<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="ZERO-A-ONE" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Kopieren',
      copy_success: 'Kopiert',
      copy_failure: 'Kopieren fehlgeschlagen'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="什么是堆 glibc的堆管理实现 arena bins chunk   malloc和free的工作流程 fastbin attack   新版本glibc中的tcache 堆的花式玩法  什么是堆  栈通常用于为函数分配固定大小的局部内存 堆是可以根据运行时的需要进行动态分配和释放的内存，大小可变 Malloc/New Free/Delete   堆的实现重点关注内存块的组织和管理方式，尤其是">
<meta property="og:type" content="article">
<meta property="og:title" content="长亭PWN笔记03">
<meta property="og:url" content="http://yoursite.com/2020/05/04/│ñ═ñPWN▒╩╝╟03/index.html">
<meta property="og:site_name" content="ZERO-A-ONE">
<meta property="og:description" content="什么是堆 glibc的堆管理实现 arena bins chunk   malloc和free的工作流程 fastbin attack   新版本glibc中的tcache 堆的花式玩法  什么是堆  栈通常用于为函数分配固定大小的局部内存 堆是可以根据运行时的需要进行动态分配和释放的内存，大小可变 Malloc/New Free/Delete   堆的实现重点关注内存块的组织和管理方式，尤其是">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200501204507.png">
<meta property="og:image" content="c:%5CUsers%5Csyc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200501213413134.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502160807.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502163306.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502223237.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502230606.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502230919.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/S6.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503114458.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503114752.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503114907.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115030.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115156.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115251.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115440.png">
<meta property="og:updated_time" content="2020-05-05T07:16:40.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="长亭PWN笔记03">
<meta name="twitter:description" content="什么是堆 glibc的堆管理实现 arena bins chunk   malloc和free的工作流程 fastbin attack   新版本glibc中的tcache 堆的花式玩法  什么是堆  栈通常用于为函数分配固定大小的局部内存 堆是可以根据运行时的需要进行动态分配和释放的内存，大小可变 Malloc/New Free/Delete   堆的实现重点关注内存块的组织和管理方式，尤其是">
<meta name="twitter:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200501204507.png">
  <link rel="canonical" href="http://yoursite.com/2020/05/04/│ñ═ñPWN▒╩╝╟03/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>长亭PWN笔记03 | ZERO-A-ONE</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZERO-A-ONE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Suche</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Suche..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
     <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/04/│ñ═ñPWN▒╩╝╟03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">长亭PWN笔记03

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2020-05-04 09:16:23" itemprop="dateCreated datePublished" datetime="2020-05-04T09:16:23-07:00">2020-05-04</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Bearbeitet am</span>
                <time title="Geändert am: 2020-05-05 00:16:40" itemprop="dateModified" datetime="2020-05-05T00:16:40-07:00">2020-05-05</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>什么是堆</li>
<li>glibc的堆管理实现<ul>
<li>arena</li>
<li>bins</li>
<li>chunk</li>
</ul>
</li>
<li>malloc和free的工作流程</li>
<li>fastbin attack  </li>
<li>新版本glibc中的tcache</li>
<li>堆的花式玩法</li>
</ul>
<h2 id="什么是堆"><a href="#什么是堆" class="headerlink" title="什么是堆"></a>什么是堆</h2><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200501204507.png" alt=" "></p>
<ul>
<li>栈通常用于为函数分配固定大小的局部内存</li>
<li>堆是可以根据运行时的需要进行动态分配和释放的内存，大小可变<ul>
<li>Malloc/New</li>
<li>Free/Delete</li>
</ul>
</li>
<li>堆的实现重点关注内存块的组织和管理方式，尤其是空闲内存块<ul>
<li>如何提高分配和释放效率</li>
<li>如何降低碎片化，提高空间利用率</li>
</ul>
</li>
<li>举例：浏览器的DOM树通常分配在堆上<ul>
<li>堆的实现算法影响堆分配网页加载和动态效果速度</li>
<li>堆的实现算法影响浏览器对内存的使用效率 </li>
</ul>
</li>
</ul>
<h2 id="常见堆实现"><a href="#常见堆实现" class="headerlink" title="常见堆实现"></a>常见堆实现</h2><ul>
<li>dlmalloc - 通用分配器</li>
<li>ptmalloc2 - glibc<ul>
<li>基于dlmalloc fork出来，在2006年增加了多线程支持</li>
</ul>
</li>
<li>jemalloc - FreeBSD、Firefox、Android</li>
<li>tcmalloc - Google Chrome</li>
<li>libumem - Solaris</li>
<li>Windows 10 - segment heap</li>
</ul>
<h2 id="ptmalloc2的多线程支持"><a href="#ptmalloc2的多线程支持" class="headerlink" title="ptmalloc2的多线程支持"></a>ptmalloc2的多线程支持</h2><ul>
<li>不同的线程维护不同的堆，称为<strong>per thread arena</strong></li>
<li>主线程创建的堆，称为<strong>main arena</strong></li>
<li>Arena数量受到CPU核数的限制<ul>
<li>对于32位系统：arena数量上限 = 2 * 核数</li>
<li>对于64位系统：arena数量上限 = 8 * 核数</li>
</ul>
</li>
</ul>
<h2 id="glibc的堆管理实现"><a href="#glibc的堆管理实现" class="headerlink" title="glibc的堆管理实现"></a>glibc的堆管理实现</h2><ul>
<li>arena<ul>
<li>指的是堆内存区域本身，并非结构</li>
<li>主线程的main arena通过sbrk创建</li>
<li>其他线程arena通过mmap创建</li>
</ul>
</li>
<li>malloc_state<ul>
<li>管理arena的核心结构，包含堆的状态信息、bins链表等</li>
<li>main arena对应的malloc_state结构存储在glibc的全局变量中</li>
<li>其他线程arena对应的malloc_state存储在arena本身当中</li>
</ul>
</li>
<li>bins<ul>
<li>bins用来管理空闲内存块，通常使用链表结构来进行组织</li>
</ul>
</li>
<li>chunks<ul>
<li>内存块的结构</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意：</p>
<p>（1）以下介绍的堆管理环境为glibc 2.26 以下（不含2.26），即出现tcache之前的堆管理方式</p>
<p>（2）以下演示的环境均是64位程序及操作系统 </p>
</blockquote>
<h2 id="Arena头部结构：malloc-state"><a href="#Arena头部结构：malloc-state" class="headerlink" title="Arena头部结构：malloc_state"></a>Arena头部结构：malloc_state</h2><p>malloc_state存储了Arena的状态，其中包括了很多用于管理空闲块的bins链表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line">	<span class="keyword">mutex_t</span> mutex; <span class="comment">/* 同步访问相关，互斥锁 */</span></span><br><span class="line">	<span class="keyword">int</span> flags; <span class="comment">/* 标志位，以前是max_fast，在一些老的文章上可能还使用的这个说法，比如phrack */</span></span><br><span class="line">	mfastbinptr fastbins[NFASTBINS]; <span class="comment">/* fastbins，之后会说到,是一个chunk的链表 */</span></span><br><span class="line">	mchunkptr top; <span class="comment">/* top chunk，一个特殊的chunk，在之后会说到 */</span></span><br><span class="line">	mchunkptr last_remainder; <span class="comment">/* 最后一次拆分top chunk得到的剩余内容，之后会说到 */</span></span><br><span class="line">	mchunkptr bins[BINS * <span class="number">2</span>]; <span class="comment">/* bins，一个chunk的链表的数组，之后会说到 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE]; <span class="comment">/* bins是否为空的一个位图 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span> <span class="comment">/* 链表，下一个malloc_state的位置 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line">	INTERNAL_SIZE_T system_mem;</span><br><span class="line">	INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mallo_state</span> <span class="title">main_arena</span>;</span><span class="comment">/*global variable in libc.so*/</span></span><br></pre></td></tr></table></figure>

<p>主线程的malloc_state结构存储在glibc的全局变量中，变量名为main_arena</p>
<h2 id="Main-Arena概览"><a href="#Main-Arena概览" class="headerlink" title="Main Arena概览"></a>Main Arena概览</h2><p><img src="C:%5CUsers%5Csyc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200501213413134.png" alt></p>
<h2 id="空闲内存块-free-chunk-结构"><a href="#空闲内存块-free-chunk-结构" class="headerlink" title="空闲内存块(free chunk)结构"></a>空闲内存块(free chunk)结构</h2><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502160807.png" alt></p>
<p>在64位平台下，free chunk的第一个字段prev_size（8字节）存储了前一个chunk的大小</p>
<p>free chunk的第二个字段size记录了当前chunk的大小，该字段最低三个bit被用作其他含义</p>
<ul>
<li>P代表PREV_INUSE，即代表前一个chunk是否被使用</li>
<li>M代表IS_MMAPPED，代表当前chunk是否属于mmap出来的</li>
<li>N代表NON_MAIN_ARENA，代表该chunk是否属于非MAIN Arena</li>
</ul>
<p>第三个字段fd和第四个字段bk（8字节）前向指针和后向指针，这两个字段用于bin链表当中，用来链接大小相同或者相近的free chunk，便于后续分配时查找</p>
<h2 id="已分配内存块（allocated-chunk）结构"><a href="#已分配内存块（allocated-chunk）结构" class="headerlink" title="已分配内存块（allocated chunk）结构"></a>已分配内存块（allocated chunk）结构</h2><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502163306.png" alt></p>
<p>allocated chunk的前两个字段和free chunk相通</p>
<p>第三个字段开始到最后，chunk中存储的都是用户数据。甚至下一个chunk的第一个字段prev_size，也可以被用来存放数据，原因是这个prev_size字段只有当“前一个”chunk是free的时候才有意义，如果“前一个”chunk是已经分配的，堆管理器并不关心</p>
<p>所以对一个chunk来说，用户可用大小从偏移+8开始，一直到下一个chunk的orev_size字段</p>
<p>在64位平台下，chunk的大小一定是0x10字节的整数倍。malloc返回的指针为图中mem指向的位置，即数据开头</p>
<h2 id="malloc参数与chunk大小的关系"><a href="#malloc参数与chunk大小的关系" class="headerlink" title="malloc参数与chunk大小的关系"></a>malloc参数与chunk大小的关系</h2><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502223237.png" alt></p>
<ul>
<li>malloc参数为用户申请的内存大小</li>
<li>chunk包含数据和metadata</li>
<li>返回的chunk只要保证其中可用数据大小等于用户申请即可</li>
<li>在x86 32位平台下chunk的大小一定是8字节的整数倍；x64平台下，chunk的大小一定是16字节的整数倍</li>
</ul>
<h2 id="Bins结构"><a href="#Bins结构" class="headerlink" title="Bins结构"></a>Bins结构</h2><ul>
<li>BIns是用来管理和组织<strong>空闲</strong>内存块的链表结构，根据chunk的大小和状态，有许多种不同的Bins结构</li>
<li>Fast bins<ul>
<li>用于管理小的chunk</li>
</ul>
</li>
<li>Bins<ul>
<li>small bins - 用于管理中等大小的chunk</li>
<li>large bins - 用于管理较大的chunk</li>
<li>unsorted bins - 用于存放未整理的chunk</li>
</ul>
</li>
</ul>
<h2 id="Fast-bins"><a href="#Fast-bins" class="headerlink" title="Fast bins"></a>Fast bins</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span>&#123;</span></span><br><span class="line">    <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">    mchunkptr top;</span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line">    mchunkptr bins[NBINS*<span class="number">2</span><span class="number">-2</span>];</span><br><span class="line">    <span class="comment">/*..*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>大小<ul>
<li>x86_32平台：16~64字节</li>
<li>x64平台：32~128字节</li>
</ul>
</li>
<li>相同大小的chunk放在一个bin中</li>
<li>单向链表</li>
<li>后进先出（FILO，First in last out）</li>
<li>相邻的空闲fastbin chunk不会被合并</li>
<li>当chunk被free时，不会清理PREV_INUSE标志</li>
</ul>
<h2 id="Fast-bins在内存中的结构示例"><a href="#Fast-bins在内存中的结构示例" class="headerlink" title="Fast bins在内存中的结构示例"></a>Fast bins在内存中的结构示例</h2><p>源代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *a1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">memset</span>(a1,<span class="number">0x41</span>,<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span> *a2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">memset</span>(a2,<span class="number">0x42</span>,<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span> *a3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">memset</span>(a3,<span class="number">0x43</span>,<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Malloc done!\n"</span>);</span><br><span class="line">    <span class="built_in">free</span>(a1);</span><br><span class="line">    <span class="built_in">free</span>(a2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Free done\n"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<ul>
<li>下断点在<code>printf(&quot;Malloc done!\n&quot;);</code></li>
</ul>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502230606.png" alt></p>
<ul>
<li>下断点在<code>printf(&quot;Free done\n&quot;);</code></li>
</ul>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/Pwn%E6%9C%AF%E8%BF%9B%E9%98%B6%EF%BC%8C%E7%8E%A9%E8%BD%AC%E5%A0%86%E6%BA%A2%E5%87%BA/QQ%E5%9B%BE%E7%89%8720200502230919.png" alt></p>
<h2 id="Small-bins"><a href="#Small-bins" class="headerlink" title="Small bins"></a>Small bins</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span>&#123;</span></span><br><span class="line">    <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">    mchunkptr top;</span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line">    mchunkptr bins[NBINS*<span class="number">2</span><span class="number">-2</span>];</span><br><span class="line">    <span class="comment">/*..*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>chunk大小 &lt; 1024 bytes(64bit)</li>
<li>相同大小的chunk放在一个bin中</li>
<li>双向循环链表</li>
<li>先进先出（First in first out）</li>
<li>当有空闲块相邻时，chunk会被合并成一个更大的chunk</li>
<li>bins[2],bins[3],…,bins[124],bins[125]共62组smallbin，大小范围[0x20,0x3f0]（64位）</li>
</ul>
<h2 id="Large-bins"><a href="#Large-bins" class="headerlink" title="Large bins"></a>Large bins</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span>&#123;</span></span><br><span class="line">    <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">    mchunkptr top;</span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line">    mchunkptr bins[NBINS*<span class="number">2</span><span class="number">-2</span>];</span><br><span class="line">    <span class="comment">/*..*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>chunk大小 &gt;= 1024 bytes(64bit)</li>
<li>每组bin表示一组size范围而不是具体的size，例如bins[126],bins[127]的链表中保存长度在[0x400,0x440]的chunk</li>
<li>双向循环链表</li>
<li>先进先出</li>
<li>chunk按照大小从大到小的排序</li>
<li>当有空闲块相邻，chunk会被合并</li>
<li>bins[126],bins[127],…,bins[250],bins[251]共63组largebin，大小范围[0x400,X]（64位）</li>
</ul>
<h2 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span>&#123;</span></span><br><span class="line">    <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">    mchunkptr top;</span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line">    mchunkptr bins[NBINS*<span class="number">2</span><span class="number">-2</span>];</span><br><span class="line">    <span class="comment">/*..*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>64位平台中：chunk大小&gt;128字节</li>
<li>只存在唯一一个unsorted bin</li>
<li>双向循环链表</li>
<li>当一个chunk（非fastbin）被free，它首先被放入unsorted bin，等后续整理时才会放入对应的small bin/fast bin</li>
<li>bins[0],bins[1]</li>
</ul>
<h2 id="Unsorted-bins与small-bins"><a href="#Unsorted-bins与small-bins" class="headerlink" title="Unsorted bins与small bins"></a>Unsorted bins与small bins</h2><p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/S6.png" alt></p>
<h2 id="其他chunk"><a href="#其他chunk" class="headerlink" title="其他chunk"></a>其他chunk</h2><ul>
<li>Top chunk<ul>
<li>不属于任何bin</li>
<li>在arena中处于最高地址</li>
<li>当没有其他空闲块时，top chunk就会被用于分配</li>
<li>分裂时<ul>
<li>一块是请求大小的chunk</li>
<li>另一块余下chunk将成为新的Top chunk</li>
</ul>
</li>
</ul>
</li>
<li>Last_remainder<ul>
<li>当请求small chunk大小的内存时，如发生分裂，则剩余的chunk保存为last_remainder</li>
</ul>
</li>
</ul>
<h2 id="malloc的工作流程"><a href="#malloc的工作流程" class="headerlink" title="malloc的工作流程"></a>malloc的工作流程</h2><ol>
<li>如果在size &lt; max fast，在fast bins中寻找fast chunk，如找到则结束</li>
<li>如果size in_smallbin_range，在small bins中寻找small chunk，如找到则结束</li>
<li>如果size not in_smallbin_range，合并所有fastbin的chunk</li>
<li>循环：<ol>
<li>检查unsorted bin中的last_remainder<ul>
<li>如果满足一定条件，则分裂之，将剩余的chunk标记为新的last_remainder</li>
</ul>
</li>
<li>在unsorted bin中搜索，同时进行整理<ul>
<li>如遇到精确大小，则返回，否则就把当前chunk整理到small/large bin中去</li>
</ul>
</li>
<li>在small bin和large bin中搜索最合适的chunk（不一定是精确大小）</li>
</ol>
</li>
<li>使用top chunk</li>
</ol>
<h2 id="free的工作流程"><a href="#free的工作流程" class="headerlink" title="free的工作流程"></a>free的工作流程</h2><ol>
<li>如果size &lt; masx fast，放入fast bin，结束</li>
<li>如果前一个chunk是free的<ol>
<li>unlink前面的chunk</li>
<li>合并两个chunk，并放入unsorted bin</li>
</ol>
</li>
<li>如果后一个chunk是top chunk，则将当前chunk并入top chunk</li>
<li>如果后一个chunk是free的<ol>
<li>unlink后面的chunk</li>
<li>合并两个chunk，并放入unsorted bin</li>
</ol>
</li>
<li>前后chunk都不是free的，放入unsorted bin</li>
</ol>
<blockquote>
<p>相当于所有的chunk在被free时只有三种去路：放入fastbin、放入unsortbin、并入top chunk</p>
</blockquote>
<h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *A,*B,*C,*D;</span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    D = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="built_in">free</span>(C);</span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x80</span> - <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">free</span>(B)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分配完malloc之后：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503114458.png" alt></p>
<p>执行free之后：</p>
<p>再次执行<code>A = malloc(0x100 - 8)</code>：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503114752.png" alt></p>
<p>再次<code>free(A)</code>：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503114907.png" alt></p>
<p>再次<code>A = malloc(0x80 - 8)</code>：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115030.png" alt></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115156.png" alt></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115251.png" alt></p>
<p>执行<code>free(B)</code>后：</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E9%95%BF%E4%BA%AD%E5%85%AC%E5%BC%80%E8%AF%BE/%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80%EF%BC%8C%E5%AE%9E%E6%88%98ROP%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/QQ%E5%9B%BE%E7%89%8720200503115440.png" alt></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2020/04/26/│ñ═ñPWN▒╩╝╟02/" rel="next" title="长亭PWN笔记02">
                  <i class="fa fa-chevron-left"></i> 长亭PWN笔记02
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2020/06/29/Angr╚δ├┼▒╩╝╟ú¿╥╗ú⌐/" rel="prev" title="Angr入门笔记（一）">
                  Angr入门笔记（一） <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Inhaltsverzeichnis
        </li>
        <li class="sidebar-nav-overview">
          Übersicht
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是堆"><span class="nav-number">1.</span> <span class="nav-text">什么是堆</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见堆实现"><span class="nav-number">2.</span> <span class="nav-text">常见堆实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ptmalloc2的多线程支持"><span class="nav-number">3.</span> <span class="nav-text">ptmalloc2的多线程支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#glibc的堆管理实现"><span class="nav-number">4.</span> <span class="nav-text">glibc的堆管理实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arena头部结构：malloc-state"><span class="nav-number">5.</span> <span class="nav-text">Arena头部结构：malloc_state</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Main-Arena概览"><span class="nav-number">6.</span> <span class="nav-text">Main Arena概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#空闲内存块-free-chunk-结构"><span class="nav-number">7.</span> <span class="nav-text">空闲内存块(free chunk)结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#已分配内存块（allocated-chunk）结构"><span class="nav-number">8.</span> <span class="nav-text">已分配内存块（allocated chunk）结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#malloc参数与chunk大小的关系"><span class="nav-number">9.</span> <span class="nav-text">malloc参数与chunk大小的关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bins结构"><span class="nav-number">10.</span> <span class="nav-text">Bins结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fast-bins"><span class="nav-number">11.</span> <span class="nav-text">Fast bins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fast-bins在内存中的结构示例"><span class="nav-number">12.</span> <span class="nav-text">Fast bins在内存中的结构示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Small-bins"><span class="nav-number">13.</span> <span class="nav-text">Small bins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Large-bins"><span class="nav-number">14.</span> <span class="nav-text">Large bins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsorted-bin"><span class="nav-number">15.</span> <span class="nav-text">Unsorted bin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsorted-bins与small-bins"><span class="nav-number">16.</span> <span class="nav-text">Unsorted bins与small bins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他chunk"><span class="nav-number">17.</span> <span class="nav-text">其他chunk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#malloc的工作流程"><span class="nav-number">18.</span> <span class="nav-text">malloc的工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#free的工作流程"><span class="nav-number">19.</span> <span class="nav-text">free的工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例分析"><span class="nav-number">20.</span> <span class="nav-text">案例分析</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZERO-A-ONE</p>
  <div class="site-description" itemprop="description">Resit much,Obey little</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">Kategorien</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZERO-A-ONE</span>
</div>
  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
