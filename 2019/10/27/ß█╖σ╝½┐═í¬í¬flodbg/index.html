<!DOCTYPE html>





<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="ZERO-A-ONE" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="检查一下程序 12345678syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ checksec flodbg[*] &apos;/mnt/hgfs/share/\xe5\xb7\x85\xe5\xb3\xb0\xe6\x9e\x81\xe5\xae\xa2/flodbg/flodbg&apos;    Arch:     amd64-64-little    RELRO:    Par">
<meta property="og:type" content="article">
<meta property="og:title" content="巅峰极客——flodbg">
<meta property="og:url" content="http://yoursite.com/2019/10/27/ß█╖σ╝½┐═í¬í¬flodbg/index.html">
<meta property="og:site_name" content="ZERO-A-ONE">
<meta property="og:description" content="检查一下程序 12345678syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ checksec flodbg[*] &apos;/mnt/hgfs/share/\xe5\xb7\x85\xe5\xb3\xb0\xe6\x9e\x81\xe5\xae\xa2/flodbg/flodbg&apos;    Arch:     amd64-64-little    RELRO:    Par">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-10-27T22:38:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="巅峰极客——flodbg">
<meta name="twitter:description" content="检查一下程序 12345678syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ checksec flodbg[*] &apos;/mnt/hgfs/share/\xe5\xb7\x85\xe5\xb3\xb0\xe6\x9e\x81\xe5\xae\xa2/flodbg/flodbg&apos;    Arch:     amd64-64-little    RELRO:    Par">
  <link rel="canonical" href="http://yoursite.com/2019/10/27/ß█╖σ╝½┐═í¬í¬flodbg/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>巅峰极客——flodbg | ZERO-A-ONE</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZERO-A-ONE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
     <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/27/ß█╖σ╝½┐═í¬í¬flodbg/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZERO-A-ONE">
      <meta itemprop="description" content="Resit much,Obey little">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZERO-A-ONE">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">巅峰极客——flodbg

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-10-27 00:37:54 / Modified: 15:38:16" itemprop="dateCreated datePublished" datetime="2019-10-27T00:37:54-07:00">2019-10-27</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>检查一下程序</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ checksec flodbg</span><br><span class="line">[*] '/mnt/hgfs/share/\xe5\xb7\x85\xe5\xb3\xb0\xe6\x9e\x81\xe5\xae\xa2/flodbg/flodbg'</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p>拿到程序发现运行发现一直没有结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syc@ubuntu:/mnt/hgfs/share/巅峰极客/flodbg$ ./flodbg</span><br></pre></td></tr></table></figure>

<p> 直接IDA Pro打开分析一下函数流程</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// er12</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v7; <span class="comment">// [rsp-8h] [rbp-4E0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp-8h] [rbp-4E0h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+0h] [rbp-4D8h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+14h] [rbp-4C4h]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+4Ch] [rbp-48Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [rsp+50h] [rbp-488h]</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// [rsp+54h] [rbp-484h]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+58h] [rbp-480h]</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// [rsp+5Ch] [rbp-47Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// [rsp+60h] [rbp-478h]</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [rsp+64h] [rbp-474h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+68h] [rbp-470h]</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [rsp+6Ch] [rbp-46Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [rsp+70h] [rbp-468h]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [rsp+74h] [rbp-464h]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [rsp+78h] [rbp-460h]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [rsp+7Ch] [rbp-45Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// [rsp+80h] [rbp-458h]</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [rsp+84h] [rbp-454h]</span></span><br><span class="line">  <span class="keyword">int</span> v26; <span class="comment">// [rsp+88h] [rbp-450h]</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// [rsp+8Ch] [rbp-44Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// [rsp+90h] [rbp-448h]</span></span><br><span class="line">  <span class="keyword">int</span> v29; <span class="comment">// [rsp+94h] [rbp-444h]</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// [rsp+98h] [rbp-440h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v31; <span class="comment">// [rsp+4A8h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v3 = (<span class="keyword">char</span> *)&amp;v9;</span><br><span class="line">  v31 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = time(<span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 += <span class="number">4</span>;</span><br><span class="line">    *((_DWORD *)v3 - <span class="number">1</span>) = _IO_getc(_bss_start);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != &amp;v11 );</span><br><span class="line">  v12 = <span class="string">'S'</span>;</span><br><span class="line">  v13 = <span class="string">'@'</span>;</span><br><span class="line">  v14 = <span class="string">'y'</span>;</span><br><span class="line">  v15 = <span class="string">'R'</span>;</span><br><span class="line">  v16 = <span class="string">'t'</span>;</span><br><span class="line">  v17 = <span class="string">'f'</span>;</span><br><span class="line">  v18 = <span class="string">'T'</span>;</span><br><span class="line">  v19 = <span class="string">'l'</span>;</span><br><span class="line">  v20 = <span class="string">'0'</span>;</span><br><span class="line">  v21 = <span class="string">'+'</span>;</span><br><span class="line">  v22 = <span class="string">'a'</span>;</span><br><span class="line">  v23 = <span class="string">'g'</span>;</span><br><span class="line">  v24 = <span class="string">'-'</span>;</span><br><span class="line">  v25 = <span class="string">'L'</span>;</span><br><span class="line">  v26 = <span class="string">'_'</span>;</span><br><span class="line">  v27 = <span class="string">'3'</span>;</span><br><span class="line">  v28 = <span class="string">'M'</span>;</span><br><span class="line">  v29 = <span class="string">'&#125;'</span>;</span><br><span class="line">  v30 = <span class="string">'&#123;'</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ptrace(<span class="number">0</span>, <span class="number">0L</span>L, <span class="number">1L</span>L, <span class="number">0L</span>L) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      func3(&amp;v10, <span class="number">2L</span>L, <span class="number">7L</span>L, <span class="number">14L</span>L);</span><br><span class="line">      v7 = <span class="number">4196782L</span>L;</span><br><span class="line">      JUMPOUT(__CS__, v8 + <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(v5);</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = <span class="number">10000000</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    --v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 );</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们长期等待无响应的代码是因为这段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v6 = <span class="number">10000000</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    --v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 );</span><br></pre></td></tr></table></figure>

<p>然后注意到这里有一个<strong>ptrace</strong>函数，且调用的是<strong>ptrace</strong>函数，所以这个程序是加入了反调试的功能的。 <strong>ptrace</strong>函数提供了父进程观察和控制其子进程执行的能力，发送给被跟踪的子进程的信号(除了<strong>SIGKILL</strong>)，都会被转发给父进程，这也是调试器主要原理。 总而言之就是如果我们使用GDB调试这个程序，<strong>ptrace</strong>函数执行成功就会返回大于0的值，那么程序就会中止</p>
<p>这里还存在一个反调试方式就是时间戳的检查</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v4 = time(<span class="number">0L</span>L);</span><br><span class="line">v5 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br></pre></td></tr></table></figure>

<p>被调试时，进程的运行速度大大降低，例如，单步调试大幅降低恶意代码的运行速度，所以时钟检测是恶意代码探测调试器存在的最常用方式之一。有如下两种用时钟检测来探测调试器存在的方法。记录一段操作前后的时间戳，然后比较这两个时间戳，如果存在滞后，则可以认为存在调试器。记录触发一个异常前后的时间戳。如果不调试进程，可以很快处理完异常，因为调试器处理异常的速度非常慢。默认情况下，调试器处理异常时需要人为干预，这导致大量延迟。虽然很多调试器允许我们忽略异常，将异常直接返回程序，但这样操作仍然存在不小的延迟</p>
<p>然后我们看这段代码使用了花指令来混淆</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JUMPOUT(__CS__, v8 + <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004009</span>C4                 dd <span class="number">48</span>EBEBEBh</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">11B</span>908247C8Dh, <span class="number">4B</span>E00000006BA00h, <span class="number">440E8000000</span>h, <span class="number">0</span>EBB866C8FFC0FFEBh</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>EB90EBFA74C03105h, <span class="number">0F</span>FC0FFEBC8FFC0FFh, <span class="number">8</span>D48C8FFC0FFEBC8h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>AB924247Ch, <span class="number">3B</span>E00000005BAh, <span class="number">0E800000409</span>E80000h, <span class="number">24B</span>48D48FFFFFE04h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">75E8</span>C789000000A0h, <span class="number">0F</span>C589C085000004h, <span class="number">5</span>C8D480000020B85h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0B</span>A0000000FB92C24h, <span class="number">6B</span>E00000009h, <span class="number">3</span>CFE8E7894800h, <span class="number">6B</span>A00000008B900h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">3B</span>E000000h, <span class="number">3B</span>8E8DF8948h, <span class="number">89F</span>FFFFD71E8FF31h, <span class="number">0F</span>02FF83E72944C7h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>EB9000001D48Fh, <span class="number">0B</span>E00000005BA0000h, <span class="number">0E8</span>EF894C00000001h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0F</span>FFCF7E80000038Ch, <span class="number">0F</span>FFFFD10E8C789FFh, <span class="number">0F</span>FFFFD78E8C58941h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">1</span>AA850FC53941h, <span class="number">13B</span>9F63100h, <span class="number">0E7894800000002</span>BAh, <span class="number">356E840246</span>C8D4Ch</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C03105EBB8660000h, <span class="number">0F</span>FC0FFEB90EBFA74h, <span class="number">0</span>C03105EBB86690C8h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C8FFC0FFEBEBFA74h, <span class="number">10B</span>90C247C8D48h, <span class="number">0B</span>E00000005BA0000h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">31F</span>E800000003h, <span class="number">4B</span>93C247C8D4800h, <span class="number">3B</span>A000000h, <span class="number">306E800000001</span>BEh</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C8FFC0FFEB900000h, <span class="number">0</span>C03105EBB8669090h, <span class="number">5</span>EBB86690EBFA74h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">909090</span>EBFA74C031h, <span class="number">0B</span>B920247C8D48h, <span class="number">0B</span>E00000006BA0000h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">2</span>CFE800000003h, <span class="number">13B</span>9F63100h, <span class="number">0E7894800000007</span>BAh, <span class="number">0E89090000002</span>BBE8h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0</span>C083485800000000h, <span class="number">0</span>EBEBEBEBEBE0FF0Ch, <span class="number">74</span>C03105EBB86690h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">3B</span>9F63190EBFAh, <span class="number">4</span>C00000002BA0000h, <span class="number">4800000289E8</span>EF89h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">9B</span>9F63128247C8Dh, <span class="number">2B</span>A000000h, <span class="number">0E8</span>FF3100000273E8h, <span class="number">2944</span>C789FFFFFC2Ch</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">8F</span>8F0F03FF83E7h, <span class="number">8B</span>9DF89480000h, <span class="number">0B</span>E00000003BA0000h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">45E8</span>DB3100000001h, <span class="number">3B</span>9000002h, <span class="number">4</span>CF63100000002BAh, <span class="number">0B</span>800000231E8EF89h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">2E660</span>EEB00000053h, <span class="number">841F</span>0Fh, <span class="number">759</span>C043B509C448Bh, <span class="number">0F</span>B834801C383483Chc</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">400F</span>FDBFED7513h, <span class="number">948B</span>48FFFFFB63E8h, <span class="number">334864000004</span>A824h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0E889000000282514</span>h, <span class="number">4B</span>8C481482475h, <span class="number">0</span>C35D415C415D5B00h</span><br><span class="line">.text:<span class="number">00000000004009</span>C8                 dq <span class="number">0F</span>F2BFD8EBFFCD83h, <span class="number">89F</span>FFFFB31E80040h</span><br><span class="line">.text:<span class="number">0000000000400</span>C50                 db <span class="number">0</span>DFh</span><br></pre></td></tr></table></figure>

<p>我们绕过这些反调试的手法可以直接path掉或者在动态调试的时候通过直接修改寄存器绕过即可，我们首先来通过path修改绕过<strong>ptrace</strong>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000040096</span>A                 call    _ptrace</span><br></pre></td></tr></table></figure>

<p>变成</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000040096</span>A                 nop                     ; Keypatch modified <span class="keyword">this</span> from:</span><br><span class="line">.text:<span class="number">000000000040096</span>A                                         ;   call _ptrace</span><br><span class="line">.text:<span class="number">000000000040096</span>A                                         ; Keypatch padded NOP to next boundary: <span class="number">4</span> bytes</span><br><span class="line">.text:<span class="number">000000000040096B</span>                 nop</span><br><span class="line">.text:<span class="number">000000000040096</span>C                 nop</span><br><span class="line">.text:<span class="number">000000000040096</span>D                 nop</span><br><span class="line">.text:<span class="number">000000000040096</span>E                 nop</span><br></pre></td></tr></table></figure>

<p>在gdb动态调试中可以发现已经成功绕过</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x400933</span> &lt;main+<span class="number">211</span>&gt;    mov    dword ptr [rsp + <span class="number">0x88</span>], <span class="number">0x5f</span></span><br><span class="line">   <span class="number">0x40093e</span> &lt;main+<span class="number">222</span>&gt;    mov    dword ptr [rsp + <span class="number">0x8c</span>], <span class="number">0x33</span></span><br><span class="line">   <span class="number">0x400949</span> &lt;main+<span class="number">233</span>&gt;    mov    dword ptr [rsp + <span class="number">0x90</span>], <span class="number">0x4d</span></span><br><span class="line">   <span class="number">0x400954</span> &lt;main+<span class="number">244</span>&gt;    mov    dword ptr [rsp + <span class="number">0x94</span>], <span class="number">0x7d</span></span><br><span class="line">   <span class="number">0x40095f</span> &lt;main+<span class="number">255</span>&gt;    mov    dword ptr [rsp + <span class="number">0x98</span>], <span class="number">0x7b</span></span><br><span class="line"> ► <span class="number">0x40096a</span> &lt;main+<span class="number">266</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096b</span> &lt;main+<span class="number">267</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096c</span> &lt;main+<span class="number">268</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096d</span> &lt;main+<span class="number">269</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096e</span> &lt;main+<span class="number">270</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x40096f</span> &lt;main+<span class="number">271</span>&gt;    test   rax, rax</span><br></pre></td></tr></table></figure>

<p>在这里我们遇到了时间戳检测</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x400972</span> &lt;main+<span class="number">274</span>&gt;     js     main+<span class="number">1036</span> &lt;<span class="number">0x400c6c</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x400978</span> &lt;main+<span class="number">280</span>&gt;     xor    edi, edi</span><br><span class="line">   <span class="number">0x40097a</span> &lt;main+<span class="number">282</span>&gt;     call   time@plt &lt;<span class="number">0x4007e0</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x40097f</span> &lt;main+<span class="number">287</span>&gt;     mov    edi, eax</span><br><span class="line">   <span class="number">0x400981</span> &lt;main+<span class="number">289</span>&gt;     sub    edi, r12d</span><br><span class="line"> ► <span class="number">0x400984</span> &lt;main+<span class="number">292</span>&gt;     cmp    edi, <span class="number">1</span></span><br><span class="line">   <span class="number">0x400987</span> &lt;main+<span class="number">295</span>&gt;     jg     main+<span class="number">1009</span> &lt;<span class="number">0x400c51</span>&gt;</span><br></pre></td></tr></table></figure>

<p>我们只需要强制修改edi寄存器的值为1即可以绕过</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> $edi = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>就已经绕过了</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x40097a</span> &lt;main+<span class="number">282</span>&gt;    call   time@plt &lt;<span class="number">0x4007e0</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x40097f</span> &lt;main+<span class="number">287</span>&gt;    mov    edi, eax</span><br><span class="line">   <span class="number">0x400981</span> &lt;main+<span class="number">289</span>&gt;    sub    edi, r12d</span><br><span class="line">   <span class="number">0x400984</span> &lt;main+<span class="number">292</span>&gt;    cmp    edi, <span class="number">1</span></span><br><span class="line">   <span class="number">0x400987</span> &lt;main+<span class="number">295</span>&gt;    jg     main+<span class="number">1009</span> &lt;<span class="number">0x400c51</span>&gt;</span><br><span class="line"> </span><br><span class="line"> ► <span class="number">0x40098d</span> &lt;main+<span class="number">301</span>&gt;    lea    r13, [rsp + <span class="number">0x14</span>]</span><br></pre></td></tr></table></figure>

<p>运行到这里</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────[ DISASM ]────────────────────────────────────────</span><br><span class="line">   <span class="number">0x4009a1</span> &lt;main+<span class="number">321</span>&gt;    mov    rdi, r13</span><br><span class="line">   <span class="number">0x4009a4</span> &lt;main+<span class="number">324</span>&gt;    call   func3 &lt;<span class="number">0x400e20</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x4009a9</span> &lt;main+<span class="number">329</span>&gt;    call   main+<span class="number">334</span> &lt;<span class="number">0x4009ae</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x4009ae</span> &lt;main+<span class="number">334</span>&gt;    pop    rax</span><br><span class="line">   <span class="number">0x4009af</span> &lt;main+<span class="number">335</span>&gt;    add    rax, <span class="number">0xa</span></span><br><span class="line"> ► <span class="number">0x4009b3</span> &lt;main+<span class="number">339</span>&gt;    jmp    rax &lt;<span class="number">0x4009b8</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x4009b8</span> &lt;main+<span class="number">344</span>&gt;    call   main+<span class="number">349</span> &lt;<span class="number">0x4009bd</span>&gt;</span><br></pre></td></tr></table></figure>

<p>可以发现其实<strong>0x4009b3</strong>是<strong>jump</strong>到了<strong>0x4009b8</strong>处，我们在<strong>IDA</strong>里面修改即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004009B3                 jmp     short loc_4009B8 ; Keypatch modified this from:</span><br><span class="line">.text:00000000004009B3                                         ;   jmp rax</span><br></pre></td></tr></table></figure>

<p>在这之前我们可以选定被花指令隐藏的数据按<strong>U</strong>或者右键选择“<strong>Undefine</strong>“先还原成数据，然后之后可以按”<strong>C</strong>“或者右键”<strong>Code</strong>“变成指令代码</p>
<p>继续运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  0x4009bd &lt;main+349&gt;    pop    rbx</span><br><span class="line">  0x4009be &lt;main+350&gt;    add    rbx, 0xa</span><br><span class="line">► 0x4009c2 &lt;main+354&gt;    jmp    rbx &lt;0x4009c7&gt;</span><br><span class="line">   ↓</span><br><span class="line">  0x4009c7 &lt;main+359&gt;    lea    rdi, [rsp + 8]</span><br></pre></td></tr></table></figure>

<p><strong>0x4009c2</strong>到<strong>0x4009c7</strong>，其实这时候我们分析一下这些花指令，本质上就是跳转到<strong>rbx+0xa</strong>的内存上</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4009bd</span> &lt;main+<span class="number">349</span>&gt;    pop    rbx</span><br><span class="line"><span class="number">0x4009be</span> &lt;main+<span class="number">350</span>&gt;    add    rbx, <span class="number">0xa</span></span><br><span class="line"><span class="number">0x4009c2</span> &lt;main+<span class="number">354</span>&gt;    jmp    rbx</span><br></pre></td></tr></table></figure>

<p>再看一下这段，加加减减等于没有，然后异或同一个寄存器一定会跳转</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x4009e1</span> &lt;main+<span class="number">385</span>&gt;    inc    eax</span><br><span class="line">  <span class="number">0x4009e3</span> &lt;main+<span class="number">387</span>&gt;    dec    eax</span><br><span class="line">  <span class="number">0x4009e5</span> &lt;main+<span class="number">389</span>&gt;    mov    ax, <span class="number">0x5eb</span></span><br><span class="line">► <span class="number">0x4009e9</span> &lt;main+<span class="number">393</span>&gt;    xor    eax, eax</span><br><span class="line">  <span class="number">0x4009eb</span> &lt;main+<span class="number">395</span>&gt;    je     main+<span class="number">391</span> &lt;<span class="number">0x4009e7</span>&gt;</span><br></pre></td></tr></table></figure>

<p>最终逆向完毕的版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// er12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// ebp</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">__pid_t</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">__pid_t</span> v9; <span class="comment">// er13</span></span><br><span class="line">  __int64 correct_count; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> input[<span class="number">19</span>]; <span class="comment">// [rsp+0h] [rbp-4D8h]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+4Ch] [rbp-48Ch]</span></span><br><span class="line">  <span class="keyword">int</span> enc[<span class="number">19</span>]; <span class="comment">// [rsp+50h] [rbp-488h]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+A0h] [rbp-438h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v17; <span class="comment">// [rsp+4A8h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v3 = input;</span><br><span class="line">  v17 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = time(<span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++v3;</span><br><span class="line">    *(v3 - <span class="number">1</span>) = _IO_getc(_bss_start);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != (<span class="keyword">int</span> *)&amp;v14 );</span><br><span class="line">  enc[<span class="number">0</span>] = <span class="string">'S'</span>;</span><br><span class="line">  enc[<span class="number">1</span>] = <span class="string">'@'</span>;</span><br><span class="line">  enc[<span class="number">2</span>] = <span class="string">'y'</span>;</span><br><span class="line">  enc[<span class="number">3</span>] = <span class="string">'R'</span>;</span><br><span class="line">  enc[<span class="number">4</span>] = <span class="string">'t'</span>;</span><br><span class="line">  enc[<span class="number">5</span>] = <span class="string">'f'</span>;</span><br><span class="line">  enc[<span class="number">6</span>] = <span class="string">'T'</span>;</span><br><span class="line">  enc[<span class="number">7</span>] = <span class="string">'l'</span>;</span><br><span class="line">  enc[<span class="number">8</span>] = <span class="string">'0'</span>;</span><br><span class="line">  enc[<span class="number">9</span>] = <span class="string">'+'</span>;</span><br><span class="line">  enc[<span class="number">10</span>] = <span class="string">'a'</span>;</span><br><span class="line">  enc[<span class="number">11</span>] = <span class="string">'g'</span>;</span><br><span class="line">  enc[<span class="number">12</span>] = <span class="string">'-'</span>;</span><br><span class="line">  enc[<span class="number">13</span>] = <span class="string">'L'</span>;</span><br><span class="line">  enc[<span class="number">14</span>] = <span class="string">'_'</span>;</span><br><span class="line">  enc[<span class="number">15</span>] = <span class="string">'3'</span>;</span><br><span class="line">  enc[<span class="number">16</span>] = <span class="string">'M'</span>;</span><br><span class="line">  enc[<span class="number">17</span>] = <span class="string">'&#125;'</span>;</span><br><span class="line">  enc[<span class="number">18</span>] = <span class="string">'&#123;'</span>;</span><br><span class="line">  func3(&amp;input[<span class="number">5</span>], <span class="number">2u</span>, <span class="number">7</span>, <span class="number">0xE</span>u);</span><br><span class="line">  func3(&amp;input[<span class="number">2</span>], <span class="number">4u</span>, <span class="number">6</span>, <span class="number">0x11</span>u);</span><br><span class="line">  func3(&amp;input[<span class="number">9</span>], <span class="number">3u</span>, <span class="number">5</span>, <span class="number">0xA</span>u);</span><br><span class="line">  v5 = getppid();</span><br><span class="line">  v6 = get_name_by_pid(v5, &amp;v16);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    func3(input, <span class="number">6u</span>, <span class="number">9</span>, <span class="number">0xF</span>u);</span><br><span class="line">    func3(&amp;input[<span class="number">11</span>], <span class="number">3u</span>, <span class="number">6</span>, <span class="number">8u</span>);</span><br><span class="line">    v7 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt; <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    func3(&amp;input[<span class="number">5</span>], <span class="number">1u</span>, <span class="number">5</span>, <span class="number">0xE</span>u);</span><br><span class="line">    v8 = getpid();</span><br><span class="line">    v9 = getsid(v8);</span><br><span class="line">    <span class="keyword">if</span> ( v9 != getppid() )</span><br><span class="line">    &#123;</span><br><span class="line">      func3(input, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0x13</span>u);</span><br><span class="line">      func3(&amp;input[<span class="number">3</span>], <span class="number">3u</span>, <span class="number">5</span>, <span class="number">0x10</span>u);</span><br><span class="line">      func3(&amp;input[<span class="number">15</span>], <span class="number">1u</span>, <span class="number">3</span>, <span class="number">4u</span>);</span><br><span class="line">      func3(&amp;input[<span class="number">8</span>], <span class="number">3u</span>, <span class="number">6</span>, <span class="number">0xB</span>u);</span><br><span class="line">      func3(input, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0x13</span>u);</span><br><span class="line">      func3(&amp;input[<span class="number">16</span>], <span class="number">0</span>, <span class="number">2</span>, <span class="number">3u</span>);</span><br><span class="line">      func3(&amp;input[<span class="number">10</span>], <span class="number">0</span>, <span class="number">2</span>, <span class="number">9u</span>);</span><br><span class="line">      v7 = (<span class="keyword">unsigned</span> __int64)time(<span class="number">0L</span>L) - v4;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &gt;= <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        correct_count = <span class="number">0L</span>L;</span><br><span class="line">        func3(&amp;input[<span class="number">11</span>], <span class="number">1u</span>, <span class="number">3</span>, <span class="number">8u</span>);</span><br><span class="line">        func3(&amp;input[<span class="number">16</span>], <span class="number">0</span>, <span class="number">2</span>, <span class="number">3u</span>);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="string">'S'</span>; i == input[correct_count]; i = enc[correct_count] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( ++correct_count == <span class="number">19</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"win"</span>);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"You failed"</span>);</span><br><span class="line">        v7 = correct_count;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_16:</span><br><span class="line">      <span class="built_in">exit</span>(v7);</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_17:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"what are you doing?!"</span>);</span><br><span class="line">    v7 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = <span class="number">-1</span>;</span><br><span class="line">LABEL_12:</span><br><span class="line">  result = v6;</span><br><span class="line">  <span class="keyword">if</span> ( __readfsqword(<span class="number">0x28</span>u) != v17 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_17;c</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 输入字符串“0123456789abcdefghi”，然后在比较处设断点，可以看到输入字符串经过处理后的结果是“8f6c90e1dg237abh5i4”。<br>然后即可写脚本，把“S@yRtfTl0+ag-L_3M}{”进行还原。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">str = <span class="string">"0123456789abcdefghi"</span></span><br><span class="line">str1 = <span class="string">"8f6c90e1dg237abh5i4"</span></span><br><span class="line">str2 = <span class="string">"S@yRtfTl0+ag-L_3M&#125;&#123;"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):</span><br><span class="line">flag += str2[str1.find(str[i])]</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p> 得到flag为flag{My-StL_R0T@+3} </p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/10/15/pwn200/" rel="next" title="pwn200">
                  <i class="fa fa-chevron-left"></i> pwn200
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/10/30/how2heap▒╩╝╟0x01/" rel="prev" title="how2heap笔记0x01">
                  how2heap笔记0x01 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ZERO-A-ONE</p>
  <div class="site-description" itemprop="description">Resit much,Obey little</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
        
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZERO-A-ONE</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客啦
</span>
</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

</body>
</html>
